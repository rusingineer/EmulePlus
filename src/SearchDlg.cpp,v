head	1.201;
access;
symbols
	PublicRelease_1_2e:1.194
	Interim_Release_1-2e_RC1:1.193
	PublicRelease_1_2d:1.190
	Interim_Release_1-2d_RC1:1.190
	Interim_Release_1-2d_beta1:1.190
	PublicRelease_1_2c:1.178
	Interim_Release_1-2c_RC1:1.178
	Interim_Release_1-2c_beta1:1.174
	PublicRelease_1_2b:1.174
	Interim_Release_1-2b_RC1:1.174
	PublicRelease_1_2a:1.172
	Interim_Release_1-2a_RC1:1.172
	Interim_Release_1-2a_beta2:1.167
	Interim_Release_1-2a_beta1:1.166
	PublicRelease_1_2:1.163
	Interim_Release_1-2_RC1:1.163
	Interim_Release_1-2_beta1:1.163
	PublicRelease_1_1g:1.161
	Interim_Release_1-1g_RC3:1.161
	Interim_Release_1-1g_RC2:1.161
	Interim_Release_1-1g_RC1:1.161
	Interim_Release_1-1g_beta2:1.158
	Interim_Release_1-1g_beta1:1.153
	PublicRelease_1_1f:1.151
	Interim_Release_1-1f_RC1:1.151
	PublicRelease_1_1e:1.150
	Interim_Release_1-1e_RC2:1.150
	Interim_Release_1-1e_RC1:1.149
	Interim_Release_1-1e_beta1:1.147
	PublicRelease_1_1d:1.142
	Interim_Release_1-1d_RC1:1.142
	PublicRelease_1_1c:1.142
	Interim_Release_1-1c_RC1:1.142
	Interim_Release_1-1c_beta2:1.142
	Interim_Release_1-1c_beta1:1.141
	PublicRelease_1_1b:1.132
	Interim_Release_1-1b_RC1:1.132
	PublicRelease_1_1a:1.132
	Interim_Release_1-1a_RC2:1.132
	Interim_Release_1-1a_RC1:1.129
	Interim_Release_1-1a_beta2:1.129
	Interim_Release_1-1a_beta1:1.129
	PublicRelease_1_1:1.125
	Interim_Release_1-1_beta1:1.125
	PublicRelease_1o:1.125
	Interim_Release_1o_RC1:1.125
	Interim_Release_1o_beta1:1.125
	PublicRelease_1n:1.125
	Interim_Release_1n_RC2:1.125
	Interim_Release_1n_RC1:1.125
	Interim_Release_1n_beta2:1.125
	Interim_Release_1n_beta1:1.124
	PublicRelease_1m:1.124
	Interim_Release_1m_beta1:1.124
	PublicRelease_1l:1.124
	Interim_Release_1l_RC3:1.123
	Interim_Release_1l_RC2:1.121
	Interim_Release_1l_RC1:1.117
	Interim_Release_1l_beta2:1.113
	Interim_Release_1l_beta1:1.111
	PublicRelease_1k:1.107
	Interim_Release_1k_RC4:1.107
	Interim_1k_RC3:1.107
	Interim_1k_RC2:1.107
	Interim_Release_1k_RC1:1.105
	Interim_Release_1k_beta5:1.102
	Intrerim_Release_1k_beta4:1.102
	Interim_Release_1k_beta1:1.91
	PublicRelease_1j:1.78
	Interim_Release_1J_RC3:1.78
	Interim_Release_1j_RC3:1.78
	Interim_Release_1j_RC2:1.78
	Interim_Release_1j_RC1:1.78
	Interim_Release_1j_beta2:1.75
	Interim_Release_1j_beta1:1.75
	PublicRelease_1i:1.68
	Interim_Release_1i_RC6:1.68
	Interim_Release_1i_RC3:1.65
	Interim_Release_1i_RC2:1.65
	Interim_Release_1i_RC1:1.62
	Interim_Release_1i_beta3:1.61
	Interim_Release_1i_beta2:1.59
	Interim_Release_1i_beta1:1.56
	PublicRelease_1h:1.52
	Interim_Release_1h_rc2:1.52
	Interim_Release_1h_RC1:1.52
	Interim_Release_1h_beta2:1.47
	Interim_Release_1h_beta1_now:1.46
	Interim_Release_1h_beta1:1.46
	PublicRelease_1g:1.46
	Interim_Release_1g_RC6_Final:1.46
	Interim_Release_1g_RC6:1.44
	Interim_Release_1g_RC5:1.44
	Interim_Release_1g_RC4:1.43
	Interim_Release_1g_RC3:1.42
	Interim_Release_1g_beta2:1.39
	Interim_Release_1g_beta1:1.37
	Interim_Release_1f_RC4:1.35
	Interim_Release_1f_RC3:1.34
	Interim_Release_1f_RC2:1.34
	Interim_Release_1f_RC:1.34
	Interim_Release_1f_beta2:1.33
	Interim_Release_1f_beta1:1.33
	PublicRelease_1e:1.33
	Interim_Release_1e_RC2:1.33
	Interim_Release_1e_RC:1.33
	Interim_Release_1e_beta3:1.32
	Interim_Release_1e_beta2:1.31
	Interim_Release_1e_beta2_before_kuchin:1.31
	Interim_Release_1e_beta1:1.30
	PublicRelease_1c:1.28
	featurestest:1.28.0.2
	Interim_Release_1c_RC:1.28
	Interim_Release_1c_beta2:1.28
	Interim_Release_1c_beta1:1.27
	threaded_downloadqueue:1.27.0.2
	PublicRelease_1b:1.25
	Interim_Release_1b_beta2:1.25
	Interim_Release_1b_beta1:1.24
	proxydeadlake:1.20.0.4
	PublicRelease_1a:1.20
	Interim_Release_1a_beta2:1.20
	BerkeleyDb:1.20.0.2
	Interim_Release_1a_beta1:1.19
	PublicRelease_1:1.19
	goldfish:1.19
	eMulePlus_1_RC2:1.17
	eMulePlus_26b_1RC1:1.14
	PreRelease_26b_i0e:1.14
	before_26d_merge:1.12
	Interim_Release_26b_i0d:1.6
	Interim_Release_26b_i0c:1.5
	Interim_Release_26b_i0b:1.5
	Interim_Release_26b_i0a:1.5
	systraydlg:1.2.0.4
	plus26based:1.2.0.2
	Interim_Release_25b_i0b:1.2
	Proxy_Dev:1.1
	Interim_Release_25b_i0a:1.1.4.1
	proxytest:1.1.4.1.0.2
	official_sockets:1.1.0.4
	eMulePlus_024b_5b:1.1.0.2;
locks; strict;
comment	@// @;


1.201
date	2011.05.10.04.37.24;	author aw3;	state Exp;
branches;
next	1.200;

1.200
date	2010.08.11.04.37.39;	author aw3;	state Exp;
branches;
next	1.199;

1.199
date	2009.10.30.01.59.03;	author aw3;	state Exp;
branches;
next	1.198;

1.198
date	2009.10.28.04.34.59;	author aw3;	state Exp;
branches;
next	1.197;

1.197
date	2009.10.22.05.38.53;	author aw3;	state Exp;
branches;
next	1.196;

1.196
date	2009.07.14.03.54.08;	author aw3;	state Exp;
branches;
next	1.195;

1.195
date	2009.05.14.03.12.16;	author aw3;	state Exp;
branches;
next	1.194;

1.194
date	2009.04.08.04.05.38;	author aw3;	state Exp;
branches;
next	1.193;

1.193
date	2008.11.13.05.16.31;	author aw3;	state Exp;
branches;
next	1.192;

1.192
date	2008.11.12.03.52.08;	author aw3;	state Exp;
branches;
next	1.191;

1.191
date	2008.11.03.05.45.23;	author aw3;	state Exp;
branches;
next	1.190;

1.190
date	2008.01.25.17.38.06;	author eklmn;	state Exp;
branches;
next	1.189;

1.189
date	2008.01.04.11.17.55;	author eklmn;	state Exp;
branches;
next	1.188;

1.188
date	2008.01.04.05.04.16;	author aw3;	state Exp;
branches;
next	1.187;

1.187
date	2008.01.02.05.30.52;	author aw3;	state Exp;
branches;
next	1.186;

1.186
date	2008.01.01.11.12.06;	author eklmn;	state Exp;
branches;
next	1.185;

1.185
date	2007.12.28.09.48.50;	author eklmn;	state Exp;
branches;
next	1.184;

1.184
date	2007.12.19.21.02.14;	author aw3;	state Exp;
branches;
next	1.183;

1.183
date	2007.12.08.09.18.15;	author eklmn;	state Exp;
branches;
next	1.182;

1.182
date	2007.11.16.20.36.37;	author eklmn;	state Exp;
branches;
next	1.181;

1.181
date	2007.11.10.23.16.30;	author eklmn;	state Exp;
branches;
next	1.180;

1.180
date	2007.10.31.18.14.55;	author fuxie-dk;	state Exp;
branches;
next	1.179;

1.179
date	2007.10.11.18.08.51;	author fuxie-dk;	state Exp;
branches;
next	1.178;

1.178
date	2007.07.31.03.14.50;	author aw3;	state Exp;
branches;
next	1.177;

1.177
date	2007.07.30.10.28.18;	author kush_eplus;	state Exp;
branches;
next	1.176;

1.176
date	2007.07.30.00.17.20;	author kush_eplus;	state Exp;
branches;
next	1.175;

1.175
date	2007.06.04.11.59.35;	author aw3;	state Exp;
branches;
next	1.174;

1.174
date	2006.11.16.05.51.47;	author aw3;	state Exp;
branches;
next	1.173;

1.173
date	2006.11.05.01.01.57;	author aw3;	state Exp;
branches;
next	1.172;

1.172
date	2006.09.05.01.10.47;	author aw3;	state Exp;
branches;
next	1.171;

1.171
date	2006.08.16.04.24.01;	author aw3;	state Exp;
branches;
next	1.170;

1.170
date	2006.08.15.04.45.20;	author aw3;	state Exp;
branches;
next	1.169;

1.169
date	2006.08.14.02.38.44;	author aw3;	state Exp;
branches;
next	1.168;

1.168
date	2006.07.29.01.40.26;	author aw3;	state Exp;
branches;
next	1.167;

1.167
date	2006.05.03.03.58.01;	author aw3;	state Exp;
branches;
next	1.166;

1.166
date	2006.04.19.11.47.46;	author aw3;	state Exp;
branches;
next	1.165;

1.165
date	2006.04.16.23.52.29;	author kush_eplus;	state Exp;
branches;
next	1.164;

1.164
date	2006.04.06.04.04.27;	author aw3;	state Exp;
branches;
next	1.163;

1.163
date	2006.01.06.20.05.54;	author kush_eplus;	state Exp;
branches;
next	1.162;

1.162
date	2005.12.29.05.35.35;	author aw3;	state Exp;
branches;
next	1.161;

1.161
date	2005.12.01.12.18.30;	author aw3;	state Exp;
branches;
next	1.160;

1.160
date	2005.11.27.22.11.49;	author eklmn;	state Exp;
branches;
next	1.159;

1.159
date	2005.11.27.20.31.05;	author eklmn;	state Exp;
branches;
next	1.158;

1.158
date	2005.11.07.02.16.00;	author aw3;	state Exp;
branches;
next	1.157;

1.157
date	2005.09.23.10.56.08;	author eklmn;	state Exp;
branches;
next	1.156;

1.156
date	2005.09.19.22.14.59;	author eklmn;	state Exp;
branches;
next	1.155;

1.155
date	2005.09.05.21.31.48;	author aw3;	state Exp;
branches;
next	1.154;

1.154
date	2005.08.29.03.11.56;	author aw3;	state Exp;
branches;
next	1.153;

1.153
date	2005.08.24.04.02.45;	author aw3;	state Exp;
branches;
next	1.152;

1.152
date	2005.08.06.17.59.01;	author aw3;	state Exp;
branches;
next	1.151;

1.151
date	2005.07.30.02.20.30;	author aw3;	state Exp;
branches;
next	1.150;

1.150
date	2005.07.07.04.19.24;	author aw3;	state Exp;
branches;
next	1.149;

1.149
date	2005.06.20.03.02.01;	author aw3;	state Exp;
branches;
next	1.148;

1.148
date	2005.06.18.01.02.46;	author aw3;	state Exp;
branches;
next	1.147;

1.147
date	2005.04.11.02.22.36;	author aw3;	state Exp;
branches;
next	1.146;

1.146
date	2005.04.09.14.42.43;	author aw3;	state Exp;
branches;
next	1.145;

1.145
date	2005.04.09.02.37.55;	author aw3;	state Exp;
branches;
next	1.144;

1.144
date	2005.04.07.04.29.11;	author aw3;	state Exp;
branches;
next	1.143;

1.143
date	2005.04.04.04.34.31;	author aw3;	state Exp;
branches;
next	1.142;

1.142
date	2005.02.02.07.15.34;	author aw3;	state Exp;
branches;
next	1.141;

1.141
date	2005.01.27.17.44.03;	author aw3;	state Exp;
branches;
next	1.140;

1.140
date	2005.01.25.16.54.52;	author aw3;	state Exp;
branches;
next	1.139;

1.139
date	2005.01.19.21.10.48;	author netwolf1;	state Exp;
branches;
next	1.138;

1.138
date	2005.01.17.18.34.54;	author katsyonak;	state Exp;
branches;
next	1.137;

1.137
date	2005.01.17.11.02.50;	author katsyonak;	state Exp;
branches;
next	1.136;

1.136
date	2005.01.16.00.34.59;	author netwolf1;	state Exp;
branches;
next	1.135;

1.135
date	2005.01.12.15.35.09;	author katsyonak;	state Exp;
branches;
next	1.134;

1.134
date	2005.01.09.12.46.27;	author katsyonak;	state Exp;
branches;
next	1.133;

1.133
date	2005.01.06.01.16.17;	author katsyonak;	state Exp;
branches;
next	1.132;

1.132
date	2004.12.06.19.32.19;	author dongato;	state Exp;
branches;
next	1.131;

1.131
date	2004.12.06.17.55.51;	author dongato;	state Exp;
branches;
next	1.130;

1.130
date	2004.12.06.13.57.44;	author dongato;	state Exp;
branches;
next	1.129;

1.129
date	2004.11.02.17.18.07;	author aw3;	state Exp;
branches;
next	1.128;

1.128
date	2004.10.29.03.25.40;	author aw3;	state Exp;
branches;
next	1.127;

1.127
date	2004.10.26.21.14.13;	author aw3;	state Exp;
branches;
next	1.126;

1.126
date	2004.10.25.18.58.22;	author aw3;	state Exp;
branches;
next	1.125;

1.125
date	2004.07.24.05.58.45;	author aw3;	state Exp;
branches;
next	1.124;

1.124
date	2004.06.09.16.04.26;	author dongato;	state Exp;
branches;
next	1.123;

1.123
date	2004.06.04.15.54.23;	author dongato;	state Exp;
branches;
next	1.122;

1.122
date	2004.06.03.20.38.45;	author dongato;	state Exp;
branches;
next	1.121;

1.121
date	2004.06.02.18.27.35;	author kush_eplus;	state Exp;
branches;
next	1.120;

1.120
date	2004.06.01.18.40.35;	author kush_eplus;	state Exp;
branches;
next	1.119;

1.119
date	2004.06.01.18.28.35;	author kush_eplus;	state Exp;
branches;
next	1.118;

1.118
date	2004.05.30.13.04.48;	author dongato;	state Exp;
branches;
next	1.117;

1.117
date	2004.05.26.13.37.32;	author dongato;	state Exp;
branches;
next	1.116;

1.116
date	2004.05.25.03.17.59;	author kush_eplus;	state Exp;
branches;
next	1.115;

1.115
date	2004.05.24.12.52.41;	author dongato;	state Exp;
branches;
next	1.114;

1.114
date	2004.05.24.08.28.26;	author netwolf1;	state Exp;
branches;
next	1.113;

1.113
date	2004.05.15.09.39.25;	author dongato;	state Exp;
branches;
next	1.112;

1.112
date	2004.05.15.00.34.18;	author aw3;	state Exp;
branches;
next	1.111;

1.111
date	2004.05.04.06.09.33;	author aw3;	state Exp;
branches;
next	1.110;

1.110
date	2004.05.03.08.24.59;	author katsyonak;	state Exp;
branches;
next	1.109;

1.109
date	2004.04.12.16.24.24;	author dongato;	state Exp;
branches;
next	1.108;

1.108
date	2004.04.12.00.44.13;	author aw3;	state Exp;
branches;
next	1.107;

1.107
date	2004.03.31.15.08.12;	author dongato;	state Exp;
branches;
next	1.106;

1.106
date	2004.03.31.15.00.30;	author dongato;	state Exp;
branches;
next	1.105;

1.105
date	2004.03.27.17.28.40;	author aw3;	state Exp;
branches;
next	1.104;

1.104
date	2004.03.27.12.16.08;	author dongato;	state Exp;
branches;
next	1.103;

1.103
date	2004.03.26.22.17.44;	author aw3;	state Exp;
branches;
next	1.102;

1.102
date	2004.03.14.21.06.29;	author aw3;	state Exp;
branches;
next	1.101;

1.101
date	2004.03.11.22.24.08;	author bavariansnail;	state Exp;
branches;
next	1.100;

1.100
date	2004.03.08.18.03.26;	author kush_eplus;	state Exp;
branches;
next	1.99;

1.99
date	2004.03.08.17.11.18;	author kush_eplus;	state Exp;
branches;
next	1.98;

1.98
date	2004.02.24.12.47.52;	author kush_eplus;	state Exp;
branches;
next	1.97;

1.97
date	2004.02.23.13.33.24;	author kush_eplus;	state Exp;
branches;
next	1.96;

1.96
date	2004.02.23.10.25.57;	author dongato;	state Exp;
branches;
next	1.95;

1.95
date	2004.02.23.02.04.50;	author kush_eplus;	state Exp;
branches;
next	1.94;

1.94
date	2004.02.23.00.17.40;	author aw3;	state Exp;
branches;
next	1.93;

1.93
date	2004.02.22.20.19.04;	author kush_eplus;	state Exp;
branches;
next	1.92;

1.92
date	2004.02.22.00.43.02;	author kush_eplus;	state Exp;
branches;
next	1.91;

1.91
date	2004.02.19.12.59.52;	author kush_eplus;	state Exp;
branches;
next	1.90;

1.90
date	2004.02.19.00.29.35;	author netwolf1;	state Exp;
branches;
next	1.89;

1.89
date	2004.02.18.23.20.55;	author kush_eplus;	state Exp;
branches;
next	1.88;

1.88
date	2004.02.18.16.25.11;	author kush_eplus;	state Exp;
branches;
next	1.87;

1.87
date	2004.02.15.11.57.30;	author morevit;	state Exp;
branches;
next	1.86;

1.86
date	2004.02.15.11.52.04;	author dongato;	state Exp;
branches;
next	1.85;

1.85
date	2004.02.14.21.35.25;	author kush_eplus;	state Exp;
branches;
next	1.84;

1.84
date	2004.02.10.15.10.26;	author bavariansnail;	state Exp;
branches;
next	1.83;

1.83
date	2004.02.05.11.56.06;	author morevit;	state Exp;
branches;
next	1.82;

1.82
date	2004.02.05.00.00.01;	author kush_eplus;	state Exp;
branches;
next	1.81;

1.81
date	2004.02.04.19.06.00;	author morevit;	state Exp;
branches;
next	1.80;

1.80
date	2004.02.03.12.53.48;	author morevit;	state Exp;
branches;
next	1.79;

1.79
date	2004.02.01.12.13.49;	author netwolf1;	state Exp;
branches;
next	1.78;

1.78
date	2004.01.10.13.11.26;	author dongato;	state Exp;
branches;
next	1.77;

1.77
date	2004.01.10.00.07.49;	author dongato;	state Exp;
branches;
next	1.76;

1.76
date	2004.01.07.22.40.32;	author katsyonak;	state Exp;
branches;
next	1.75;

1.75
date	2003.12.30.10.44.04;	author dongato;	state Exp;
branches;
next	1.74;

1.74
date	2003.12.24.01.21.14;	author katsyonak;	state Exp;
branches;
next	1.73;

1.73
date	2003.12.23.19.03.21;	author katsyonak;	state Exp;
branches;
next	1.72;

1.72
date	2003.12.23.15.35.17;	author katsyonak;	state Exp;
branches;
next	1.71;

1.71
date	2003.12.20.22.59.36;	author bavariansnail;	state Exp;
branches;
next	1.70;

1.70
date	2003.12.20.00.27.21;	author dongato;	state Exp;
branches;
next	1.69;

1.69
date	2003.12.19.15.57.58;	author dongato;	state Exp;
branches;
next	1.68;

1.68
date	2003.11.27.14.51.06;	author eklmn;	state Exp;
branches;
next	1.67;

1.67
date	2003.11.22.22.05.57;	author forcha;	state Exp;
branches;
next	1.66;

1.66
date	2003.11.22.13.12.10;	author eklmn;	state Exp;
branches;
next	1.65;

1.65
date	2003.11.05.11.08.45;	author katsyonak;	state Exp;
branches;
next	1.64;

1.64
date	2003.11.05.08.21.54;	author katsyonak;	state Exp;
branches;
next	1.63;

1.63
date	2003.11.04.23.23.25;	author dongato;	state Exp;
branches;
next	1.62;

1.62
date	2003.11.04.16.09.17;	author katsyonak;	state Exp;
branches;
next	1.61;

1.61
date	2003.10.31.06.47.00;	author eklmn;	state Exp;
branches;
next	1.60;

1.60
date	2003.10.26.15.57.56;	author morevit;	state Exp;
branches;
next	1.59;

1.59
date	2003.10.24.01.21.20;	author morevit;	state Exp;
branches;
next	1.58;

1.58
date	2003.10.15.03.51.45;	author morevit;	state Exp;
branches;
next	1.57;

1.57
date	2003.10.08.01.53.32;	author morevit;	state Exp;
branches;
next	1.56;

1.56
date	2003.10.03.18.08.49;	author dongato;	state Exp;
branches;
next	1.55;

1.55
date	2003.09.23.16.52.50;	author morevit;	state Exp;
branches;
next	1.54;

1.54
date	2003.09.20.15.39.31;	author morevit;	state Exp;
branches;
next	1.53;

1.53
date	2003.09.19.14.42.46;	author morevit;	state Exp;
branches;
next	1.52;

1.52
date	2003.09.09.16.45.11;	author dongato;	state Exp;
branches;
next	1.51;

1.51
date	2003.09.05.23.08.38;	author puritynn666;	state Exp;
branches;
next	1.50;

1.50
date	2003.09.05.19.03.35;	author puritynn666;	state Exp;
branches;
next	1.49;

1.49
date	2003.09.05.18.15.02;	author dongato;	state Exp;
branches;
next	1.48;

1.48
date	2003.09.05.11.12.13;	author dongato;	state Exp;
branches;
next	1.47;

1.47
date	2003.09.02.18.28.57;	author puritynn666;	state Exp;
branches;
next	1.46;

1.46
date	2003.07.25.08.51.26;	author netwolf1;	state Exp;
branches;
next	1.45;

1.45
date	2003.07.24.15.54.59;	author netwolf1;	state Exp;
branches;
next	1.44;

1.44
date	2003.07.10.12.21.54;	author emoulari;	state Exp;
branches;
next	1.43;

1.43
date	2003.07.08.19.35.47;	author emoulari;	state Exp;
branches;
next	1.42;

1.42
date	2003.06.15.09.10.05;	author partyckip;	state Exp;
branches;
next	1.41;

1.41
date	2003.06.11.08.24.40;	author netwolf1;	state Exp;
branches;
next	1.40;

1.40
date	2003.06.10.09.36.46;	author kuchin;	state Exp;
branches;
next	1.39;

1.39
date	2003.06.08.07.36.57;	author partyckip;	state Exp;
branches;
next	1.38;

1.38
date	2003.06.06.20.37.18;	author partyckip;	state Exp;
branches;
next	1.37;

1.37
date	2003.06.01.08.59.02;	author kuchin;	state Exp;
branches;
next	1.36;

1.36
date	2003.05.31.17.14.28;	author partyckip;	state Exp;
branches;
next	1.35;

1.35
date	2003.05.26.00.02.47;	author dongato;	state Exp;
branches;
next	1.34;

1.34
date	2003.05.11.11.37.48;	author kuchin;	state Exp;
branches;
next	1.33;

1.33
date	2003.04.26.16.28.39;	author ultras;	state Exp;
branches;
next	1.32;

1.32
date	2003.04.22.18.34.01;	author ultras;	state Exp;
branches;
next	1.31;

1.31
date	2003.04.19.07.17.00;	author kuchin;	state Exp;
branches;
next	1.30;

1.30
date	2003.04.13.17.48.31;	author kuchin;	state Exp;
branches;
next	1.29;

1.29
date	2003.03.28.10.19.09;	author dongato;	state Exp;
branches;
next	1.28;

1.28
date	2003.03.20.23.32.03;	author lord_kiron;	state Exp;
branches
	1.28.2.1;
next	1.27;

1.27
date	2003.03.14.16.24.20;	author partyckip;	state Exp;
branches;
next	1.26;

1.26
date	2003.03.13.21.16.34;	author partyckip;	state Exp;
branches;
next	1.25;

1.25
date	2003.03.08.19.27.12;	author dongato;	state Exp;
branches;
next	1.24;

1.24
date	2003.03.05.13.28.51;	author cax2;	state Exp;
branches;
next	1.23;

1.23
date	2003.03.05.11.23.44;	author recdvst;	state Exp;
branches;
next	1.22;

1.22
date	2003.03.01.12.48.30;	author dongato;	state Exp;
branches;
next	1.21;

1.21
date	2003.02.28.21.00.37;	author dongato;	state Exp;
branches;
next	1.20;

1.20
date	2003.02.25.02.34.37;	author dongato;	state Exp;
branches
	1.20.2.1;
next	1.19;

1.19
date	2003.02.20.23.21.19;	author cax2;	state Exp;
branches;
next	1.18;

1.18
date	2003.02.20.14.48.16;	author dongato;	state Exp;
branches;
next	1.17;

1.17
date	2003.02.20.07.25.22;	author cax2;	state Exp;
branches;
next	1.16;

1.16
date	2003.02.20.00.34.17;	author dongato;	state Exp;
branches;
next	1.15;

1.15
date	2003.02.19.20.53.07;	author cax2;	state Exp;
branches;
next	1.14;

1.14
date	2003.02.17.09.15.16;	author cax2;	state Exp;
branches;
next	1.13;

1.13
date	2003.02.17.06.50.29;	author obaldin;	state Exp;
branches;
next	1.12;

1.12
date	2003.02.16.22.01.48;	author lord_kiron;	state Exp;
branches;
next	1.11;

1.11
date	2003.02.16.14.31.05;	author dongato;	state Exp;
branches;
next	1.10;

1.10
date	2003.02.16.03.50.30;	author cax2;	state Exp;
branches;
next	1.9;

1.9
date	2003.02.16.03.21.42;	author cax2;	state Exp;
branches;
next	1.8;

1.8
date	2003.02.15.15.15.07;	author dongato;	state Exp;
branches;
next	1.7;

1.7
date	2003.02.14.15.32.16;	author dongato;	state Exp;
branches;
next	1.6;

1.6
date	2003.02.13.14.57.47;	author obaldin;	state Exp;
branches;
next	1.5;

1.5
date	2003.02.09.21.04.40;	author emoulari;	state Exp;
branches;
next	1.4;

1.4
date	2003.02.09.18.39.42;	author kuchin;	state Exp;
branches;
next	1.3;

1.3
date	2003.02.09.10.42.39;	author emoulari;	state Exp;
branches;
next	1.2;

1.2
date	2003.02.02.16.46.57;	author cax2;	state Exp;
branches
	1.2.2.1;
next	1.1;

1.1
date	2003.01.21.18.21.22;	author cax2;	state Exp;
branches
	1.1.4.1;
next	;

1.1.4.1
date	2003.01.28.16.54.25;	author cax2;	state Exp;
branches;
next	;

1.2.2.1
date	2003.02.05.01.58.42;	author obaldin;	state Exp;
branches;
next	;

1.20.2.1
date	2003.03.01.20.59.36;	author obaldin;	state Exp;
branches;
next	;

1.28.2.1
date	2003.03.23.06.22.02;	author recdvst;	state Exp;
branches;
next	;


desc
@@


1.201
log
@Removed emugle website search, as site changed orientation.
@
text
@//this file is part of eMule
//Copyright (C)2002 Merkur ( merkur-@@users.sourceforge.net / http://www.emule-project.net )
//
//This program is free software; you can redistribute it and/or
//modify it under the terms of the GNU General Public License
//as published by the Free Software Foundation; either
//version 2 of the License, or (at your option) any later version.
//
//This program is distributed in the hope that it will be useful,
//but WITHOUT ANY WARRANTY; without even the implied warranty of
//MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
//GNU General Public License for more details.
//
//You should have received a copy of the GNU General Public License
//along with this program; if not, write to the Free Software
//Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.

#include "stdafx.h"
#include "emule.h"
#include "SearchDlg.h"
#include "packets.h"
#include "server.h"
#include "opcodes.h"
#include "ServerList.h"
#include "SharedFileList.h"
#include "otherfunctions.h"
#include "UploadQueue.h"
#include "ED2KLink.h"
#include "CustomAutoComplete.h"
#ifdef OLD_SOCKETS_ENABLED
#include "sockets.h"
#endif

#ifdef _DEBUG
#undef THIS_FILE
static char THIS_FILE[]=__FILE__;
#define new DEBUG_NEW
#endif

#define	SEARCH_STRINGS_PROFILE	_T("AC_SearchStrings.dat")

//	Search control masks to enable/disable controls
#define EP_SCHCTRL_EXCL		0x01
#define EP_SCHCTRL_TYPE		0x02
#define EP_SCHCTRL_MIN		0x04
#define EP_SCHCTRL_MAX		0x08
#define EP_SCHCTRL_AVAIL	0x10
#define EP_SCHCTRL_EXT		0x20

//	Search type indexes
enum
{
	EP_SCHTYPE_ANY = 0,
	EP_SCHTYPE_ARC,
	EP_SCHTYPE_AUDIO,
	EP_SCHTYPE_CDIMG,
	EP_SCHTYPE_DOC,
	EP_SCHTYPE_PICS,
	EP_SCHTYPE_PRG,
	EP_SCHTYPE_VIDEO,

	EP_SCHTYPE_COUNT
};

//	Search server parameter types
#define SCH_SRV_PARAMTYPE_BOOL			0	// boolean operator
#define SCH_SRV_PARAMTYPE_STR			1	// string
#define SCH_SRV_PARAMTYPE_TAGSTR		2	// string with tag
#define SCH_SRV_PARAMTYPE_TAGNUM		3	// number with tag
#define SCH_SRV_PARAMTYPE_TAGNUM64	8	// 64bit number with tag

#define SCH_SRV_BOOLPARAM_AND			0
#define SCH_SRV_BOOLPARAM_OR			1
#define SCH_SRV_BOOLPARAM_NOT			2

class CSearchExprTarget
{
public:
	CSearchExprTarget(CMemFile *pStream1, CMemFile *pStream2)
	{
		m_pStrm1 = pStream1;
		m_pStrm2 = pStream2;
		m_bContains64bitData = false;
	}

	void AddBooleanAND()
	{
		static const byte s_aBoolPar[] = { SCH_SRV_PARAMTYPE_BOOL, SCH_SRV_BOOLPARAM_AND };

		m_pStrm1->Write(&s_aBoolPar, sizeof(s_aBoolPar));
		m_pStrm2->Write(&s_aBoolPar, sizeof(s_aBoolPar));
	}

	void AddBooleanOR()
	{
		static const byte s_aBoolPar[] = { SCH_SRV_PARAMTYPE_BOOL, SCH_SRV_BOOLPARAM_OR };

		m_pStrm1->Write(&s_aBoolPar, sizeof(s_aBoolPar));
		m_pStrm2->Write(&s_aBoolPar, sizeof(s_aBoolPar));
	}

	void AddBooleanNOT()
	{
		static const byte s_aBoolPar[] = { SCH_SRV_PARAMTYPE_BOOL, SCH_SRV_BOOLPARAM_NOT };

		m_pStrm1->Write(&s_aBoolPar, sizeof(s_aBoolPar));
		m_pStrm2->Write(&s_aBoolPar, sizeof(s_aBoolPar));
	}

	void AddStringParam(const CString &strVal)
	{
		byte abytePar[3];
		CStringA strEncoded;

		Str2MB(cfUTF8, &strEncoded, strVal);

		abytePar[0] = SCH_SRV_PARAMTYPE_STR;
		POKE_WORD(&abytePar[1], static_cast<uint16>(strEncoded.GetLength()));	// string length

		m_pStrm1->Write(&abytePar, sizeof(abytePar));
		m_pStrm1->Write(strEncoded, strEncoded.GetLength());
		m_pStrm2->Write(&abytePar, sizeof(abytePar));
		m_pStrm2->Write(strEncoded, strEncoded.GetLength());
	}

	void AddStringParam(byte byteTagID, const CString &strVal, CMemFile *pStrm)
	{
		byte abytePar[6];
		CStringA strEncoded;

		Str2MB(cfUTF8, &strEncoded, strVal);

		abytePar[0] = SCH_SRV_PARAMTYPE_TAGSTR;
		POKE_WORD(&abytePar[1], static_cast<uint16>(strEncoded.GetLength()));	// string length
		POKE_WORD(&abytePar[3], 1);			// meta tag ID length
		abytePar[5] = byteTagID;			// meta tag ID name

		pStrm->Write(&abytePar, 3);
		pStrm->Write(strEncoded, strEncoded.GetLength());
		pStrm->Write(&abytePar[3], 3);
	}

	void AddStringParam(byte byteTagID, const CString &strVal)
	{
		AddStringParam(byteTagID, strVal, m_pStrm1);
		AddStringParam(byteTagID, strVal, m_pStrm2);
	}

	void AddNumParam(byte byteTagID, byte byteOperator, uint64 qwVal, CMemFile *pStrm)
	{
		byte	abytePar[9 + 4];
		uint32	dwSz, dwVal;
		bool	b64BitValue = (qwVal > 0xFFFFFFFFui64);

		if (b64BitValue && (pStrm == m_pStrm2))
		{
			m_bContains64bitData = true;
			abytePar[0] = SCH_SRV_PARAMTYPE_TAGNUM64;
			POKE_QWORD(&abytePar[1], qwVal);	// numeric value
			abytePar[9] = byteOperator;			// comparison operator
			POKE_WORD(&abytePar[10], 1);		// meta tag ID length
			abytePar[12] = byteTagID;			// meta tag ID name
			dwSz = sizeof(abytePar);
		}
		else
		{
			if (b64BitValue)
				dwVal = 0xFFFFFFFF;
			else
				dwVal = static_cast<uint32>(qwVal);
			abytePar[0] = SCH_SRV_PARAMTYPE_TAGNUM;
			POKE_DWORD(&abytePar[1], dwVal);	// numeric value
			abytePar[5] = byteOperator;			// comparison operator
			POKE_WORD(&abytePar[6], 1);			// meta tag ID length
			abytePar[8] = byteTagID;			// meta tag ID name
			dwSz = sizeof(abytePar) - 4;
		}
		pStrm->Write(&abytePar, dwSz);
	}

	void AddNumParam(byte byteTagID, byte byteOperator, uint64 qwVal)
	{
		AddNumParam(byteTagID, byteOperator, qwVal, m_pStrm1);
		AddNumParam(byteTagID, byteOperator, qwVal, m_pStrm2);
	}

	void AddNumParamMin(byte byteTagID, uint64 qwVal)
	{
		AddNumParam(byteTagID, ED2K_SEARCH_OP_GREATER, qwVal - 1ui64);
	}

	void AddNumParamMax(byte byteTagID, uint64 qwVal)
	{
		AddNumParam(byteTagID, ED2K_SEARCH_OP_LESS, qwVal + 1ui64);
	}

	bool Contains64bitData() const		{ return m_bContains64bitData; }

private:
	CMemFile	*m_pStrm1;
	CMemFile	*m_pStrm2;
	bool		m_bContains64bitData;	//	2nd scream contains 64bit numbers
};

// CSearchDlg dialog

IMPLEMENT_DYNAMIC(CSearchDlg, CDialog)
CSearchDlg::CSearchDlg(CWnd* pParent /*=NULL*/)
: CResizableDialog(CSearchDlg::IDD, pParent)
{
	m_nSearchID = 0;
	m_bCancelled = true;
	m_bMoreEnabled = false;
	m_pGlobSearchPck = NULL;
	m_pGlobSearchPck2 = NULL;
	m_b64BitSearchPacket = false;
	m_pacSearchString = NULL;
	m_bGuardCBPrompt = false;
	m_nMoreRequestCount = 0;
}
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
CSearchDlg::~CSearchDlg()
{
	EMULE_TRY

	safe_delete(m_pGlobSearchPck);
	safe_delete(m_pGlobSearchPck2);
	if (m_pacSearchString != NULL)
	{
		m_pacSearchString->Unbind();
		m_pacSearchString->Release();
	}

	EMULE_CATCH2
}
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
BOOL CSearchDlg::OnInitDialog()
{
	static const uint16 s_auIconResID[] =
	{
		IDI_SMALLSERVER,	//EP_SEARCHMETHOD_SERV
		IDI_GLOBAL,			//EP_SEARCHMETHOD_GLOB
		IDI_TRAYICON_GREY	//EP_SEARCHMETHOD_WEB1
	};

	EMULE_TRY

	CResizableDialog::OnInitDialog();
	g_App.m_pSearchList->SetOutputWnd(&m_ctlSearchList);
	m_ctlSearchList.Init(g_App.m_pSearchList);

	m_ctlGlobalSearchProgress.SetStep(1);
	global_search_timer = 0;
	m_bGlobalSearch = false;
	m_bGuardCBPrompt = false;

	m_ctrlSearchFrm.Init(IDI_NORMALSEARCH, &g_App.m_pMDlg->m_themeHelper);
	m_ctrlDirectDlFrm.Init(IDI_DIRECTDOWNLOAD, &g_App.m_pMDlg->m_themeHelper);
	oldSearchLstIcon = GetSearchLstStatic()->SetIcon(GetSearchLstIcon());

	m_BoxImageList.Create(16, 16, g_App.m_iDfltImageListColorFlags|ILC_MASK, ARRSIZE(s_auIconResID), 0);
	m_BoxImageList.SetBkColor(CLR_NONE);
	FillImgLstWith16x16Icons(&m_BoxImageList, s_auIconResID, ARRSIZE(s_auIconResID));

	AddAnchor(IDC_SEARCH_FRM, TOP_LEFT);
	AddAnchor(IDC_SNAME_LBL, TOP_LEFT);
	AddAnchor(IDC_SEARCHNAME, TOP_LEFT);
	AddAnchor(IDC_SEARCHNAME_NOT, TOP_LEFT);
	AddAnchor(IDC_STYPE_LBL, TOP_LEFT);
	AddAnchor(IDC_TYPESEARCH, TOP_LEFT);
	AddAnchor(IDC_SMETHOD_LBL, TOP_LEFT);
	AddAnchor(IDC_METHOD, TOP_LEFT);

	AddAnchor(IDC_DDOWN_FRM, TOP_LEFT, TOP_RIGHT);
	AddAnchor(IDC_ED2KLINK_LBL, TOP_LEFT);
	AddAnchor(IDC_ELINK, TOP_LEFT, TOP_RIGHT);

	AddAnchor(IDC_STARTS, TOP_RIGHT);
	AddAnchor(IDC_MORES, TOP_RIGHT);
	AddAnchor(IDC_CANCELS, TOP_RIGHT);
	AddAnchor(IDC_CLEARALL, TOP_RIGHT);

	AddAnchor(IDC_SEARCHLST_ICO, TOP_LEFT);
	AddAnchor(IDC_RESULTS_LBL, TOP_LEFT);
	AddAnchor(IDC_SEARCHLIST, TOP_LEFT, BOTTOM_RIGHT);

	AddAnchor(IDC_SDOWNLOAD, BOTTOM_LEFT);
	AddAnchor(IDC_PROGRESS1, BOTTOM_LEFT, BOTTOM_RIGHT);

	AddAnchor(m_ctlSearchTabs.m_hWnd,TOP_LEFT,TOP_RIGHT);
	AddAnchor(IDC_DOWNLOAD_ALL_ED2K, BOTTOM_LEFT);
	AddAnchor(IDC_STATIC_DLTOof, BOTTOM_LEFT);
	AddAnchor(IDC_CATTAB2, BOTTOM_LEFT, BOTTOM_RIGHT);

	ShowSearchTabs(SW_HIDE);

	m_pacSearchString = new CCustomAutoComplete();
	m_pacSearchString->AddRef();
	m_strLastClipBoard = _T("");

	CoInitialize(NULL);
	if (m_pacSearchString->Bind(::GetDlgItem(m_hWnd, IDC_SEARCHNAME), ACO_UPDOWNKEYDROPSLIST | ACO_AUTOSUGGEST))
	{
		if (g_App.m_pPrefs->GetKeepSearchHistory())
			m_pacSearchString->LoadList(g_App.m_pPrefs->GetConfigDir() + _T("\\") SEARCH_STRINGS_PROFILE);
	}

//	Max. Length of search expression
	((CEdit*)GetDlgItem(IDC_SEARCHNAME))->LimitText(512);
	((CEdit*)GetDlgItem(IDC_EDITSEARCHEXTENSION))->LimitText(32);

	Localize();

	OnEnChangeMethod();

	m_ttip.Create(this);
	m_ttip.SetDelayTime(TTDT_AUTOPOP, 15000);
	m_ttip.SetDelayTime(TTDT_INITIAL, g_App.m_pPrefs->GetToolTipDelay()*1000);
	m_ttip.SendMessage(TTM_SETMAXTIPWIDTH, 0, SHRT_MAX);
	m_ttip.SetBehaviour(PPTOOLTIP_MULTIPLE_SHOW);
	m_ttip.SetNotify(m_hWnd);
	m_ttip.AddTool(&m_ctlSearchList, _T(""));

	return true;
	EMULE_CATCH
	return false;
}
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
void CSearchDlg::DoDataExchange(CDataExchange* pDX)
{
	CResizableDialog::DoDataExchange(pDX);
	DDX_Control(pDX, IDC_SEARCHLIST, m_ctlSearchList);
	DDX_Control(pDX, IDC_PROGRESS1, m_ctlGlobalSearchProgress);
	DDX_Control(pDX, IDC_METHOD, methodbox);
	DDX_Control(pDX, IDC_TYPESEARCH, Stypebox);
	DDX_Control(pDX, IDC_TAB1, m_ctlSearchTabs);
	DDX_Control(pDX, IDC_SEARCH_FRM, m_ctrlSearchFrm);
	DDX_Control(pDX, IDC_DDOWN_FRM, m_ctrlDirectDlFrm);
	DDX_Control(pDX, IDC_CATTAB2, m_ctrlCatTabs);
}
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
BEGIN_MESSAGE_MAP(CSearchDlg, CResizableDialog)
	ON_WM_TIMER()
	ON_BN_CLICKED(IDC_SEARCH_RESET, OnBnClickedSearchReset)
	ON_BN_CLICKED(IDC_STARTS, OnBnClickedStart)
	ON_BN_CLICKED(IDC_MORES, OnBnClickedMore)
	ON_BN_CLICKED(IDC_CANCELS, OnBnClickedCancel)
	ON_BN_CLICKED(IDC_CLEARALL, OnBnClickedClearall)
	ON_BN_CLICKED(IDC_SDOWNLOAD, OnBnClickedSdownload)
	ON_BN_CLICKED(IDC_DOWNLOAD_ALL_ED2K, OnBnClickedDownloadAllEd2k)
	ON_EN_KILLFOCUS(IDC_EDITSEARCHMIN, OnChangeMin)
	ON_EN_KILLFOCUS(IDC_EDITSEARCHMAX, OnChangeMax)
	ON_NOTIFY(NM_DBLCLK, IDC_SEARCHLIST, OnNMDblclkSearchlist)
	ON_NOTIFY(TCN_SELCHANGE, IDC_TAB1, OnTcnSelchangeTab1)
	ON_EN_CHANGE(IDC_SEARCHNAME, OnEnChangeSearchname)
	ON_CBN_SELCHANGE(IDC_TYPESEARCH, OnEnChangeSearchname)
	ON_CBN_SELCHANGE(IDC_METHOD, OnEnChangeMethod)
	ON_MESSAGE(WM_CLOSETAB, OnCloseTab)
	ON_MESSAGE(WM_SHOWWINDOW, OnShowWindow)
	ON_WM_DESTROY()
END_MESSAGE_MAP()
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// CSearchDlg message handlers
void CSearchDlg::OnChangeMin()
{
	OnChangeSize(true);
}
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
void CSearchDlg::OnChangeMax()
{
	OnChangeSize(false);
}
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
void CSearchDlg::OnChangeSize(bool bChangedMin)
{
	EMULE_TRY

	CString	strNum;
	int		iMin, iMax;

	GetDlgItemText(IDC_EDITSEARCHMIN, strNum);
	iMin = _tstoi(strNum);
	GetDlgItemText(IDC_EDITSEARCHMAX, strNum);
	iMax = _tstoi(strNum);
	if (iMin > 524287)	// 512 * 1024 - 1
	{
		iMin = 524287;
		SetDlgItemText(IDC_EDITSEARCHMIN, _T("524287"));
	}
	if (iMax > 524288)	// 512 * 1024
	{
		iMax = 524288;
		SetDlgItemText(IDC_EDITSEARCHMAX, _T("524288"));
	}
	if ((iMax <= iMin) && !strNum.IsEmpty())
	{
		SetDlgItemText((bChangedMin) ? IDC_EDITSEARCHMAX : IDC_EDITSEARCHMIN, _T(""));
	}

	EMULE_CATCH
}
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
void CSearchDlg::OnBnClickedStart()
{
	EMULE_TRY

	if (!GetDlgItem(IDC_STARTS)->IsWindowEnabled())
		return;

	m_ctlGlobalSearchProgress.SetPos(0);

	CString		strTemp;

//	ED2k-links
	GetDlgItemText(IDC_ELINK, strTemp);
	if (!strTemp.IsEmpty())
	{
		SetDlgItemText(IDC_ELINK, _T(""));

		int				iCatIdx = m_ctrlCatTabs.GetCurSel();
		EnumCategories	eCatID = (iCatIdx < 1 || iCatIdx > CCat::GetNumUserCats()) ? CAT_NONE : CCat::GetCatIDByUserIndex(iCatIdx);

		AddEd2kLinksToDownload(strTemp, eCatID);
	}
//	Search by name
	else if (GetDlgItem(IDC_SEARCHNAME)->GetWindowTextLength())
	{
		if (m_pacSearchString != NULL)
		{
			if (GetDlgItemText(IDC_SEARCHNAME, strTemp) && g_App.m_pPrefs->GetKeepSearchHistory())
				m_pacSearchString->AddItem(strTemp, 0);
		}
		switch (methodbox.GetCurSel())
		{
			case EP_SEARCHMETHOD_SERV:
			case EP_SEARCHMETHOD_GLOB:
				StartNewSearch();
				break;
			case EP_SEARCHMETHOD_WEB1:
				ShellOpenFile(CreateWebQuery());
				break;
			default:
				break;
		}
	}

	EMULE_CATCH
}
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
void CSearchDlg::OnTimer(UINT nIDEvent)
{
	EMULE_TRY

	CResizableDialog::OnTimer(nIDEvent);

#ifdef OLD_SOCKETS_ENABLED
	if (g_App.m_pServerConnect->IsConnected())
	{
		CServer		*pNextServer = g_App.m_pServerList->GetNextSearchServer();
		CServer		*pCurServer = g_App.m_pServerConnect->GetCurrentServer();

		if (pNextServer == g_App.m_pServerList->GetServerByAddress(pCurServer->GetAddress(), pCurServer->GetPort()))
			pNextServer = g_App.m_pServerList->GetNextSearchServer();

	//	If we got the next server and we haven't wrapped all the way around the server list...
		if (pNextServer != NULL && g_App.m_pServerList->GetServerCount() - 1 != m_uServerCount)
		{
			m_uServerCount++;
		//	Don't send search requests to the dead servers (dead static servers aren't removed automatically)
			if (pNextServer->GetFailedCount() >= g_App.m_pPrefs->GetDeadserverRetries())
				return;

			uint32	dwSrvUDPFlags = pNextServer->GetUDPFlags();
			Packet	*pSearchPck, *pExtSearchPck;

#define EPUDP_ADVFORM	(SRV_UDPFLG_LARGEFILES | SRV_UDPFLG_TYPETAGINTEGER | SRV_UDPFLG_EXT_GETFILES | SRV_UDPFLG_NEWTAGS)
			if ((dwSrvUDPFlags & EPUDP_ADVFORM) == EPUDP_ADVFORM)
			{
				static const uint32		dwTagCnt = 1;
				CMemFile	pckStrm(16);
				uint32		dwHdrSz;
				CWrTag		tagWr;

				pckStrm.Write(&dwTagCnt, sizeof(uint32));
				tagWr.WriteNewEd2kTag(CT_SERVER_UDPSEARCH_FLAGS, static_cast<uint32>(SRVCAP_UDP_NEWTAGS_LARGEFILES), pckStrm);

				pSearchPck = (m_pGlobSearchPck2 != NULL) ? m_pGlobSearchPck2 : m_pGlobSearchPck;

				dwHdrSz = static_cast<uint32>(pckStrm.GetLength());
				pExtSearchPck = new Packet(OP_GLOBSEARCHREQ3, pSearchPck->m_dwSize + dwHdrSz);
				pckStrm.SeekToBegin();
				pckStrm.Read(pExtSearchPck->m_pcBuffer, dwHdrSz);
				memcpy(pExtSearchPck->m_pcBuffer + dwHdrSz, pSearchPck->m_pcBuffer, pSearchPck->m_dwSize);

				g_App.m_pUploadQueue->AddUpDataOverheadServer(pExtSearchPck->m_dwSize);
				g_App.m_pServerConnect->SendUDPPacket(pExtSearchPck, pNextServer, true);
			}
			else if (!m_b64BitSearchPacket)	//	Skipped large file search request when the server doesn't support it
			{
			//	Send integer search type if it's among operands and server supports integer search type
				pSearchPck = ( (m_pGlobSearchPck2 != NULL) &&
					(dwSrvUDPFlags & SRV_UDPFLG_TYPETAGINTEGER) ) ? m_pGlobSearchPck2 : m_pGlobSearchPck;

			//	If the server supports extended Get Files...
				if (dwSrvUDPFlags & SRV_UDPFLG_EXT_GETFILES)
					pSearchPck->m_eOpcode = OP_GLOBSEARCHREQ2;
				else
					pSearchPck->m_eOpcode = OP_GLOBSEARCHREQ;

				g_App.m_pUploadQueue->AddUpDataOverheadServer(pSearchPck->m_dwSize);
				g_App.m_pServerConnect->SendUDPPacket(pSearchPck, pNextServer, false);
			}
#if 1
			else
			{
				g_App.m_pMDlg->AddLogLine( LOG_FL_DBG | LOG_RGB_CHOCOLATE, _T("Skipped large file UDP search request to server %s (%s, Flags %#x)"),
					pNextServer->GetAddress(), pNextServer->GetVersion(), dwSrvUDPFlags );
			}
#endif
			m_ctlGlobalSearchProgress.StepIt();
		}
		else
		{
			OnBnClickedCancel();
		}
	}
	else
#endif //OLD_SOCKETS_ENABLED
		OnBnClickedCancel();

	EMULE_CATCH
}
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
void CSearchDlg::OnBnClickedCancel()
{
	EMULE_TRY

	safe_delete(m_pGlobSearchPck);
	safe_delete(m_pGlobSearchPck2);
	m_b64BitSearchPacket = false;

	m_bCancelled = true;
	m_bGlobalSearch = false;
	if (global_search_timer)
	{
		KillTimer(global_search_timer);
		global_search_timer = 0;
		m_ctlGlobalSearchProgress.SetPos(0);
	}
	GetDlgItem(IDC_STARTS)->EnableWindow(true);
	GetDlgItem(IDC_MORES)->EnableWindow(false);
	GetDlgItem(IDC_CANCELS)->EnableWindow(false);

	EMULE_CATCH
}
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
void CSearchDlg::LocalSearchEnd(uint16 count, bool bIsMoreResultsAvailable)
{
	EMULE_TRY

	if (!m_bCancelled)
	{
		if (count >= MAX_RESULTS)
		{
			OnBnClickedCancel();
		}
		else if (!m_bGlobalSearch)
		{
			GetDlgItem(IDC_STARTS)->EnableWindow(true);
			GetDlgItem(IDC_CANCELS)->EnableWindow(false);
			m_bCancelled = true; // DonGato: if we do not set this ENTER doesn't work
		}
		else
		{
			global_search_timer = SetTimer(1, 750, 0);
		}
	}

	if (bIsMoreResultsAvailable && m_nMoreRequestCount < MAX_MORE_SEARCH_REQ)
	{
		GetDlgItem(IDC_MORES)->EnableWindow(true);
		GetDlgItem(IDC_STARTS)->EnableWindow(true);
		GetDlgItem(IDC_CANCELS)->EnableWindow(false);
		m_bMoreEnabled = true;
	}
	else
	{
		GetDlgItem(IDC_MORES)->EnableWindow(false);
		if (!m_bGlobalSearch)
		{
			GetDlgItem(IDC_STARTS)->EnableWindow(true);
			GetDlgItem(IDC_CANCELS)->EnableWindow(false);
		}
		m_bMoreEnabled = false;
	}

	EMULE_CATCH
}
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
void CSearchDlg::AddGlobalEd2kSearchResults(uint16 count)
{
	if (!m_bCancelled && (count >= MAX_RESULTS))
		OnBnClickedCancel();
}
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
void CSearchDlg::OnBnClickedSdownload()
{
	DownloadSelected(g_App.m_pPrefs->StartDownloadPaused());
}
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
BOOL CSearchDlg::PreTranslateMessage(MSG *pMsg)
{
	EMULE_TRY

	if (pMsg->message == WM_KEYDOWN)
	{
		if (pMsg->wParam == VK_ESCAPE)
		{
			return FALSE;
		}
		else if ( pMsg->wParam == VK_DELETE
					&& GetAsyncKeyState(VK_CONTROL) < 0
					&& pMsg->hwnd == GetDlgItem(IDC_SEARCHNAME)->m_hWnd )
		{
			m_pacSearchString->Clear();
		}
		else if (pMsg->wParam == VK_RETURN)
		{
			if (pMsg->hwnd == GetDlgItem(IDC_SEARCHLIST)->m_hWnd)
			{
				OnBnClickedSdownload();
			}
			else if ( pMsg->hwnd == GetDlgItem(IDC_SEARCHNAME)->m_hWnd
						&& m_pacSearchString && m_pacSearchString->IsBound() )
			{
				CString strText;

				GetDlgItemText(IDC_SEARCHNAME, strText);
				if (!strText.IsEmpty())
				{
					SetDlgItemText(IDC_SEARCHNAME, _T("")); // this seems to be the only way to hide the dropdown
					SetDlgItemText(IDC_SEARCHNAME, strText);
				//	Remove selection
					((CEdit*)GetDlgItem(IDC_SEARCHNAME))->SetSel(~0ul);
				}
				if (m_bCancelled)
					OnBnClickedStart();
			}
			else if ( m_bCancelled
						&& ( pMsg->hwnd == GetDlgItem(IDC_TYPESEARCH)->m_hWnd
							|| pMsg->hwnd == GetDlgItem(IDC_EDITSEARCHMIN)->m_hWnd
							|| pMsg->hwnd == GetDlgItem(IDC_EDITSEARCHMAX)->m_hWnd
							|| pMsg->hwnd == GetDlgItem(IDC_EDITSEARCHAVAILABILITY)->m_hWnd
							|| pMsg->hwnd == GetDlgItem(IDC_SEARCHNAME_NOT)->m_hWnd
							|| pMsg->hwnd == GetDlgItem(IDC_METHOD)->m_hWnd
							|| pMsg->hwnd == GetDlgItem(IDC_EDITSEARCHEXTENSION)->m_hWnd )
						|| pMsg->hwnd == GetDlgItem(IDC_ELINK)->m_hWnd )
			{
				OnBnClickedStart();
			}
		}
	}

	if (g_App.m_pPrefs->GetToolTipDelay() != 0)
		m_ttip.RelayEvent(pMsg);

	return CResizableDialog::PreTranslateMessage(pMsg);

	EMULE_CATCH

	return false;
}
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
BOOL CSearchDlg::OnNotify(WPARAM wParam, LPARAM lParam, LRESULT* pResult)
{
	NMHDR* pNMHDR = (NMHDR*)lParam;

	switch(pNMHDR->code)
	{
		case UDM_TOOLTIP_DISPLAY:
		{
			NM_PPTOOLTIP_DISPLAY *pNotify = (NM_PPTOOLTIP_DISPLAY*)lParam;

			GetInfo4ToolTip(pNotify);
			return TRUE;
		}
		case UDM_TOOLTIP_POP:
		{
			m_ttip.Pop();
			return TRUE;
		}
	}

	return CResizableDialog::OnNotify(wParam, lParam, pResult);
}
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
void CSearchDlg::GetInfo4ToolTip(NM_PPTOOLTIP_DISPLAY *pNotify)
{
	int	iControlId = CWnd::FromHandle(pNotify->ti->hWnd)->GetDlgCtrlID();

	if (iControlId == IDC_SEARCHLIST)
	{
		if (m_ctlSearchTabs.GetItemCount() < 1)
			return;

		int				iRating, iSel = GetItemUnderMouse(&m_ctlSearchList);

		if (iSel < 0 || iSel == 65535)
			return;

		CSearchFile		*pSearchFile = reinterpret_cast<CSearchFile*>(m_ctlSearchList.GetItemData(iSel));

		if (pSearchFile == NULL)
			return;

		CKnownFile		*pKnownFile = g_App.m_pSharedFilesList->GetFileByID(pSearchFile->GetFileHash());
		CString			strTemp, strInfo;

		if (pKnownFile == NULL)
			pKnownFile = g_App.m_pDownloadQueue->GetFileByID(pSearchFile->GetFileHash());

		if (pKnownFile != NULL)
		{
			if (pKnownFile->IsPartFile())
				strTemp.Format(_T("%s (%s)"), GetResString(IDS_TREE_DL), ((CPartFile*)pKnownFile)->GetPartFileStatus());
			else
				GetResString(&strTemp, IDS_SHAREDFILES);
		}
		else
		{
			pKnownFile = g_App.m_pKnownFilesList->FindKnownFileByID(pSearchFile->GetFileHash());
			GetResString(&strTemp, (pKnownFile != NULL) ? IDS_KNOWNFILES : IDS_UNKNOWN);
		}

		strInfo.Format(_T("<t=2><b>%s</b><br><t=2>%s<br><t=2>%s<br><hr=100%%><br><b>%s:<t></b>%s (%s %s)<br><b>%s:<t></b>%u<br><b>%s:<t></b>%u<br><b>%s:<t></b>%s"),
			pSearchFile->GetFileName(),
			pSearchFile->GetFileTypeString(),
			strTemp,
			GetResString(IDS_DL_SIZE), CastItoXBytes(pSearchFile->GetFileSize()), CastItoThousands(pSearchFile->GetFileSize()), GetResString(IDS_BYTES),
			GetResString(IDS_DL_SOURCES), pSearchFile->GetSourceCount(),
			GetResString(IDS_SF_COMPLETESRC), pSearchFile->GetCompleteSourceCount(), 
			GetResString(IDS_FILEHASH), HashToString(pSearchFile->GetFileHash()));

		g_App.m_pFakeCheck->GetFakeComment(HashToString(pSearchFile->GetFileHash()), pSearchFile->GetFileSize(), &strTemp);
		strTemp.Replace(_T("<"), _T("<<"));

		if (!strTemp.IsEmpty())
			strInfo.AppendFormat(_T("<br><b>%s:<t></b>%s"), GetResString(IDS_FAKE_CHECK_HEADER), strTemp);

		strTemp = m_ctlSearchList.GetItemText(iSel, SEARCHCOL_LASTSEENCOMPLETE);
		if (!strTemp.IsEmpty())
			strInfo.AppendFormat(_T("<br><b>%s:<t></b>%s"), GetResString(IDS_LASTSEENCOMPLETE), strTemp);

		strTemp = pSearchFile->GetSearchFileDir();
		if (!strTemp.IsEmpty())
			strInfo.AppendFormat(_T("<br><b>%s:<t></b>%s"), GetResString(IDS_SF_FOLDER), strTemp);

		if ((iRating = pSearchFile->GetSrvFileRating()) != PF_RATING_NONE)
		{
			double	dRating;
			uint32	dwUsers;

		//	Convert it to the original crazy format for proper string display
			if (iRating == PF_RATING_FAIR)
				iRating = PF_RATING_GOOD;
			else if (iRating == PF_RATING_GOOD)
				iRating = PF_RATING_FAIR;
			pSearchFile->GetSrvFileRatingEx(&dRating, &dwUsers);
			strInfo.AppendFormat( _T("<br><b>%s:<t></b>%s (%.2f) "), GetResString(IDS_TT_CMT_RATING),
				GetRatingString(static_cast<_EnumPartFileRating>(iRating)), dRating );
			strInfo.AppendFormat(GetResString(IDS_BY_USERS), dwUsers);
		}

		SHFILEINFO		shfi;

		memzero(&shfi, sizeof(shfi));
		SHGetFileInfo(pSearchFile->GetFileName(), FILE_ATTRIBUTE_NORMAL, &shfi, sizeof(shfi), SHGFI_ICON | SHGFI_USEFILEATTRIBUTES);
		pNotify->ti->hIcon = shfi.hIcon;
		pNotify->ti->sTooltip = strInfo;
	}
}
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
void CSearchDlg::OnNMDblclkSearchlist(NMHDR *pNMHDR, LRESULT *pResult)
{
	NOPRM(pNMHDR);
	EMULE_TRY

	OnBnClickedSdownload();
	*pResult = 0;

	EMULE_CATCH
}
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
CString	CSearchDlg::CreateWebQuery()
{
	EMULE_TRY

	CString	strQuery, strToSearch;
	uint32	dwVal;

	GetDlgItemText(IDC_SEARCHNAME, strToSearch);
	switch (methodbox.GetCurSel())
	{
		case EP_SEARCHMETHOD_WEB1:
			strQuery.Format(_T("http://www.filedonkey.com/fdsearch/index.php?pattern=%s"),
				URLEncode(strToSearch));
			GetDlgItemText(IDC_EDITSEARCHMIN, strToSearch);
			dwVal = _tstol(strToSearch);
			GetDlgItemText(IDC_EDITSEARCHMAX, strToSearch);
			strQuery.AppendFormat( _T("&min_size=%I64u&max_size=%I64u"),
				static_cast<uint64>(dwVal) * 1048576ui64,
				static_cast<uint64>(_tstol(strToSearch)) * 1048576ui64 );
			break;
	}
	return strQuery;

	EMULE_CATCH

	return _T("");
}
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
void CSearchDlg::DownloadSelected(bool bPaused)
{
	EMULE_TRY
	int index = -1;
	POSITION pos = m_ctlSearchList.GetFirstSelectedItemPosition();
	while(pos != NULL)
	{
		index = m_ctlSearchList.GetNextSelectedItem(pos);

		if(index > -1)
		{
			int					iCatIdx = m_ctrlCatTabs.GetCurSel();
			EnumCategories		eCatID = (iCatIdx < 1 || iCatIdx > CCat::GetNumUserCats()) ? CAT_NONE : CCat::GetCatIDByUserIndex(iCatIdx);
			CSearchFile			*pSearchFile = (CSearchFile*)m_ctlSearchList.GetItemData(index);

			g_App.m_pDownloadQueue->AddSearchToDownload(pSearchFile, eCatID, bPaused);

			if (pSearchFile->GetLastSeenCompleteValue() == 0x7FFFFFFF && pSearchFile->GetType() == SFT_SERVER)
			{
				g_App.m_pMDlg->AddLogLine(LOG_FL_SBAR | LOG_RGB_WARNING, IDS_SOURCESWARNING, pSearchFile->GetFileName());
			}

			m_ctlSearchList.RedrawItems(index,index);
		}
	}
	EMULE_CATCH
}
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
void CSearchDlg::Localize()
{
	static const int s_aiResTbl[][2] =
	{
		{ IDC_SNAME_LBL, IDS_SW_NAME },
		{ IDC_SNAME_LBL2, IDS_SCH_EXCEPT },
		{ IDC_STYPE_LBL, IDS_SW_TYPE },
		{ IDC_SMETHOD_LBL, IDS_SW_METHOD },
		{ IDC_ED2KLINK_LBL, IDS_SW_LINK },
		{ IDC_STARTS, IDS_SW_START },
		{ IDC_MORES, IDS_SW_MORE },
		{ IDC_CANCELS, IDS_CANCEL },
		{ IDC_CLEARALL, IDS_REMOVEALLSEARCH },
		{ IDC_RESULTS_LBL, IDS_SW_RESULT },
		{ IDC_SDOWNLOAD, IDS_SW_DOWNLOAD },
		{ IDC_SEARCHAVAIL, IDS_SEARCHAVAIL },
		{ IDC_SEARCHEXT, IDS_SEARCHEXTENSION_LBL },
		{ IDC_SEARCH_RESET, IDS_PW_RESET },
		{ IDC_DOWNLOAD_ALL_ED2K, IDS_DOWNLOAD_ALL_ED2K }
	};

	EMULE_TRY
	m_ctlSearchList.Localize();

	for (uint32 i = 0; i < ARRSIZE(s_aiResTbl); i++)
		SetDlgItemText(s_aiResTbl[i][0], GetResString(static_cast<UINT>(s_aiResTbl[i][1])));

	m_ctrlSearchFrm.SetText(GetResString(IDS_SEARCH_NOUN));
	m_ctrlDirectDlFrm.SetText(GetResString(IDS_SW_DIRECTDOWNLOAD));

	SetDlgItemText(IDC_SEARCHMINSIZE, GetResString(IDS_SEARCHMINSIZE) + _T(" (") + GetResString(IDS_MBYTES) + _T(')'));
	SetDlgItemText(IDC_SEARCHMAXSIZE, GetResString(IDS_SEARCHMAXSIZE) + _T(" (") + GetResString(IDS_MBYTES) + _T(')'));

	methodbox.ResetContent();
	methodbox.SetImageList(&m_BoxImageList);
	COMBOBOXEXITEM     cbi;
	cbi.mask = CBEIF_IMAGE | CBEIF_OVERLAY | CBEIF_SELECTEDIMAGE | CBEIF_TEXT;

	CString str[EP_SEARCHMETHOD_COUNT];

	GetResString(&str[EP_SEARCHMETHOD_SERV], IDS_PW_SERVER);
	GetResString(&str[EP_SEARCHMETHOD_GLOB], IDS_SW_GLOBAL);
	str[EP_SEARCHMETHOD_WEB1] = _T("FileDonkey (Web)");
	for (int i = 0; i < EP_SEARCHMETHOD_COUNT; i++)
	{
		cbi.iItem = i;
		cbi.pszText = const_cast<LPTSTR>(str[i].GetString());
		cbi.cchTextMax = str[i].GetLength();
		cbi.iImage = i;
		cbi.iSelectedImage = i;
		cbi.iOverlay = i;
		methodbox.InsertItem(&cbi);
	}
	methodbox.SetCurSel(g_App.m_pPrefs->GetSearchMethod());

	Stypebox.ResetContent();
	Stypebox.AddString(GetResString(IDS_SEARCH_ANY));
	Stypebox.AddString(GetResString(IDS_SEARCH_ARC)+_T(" (.zip .rar .ace...)"));
	Stypebox.AddString(GetResString(IDS_SEARCH_AUDIO)+_T(" (.mp3 .ogg .wav...)"));
	Stypebox.AddString(GetResString(IDS_SEARCH_CDIMG)+_T(" (.iso .bin .nrg...)"));
	Stypebox.AddString(GetResString(IDS_SEARCH_DOC)+_T(" (.doc .txt .pdf...)"));
	Stypebox.AddString(GetResString(IDS_SEARCH_PICS)+_T(" (.jpg .gif .png...)"));
	Stypebox.AddString(GetResString(IDS_SEARCH_PRG)+_T(" (.exe .zip .rar...)"));
	Stypebox.AddString(GetResString(IDS_SEARCH_VIDEO)+_T(" (.avi .mpg .ogm...)"));
	Stypebox.SetCurSel(EP_SCHTYPE_ANY);

	UpdateCatTabs(); //Localization Fix

	EMULE_CATCH
}
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
void CSearchDlg::OnBnClickedClearall()
{
	OnBnClickedCancel();
	DeleteAllSearches();
	SetDlgItemText(IDC_SEARCHNAME, _T(""));
	GetDlgItem(IDC_SEARCHNAME)->SetFocus();
}
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
void CSearchDlg::DoNewEd2kSearch(const CString &strSearch, const CString &strTypeText, uint64 qwMinSize, uint64 qwMaxSize,
	uint32 dwAvailability, const CString &strExtension, bool bDoGlobal, const CString &strSearchExclusion, uint16 nSearchID /*=0*/)
{
	EMULE_TRY

#ifdef OLD_SOCKETS_ENABLED
	if (!g_App.m_pServerConnect->IsConnected())
		return;
#endif //OLD_SOCKETS_ENABLED

//	KuSh: perhaps a messagebox or a message in the log/debuglog could be great
	if (strSearch.IsEmpty() && strExtension.IsEmpty())
	{
		return;
	}

	if (nSearchID == 0)
	{
		m_nSearchID++;
		g_App.m_pSearchList->NewSearch(&m_ctlSearchList, strTypeText, m_nSearchID);
	}
	else
	{
		m_nSearchID = nSearchID;
	}

//	Related files search is allowed only for server search type
	if (bDoGlobal && (_tcsnicmp(strSearch, _T("related:"), 8) == 0))
		bDoGlobal = false;

	m_bCancelled = false;
	m_nMoreRequestCount = 0;

	CString	strType;
	uint32	dwType = ED2KFT_ANY;

	if (GetResString(IDS_SEARCH_AUDIO) == strTypeText)
	{
		strType = _T("Audio");
		dwType = ED2KFT_AUDIO;
	}
	else if (GetResString(IDS_SEARCH_VIDEO) == strTypeText)
	{
		strType = _T("Video");
		dwType = ED2KFT_VIDEO;
	}
//	Archives, CD images and programs are treated the same by servers
	else if (GetResString(IDS_SEARCH_ARC) == strTypeText || GetResString(IDS_SEARCH_PRG) == strTypeText || GetResString(IDS_SEARCH_CDIMG) == strTypeText)
	{
		strType = _T("Pro");
		dwType = ED2KFT_PROGRAM;
	}
	else if (GetResString(IDS_SEARCH_PICS) == strTypeText)
	{
		strType = _T("Image");
		dwType = ED2KFT_IMAGE;
	}
	else if (GetResString(IDS_SEARCH_DOC) == strTypeText)
	{
		strType = _T("Doc");
		dwType = ED2KFT_DOCUMENT;
	}

//	The 2nd stream is used to create a new packet format,
//	as a packet can be sent to different servers we need to prepare 2 different ones
	CMemFile			pckStrm1(100), pckStrm2(100);
	CSearchExprTarget	Targ(&pckStrm1, &pckStrm2);

	uint32	dwTermsCount = 0;

	if (!strExtension.IsEmpty())
		dwTermsCount++;
	if (dwAvailability > 0)
		dwTermsCount++;
	if (qwMaxSize > 0)
		dwTermsCount++;
	if (qwMinSize > 0)
		dwTermsCount++;
	if (!strType.IsEmpty())
		dwTermsCount++;

	uint32			dwParameterCount = 0;

	//	New request creation method that can be processed by the servers with less load (lugdunummaster request)
	//
	//	input:      "a" AND min=1 AND max=2
	//	instead of: AND AND "a" min=1 max=2
	//	we use:     AND "a" AND min=1 max=2

	//	KuSh: all spaces should be parsed !!!
	if (!strSearch.IsEmpty())
	{
		int			iCurPos = 0;
		CString		strResToken = strSearch.Tokenize(_T(" "),iCurPos);
		CString		strOldResToken;

		while (!strResToken.IsEmpty())
		{
			strOldResToken = strResToken;
			strResToken = strSearch.Tokenize(_T(" "), iCurPos);
			if (!strResToken.IsEmpty() || dwTermsCount > 0)
				Targ.AddBooleanAND();
			Targ.AddStringParam(strOldResToken);
		}
	}
	if (!strType.IsEmpty())
	{
		if (++dwParameterCount < dwTermsCount)
			Targ.AddBooleanAND();
		Targ.AddStringParam(FT_FILETYPE, strType, &pckStrm1);
		Targ.AddNumParam(FT_FILETYPE, ED2K_SEARCH_OP_EQUAL, dwType, &pckStrm2);
	}
	if (qwMinSize > 0)
	{
		if (++dwParameterCount < dwTermsCount)
			Targ.AddBooleanAND();
		Targ.AddNumParamMin(FT_FILESIZE, qwMinSize);
	}
	if (qwMaxSize > 0)
	{
		if (++dwParameterCount < dwTermsCount)
			Targ.AddBooleanAND();
		Targ.AddNumParamMax(FT_FILESIZE, qwMaxSize);
	}
	if (dwAvailability > 0)
	{
		if (++dwParameterCount < dwTermsCount)
			Targ.AddBooleanAND();
		Targ.AddNumParamMin(FT_SOURCES, dwAvailability);
	}
	if (!strExtension.IsEmpty())
	{
		if (++dwParameterCount < dwTermsCount)
			Targ.AddBooleanAND();
		Targ.AddStringParam(FT_FILEFORMAT, strExtension);
	}
	ASSERT( dwParameterCount == dwTermsCount );

//	Send new packet format if it's different from the old one and
//	the server supports corresponding features
	uint32	dwSrvTCPFlags = g_App.m_pServerConnect->GetCurrentServer()->GetTCPFlags();
	bool	bHas64bData = Targ.Contains64bitData();
	bool	bNewPckFmt = ( ( bHas64bData &&
		((dwSrvTCPFlags & (SRV_TCPFLG_LARGEFILES | SRV_TCPFLG_TYPETAGINTEGER)) ==
			(SRV_TCPFLG_LARGEFILES | SRV_TCPFLG_TYPETAGINTEGER)) ) ||
		( !bHas64bData && (dwType != ED2KFT_ANY) && (dwSrvTCPFlags & SRV_TCPFLG_TYPETAGINTEGER)) );
	Packet	*pPacket = new Packet((bNewPckFmt) ? &pckStrm2 : &pckStrm1);

	pPacket->m_eOpcode = OP_SEARCHREQUEST;

	g_App.m_pUploadQueue->AddUpDataOverheadServer(pPacket->m_dwSize);
#ifdef OLD_SOCKETS_ENABLED
	g_App.m_pServerConnect->SendPacket(pPacket, false);
#endif //OLD_SOCKETS_ENABLED

	if (bDoGlobal)
	{
	//	Get rid of any old global search packets
		safe_delete(m_pGlobSearchPck);
		safe_delete(m_pGlobSearchPck2);
		m_b64BitSearchPacket = bHas64bData;
	//	Keep packets to use them for UDP search
		if (bNewPckFmt)
		{
			m_pGlobSearchPck = new Packet(&pckStrm1);
			m_pGlobSearchPck2 = pPacket;
		}
		else
		{
			m_pGlobSearchPck = pPacket;
			if (m_b64BitSearchPacket || (dwType != ED2KFT_ANY))
				m_pGlobSearchPck2 = new Packet(&pckStrm2);
		}

		if (g_App.m_pPrefs->GetUseServerPriorities())
			g_App.m_pServerList->ResetSearchServerPos();
		m_uServerCount = 0;
		m_ctlGlobalSearchProgress.SetRange32(0, g_App.m_pServerList->GetServerCount() - 1);
		m_bGlobalSearch = true;
	}
	else
	{
		m_bGlobalSearch = false;
		delete pPacket;
	}

	SearchData		sd;

	sd.sNotSearch = strSearchExclusion;
	sd.bDocumentSearch = (GetResString(IDS_SEARCH_DOC) == strTypeText);
	m_SearchMap.SetAt(m_nSearchID, sd);
	CreateNewTab(strSearch, m_nSearchID);

	EMULE_CATCH
}
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
void CSearchDlg::StartNewSearch()
{
	EMULE_TRY

#ifdef OLD_SOCKETS_ENABLED
//	If we're not connected to a server...
	if (!g_App.m_pServerConnect->IsConnected())
	{
		MessageBox(GetResString(IDS_ERR_NOTCONNECTED), GetResString(IDS_NOTCONNECTED), MB_ICONASTERISK);
	}
	else
#endif //OLD_SOCKETS_ENABLED
	{
		CString			strSearch, strExtension;

		GetDlgItemText(IDC_SEARCHNAME, strSearch);
		strSearch.Trim();
		GetDlgItemText(IDC_EDITSEARCHEXTENSION, strExtension);
		strExtension.Trim();
		if (!strExtension.IsEmpty() && (strExtension[0] == _T('.')))
		{
			strExtension = strExtension.Mid(1);
			SetDlgItemText(IDC_EDITSEARCHEXTENSION, strExtension);	// update GUI
		}

	//	KuSh: perhaps a messagebox or a message in the log/debuglog could be great
		if (strSearch.IsEmpty() && strExtension.IsEmpty())
		{
			return;
		}

		CString			strTypeText, strNum, strSearchExclusion;
		bool			bIsThisGlobal = (methodbox.GetCurSel() == EP_SEARCHMETHOD_GLOB);

		GetDlgItemText(IDC_TYPESEARCH, strTypeText);

		int				idx = strTypeText.Find(_T(" (."));

		if (idx > 0)
			strTypeText.Truncate(idx);

		GetDlgItemText(IDC_EDITSEARCHMIN, strNum);

		uint64	qwMinSize = static_cast<uint64>(_tstol(strNum)) * 0x100000ui64;

		GetDlgItemText(IDC_EDITSEARCHMAX, strNum);

		uint64	qwMaxSize = static_cast<uint64>(_tstol(strNum)) * 0x100000ui64;

	//	If no maximum size is specified or MaxSize < MinSize, don't send maximum size limit
		if (qwMaxSize < qwMinSize)
			qwMaxSize = 0;

		GetDlgItemText(IDC_EDITSEARCHAVAILABILITY, strNum);

		uint32	dwAvailability = _tstoi(strNum);

		GetDlgItemText(IDC_SEARCHNAME_NOT, strSearchExclusion);
		strSearchExclusion.Trim();
		strSearchExclusion.MakeLower();

		if (GetFocus() == GetDlgItem(IDC_STARTS))
			GetDlgItem(IDC_SEARCHNAME)->SetFocus();
		GetDlgItem(IDC_STARTS)->EnableWindow(false);
		GetDlgItem(IDC_MORES)->EnableWindow(false);
		GetDlgItem(IDC_CANCELS)->EnableWindow(true);

		DoNewEd2kSearch(strSearch, strTypeText, qwMinSize, qwMaxSize, dwAvailability,
						strExtension, bIsThisGlobal, strSearchExclusion);
	}

	EMULE_CATCH
}
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
void CSearchDlg::CreateNewTab(const CString &strSearchString, uint32 dwSearchID)
{
	EMULE_TRY
//	Add new tab
	TCITEM	tci;
	CString	strBuff(strSearchString);

	tci.mask = TCIF_PARAM | TCIF_TEXT | TCIF_IMAGE;
	tci.lParam = static_cast<LPARAM>(dwSearchID);
	tci.pszText = (strBuff.IsEmpty()) ? _T("-") : const_cast<LPTSTR>(strBuff.GetString());
	tci.iImage = 0;

	int	iItemIdx = m_ctlSearchTabs.InsertItem(m_ctlSearchTabs.GetItemCount(), &tci);

	if (!m_ctlSearchTabs.IsWindowVisible())
		ShowSearchTabs(SW_SHOW);
	m_ctlSearchTabs.SetCurSel(iItemIdx);
	m_ctlSearchList.ShowResults(dwSearchID);
	EMULE_CATCH
}
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
void CSearchDlg::DeleteSearch(uint32 nSearchID)
{
	EMULE_TRY

	int		i, iItems;
	TCITEM	item;

	item.mask = TCIF_PARAM;
	item.lParam = -1;

	for (i = 0, iItems = m_ctlSearchTabs.GetItemCount(); iItems != i; ++i)
	{
		m_ctlSearchTabs.GetItem(i,&item);
		if (static_cast<uint32>(item.lParam) == nSearchID)
			break;
	}

	if (item.lParam == -1 || item.lParam == 0 || static_cast<uint32>(item.lParam) != nSearchID)
		return;

	if ((!m_bCancelled) && (nSearchID == m_nSearchID))
		OnBnClickedCancel();

	g_App.m_pSearchList->RemoveResults(nSearchID);
	m_ctlSearchTabs.DeleteItem(i);

	if (--iItems)
	{
		if (i >= iItems)
			i = iItems - 1;
		m_ctlSearchTabs.SetCurSel(i);
		item.mask = TCIF_PARAM;
		m_ctlSearchTabs.GetItem(i,&item);
		m_ctlSearchList.ShowResults(item.lParam);
	}
	else
	{
		m_ctlSearchList.DeleteAllItems();
		ShowSearchTabs(SW_HIDE);
		m_ctlSearchList.NoTabs();
	}

	EMULE_CATCH
}
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
void CSearchDlg::DeleteAllSearches()
{
	EMULE_TRY

	g_App.m_pSearchList->Clear();
	m_ctlSearchList.DeleteAllItems();
	ShowSearchTabs(SW_HIDE);
	m_ctlSearchTabs.DeleteAllItems();

	EMULE_CATCH
}
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
void CSearchDlg::OnTcnSelchangeTab1(NMHDR *pNMHDR, LRESULT *pResult)
{
	NOPRM(pNMHDR);
	EMULE_TRY

	const int iCurrentTab = m_ctlSearchTabs.GetCurSel();

	if (iCurrentTab == -1)
		return;

	TCITEM item;
	item.mask = TCIF_PARAM;
	m_ctlSearchTabs.GetItem(iCurrentTab, &item);
	m_ctlSearchList.ShowResults(item.lParam);
	GetDlgItem(IDC_MORES)->EnableWindow(false);

	*pResult = 0;

	EMULE_CATCH
}
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
LRESULT CSearchDlg::OnCloseTab(WPARAM wparam, LPARAM lparam)
{
	NOPRM(lparam);
	EMULE_TRY

	TCITEM item;
	item.mask = TCIF_PARAM;
	int i = (int)wparam;
	m_ctlSearchTabs.GetItem(i,&item);
	uint32	dwSearchID = static_cast<uint32>(item.lParam);

	if (!m_bCancelled && ((dwSearchID == m_nSearchID) || (m_ctlSearchTabs.GetItemCount() == 1)))
		OnBnClickedCancel();  // Cancel active search before closing active tab

	DeleteSearch(dwSearchID);
	GetDlgItem(IDC_MORES)->EnableWindow(false);

	return true;

	EMULE_CATCH

	return false;
}
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
void CSearchDlg::OnEnChangeSearchname()
{
	GetDlgItem(IDC_CANCELS)->EnableWindow(!m_bCancelled);
	GetDlgItem(IDC_MORES)->EnableWindow(false);
}
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
void CSearchDlg::OnBnClickedSearchReset()
{
	static const uint16 s_auResID[] = {
		IDC_EDITSEARCHAVAILABILITY, IDC_EDITSEARCHEXTENSION, IDC_EDITSEARCHMIN,
		IDC_EDITSEARCHMAX, IDC_SEARCHNAME, IDC_SEARCHNAME_NOT
	};

	for(unsigned ui = 0; ui < ARRSIZE(s_auResID); ui++)
		SetDlgItemText(s_auResID[ui], _T(""));
	Stypebox.SetCurSel(EP_SCHTYPE_ANY);
	GetDlgItem(IDC_SEARCHNAME)->SetFocus();
}
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
void CSearchDlg::OnEnChangeMethod()
{
	static const uint16 s_auResID[] = {
		IDC_SEARCHNAME_NOT,	IDC_TYPESEARCH,	IDC_EDITSEARCHMIN,
		IDC_EDITSEARCHMAX,	IDC_EDITSEARCHAVAILABILITY,	IDC_EDITSEARCHEXTENSION
	};
	unsigned uiMask = EP_SCHCTRL_EXT | EP_SCHCTRL_AVAIL | EP_SCHCTRL_MAX | EP_SCHCTRL_MIN | EP_SCHCTRL_TYPE | EP_SCHCTRL_EXCL;
	int	iCurSel = methodbox.GetCurSel();

	g_App.m_pPrefs->SetSearchMethod(static_cast<byte>(iCurSel));
	switch (iCurSel)
	{
		case EP_SEARCHMETHOD_WEB1:
			uiMask = EP_SCHCTRL_MAX | EP_SCHCTRL_MIN;
			break;
	}
	for(unsigned ui = 0; ui < ARRSIZE(s_auResID); ui++, uiMask >>= 1)
		GetDlgItem(s_auResID[ui])->EnableWindow(static_cast<BOOL>(uiMask & 1));
}
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
void CSearchDlg::SearchClipBoard()
{
	EMULE_TRY

	if (m_bGuardCBPrompt)
		return;

	CString	strClipBoard;

	if (!g_App.CopyTextFromClipboard(&strClipBoard))
		return;

	strClipBoard.Trim();
	if (strClipBoard.IsEmpty() || (strClipBoard.Compare(m_strLastClipBoard) == 0))
		return;

	if (strClipBoard.Left(13).CompareNoCase(_T("ed2k://|file|")) == 0)
	{
		m_bGuardCBPrompt = true;

		if (AfxMessageBox(GetResString(IDS_ADDDOWNLOADSFROMCB) + strClipBoard, MB_YESNO | MB_SETFOREGROUND | MB_ICONQUESTION) == IDYES)
		{
			EnumCategories	eCatID = CAT_NONE;

			AddEd2kLinksToDownload(strClipBoard, eCatID);
		}
	}
	m_strLastClipBoard = strClipBoard;
	m_bGuardCBPrompt = false;

	EMULE_CATCH
}
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
void CSearchDlg::AddEd2kLinksToDownload(CString strLink, EnumCategories eCatID)
{
	EMULE_TRY

	CString	resToken;
	int		curPos = 0;

	for (;;)
	{
		resToken = strLink.Tokenize(_T("\t\n\r"), curPos);
		resToken.Trim();
		if (resToken.IsEmpty())
			break;

		if (resToken.Right(1) != _T("/"))
			resToken += _T("/");

		try
		{
			CED2KLink	   *pLink = CED2KLink::CreateLinkFromUrl(resToken);

			_ASSERT( pLink !=0 );
			if (pLink->GetKind() == CED2KLink::kFile)
			{
				g_App.m_pDownloadQueue->AddFileLinkToDownload(pLink->GetFileLink(),eCatID);
			}
			else if (pLink->GetKind() == CED2KLink::kServer)
			{
				CString 			strName;
				CED2KServerLink* 	pSrvLink = pLink->GetServerLink();
				CServer* 			pSrv = new CServer(pSrvLink->GetPort(), pSrvLink->GetAddress());

				pSrvLink->GetDefaultName(strName);
				pSrv->SetListName(strName);
				if (g_App.m_pPrefs->GetManuallyAddedServerHighPrio())
					pSrv->SetPreference(PR_HIGH);

				if (!g_App.m_pMDlg->m_wndServer.m_ctlServerList.AddServer(pSrv, true))
					delete pSrv;
				else
					g_App.m_pMDlg->AddLogLine(LOG_FL_SBAR, IDS_SERVERADDED, pSrv->GetListName());
			}
			else
			{
				delete pLink;
				throw CString(_T("bad link"));
			}
			delete pLink;
		}
		catch(CString error)
		{
			OUTPUT_DEBUG_TRACE();
			g_App.m_pMDlg->AddLogLine(LOG_FL_SBAR | LOG_RGB_WARNING, IDS_ERR_INVALIDLINK, error);
		}
	}

	EMULE_CATCH
}
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
void CSearchDlg::OnBnClickedDownloadAllEd2k()
{
	EMULE_TRY

	CString			strClipboard;

	if (!g_App.CopyTextFromClipboard(&strClipboard))
		return;

	const TCHAR		*text = strClipboard.GetString();
	CString			newlink;
	CString			msglinks;
	CTypedPtrList<CPtrList, CED2KLink*>	links;

	while (_tcsnextc(text))
	{
		if (_tcsnicmp(text, _T("ed2k://"), CSTRLEN(_T("ed2k://"))) == 0)
		{
			bool bLinkEnded = false;
			unsigned prevchar = 0;
			while (_tcsnextc(text))
			{
				if (_tcsnextc(text) == _T('\n'))
				{
					text = _tcsinc(text);
					continue;
				}
				else if (_tcsnextc(text) == _T('\r'))
				{
					text = _tcsinc(text);
					continue;
				}
				else if (_tcsncmp(text, _T("> "), CSTRLEN(_T("> "))) == 0)
				{
					text += _tcslen(_T("> "));
					continue;
				}
				else if (_tcsnextc(text) == _T('>'))
				{
					text = _tcsinc(text);
					continue;
				}
				newlink.AppendChar(static_cast<TCHAR>(_tcsnextc(text)));

				TCHAR nextchar = static_cast<TCHAR>(_tcsnextc(_tcsinc(text)));

				// Link ends with "|/"
				if ((_tcsnextc(text) == _T('/')) && ((nextchar != _T('|')) && (nextchar != _T('/'))))
					bLinkEnded = true;

				// Link ends with "|"
				if ( (_tcsnextc(text) == _T('|')) && (prevchar != _T('/'))
				    && (_tcschr(_T(" \""), nextchar) || _tcschr(_T("\r\n"), nextchar)) )
				{
					newlink.AppendChar(_T('/'));
					bLinkEnded = true;
				}

				if (bLinkEnded)
				{
					try
					{
						CED2KLink* pLink = CED2KLink::CreateLinkFromUrl(newlink);
						_ASSERT( pLink != 0 );
						if ( pLink->GetKind() == CED2KLink::kFile)
						{
							msglinks += newlink;
							msglinks += _T('\n');
							links.AddTail(pLink);
						}
						else
						{
							delete pLink;
						}
					}
					catch(...)
					{
					}

					newlink = _T("");
					break;
				}
				prevchar = _tcsnextc(text);
				text = _tcsinc(text);
			}
		}
		text = _tcsinc(text);
	}
	if (links.IsEmpty())
	{
		MessageBox(GetResString(IDS_ED2KNOLINKFROMCLIPBOARD)); //"No ED2K links found in clipboard"
	}
	else
	{
		CString	msg;

		msg.Format(GetResString(IDS_ED2KCONFIRMFROMCLIPBOARD), msglinks); // "Add to downloads these links?\n%s", msglinks

		int		retvalue = MessageBox(msg, NULL, MB_YESNO);

		if (retvalue == IDYES)
		{
			int					iCatIdx = m_ctrlCatTabs.GetCurSel();
			EnumCategories		eCatID = (iCatIdx < 1 || iCatIdx > CCat::GetNumUserCats()) ? CAT_NONE : CCat::GetCatIDByUserIndex(iCatIdx);

			while (!links.IsEmpty())
			{
				g_App.m_pDownloadQueue->AddFileLinkToDownload(links.GetHead()->GetFileLink(),eCatID);
				delete links.RemoveHead();
			}
		}
		else
		{
			while (!links.IsEmpty())
				delete links.RemoveHead();
		}
	}

	EMULE_CATCH
}
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
void CSearchDlg::OnDestroy()
{
	EMULE_TRY

	CResizableDialog::OnDestroy();
	//Resources cleanup - [TwoBottle Mod]
	DestroyIcon(GetSearchLstStatic()->SetIcon(oldSearchLstIcon));
	m_BoxImageList.DeleteImageList();	// eklmn: bugfix(01): resource cleanup due to ImageLists recreation

	EMULE_CATCH
}
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// Ultras - to set a focus in the search field
LRESULT CSearchDlg::OnShowWindow(WPARAM wparam, LPARAM lparam)
{
	const LRESULT	ret = DefWindowProc( WM_SHOWWINDOW, wparam, lparam );

	if( !ret && wparam && !lparam )
		GetDlgItem(IDC_SEARCHNAME)->SetFocus();

	return ret;
}
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
CString CSearchDlg::GetNotSearch(int nSearchId)
{
	SearchData	sd;

	if(m_SearchMap.Lookup(nSearchId, sd))
		return sd.sNotSearch;
	else
		return _T("");
}
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
bool CSearchDlg::IsDocumentSearch(int nSearchId)
{
	SearchData	sd;

	if(m_SearchMap.Lookup(nSearchId, sd))
		return sd.bDocumentSearch;
	else
		return false;
}
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
void CSearchDlg::UpdateCatTabs()
{
	CString	strBuff;
	int		oldsel = m_ctrlCatTabs.GetCurSel();

	m_ctrlCatTabs.DeleteAllItems();
	m_ctrlCatTabs.InsertItem(0, ::GetResString(IDS_CAT_UNCATEGORIZED));
	for (int ix = 1; ix <= CCat::GetNumUserCats(); ix++)
	{
		strBuff = CCat::GetCatByUserIndex(ix)->GetTitle();
		strBuff.Replace(_T("&"), _T("&&"));
		m_ctrlCatTabs.InsertItem(ix, strBuff);
	}

	if (oldsel == -1 || oldsel >= m_ctrlCatTabs.GetItemCount())
		oldsel = 0;

	m_ctrlCatTabs.SetCurSel(oldsel);

	int		flag = (m_ctrlCatTabs.GetItemCount() > 1) ? SW_SHOW : SW_HIDE;

	GetDlgItem(IDC_CATTAB2)->ShowWindow(flag);
	GetDlgItem(IDC_STATIC_DLTOof)->ShowWindow(flag);
}
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
void CSearchDlg::KeepHistoryChanged()
{
	if (m_pacSearchString != NULL)
		m_pacSearchString->Clear();
}
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
void CSearchDlg::SaveSearchStrings()
{
	if (m_pacSearchString == NULL)
		return;
	m_pacSearchString->SaveList(g_App.m_pPrefs->GetConfigDir() + _T("\\") SEARCH_STRINGS_PROFILE);
}
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
void CSearchDlg::OnBnClickedMore()
{
	EMULE_TRY

	if (!GetDlgItem(IDC_MORES)->IsWindowEnabled())
		return;

	if (!g_App.m_pServerConnect->IsConnected())
	{
		MessageBox(GetResString(IDS_ERR_NOTCONNECTED), GetResString(IDS_NOTCONNECTED), MB_ICONASTERISK);
		return;
	}

	if (GetFocus() == GetDlgItem(IDC_MORES))
		GetDlgItem(IDC_SEARCHNAME)->SetFocus();
	GetDlgItem(IDC_STARTS)->EnableWindow(false);
	GetDlgItem(IDC_MORES)->EnableWindow(false);
	GetDlgItem(IDC_CANCELS)->EnableWindow(true);

	Packet		*pPacket = new Packet(OP_EDONKEYPROT);

	pPacket->m_eOpcode = OP_QUERY_MORE_RESULT;

	g_App.m_pUploadQueue->AddUpDataOverheadServer(pPacket->m_dwSize);
#ifdef OLD_SOCKETS_ENABLED
	g_App.m_pServerConnect->SendPacket(pPacket,true);
#endif //OLD_SOCKETS_ENABLED

	m_nMoreRequestCount++;

	EMULE_CATCH
}
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
void CSearchDlg::ShowSearchTabs(int iCmdShow)
{
	EMULE_TRY

	WINDOWPLACEMENT	wpSearchListWinPos;
	WINDOWPLACEMENT	wpSearchTabsWinPos;

	m_ctlSearchTabs.GetWindowPlacement(&wpSearchTabsWinPos);
	m_ctlSearchList.GetWindowPlacement(&wpSearchListWinPos);

	if (iCmdShow == SW_SHOW)
	{
		wpSearchListWinPos.rcNormalPosition.top = wpSearchTabsWinPos.rcNormalPosition.bottom;
	}
	else
	{
		wpSearchListWinPos.rcNormalPosition.top = wpSearchTabsWinPos.rcNormalPosition.top;
	}

	m_ctlSearchTabs.ShowWindow(iCmdShow);
	RemoveAnchor(m_ctlSearchList);
	m_ctlSearchList.SetWindowPlacement(&wpSearchListWinPos);
	AddAnchor(m_ctlSearchList,TOP_LEFT,BOTTOM_RIGHT);
	GetDlgItem(IDC_CLEARALL)->ShowWindow(iCmdShow);

	EMULE_CATCH
}
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
void CSearchDlg::ProcessEd2kSearchLinkRequest(const TCHAR *pcSearchTerm)
{
	// We have a ed2k search link, asking us to search for stuff
	// For now we handle this very basic: Put the search term into the params window (so the users can also see it)
	// And if we are connected, start the search otherwise not.
	OnBnClickedSearchReset();
	SetDlgItemText(IDC_ELINK, _T(""));
	SetDlgItemText(IDC_SEARCHNAME, pcSearchTerm);
	switch (methodbox.GetCurSel())
	{
		case EP_SEARCHMETHOD_SERV:
		case EP_SEARCHMETHOD_GLOB:
		default:
			if (!g_App.m_pServerConnect->IsConnected())
				break;
		case EP_SEARCHMETHOD_WEB1:
			OnBnClickedStart();
			break;
	}
}
@


1.200
log
@Added search ed2k link support (from original) {eeeeh}; Minor renaming.
@
text
@d243 1
a243 2
		IDI_SCH_WEB2,		//EP_SEARCHMETHOD_WEB1
		IDI_TRAYICON_GREY	//EP_SEARCHMETHOD_WEB2
a439 1
			case EP_SEARCHMETHOD_WEB2:
a804 47
		{
		//	The only one required field is q
			strQuery.Format(_T("http://www.emugle.com/search.php?q=%s"), URLEncode(strToSearch));

			dwVal = Stypebox.GetCurSel();

			const TCHAR *pcType = NULL;

			switch (dwVal)
			{
				case EP_SCHTYPE_ARC:
					pcType = _T("Archive");
					break;
				case EP_SCHTYPE_AUDIO:
					pcType = _T("Audio");
					break;
				case EP_SCHTYPE_CDIMG:
					pcType = _T("CD+Image");
					break;
				case EP_SCHTYPE_PICS:
					pcType = _T("Image");
					break;
				case EP_SCHTYPE_VIDEO:
					pcType = _T("Video");
					break;
			}
			if (pcType != NULL)
				strQuery.AppendFormat(_T("&t=%s"), pcType);

			GetDlgItemText(IDC_SEARCHNAME_NOT, strToSearch);
			if (!strToSearch.IsEmpty())
				strQuery.AppendFormat(_T("&ex=%s"), URLEncode(strToSearch));	// multiple items allowed

			GetDlgItemText(IDC_EDITSEARCHMIN, strToSearch);
			if ((dwVal = _tstol(strToSearch)) != 0)
				strQuery.AppendFormat(_T("&mins=%u"), dwVal);

			GetDlgItemText(IDC_EDITSEARCHMAX, strToSearch);
			if ((dwVal = _tstol(strToSearch)) != 0)
				strQuery.AppendFormat(_T("&maxs=%u"), dwVal);

			GetDlgItemText(IDC_EDITSEARCHAVAILABILITY, strToSearch);
			if ((dwVal = _tstol(strToSearch)) != 0)
				strQuery.AppendFormat(_T("&avai=%u"), dwVal);
			break;
		}
		case EP_SEARCHMETHOD_WEB2:
d892 1
a892 2
	str[EP_SEARCHMETHOD_WEB1] = _T("eMugle (Web)");
	str[EP_SEARCHMETHOD_WEB2] = _T("FileDonkey (Web)");
d1353 1
a1353 1
		case EP_SEARCHMETHOD_WEB2:
a1355 3
		case EP_SEARCHMETHOD_WEB1:
			uiMask = EP_SCHCTRL_AVAIL | EP_SCHCTRL_MAX | EP_SCHCTRL_MIN | EP_SCHCTRL_TYPE | EP_SCHCTRL_EXCL;
			break;
a1731 1
		case EP_SEARCHMETHOD_WEB2:
@


1.199
log
@Fixed a bunch of DynIP server related issues.
@
text
@d346 3
a348 3
	ON_BN_CLICKED(IDC_STARTS, OnBnClickedStarts)
	ON_BN_CLICKED(IDC_MORES, OnBnClickedMores)
	ON_BN_CLICKED(IDC_CANCELS, OnBnClickedCancels)
d404 1
a404 1
void CSearchDlg::OnBnClickedStarts()
d526 1
a526 1
			OnBnClickedCancels();
d531 1
a531 1
		OnBnClickedCancels();
d536 1
a536 1
void CSearchDlg::OnBnClickedCancels()
d567 1
a567 1
			OnBnClickedCancels();
d605 1
a605 1
		OnBnClickedCancels();
d649 1
a649 1
					OnBnClickedStarts();
d661 1
a661 1
				OnBnClickedStarts();
d973 1
a973 1
	OnBnClickedCancels();
d1291 1
a1291 1
		OnBnClickedCancels();
d1359 2
a1360 2
	if ((!m_bCancelled) && ((dwSearchID == m_nSearchID) || (m_ctlSearchTabs.GetItemCount() == 1)))
		OnBnClickedCancels();  // Cancel active search before closing active tab
d1380 7
a1386 6
	SetDlgItemText(IDC_EDITSEARCHAVAILABILITY, _T(""));
	SetDlgItemText(IDC_EDITSEARCHEXTENSION, _T(""));
	SetDlgItemText(IDC_EDITSEARCHMIN, _T(""));
	SetDlgItemText(IDC_EDITSEARCHMAX, _T(""));
	SetDlgItemText(IDC_SEARCHNAME, _T(""));
	SetDlgItemText(IDC_SEARCHNAME_NOT, _T(""));
d1650 1
a1650 1
CString	CSearchDlg::GetNotSearch(int nSearchId)
d1708 1
a1708 1
void CSearchDlg::OnBnClickedMores()
d1769 21
@


1.198
log
@Reduced H-file dependency.
@
text
@d519 1
a519 1
					pNextServer->GetFullIP(), pNextServer->GetVersion(), dwSrvUDPFlags );
@


1.197
log
@Renamed server link interface services -- IP replaced with address as it's not only IP for DynIP servers (similar to original).
@
text
@d30 3
@


1.196
log
@Reduced H-file dependency.
@
text
@d1473 1
a1473 1
				CServer* 			pSrv = new CServer(pSrvLink->GetPort(), pSrvLink->GetIP());
@


1.195
log
@Unified list column definitions.
@
text
@d27 1
@


1.194
log
@Reduced H-file dependency.
@
text
@d748 1
a748 1
		strTemp = m_ctlSearchList.GetItemText(iSel, SL_COLUMN_LASTSEENCOMPLETE);
@


1.193
log
@IDS_ADDDOWNLOADSFROMCB run time formatting was moved to resource files.
@
text
@d24 1
@


1.192
log
@Simplified logging system implementation.
@
text
@d1428 1
a1428 1
		if (AfxMessageBox(GetResString(IDS_ADDDOWNLOADSFROMCB) + _T("\r\n") + strClipBoard, MB_YESNO | MB_SETFOREGROUND | MB_ICONQUESTION) == IDYES)
@


1.191
log
@Reduced H-file dependency.
@
text
@d513 1
a513 1
				g_App.m_pMDlg->AddDebugLogLine( RGB_CHOCOLATE_TXT _T("Skipped large file UDP search request to server %s (%s, Flags %#x)"),
d885 1
a885 1
				g_App.m_pMDlg->AddLogLine(true, RGB_LOG_WARNING + GetResString(IDS_SOURCESWARNING), pSearchFile->GetFileName());
d1481 1
a1481 1
					g_App.m_pMDlg->AddLogLine(true, IDS_SERVERADDED, pSrv->GetListName());
d1493 1
a1493 1
			g_App.m_pMDlg->AddLogLine(true, RGB_LOG_WARNING + GetResString(IDS_ERR_INVALIDLINK), error);
@


1.190
log
@added Unicode support for search on server
@
text
@d24 1
@


1.189
log
@added Unicode support for clipboard
@
text
@d107 3
d112 1
a112 1
		POKE_WORD(&abytePar[1], static_cast<uint16>(strVal.GetLength()));	// string length
d115 1
a115 1
		m_pStrm1->Write(strVal, strVal.GetLength());
d117 1
a117 1
		m_pStrm2->Write(strVal, strVal.GetLength());
d123 3
d128 1
a128 1
		POKE_WORD(&abytePar[1], static_cast<uint16>(strVal.GetLength()));	// string length
d133 1
a133 1
		pStrm->Write(strVal, strVal.GetLength());
d1011 1
a1011 1
		strType = "Audio";
d1016 1
a1016 1
		strType = "Video";
d1022 1
a1022 1
		strType = "Pro";
d1027 1
a1027 1
		strType = "Image";
d1032 1
a1032 1
		strType = "Doc";
@


1.188
log
@Used appropriate constants intead of numbers.
@
text
@d1408 4
a1411 1
	CString	strClipBoard(g_App.CopyTextFromClipboard());
d1497 6
a1502 2
	CString			clipboard = g_App.CopyTextFromClipboard();
	const TCHAR	   *text = clipboard;
@


1.187
log
@Fixed 'improved comment processing' which screwed comment processing big time.
@
text
@d1171 1
a1171 1
		MessageBox(GetResString(IDS_ERR_NOTCONNECTED), GetResString(IDS_NOTCONNECTED), 64);
d1697 1
a1697 1
		MessageBox(GetResString(IDS_ERR_NOTCONNECTED), GetResString(IDS_NOTCONNECTED), 64);
@


1.186
log
@improved comment processing
@
text
@d760 1
a760 1
				GetRatingString(static_cast<EnumPartFileRating>(iRating)), dRating );
@


1.185
log
@1) renamed GetFakeCheckComment() into GetFakeComment()
2) GetFakeComment() returns the string over parameter
3) removed LastHit interface
@
text
@d760 1
a760 1
				GetRatingString(static_cast<_EnumPartFileRating>(iRating)), dRating );
@


1.184
log
@Wrong max search limit was sent to servers when more than 4GB was specified;
Robust case insensitive ed2k link parsing {Avi-3k}; Suppressed compiler warnings.
@
text
@d734 1
a734 1
		strTemp = g_App.m_pFakeCheck->GetFakeCheckComment(HashToString(pSearchFile->GetFileHash()), pSearchFile->GetFileSize());
@


1.183
log
@removed the function ToQueryString()
@
text
@d109 1
a109 1
		POKE_WORD(&abytePar[1], strVal.GetLength());	// string length
d122 1
a122 1
		POKE_WORD(&abytePar[1], strVal.GetLength());	// string length
d180 1
a180 1
	void AddNumParamMax(byte byteTagID, uint32 qwVal)
d409 2
a410 2
		byte			iCatIndex = m_ctrlCatTabs.GetCurSel();
		EnumCategories	eCatID = (iCatIndex < 1 || iCatIndex > CCat::GetNumUserCats()) ? CAT_NONE : CCat::GetCatIDByUserIndex(iCatIndex);
d870 2
a871 2
			byte				iCatIndex = m_ctrlCatTabs.GetCurSel();
			EnumCategories		eCatID = (iCatIndex < 1 || iCatIndex > CCat::GetNumUserCats()) ? CAT_NONE : CCat::GetCatIDByUserIndex(iCatIndex);
d1249 1
a1249 1
	uint16	uItemIdx = m_ctlSearchTabs.InsertItem(m_ctlSearchTabs.GetItemCount(), &tci);
d1253 1
a1253 1
	m_ctlSearchTabs.SetCurSel(uItemIdx);
d1387 1
a1387 1
	g_App.m_pPrefs->SetSearchMethod(iCurSel);
a1400 16
// Download all ed2ks in clipboard
bool isprefix(const TCHAR* prefix, const TCHAR* string)
{
	EMULE_TRY
	while (_tcsnextc(prefix))
	{
		if (_tcsnextc(prefix) != _tcsnextc(string))
			return false;
		prefix = _tcsinc(prefix);
		string = _tcsinc(string);
	}
	return true;
	EMULE_CATCH
	return false;
}
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
d1502 1
a1502 1
		if (isprefix(_T("ed2k://"), text))
d1505 1
a1505 1
			TCHAR prevchar = 0;
d1518 1
a1518 1
				else if (isprefix(_T("> "), text))
d1528 1
a1528 1
				newlink.AppendChar(_tcsnextc(text));
d1530 1
a1530 1
				TCHAR nextchar = _tcsnextc(_tcsinc(text));
d1588 2
a1589 2
			byte				iCatIndex = m_ctrlCatTabs.GetCurSel();
			EnumCategories		eCatID = (iCatIndex < 1 || iCatIndex > CCat::GetNumUserCats()) ? CAT_NONE : CCat::GetCatIDByUserIndex(iCatIndex);
@


1.182
log
@improved optimization (thanks Aw3)
@
text
@d797 1
a797 1
			strQuery.Format(_T("http://www.emugle.com/search.php?q=%s"), ToQueryString(strToSearch));
d826 1
a826 1
				strQuery.AppendFormat(_T("&ex=%s"), ToQueryString(strToSearch));	// multiple items allowed
d843 1
a843 1
				ToQueryString(strToSearch));
a858 10
CString	CSearchDlg::ToQueryString(const CString& strQuery)
{
	CString strTemp(strQuery);

// do in place replacement of the space by the '+'
	strTemp.Replace(_T(" "), _T("+"));

	return URLEncode(strTemp);
}
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
@


1.181
log
@optimization: get encoded string with minimal reallocation
@
text
@d859 1
a859 1
CString	CSearchDlg::ToQueryString(CString strQuery)
d861 2
d864 1
a864 1
	strQuery.Replace(_T(" "), _T("+"));
d866 1
a866 1
	return URLEncode(strQuery);
@


1.180
log
@Shortened category services [Aw3].
@
text
@d859 1
a859 1
CString	CSearchDlg::ToQueryString(const CString &str)
d861 2
a862 1
	CString strTmp = URLEncode(str);
d864 1
a864 2
	strTmp.Replace(_T("%20"), _T("+"));
	return strTmp;
@


1.179
log
@Added 'Keep search history' setting to preserve or not search history [Aw3];
Generate less code for some logging; Clean-up [Aw3].
@
text
@d1683 1
a1683 1
		strBuff = CCat::GetCatByIndex(CCat::UserCatIndexToCatIndex(ix))->GetTitle();
@


1.178
log
@Corrected casting; Some minor clean-up.
@
text
@d216 1
a216 1
	if (m_pacSearchString)
d292 4
a295 1
		m_pacSearchString->LoadList(g_App.m_pPrefs->GetConfigDir() + _T("\\") SEARCH_STRINGS_PROFILE);
d419 1
a419 1
			if (GetDlgItemText(IDC_SEARCHNAME, strTemp))
d1432 1
a1432 1
	CString m_strClipBoard = g_App.CopyTextFromClipboard().Trim();
d1434 2
a1435 1
	if (m_strClipBoard == _T(""))
d1438 1
a1438 4
	if (m_strClipBoard.Compare(m_strLastClipBoard)==0)
		return;

	if (m_strClipBoard.Left(13).CompareNoCase(_T("ed2k://|file|"))==0)
d1440 1
a1440 1
		m_bGuardCBPrompt=true;
d1442 1
a1442 1
		if (AfxMessageBox(GetResString(IDS_ADDDOWNLOADSFROMCB)+_T("\r\n") + m_strClipBoard, MB_YESNO | MB_SETFOREGROUND | MB_ICONQUESTION )== IDYES)
d1446 1
a1446 1
			AddEd2kLinksToDownload(m_strClipBoard, eCatID);
d1449 1
a1449 1
	m_strLastClipBoard = m_strClipBoard;
d1455 1
a1455 1
void CSearchDlg::AddEd2kLinksToDownload(CString strLink,EnumCategories eCatID)
d1495 1
a1495 1
					g_App.m_pMDlg->AddLogLine(true, GetResString(IDS_SERVERADDED), pSrv->GetListName());
d1680 1
a1680 1
	m_ctrlCatTabs.InsertItem(0,::GetResString(IDS_CAT_UNCATEGORIZED));
d1699 7
a1705 1
BOOL CSearchDlg::SaveSearchStrings()
d1708 2
a1709 2
		return FALSE;
	return m_pacSearchString->SaveList(CString(g_App.m_pPrefs->GetConfigDir()) + _T("\\") SEARCH_STRINGS_PROFILE);
d1721 1
a1721 1
		MessageBox(GetResString(IDS_ERR_NOTCONNECTED),GetResString(IDS_NOTCONNECTED),64);
@


1.177
log
@Reverted back #include was moved to C-file;
Correct fix for level 4 warnings {Aw3}.
@
text
@a17 3
// SearchDlg.cpp : implementation file
//

d250 1
a250 1
	m_BoxImageList.Create(16, 16, g_App.m_iDfltImageListColorFlags|ILC_MASK, ELEMENT_COUNT(s_auIconResID), 0);
d252 1
a252 1
	FillImgLstWith16x16Icons(&m_BoxImageList, s_auIconResID, ELEMENT_COUNT(s_auIconResID));
d916 1
a916 1
	for (uint32 i = 0; i < ELEMENT_COUNT(s_aiResTbl); i++)
d1350 1
a1350 1
	UINT nSearchID = static_cast<UINT>(item.lParam);
d1352 1
a1352 1
	if ((!m_bCancelled) && ((nSearchID == m_nSearchID) || (m_ctlSearchTabs.GetItemCount() == 1)))
d1355 1
a1355 1
	DeleteSearch(nSearchID);
@


1.176
log
@#include was moved to C-file.
Suppressed level 4 warnings.
@
text
@a29 1
#include "IconStatic.h"
d1279 1
a1279 1
		if (static_cast<UINT>(item.lParam) == nSearchID)
d1283 1
a1283 1
	if (item.lParam == -1 || item.lParam == 0 || static_cast<UINT>(item.lParam) != nSearchID)
@


1.175
log
@Corrected usage of "Set manually added servers to High Priority" when added through a link {gnwd}.
@
text
@d30 1
d635 1
a635 1
					((CEdit*)GetDlgItem(IDC_SEARCHNAME))->SetSel(-1);
d776 1
d778 1
d781 1
d1280 1
a1280 1
		if (item.lParam == nSearchID)
d1284 1
a1284 1
	if (item.lParam == -1 || item.lParam == NULL || item.lParam != nSearchID)
d1315 1
d1320 1
d1326 1
d1347 1
d1354 1
a1354 1
	int nSearchID = item.lParam;
@


1.174
log
@Modified constructors to avoid potential compiling issue due to type collision.
@
text
@d1483 3
a1485 2
				pSrv->SetListName(strName.GetBuffer());
				pSrv->SetPreference(PR_HIGH);
d1487 1
a1487 1
				if (!g_App.m_pMDlg->m_wndServer.m_ctlServerList.AddServer(pSrv,true))
@


1.173
log
@Improved string processing.
@
text
@d1719 1
a1719 1
	Packet		*pPacket = new Packet();
@


1.172
log
@Large file size support (max file size 512 GB - 1 = 549,755,813,887).
@
text
@d1457 6
a1462 2
	resToken = strLink.Tokenize(_T("\t\n\r"),curPos);
	resToken.Trim();
a1463 2
	while (resToken != _T(""))
	{
a1502 2
		resToken = strLink.Tokenize(_T("\t\n\r"),curPos);
		resToken.Trim();
@


1.171
log
@Faster tooltip preparation in the search list.
@
text
@a466 1
#if _LARGEFILE_READY
d475 1
a475 1
				tagWr.WriteNewEd2kTag(CT_SERVER_UDPSEARCH_FLAGS, SRVCAP_UDP_NEWTAGS_LARGEFILES, pckStrm);
a488 3
#else
			if (!m_b64BitSearchPacket)
#endif
@


1.170
log
@Large file size support preparations.
@
text
@d733 1
a733 1
			GetResString(IDS_DL_SIZE), CastItoXBytes(pSearchFile->GetIntTagValue(FT_FILESIZE)), CastItoThousands(pSearchFile->GetIntTagValue(FT_FILESIZE)), GetResString(IDS_BYTES),
@


1.169
log
@Large file size support preparations.
@
text
@d80 1
d88 1
a88 2
		if (m_pStrm2)
			m_pStrm2->Write(&s_aBoolPar, sizeof(s_aBoolPar));
d96 1
a96 2
		if (m_pStrm2)
			m_pStrm2->Write(&s_aBoolPar, sizeof(s_aBoolPar));
d104 1
a104 2
		if (m_pStrm2)
			m_pStrm2->Write(&s_aBoolPar, sizeof(s_aBoolPar));
d116 2
a117 5
		if (m_pStrm2)
		{
			m_pStrm2->Write(&abytePar, sizeof(abytePar));
			m_pStrm2->Write(strVal, strVal.GetLength());
		}
d137 1
a137 2
		if (m_pStrm2)
			AddStringParam(byteTagID, strVal, m_pStrm2);
d148 1
d175 1
a175 2
		if (m_pStrm2)
			AddNumParam(byteTagID, byteOperator, qwVal, m_pStrm2);
d188 2
d193 1
d207 1
d463 45
a507 7
		//	Send integer search type if it's among operands and server supports integer search type
			Packet	*pSearchPck = ( (m_pGlobSearchPck2 != NULL) &&
				(pNextServer->GetUDPFlags() & SRV_UDPFLG_TYPETAGINTEGER) ) ? m_pGlobSearchPck2 : m_pGlobSearchPck;

		//	If the server supports extended Get Files...
			if (pNextServer->GetUDPFlags() & SRV_UDPFLG_EXT_GETFILES)
				pSearchPck->m_eOpcode = OP_GLOBSEARCHREQ2;
d509 5
a513 4
				pSearchPck->m_eOpcode = OP_GLOBSEARCHREQ;

			g_App.m_pUploadQueue->AddUpDataOverheadServer(pSearchPck->m_dwSize);
			g_App.m_pServerConnect->SendUDPPacket(pSearchPck, pNextServer, false);
d534 1
d1039 1
a1039 1
//	The 2nd stream is used to create a packet contained file type as a number,
d1042 1
a1042 1
	CSearchExprTarget	Targ(&pckStrm1, (dwType != ED2KFT_ANY) ? &pckStrm2 : NULL);
d1114 9
a1122 4
//	Send integer search type if it's among operands and server supports integer search type
	bool	bTCPIntType = ( (dwType != ED2KFT_ANY) &&
		(g_App.m_pServerConnect->GetCurrentServer()->GetTCPFlags() & SRV_TCPFLG_TYPETAGINTEGER) );
	Packet	*pPacket = new Packet((bTCPIntType) ? &pckStrm2 : &pckStrm1);
d1136 1
d1138 1
a1138 1
		if (bTCPIntType)
d1146 1
a1146 1
			if (dwType != ED2KFT_ANY)
@


1.168
log
@Renamed AddUDPResult -> AddGlobalEd2kSearchResults (original).
@
text
@d67 1
d146 1
a146 1
	void AddNumParam(byte byteTagID, byte byteOperator, uint32 dwVal, CMemFile *pStrm)
d148 27
a174 9
		byte abytePar[9];

		abytePar[0] = SCH_SRV_PARAMTYPE_TAGNUM;
		POKE_DWORD(&abytePar[1], dwVal);	// numeric value
		abytePar[5] = byteOperator;			// comparison operator
		POKE_WORD(&abytePar[6], 1);			// meta tag ID length
		abytePar[8] = byteTagID;			// meta tag ID name

		pStrm->Write(&abytePar, sizeof(abytePar));
d177 1
a177 1
	void AddNumParam(byte byteTagID, byte byteOperator, uint32 dwVal)
d179 1
a179 1
		AddNumParam(byteTagID, byteOperator, dwVal, m_pStrm1);
d181 1
a181 1
			AddNumParam(byteTagID, byteOperator, dwVal, m_pStrm2);
d184 1
a184 1
	void AddNumParamMin(byte byteTagID, uint32 dwVal)
d186 1
a186 1
		AddNumParam(byteTagID, ED2K_SEARCH_OP_GREATER, dwVal - 1u);
d189 1
a189 1
	void AddNumParamMax(byte byteTagID, uint32 dwVal)
d191 1
a191 1
		AddNumParam(byteTagID, ED2K_SEARCH_OP_LESS, dwVal + 1u);
d376 1
a376 1
	if (iMin > 4095)
d378 2
a379 2
		iMin = 4095;
		SetDlgItemText(IDC_EDITSEARCHMIN, _T("4095"));
d381 1
a381 1
	if (iMax > 4096)
d383 2
a384 2
		iMax = 4096;
		SetDlgItemText(IDC_EDITSEARCHMAX, _T("4096"));
d810 3
a812 1
			strQuery.AppendFormat(_T("&min_size=%u&max_size=%u"), dwVal * 1048576, _tstol(strToSearch) * 1048576);
d933 1
a933 1
	DeleteAllSearchs();
d938 2
a939 2
void CSearchDlg::DoNewSearch(const CString &strSearch, const CString &strTypeText, uint32 dwMinSize, uint32 dwMaxSize,
							 uint32 dwAvailability, const CString &strExtension, bool bDoGlobal, const CString &strSearchExclusion, uint16 nSearchID /*= 0*/)
d1012 1
a1012 1
	if (dwMaxSize > 0)
d1014 1
a1014 1
	if (dwMinSize > 0)
d1050 1
a1050 1
	if (dwMinSize > 0)
d1054 1
a1054 1
		Targ.AddNumParamMin(FT_FILESIZE, dwMinSize);
d1056 1
a1056 1
	if (dwMaxSize > 0)
d1060 1
a1060 1
		Targ.AddNumParamMax(FT_FILESIZE, dwMaxSize);
d1136 1
a1136 1
		MessageBox(GetResString(IDS_ERR_NOTCONNECTED),GetResString(IDS_NOTCONNECTED),64);
d1171 1
a1171 1
		unsigned long	dwMinSize = _tstol(strNum) * 0x100000;
d1175 1
a1175 1
		unsigned long	dwMaxSize = _tstol(strNum) * 0x100000;
d1178 2
a1179 2
		if (dwMaxSize < dwMinSize)
			dwMaxSize = 0;
d1195 1
a1195 1
		DoNewSearch(strSearch, strTypeText, dwMinSize, dwMaxSize, dwAvailability,
d1268 1
a1268 1
void CSearchDlg::DeleteAllSearchs()
@


1.167
log
@IDS_CANCEL used instead of IDS_SW_CANCEL on the search window (it should be more correct).
@
text
@d537 1
a537 1
void CSearchDlg::AddUDPResult(uint16 count)
@


1.166
log
@Added IDS_BY_USERS.
@
text
@d848 1
a848 1
		{ IDC_CANCELS, IDS_SW_CANCEL },
@


1.165
log
@Improved string processing.
@
text
@d708 1
a708 1
			strInfo.AppendFormat(_T("by approx. %u users"), dwUsers);
@


1.164
log
@Show overall file rating provided by servers in the search list.
@
text
@d278 1
a278 1
		m_pacSearchString->LoadList(CString(g_App.m_pPrefs->GetConfigDir()) +  _T("\\") SEARCH_STRINGS_PROFILE);
d400 1
a400 1
		if (m_pacSearchString)
@


1.163
log
@UNICODE preparation (first shot)
@
text
@a216 1
//		IDI_SCH_FILTER,		//EP_SEARCHMETHOD_FILT
d636 1
a636 1
	int						iControlId = CWnd::FromHandle(pNotify->ti->hWnd)->GetDlgCtrlID();
d643 1
a643 1
		int				iSel = GetItemUnderMouse(&m_ctlSearchList);
d654 1
a654 2
		CString			strTemp;
		CString			strInfo;
d695 16
a878 1
//	GetResString(&str[EP_SEARCHMETHOD_FILT], IDS_LOCAL_FILTER);
d1628 2
a1629 2
	this->GetDlgItem(IDC_CATTAB2)->ShowWindow(flag);
	this->GetDlgItem(IDC_STATIC_DLTOof)->ShowWindow(flag);
@


1.162
log
@Compatibility with VC2005 [brengarne]; Formatting.
@
text
@d871 1
a871 1
		cbi.pszText = (LPTSTR)(LPCTSTR)str[i];
d1168 1
a1168 1
void CSearchDlg::CreateNewTab(const CString &strSearchString, uint32 nSearchID)
d1171 2
a1172 2
	// add new tab
	TCITEM	newitem;
d1175 7
a1181 5
	newitem.mask = TCIF_PARAM | TCIF_TEXT | TCIF_IMAGE;
	newitem.lParam = (LPARAM)nSearchID;
	newitem.pszText = (strBuff.IsEmpty()) ? _T("-") : (LPSTR)strBuff.GetString();
	newitem.iImage = 0;
	uint16 itemnr = m_ctlSearchTabs.InsertItem(m_ctlSearchTabs.GetItemCount(), &newitem);
d1184 2
a1185 2
	m_ctlSearchTabs.SetCurSel(itemnr);
	m_ctlSearchList.ShowResults(nSearchID);
@


1.161
log
@Increased max string which can be entered into Extension editbox (8->32).
@
text
@d1191 3
a1193 1
	TCITEM item;
d1197 1
a1197 1
	for (int i = 0, nItems = m_ctlSearchTabs.GetItemCount(); nItems != i; ++i)
d1213 1
a1213 1
	if (--nItems)
d1215 2
a1216 2
		if (i >= nItems)
			i = nItems - 1;
@


1.160
log
@renamed g_pPrefs->m_pPrefs (f... paste & copy :( )
@
text
@d283 1
a283 1
	((CEdit*)GetDlgItem(IDC_EDITSEARCHEXTENSION))->LimitText(8);
@


1.159
log
@renamed 3 variables
@
text
@d279 1
a279 1
		m_pacSearchString->LoadList(CString(g_App.g_pPrefs->GetConfigDir()) +  _T("\\") SEARCH_STRINGS_PROFILE);
d291 1
a291 1
	m_ttip.SetDelayTime(TTDT_INITIAL, g_App.g_pPrefs->GetToolTipDelay()*1000);
d444 1
a444 1
			if (pNextServer->GetFailedCount() >= g_App.g_pPrefs->GetDeadserverRetries())
d546 1
a546 1
	DownloadSelected(g_App.g_pPrefs->StartDownloadPaused());
d602 1
a602 1
	if (g_App.g_pPrefs->GetToolTipDelay() != 0)
d878 1
a878 1
	methodbox.SetCurSel(g_App.g_pPrefs->GetSearchMethod());
d1072 1
a1072 1
		if (g_App.g_pPrefs->GetUseServerPriorities())
d1310 1
a1310 1
	g_App.g_pPrefs->SetSearchMethod(iCurSel);
d1619 1
a1619 1
	return m_pacSearchString->SaveList(CString(g_App.g_pPrefs->GetConfigDir()) + _T("\\") SEARCH_STRINGS_PROFILE);
@


1.158
log
@Don't send global search packet to failed servers.
@
text
@d225 2
a226 2
	g_eMuleApp.m_pSearchList->SetOutputWnd(&m_ctlSearchList);
	m_ctlSearchList.Init(g_eMuleApp.m_pSearchList);
d233 2
a234 2
	m_ctrlSearchFrm.Init(IDI_NORMALSEARCH, &g_eMuleApp.m_pdlgEmule->m_themeHelper);
	m_ctrlDirectDlFrm.Init(IDI_DIRECTDOWNLOAD, &g_eMuleApp.m_pdlgEmule->m_themeHelper);
d237 1
a237 1
	m_BoxImageList.Create(16, 16, g_eMuleApp.m_iDfltImageListColorFlags|ILC_MASK, ELEMENT_COUNT(s_auIconResID), 0);
d279 1
a279 1
		m_pacSearchString->LoadList(CString(g_eMuleApp.m_pGlobPrefs->GetConfigDir()) +  _T("\\") SEARCH_STRINGS_PROFILE);
d291 1
a291 1
	m_ttip.SetDelayTime(TTDT_INITIAL, g_eMuleApp.m_pGlobPrefs->GetToolTipDelay()*1000);
d431 1
a431 1
	if (g_eMuleApp.m_pServerConnect->IsConnected())
d433 2
a434 2
		CServer		*pNextServer = g_eMuleApp.m_pServerList->GetNextSearchServer();
		CServer		*pCurServer = g_eMuleApp.m_pServerConnect->GetCurrentServer();
d436 2
a437 2
		if (pNextServer == g_eMuleApp.m_pServerList->GetServerByAddress(pCurServer->GetAddress(), pCurServer->GetPort()))
			pNextServer = g_eMuleApp.m_pServerList->GetNextSearchServer();
d440 1
a440 1
		if (pNextServer != NULL && g_eMuleApp.m_pServerList->GetServerCount() - 1 != m_uServerCount)
d444 1
a444 1
			if (pNextServer->GetFailedCount() >= g_eMuleApp.m_pGlobPrefs->GetDeadserverRetries())
d457 2
a458 2
			g_eMuleApp.m_pUploadQueue->AddUpDataOverheadServer(pSearchPck->m_dwSize);
			g_eMuleApp.m_pServerConnect->SendUDPPacket(pSearchPck, pNextServer, false);
d546 1
a546 1
	DownloadSelected(g_eMuleApp.m_pGlobPrefs->StartDownloadPaused());
d602 1
a602 1
	if (g_eMuleApp.m_pGlobPrefs->GetToolTipDelay() != 0)
d654 1
a654 1
		CKnownFile		*pKnownFile = g_eMuleApp.m_pSharedFilesList->GetFileByID(pSearchFile->GetFileHash());
d659 1
a659 1
			pKnownFile = g_eMuleApp.m_pDownloadQueue->GetFileByID(pSearchFile->GetFileHash());
d670 1
a670 1
			pKnownFile = g_eMuleApp.m_pKnownFilesList->FindKnownFileByID(pSearchFile->GetFileHash());
d683 1
a683 1
		strTemp = g_eMuleApp.m_pFakeCheck->GetFakeCheckComment(HashToString(pSearchFile->GetFileHash()), pSearchFile->GetFileSize());
d810 1
a810 1
			g_eMuleApp.m_pDownloadQueue->AddSearchToDownload(pSearchFile, eCatID, bPaused);
d814 1
a814 1
				g_eMuleApp.m_pdlgEmule->AddLogLine(true, RGB_LOG_WARNING + GetResString(IDS_SOURCESWARNING), pSearchFile->GetFileName());
d878 1
a878 1
	methodbox.SetCurSel(g_eMuleApp.m_pGlobPrefs->GetSearchMethod());
d910 1
a910 1
	if (!g_eMuleApp.m_pServerConnect->IsConnected())
d923 1
a923 1
		g_eMuleApp.m_pSearchList->NewSearch(&m_ctlSearchList, strTypeText, m_nSearchID);
d1044 1
a1044 1
		(g_eMuleApp.m_pServerConnect->GetCurrentServer()->GetTCPFlags() & SRV_TCPFLG_TYPETAGINTEGER) );
d1049 1
a1049 1
	g_eMuleApp.m_pUploadQueue->AddUpDataOverheadServer(pPacket->m_dwSize);
d1051 1
a1051 1
	g_eMuleApp.m_pServerConnect->SendPacket(pPacket, false);
d1072 2
a1073 2
		if (g_eMuleApp.m_pGlobPrefs->GetUseServerPriorities())
			g_eMuleApp.m_pServerList->ResetSearchServerPos();
d1075 1
a1075 1
		m_ctlGlobalSearchProgress.SetRange32(0, g_eMuleApp.m_pServerList->GetServerCount() - 1);
d1100 1
a1100 1
	if (!g_eMuleApp.m_pServerConnect->IsConnected())
d1208 1
a1208 1
	g_eMuleApp.m_pSearchList->RemoveResults(nSearchID);
d1233 1
a1233 1
	g_eMuleApp.m_pSearchList->Clear();
d1310 1
a1310 1
	g_eMuleApp.m_pGlobPrefs->SetSearchMethod(iCurSel);
d1347 1
a1347 1
	CString m_strClipBoard = g_eMuleApp.CopyTextFromClipboard().Trim();
d1394 1
a1394 1
				g_eMuleApp.m_pDownloadQueue->AddFileLinkToDownload(pLink->GetFileLink(),eCatID);
d1406 1
a1406 1
				if (!g_eMuleApp.m_pdlgEmule->m_wndServer.m_ctlServerList.AddServer(pSrv,true))
d1409 1
a1409 1
					g_eMuleApp.m_pdlgEmule->AddLogLine(true, GetResString(IDS_SERVERADDED), pSrv->GetListName());
d1421 1
a1421 1
			g_eMuleApp.m_pdlgEmule->AddLogLine(true, RGB_LOG_WARNING + GetResString(IDS_ERR_INVALIDLINK), error);
d1434 1
a1434 1
	CString			clipboard = g_eMuleApp.CopyTextFromClipboard();
d1533 1
a1533 1
				g_eMuleApp.m_pDownloadQueue->AddFileLinkToDownload(links.GetHead()->GetFileLink(),eCatID);
d1619 1
a1619 1
	return m_pacSearchString->SaveList(CString(g_eMuleApp.m_pGlobPrefs->GetConfigDir()) + _T("\\") SEARCH_STRINGS_PROFILE);
d1629 1
a1629 1
	if (!g_eMuleApp.m_pServerConnect->IsConnected())
d1645 1
a1645 1
	g_eMuleApp.m_pUploadQueue->AddUpDataOverheadServer(pPacket->m_dwSize);
d1647 1
a1647 1
	g_eMuleApp.m_pServerConnect->SendPacket(pPacket,true);
@


1.157
log
@correction for string processing by tooltip notify. thanks Aw3
@
text
@d443 3
@


1.156
log
@fixed hanging tooltip by focus switch; the "OnToolTipNotify" replaced over OnNotify because it works faster as using ON_NOTIFY_EX_RANGE(...)
@
text
@d619 1
a619 1
			pNotify->ti->sTooltip = GetInfo4ToolTip(pNotify);
d632 1
a632 1
CString  CSearchDlg::GetInfo4ToolTip(NM_PPTOOLTIP_DISPLAY *pNotify)
a634 1
	CString					strInfo(_T(""));
d639 1
a639 1
			return FALSE;
d644 1
a644 1
			return FALSE;
d649 1
a649 1
			return FALSE;
d653 1
d699 1
a700 2

	return strInfo;
@


1.155
log
@Modified result limiting condition to be great or equal.
@
text
@a327 1
	ON_NOTIFY_EX_RANGE(UDM_TOOLTIP_DISPLAY,0,0xFFFF,OnToolTipNotify)
d609 24
a632 1
BOOL CSearchDlg::OnToolTipNotify(UINT id, NMHDR *pNMH, LRESULT *pResult)
a633 1
	NM_PPTOOLTIP_DISPLAY	*pNotify = (NM_PPTOOLTIP_DISPLAY*)pNMH;
d635 1
a635 1
	CString					strInfo;
a699 1
	pNotify->ti->sTooltip = strInfo;
d701 1
a701 1
	return TRUE;
@


1.154
log
@Integer file type in server search requests to reduce traffic {lugdunummaster};
Fixed server search request when file extension is specified;
Limited file extension edit box length to 8 characters;
Added missed server search overhead statistics;
Corrected boundary conditions when min/max search file sizes are specified;
Modified preparation of the server search request packet to make it clearer;
Renamed service to follow real actions.
@
text
@d499 1
a499 1
		if (count > MAX_RESULTS)
d538 1
a538 1
	if (!m_bCancelled && count > MAX_RESULTS)
@


1.153
log
@IDS_SEARCH_NOUN substitutes IDS_SW_SEARCHBOX.
@
text
@d62 118
d189 2
a190 1
	m_pGlobalSearchPacket = NULL;
d200 2
a201 1
	safe_delete(m_pGlobalSearchPacket);
d283 1
d444 5
d451 1
a451 3
			{
				m_pGlobalSearchPacket->m_eOpcode = OP_GLOBSEARCHREQ2;
			}
d453 1
a453 3
			{
				m_pGlobalSearchPacket->m_eOpcode = OP_GLOBSEARCHREQ;
			}
d455 2
a456 1
			g_eMuleApp.m_pServerConnect->SendUDPPacket(m_pGlobalSearchPacket, pNextServer, false);
d475 2
a476 2
	if(m_pGlobalSearchPacket)
		safe_delete(m_pGlobalSearchPacket);
d882 2
a883 2
void CSearchDlg::DoNewSearch(CString strSearch, CString strTypeText, unsigned long dwMinSize, unsigned long dwMaxSize,
							 int iAvailability, CString strExtension, bool bDoGlobal, CString strSearchExclusion, uint16 nSearchID /*= 0*/)
d901 1
a901 1
		g_eMuleApp.m_pSearchList->NewSearch(&m_ctlSearchList,strTypeText,m_nSearchID);
d915 2
a916 1
	CString		strType;
a917 1
//	TODO: create a fonction to not duplicate this code
d919 4
a922 1
		strType = _T("Audio");
d924 5
a928 2
		strType = _T("Video");
//	Archives, CD images and programs treated the same by servers
d930 4
a933 1
		strType = _T("Pro");
d935 4
a938 1
		strType = _T("Image");
d940 4
a943 3
		strType = _T("Doc");
	else
		strType = _T("");
d945 4
a948 5
	CSafeMemFile	packetStream(100);
	uint16			uSize;

	if (!strExtension.IsEmpty() && strExtension.GetAt(0) != _T('.'))
		strExtension = _T(".") + strExtension;
d954 1
a954 3
//	Because the availability is used with the 'Min' operator, we decrement the entered value by one to get
//	more 'useable' results from the server (from a user's POV).
	if (iAvailability >= 0)
a964 1
	//
d981 1
a981 1
			strResToken = strSearch.Tokenize(_T(" "),iCurPos);
d983 2
a984 7
			{
				packetStream.Write(&SEARCH_OPPARAM_AND, 2);
			}
			packetStream.Write(&SEARCH_PARAMTYPE_STRING, 1);		// write the parameter strType
			uSize = strOldResToken.GetLength();
			packetStream.Write(&uSize, 2);							// write parameter length
			packetStream.Write(strOldResToken.GetBuffer(), uSize);	// write the searched string
d990 3
a992 8
		{
			packetStream.Write(&SEARCH_OPPARAM_AND, 2);
		}
		packetStream.Write(&SEARCH_PARAMTYPE_TYPE, 1);			// write the parameter strType
		uSize = strType.GetLength();
		packetStream.Write(&uSize, 2);							// write the length
		packetStream.Write(strType.GetBuffer(), uSize);			// write parameter
		packetStream.Write(&SEARCH_PARAMID_TYPE, 3);			// nemonic for this kind of parameter (only 3 bytes!!)
d997 2
a998 6
		{
			packetStream.Write(&SEARCH_OPPARAM_AND, 2);
		}
		packetStream.Write(&SEARCH_PARAMTYPE_NUMERIC, 1);		// write the parameter strType
		packetStream.Write(&dwMinSize, 4);						// write the parameter
		packetStream.Write(&SEARCH_PARAMID_MINSIZE, 4);			// nemonic for this kind of parameter
d1003 4
a1006 10
		{
			packetStream.Write(&SEARCH_OPPARAM_AND, 2);
		}
		packetStream.Write(&SEARCH_PARAMTYPE_NUMERIC, 1);		// write the parameter strType
		packetStream.Write(&dwMaxSize, 4);						// write the parameter
		packetStream.Write(&SEARCH_PARAMID_MAXSIZE, 4);			// nemonic for this kind of parameter
	}
//	Because the availability is used with the 'Min' operator, we decrement the entered value by one to get
//	more 'useable' results from the server (from a user's POV).
	if (iAvailability >= 0)
d1009 2
a1010 6
		{
			packetStream.Write(&SEARCH_OPPARAM_AND, 2);
		}
		packetStream.Write(&SEARCH_PARAMTYPE_NUMERIC, 1);		// write the parameter strType
		packetStream.Write(&iAvailability, 4);					// write the parameter
		packetStream.Write(&SEARCH_PARAMID_AVAILABILITY, 4);	// nemonic for this kind of parameter
d1015 2
a1016 8
		{
			packetStream.Write(&SEARCH_OPPARAM_AND, 2);
		}
		packetStream.Write(&SEARCH_PARAMTYPE_STRING, 1);		// write the parameter strType
		uSize = strExtension.GetLength();
		packetStream.Write(&uSize, 2);							// write the length
		packetStream.Write(strExtension.GetBuffer(), uSize);	// write parameter
		packetStream.Write(&SEARCH_PARAMID_EXTENSION, 3);		// nemonic for this kind of parameter (only 3 bytes!!)
a1017 2


d1020 4
a1023 1
	Packet		*pPacket = new Packet(&packetStream);
d1029 1
a1029 1
	g_eMuleApp.m_pServerConnect->SendPacket(pPacket,false);
d1034 10
a1043 1
		if (g_eMuleApp.m_pGlobPrefs->Score() != NULL)
d1045 6
a1051 8
		}
	//	Get rid of any old global search packet
		if (m_bGlobalSearch)
			safe_delete(m_pGlobalSearchPacket);
	//
	//	Change the search request packet into a global search packet and save it.
		m_pGlobalSearchPacket = pPacket;
		m_pGlobalSearchPacket->m_eOpcode = OP_GLOBSEARCHREQ;
d1053 1
a1053 1
		m_ctlGlobalSearchProgress.SetRange32(0,g_eMuleApp.m_pServerList->GetServerCount()-1);
d1091 5
a1110 1
		{
a1111 1
		}
d1121 1
a1121 2
	//
	//	Maximum file size // netwolf: if no maximum size is specified or dwMaxSize<dwMinSize, dont send maximum.size limit (at lugdunums request)
a1124 4
	//
	//	Because the availability is used with the 'Min' operator, we decrement the entered value by one to get
	//	more 'useable' results from the server (from a user's POV). Therefore its correct to send an
	//	'Availability' of 0, because it will return all files with an 'Availability' of >= 1.
d1127 1
a1127 6
		int				iAvailability = _tstoi(strNum);

		if (iAvailability == 0)
		{
			iAvailability = -1;
		}
d1139 1
a1139 1
		DoNewSearch(strSearch, strTypeText, dwMinSize, dwMaxSize, iAvailability,
@


1.152
log
@Separate GetFileTypeString for search type.
@
text
@d705 1
a705 1
	m_ctrlSearchFrm.SetText(GetResString(IDS_SW_SEARCHBOX));
@


1.151
log
@Added Related File Search.
@
text
@d529 1
a529 1
			pSearchFile->GetFileTypeString(true),
@


1.150
log
@Returned min/max size parameters for FileDonkey search (as they became again available).
@
text
@d785 4
@


1.149
log
@Disabled code prepared for Local Filter (let's hope to use it some day).
@
text
@d627 1
a627 1
			strQuery.Format(_T("http://www.filehash.com/fdsearch/index.php?pattern=%s"),
d629 4
d1185 1
a1185 1
			uiMask = 0;
@


1.148
log
@Optimized GetCurrentServer() calls (cache value for consecutive usage).
@
text
@d97 1
a97 1
		IDI_SCH_FILTER,		//EP_SEARCHMETHOD_FILT
d716 1
a716 1
	GetResString(&str[EP_SEARCHMETHOD_FILT], IDS_LOCAL_FILTER);
d804 1
a804 1
	if (!strExtension.IsEmpty() && strExtension.GetAt(0) != '.')
@


1.147
log
@Fixed disabled 'Clear All' button after request of shared files list (I don't understand
why 'Clear All' button was disabled at the beginning so I made it always enabled).
@
text
@d314 1
d316 1
a316 1
		if (pNextServer == g_eMuleApp.m_pServerList->GetServerByAddress(g_eMuleApp.m_pServerConnect->GetCurrentServer()->GetAddress(),g_eMuleApp.m_pServerConnect->GetCurrentServer()->GetPort()))
@


1.146
log
@A minor improvement for the previous solution.
@
text
@a364 1
	GetDlgItem(IDC_CLEARALL)->EnableWindow(true);
a382 1
			GetDlgItem(IDC_CLEARALL)->EnableWindow(true);
d1151 1
a1151 7
	EMULE_TRY

	if (m_bCancelled)
		GetDlgItem(IDC_CANCELS)->EnableWindow(false);
	else
		GetDlgItem(IDC_CANCELS)->EnableWindow(true);

a1152 3
	GetDlgItem(IDC_CLEARALL)->EnableWindow(true);

	EMULE_CATCH
@


1.145
log
@Added eMugle web search support;
Some reorganization to improve readability and optimization;
Removed some unused method; Some renaming.
@
text
@d581 1
d586 4
a589 2
			if ( (dwVal < EP_SCHTYPE_COUNT) && ( ( (1 << dwVal) &
				((1 << EP_SCHTYPE_ARC) | (1 << EP_SCHTYPE_AUDIO) | (1 << EP_SCHTYPE_CDIMG) | (1 << EP_SCHTYPE_PICS) | (1 << EP_SCHTYPE_VIDEO))) != 0) )
d591 17
a607 21
				const TCHAR *pcType;

				switch (dwVal)
				{
					case EP_SCHTYPE_ARC:
						pcType = _T("Archive");
						break;
					case EP_SCHTYPE_AUDIO:
						pcType = _T("Audio");
						break;
					case EP_SCHTYPE_CDIMG:
						pcType = _T("CD+Image");
						break;
					case EP_SCHTYPE_PICS:
						pcType = _T("Image");
						break;
					case EP_SCHTYPE_VIDEO:
					default:
						pcType = _T("Video");
						break;
				}
a608 1
			}
d626 1
a626 1

@


1.144
log
@Unified search methods; Use 16x16 icons for search method combobox;
Preparations for Local Filter and eMugle web search.
@
text
@d39 23
d95 5
a99 5
		IDI_SMALLSERVER,	//EP_SEARCHTYPE_SERV
		IDI_GLOBAL,			//EP_SEARCHTYPE_GLOB
		IDI_SCH_FILTER,		//EP_SEARCHTYPE_FILT
		IDI_SCH_WEB2,		//EP_SEARCHTYPE_WEB1
		IDI_TRAYICON_GREY	//EP_SEARCHTYPE_WEB2
d126 1
a126 1
	AddAnchor(IDC_TypeSearch, TOP_LEFT);
d187 1
a187 1
	DDX_Control(pDX, IDC_TypeSearch, Stypebox);
d209 1
a209 1
	ON_CBN_SELCHANGE(IDC_TypeSearch, OnEnChangeSearchname)
d288 2
a289 2
			case EP_SEARCHTYPE_SERV:
			case EP_SEARCHTYPE_GLOB:
d292 2
a293 1
			case EP_SEARCHTYPE_WEB2:
d464 1
a464 1
						&& ( pMsg->hwnd == GetDlgItem(IDC_TypeSearch)->m_hWnd
a571 5
	static const TCHAR *const s_apcFileDonkeyExt[] = {
		_T("avi"), _T("mp3"), _T("mpg"), _T("rar"), _T("zip"), _T("divx"),
		_T("dvd"), _T("svcd"), _T("vcd"), _T("vhs")
	};

d574 2
a575 1
	CString			strQuery, strToSearch, strToFilter;
d577 1
d580 48
a627 3
		case EP_SEARCHTYPE_WEB2:
		{
			GetDlgItemText(IDC_SEARCHNAME, strToSearch);
d629 1
a632 1
		}
d645 1
a645 1
	strTmp.Replace(_T("%20"),_T("+"));
d715 1
a715 1
	CString str[EP_SEARCHTYPE_COUNT];
d717 6
a722 6
	GetResString(&str[EP_SEARCHTYPE_SERV], IDS_PW_SERVER);
	GetResString(&str[EP_SEARCHTYPE_GLOB], IDS_SW_GLOBAL);
	GetResString(&str[EP_SEARCHTYPE_FILT], IDS_LOCAL_FILTER);
	str[EP_SEARCHTYPE_WEB1] = _T("eMugle (Web)");
	str[EP_SEARCHTYPE_WEB2] = _T("FileDonkey (Web)");
	for (int i = 0; i < EP_SEARCHTYPE_COUNT; i++)
d743 1
a743 1
	Stypebox.SetCurSel(0);
d984 1
a984 1
		bool			bIsThisGlobal = (methodbox.GetCurSel() == EP_SEARCHTYPE_GLOB);
d986 1
a986 1
		GetDlgItemText(IDC_TypeSearch, strTypeText);
a1169 2
	EMULE_TRY

d1176 1
a1176 1
	Stypebox.SetCurSel(Stypebox.FindString(-1,GetResString(IDS_SEARCH_ANY)));
a1177 6

	EMULE_CATCH
}
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
void CSearchDlg::OnStnClickedSearchextensionLbl()
{
d1182 5
d1192 2
a1193 7
		case EP_SEARCHTYPE_WEB2:
			GetDlgItem(IDC_SEARCHNAME_NOT)->EnableWindow(false);
			GetDlgItem(IDC_TypeSearch)->EnableWindow(false);
			GetDlgItem(IDC_EDITSEARCHMIN)->EnableWindow(false);
			GetDlgItem(IDC_EDITSEARCHMAX)->EnableWindow(false);
			GetDlgItem(IDC_EDITSEARCHAVAILABILITY)->EnableWindow(false);
			GetDlgItem(IDC_EDITSEARCHEXTENSION)->EnableWindow(false);
d1195 2
a1196 9
		case EP_SEARCHTYPE_SERV:
		case EP_SEARCHTYPE_GLOB:
		default:
			GetDlgItem(IDC_SEARCHNAME_NOT)->EnableWindow(true);
			GetDlgItem(IDC_TypeSearch)->EnableWindow(true);
			GetDlgItem(IDC_EDITSEARCHMIN)->EnableWindow(true);
			GetDlgItem(IDC_EDITSEARCHMAX)->EnableWindow(true);
			GetDlgItem(IDC_EDITSEARCHAVAILABILITY)->EnableWindow(true);
			GetDlgItem(IDC_EDITSEARCHEXTENSION)->EnableWindow(true);
d1199 2
@


1.143
log
@Updated FileDonkey web search; Improved string processing.
@
text
@d70 1
a70 1
	static const uint16 s_au13x13IconResID[] =
d72 5
a76 3
		IDI_SCH_SERVER,
		IDI_SCH_GLOBAL,
		IDI_SCH_FILEDONKEY
d94 1
a94 1
	m_BoxImageList.Create(13,13,g_eMuleApp.m_iDfltImageListColorFlags|ILC_MASK,0,10);
d96 1
a96 11

	HINSTANCE hInst = AfxGetInstanceHandle();

	for (unsigned ui = 0; ui < ELEMENT_COUNT(s_au13x13IconResID); ui++)
	{
		HICON	hIcon = reinterpret_cast<HICON>(::LoadImage(hInst, MAKEINTRESOURCE(s_au13x13IconResID[ui]), IMAGE_ICON, 13, 13, 0));

		m_BoxImageList.Add(hIcon);
	//	This resource isn't required anymore, unload it
		::DestroyIcon(hIcon);
	}
d265 9
a273 9
		case 0:
		case 1:
			StartNewSearch();
			break;
		case 2:
			ShellOpenFile(CreateWebQuery());
			break;
		default:
			break;
d559 1
a559 1
		case 2:
d649 1
a649 1
	CString str[3];
d651 6
a656 4
	GetResString(&str[0], IDS_PW_SERVER);
	GetResString(&str[1], IDS_SW_GLOBAL);
	str[2] = _T("FileDonkey");
	for (int i = 0; i < 3; i++)
d666 1
a666 1
	methodbox.SetCurSel(g_eMuleApp.m_pGlobPrefs->GetMethod());
d918 1
a918 1
		bool			bIsThisGlobal = (methodbox.GetCurSel() == 1);
d1124 1
a1124 2
	EMULE_TRY
	g_eMuleApp.m_pGlobPrefs->SetMethod(methodbox.GetCurSel());
d1126 2
a1127 1
	switch (methodbox.GetCurSel())
d1129 1
a1129 1
		case 2:
d1137 2
a1138 2
		case 1:
		case 0:
a1147 2

	EMULE_CATCH
@


1.142
log
@Unified processing of server priorities.
@
text
@a568 5
			GetDlgItemText(IDC_EDITSEARCHMIN, strToSearch);
			uint32 dwMinSize = _tstol(strToSearch);
			GetDlgItemText(IDC_EDITSEARCHMAX, strToSearch);
			uint32 dwMaxSize = _tstol(strToSearch);

a569 9
			GetDlgItemText(IDC_EDITSEARCHEXTENSION, strToFilter);
			strToFilter.MakeLower();
			for (unsigned ui = 0; ui < ELEMENT_COUNT(s_apcFileDonkeyExt); ui++)
			{
				if (strToFilter == s_apcFileDonkeyExt[ui])
					break;
			}
			if (ui == ELEMENT_COUNT(s_apcFileDonkeyExt))
				strToFilter.Empty();
d571 2
a572 2
			strQuery.Format(_T("http://www.filedonkey.com/fdsearch/index.php?pattern=%s&scope=%s&min_size=%u&max_size=%u&w=search"),
				ToQueryString(strToSearch), strToFilter, dwMinSize * 1048576, dwMaxSize * 1048576);
d583 1
a583 1
CString	CSearchDlg::ToQueryString(CString str)
d585 4
a588 6
	EMULE_TRY
	CString sTmp = URLEncode(str);
	sTmp.Replace(_T("%20"),_T("+"));
	return sTmp;
	EMULE_CATCH
	return _T("");
d1138 2
a1139 2
			GetDlgItem(IDC_EDITSEARCHMIN)->EnableWindow(true);
			GetDlgItem(IDC_EDITSEARCHMAX)->EnableWindow(true);
d1141 1
a1141 1
			GetDlgItem(IDC_EDITSEARCHEXTENSION)->EnableWindow(true);
@


1.141
log
@Simplied invalid link report.
@
text
@d1254 1
a1254 1
				pSrv->SetPreference(CServer::SERVERPRIORITY_HIGH);
@


1.140
log
@Fixed Last Seen Complete display in tooltips (it has to be constant).
@
text
@d1271 1
a1271 5

			CString	buffer;

			buffer.Format(GetResString(IDS_ERR_INVALIDLINK),error.GetBuffer());
			g_eMuleApp.m_pdlgEmule->AddLogLine(true, RGB_LOG_WARNING + GetResString(IDS_ERR_LINKERROR), buffer);
@


1.139
log
@Don't use 32 bit color resources if OS/comctl32.dll doesn't support it and some other minor changes/optimizations.
@
text
@d527 2
a528 12
		uint32			dwLastSeenVal;

		if ((dwLastSeenVal = pSearchFile->GetLastSeenCompleteValue()) != 0)
		{
			if (dwLastSeenVal == 0x7FFFFFFF)
				GetResString(&strTemp, IDS_NEVER);
			else
			{
				COleDateTime	lastSeenTime = COleDateTime::GetCurrentTime() - COleDateTimeSpan(0, 0, 0, dwLastSeenVal - 1);

				strTemp = lastSeenTime.Format();
			}
a529 1
		}
@


1.138
log
@Moved GetItemUnderMouse to otherfunctions.
@
text
@d92 1
a92 1
	m_BoxImageList.Create(13,13,ILC_COLOR32|ILC_MASK,0,10);
@


1.137
log
@Added 'Folder' to Search & Shared Files tooltips.
@
text
@a471 28
int CSearchDlg::GetItemUnderMouse(CListCtrl* ctrl)
{
	EMULE_TRY

	CPoint			pt;

	::GetCursorPos(&pt);
	ctrl->ScreenToClient(&pt);

	LVHITTESTINFO	hit, subhit;

	hit.pt = pt;
	subhit.pt = pt;
	ctrl->SubItemHitTest(&subhit);

	int				iSel = ctrl->HitTest(&hit);

	if (iSel != LB_ERR && (hit.flags & LVHT_ONITEM))
	{
		if (subhit.iSubItem == 0)
			return iSel;
	}

	EMULE_CATCH

	return LB_ERR;
}
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
@


1.136
log
@Add sources possibly received from global search (official).
Added missing translations in case countryflag.dll / ip-to-country.cvs is not found.
Notifier informs if a new version is available (not annoying, but still more likely
 to be noticed than just a log line).
Added 'Folder' column to Shared files window.
Prevent adding install/working dirs (\Webserver, \Db...) to Shared files.
+ some other minor changes/fixes.
@
text
@d570 4
@


1.135
log
@Minor change in tooltips.
@
text
@d335 3
a341 1
		safe_delete(m_pGlobalSearchPacket);
@


1.134
log
@Correction in tooltips.
@
text
@d538 1
a538 1
		strInfo.Format(_T("<t=2><b>%s</b><br><t=2>%s<br><t=2>%s<br><hr=100%%><br><b>%s:<t></b>%s (%u %s)<br><b>%s:<t></b>%u<br><b>%s:<t></b>%u<br><b>%s:<t></b>%s"),
d542 1
a542 1
			GetResString(IDS_DL_SIZE), CastItoXBytes(pSearchFile->GetIntTagValue(FT_FILESIZE)), pSearchFile->GetIntTagValue(FT_FILESIZE), GetResString(IDS_BYTES),
@


1.133
log
@Added tooltips to the Search & Shared Files lists.
@
text
@d535 1
a535 5

			if (pKnownFile != NULL)
				GetResString(&strTemp, IDS_KNOWNFILES);
			else
				GetResString(&strTemp, IDS_UNKNOWN);
d548 1
d561 1
a561 1
				COleDateTime lastSeenTime = COleDateTime::GetCurrentTime() - COleDateTimeSpan(0, 0, 0, dwLastSeenVal - 1);
@


1.132
log
@Changed color from ERROR to WARNING
@
text
@d153 8
d192 1
d459 4
d470 112
@


1.131
log
@Changes to last features
@
text
@d537 1
a537 1
				g_eMuleApp.m_pdlgEmule->AddLogLine(true, RGB_LOG_ERROR + GetResString(IDS_SOURCESWARNING), pSearchFile->GetFileName());
@


1.130
log
@- added warning when sharing too much files that leads to connection problems
- new warning when adding a file from search that has no complete sources reported
@
text
@d531 1
d533 1
a533 1
			CSearchFile *pSearchFile = (CSearchFile*)m_ctlSearchList.GetItemData(index);
d535 1
a535 1
			if (pSearchFile->GetLastSeenCompleteValue() == 0x7FFFFFFF)
d537 1
a537 9
				CString strWarning;
				strWarning.Format(GetResString(IDS_SOURCESWARNING), pSearchFile->GetFileName());

				if (AfxMessageBox(strWarning, MB_ICONQUESTION|MB_YESNO) == IDYES)
					g_eMuleApp.m_pDownloadQueue->AddSearchToDownload(pSearchFile, eCatID, bPaused);
			}
			else
			{
				g_eMuleApp.m_pDownloadQueue->AddSearchToDownload(pSearchFile, eCatID, bPaused);
@


1.129
log
@Removed left Jigle stuff.
@
text
@d526 1
d532 14
a545 1
			g_eMuleApp.m_pDownloadQueue->AddSearchToDownload((CSearchFile*)m_ctlSearchList.GetItemData(index), eCatID, bPaused);
@


1.128
log
@Removed unused closable tab stuff to reduce used memory and GDI resources;
Improved string processing; Removed unused variables.
@
text
@a268 1
		case 3:
d763 1
a763 1
	    	packetStream.Write(&SEARCH_OPPARAM_AND, 2);
@


1.127
log
@Faster image lists icon loading; reduced memory usage.
@
text
@a69 1
	static const uint16 s_auIconResID[] = { IDI_NORMALSEARCH };
a105 5
	m_pImageList.Create(16, 16, ILC_COLOR32 | ILC_MASK, ELEMENT_COUNT(s_auIconResID), 0);
	m_pImageList.SetBkColor(CLR_NONE);
	FillImgLstWith16x16Icons(&m_pImageList, s_auIconResID, ELEMENT_COUNT(s_auIconResID));
	m_ctlSearchTabs.SetImageList(&m_pImageList);

a475 2
	unsigned long	dwNum;
	int				iIdx;
d813 1
a813 1
	CreateNewTab(strSearch,m_nSearchID);
d899 1
a899 1
void CSearchDlg::CreateNewTab(CString searchString,uint32 nSearchID)
d903 4
a906 4
	TCITEM newitem;
	if (searchString.GetLength() == 0)
		searchString = _T("-");
	newitem.mask = TCIF_PARAM|TCIF_TEXT|TCIF_IMAGE;
d908 1
a908 2
	newitem.pszText = searchString.GetBuffer();
	newitem.cchTextMax = (int)searchString.GetLength()+10;
d910 1
a910 1
	uint16 itemnr = m_ctlSearchTabs.InsertItem(m_ctlSearchTabs.GetItemCount(),&newitem);
@


1.126
log
@Removed unused Jigle stuff.
@
text
@d107 1
a107 1
	m_pImageList.Create(16,16,ILC_COLOR32|ILC_MASK,0,10);
@


1.125
log
@Faster icon loading.
@
text
@a75 1
	//	IDI_SCH_JIGLE
a508 49
		case 3:
		{
			GetDlgItemText(IDC_SEARCHNAME, strToSearch);
			strQuery.Format(_T("http://www.jigle.com/search?p=%s&ma="), ToQueryString(strToSearch));
			GetDlgItemText(IDC_EDITSEARCHAVAILABILITY, strToSearch);

			uint32 dwToSearch = _tstoi(strToSearch);

			if (dwToSearch > 1000)
				dwToSearch = 1000;
			else if (dwToSearch > 500)
				dwToSearch = 500;
			else if (dwToSearch > 200)
				dwToSearch = 200;
			else if (dwToSearch > 100)
				dwToSearch = 100;
			else if (dwToSearch > 50)
				dwToSearch = 50;
			else if (dwToSearch > 20)
				dwToSearch = 20;
			else if (dwToSearch > 10)
				dwToSearch = 10;
			else
				dwToSearch = 1;
			strQuery.AppendFormat(_T("%u&v=0&d=1&a=0&l=10"), dwToSearch);
			GetDlgItemText(IDC_EDITSEARCHMIN, strToSearch);
			dwNum =_tstol(strToSearch);
			GetDlgItemText(IDC_TypeSearch, strToSearch);
			iIdx = strToSearch.Find(_T(" (."));
			if (iIdx > 0)
				strToSearch.Truncate(iIdx);
			if (GetResString(IDS_SEARCH_AUDIO)==strToSearch)
				strToSearch=_T("1");
			else if (GetResString(IDS_SEARCH_VIDEO)==strToSearch)
				strToSearch=_T("2");
			else if (GetResString(IDS_SEARCH_PICS)==strToSearch)
				strToSearch=_T("3");
			else if (GetResString(IDS_SEARCH_PRG)==strToSearch)
				strToSearch=_T("4");
			else if (GetResString(IDS_SEARCH_DOC)==strToSearch)
				strToSearch=_T("5");
			else
				strToSearch=_T("0");
			strQuery.AppendFormat(_T("&t=%s&sl=%u&su="), strToSearch, (dwNum > 0) ? dwNum * 1048576 : 1);
			GetDlgItemText(IDC_EDITSEARCHMAX, strToSearch);
			if ((dwNum = _tstol(strToSearch)) > 0)
				strQuery.AppendFormat(_T("%u"), dwNum * 1048576);
			break;
		}
d586 1
a586 1
	CString str[3/*4*/];
d591 1
a591 2
//	str[3] = _T("Jigle");
	for (int i = 0; i < 3/*4*/; i++)
a1064 2
		case 3:
			// Jigle - not anymore
@


1.124
log
@Fixes
@
text
@d97 2
d101 1
a101 1
		HICON	hIcon = reinterpret_cast<HICON>(::LoadImage(AfxGetInstanceHandle(), MAKEINTRESOURCE(s_au13x13IconResID[ui]), IMAGE_ICON, 13, 13, 0));
@


1.123
log
@Moved FinSharedFiles to a timer to fix issues with hashing hung on start
Fixed Search buttons activation issues and More not working
@
text
@d75 2
a76 2
		IDI_SCH_FILEDONKEY,
//	IDI_SCH_JIGLE
d96 1
d150 3
a152 1
	((CEdit*)GetDlgItem(IDC_SEARCHNAME))->LimitText(512); // max. length of search expression
d233 1
a233 1
	//OnEnChangeSearchname(); // EC 08.07.03
d240 1
d281 1
d288 1
d324 1
d331 1
d345 1
d1033 1
a1033 1
	const int	cur_sel = m_ctlSearchTabs.GetCurSel();
d1035 1
a1035 1
	if ( -1 == cur_sel )
d1038 5
a1042 1
	TCITEM		item;
a1043 3
	item.mask = TCIF_PARAM;
	m_ctlSearchTabs.GetItem( cur_sel,&item );
	m_ctlSearchList.ShowResults( item.lParam );
d1052 1
d1060 2
a1061 1
		OnBnClickedCancels();  //Sony - cancel active search before closing active tab
d1063 1
d1066 1
d1068 1
d1075 6
a1080 1
//	GetDlgItem(IDC_STARTS)->EnableWindow(true); // DonGato: not enabled until the issued search is done
a1081 1
	GetDlgItem(IDC_CANCELS)->EnableWindow(false);
d1083 1
@


1.122
log
@Minor fixes for search behavior
@
text
@d47 1
d362 1
d366 13
d380 1
d1424 1
d1427 1
@


1.121
log
@updated MobileMule up to 0.8a
@
text
@d354 1
d1044 1
a1044 1
	GetDlgItem(IDC_STARTS)->EnableWindow(true);
@


1.120
log
@removed "delete only one search history entry" feature since it adds more bugs than usefull things
@
text
@d651 1
a651 1
							 int iAvailability, CString strExtension, bool bDoGlobal, CString strSearchExclusion)
d666 10
a675 2
	m_nSearchID++;
	g_eMuleApp.m_pSearchList->NewSearch(&m_ctlSearchList,strTypeText,m_nSearchID);
@


1.119
log
@fix for download that are always started unpaused (showtopic=5806&st=15#)
@
text
@d388 3
a390 1
		else if (pMsg->wParam == VK_DELETE)
d392 1
a392 21
			if (pMsg->hwnd == GetDlgItem(IDC_SEARCHNAME)->m_hWnd)
			{
				if (GetAsyncKeyState(VK_CONTROL) < 0)
				{
					m_pacSearchString->Clear();
				}
				else if (m_pacSearchString && m_pacSearchString->IsBound())
				{
					CString strText;

					GetDlgItemText(IDC_SEARCHNAME, strText);
					if (!strText.IsEmpty())
					{
						if (m_pacSearchString->RemoveItem(strText))
						{
							SetDlgItemText(IDC_SEARCHNAME, _T(""));
							((CEdit*)GetDlgItem(IDC_SEARCHNAME))->SetSel(-1);
						}
					}
				}
			}
@


1.118
log
@I don't see another way.
@
text
@d375 1
a375 1
	DownloadSelected();
@


1.117
log
@Minor fixes
@
text
@d403 5
a407 3
						m_pacSearchString->RemoveItem(strText);
						SetDlgItemText(IDC_SEARCHNAME, _T(""));
						((CEdit*)GetDlgItem(IDC_SEARCHNAME))->SetSel(-1);
@


1.116
log
@fix for searches added to no tab
updated the previous "Only one Search at a time can be done now" fix by EC to handle a return in one of the search edit control
@
text
@d961 1
d964 3
a966 1
	for( int i = 0, nItems = m_ctlSearchTabs.GetItemCount(); nItems != i; ++i )
d972 2
a973 1
	if (item.lParam != nSearchID)
d975 1
d977 2
a978 1
		OnBnClickedCancels();  //Sony - cancel active search before closing active tab
d981 2
a982 1
	if ( --nItems )
d984 2
a985 1
		if( i >= nItems ) i = nItems - 1;
d997 1
@


1.115
log
@Reverting to the way we agreed watched links should be added (uncategorized)
Sorry for the exception. :-(
@
text
@d46 2
a47 1
	m_pGlobalSearchPacket	=	NULL;
d382 17
a398 2
	if ((pMsg->message == WM_KEYDOWN) && (pMsg->wParam == VK_ESCAPE))
		return FALSE;
d400 11
a410 17
	if( (pMsg->message == WM_KEYDOWN) && (pMsg->wParam == VK_DELETE) && (pMsg->hwnd == GetDlgItem(IDC_SEARCHNAME)->m_hWnd) && (GetAsyncKeyState(VK_CONTROL)<0) )
		m_pacSearchString->Clear();

	if((pMsg->message == WM_KEYDOWN) && (pMsg->wParam == VK_RETURN))
	{
		if (pMsg->hwnd == GetDlgItem(IDC_SEARCHLIST)->m_hWnd)
			OnBnClickedSdownload();
		else if (pMsg->hwnd == GetDlgItem(IDC_ELINK)->m_hWnd)
			OnBnClickedStarts();
		else if (pMsg->hwnd == GetDlgItem(IDC_SEARCHNAME)->m_hWnd ||
			pMsg->hwnd == GetDlgItem(IDC_TypeSearch)->m_hWnd ||
			pMsg->hwnd == GetDlgItem(IDC_EDITSEARCHMIN)->m_hWnd ||
			pMsg->hwnd == GetDlgItem(IDC_EDITSEARCHMAX)->m_hWnd ||
			pMsg->hwnd == GetDlgItem(IDC_EDITSEARCHAVAILABILITY)->m_hWnd ||
			pMsg->hwnd == GetDlgItem(IDC_SEARCHNAME_NOT)->m_hWnd ||
			pMsg->hwnd == GetDlgItem(IDC_METHOD)->m_hWnd ||
			pMsg->hwnd == GetDlgItem(IDC_EDITSEARCHEXTENSION)->m_hWnd)
d412 6
a417 1
			if (m_pacSearchString && m_pacSearchString->IsBound() && pMsg->hwnd == GetDlgItem(IDC_SEARCHNAME)->m_hWnd)
d429 14
a443 1
			OnBnClickedStarts();
d1030 1
a1030 1
	if ((!m_bCancelled) && (nSearchID == m_nSearchID))
@


1.114
log
@Fix for exception on "Watch clipboard for ed2k links".
@
text
@d1091 2
d1110 1
a1110 2
		    byte			iCatIndex = m_ctrlCatTabs.GetCurSel();
			EnumCategories	eCatID = (iCatIndex < 1 || iCatIndex > CCat::GetNumUserCats()) ? CAT_NONE : CCat::GetCatIDByUserIndex(iCatIndex);
d1117 2
@


1.113
log
@Minor formating changes and corrections
Added ed2k server link processing at search window
@
text
@d1108 4
a1111 1
			AddEd2kLinksToDownload(m_strClipBoard, CAT_UNCATEGORIZED);
@


1.112
log
@Corrected display of '&' in Category submenu and on Search category tabs;
Improved string processing.
@
text
@d1139 15
@


1.111
log
@Improve image list filling.
@
text
@d595 1
d597 3
a599 2
	str[0] = GetResString(IDS_PW_SERVER);
	str[1] = GetResString(IDS_SW_GLOBAL);
d1324 1
d1330 5
a1334 1
		m_ctrlCatTabs.InsertItem(ix,CCat::GetCatByIndex(CCat::UserCatIndexToCatIndex(ix))->GetTitle());
@


1.110
log
@added 'Download (Paused)' to Searchlist context menu
@
text
@d68 9
d78 1
d94 8
a101 4
	m_BoxImageList.Add(LoadImgLstIcon(MAKEINTRESOURCE(IDI_SCH_SERVER),13,13));
	m_BoxImageList.Add(LoadImgLstIcon(MAKEINTRESOURCE(IDI_SCH_GLOBAL),13,13));
	m_BoxImageList.Add(LoadImgLstIcon(MAKEINTRESOURCE(IDI_SCH_FILEDONKEY),13,13));
//	m_BoxImageList.Add(LoadImgLstIcon(MAKEINTRESOURCE(IDI_SCH_JIGLE),13,13));
d105 1
a105 2
	m_pImageList.Add(LoadImgLstIcon(MAKEINTRESOURCE(IDI_NORMALSEARCH),16,16));
	LoadImgLstIcon(NULL,0,0); // delete temp-icon
@


1.109
log
@Minor formating changes, some more upload log and fix for clipboard monitoring
@
text
@d524 1
a524 1
void CSearchDlg::DownloadSelected()
d537 1
a537 1
			g_eMuleApp.m_pDownloadQueue->AddSearchToDownload((CSearchFile*)m_ctlSearchList.GetItemData(index),eCatID);
@


1.108
log
@Improved string processing; minor improvements.
@
text
@d121 1
a121 1
	AddAnchor(IDC_DOWNLOAD_ALL_ED2K, BOTTOM_LEFT); //<<-- enkeyDEV(Ottavio84) -Download all ed2ks in clipboard-
d1058 1
a1058 1
// START - enkeyDEV(Ottavio84) -Download all ed2ks in clipboard-
d1093 1
a1093 5

			byte			iCatIndex = m_ctrlCatTabs.GetCurSel();
			EnumCategories	eCatID = (iCatIndex < 1 || iCatIndex > CCat::GetNumUserCats()) ? CAT_NONE : CCat::GetCatIDByUserIndex(iCatIndex);

			AddEd2kLinksToDownload(m_strClipBoard, eCatID);
@


1.107
log
@Reverted last change (not meant)
@
text
@d190 1
a190 1
void CSearchDlg::OnChangeSize(bool changedMin)
d193 11
a203 4
	CString sMin, sMax;
	GetDlgItemText(IDC_EDITSEARCHMIN, sMin);
	GetDlgItemText(IDC_EDITSEARCHMAX, sMax);
	if (_tstol(sMin)>4095)
d205 4
a208 1
	if (_tstol(sMax)>4096)
d210 2
a211 1
	if (_tstoi(sMax)-_tstoi(sMin)<1 && sMax!="")
d213 1
a213 8
		if (changedMin)
		{
			SetDlgItemText(IDC_EDITSEARCHMAX, _T(""));
		}
		else
		{
			SetDlgItemText(IDC_EDITSEARCHMIN, _T(""));
		}
d233 1
a233 1
		GetDlgItem(IDC_ELINK)->SetWindowText(_T(""));
d364 1
a364 1
BOOL CSearchDlg::PreTranslateMessage(MSG* pMsg)
d367 3
a369 2
	if((pMsg->message == WM_KEYDOWN) && (pMsg->wParam == VK_ESCAPE))
	   	return FALSE;
d392 2
a393 1
				GetDlgItem(IDC_SEARCHNAME)->GetWindowText(strText);
d396 4
a399 3
					GetDlgItem(IDC_SEARCHNAME)->SetWindowText(_T("")); // this seems to be the only chance to let the dropdown list to disapear
					GetDlgItem(IDC_SEARCHNAME)->SetWindowText(strText);
					((CEdit*)GetDlgItem(IDC_SEARCHNAME))->SetSel(strText.GetLength(), strText.GetLength());
d403 1
a403 1
   		}
d406 1
d408 1
d451 1
a451 1
				strToFilter = _T("");
@


1.106
log
@*** empty log message ***
@
text
@d610 1
@


1.105
log
@Improved string processing.
@
text
@a609 1
	SetDlgItemText(IDC_SEARCHNAME, _T(""));
@


1.104
log
@Removed Jigle search and updated FileDonkey in both GUI and WebServer.
@
text
@d413 5
d428 7
a434 4
			strQuery = _T("http://www.filedonkey.com/fdsearch/index.php?pattern=");
			GetDlgItem(IDC_SEARCHNAME)->GetWindowText(strToSearch);
			strQuery += ToQueryString(strToSearch);
			GetDlgItem(IDC_EDITSEARCHEXTENSION)->GetWindowText(strToFilter);
d436 1
a436 3
			if ( strToFilter == "avi" || strToFilter == "mp3" || strToFilter == "mpg" || strToFilter == "rar" ||
				 strToFilter == "zip" || strToFilter == "divx" || strToFilter == "dvd" || strToFilter == "svcd" ||
				 strToFilter == "vcd" || strToFilter == "vhs")
d438 2
d441 1
a441 1
			else
d444 2
a445 6
			GetDlgItemText(IDC_EDITSEARCHMIN, strToSearch);
			int iMinSize=_tstol(strToSearch);
			GetDlgItemText(IDC_EDITSEARCHMAX, strToSearch);
			int iMaxSize=_tstol(strToSearch);

			strQuery.AppendFormat(_T("&scope=%s&min_size=%i&max_size=%i&w=search"), strToFilter, iMinSize*1048576, iMaxSize*1048576);
@


1.103
log
@Fixed file type selection for web service search requestes;
Improved string processing; minor improvements.
@
text
@a17 1

d87 1
a87 1
	m_BoxImageList.Add(LoadImgLstIcon(MAKEINTRESOURCE(IDI_SCH_JIGLE),13,13));
d138 2
d415 2
a416 2
	CString			query,tosearch;
	unsigned long	num;
d423 10
a432 15
			query = _T("http://www.filedonkey.com/fdsearch/index.php?pattern=");
			GetDlgItemText(IDC_SEARCHNAME, tosearch);
			query += ToQueryString(tosearch);
			GetDlgItemText(IDC_TypeSearch, tosearch);
			iIdx = tosearch.Find(_T(" (."));
			if (iIdx > 0)
				tosearch.Truncate(iIdx);
			if (GetResString(IDS_SEARCH_AUDIO) == tosearch)
				tosearch = _T("Audio");
			else if (GetResString(IDS_SEARCH_VIDEO) == tosearch)
				tosearch = _T("Video");
			else if (GetResString(IDS_SEARCH_PRG) == tosearch)
				tosearch = _T("Pro");
			else if (GetResString(IDS_SEARCH_DOC) == tosearch)	// netwolf 06.05.03
				tosearch = _T("Doc");
d434 8
a441 3
				tosearch = _T("All");
		//	Added filedonkey 'type' option
			query.AppendFormat(_T("&media=%s&action=search&name=FD-Search&op=modload&file=index&requestby=emule"), tosearch);
d446 3
a448 3
			GetDlgItemText(IDC_SEARCHNAME, tosearch);
			query.Format(_T("http://www.jigle.com/search?p=%s&ma="), ToQueryString(tosearch));
			GetDlgItemText(IDC_EDITSEARCHAVAILABILITY, tosearch);
d450 1
a450 1
			uint32		dwToSearch = _tstoi(tosearch);
d468 5
a472 5
			query.AppendFormat(_T("%u&v=0&d=1&a=0&l=10"), dwToSearch);		//Cax2 might want to change to l=25 for more results per page...
			GetDlgItemText(IDC_EDITSEARCHMIN, tosearch);
			num=_tstol(tosearch);
			GetDlgItemText(IDC_TypeSearch, tosearch);
			iIdx = tosearch.Find(_T(" (."));
d474 11
a484 11
				tosearch.Truncate(iIdx);
			if (GetResString(IDS_SEARCH_AUDIO)==tosearch)
				tosearch=_T("1");
			else if (GetResString(IDS_SEARCH_VIDEO)==tosearch)
				tosearch=_T("2");
			else if (GetResString(IDS_SEARCH_PICS)==tosearch)
				tosearch=_T("3");
			else if (GetResString(IDS_SEARCH_PRG)==tosearch)
				tosearch=_T("4");
			else if (GetResString(IDS_SEARCH_DOC)==tosearch)	// netwolf 06.05.03	// 5 is jigles search for docs string
				tosearch=_T("5");
d486 5
a490 5
				tosearch=_T("0");
			query.AppendFormat(_T("&t=%s&sl=%u&su="), tosearch, (num > 0) ? num * 1048576 : 1);
			GetDlgItemText(IDC_EDITSEARCHMAX, tosearch);
			if ((num = _tstol(tosearch)) > 0)
				query.AppendFormat(_T("%u"), num * 1048576);
d494 1
a494 1
	return query;
d569 1
a569 1
	CString            str[4];
d573 2
a574 2
	str[3] = _T("Jigle");
	for (int i = 0; i < 4; i++)
d1017 25
@


1.102
log
@Improved string processing; Unified localization.
@
text
@d193 2
a194 2
	GetDlgItem(IDC_EDITSEARCHMIN)->GetWindowText(sMin);
	GetDlgItem(IDC_EDITSEARCHMAX)->GetWindowText(sMax);
d196 1
a196 1
		GetDlgItem(IDC_EDITSEARCHMIN)->SetWindowText(_T("4095"));
d198 1
a198 1
		GetDlgItem(IDC_EDITSEARCHMAX)->SetWindowText(_T("4096"));
d203 1
a203 1
			GetDlgItem(IDC_EDITSEARCHMAX)->SetWindowText(_T(""));
d207 1
a207 1
			GetDlgItem(IDC_EDITSEARCHMIN)->SetWindowText(_T(""));
d222 2
d225 2
a226 1
	if (GetDlgItem(IDC_ELINK)->GetWindowTextLength() != NULL)
a227 3
		CString			strLink;

		GetDlgItem(IDC_ELINK)->GetWindowText(strLink);
d233 1
a233 2
		AddEd2kLinksToDownload(strLink,eCatID);
		return;
d236 1
a236 1
	if (GetDlgItem(IDC_SEARCHNAME)->GetWindowTextLength())
d240 2
a241 4
			CString			strSearch;

			if (GetDlgItemText(IDC_SEARCHNAME, strSearch))
				m_pacSearchString->AddItem(strSearch, 0);
d416 1
d422 7
a428 4
			query = _T("http://www.filedonkey.com/fdsearch/index.php?");
			GetDlgItem(IDC_SEARCHNAME)->GetWindowText(tosearch);
			query += _T("pattern=")+ToQueryString(tosearch);
			GetDlgItem(IDC_TypeSearch)->GetWindowText(tosearch);
d439 2
a440 2
			query +=_T("&media=") + tosearch; //Cax2 added filedonkey 'type' option
			query += _T("&action=search&name=FD-Search&op=modload&file=index&requestby=emule");
d445 29
a473 14
			query = _T("http://www.jigle.com/search?");
			GetDlgItem(IDC_SEARCHNAME)->GetWindowText(tosearch);
			query += _T("p=")+ToQueryString(tosearch) + _T("&ma=");
			GetDlgItem(IDC_EDITSEARCHAVAILABILITY)->GetWindowText(tosearch);
			if (_tstol(tosearch)>1000) tosearch=_T("1000");
			else if (_tstoi(tosearch)>500) tosearch=_T("500");
			else if (_tstoi(tosearch)>200) tosearch=_T("200");
			else if (_tstoi(tosearch)>100) tosearch=_T("100");
			else if (_tstoi(tosearch)>50) tosearch=_T("50");
			else if (_tstoi(tosearch)>20) tosearch=_T("20");
			else if (_tstoi(tosearch)>10) tosearch=_T("10");
			else tosearch=_T("1");
			query += tosearch +_T("&v=0&d=1&a=0&l=10");		//Cax2 might want to change to l=25 for more results per page...
			GetDlgItem(IDC_TypeSearch)->GetWindowText(tosearch);
d486 4
a489 9
			query +=_T("&t=") +tosearch;
			GetDlgItem(IDC_EDITSEARCHMIN)->GetWindowText(tosearch);
			num=_tstol(tosearch);
			tosearch.Format(_T("%u"),((num>0)?num *1048576:1));
			query +=_T("&sl=") +tosearch;
			GetDlgItem(IDC_EDITSEARCHMAX)->GetWindowText(tosearch);
			num=_tstol(tosearch);
			tosearch.Format(((num>0)?_T("%u"):_T("")),num * 1048576);
			query +=_T("&su=") + tosearch;
a491 2
		default:
			return _T("");
d556 1
a556 1
		GetDlgItem(s_aiResTbl[i][0])->SetWindowText(GetResString(static_cast<UINT>(s_aiResTbl[i][1])));
d561 2
a562 2
	GetDlgItem(IDC_SEARCHMINSIZE)->SetWindowText(GetResString(IDS_SEARCHMINSIZE) + _T(" (") + GetResString(IDS_MBYTES) + _T(')'));
	GetDlgItem(IDC_SEARCHMAXSIZE)->SetWindowText(GetResString(IDS_SEARCHMAXSIZE) + _T(" (") + GetResString(IDS_MBYTES) + _T(')'));
d605 1
a605 1
	GetDlgItem(IDC_SEARCHNAME)->SetWindowText(_T(""));
d815 1
a815 1
		GetDlgItem(IDC_SEARCHNAME)->GetWindowText(strSearch);
d817 1
a817 1
		GetDlgItem(IDC_EDITSEARCHEXTENSION)->GetWindowText(strExtension);
d826 1
a826 1
		CString			strTypeText,strSizeMin,strSizeMax,strAvailability,strType,strSearchExclusion;
d829 1
a829 1
		GetDlgItem(IDC_TypeSearch)->GetWindowText(strTypeText);
d835 1
a835 1
			strTypeText.Delete(idx, strTypeText.GetLength() - idx);
d838 5
a842 4
		GetDlgItem(IDC_EDITSEARCHMIN)->GetWindowText(strSizeMin);
		strSizeMin.Trim();
		GetDlgItem(IDC_EDITSEARCHMAX)->GetWindowText(strSizeMax);
		strSizeMax.Trim();
d844 1
a844 2
		unsigned long	dwMinSize = _tstol(strSizeMin.GetString()) * 0x100000;
		unsigned long	dwMaxSize = _tstol(strSizeMax.GetString()) * 0x100000;
d855 1
a855 2
		GetDlgItem(IDC_EDITSEARCHAVAILABILITY)->GetWindowText(strAvailability);
		strAvailability.Trim();
d857 1
a857 1
		int				iAvailability = _tstoi(strAvailability);
d864 1
a864 1
		GetDlgItem(IDC_SEARCHNAME_NOT)->GetWindowText(strSearchExclusion);
d996 6
a1001 6
	GetDlgItem(IDC_EDITSEARCHAVAILABILITY)->SetWindowText(_T(""));
	GetDlgItem(IDC_EDITSEARCHEXTENSION)->SetWindowText(_T(""));
	GetDlgItem(IDC_EDITSEARCHMIN)->SetWindowText(_T(""));
	GetDlgItem(IDC_EDITSEARCHMAX)->SetWindowText(_T(""));
	GetDlgItem(IDC_SEARCHNAME)->SetWindowText(_T(""));
	GetDlgItem(IDC_SEARCHNAME_NOT)->SetWindowText(_T(""));
@


1.101
log
@bugfix to avoid invalid link messages due to leading blanks when watching clipboard
@
text
@d524 19
d546 3
a549 4
	GetDlgItem(IDC_SNAME_LBL)->SetWindowText(GetResString(IDS_SW_NAME));
	GetDlgItem(IDC_SNAME_LBL2)->SetWindowText(GetResString(IDS_SCH_EXCEPT));
	GetDlgItem(IDC_STYPE_LBL)->SetWindowText(GetResString(IDS_SW_TYPE));
	GetDlgItem(IDC_SMETHOD_LBL)->SetWindowText(GetResString(IDS_SW_METHOD));
a550 1
	GetDlgItem(IDC_ED2KLINK_LBL)->SetWindowText(GetResString(IDS_SW_LINK));
d552 2
a553 14
	GetDlgItem(IDC_STARTS)->SetWindowText(GetResString(IDS_SW_START));
	GetDlgItem(IDC_MORES)->SetWindowText(GetResString(IDS_SW_MORE));
	GetDlgItem(IDC_CANCELS)->SetWindowText(GetResString(IDS_SW_CANCEL));
	GetDlgItem(IDC_CLEARALL)->SetWindowText(GetResString(IDS_REMOVEALLSEARCH));

	GetDlgItem(IDC_RESULTS_LBL)->SetWindowText(GetResString(IDS_SW_RESULT));
	GetDlgItem(IDC_SDOWNLOAD)->SetWindowText(GetResString(IDS_SW_DOWNLOAD));

	GetDlgItem(IDC_SEARCHMINSIZE)->SetWindowText(GetResString(IDS_SEARCHMINSIZE) + _T(" (") + GetResString(IDS_MBYTES) + _T(")"));
	GetDlgItem(IDC_SEARCHMAXSIZE)->SetWindowText(GetResString(IDS_SEARCHMAXSIZE) + _T(" (") + GetResString(IDS_MBYTES) + _T(")"));
	GetDlgItem(IDC_SEARCHAVAIL)->SetWindowText(GetResString(IDS_SEARCHAVAIL));
	GetDlgItem(IDC_SEARCHEXT)->SetWindowText(GetResString(IDS_SEARCHEXTENSION_LBL));
	GetDlgItem(IDC_SEARCH_RESET)->SetWindowText(GetResString(IDS_PW_RESET)); // EC
	GetDlgItem(IDC_DOWNLOAD_ALL_ED2K)->SetWindowText(GetResString(IDS_DOWNLOAD_ALL_ED2K)); //<<--enkeyDEV
d564 1
a564 1
	for (int i=0; i<4;i++)
d1166 2
a1167 1
							msglinks += newlink + _T("\n");
@


1.100
log
@removed debugging informations
@
text
@d1027 1
a1027 1
	CString m_strClipBoard = g_eMuleApp.CopyTextFromClipboard();
@


1.99
log
@removed old search code + some fix and changes
@
text
@a655 2
	CString			strSearchDebug = _T("");

a676 1
				strSearchDebug += _T("AND ");
a681 1
			strSearchDebug.AppendFormat(_T("\"%s\" "), strOldResToken);
a688 1
			strSearchDebug += _T("AND ");
a694 1
		strSearchDebug.AppendFormat(_T("type=\"%s\" "), strType);
a700 1
			strSearchDebug += _T("AND ");
a704 1
		strSearchDebug.AppendFormat(_T("min=%u "), dwMinSize);
a710 1
			strSearchDebug += _T("AND ");
a714 1
		strSearchDebug.AppendFormat(_T("max=%u "), dwMaxSize);
a722 1
			strSearchDebug += _T("AND ");
a726 1
		strSearchDebug.AppendFormat(_T("avail=%u "), iAvailability);
a732 1
	    	strSearchDebug += _T("AND ");
a738 1
		strSearchDebug.AppendFormat(_T("ext=\"%s\" "), strExtension);
a740 2
	if (!strSearchDebug.IsEmpty())
		AddDebugLogLine(false, RGB_LOG_ERROR + _T("[KuSh - test] Search Request: %s"), strSearchDebug);
@


1.98
log
@fixes for my future code
@
text
@a49 1
#ifdef NEW_SEARCH_ENABLED
a50 1
#endif // NEW_SEARCH_ENABLED
a160 1
#ifdef NEW_SEARCH_ENABLED
a161 1
#endif // NEW_SEARCH_ENABLED
a316 1
#ifdef NEW_SEARCH_ENABLED
a317 1
#endif // NEW_SEARCH_ENABLED
a322 1
#ifdef NEW_SEARCH_ENABLED
a328 2
	//	Avoid enabled more button if search results are processed after a user's cancel
		GetDlgItem(IDC_MORES)->EnableWindow(bIsMoreResultsAvailable && m_nMoreRequestCount < 5);
d344 1
a344 9
	EMULE_CATCH
}
#else
void CSearchDlg::LocalSearchEnd(uint16 count)
{
	EMULE_TRY
	if (!m_bCancelled && count > MAX_RESULTS)
		OnBnClickedCancels();
	if (!m_bCancelled)
d346 1
a346 8
		if (!m_bGlobalSearch)
		{
			GetDlgItem(IDC_STARTS)->EnableWindow(true);
			GetDlgItem(IDC_CANCELS)->EnableWindow(false);
			GetDlgItem(IDC_CLEARALL)->EnableWindow(true);
		}
		else
			global_search_timer = SetTimer(1, 750, 0);
a349 1
#endif // NEW_SEARCH_ENABLED
a613 1
#ifdef NEW_SEARCH_ENABLED
a614 1
#endif // NEW_SEARCH_ENABLED
a617 2
#ifdef NEW_SEARCH_ENABLED
//	KuSh: official use UNICODE, so ... why not ?
a631 16
#else
//	eklmn: don't use UNICODE here
	if (GetResString(IDS_SEARCH_AUDIO)==strTypeText)
		strType = "Audio";
	else if (GetResString(IDS_SEARCH_VIDEO)==strTypeText)
		strType = "Video";
//	Archives, CD images and programs treated the same by servers
	else if (GetResString(IDS_SEARCH_ARC) == strTypeText || GetResString(IDS_SEARCH_PRG)==strTypeText || GetResString(IDS_SEARCH_CDIMG) == strTypeText)
		strType = "Pro";
	else if (GetResString(IDS_SEARCH_PICS)==strTypeText)
		strType = "Image";
	else if (GetResString(IDS_SEARCH_DOC)==strTypeText)
		strType = "Doc";
	else
		strType = "";
#endif //NEW_SEARCH_ENABLED
a634 3
#ifndef NEW_SEARCH_ENABLED
	TCHAR		   *ptstrFormat;
#endif //NEW_SEARCH_ENABLED
a638 1
#ifdef NEW_SEARCH_ENABLED
a758 97
#else
	int		iNumParameters = 0; //must be written iNumParameters-1 parameter headers

	if (strSearch.GetLength() > 0)
	{
		iNumParameters++;
		if (iNumParameters > 1)
			packetStream.Write(&SEARCH_OPPARAM_AND,2);
	}

	if (strType.GetLength() > 0)
	{
		iNumParameters++;
		if (iNumParameters > 1)
			packetStream.Write(&SEARCH_OPPARAM_AND,2);
	}

	if (dwMinSize > 0)
	{
		iNumParameters++;
		if (iNumParameters > 1)
			packetStream.Write(&SEARCH_OPPARAM_AND,2);
	}

	if (dwMaxSize > 0)
	{
		iNumParameters++;
		if (iNumParameters > 1)
			packetStream.Write(&SEARCH_OPPARAM_AND,2);
	}

//	Because the availability is used with the 'Min' operator, we decrement the entered value by one to get
//	more 'useable' results from the server (from a user's POV).
	if (iAvailability >= 0)
	{
		iNumParameters++;
		if (iNumParameters > 1)
			packetStream.Write(&SEARCH_OPPARAM_AND,2);
	}

	if (strExtension.GetLength() > 0)
	{
		iNumParameters++;
		if (iNumParameters > 1)
			packetStream.Write(&SEARCH_OPPARAM_AND,2);
	}

    //body
	if (strSearch.GetLength() > 0) //search a string
	{
		packetStream.Write(&SEARCH_PARAMTYPE_STRING,1); //write the parameter strType
		uSize = strSearch.GetLength();
		packetStream.Write(&uSize,2);  // write parameter length
		packetStream.Write(strSearch.GetBuffer() ,uSize); //write the searched string
	}

	if (strType.GetLength() > 0)
	{
		packetStream.Write(&SEARCH_PARAMTYPE_TYPE,1); //write the parameter strType
		uSize=strType.GetLength();
		packetStream.Write(&uSize,2);   //write the length
		ptstrFormat = strType.GetBuffer();
		packetStream.Write(ptstrFormat,uSize); //write parameter
		packetStream.Write(&SEARCH_PARAMID_TYPE,3); //nemonic for this kind of parameter (only 3 bytes!!)
	}

	if (dwMinSize > 0)
	{
		packetStream.Write(&SEARCH_PARAMTYPE_NUMERIC,1); //write the parameter strType
		packetStream.Write(&dwMinSize,4);		   //write the parameter
		packetStream.Write(&SEARCH_PARAMID_MINSIZE,4);    //nemonic for this kind of parameter
	}

	if (dwMaxSize > 0)
	{
		packetStream.Write(&SEARCH_PARAMTYPE_NUMERIC,1); //write the parameter strType
		packetStream.Write(&dwMaxSize,4);		   //write the parameter
		packetStream.Write(&SEARCH_PARAMID_MAXSIZE,4);    //nemonic for this kind of parameter
	}

	if (iAvailability > 0)
	{
		packetStream.Write(&SEARCH_PARAMTYPE_NUMERIC,1); //write the parameter strType
		packetStream.Write(&iAvailability,4);    //write the parameter
		packetStream.Write(&SEARCH_PARAMID_AVAILABILITY,4);  //nemonic for this kind of parameter
	}

	if (strExtension.GetLength() > 0)
	{
		packetStream.Write(&SEARCH_PARAMTYPE_STRING,1); //write the parameter strType
		uSize=strExtension.GetLength();
		packetStream.Write(&uSize,2);   //write the length
		ptstrFormat=strExtension.GetBuffer();
		packetStream.Write(ptstrFormat,uSize); //write parameter
		packetStream.Write(&SEARCH_PARAMID_EXTENSION,3); //nemonic for this kind of parameter (only 3 bytes!!)
	}
#endif //NEW_SEARCH_ENABLED
d860 1
a860 1
		int				iAvailability;
d862 1
a862 1
		if (strAvailability.IsEmpty())
a865 4
		else
		{
			iAvailability = _tstoi(strAvailability) - 1;
		}
a873 1
#ifdef NEW_SEARCH_ENABLED
a874 1
#endif // NEW_SEARCH_ENABLED
a988 1
#ifdef NEW_SEARCH_ENABLED
a989 1
#endif //  NEW_SEARCH_ENABLED
a1300 1
#ifdef NEW_SEARCH_ENABLED
a1331 1
#endif // NEW_SEARCH_ENABLED
@


1.97
log
@formatting;
optimzations in UploadQueue.cpp;
removing doubled ';'
@
text
@d336 2
a352 1
	GetDlgItem(IDC_MORES)->EnableWindow(bIsMoreResultsAvailable && m_nMoreRequestCount < 5);
d725 1
a725 1
			if (!strResToken.IsEmpty() || dwTermsCount > 1)
@


1.96
log
@Minor change
@
text
@a700 2
	if (!strSearch.IsEmpty())
		dwTermsCount++;
d704 2
d727 1
d733 1
d741 1
d748 1
d755 1
d760 1
d767 1
d772 1
d781 1
d786 1
d793 1
d800 1
d803 3
@


1.95
log
@formatting;
corrected last Aw3 change;
tokenize the Search String to send multi AND arguments
@
text
@d553 1
a553 1
	GetDlgItem(IDC_SNAME_LBL2)->SetWindowText(GetResString(IDS_SCH_EXCEPT).MakeLower());
@


1.94
log
@minor correction (no logic changes)
@
text
@d337 1
d339 2
a340 1
		if (!m_bGlobalSearch)
d713 1
d716 16
a731 3
		if (++dwParameterCount < dwTermsCount)
		{
			packetStream.Write(&SEARCH_OPPARAM_AND, 2);
a732 4
		packetStream.Write(&SEARCH_PARAMTYPE_STRING, 1);		// write the parameter strType
		uSize = strSearch.GetLength();
		packetStream.Write(&uSize, 2);							// write parameter length
		packetStream.Write(strSearch.GetBuffer(), uSize);		// write the searched string
@


1.93
log
@formatting;
more button code comitted but not compiled as default
@
text
@d333 1
a333 2
	if (!m_bCancelled && count > MAX_RESULTS)
		OnBnClickedCancels();
d336 2
@


1.92
log
@fix: min search doesn't work, due to my changes
@
text
@d50 3
d112 1
d163 3
d321 3
d329 23
d370 1
d557 1
d635 3
d995 3
d1112 3
d1426 33
d1482 1
@


1.91
log
@reverted a bogus change by me;
added Extension field in Search Window
@
text
@d897 1
d899 1
d920 3
a922 1
		GetDlgItem(IDC_EDITSEARCHMAX)->GetWindowText(strSizeMin);
a923 1
		unsigned long	dwMaxSize = _tstol(strSizeMin.GetString()) * 0x100000;
d925 1
d937 1
d951 1
@


1.90
log
@added "Watch clipboard for ed2k links"
@
text
@d370 2
a371 1
			pMsg->hwnd == GetDlgItem(IDC_METHOD)->m_hWnd)
d532 1
d894 1
a894 1
		CString			strSearch;
d897 1
d900 1
a900 1
		if (strSearch.IsEmpty())
a905 1
		CString			strExtension = _T("");
d1075 1
d1113 1
a1113 1
void CSearchDlg::SearchClipBoard() 
@


1.89
log
@formatting;
removed duplicate code for Starting a Search and Creates ED2KLinks;
first few changes in both code and gui to implement the new search method (ED2KProtocol), don't worry :)
@
text
@d49 1
d76 1
d128 1
d215 1
a215 1
		return; // EC 10.07.03
d219 1
d222 1
a222 1
		CString			strlink;
d224 1
a224 1
		GetDlgItem(IDC_ELINK)->GetWindowText(strlink);
d230 1
a230 1
		AddEd2kLinksToDownload(strlink,eCatID);
d233 1
d501 1
a501 2
			// Lord KiRon
			//m_ctlSearchList.Update(index);
d1109 13
d1123 18
a1140 1
void CSearchDlg::AddEd2kLinksToDownload(CString strlink,EnumCategories eCatID)
d1147 1
a1147 1
	resToken = strlink.Tokenize(_T("\t\n\r"),curPos);
d1166 1
a1166 1
				delete pLink; // [i_a] memleak
d1180 1
a1180 1
		resToken = strlink.Tokenize(_T("\t\n\r"),curPos);
a1301 1
// END - enkeyDEV(Ottavio84) -Download all ed2ks in clipboard-
@


1.88
log
@formatting;
minor change in LanCast preferences loading;
changed the SearchDlg code to not duplicate the code
@
text
@a79 1
	m_ctlSearchTabs.ShowWindow(SW_HIDE);
d122 2
d216 1
a216 1
	if (GetDlgItem(IDC_ELINK)->GetWindowTextLength())
d218 1
a218 1
		CString		strlink;
a220 5
		strlink.Trim();
		if (strlink.Right(1) != _T("/"))
		{
			strlink += _T("/");
		}
a221 9
		try
		{
			CED2KLink	   *pLink = CED2KLink::CreateLinkFromUrl(strlink);

			_ASSERT( pLink != NULL );
			if (pLink->GetKind() == CED2KLink::kFile)
			{
				byte			iCatIndex = m_ctrlCatTabs.GetCurSel();
				EnumCategories	eCatID = (iCatIndex < 1 || iCatIndex > CCat::GetNumUserCats()) ? CAT_NONE : CCat::GetCatIDByUserIndex(iCatIndex);
d223 2
a224 13
				g_eMuleApp.m_pDownloadQueue->AddFileLinkToDownload(pLink->GetFileLink(), eCatID);
			}
			else
			{
				delete pLink; // [i_a] memleak
				throw CString(_T("bad link"));
			}
			delete pLink;
		}
		catch(CString &error)
		{
			OUTPUT_DEBUG_TRACE();
			CString			buffer;
d226 1
a226 3
			buffer.Format(GetResString(IDS_ERR_INVALIDLINK),error.GetBuffer());
			AddLogLine(true, RGB_LOG_WARNING + GetResString(IDS_ERR_LINKERROR), buffer);
		}
d308 1
a309 1
	GetDlgItem(IDC_STARTS)->EnableWindow(true);
d371 2
a372 1
				if (!strText.IsEmpty()){
d397 4
a400 2
	CString query,tosearch;
	unsigned long num;
d403 61
a463 57
	case 2:
		query = _T("http://www.filedonkey.com/fdsearch/index.php?");
		GetDlgItem(IDC_SEARCHNAME)->GetWindowText(tosearch);
		query += _T("pattern=")+ToQueryString(tosearch);
		GetDlgItem(IDC_TypeSearch)->GetWindowText(tosearch);
		if (GetResString(IDS_SEARCH_AUDIO)==tosearch)
			tosearch=_T("Audio");
		else if (GetResString(IDS_SEARCH_VIDEO)==tosearch)
			tosearch=_T("Video");
		else if (GetResString(IDS_SEARCH_PRG)==tosearch)
			tosearch=_T("Pro");
		else if (GetResString(IDS_SEARCH_DOC)==tosearch)	// netwolf 06.05.03
			tosearch=_T("Doc");
		else
			tosearch=_T("All");
		query +=_T("&media=") + tosearch; //Cax2 added filedonkey 'type' option
		query += _T("&action=search&name=FD-Search&op=modload&file=index&requestby=emule");
		break;
	case 3:
		query = _T("http://www.jigle.com/search?");
		GetDlgItem(IDC_SEARCHNAME)->GetWindowText(tosearch);
		query += _T("p=")+ToQueryString(tosearch) + _T("&ma=");
		GetDlgItem(IDC_EDITSEARCHAVAILABILITY)->GetWindowText(tosearch);
		if (_tstol(tosearch)>1000) tosearch=_T("1000");
		else if (_tstoi(tosearch)>500) tosearch=_T("500");
		else if (_tstoi(tosearch)>200) tosearch=_T("200");
		else if (_tstoi(tosearch)>100) tosearch=_T("100");
		else if (_tstoi(tosearch)>50) tosearch=_T("50");
		else if (_tstoi(tosearch)>20) tosearch=_T("20");
		else if (_tstoi(tosearch)>10) tosearch=_T("10");
		else tosearch=_T("1");
		query += tosearch +_T("&v=0&d=1&a=0&l=10");		//Cax2 might want to change to l=25 for more results per page...
		GetDlgItem(IDC_TypeSearch)->GetWindowText(tosearch);
		if (GetResString(IDS_SEARCH_AUDIO)==tosearch)
			tosearch=_T("1");
		else if (GetResString(IDS_SEARCH_VIDEO)==tosearch)
			tosearch=_T("2");
		else if (GetResString(IDS_SEARCH_PICS)==tosearch)
			tosearch=_T("3");
		else if (GetResString(IDS_SEARCH_PRG)==tosearch)
			tosearch=_T("4");
		else if (GetResString(IDS_SEARCH_DOC)==tosearch)	// netwolf 06.05.03	// 5 is jigles search for docs string
			tosearch=_T("5");
		else
			tosearch=_T("0");
		query +=_T("&t=") +tosearch;
		GetDlgItem(IDC_EDITSEARCHMIN)->GetWindowText(tosearch);
		num=_tstol(tosearch);
		tosearch.Format(_T("%u"),((num>0)?num *1048576:1));
		query +=_T("&sl=") +tosearch;
		GetDlgItem(IDC_EDITSEARCHMAX)->GetWindowText(tosearch);
		num=_tstol(tosearch);
		tosearch.Format(((num>0)?_T("%u"):_T("")),num * 1048576);
		query +=_T("&su=") + tosearch;
		break;
	default:
		return CString(_T(""));
d466 1
d468 2
a469 1
	return CString(_T(""));
d472 2
a473 1
CString	CSearchDlg::ToQueryString(CString str){
d479 1
a479 1
	return CString(_T(""));
d581 2
a582 1
	if (!g_eMuleApp.m_pServerConnect->IsConnected()) return;
d585 5
a589 20
		m_nSearchID++;
		g_eMuleApp.m_pSearchList->NewSearch(&m_ctlSearchList,strTypeText,m_nSearchID);
		m_bCancelled = false;

		CString		strType;

	//	eklmn: don't use UNICODE here
		if (GetResString(IDS_SEARCH_AUDIO)==strTypeText)
			strType = "Audio";
		else if (GetResString(IDS_SEARCH_VIDEO)==strTypeText)
			strType = "Video";
	//	Archives, CD images and programs treated the same by servers
		else if (GetResString(IDS_SEARCH_ARC) == strTypeText || GetResString(IDS_SEARCH_PRG)==strTypeText || GetResString(IDS_SEARCH_CDIMG) == strTypeText)
			strType = "Pro";
		else if (GetResString(IDS_SEARCH_PICS)==strTypeText)
			strType = "Image";
		else if (GetResString(IDS_SEARCH_DOC)==strTypeText)
			strType = "Doc";
		else
			strType = "";
d591 38
a628 3
		CMemFile	packetStream(100);
		uint16		uSize;
		TCHAR		*ptstrFormat;
d630 26
a655 2
		if (strExtension.GetLength() > 0 && strExtension.GetAt(0) != '.')
			strExtension = _T(".") + strExtension;
d657 1
a657 4
		if (strSearch.GetLength() == 0 && strExtension.GetLength() == 0)
		{
			return;
		}
d659 6
a664 1
		int		iNumParameters = 0; //must be written iNumParameters-1 parameter headers
d666 3
a668 1
		if (strSearch.GetLength()>0)
d670 1
a670 3
			iNumParameters++;
			if (iNumParameters>1)
				packetStream.Write(&SEARCH_OPPARAM_AND,2);
d672 8
a679 2

		if (strType.GetLength()>0)
d681 1
a681 3
			iNumParameters++;
			if (iNumParameters>1)
				packetStream.Write(&SEARCH_OPPARAM_AND,2);
d683 9
a691 2

		if (dwMinSize>0)
d693 1
a693 3
			iNumParameters++;
			if (iNumParameters>1)
				packetStream.Write(&SEARCH_OPPARAM_AND,2);
d695 7
a701 2

		if (dwMaxSize>0)
d703 1
a703 3
			iNumParameters++;
			if (iNumParameters>1)
				packetStream.Write(&SEARCH_OPPARAM_AND,2);
d705 9
a713 4

	//	Because the availability is used with the 'Min' operator, we decrement the entered value by one to get
	//	more 'useable' results from the server (from a user's POV).
		if (iAvailability>=0)
d715 1
a715 3
			iNumParameters++;
			if (iNumParameters>1)
				packetStream.Write(&SEARCH_OPPARAM_AND,2);
d717 7
a723 2

		if (strExtension.GetLength()>0)
d725 1
a725 3
			iNumParameters++;
			if (iNumParameters>1)
				packetStream.Write(&SEARCH_OPPARAM_AND,2);
d727 31
d759 22
a780 8
        //body
		if (strSearch.GetLength()>0) //search a string
		{
			packetStream.Write(&SEARCH_PARAMTYPE_STRING,1); //write the parameter strType
			uSize = strSearch.GetLength();
			packetStream.Write(&uSize,2);  // write parameter length
			packetStream.Write(strSearch.GetBuffer() ,uSize); //write the searched string
		}
d782 8
a789 9
		if (strType.GetLength()>0)
		{
			packetStream.Write(&SEARCH_PARAMTYPE_TYPE,1); //write the parameter strType
			uSize=strType.GetLength();
			packetStream.Write(&uSize,2);   //write the length
			ptstrFormat=strType.GetBuffer();
			packetStream.Write(ptstrFormat,uSize); //write parameter
			packetStream.Write(&SEARCH_PARAMID_TYPE,3); //nemonic for this kind of parameter (only 3 bytes!!)
		}
d791 9
a799 6
		if (dwMinSize>0)
		{
			packetStream.Write(&SEARCH_PARAMTYPE_NUMERIC,1); //write the parameter strType
			packetStream.Write(&dwMinSize,4);		   //write the parameter
			packetStream.Write(&SEARCH_PARAMID_MINSIZE,4);    //nemonic for this kind of parameter
		}
d801 6
a806 6
		if (dwMaxSize>0)
		{
			packetStream.Write(&SEARCH_PARAMTYPE_NUMERIC,1); //write the parameter strType
			packetStream.Write(&dwMaxSize,4);		   //write the parameter
			packetStream.Write(&SEARCH_PARAMID_MAXSIZE,4);    //nemonic for this kind of parameter
		}
d808 6
a813 6
		if (iAvailability>0)
		{
			packetStream.Write(&SEARCH_PARAMTYPE_NUMERIC,1); //write the parameter strType
			packetStream.Write(&iAvailability,4);    //write the parameter
			packetStream.Write(&SEARCH_PARAMID_AVAILABILITY,4);  //nemonic for this kind of parameter
		}
d815 6
a820 9
		if (strExtension.GetLength()>0)
		{
			packetStream.Write(&SEARCH_PARAMTYPE_STRING,1); //write the parameter strType
			uSize=strExtension.GetLength();
			packetStream.Write(&uSize,2);   //write the length
			ptstrFormat=strExtension.GetBuffer();
			packetStream.Write(ptstrFormat,uSize); //write parameter
			packetStream.Write(&SEARCH_PARAMID_EXTENSION,3); //nemonic for this kind of parameter (only 3 bytes!!)
		}
d822 10
d833 1
a833 1
		Packet		*pPacket = new Packet(&packetStream);
d835 1
a835 1
		pPacket->m_eOpcode = OP_SEARCHREQUEST;
d837 1
a837 1
		g_eMuleApp.m_pUploadQueue->AddUpDataOverheadServer(pPacket->m_dwSize);
d839 1
a839 1
		g_eMuleApp.m_pServerConnect->SendPacket(pPacket,false);
d842 3
a844 1
		if (bDoGlobal)
d846 1
a846 19
			if (g_eMuleApp.m_pGlobPrefs->Score())
			{
				g_eMuleApp.m_pServerList->ResetSearchServerPos();
			}
		//	Get rid of any old global search packet
			if (m_bGlobalSearch)
				safe_delete(m_pGlobalSearchPacket);
		//
		//	Change the search request packet into a global search packet and save it.
			m_pGlobalSearchPacket = pPacket;
			m_pGlobalSearchPacket->m_eOpcode = OP_GLOBSEARCHREQ;
			m_uServerCount = 0;
			m_ctlGlobalSearchProgress.SetRange32(0,g_eMuleApp.m_pServerList->GetServerCount()-1);
			m_bGlobalSearch = true;
		}
		else
		{
			m_bGlobalSearch = false;
			delete pPacket;
d848 18
d867 4
a870 1
		SearchData		sd;
a871 4
		sd.sNotSearch = strSearchExclusion;
		sd.bDocumentSearch = (GetResString(IDS_SEARCH_DOC) == strTypeText);
		m_SearchMap.SetAt(m_nSearchID, sd);
		CreateNewTab(strSearch,m_nSearchID);
d888 11
a898 1
		CString			strSearch,strTypeText,strSizeMin,strSizeMax,strAvailability,strType,strSearchExclusion;
a901 1
		GetDlgItem(IDC_SEARCHNAME)->GetWindowText(strSearch);
d960 1
a960 1
		searchString = "-";
d968 1
a968 1
		m_ctlSearchTabs.ShowWindow(SW_SHOW);
d1002 1
a1002 1
		m_ctlSearchTabs.ShowWindow(SW_HIDE);
d1013 1
a1013 1
	m_ctlSearchTabs.ShowWindow(SW_HIDE);
a1020 2
	const int cur_sel = m_ctlSearchTabs.GetCurSel();
	if( -1 == cur_sel ) return;
d1022 7
a1028 1
	TCITEM item;
d1033 1
d1067 1
d1075 1
d1094 2
a1095 1
	while (_tcsnextc(prefix)) {
d1110 5
a1114 2
	CString resToken;
	int curPos=0;
d1116 1
a1116 2
	resToken= strlink.Tokenize(_T("\t\n\r"),curPos);
	while (resToken != "")
d1118 6
a1124 3
		if (resToken.Right(1)!="/") resToken+="/";
		try {
			CED2KLink* pLink = CED2KLink::CreateLinkFromUrl(resToken.Trim());
d1126 2
a1127 1
			if ( pLink->GetKind() == CED2KLink::kFile) {
d1129 3
a1131 1
			} else {
d1133 1
a1133 1
				throw CString("bad link");
d1136 3
a1138 1
		} catch(CString error){
d1140 3
a1142 1
			CString buffer;
d1146 2
a1147 1
		resToken= strlink.Tokenize(_T("\t\n\r"),curPos);
d1156 7
a1162 5
	CString clipboard = g_eMuleApp.CopyTextFromClipboard();
	const TCHAR* text = clipboard;
	CString newlink;
	CString msglinks;
	CTypedPtrList<CPtrList, CED2KLink*> links;
d1171 1
a1171 1
				if (_tcsnextc(text) == '\n')
d1176 1
a1176 1
				else if (_tcsnextc(text) == '\r')
d1186 1
a1186 1
				else if (_tcsnextc(text) == '>')
d1196 1
a1196 1
				if ((_tcsnextc(text) == '/') && ((nextchar != _T('|')) && (nextchar != _T('/'))))
d1200 1
a1200 1
				if ( (_tcsnextc(text) == '|') && (prevchar != '/')
d1212 1
a1212 1
						_ASSERT( pLink !=0 );
d1223 3
a1225 1
					catch(...) {}
d1227 1
a1227 1
					newlink = "";
d1242 2
a1243 1
		CString msg;
d1245 3
a1247 1
		int retvalue = MessageBox(msg, NULL, MB_YESNO);
d1265 1
d1273 1
d1278 1
d1285 2
a1286 1
	const LRESULT ret = DefWindowProc( WM_SHOWWINDOW, wparam, lparam );
d1295 2
a1296 1
	SearchData sd;
d1305 2
a1306 1
	SearchData sd;
d1315 1
a1315 1
	int		oldsel=m_ctrlCatTabs.GetCurSel();
a1317 1

d1322 1
a1322 1
	if (oldsel >= m_ctrlCatTabs.GetItemCount() || oldsel==-1)
d1326 2
a1327 2
	int flag;
	flag=(m_ctrlCatTabs.GetItemCount()>1) ? SW_SHOW:SW_HIDE;
d1339 28
a1366 1
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////@


1.87
log
@Changed uint32 to unsigned long from unsigned int and made necessary code changes. Got rid of _unsigned_ types int8,int16,int32,int64. Eliminated uint8 to avoid confusion. Use "byte".
@
text
@d551 4
a554 4
	str[0]=GetResString(IDS_PW_SERVER);
	str[1]=GetResString(IDS_SW_GLOBAL);
	str[2]="FileDonkey";
	str[3]="Jigle";
a575 1
	//Stypebox.AddString(GetResString(IDS_SEARCH_USER));
d592 1
a592 1
							 int iAvailability, CString strExtension, bool bDoGlobal)
d608 1
a608 1
			strType="Audio";
d610 1
a610 1
			strType="Video";
d613 1
a613 1
			strType="Pro";
d615 1
a615 1
			strType="Image";
d617 1
a617 1
			strType="Doc";
d619 1
a619 1
			strType="";
d625 2
a626 2
		if (strExtension.GetLength()>0 && strExtension.GetAt(0)!='.')
			strExtension=_T(".")+strExtension;
d628 1
a628 1
		if (strSearch.GetLength()==0 && strExtension.GetLength()==0)
d633 1
a633 1
		int		iNumParameters=0; //must be written iNumParameters-1 parameter headers
d663 3
a665 1
		if (iAvailability>0)
d761 1
d764 2
a765 2
		sd.sNotSearch = "";
		sd.bDocumentSearch = (GetResString(IDS_SEARCH_DOC)==strTypeText);
a774 2
	bool		bIsThisGlobal = (methodbox.GetCurSel() == 1);

d784 3
a786 1
		m_nSearchID++;
d788 1
a788 5
		CString			strTypeText;
		CString			strSearch;

	//
	//	Get the settings from the UI
d795 1
a795 1
			strTypeText.Delete(idx,strTypeText.GetLength()-idx);
a796 14
		GetDlgItem(IDC_SEARCHNAME)->GetWindowText(strSearch);
		g_eMuleApp.m_pSearchList->NewSearch(&m_ctlSearchList,strTypeText,m_nSearchID);
		GetDlgItem(IDC_STARTS)->EnableWindow(false);
		GetDlgItem(IDC_CANCELS)->EnableWindow(true);

		m_bCancelled = false;

		CMemFile	   *packetStream = new CMemFile(100);
		uint16			uSize;
		TCHAR		   *ptstrFormat;
		unsigned long	dwAvailability;

		CString			strSizeMin,strSizeMax,strAvailability,strType;
		CString			strExtension = "";
d809 4
a812 15
	//	eklmn: Don't use UNICODE here
		if (GetResString(IDS_SEARCH_AUDIO) == strTypeText)
			strType = "Audio";
		else if (GetResString(IDS_SEARCH_VIDEO) == strTypeText)
			strType = "Video";
	//	archives, CD images and programs treated the same by servers
		else if (GetResString(IDS_SEARCH_ARC) == strTypeText || GetResString(IDS_SEARCH_PRG) == strTypeText || GetResString(IDS_SEARCH_CDIMG) == strTypeText)
			strType = "Pro";
		else if (GetResString(IDS_SEARCH_PICS)==strTypeText)
			strType = "Image";
		else if (GetResString(IDS_SEARCH_DOC)==strTypeText)
			strType = "Doc";
		else
			strType = "";

a813 53
		dwAvailability = _tstol(strAvailability.GetString());

	//	If the search string isn't specified and the extension is unspecified...
	//	KuSh - why testing strExtension since we can't specified file extension anywhere ?
	//	       (strExtension.GetLength() == 0) always return true ...
		if (strSearch.GetLength() == 0 && strExtension.GetLength() == 0)
		{
			delete packetStream;
			return;
		}

		int				iNumParameters = 0; //	Must be written iNumParameters-1 parameter headers

	//
	//	If it's not a user search...
		if (GetResString(IDS_SEARCH_USER) != strTypeText)
		{
		//	If search text is specified...
			if (strSearch.GetLength() > 0)
			{
				iNumParameters++;
				if (iNumParameters > 1)
					packetStream->Write(&SEARCH_OPPARAM_AND,2);
			}
		//	If search type is specified...
			if (strType.GetLength() > 0)
			{
				iNumParameters++;
				if (iNumParameters > 1)
					packetStream->Write(&SEARCH_OPPARAM_AND,2);
			}
		//	If a minimum file size is specified...
			if (dwMinSize > 0)
			{
				iNumParameters++;
				if (iNumParameters>1)
					packetStream->Write(&SEARCH_OPPARAM_AND,2);
			}
		//	If a maximum file size is specified...
			if (dwMaxSize > 0)
			{
				iNumParameters++;
				if (iNumParameters>1)
					packetStream->Write(&SEARCH_OPPARAM_AND,2);
			}

		//	If availability is specified...
			if (dwAvailability > 0)
			{
				iNumParameters++;
				if (iNumParameters > 1)
					packetStream->Write(&SEARCH_OPPARAM_AND,2);
			}
d815 1
a815 11
		//	If an extension is specified...
			if (strExtension.GetLength() > 0)
			{
				iNumParameters++;
				if (iNumParameters > 1)
					packetStream->Write(&SEARCH_OPPARAM_AND,2);
			}
		}
	//
	//	Body
	//
d817 1
a817 2
	//	If search text is specified...
		if (!strSearch.IsEmpty())
d819 1
a819 5
			packetStream->Write(&SEARCH_PARAMTYPE_STRING,1);	// <paramtype 1>
			uSize = strSearch.GetLength();
			packetStream->Write(&uSize,2);						// <textlen 2>
			ptstrFormat = strSearch.GetBuffer();
			packetStream->Write(ptstrFormat,uSize);				// (<textchar 1>)*textlen
d821 1
a821 2
	//	If this isn't a user search...
		if (GetResString(IDS_SEARCH_USER) != strTypeText)
d823 1
a823 41
		//	If a search type is specified...
			if (!strType.IsEmpty())
			{
				packetStream->Write(&SEARCH_PARAMTYPE_TYPE,1);	// <paramtype 1>
				uSize=strType.GetLength();
				packetStream->Write(&uSize,2);					// <typelen 2>
				ptstrFormat=strType.GetBuffer();
				packetStream->Write(ptstrFormat,uSize);			// (<typechar 1>)*typelen
				packetStream->Write(&SEARCH_PARAMID_TYPE,3);	// <paramid 3>
			}
		//	If a min file size is specified...
			if (dwMinSize > 0)
			{
				packetStream->Write(&SEARCH_PARAMTYPE_NUMERIC,1);	//	<paramtype 1>
				packetStream->Write(&dwMinSize,4);					//	<minsize 4>
				packetStream->Write(&SEARCH_PARAMID_MINSIZE,4);		//	<paramid 4>
			}
		//	If a max file size is specified...
			if (dwMaxSize > 0)
			{
				packetStream->Write(&SEARCH_PARAMTYPE_NUMERIC,1);	//	<paramtype 1>
				packetStream->Write(&dwMaxSize,4);					//	<maxsize 4>
				packetStream->Write(&SEARCH_PARAMID_MAXSIZE,4);		//	<paramid 4>
			}
		//	If an availability is specified...
			if (dwAvailability > 0)
			{
				packetStream->Write(&SEARCH_PARAMTYPE_NUMERIC,1);	//	<paramtype 1>
				packetStream->Write(&dwAvailability,4);				//	<availability 4>
				packetStream->Write(&SEARCH_PARAMID_AVAILABILITY,4);//	<paramid 4>
			}
		//	If a file extension is specified...
			if (strExtension.GetLength() > 0)
			{
				packetStream->Write(&SEARCH_PARAMTYPE_STRING,1);	//	<paramtype 1>
				uSize = strExtension.GetLength();
				packetStream->Write(&uSize,2);						//	<extlen 2>
				ptstrFormat=strExtension.GetBuffer();
				packetStream->Write(ptstrFormat,uSize);				//	(<extchar 1>)*extlen
				packetStream->Write(&SEARCH_PARAMID_EXTENSION,3);	//	<paramid 3>		// 3??
			}
d826 2
a827 1
		Packet	   *pPacket = new Packet(packetStream);
d829 4
a832 3
		if (pPacket != NULL)
		{
			pPacket->m_eOpcode =(GetResString(IDS_SEARCH_USER) == strTypeText) ? OP_SEARCH_USER : OP_SEARCHREQUEST;
d834 3
a836 6
			delete packetStream;

			g_eMuleApp.m_pUploadQueue->AddUpDataOverheadServer(pPacket->m_dwSize);
#ifdef OLD_SOCKETS_ENABLED
			g_eMuleApp.m_pServerConnect->SendPacket(pPacket,false);
#endif OLD_SOCKETS_ENABLED
a837 32
			if (bIsThisGlobal)
			{
				if (g_eMuleApp.m_pGlobPrefs->Score())
				{
					g_eMuleApp.m_pServerList->ResetSearchServerPos();
				}
				safe_delete(m_pGlobalSearchPacket);
				m_pGlobalSearchPacket = pPacket;
				m_pGlobalSearchPacket->m_eOpcode = OP_GLOBSEARCHREQ;
				m_uServerCount = 0;
				m_ctlGlobalSearchProgress.SetRange32(0,g_eMuleApp.m_pServerList->GetServerCount()-1);
				m_bGlobalSearch = true;
			}
			else
			{
				m_bGlobalSearch = false;
				delete pPacket;
			}

			CString			strSearchExclusion;

			GetDlgItem(IDC_SEARCHNAME_NOT)->GetWindowText(strSearchExclusion);
			strSearchExclusion.MakeLower();

			SearchData		sd;

			sd.sNotSearch = strSearchExclusion;
			sd.bDocumentSearch = (GetResString(IDS_SEARCH_DOC)==strTypeText);
			m_SearchMap.SetAt(m_nSearchID, sd);
			CreateNewTab(strSearch,m_nSearchID);
		}
	}
d919 2
a920 1
LRESULT CSearchDlg::OnCloseTab(WPARAM wparam, LPARAM lparam) {
d985 2
a986 1
void CSearchDlg::AddEd2kLinksToDownload(CString strlink,EnumCategories eCatID){
d1139 2
a1140 1
LRESULT CSearchDlg::OnShowWindow(WPARAM wparam, LPARAM lparam) {
@


1.86
log
@Added missing category selection to Dowload All ed2k links from clipboard
@
text
@d233 1
a233 1
				uint8			iCatIndex = m_ctrlCatTabs.GetCurSel();
d508 1
a508 1
			uint8				iCatIndex = m_ctrlCatTabs.GetCurSel();
d1276 1
a1276 1
			uint8				iCatIndex = m_ctrlCatTabs.GetCurSel();
@


1.85
log
@few changes and formatting + corrected a previous change that is not working
@
text
@d1276 3
d1281 1
a1281 1
				g_eMuleApp.m_pDownloadQueue->AddFileLinkToDownload(links.GetHead()->GetFileLink());
@


1.84
log
@trim spaces from manual pasted ed2k link to avoid invalid link message
@
text
@d55 1
a55 1
	safe_delete(m_pGlobalSearchPacket);		
d61 1
a61 1
	
d77 1
a77 1
	m_ctrlDirectDlFrm.Init(IDI_DIRECTDOWNLOAD, &g_eMuleApp.m_pdlgEmule->m_themeHelper);	
d196 1
a196 1
			GetDlgItem(IDC_EDITSEARCHMAX)->SetWindowText(_T(""));	
d210 3
a212 1
	if (!GetDlgItem(IDC_STARTS)->IsWindowEnabled()) return; // EC 10.07.03
d217 2
a218 1
		CString strlink;
d221 3
a223 3
		if (strlink.Right(1)!=_T("/")) 
		{	
			strlink+=_T("/");
d226 1
a226 1
		try 
d228 4
a231 3
			CED2KLink* pLink = CED2KLink::CreateLinkFromUrl(strlink);
			_ASSERT( pLink !=0 );
			if ( pLink->GetKind() == CED2KLink::kFile)
d233 3
a235 2
				uint8 iCatIndex = m_ctrlCatTabs.GetCurSel();
				EnumCategories eCatID = (iCatIndex < 1 || iCatIndex > CCat::GetNumUserCats()) ? CAT_NONE : CCat::GetCatIDByUserIndex(iCatIndex);
d237 2
a238 2
			} 
			else 
d244 2
a245 2
		} 
		catch(CString &error) 
d248 2
a249 1
			CString buffer;
d259 2
a260 1
			CString strSearch;
a269 1

d273 1
a273 1
			return;
d275 1
a275 1
			return;
d307 1
a307 1
			
d345 2
a346 1
	if (!m_bCancelled){	
d370 1
a370 1
BOOL CSearchDlg::PreTranslateMessage(MSG* pMsg) 
d438 1
a438 1
			tosearch=_T("Doc");		
d457 1
a457 1
		query += tosearch +_T("&v=0&d=1&a=0&l=10");		//Cax2 might want to change to l=25 for more results per page... 
d501 5
a505 5
	int index = -1; 
	POSITION pos = m_ctlSearchList.GetFirstSelectedItemPosition(); 
	while(pos != NULL) 
	{ 
		index = m_ctlSearchList.GetNextSelectedItem(pos); 
d516 1
a516 1
	} 
d580 1
a580 1
	
d592 1
a592 1
void CSearchDlg::DoNewSearch(CString strSearch, CString strTypeText, unsigned long dwMinSize, unsigned long dwMaxSize, 
d608 3
a610 3
		if (GetResString(IDS_SEARCH_AUDIO)==strTypeText) 
			strType="Audio"; 
		else if (GetResString(IDS_SEARCH_VIDEO)==strTypeText) 
d613 1
a613 1
		else if (GetResString(IDS_SEARCH_ARC) == strTypeText || GetResString(IDS_SEARCH_PRG)==strTypeText || GetResString(IDS_SEARCH_CDIMG) == strTypeText) 
d615 1
a615 1
		else if (GetResString(IDS_SEARCH_PICS)==strTypeText) 
d617 1
a617 1
		else if (GetResString(IDS_SEARCH_DOC)==strTypeText) 
d622 1
a622 1
		CMemFile	packetStream(100); 
d629 1
a629 1
		if (strSearch.GetLength()==0 && strExtension.GetLength()==0) 
d649 1
a649 1
	  
d656 1
a656 1
        
d663 1
a663 1
        
d670 1
a670 1
        
d682 1
a682 1
			uSize = strSearch.GetLength(); 
d684 1
a684 1
			packetStream.Write(strSearch.GetBuffer() ,uSize); //write the searched string 
d690 1
a690 1
			uSize=strType.GetLength(); 
d692 1
a692 1
			ptstrFormat=strType.GetBuffer(); 
d721 1
a721 1
			uSize=strExtension.GetLength(); 
d723 1
a723 1
			ptstrFormat=strExtension.GetBuffer(); 
d732 1
a732 1
		
d786 2
a787 2
		CString		strTypeText;
		CString		strSearch;
d793 1
a793 1
		int		idx = strTypeText.Find(_T(" (."));
d803 1
a803 1
		
d806 1
a806 1
		CMemFile		*packetStream = new CMemFile(100); 
d808 1
a808 1
		TCHAR			*ptstrFormat;
d811 2
a812 1
		CString		strSizeMin,strSizeMax,strExtension,strAvailability,strType;
d817 3
a819 2
		unsigned long		dwMaxSize = _tstol(strSizeMin.GetString()) * 0x100000; 
		unsigned long		dwMinSize = _tstol(strSizeMin.GetString()) * 0x100000;
d826 4
a829 4
		if (GetResString(IDS_SEARCH_AUDIO) == strTypeText) 
			strType="Audio";
		else if (GetResString(IDS_SEARCH_VIDEO) == strTypeText) 
			strType="Video";
d831 6
a836 6
		else if (GetResString(IDS_SEARCH_ARC) == strTypeText || GetResString(IDS_SEARCH_PRG) == strTypeText || GetResString(IDS_SEARCH_CDIMG) == strTypeText) 
			strType="Pro";
		else if (GetResString(IDS_SEARCH_PICS)==strTypeText) 
			strType="Image";
		else if (GetResString(IDS_SEARCH_DOC)==strTypeText) 
			strType="Doc";
d838 1
a838 1
			strType="";
d840 1
a840 1
		GetDlgItem(IDC_EDITSEARCHAVAILABILITY)->GetWindowText(strAvailability); 
d843 4
a846 2
	//	If the search string isn't specified or the type is unspecified...
		if (strSearch.GetLength() == 0 && strExtension.GetLength() == 0) 
d852 1
a852 1
		int		iNumParameters = 0; //	Must be written iNumParameters-1 parameter headers
d886 1
a886 1
	        
d894 1
a894 1
	        
d911 1
a911 1
			uSize = strSearch.GetLength(); 
d913 1
a913 1
			ptstrFormat = strSearch.GetBuffer(); 
d923 1
a923 1
				uSize=strType.GetLength(); 
d925 1
a925 1
				ptstrFormat=strType.GetBuffer(); 
d954 1
a954 1
				uSize = strExtension.GetLength(); 
d956 1
a956 1
				ptstrFormat=strExtension.GetBuffer(); 
d962 1
a962 1
		Packet		*pPacket = new Packet(packetStream);
d1108 3
a1110 3
	GetDlgItem(IDC_STARTS)->EnableWindow(true); 
	GetDlgItem(IDC_CANCELS)->EnableWindow(false);	
	GetDlgItem(IDC_CLEARALL)->EnableWindow(true); 
d1117 3
a1119 3
	GetDlgItem(IDC_EDITSEARCHAVAILABILITY)->SetWindowText(_T(""));	
	GetDlgItem(IDC_EDITSEARCHMIN)->SetWindowText(_T(""));	
	GetDlgItem(IDC_EDITSEARCHMAX)->SetWindowText(_T(""));	
d1162 1
a1162 1
		
d1194 4
a1197 2
	while (_tcsnextc(text)) {
		if (isprefix(_T("ed2k://"), text)) {
d1202 2
a1203 1
				if (_tcsnextc(text) == '\n') {
d1206 3
a1208 1
				} else if (_tcsnextc(text) == '\r') {
d1211 3
a1213 1
				} else if (isprefix(_T("> "), text)) {
d1216 3
a1218 1
				} else if (_tcsnextc(text) == '>') {
d1231 2
a1232 2
				if ((_tcsnextc(text) == '|') && (prevchar != '/') &&
					(_tcschr(_T(" \""), nextchar) || _tcschr(_T("\r\n"), nextchar)))
d1238 4
a1241 2
				if (bLinkEnded) {
					try {
d1244 2
a1245 1
						if ( pLink->GetKind() == CED2KLink::kFile) {
d1248 3
a1250 1
						} else {
d1265 2
a1266 1
	if (links.IsEmpty()) {
d1268 3
a1270 1
	} else {
d1274 4
a1277 2
		if (retvalue == IDYES) {
			while (!links.IsEmpty()) {
d1281 3
a1283 1
		} else 
d1286 1
d1345 1
a1345 1
	
@


1.83
log
@Formatting, comments, and name changes.
@
text
@d217 1
@


1.82
log
@Formatting, name changes and deleting spaces and tabs at end of lines
@
text
@d722 1
a722 1
		
d736 1
a736 1

@


1.81
log
@Formatting, comments, and name changes.
@
text
@d630 3
a632 3
		  iNumParameters++;
		  if (iNumParameters>1)
		      packetStream.Write(&SEARCH_OPPARAM_AND,2);
d637 3
a639 3
		  iNumParameters++;
		  if (iNumParameters>1)
		      packetStream.Write(&SEARCH_OPPARAM_AND,2);
d644 3
a646 3
		  iNumParameters++;
		  if (iNumParameters>1)
			  packetStream.Write(&SEARCH_OPPARAM_AND,2);
d651 3
a653 3
		  iNumParameters++;
		  if (iNumParameters>1)
			  packetStream.Write(&SEARCH_OPPARAM_AND,2);
d658 3
a660 3
		  iNumParameters++;
		  if (iNumParameters>1)
			  packetStream.Write(&SEARCH_OPPARAM_AND,2);
d665 3
a667 3
		  iNumParameters++;
		  if (iNumParameters>1)
		      packetStream.Write(&SEARCH_OPPARAM_AND,2);
d722 1
a722 1

d736 1
a736 1
		//	Get rid of any old global search packet
@


1.80
log
@Formatting, comments, and name changes.
@
text
@d47 1
a47 1
	pSearchPacket	=	NULL;
d55 1
a55 1
	safe_delete(pSearchPacket);		
d72 1
a72 1
	searchprogress.SetStep(1);
d74 1
a74 1
	globsearch = false;
d142 1
a142 1
	DDX_Control(pDX, IDC_PROGRESS1, searchprogress);
d211 1
a211 1
	searchprogress.SetPos(0);
d282 2
a283 1
		CServer* pNextServer = g_eMuleApp.m_pServerList->GetNextSearchServer();
d287 2
a288 1
		if (pNextServer && g_eMuleApp.m_pServerList->GetServerCount() - 1 != m_uServerCount)
d291 1
d293 3
a295 1
				pSearchPacket->m_eOpcode = OP_GLOBSEARCHREQ2;
d297 3
a299 1
				pSearchPacket->m_eOpcode = OP_GLOBSEARCHREQ;
d301 2
a302 2
			g_eMuleApp.m_pServerConnect->SendUDPPacket(pSearchPacket, pNextServer, false);
			searchprogress.StepIt();
d305 1
d307 1
d319 1
a319 1
	globsearch = false;
d322 1
a322 1
		safe_delete(pSearchPacket);
d325 1
a325 1
		searchprogress.SetPos(0);
d339 1
a339 1
		if (!globsearch)
d584 2
a585 2
void CSearchDlg::DoNewSearch(CString searchString, CString typeText, unsigned long min, unsigned long max, 
		int availability, CString extension, bool doGlobal)
d594 1
a594 1
		g_eMuleApp.m_pSearchList->NewSearch(&m_ctlSearchList,typeText,m_nSearchID);
d597 14
a610 13
		CString type;
		//eklmn: don't use UNICODE here
		if (GetResString(IDS_SEARCH_AUDIO)==typeText) 
			type="Audio"; 
		else if (GetResString(IDS_SEARCH_VIDEO)==typeText) 
			type="Video";
		//archives, CD images and programs treated the same by servers
		else if (GetResString(IDS_SEARCH_ARC) == typeText || GetResString(IDS_SEARCH_PRG)==typeText || GetResString(IDS_SEARCH_CDIMG) == typeText) 
			type="Pro";
		else if (GetResString(IDS_SEARCH_PICS)==typeText) 
			type="Image";
		else if (GetResString(IDS_SEARCH_DOC)==typeText) 
			type="Doc";
d612 1
a612 1
			type="";
d614 3
a616 3
		CMemFile data(100); 
		uint16 nSize;
		TCHAR* formatC;
d618 2
a619 1
		if (extension.GetLength()>0 && extension.GetAt(0)!='.' ) extension=_T(".")+extension;
d621 1
a621 1
		if ( searchString.GetLength()==0 && extension.GetLength()==0) 
d626 1
a626 1
		int parametercount=0; //must be written parametercount-1 parmeter headers
d628 1
a628 1
		if ( searchString.GetLength()>0)
d630 3
a632 3
		  parametercount++;
		  if (parametercount>1)
		      data.Write(&andParameter,2);
d635 1
a635 1
		if (type.GetLength()>0)
d637 3
a639 3
		  parametercount++;
		  if (parametercount>1)
		      data.Write(&andParameter,2);
d642 1
a642 1
		if (min>0)
d644 3
a646 3
		  parametercount++;
		  if (parametercount>1)
			  data.Write(&andParameter,2);
d649 1
a649 1
		if (max>0)
d651 3
a653 3
		  parametercount++;
		  if (parametercount>1)
			  data.Write(&andParameter,2);
d656 1
a656 1
		if (availability>0)
d658 3
a660 3
		  parametercount++;
		  if (parametercount>1)
			  data.Write(&andParameter,2);
d663 1
a663 1
		if (extension.GetLength()>0)
d665 3
a667 3
		  parametercount++;
		  if (parametercount>1)
		      data.Write(&andParameter,2);
d671 1
a671 1
		if (searchString.GetLength()>0) //search a string
d673 4
a676 4
			data.Write(&stringParameter,1); //write the parameter type
			nSize = searchString.GetLength(); 
			data.Write(&nSize,2);  // write parameter length
			data.Write(searchString.GetBuffer() ,nSize); //write the searched string 
d679 1
a679 1
		if (type.GetLength()>0)
d681 6
a686 6
			data.Write(&typeParameter,1); //write the parameter type
			nSize=type.GetLength(); 
			data.Write(&nSize,2);   //write the length
			formatC=type.GetBuffer(); 
			data.Write(formatC,nSize); //write parameter
			data.Write(&typeNemonic,3); //nemonic for this kind of parameter (only 3 bytes!!)
d689 1
a689 1
		if (min>0)
d691 3
a693 3
			data.Write(&numericParameter,1); //write the parameter type
			data.Write(&min,4);		   //write the parameter
			data.Write(&minNemonic,4);    //nemonic for this kind of parameter
d696 1
a696 1
		if (max>0)
d698 3
a700 3
			data.Write(&numericParameter,1); //write the parameter type
			data.Write(&max,4);		   //write the parameter
			data.Write(&maxNemonic,4);    //nemonic for this kind of parameter
d703 1
a703 1
		if (availability>0)
d705 3
a707 3
			data.Write(&numericParameter,1); //write the parameter type
			data.Write(&availability,4);    //write the parameter
			data.Write(&availabilityNemonic,4);  //nemonic for this kind of parameter
d710 1
a710 1
		if (extension.GetLength()>0)
d712 6
a717 6
			data.Write(&stringParameter,1); //write the parameter type
			nSize=extension.GetLength(); 
			data.Write(&nSize,2);   //write the length
			formatC=extension.GetBuffer(); 
			data.Write(formatC,nSize); //write parameter
			data.Write(&extensionNemonic,3); //nemonic for this kind of parameter (only 3 bytes!!)
d721 3
a723 2
		Packet* packet = new Packet(&data);
		packet->m_eOpcode = OP_SEARCHREQUEST;
d725 1
a725 1
		g_eMuleApp.m_pUploadQueue->AddUpDataOverheadServer(packet->m_dwSize);
d727 1
a727 1
		g_eMuleApp.m_pServerConnect->SendPacket(packet,false);
d730 4
a733 2
		if (doGlobal){
			if( g_eMuleApp.m_pGlobPrefs->Score() ){
d736 7
a742 4

			if (globsearch) safe_delete(pSearchPacket);
			pSearchPacket = packet;
			pSearchPacket->m_eOpcode = OP_GLOBSEARCHREQ;
d744 2
a745 2
			searchprogress.SetRange32(0,g_eMuleApp.m_pServerList->GetServerCount()-1);
			globsearch = true;
d747 4
a750 3
		else{
			globsearch = false;
			delete packet;
d752 2
a753 1
		SearchData sd;
d755 1
a755 1
		sd.bDocumentSearch = (GetResString(IDS_SEARCH_DOC)==typeText);
d757 1
a757 1
		CreateNewTab(searchString,m_nSearchID);
d800 1
a800 1
		TCHAR			*formatC;
d808 2
a809 2
		unsigned long		max = _tstol(strSizeMin.GetString()) * 0x100000; 
		unsigned long		min = _tstol(strSizeMin.GetString()) * 0x100000;
d811 3
a813 3
	//	max file size // netwolf: if no max size is specified or max<min, dont send max.size limit (at lugdunums request)
		if (max < min)
			max = 0;
d820 1
a820 1
		//archives, CD images and programs treated the same by servers
d831 1
a831 1
		dwAvailability=_tstol(strAvailability.GetString());
d834 1
a834 1
		if (strSearch.GetLength()==0 && strExtension.GetLength()==0) 
d840 1
a840 1
		int		iNumParameters=0; //must be written iNumParameters-1 parameter headers
d842 2
a843 2
	//	Cax2 - get users: no other parameters allowed
	//	Get users TODO - still need to display the results sent by the server!!!
d846 2
a847 1
			if ( strSearch.GetLength()>0)
d850 2
a851 2
				if (iNumParameters>1)
					packetStream->Write(&andParameter,2);
d853 2
a854 2

			if (strType.GetLength()>0)
d857 2
a858 2
				if (iNumParameters>1)
					packetStream->Write(&andParameter,2);
d860 2
a861 2
		  
			if (min>0)
d865 1
a865 1
					packetStream->Write(&andParameter,2);
d867 2
a868 2
	        
			if (max>0)
d872 1
a872 1
					packetStream->Write(&andParameter,2);
d875 2
a876 1
			if (dwAvailability>0)
d879 2
a880 2
				if (iNumParameters>1)
					packetStream->Write(&andParameter,2);
d883 2
a884 1
			if (strExtension.GetLength()>0)
d887 2
a888 2
				if (iNumParameters>1)
					packetStream->Write(&andParameter,2);
d891 3
d895 2
a896 2
		//body
		if (!strSearch.IsEmpty()) //search a string
d898 1
a898 1
			packetStream->Write(&stringParameter,1); //write the parameter strType
d900 3
a902 3
			packetStream->Write(&uSize,2);  // write parameter length
			formatC=strSearch.GetBuffer(); 
			packetStream->Write(formatC,uSize); //write the searched string 
d904 2
a905 2
		//Cax2 - get users: no other parameters allowed
		if(GetResString(IDS_SEARCH_USER)!=strTypeText)
d907 1
d910 1
a910 1
				packetStream->Write(&typeParameter,1); //write the parameter strType
d912 4
a915 4
				packetStream->Write(&uSize,2);   //write the length
				formatC=strType.GetBuffer(); 
				packetStream->Write(formatC,uSize); //write parameter
				packetStream->Write(&typeNemonic,3); //mnemonic for this kind of parameter (only 3 bytes!!)
d917 2
a918 2

			if (min>0)
d920 3
a922 3
				packetStream->Write(&numericParameter,1); //write the parameter strType
				packetStream->Write(&min,4);		   //write the parameter
				packetStream->Write(&minNemonic,4);    //nemonic for this kind of parameter
d924 2
a925 2

			if (max>0)
d927 3
a929 3
				packetStream->Write(&numericParameter,1); //write the parameter strType
				packetStream->Write(&max,4);		   //write the parameter
				packetStream->Write(&maxNemonic,4);    //nemonic for this kind of parameter
d931 2
a932 2

			if (dwAvailability>0)
d934 3
a936 3
				packetStream->Write(&numericParameter,1); //write the parameter strType
				packetStream->Write(&dwAvailability,4);    //write the parameter
				packetStream->Write(&availabilityNemonic,4);  //nemonic for this kind of parameter
d938 2
a939 2

			if (strExtension.GetLength()>0)
d941 6
a946 6
				packetStream->Write(&stringParameter,1); //write the parameter strType
				uSize=strExtension.GetLength(); 
				packetStream->Write(&uSize,2);   //write the length
				formatC=strExtension.GetBuffer(); 
				packetStream->Write(formatC,uSize); //write parameter
				packetStream->Write(&extensionNemonic,3); //nemonic for this kind of parameter (only 3 bytes!!)
d954 2
a955 2
			//Cax2 - get users
			pPacket->m_eOpcode =(GetResString(IDS_SEARCH_USER)==strTypeText)?OP_SEARCH_USER:OP_SEARCHREQUEST;
d957 1
d961 1
a961 1
#endif //OLD_SOCKETS_ENABLED
d969 3
a971 3
				safe_delete(pSearchPacket);
				pSearchPacket = pPacket;
				pSearchPacket->m_eOpcode = OP_GLOBSEARCHREQ;
d973 2
a974 2
				searchprogress.SetRange32(0,g_eMuleApp.m_pServerList->GetServerCount()-1);
				globsearch = true;
d978 1
a978 1
				globsearch = false;
d982 1
a982 1
			CString			searchNotString;
d984 2
a985 2
			GetDlgItem(IDC_SEARCHNAME_NOT)->GetWindowText(searchNotString);
			searchNotString.MakeLower();
d989 1
a989 1
			sd.sNotSearch = searchNotString;
@


1.79
log
@removed 2 GB search limitation
set focus to name after reset/clear all
@
text
@d286 1
a286 1
		if (pNextServer && g_eMuleApp.m_pServerList->GetServerCount() - 1 != servercount)
d288 1
a288 1
			servercount++;
d309 1
a309 1
	canceled = true;
d327 1
a327 1
	if (!canceled && count > MAX_RESULTS)
d329 1
a329 1
	if (!canceled){	
d344 1
a344 1
	if (!canceled && count > MAX_RESULTS)
d586 1
a586 1
		canceled = false;
d726 1
a726 1
			servercount = 0;
d745 3
a747 1
	bool isThisGlobal=(methodbox.GetCurSel()==1);
d749 1
d751 1
d753 1
d758 16
a773 9
		CString typeText;
		CString searchString;
		GetDlgItem(IDC_TypeSearch)->GetWindowText(typeText);
//		AddDebugLogLine(false, _T("--->Selected Item %u"),Stypebox.GetCurSel());
		int idx=typeText.Find(_T(" (."));	//Cax2 bugfix: remove all examples from typeText
		if (idx>0)
			typeText.Delete(idx,typeText.GetLength()-idx);
		GetDlgItem(IDC_SEARCHNAME)->GetWindowText(searchString);
		g_eMuleApp.m_pSearchList->NewSearch(&m_ctlSearchList,typeText,m_nSearchID);
d777 1
a777 13
		canceled = false;

		CMemFile* data = new CMemFile(100); 
		uint16 nSize;
		TCHAR* formatC;
		unsigned long availability;

		CString sizeMin,sizeMax,extension,availabilitystr,type;
		GetDlgItem(IDC_EDITSEARCHMIN)->GetWindowText(sizeMin);
		GetDlgItem(IDC_EDITSEARCHMAX)->GetWindowText(sizeMax);
		unsigned long max=_tstol(sizeMax.GetString())*1048576; 
		unsigned long min=_tstol(sizeMin.GetString())*1048576; 
		if (max<min) max=0;//max file size // netwolf: if no max size is specified or max<min, dont send max.size limit (at lugdunums request)
d779 22
a800 5
		//eklmn: don't use UNICODE here
		if (GetResString(IDS_SEARCH_AUDIO)==typeText) 
			type="Audio";
		else if (GetResString(IDS_SEARCH_VIDEO)==typeText) 
			type="Video";
d802 6
a807 6
		else if (GetResString(IDS_SEARCH_ARC) == typeText || GetResString(IDS_SEARCH_PRG)==typeText || GetResString(IDS_SEARCH_CDIMG) == typeText) 
			type="Pro";
		else if (GetResString(IDS_SEARCH_PICS)==typeText) 
			type="Image";
		else if (GetResString(IDS_SEARCH_DOC)==typeText) 
			type="Doc";
d809 1
a809 1
			type="";
d811 2
a812 2
		GetDlgItem(IDC_EDITSEARCHAVAILABILITY)->GetWindowText(availabilitystr); 
		availability=_tstol(availabilitystr.GetString());
d814 2
a815 1
		if ( searchString.GetLength()==0 && extension.GetLength()==0) 
d817 1
a817 1
			delete data;
d821 1
a821 1
		int parametercount=0; //must be written parametercount-1 parmeter headers
d823 3
a825 3
		//Cax2 - get users: no other parameters allowed
		//Get users TODO - still need to display the results sent by the server!!!
		if(GetResString(IDS_SEARCH_USER)!=typeText)
d827 1
a827 1
			if ( searchString.GetLength()>0)
d829 3
a831 3
				parametercount++;
				if (parametercount>1)
					data->Write(&andParameter,2);
d834 1
a834 1
			if (type.GetLength()>0)
d836 3
a838 3
				parametercount++;
				if (parametercount>1)
					data->Write(&andParameter,2);
d843 3
a845 3
				parametercount++;
				if (parametercount>1)
					data->Write(&andParameter,2);
d850 3
a852 3
				parametercount++;
				if (parametercount>1)
					data->Write(&andParameter,2);
d855 1
a855 1
			if (availability>0)
d857 3
a859 3
				parametercount++;
				if (parametercount>1)
					data->Write(&andParameter,2);
d862 1
a862 1
			if (extension.GetLength()>0)
d864 3
a866 3
				parametercount++;
				if (parametercount>1)
					data->Write(&andParameter,2);
d871 1
a871 1
		if (!searchString.IsEmpty()) //search a string
d873 5
a877 5
			data->Write(&stringParameter,1); //write the parameter type
			nSize = searchString.GetLength(); 
			data->Write(&nSize,2);  // write parameter length
			formatC=searchString.GetBuffer(); 
			data->Write(formatC,nSize); //write the searched string 
d880 1
a880 1
		if(GetResString(IDS_SEARCH_USER)!=typeText)
d882 1
a882 1
			if (!type.IsEmpty())
d884 6
a889 6
				data->Write(&typeParameter,1); //write the parameter type
				nSize=type.GetLength(); 
				data->Write(&nSize,2);   //write the length
				formatC=type.GetBuffer(); 
				data->Write(formatC,nSize); //write parameter
				data->Write(&typeNemonic,3); //mnemonic for this kind of parameter (only 3 bytes!!)
d894 3
a896 3
				data->Write(&numericParameter,1); //write the parameter type
				data->Write(&min,4);		   //write the parameter
				data->Write(&minNemonic,4);    //nemonic for this kind of parameter
d901 3
a903 3
				data->Write(&numericParameter,1); //write the parameter type
				data->Write(&max,4);		   //write the parameter
				data->Write(&maxNemonic,4);    //nemonic for this kind of parameter
d906 1
a906 1
			if (availability>0)
d908 3
a910 3
				data->Write(&numericParameter,1); //write the parameter type
				data->Write(&availability,4);    //write the parameter
				data->Write(&availabilityNemonic,4);  //nemonic for this kind of parameter
d913 1
a913 1
			if (extension.GetLength()>0)
d915 6
a920 6
				data->Write(&stringParameter,1); //write the parameter type
				nSize=extension.GetLength(); 
				data->Write(&nSize,2);   //write the length
				formatC=extension.GetBuffer(); 
				data->Write(formatC,nSize); //write parameter
				data->Write(&extensionNemonic,3); //nemonic for this kind of parameter (only 3 bytes!!)
d924 3
a926 2
		Packet* packet = new Packet(data);
		if ( packet )
d929 3
a931 3
			packet->m_eOpcode =(GetResString(IDS_SEARCH_USER)==typeText)?OP_SEARCH_USER:OP_SEARCHREQUEST;
			delete data;
			g_eMuleApp.m_pUploadQueue->AddUpDataOverheadServer(packet->m_dwSize);
d933 1
a933 1
			g_eMuleApp.m_pServerConnect->SendPacket(packet,false);
d936 4
a939 2
			if (isThisGlobal){
				if( g_eMuleApp.m_pGlobPrefs->Score() ){
d943 1
a943 1
				pSearchPacket = packet;
d945 1
a945 1
				servercount = 0;
d949 2
a950 1
			else{
d952 1
a952 1
				delete packet;
d954 3
a956 1
			CString searchNotString;
d959 3
a961 1
			SearchData sd;
d963 1
a963 1
			sd.bDocumentSearch = (GetResString(IDS_SEARCH_DOC)==typeText);
d965 1
a965 1
			CreateNewTab(searchString,m_nSearchID);
d1004 1
a1004 1
	if ((!canceled) && (nSearchID == m_nSearchID))
d1057 1
a1057 1
	if ((!canceled) && (nSearchID == m_nSearchID))
@


1.78
log
@fixed cumulative statistics totals for uploads and downloads and other minor changes
@
text
@d188 4
a191 4
	if (_tstol(sMin)>2047)
		GetDlgItem(IDC_EDITSEARCHMIN)->SetWindowText(_T("2047"));
	if (_tstol(sMax)>2048)
		GetDlgItem(IDC_EDITSEARCHMAX)->SetWindowText(_T("2048"));
d571 2
d1058 1
a1058 2

	//OnEnChangeSearchname(); // EC 08.07.03
@


1.77
log
@Fixed documents search
@
text
@d555 1
a558 1
	Stypebox.AddString(GetResString(IDS_SEARCH_DOC)+_T(" (.doc .txt .pdf...)"));
d598 1
a598 1
			type="";
d788 1
a788 1
			type="";
@


1.76
log
@Changed clear search history key combination to Ctrl+Del as not all keyboards have the Alt-Gr key
@
text
@d309 1
a309 1
	canceld = true;
d327 1
a327 1
	if (!canceld && count > MAX_RESULTS)
d329 1
a329 1
	if (!canceld){	
d344 1
a344 1
	if (!canceld && count > MAX_RESULTS)
d372 1
a372 1
			pMsg->hwnd == GetDlgItem(IDC_EDITSEARCHAVAIBILITY)->m_hWnd ||
d431 1
a431 1
		GetDlgItem(IDC_EDITSEARCHAVAIBILITY)->GetWindowText(tosearch);
d573 2
a574 2
void CSearchDlg::DoNewSearch(CString searchString, CString typeText,unsigned long min, unsigned long max, 
		int avaibility,CString extension, bool doGlobal)
d584 1
a584 1
		canceld = false;
d587 1
a587 1
		//eklmn: don't use an unicode here
d589 1
a589 1
			type=_T("Audio"); 
d591 1
a591 1
			type=_T("Video");
d594 1
a594 1
			type=_T("Pro");
d596 1
a596 1
			type=_T("Image");
d598 1
a598 1
			type=_T("Doc");
d600 1
a600 1
			type=_T("");
d643 1
a643 1
		if (avaibility>0)
d690 1
a690 1
		if (avaibility>0)
d693 2
a694 2
			data.Write(&avaibility,4);    //write the parameter
			data.Write(&avaibilityNemonic,4);  //nemonic for this kind of parameter
d763 1
a763 1
		canceld = false;
d768 1
a768 1
		unsigned long avaibility;
d770 1
a770 1
		CString sizeMin,sizeMax,extension,avaibilitystr,type;
d777 1
d788 1
a788 1
			type="Doc";
d792 2
a793 2
		GetDlgItem(IDC_EDITSEARCHAVAIBILITY)->GetWindowText(avaibilitystr); 
		avaibility=_tstol(avaibilitystr.GetString());
d809 3
a811 3
			parametercount++;
			if (parametercount>1)
				data->Write(&andParameter,2);
d814 1
a814 1
		if (type.GetLength()>0)
d816 3
a818 3
			parametercount++;
			if (parametercount>1)
				data->Write(&andParameter,2);
d823 3
a825 3
			parametercount++;
			if (parametercount>1)
				data->Write(&andParameter,2);
d830 3
a832 3
			parametercount++;
			if (parametercount>1)
				data->Write(&andParameter,2);
d835 1
a835 1
			if (avaibility>0)
d837 3
a839 3
			parametercount++;
			if (parametercount>1)
				data->Write(&andParameter,2);
d844 3
a846 3
			parametercount++;
			if (parametercount>1)
				data->Write(&andParameter,2);
d886 1
a886 1
			if (avaibility>0)
d889 2
a890 2
				data->Write(&avaibility,4);    //write the parameter
				data->Write(&avaibilityNemonic,4);  //nemonic for this kind of parameter
d976 1
a976 1
	if ((!canceld) && (nSearchID == m_nSearchID))
d1029 1
a1029 1
	if ((!canceld) && (nSearchID == m_nSearchID))
d1050 1
a1050 1
	GetDlgItem(IDC_EDITSEARCHAVAIBILITY)->SetWindowText(_T(""));	
@


1.75
log
@Removed line of unneeded log.
@
text
@d359 1
a359 1
	if( (pMsg->message == WM_KEYDOWN) && (pMsg->wParam == VK_DELETE) && (pMsg->hwnd == GetDlgItem(IDC_SEARCHNAME)->m_hWnd) && (GetAsyncKeyState(VK_MENU)<0) )
@


1.74
log
@Added RGB_LOG_ERROR, RGB_LOG_WARNING, RGB_LOG_NOTICE, RGB_LOG_DIMMED & RGB_LOG_SUCCESS for easier changing of log colors
@
text
@d754 1
a754 1
		AddDebugLogLine(false, _T("--->Selected Item %u"),Stypebox.GetCurSel());
@


1.73
log
@Changed to predefined colors  - thx DoubleT ;-)
@
text
@d244 1
a244 1
			AddLogLine(true, RGB_LIGHT_ORANGE + GetResString(IDS_ERR_LINKERROR), buffer);
d1111 1
a1111 1
			g_eMuleApp.m_pdlgEmule->AddLogLine(true, RGB_LIGHT_ORANGE + GetResString(IDS_ERR_LINKERROR), buffer);
@


1.72
log
@Added some colors to the logs...
@
text
@d244 1
a244 1
			AddLogLine(true, _T("<COLOR=255,102,0>") + GetResString(IDS_ERR_LINKERROR), buffer);
d754 1
a754 1
		AddDebugLogLine(false,"--->Selected Item %u",Stypebox.GetCurSel());
d1111 1
a1111 1
			g_eMuleApp.m_pdlgEmule->AddLogLine(true, _T("<COLOR=255,102,0>") + GetResString(IDS_ERR_LINKERROR), buffer);
@


1.71
log
@looks like a small copy-paste issue
@
text
@d244 1
a244 1
			AddLogLine(true, IDS_ERR_LINKERROR, buffer);
d1111 1
a1111 1
			g_eMuleApp.m_pdlgEmule->AddLogLine(true, IDS_ERR_LINKERROR, buffer);
@


1.70
log
@Fix?
@
text
@d787 1
a787 1
			type="";/
@


1.69
log
@Minor changes
@
text
@d589 1
a589 1
			type="Audio"; //type=_T("Audio"); 
d591 1
a591 1
			type="Video";//type=_T("Video");
d594 1
a594 1
			type="Pro";//type=_T("Pro");
d596 1
a596 1
			type="Image";//type=_T("Image");
d598 1
a598 1
			type="Doc";//type=_T("Doc");
d600 1
a600 1
			type="";//type=_T("");
d776 1
d778 1
a778 1
			type="Audio"; //type=_T("Audio"); 
d780 1
a780 1
			type="Video";//type=_T("Video");
d783 1
a783 1
			type="Pro";//type=_T("Pro");
d785 1
a785 1
			type="Image";//type=_T("Image");
d787 1
a787 1
			type="Doc";//type=_T("Doc");
d789 1
a789 1
			type="";//type=_T("");
@


1.68
log
@fixed search by "Any" type & some optimization
@
text
@d589 1
a589 1
			type=_T("Audio"); 
d591 1
a591 1
			type=_T("Video");
d593 2
a594 2
		else if (GetResString(IDS_SEARCH_ARC)==typeText || GetResString(IDS_SEARCH_PRG)==typeText || GetResString(IDS_SEARCH_CDIMG) == typeText) 
			type=_T("Pro");
d596 1
a596 1
			type=_T("Image");
d598 1
a598 1
			type=_T("Doc");
d600 1
a600 1
			type=_T("");
d788 1
a788 1
			//type=_T("");
@


1.67
log
@direct links are added to the selected cat
@
text
@d50 1
a50 1

d64 1
a64 1

d137 1
a137 1

d150 1
a150 2


d170 1
a170 2


d176 1
d181 1
a181 1

d206 1
a206 1

d273 1
a273 1

d305 1
a305 1

d323 1
a323 2


d341 1
d347 1
a347 1

d352 1
a352 1

d393 1
a393 1

d401 1
a401 1

d471 1
a471 1

d480 1
a480 1

d502 1
a502 2


d566 1
a566 1

d572 1
a572 1

d574 2
a575 1
		int avaibility,CString extension, bool doGlobal){
a585 11
		long typeNemonic=      0x00030001;
		long extensionNemonic= 0x00040001;
		long avaibilityNemonic=0x15000101;
		long minNemonic=       0x02000101;
		long maxNemonic=	   0x02000102;
		byte stringParameter=1;
		byte typeParameter=2;
		byte numericParameter=3;
		int andParameter=0x0000;
		//int orParameter=0x0100;

d593 1
a593 1
		else if (GetResString(IDS_SEARCH_ARC)==typeText || GetResString(IDS_SEARCH_PRG)==typeText || GetResString(IDS_SEARCH_CDIMG)) 
d739 1
a739 1

d754 1
a764 11
		long typeNemonic=  0x00030001;
		long extensionNemonic= 0x00040001;
		long avaibilityNemonic=0x15000101;
		long minNemonic=       0x02000101;
		long maxNemonic=	   0x02000102;
		byte stringParameter=1;
		byte typeParameter=2;
		byte numericParameter=3;
		int andParameter=0x0000;
		int orParameter=0x0100;

d777 1
a777 1
			type=_T("Audio"); 
d779 1
a779 1
			type=_T("Video");
d781 2
a782 2
		else if (GetResString(IDS_SEARCH_ARC)==typeText || GetResString(IDS_SEARCH_PRG)==typeText || GetResString(IDS_SEARCH_CDIMG)) 
			type=_T("Pro");
d784 1
a784 1
			type=_T("Image");
d786 1
a786 1
			type=_T("Doc");
d788 1
a788 1
			type=_T("");
d940 1
a940 1

d960 1
a960 1

d994 1
a994 1

d1004 1
a1004 1

d1018 1
a1018 1

d1035 1
a1035 1

d1044 1
a1044 1

d1058 1
a1058 1

d1062 1
a1062 1

d1069 1
a1069 1

d1117 1
a1117 1

d1201 1
a1201 1

d1211 1
a1211 1

d1220 1
a1220 1

d1229 1
a1229 1

d1238 1
a1238 1

d1259 1
a1259 1

d1266 1
@


1.66
log
@small optimization in setting of filetypes
@
text
@d218 4
a221 1
		if (strlink.Right(1)!=_T("/")) strlink+=_T("/");
d229 6
a234 2
				g_eMuleApp.m_pDownloadQueue->AddFileLinkToDownload(pLink->GetFileLink());
			} else {
d239 3
a241 1
		} catch(CString &error) {
d493 1
a493 1
			EnumCategories		eCatID = (iCatIndex < 1 || iCatIndex >= CCat::GetNumUserCats()) ? CAT_NONE : CCat::GetCatIDByUserIndex(iCatIndex);
@


1.65
log
@*** empty log message ***
@
text
@d589 15
a603 8
		CString type=_T("");
		if (GetResString(IDS_SEARCH_AUDIO)==typeText) type.Format(_T("Audio")); 
		if (GetResString(IDS_SEARCH_VIDEO)==typeText) type.Format(_T("Video")); 
		if (GetResString(IDS_SEARCH_PRG)==typeText) type.Format(_T("Pro")); 
		if (GetResString(IDS_SEARCH_PICS)==typeText) type.Format(_T("Image")); 
		if (GetResString(IDS_SEARCH_DOC)==typeText) type.Format(_T("Doc"));
		if (GetResString(IDS_SEARCH_CDIMG)==typeText) type.Format(_T("Pro")); 
		if (GetResString(IDS_SEARCH_ARC)==typeText) type.Format(_T("Pro")); 
d789 13
a801 7
		type="";
		if (GetResString(IDS_SEARCH_AUDIO)==typeText) type="Audio"; 
		if (GetResString(IDS_SEARCH_VIDEO)==typeText) type="Video";
		//archives and programs treated the same by servers
		if (GetResString(IDS_SEARCH_ARC)==typeText||GetResString(IDS_SEARCH_PRG)==typeText) type="Pro"; 
		if (GetResString(IDS_SEARCH_PICS)==typeText) type="Image"; 
		if (GetResString(IDS_SEARCH_DOC)==typeText) type="";
@


1.64
log
@removed a forgoten log line that was used for debug
@
text
@d78 1
a78 1
	oldSearchLstIcon = GetSearchLstStatic()->SetIcon(GetSearchLstIcon());]
@


1.63
log
@Fix for not showing images on Search Method
@
text
@d78 1
a78 1
	oldSearchLstIcon = GetSearchLstStatic()->SetIcon(GetSearchLstIcon());	//[TwoBottle Mod]
a128 2
	else 
		AddLogLine(true, "Bind failed!");
@


1.62
log
@added auto-complete for search text (search history) from official v0.30c
@
text
@a71 2
	Localize();

d132 2
@


1.61
log
@1) compession support within communicatio client<->server
2) extended UDP file search support
@
text
@d30 1
d38 1
d48 1
d56 5
d71 3
d125 10
a134 1
	Localize();
d166 2
a167 1
	//ON_CBN_SELCHANGE(IDC_TypeSearch, OnEnChangeSearchname) // EC 08.07.03
d244 6
d350 7
a356 1
	if((pMsg->message == WM_KEYDOWN) && (pMsg->wParam == 13))
d369 11
d381 1
d1037 1
a1037 2
// EC 08.07.03
/*
d1046 1
a1046 2
*/
// EC Ends
d1260 7
@


1.60
log
@Formatting, comments, and name changes.
Fixed a couple of sorting related bugs in SearchListCtrl.
@
text
@d45 1
a45 1
	searchpacket	=	NULL;
d51 3
a53 2
	if ( searchpacket )
		delete searchpacket;
d245 1
d249 3
a251 3
		CServer* toask = g_eMuleApp.m_pServerList->GetNextSearchServer();
		if (toask == g_eMuleApp.m_pServerList->GetServerByAddress(g_eMuleApp.m_pServerConnect->GetCurrentServer()->GetAddress(),g_eMuleApp.m_pServerConnect->GetCurrentServer()->GetPort()))
			toask = g_eMuleApp.m_pServerList->GetNextSearchServer();
d253 1
a253 1
		if (toask && g_eMuleApp.m_pServerList->GetServerCount()-1 != servercount)
d256 6
a261 1
			g_eMuleApp.m_pServerConnect->SendUDPPacket(searchpacket,toask,false);
d280 1
a280 2
		delete searchpacket;
		searchpacket	=	NULL;
d674 3
a676 3
			if (globsearch) delete searchpacket;
			searchpacket = packet;
			searchpacket->m_eOpcode = OP_GLOBSEARCHREQ;
d874 3
a876 6
				if ( searchpacket )
				{
					delete searchpacket;
				}
				searchpacket = packet;
				searchpacket->m_eOpcode = OP_GLOBSEARCHREQ;
@


1.59
log
@Formatting, comments, and name changes.
@
text
@d60 2
a61 2
	g_eMuleApp.m_pSearchList->SetOutputWnd(&searchlistctrl);
	searchlistctrl.Init(g_eMuleApp.m_pSearchList);
d70 1
a70 1
	searchselect.ShowWindow(SW_HIDE);
d82 1
a82 1
	searchselect.SetImageList(&m_pImageList);
d108 1
a108 1
	AddAnchor(searchselect.m_hWnd,TOP_LEFT,TOP_RIGHT);
d122 1
a122 1
	DDX_Control(pDX, IDC_SEARCHLIST, searchlistctrl);
d126 1
a126 1
	DDX_Control(pDX, IDC_TAB1, searchselect);
d428 1
a428 1
	POSITION pos = searchlistctrl.GetFirstSelectedItemPosition(); 
d431 1
a431 1
		index = searchlistctrl.GetNextSelectedItem(pos); 
d437 1
a437 1
			g_eMuleApp.m_pDownloadQueue->AddSearchToDownload((CSearchFile*)searchlistctrl.GetItemData(index),eCatID);
d439 2
a440 2
			//searchlistctrl.Update(index);
			searchlistctrl.RedrawItems(index,index);
d450 1
a450 1
	searchlistctrl.Localize();
d526 1
a526 1
		g_eMuleApp.m_pSearchList->NewSearch(&searchlistctrl,typeText,m_nSearchID);
d705 1
a705 1
		g_eMuleApp.m_pSearchList->NewSearch(&searchlistctrl,typeText,m_nSearchID);
d907 5
a911 5
	uint16 itemnr = searchselect.InsertItem(searchselect.GetItemCount(),&newitem);
	if (!searchselect.IsWindowVisible())
		searchselect.ShowWindow(SW_SHOW);
	searchselect.SetCurSel(itemnr);
	searchlistctrl.ShowResults(nSearchID);
d920 1
a920 1
	for( int i = 0, nItems = searchselect.GetItemCount(); nItems != i; ++i )
d922 1
a922 1
		searchselect.GetItem(i,&item);
d931 1
a931 1
	searchselect.DeleteItem(i);
d935 1
a935 1
		searchselect.SetCurSel(i);
d937 2
a938 2
		searchselect.GetItem(i,&item);
		searchlistctrl.ShowResults(item.lParam);
d942 3
a944 3
		searchlistctrl.DeleteAllItems();
		searchselect.ShowWindow(SW_HIDE);
		searchlistctrl.NoTabs();
d953 3
a955 3
	searchlistctrl.DeleteAllItems();
	searchselect.ShowWindow(SW_HIDE);
	searchselect.DeleteAllItems();
d962 1
a962 1
	const int cur_sel = searchselect.GetCurSel();
d967 2
a968 2
	searchselect.GetItem( cur_sel,&item );
	searchlistctrl.ShowResults( item.lParam );
d978 1
a978 1
	searchselect.GetItem(i,&item);
@


1.58
log
@DownloadListCtrl rewrite.
Changed Category ID types to an enumeration.
More async update work.
The usual formatting, comments, and name changes.
@
text
@a1016 1
	// TODO: Add your control notification handler code here
@


1.57
log
@Formatting, comments, and name changes.
Created distinct tag classes and typed enumerations for tags, opcodes, and protocols.
@
text
@d434 2
a435 2
			uint8		iCatIndex = m_ctrlCatTabs.GetCurSel();
			uint8		iCatID = (iCatIndex < 1 || iCatIndex >= CCat::GetNumUserCats()) ? 0 : CCat::GetCatIDByUserIndex(iCatIndex);
d437 1
a437 1
			g_eMuleApp.m_pDownloadQueue->AddSearchToDownload((CSearchFile*)searchlistctrl.GetItemData(index),iCatID);
d1042 1
a1042 1
void CSearchDlg::AddEd2kLinksToDownload(CString strlink,uint8 cat){
d1057 1
a1057 1
				g_eMuleApp.m_pDownloadQueue->AddFileLinkToDownload(pLink->GetFileLink(),cat);
@


1.56
log
@Localization fixes.
@
text
@d656 1
a656 1
		packet->opcode = OP_SEARCHREQUEST;
d658 1
a658 1
		g_eMuleApp.m_pUploadQueue->AddUpDataOverheadServer(packet->size);
d670 1
a670 1
			searchpacket->opcode = OP_GLOBSEARCHREQ;
d857 1
a857 1
			packet->opcode =(GetResString(IDS_SEARCH_USER)==typeText)?OP_SEARCH_USER:OP_SEARCHREQUEST;
d859 1
a859 1
			g_eMuleApp.m_pUploadQueue->AddUpDataOverheadServer(packet->size);
d873 1
a873 1
				searchpacket->opcode = OP_GLOBSEARCHREQ;
@


1.55
log
@Category rewrite with predefined status/media type categories.
@
text
@d505 3
@


1.54
log
@More name changes, reinstated CMuleCtrlItem class, moved srcsarevisible from CPartFile to CMuleCtrlItem (where it belongs), added "Show Full Status Icons" and "Show Gray Paused" features with corresponding preferences, modified "SmartOpen" code to make it sticky and to make it work with sources with changing states.
@
text
@d129 1
a129 1
	DDX_Control(pDX, IDC_CATTAB2, m_cattabs);
d434 4
a437 1
			g_eMuleApp.m_pDownloadQueue->AddSearchToDownload((CSearchFile*)searchlistctrl.GetItemData(index),m_cattabs.GetCurSel());
d1195 3
a1197 2
	int oldsel=m_cattabs.GetCurSel();
	m_cattabs.DeleteAllItems();
d1199 3
a1201 2
	for (int ix=0;ix<g_eMuleApp.m_pGlobPrefs->GetCatCount();ix++)
		m_cattabs.InsertItem(ix,(ix==0)?GetResString(IDS_ALL):g_eMuleApp.m_pGlobPrefs->GetCategory(ix)->title);
d1203 2
a1204 2
	if (oldsel>=m_cattabs.GetItemCount() || oldsel==-1)
		oldsel=0;
d1206 1
a1206 1
	m_cattabs.SetCurSel(oldsel);
d1208 1
a1208 1
	flag=(m_cattabs.GetItemCount()>1) ? SW_SHOW:SW_HIDE;
@


1.53
log
@Second batch of name changes
@
text
@d60 2
a61 2
	theApp.searchlist->SetOutputWnd(&searchlistctrl);
	searchlistctrl.Init(theApp.searchlist);
d66 2
a67 2
	m_ctrlSearchFrm.Init(IDI_NORMALSEARCH, &theApp.emuledlg->m_ThemeHelper);
	m_ctrlDirectDlFrm.Init(IDI_DIRECTDOWNLOAD, &theApp.emuledlg->m_ThemeHelper);	
d206 1
a206 1
				theApp.downloadqueue->AddFileLinkToDownload(pLink->GetFileLink());
d245 1
a245 1
	if (theApp.serverconnect->IsConnected())
d247 3
a249 3
		CServer* toask = theApp.serverlist->GetNextSearchServer();
		if (toask == theApp.serverlist->GetServerByAddress(theApp.serverconnect->GetCurrentServer()->GetAddress(),theApp.serverconnect->GetCurrentServer()->GetPort()))
			toask = theApp.serverlist->GetNextSearchServer();
d251 1
a251 1
		if (toask && theApp.serverlist->GetServerCount()-1 != servercount)
d254 1
a254 1
			theApp.serverconnect->SendUDPPacket(searchpacket,toask,false);
d434 1
a434 1
			theApp.downloadqueue->AddSearchToDownload((CSearchFile*)searchlistctrl.GetItemData(index),m_cattabs.GetCurSel());
d489 1
a489 1
	methodbox.SetCurSel(theApp.glob_prefs->GetMethod());
d516 1
a516 1
	if (!theApp.serverconnect->IsConnected()) return;
d520 1
a520 1
		theApp.searchlist->NewSearch(&searchlistctrl,typeText,m_nSearchID);
d652 1
a652 1
		theApp.uploadqueue->AddUpDataOverheadServer(packet->size);
d654 1
a654 1
		theApp.serverconnect->SendPacket(packet,false);
d658 2
a659 2
			if( theApp.glob_prefs->Score() ){
				theApp.serverlist->ResetSearchServerPos();
d666 1
a666 1
			searchprogress.SetRange32(0,theApp.serverlist->GetServerCount()-1);
d686 1
a686 1
	if (!theApp.serverconnect->IsConnected())
d699 1
a699 1
		theApp.searchlist->NewSearch(&searchlistctrl,typeText,m_nSearchID);
d853 1
a853 1
			theApp.uploadqueue->AddUpDataOverheadServer(packet->size);
d855 1
a855 1
			theApp.serverconnect->SendPacket(packet,false);
d859 2
a860 2
				if( theApp.glob_prefs->Score() ){
					theApp.serverlist->ResetSearchServerPos();
d869 1
a869 1
				searchprogress.SetRange32(0,theApp.serverlist->GetServerCount()-1);
d924 1
a924 1
	theApp.searchlist->RemoveResults(nSearchID);
d946 1
a946 1
	theApp.searchlist->Clear();
d1017 1
a1017 1
	theApp.glob_prefs->SetMethod(methodbox.GetCurSel());
d1051 1
a1051 1
				theApp.downloadqueue->AddFileLinkToDownload(pLink->GetFileLink(),cat);
d1061 1
a1061 1
			theApp.emuledlg->AddLogLine(true, IDS_ERR_LINKERROR, buffer);
d1072 1
a1072 1
	CString clipboard = theApp.CopyTextFromClipboard();
d1142 1
a1142 1
				theApp.downloadqueue->AddFileLinkToDownload(links.GetHead()->GetFileLink());
d1195 2
a1196 2
	for (int ix=0;ix<theApp.glob_prefs->GetCatCount();ix++)
		m_cattabs.InsertItem(ix,(ix==0)?GetResString(IDS_ALL):theApp.glob_prefs->GetCategory(ix)->title);
@


1.52
log
@Fix for clear.
@
text
@d78 3
a80 3
	m_ImageList.Create(16,16,ILC_COLOR32|ILC_MASK,0,10);
	m_ImageList.SetBkColor(CLR_NONE);
	m_ImageList.Add(LoadImgLstIcon(MAKEINTRESOURCE(IDI_NORMALSEARCH),16,16));
d82 1
a82 1
	searchselect.SetImageList(&m_ImageList);
@


1.51
log
@bugfixing my bugfix
@
text
@a327 1
			pMsg->hwnd == GetDlgItem(IDC_EDITSEARCHEXTENSION)->m_hWnd ||
a397 2
		GetDlgItem(IDC_EDITSEARCHEXTENSION)->GetWindowText(tosearch);
		query +=_T("&x=") + ToQueryString(tosearch);
a726 3
		//Keep the code, we might want to re-enable an extension box in the future...
		//GetDlgItem(IDC_EDITSEARCHEXTENSION)->GetWindowText(extension);
		//if (extension.GetLength()>0 && extension.GetAt(0)!='.' ) extension="."+extension;
a998 1
	GetDlgItem(IDC_EDITSEARCHEXTENSION)->SetWindowText(_T(""));	
@


1.50
log
@fixed webbased search and extended normal search in webserver
@
text
@a537 1
		if (GetResString(IDS_SEARCH_ANY)==typeText) type.Format(_T("Any")); 
d539 6
a544 6
		if (GetResString(IDS_SEARCH_PICS)==typeText) type.Format(_T("Pictures")); 
		if (GetResString(IDS_SEARCH_PRG)==typeText) type.Format(_T("Programs")); 
		if (GetResString(IDS_SEARCH_VIDEO)==typeText) type.Format(_T("Videos")); 
		if (GetResString(IDS_SEARCH_CDIMG)==typeText) type.Format(_T("CD-Images")); 
		if (GetResString(IDS_SEARCH_ARC)==typeText) type.Format(_T("Archives")); 
		if (GetResString(IDS_SEARCH_DOC)==typeText) type.Format(_T("Documents")); 
@


1.49
log
@Fixed adding clipboard links with | and tooltips
@
text
@d538 1
d540 6
a545 4
		if (GetResString(IDS_SEARCH_VIDEO)==typeText) type.Format(_T("Video")); 
		if (GetResString(IDS_SEARCH_PRG)==typeText) type.Format(_T("Pro")); 
		if (GetResString(IDS_SEARCH_PICS)==typeText) type.Format(_T("Image")); 
		if (GetResString(IDS_SEARCH_DOC)==typeText) type.Format(_T(""));
@


1.48
log
@Added Category missing feature in Search Window.
@
text
@d1086 2
a1087 1
			while (_tcsnextc(text)) {
a1099 1

d1104 3
a1106 1
				if ((_tcsnextc(text) == '/') && ((nextchar != _T('|')) && (nextchar != _T('/')))) // Link ends with "|/"
d1109 4
a1112 1
				if ((_tcsnextc(text) == '|') && (prevchar != '/') && _tcschr(_T(" \""), nextchar)) { // Link ends with "|"
@


1.47
log
@merging category code for webserver
@
text
@d105 2
a106 4
	AddAnchor(IDC_SDOWNLOAD,BOTTOM_RIGHT);
	AddAnchor(IDC_SMARTF_LBL,BOTTOM_LEFT);
	AddAnchor(IDC_EDITSEARCHEXTENSION,BOTTOM_LEFT);
	AddAnchor(IDC_PROGRESS1,BOTTOM_LEFT,BOTTOM_RIGHT);
d109 3
a111 1
	AddAnchor(IDC_DOWNLOAD_ALL_ED2K, BOTTOM_RIGHT); //<<-- enkeyDEV(Ottavio84) -Download all ed2ks in clipboard-
d129 1
a140 3
	//ON_EN_CHANGE(IDC_SEARCHNAME, OnEnChangeSearchname) // EC 08.07.03
	//ON_EN_CHANGE(IDC_SEARCHAVAIL , OnEnChangeSearchname) // EC 08.07.03
	//ON_EN_CHANGE(IDC_SEARCHEXTENSION, OnEnChangeSearchname) // EC 08.07.03
a148 1
	ON_STN_CLICKED(IDC_SEARCHEXTENSION_LBL, OnStnClickedSearchextensionLbl)
a426 1

d437 1
a437 1
			theApp.downloadqueue->AddSearchToDownload((CSearchFile*)searchlistctrl.GetItemData(index));
a468 1
	//GetDlgItem(IDC_SEARCHEXTENSION_LBL)->SetWindowText(GetResString(IDS_SEARCHEXTENSION_LBL));
a470 1
	GetDlgItem(IDC_SMARTFILTER_LBL)->SetWindowText(GetResString(IDS_SMARTFILTER_LBL)); // EC
d1152 1
d1188 19
@


1.46
log
@made 'except' string lowercase
@
text
@d1047 1
a1047 1
void CSearchDlg::AddEd2kLinksToDownload(CString strlink){
d1062 1
a1062 1
				theApp.downloadqueue->AddFileLinkToDownload(pLink->GetFileLink());
@


1.45
log
@Andrerib: changed NOT to Except (and localized)
@
text
@d458 1
a458 1
	GetDlgItem(IDC_SNAME_LBL2)->SetWindowText(GetResString(IDS_SCH_EXCEPT));
@


1.44
log
@bugfix for bugfix :)
@
text
@d458 1
@


1.43
log
@BUGFIX for  0000304
@
text
@d194 1
@


1.42
log
@unicode cleanup
@
text
@d140 3
a142 3
	ON_EN_CHANGE(IDC_SEARCHNAME, OnEnChangeSearchname)
	ON_EN_CHANGE(IDC_SEARCHAVAIL , OnEnChangeSearchname)
	ON_EN_CHANGE(IDC_SEARCHEXTENSION, OnEnChangeSearchname)
d147 1
a147 1
	ON_CBN_SELCHANGE(IDC_TypeSearch, OnEnChangeSearchname)
d187 1
a187 1
	OnEnChangeSearchname();
d707 1
d991 2
a992 1

d996 1
a996 1
	GetDlgItem(IDC_STARTS)->EnableWindow(true);
d998 1
a998 1
	GetDlgItem(IDC_CLEARALL)->EnableWindow(true);
d1001 2
a1002 1

d1014 1
a1014 1
	OnEnChangeSearchname();
@


1.41
log
@avoid unnecessary search requests if no max size specified (at lugdunums request)
@
text
@d172 5
a176 5
	if (atol(sMin)>2047)
		GetDlgItem(IDC_EDITSEARCHMIN)->SetWindowText("2047");
	if (atol(sMax)>2048)
		GetDlgItem(IDC_EDITSEARCHMAX)->SetWindowText("2048");
	if (atoi(sMax)-atoi(sMin)<1 && sMax!="")
d180 1
a180 1
			GetDlgItem(IDC_EDITSEARCHMAX)->SetWindowText("");	
d184 1
a184 1
			GetDlgItem(IDC_EDITSEARCHMIN)->SetWindowText("");
d200 2
a201 2
		if (strlink.Right(1)!="/") strlink+="/";
		GetDlgItem(IDC_ELINK)->SetWindowText("");
d211 1
a211 1
				throw CString("bad link");
d356 1
a356 1
		query = "http://www.filedonkey.com/fdsearch/index.php?";
d358 1
a358 1
		query += "pattern="+ToQueryString(tosearch);
d361 1
a361 1
			tosearch="Audio";
d363 1
a363 1
			tosearch="Video";
d365 1
a365 1
			tosearch="Pro";
d367 1
a367 1
			tosearch="Doc";		
d369 3
a371 3
			tosearch="All";
		query +="&media=" + tosearch; //Cax2 added filedonkey 'type' option
		query += "&action=search&name=FD-Search&op=modload&file=index&requestby=emule";
d374 1
a374 1
		query = "http://www.jigle.com/search?";
d376 1
a376 1
		query += "p="+ToQueryString(tosearch) + "&ma=";
d378 9
a386 9
		if (atol(tosearch)>1000) tosearch="1000";
		else if (atoi(tosearch)>500) tosearch="500";
		else if (atoi(tosearch)>200) tosearch="200";
		else if (atoi(tosearch)>100) tosearch="100";
		else if (atoi(tosearch)>50) tosearch="50";
		else if (atoi(tosearch)>20) tosearch="20";
		else if (atoi(tosearch)>10) tosearch="10";
		else tosearch="1";
		query += tosearch +"&v=0&d=1&a=0&l=10";		//Cax2 might want to change to l=25 for more results per page... 
d389 1
a389 1
			tosearch="1";
d391 1
a391 1
			tosearch="2";
d393 1
a393 1
			tosearch="3";
d395 1
a395 1
			tosearch="4";
d397 1
a397 1
			tosearch="5";
d399 2
a400 2
			tosearch="0";
		query +="&t=" +tosearch;
d402 1
a402 1
		query +="&x=" + ToQueryString(tosearch);
d404 3
a406 3
		num=atol(tosearch);
		tosearch.Format("%u",((num>0)?num *1048576:1));
		query +="&sl=" +tosearch;
d408 3
a410 3
		num=atol(tosearch);
		tosearch.Format(((num>0)?"%u":""),num * 1048576);
		query +="&su=" + tosearch;
d423 1
a423 1
	sTmp.Replace("%20","+");
d469 2
a470 2
	GetDlgItem(IDC_SEARCHMINSIZE)->SetWindowText(GetResString(IDS_SEARCHMINSIZE) + " (" + GetResString(IDS_MBYTES) + ")");
	GetDlgItem(IDC_SEARCHMAXSIZE)->SetWindowText(GetResString(IDS_SEARCHMAXSIZE) + " (" + GetResString(IDS_MBYTES) + ")");
d500 7
a506 7
	Stypebox.AddString(GetResString(IDS_SEARCH_ARC)+" (.zip .rar .ace...)");
	Stypebox.AddString(GetResString(IDS_SEARCH_AUDIO)+" (.mp3 .ogg .wav...)");
	Stypebox.AddString(GetResString(IDS_SEARCH_CDIMG)+" (.iso .bin .nrg...)");
	Stypebox.AddString(GetResString(IDS_SEARCH_PICS)+" (.jpg .gif .png...)");
	Stypebox.AddString(GetResString(IDS_SEARCH_PRG)+" (.exe .zip .rar...)");
	Stypebox.AddString(GetResString(IDS_SEARCH_VIDEO)+" (.avi .mpg .ogm...)");
	Stypebox.AddString(GetResString(IDS_SEARCH_DOC)+" (.doc .txt .pdf...)");
d541 6
a546 6
		CString type="";
		if (GetResString(IDS_SEARCH_AUDIO)==typeText) type.Format("Audio"); 
		if (GetResString(IDS_SEARCH_VIDEO)==typeText) type.Format("Video"); 
		if (GetResString(IDS_SEARCH_PRG)==typeText) type.Format("Pro"); 
		if (GetResString(IDS_SEARCH_PICS)==typeText) type.Format("Image"); 
		if (GetResString(IDS_SEARCH_DOC)==typeText) type.Format("");
d550 1
a550 1
		char* formatC;
d552 1
a552 1
		if (extension.GetLength()>0 && extension.GetAt(0)!='.' ) extension="."+extension;
d700 1
a700 1
		int idx=typeText.Find(" (.");	//Cax2 bugfix: remove all examples from typeText
d722 1
a722 1
		char* formatC;
d728 2
a729 2
		unsigned long max=atol(sizeMax.GetString())*1048576; 
		unsigned long min=atol(sizeMin.GetString())*1048576; 
d743 1
a743 1
		avaibility=atol(avaibilitystr.GetString());
d1003 6
a1008 6
	GetDlgItem(IDC_EDITSEARCHAVAIBILITY)->SetWindowText("");	
	GetDlgItem(IDC_EDITSEARCHEXTENSION)->SetWindowText("");	
	GetDlgItem(IDC_EDITSEARCHMIN)->SetWindowText("");	
	GetDlgItem(IDC_EDITSEARCHMAX)->SetWindowText("");	
	GetDlgItem(IDC_SEARCHNAME)->SetWindowText("");
	GetDlgItem(IDC_SEARCHNAME_NOT)->SetWindowText("");
d1048 1
a1048 1
	resToken= strlink.Tokenize("\t\n\r",curPos);
d1069 1
a1069 1
		resToken= strlink.Tokenize("\t\n\r",curPos);
d1095 1
a1095 1
					text += _tcslen("> ");
d1118 1
a1118 1
							msglinks += newlink + "\n";
@


1.40
log
@Preparing for new sockets
@
text
@d730 1
a730 1
		if (max==0 || max<min) max=2147483646;//max file size 
@


1.39
log
@converted to new logger methods
@
text
@d246 1
d263 1
d522 1
d524 1
d658 1
d660 1
d690 1
d693 3
a695 1
	else{
d861 1
d863 1
@


1.38
log
@code cleanup
@
text
@d218 1
a218 1
			AddLogLine(true, GetResString(IDS_ERR_LINKERROR), buffer);
d1056 1
a1056 1
			theApp.emuledlg->AddLogLine(true, GetResString(IDS_ERR_LINKERROR), buffer);
@


1.37
log
@Eklmn and BavarianSnail changes. see changelog+
@
text
@d544 1
a544 1
		CMemFile* data = new CMemFile(100); 
a551 1
			delete data;
d561 1
a561 1
		      data->Write(&andParameter,2);
d568 1
a568 1
		      data->Write(&andParameter,2);
d575 1
a575 1
			  data->Write(&andParameter,2);
d582 1
a582 1
			  data->Write(&andParameter,2);
d589 1
a589 1
			  data->Write(&andParameter,2);
d596 1
a596 1
		      data->Write(&andParameter,2);
d602 1
a602 1
			data->Write(&stringParameter,1); //write the parameter type
d604 2
a605 2
			data->Write(&nSize,2);  // write parameter length
			data->Write(searchString.GetBuffer() ,nSize); //write the searched string 
d610 1
a610 1
			data->Write(&typeParameter,1); //write the parameter type
d612 1
a612 1
			data->Write(&nSize,2);   //write the length
d614 2
a615 2
			data->Write(formatC,nSize); //write parameter
			data->Write(&typeNemonic,3); //nemonic for this kind of parameter (only 3 bytes!!)
d620 3
a622 3
			data->Write(&numericParameter,1); //write the parameter type
			data->Write(&min,4);		   //write the parameter
			data->Write(&minNemonic,4);    //nemonic for this kind of parameter
d627 3
a629 3
			data->Write(&numericParameter,1); //write the parameter type
			data->Write(&max,4);		   //write the parameter
			data->Write(&maxNemonic,4);    //nemonic for this kind of parameter
d634 3
a636 3
			data->Write(&numericParameter,1); //write the parameter type
			data->Write(&avaibility,4);    //write the parameter
			data->Write(&avaibilityNemonic,4);  //nemonic for this kind of parameter
d641 1
a641 1
			data->Write(&stringParameter,1); //write the parameter type
d643 1
a643 1
			data->Write(&nSize,2);   //write the length
d645 2
a646 2
			data->Write(formatC,nSize); //write parameter
			data->Write(&extensionNemonic,3); //nemonic for this kind of parameter (only 3 bytes!!)
d650 1
a650 1
		Packet* packet = new Packet(data);
d652 1
a652 1
		delete data;
@


1.36
log
@code cleanup
@
text
@d1149 1
@


1.35
log
@Fix for search when on NOT or METHOD boxes.
@
text
@d216 2
a217 2
			char buffer[200];
			sprintf(buffer,GetResString(IDS_ERR_INVALIDLINK),error.GetBuffer());
d1055 2
a1056 2
			char buffer[200];
			sprintf(buffer,GetResString(IDS_ERR_INVALIDLINK),error.GetBuffer());
@


1.34
log
@documents search and 'NOT' search filter
@
text
@d323 8
a330 6
		else if (pMsg->hwnd == GetDlgItem(IDC_SEARCHNAME)->m_hWnd || 
			pMsg->hwnd == GetDlgItem(IDC_TypeSearch)->m_hWnd || 
			pMsg->hwnd == GetDlgItem(IDC_EDITSEARCHMIN)->m_hWnd || 
			pMsg->hwnd == GetDlgItem(IDC_EDITSEARCHMAX)->m_hWnd || 
			pMsg->hwnd == GetDlgItem(IDC_EDITSEARCHAVAIBILITY)->m_hWnd || 
			pMsg->hwnd == GetDlgItem(IDC_EDITSEARCHEXTENSION)->m_hWnd)
@


1.33
log
@#0000160
feature
When opening the search window make the Name field active automatically
@
text
@d87 1
d362 2
d392 2
d502 1
d540 1
d671 4
d730 1
d871 7
d996 1
d1157 19
a1175 1
}@


1.32
log
@#0000174
feature
When closing search tabs set focus to the next tab instead of first one
@
text
@d149 1
d1129 9
@


1.31
log
@Upgrade to webserver official 0.28a
@
text
@d889 1
a889 2
	int i;
	for (i = 0; i != searchselect.GetItemCount();i++)
d901 1
a901 1
	if (searchselect.GetItemCount())
d903 2
a904 1
		searchselect.SetCurSel(0);
d906 1
a906 1
		searchselect.GetItem(0,&item);
d931 3
d936 2
a937 5
	int cur_sel = searchselect.GetCurSel();
	if (cur_sel == (-1))
		return;
	searchselect.GetItem(cur_sel,&item);
	searchlistctrl.ShowResults(item.lParam);
@


1.30
log
@More try/catch according to crash dumps
@
text
@d507 160
d1007 33
@


1.29
log
@Minor changes
@
text
@d50 1
d53 1
d58 1
d114 2
d166 1
d186 1
d191 1
d237 1
d242 1
d261 1
d266 1
d280 1
d286 1
a297 1

d299 1
d314 1
d330 2
d336 1
d339 1
d344 1
d403 1
a403 1
		return "";
d406 2
d411 1
d415 2
d422 1
d436 1
d442 1
d498 1
d509 1
d701 1
d706 1
d721 1
d726 1
d755 1
d760 1
d765 1
d770 1
d779 1
d783 1
d795 2
d801 1
d805 1
d810 1
d819 1
d829 1
d831 1
d837 1
d845 2
d851 1
d924 1
d929 1
d933 1
@


1.28
log
@Fixed a memory leak on global search
@
text
@d466 1
a466 1
	Stypebox.AddString(GetResString(IDS_SEARCH_PRG)+" (.zip .rar .exe...)");
d468 1
a468 1
	Stypebox.AddString(GetResString(IDS_SEARCH_USER));
@


1.28.2.1
log
@27a partial merge
@
text
@a61 1
	m_guardCBPrompt=false;
a108 2
	m_lastclpbrd="";

a299 1
   if((pMsg->message == WM_KEYDOWN) && (pMsg->wParam == 27)) return FALSE;
a674 7
    int iTabItems = searchselect.GetItemCount();
    for (int i = 0; i < iTabItems; i++){
        TCITEM tci;
        tci.mask = TCIF_PARAM;
        if (searchselect.GetItem(i, &tci) && tci.lParam == nSearchID)
            return;
    }
d800 2
a801 28
	AddEd2kLinksToDownload(theApp.CopyTextFromClipboard());
}
// END - enkeyDEV(Ottavio84) -Download all ed2ks in clipboard-
void CSearchDlg::OnDestroy()
{
	CResizableDialog::OnDestroy();
	//Resources cleanup - [TwoBottle Mod]
	DestroyIcon(GetSearchLstStatic()->SetIcon(oldSearchLstIcon));
}

void CSearchDlg::SearchClipBoard() {
	if (m_guardCBPrompt) return;

	CString clpbrd=theApp.CopyTextFromClipboard();
	if (clpbrd=="" || clpbrd.Compare(m_lastclpbrd)==0) return;

	if (clpbrd.Find("ed2k://|file|")!=-1)
	{
		m_guardCBPrompt=true;
		AddEd2kLinksToDownload(clpbrd);
	}
	m_lastclpbrd=clpbrd;
	m_guardCBPrompt=false;

}

void CSearchDlg::AddEd2kLinksToDownload(CString strlink){
	const TCHAR* text = strlink;
a859 2
		theApp.emuledlg->RestoreWindow();
		theApp.emuledlg->BringWindowToTop();
d872 8
a879 1
}@


1.27
log
@converted to new logging method
@
text
@d45 1
d50 2
d260 1
d642 27
a668 19
		//Cax2 - get users
		packet->opcode =(GetResString(IDS_SEARCH_USER)==typeText)?OP_SEARCH_USER:OP_SEARCHREQUEST;
		delete data;
		theApp.uploadqueue->AddUpDataOverheadServer(packet->size);
		theApp.serverconnect->SendPacket(packet,false);

		if (isThisGlobal){
			if( theApp.glob_prefs->Score() ){
				theApp.serverlist->ResetSearchServerPos();
			}
			searchpacket = packet;
			searchpacket->opcode = OP_GLOBSEARCHREQ;
			servercount = 0;
			searchprogress.SetRange32(0,theApp.serverlist->GetServerCount()-1);
			globsearch = true;
		}
		else{
			globsearch = false;
			delete packet;
a669 1
		CreateNewTab(searchString,m_nSearchID);
@


1.26
log
@fixed resource leak
@
text
@d205 1
a205 1
			theApp.emuledlg->AddLogLine(true, GetResString(IDS_ERR_LINKERROR), buffer);
@


1.25
log
@Last changes to context menues and Fakecheck code removal.
@
text
@d61 2
a62 2
	m_ctrlDirectDlFrm.Init(IDI_DIRECTDOWNLOAD, &theApp.emuledlg->m_ThemeHelper);
	((CStatic*)GetDlgItem(IDC_SEARCHLST_ICO))->SetIcon((HICON)::LoadImage(AfxGetInstanceHandle(), MAKEINTRESOURCE(IDI_SEARCHRESULTS), IMAGE_ICON, 16, 16, 0));
d142 1
d862 7
a868 1
// END - enkeyDEV(Ottavio84) -Download all ed2ks in clipboard-@


1.24
log
@bugfixed server & global search
@
text
@a98 1
	AddAnchor(IDC_FAKECHECK,BOTTOM_RIGHT);
a128 1
	ON_BN_CLICKED(IDC_FAKECHECK, OnBnClickedFakecheck)
a761 51
}


// Added by Tarod [AgentSmith]
void CSearchDlg::OnBnClickedFakecheck()
{
	char buffer[100]; 
	int index = -1; 
	CString fakeurl = "http://edonkeyfakes.ath.cx/fakecheck/update/fakecheck.php?hash="; 

	POSITION pos = searchlistctrl.GetFirstSelectedItemPosition(); 
	if(pos != NULL)
	{ 
		index = searchlistctrl.GetNextSelectedItem(pos); 
		if(index > -1)
		{ 
			buffer[0] = 0; 
			for(uint16 i = 0; i != 16; i++) // hmm I wonder if there is a standart function for this 
				sprintf(buffer, "%s%02X", buffer, ((CSearchFile*)searchlistctrl.GetItemData(index))->GetFileHash()[i]); 
		} 
		fakeurl += buffer; 
	} 
	ShellOpenFile(fakeurl);
}

// DonGato [ptiemann]
void CSearchDlg::ed2kfilesFakecheck()
{
	char buffer[100]; 
	int index = -1; 
	CString fakeurl = "http://www.ed2kfiles.com/cgi-bin/mh_fake.pl?MACTION=CHECK&md4=";

	POSITION pos = searchlistctrl.GetFirstSelectedItemPosition(); 
	if(pos != NULL)
	{ 
		index = searchlistctrl.GetNextSelectedItem(pos); 
		if(index > -1)
		{
			buffer[0] = 0; 
			for(uint16 i = 0; i != 16; i++)
				sprintf(buffer, "%s%02X", buffer, ((CSearchFile*)searchlistctrl.GetItemData(index))->GetFileHash()[i]); 

			fakeurl += buffer; 

			sprintf(buffer, "&size=%d&name=%s", ((CSearchFile*)searchlistctrl.GetItemData(index))->GetFileSize(),
				((CSearchFile*)searchlistctrl.GetItemData(index))->GetFileName());
			fakeurl += buffer; 

		} 
	} 
	ShellOpenFile(fakeurl);
@


1.23
log
@enkeydev stuff
@
text
@d485 3
d490 2
a491 2
		this->GetDlgItem(IDC_STARTS)->EnableWindow(false);
		this->GetDlgItem(IDC_CANCELS)->EnableWindow(true);
d494 1
a494 1
		long typeNemonic=      0x00030001;
d516 3
a518 3

		GetDlgItem(IDC_EDITSEARCHEXTENSION)->GetWindowText(extension);
		if (extension.GetLength()>0 && extension.GetAt(0)!='.' ) extension="."+extension;
d520 5
a524 4
		if (GetResString(IDS_SEARCH_AUDIO)==typeText) type.Format("Audio"); 
		if (GetResString(IDS_SEARCH_VIDEO)==typeText) type.Format("Video"); 
		if (GetResString(IDS_SEARCH_PRG)==typeText) type.Format("Pro"); 
		if (GetResString(IDS_SEARCH_PICS)==typeText) type.Format("Image"); 
d537 3
a539 1
		if ( searchString.GetLength()>0)
d541 2
d546 1
a546 1
		}
d549 1
a549 1
		{
d553 4
a556 4
		}

		if (min>0)
		{
d560 4
a563 4
		}

		if (max>0)
		{
d567 4
a570 4
		}

		if (avaibility>0)
		{
d574 4
a577 4
		}

		if (extension.GetLength()>0)
		{
d581 1
d585 1
a585 1
		if (searchString.GetLength()>0) //search a string
d588 1
a588 1
			nSize = GetDlgItem(IDC_SEARCHNAME)->GetWindowTextLength(); 
d590 2
a591 4
			char* searchstr = new char[nSize+1]; 
			GetDlgItem(IDC_SEARCHNAME)->GetWindowText(searchstr,nSize+1); 
			data->Write(searchstr,nSize); //write the searched string 
			delete[] searchstr; 
d593 2
a594 12

		if (type.GetLength()>0)
		{
			data->Write(&typeParameter,1); //write the parameter type
			nSize=type.GetLength(); 
			data->Write(&nSize,2);   //write the length
			formatC=type.GetBuffer(); 
			data->Write(formatC,nSize); //write parameter
			data->Write(&typeNemonic,3); //nemonic for this kind of parameter (only 3 bytes!!)
		}

		if (min>0)
d596 40
a635 3
			data->Write(&numericParameter,1); //write the parameter type
			data->Write(&min,4);		   //write the parameter
			data->Write(&minNemonic,4);    //nemonic for this kind of parameter
a637 25
		if (max>0)
		{
			data->Write(&numericParameter,1); //write the parameter type
			data->Write(&max,4);		   //write the parameter
			data->Write(&maxNemonic,4);    //nemonic for this kind of parameter
		}

		if (avaibility>0)
		{
			data->Write(&numericParameter,1); //write the parameter type
			data->Write(&avaibility,4);    //write the parameter
			data->Write(&avaibilityNemonic,4);  //nemonic for this kind of parameter
		}

		if (extension.GetLength()>0)
		{
			data->Write(&stringParameter,1); //write the parameter type
			nSize=extension.GetLength(); 
			data->Write(&nSize,2);   //write the length
			formatC=extension.GetBuffer(); 
			data->Write(formatC,nSize); //write parameter
			data->Write(&extensionNemonic,3); //nemonic for this kind of parameter (only 3 bytes!!)
		}


d639 2
a640 1
		packet->opcode = OP_SEARCHREQUEST;
@


1.22
log
@file buffer size, autotake ed2k links and some preferences reorganization.
@
text
@d42 1
a42 1
	: CResizableDialog(CSearchDlg::IDD, pParent)
d44 1
a44 1
		m_nSearchID = 0;
d97 1
a97 1
	
d103 1
a103 1
	
d105 1
d132 1
d214 11
a224 11
			case 0:
			case 1:
				StartNewSearch();
				break;
			
			case 2:
			case 3:
				ShellOpenFile(CreateWebQuery());
				return;
			default:
				return;
d297 3
a299 3
   if((pMsg->message == WM_KEYDOWN) && (pMsg->wParam == 13))
   {
	   if (pMsg->hwnd == GetDlgItem(IDC_SEARCHLIST)->m_hWnd)
d301 1
a301 1
	   else if (pMsg->hwnd == GetDlgItem(IDC_ELINK)->m_hWnd)
d303 6
a308 6
	   else if (pMsg->hwnd == GetDlgItem(IDC_SEARCHNAME)->m_hWnd || 
				pMsg->hwnd == GetDlgItem(IDC_TypeSearch)->m_hWnd || 
				pMsg->hwnd == GetDlgItem(IDC_EDITSEARCHMIN)->m_hWnd || 
				pMsg->hwnd == GetDlgItem(IDC_EDITSEARCHMAX)->m_hWnd || 
				pMsg->hwnd == GetDlgItem(IDC_EDITSEARCHAVAIBILITY)->m_hWnd || 
				pMsg->hwnd == GetDlgItem(IDC_EDITSEARCHEXTENSION)->m_hWnd)
d310 2
a311 2
   }
   return CResizableDialog::PreTranslateMessage(pMsg);
d326 55
a380 55
		case 2:
			query = "http://www.filedonkey.com/fdsearch/index.php?";
			GetDlgItem(IDC_SEARCHNAME)->GetWindowText(tosearch);
			query += "pattern="+ToQueryString(tosearch);
			GetDlgItem(IDC_TypeSearch)->GetWindowText(tosearch);
			if (GetResString(IDS_SEARCH_AUDIO)==tosearch)
				tosearch="Audio";
			else if (GetResString(IDS_SEARCH_VIDEO)==tosearch)
				tosearch="Video";
			else if (GetResString(IDS_SEARCH_PRG)==tosearch)
				tosearch="Pro";
			else
				tosearch="All";
			query +="&media=" + tosearch; //Cax2 added filedonkey 'type' option
			query += "&action=search&name=FD-Search&op=modload&file=index&requestby=emule";
			break;
		case 3:
			query = "http://www.jigle.com/search?";
			GetDlgItem(IDC_SEARCHNAME)->GetWindowText(tosearch);
			query += "p="+ToQueryString(tosearch) + "&ma=";
			GetDlgItem(IDC_EDITSEARCHAVAIBILITY)->GetWindowText(tosearch);
			if (atol(tosearch)>1000) tosearch="1000";
			else if (atoi(tosearch)>500) tosearch="500";
			else if (atoi(tosearch)>200) tosearch="200";
			else if (atoi(tosearch)>100) tosearch="100";
			else if (atoi(tosearch)>50) tosearch="50";
			else if (atoi(tosearch)>20) tosearch="20";
			else if (atoi(tosearch)>10) tosearch="10";
			else tosearch="1";
			query += tosearch +"&v=0&d=1&a=0&l=10";		//Cax2 might want to change to l=25 for more results per page... 
			GetDlgItem(IDC_TypeSearch)->GetWindowText(tosearch);
			if (GetResString(IDS_SEARCH_AUDIO)==tosearch)
				tosearch="1";
			else if (GetResString(IDS_SEARCH_VIDEO)==tosearch)
				tosearch="2";
			else if (GetResString(IDS_SEARCH_PICS)==tosearch)
				tosearch="3";
			else if (GetResString(IDS_SEARCH_PRG)==tosearch)
				tosearch="4";
			else
				tosearch="0";
			query +="&t=" +tosearch;
			GetDlgItem(IDC_EDITSEARCHEXTENSION)->GetWindowText(tosearch);
			query +="&x=" + ToQueryString(tosearch);
			GetDlgItem(IDC_EDITSEARCHMIN)->GetWindowText(tosearch);
			num=atol(tosearch);
			tosearch.Format("%u",((num>0)?num *1048576:1));
			query +="&sl=" +tosearch;
			GetDlgItem(IDC_EDITSEARCHMAX)->GetWindowText(tosearch);
			num=atol(tosearch);
			tosearch.Format(((num>0)?"%u":""),num * 1048576);
			query +="&su=" + tosearch;
			break;
		default:
			return "";
d413 1
a413 1
	
d420 1
a420 1
	
d424 1
a424 1
	
d434 1
d524 1
a524 1
	  
d535 3
a537 3
		  parametercount++;
		  if (parametercount>1)
		      data->Write(&andParameter,2);
d542 3
a544 3
		  parametercount++;
		  if (parametercount>1)
		      data->Write(&andParameter,2);
d546 1
a546 1
	  
d549 3
a551 3
		  parametercount++;
		  if (parametercount>1)
			  data->Write(&andParameter,2);
d553 1
a553 1
        
d556 3
a558 3
		  parametercount++;
		  if (parametercount>1)
			  data->Write(&andParameter,2);
d560 1
a560 1
        
d563 3
a565 3
		  parametercount++;
		  if (parametercount>1)
			  data->Write(&andParameter,2);
d567 1
a567 1
        
d570 3
a572 3
		  parametercount++;
		  if (parametercount>1)
		      data->Write(&andParameter,2);
d575 1
a575 1
        //body
d674 4
a677 4
    item.mask = TCIF_PARAM;
    int i;
    for (i = 0; i != searchselect.GetItemCount();i++)
    {
d681 2
a682 2
    }
    if (item.lParam != nSearchID)
d686 4
a689 4
    theApp.searchlist->RemoveResults(nSearchID);
    searchselect.DeleteItem(i);
    if (searchselect.GetItemCount())
    {
d692 9
a700 9
	    searchselect.GetItem(0,&item);
	    searchlistctrl.ShowResults(item.lParam);
    }
    else
    {
	    searchlistctrl.DeleteAllItems();
	    searchselect.ShowWindow(SW_HIDE);
	    searchlistctrl.NoTabs();
    }
d799 1
a799 1
				                                ((CSearchFile*)searchlistctrl.GetItemData(index))->GetFileName());
d816 89
@


1.21
log
@Paused files shown in grey and Selected search methos stored between sessions.
@
text
@a79 1
	//AddAnchor(IDC_SGLOBAL, TOP_LEFT);
a413 1
	//GetDlgItem(IDC_SGLOBAL)->SetWindowText(GetResString(IDS_SW_GLOBAL));
@


1.20
log
@Updated conetext menus.
@
text
@d140 1
d454 1
a454 1
	methodbox.SetCurSel(0);
a805 3



d809 5
@


1.20.2.1
log
@keeping in sync with the main cvs line
@
text
@d80 1
a139 1
	ON_CBN_SELCHANGE(IDC_METHOD, OnEnChangeMethod)
d414 1
d453 1
a453 1
	methodbox.SetCurSel(theApp.glob_prefs->GetMethod());
d805 3
a810 5
}

void CSearchDlg::OnEnChangeMethod()
{
	theApp.glob_prefs->SetMethod(methodbox.GetCurSel());
@


1.19
log
@bugfixes: sort in search window, unknown % in stats, dowload speed at startup updated search layout
@
text
@d427 2
a428 2
	GetDlgItem(IDC_SEARCHMINSIZE)->SetWindowText(GetResString(IDS_SEARCHMINSIZE)+", " + GetResString(IDS_MBYTES));
	GetDlgItem(IDC_SEARCHMAXSIZE)->SetWindowText(GetResString(IDS_SEARCHMAXSIZE)+", " + GetResString(IDS_MBYTES));
@


1.18
log
@End of double check with official code.
@
text
@d68 1
d80 1
a80 1
	AddAnchor(IDC_SGLOBAL, TOP_LEFT);
d213 1
d216 1
a216 1
			case 1:
d218 1
d324 1
a324 1
		case 1:
d340 1
a340 1
		case 2:
d414 1
a414 1
	GetDlgItem(IDC_SGLOBAL)->SetWindowText(GetResString(IDS_SW_GLOBAL));
d438 1
a438 1
	CString            str[3];
d440 4
a443 3
	str[1]="FileDonkey";
	str[2]="Jigle";
	for (int i=0; i<3;i++)
d475 1
d633 1
a633 1
		if (this->IsDlgButtonChecked(IDC_SGLOBAL)){
@


1.17
log
@minor updates & bugfixes
@
text
@a725 1
/*	theApp.searchlist->RemoveResults(nSearchID);
a726 14
	searchselect.DeleteItem(i);
	if(searchselect.GetItemCount())
	{
		searchselect.SetCurSel(0);
		item.mask = TCIF_PARAM;
		searchselect.GetItem(0,&item);
		searchlistctrl.ShowResults(item.lParam);
	}
	else
	{
		searchlistctrl.DeleteAllItems();
		searchselect.ShowWindow(SW_HIDE);
	}
*/
@


1.16
log
@Last BUGFIXES (FileComments/SharedFiles Columns)
@
text
@d429 2
a430 1
	
@


1.15
log
@minor graphic improvements. search bugfix
@
text
@d100 2
d133 1
a133 1
	ON_EN_CHANGE(IDC_SEARCHEXTENTION, OnEnChangeSearchname)
d426 1
a426 1
	GetDlgItem(IDC_SEARCHEXTENSION_LBL)->SetWindowText(GetResString(IDS_SEARCHEXTENSION_LBL));
d451 2
a452 2
	Stypebox.AddString(GetResString(IDS_SEARCH_ANY)+" (.zip .rar .avi .mpeg .mp3...)");
	Stypebox.AddString(GetResString(IDS_SEARCH_ARC)+" (.zip .rar .ace .gz .tar...)");
d454 2
a455 2
	Stypebox.AddString(GetResString(IDS_SEARCH_CDIMG)+" (.iso .bin .cue .nrg...)");
	Stypebox.AddString(GetResString(IDS_SEARCH_PICS)+" (.jpg .gif .bmp .png...)");
d457 1
a457 1
	Stypebox.AddString(GetResString(IDS_SEARCH_VIDEO)+" (.avi .divx .mpg .ogm...)");
@


1.14
log
@SF & RF ratios bugfixed, added 'type' options to filedonkey search
@
text
@d65 6
d113 1
a113 1
	DDX_Control(pDX, IDC_METHOD, typebox);
d207 1
a207 1
		switch (typebox.GetCurSel())
d317 1
a317 1
	switch (typebox.GetCurSel())
d428 28
a455 16
	while (typebox.GetCount()>0)
		typebox.DeleteString(0);
	typebox.AddString(GetResString(IDS_PW_SERVER));
	typebox.AddString("FileDonkey");
	typebox.AddString("Jigle");
	typebox.SetCurSel(typebox.FindString(-1,GetResString(IDS_PW_SERVER)));

	while(Stypebox.GetCount() > 0) 
		Stypebox.DeleteString(0);
	Stypebox.AddString(GetResString(IDS_SEARCH_ANY));
	Stypebox.AddString(GetResString(IDS_SEARCH_ARC));
	Stypebox.AddString(GetResString(IDS_SEARCH_AUDIO));
	Stypebox.AddString(GetResString(IDS_SEARCH_CDIMG));
	Stypebox.AddString(GetResString(IDS_SEARCH_PICS));
	Stypebox.AddString(GetResString(IDS_SEARCH_PRG));
	Stypebox.AddString(GetResString(IDS_SEARCH_VIDEO));
d457 1
a457 1
	Stypebox.SetCurSel(Stypebox.FindString(-1,GetResString(IDS_SEARCH_ANY)));
@


1.13
log
@upgrade to 26d, fixes, extended reask, more upload parts seen, more crash fixes
@
text
@d317 10
a326 1
			query += tosearch;
@


1.12
log
@Added instrumentation for debugging memory leaks :
#ifdef _DEBUG
#undef THIS_FILE
static char THIS_FILE[]=__FILE__;
#define new DEBUG_NEW
#endif

To all .cpp files (I hope I didn't miss any one)
@
text
@d488 5
a492 1
		if ( searchString.GetLength()==0 && extension.GetLength()==0) return;
@


1.11
log
@Chnages to position of controls on Search and SysTray.
@
text
@d31 7
@


1.10
log
@limit set to min & max file size in the search
@
text
@d125 1
d776 5
@


1.9
log
@added jigle parameters to search code
@
text
@d143 4
d150 1
d152 1
d154 3
a156 1
			GetDlgItem(IDC_EDITSEARCHMIN)->SetWindowText("");	
a340 1
			tosearch=tosearch.Left(4);
a341 1
			if (num>=2048) num=2047;	//Max file size limit for the search...
a344 1
			tosearch=tosearch.Left(4);
a345 1
			if (num>2048) num=2048;
@


1.8
log
@Added xrmb's SmartOpen
@
text
@d119 2
a120 2
	ON_EN_CHANGE(IDC_SEARCHMINSIZE, OnEnChangeSearchname)
	ON_EN_CHANGE(IDC_SEARCHMAXSIZE, OnEnChangeSearchname)
d129 23
d293 2
a294 2
	CString query;
	CString tosearch;
d300 1
a300 3
			tosearch = URLEncode(tosearch);
			tosearch.Replace("%20","+");
			query += "pattern=";
d307 37
a343 5
			tosearch = URLEncode(tosearch);
			tosearch.Replace("%20","+");
			query += "p=";
			query += tosearch;
			query += "&ma=1&d=1&a=0&l=10&t=0&x=&sl=1&su=&v=0";
d351 7
d768 3
@


1.7
log
@Updates to Search, System Tray tooltip and System Tray Menu.
@
text
@d335 4
a338 4
	GetDlgItem(IDC_SEARCHMINSIZE)->SetWindowText(GetResString(IDS_SEARCHMINSIZE)+", " + GetResString(IDS_MBYTES) +":");
	GetDlgItem(IDC_SEARCHMAXSIZE)->SetWindowText(GetResString(IDS_SEARCHMAXSIZE)+", " + GetResString(IDS_MBYTES) +":");
	GetDlgItem(IDC_SEARCHEXTENSION_LBL)->SetWindowText(GetResString(IDS_SEARCHEXTENSION_LBL)+":");
	GetDlgItem(IDC_SEARCHAVAIL)->SetWindowText(GetResString(IDS_SEARCHAVAIL)+":");
@


1.6
log
@overhead parameters change
@
text
@a53 1
	m_ctrlWebSearchFrm.Init(IDI_WEBBASED, &theApp.emuledlg->m_ThemeHelper);
d70 2
a71 6

	AddAnchor(IDC_WEBSEARCH_FRM, TOP_LEFT);
	AddAnchor(IDC_WNAME_LBL, TOP_LEFT);
	AddAnchor(IDC_SWEB, TOP_LEFT);
	AddAnchor(IDC_WTYPE_LBL, TOP_LEFT);
	AddAnchor(IDC_Type, TOP_LEFT);
d100 1
a100 1
	DDX_Control(pDX, IDC_Type, typebox);
a103 1
	DDX_Control(pDX, IDC_WEBSEARCH_FRM, m_ctrlWebSearchFrm);
d109 2
a111 1
	ON_WM_TIMER()
d113 2
a115 3
	ON_NOTIFY(NM_DBLCLK, IDC_SEARCHLIST, OnNMDblclkSearchlist)
	ON_BN_CLICKED(IDC_CLEARALL, OnBnClickedClearall)
	ON_NOTIFY(TCN_SELCHANGE, IDC_TAB1, OnTcnSelchangeTab1)
a116 3
	ON_CBN_SELCHANGE(IDC_TypeSearch, OnEnChangeSearchname)
	ON_MESSAGE(WM_CLOSETAB, OnCloseTab)
	ON_BN_CLICKED(IDC_FAKECHECK, OnBnClickedFakecheck)
d121 4
a124 1
	ON_BN_CLICKED(IDC_SEARCH_RESET, OnBnClickedSearchReset)
d160 1
a160 1
	if (GetDlgItem(IDC_SWEB)->GetWindowTextLength())
d162 12
a173 2
		ShellOpenFile(CreateWebQuery());
		return;
a174 2
	// start search
	StartNewSearch();
a239 1
	//start download(s)
d271 1
a271 1
	query = "http://www.filedonkey.com/fdsearch/index.php?media=";
d275 7
a281 1
			query += "Audio";
d284 7
a290 4
			query += "Video";
			break;
		case 3:
			query += "Pro";
d293 1
a293 1
			;
a294 7
	CString tosearch;
	GetDlgItem(IDC_SWEB)->GetWindowText(tosearch);
	tosearch = URLEncode(tosearch);
	tosearch.Replace("%20","+");
	query += "&pattern=";
	query += tosearch;
	query += "&action=search&name=FD-Search&op=modload&file=index&requestby=emule";
d324 1
a324 3
	m_ctrlWebSearchFrm.SetText(GetResString(IDS_SW_WEBBASED));
	GetDlgItem(IDC_WNAME_LBL)->SetWindowText(GetResString(IDS_SW_NAME));
	GetDlgItem(IDC_WTYPE_LBL)->SetWindowText(GetResString(IDS_SW_TYPE));
d343 4
a346 5
	typebox.AddString(GetResString(IDS_SEARCH_ANY));
	typebox.AddString(GetResString(IDS_SEARCH_AUDIO));
	typebox.AddString(GetResString(IDS_SEARCH_VIDEO));
	typebox.AddString(GetResString(IDS_SEARCH_PRG));
	typebox.SetCurSel(typebox.FindString(-1,GetResString(IDS_SEARCH_ANY)));
d367 2
a368 6





void CSearchDlg::StartNewSearch(){
a539 159




/*

void CSearchDlg::StartNewSearch()
{
	if (!theApp.serverconnect->IsConnected())
		MessageBox(GetResString(IDS_ERR_NOTCONNECTED),GetResString(IDS_NOTCONNECTED),64);
	else {
		m_nSearchID++;
		CString typeText;
		CString searchString;
		GetDlgItem(IDC_TypeSearch)->GetWindowText(typeText);
		GetDlgItem(IDC_SEARCHNAME)->GetWindowText(searchString);
		theApp.searchlist->NewSearch(&searchlistctrl,typeText,m_nSearchID);
		GetDlgItem(IDC_STARTS)->EnableWindow(false);
		GetDlgItem(IDC_CANCELS)->EnableWindow(true);
		GetDlgItem(IDC_CLEARALL)->EnableWindow(false);
		canceld = false;

		long typeNemonic=      0x00030001;
		long extensionNemonic= 0x00040001;
		long avaibilityNemonic=0x15000101;
		long minNemonic=       0x02000101;
		long maxNemonic=	   0x02000102;
		byte stringParameter=1;
		byte typeParameter=2;
		byte numericParameter=3;
		int andParameter=0x0000;
		int orParameter=0x0100;

		CMemFile* data = new CMemFile(100); 
		int8 buffer; 
		CString type; 
		uint16 size; 
		CString maxstr; 
		CString minstr; 
		unsigned long max; 
		unsigned long min; 
		char* cadena; 
		type.Format(""); 
		GetDlgItem(IDC_EDITSEARCHMAX)->GetWindowText(maxstr); 
		GetDlgItem(IDC_EDITSEARCHMIN)->GetWindowText(minstr); 
		max=0;min=0; 
		max=atol(maxstr.GetString())*1024*1024; 
		min=atol(minstr.GetString())*1024*1024; 
		if ((max>0)||(min>0)) // DonGato
		{ 
			if (max==0) 
				max=2147483646; // max file size 
			buffer = 0;   data->Write(&buffer,1);	buffer = 0;   data->Write(&buffer,1);       
			buffer = 0;   data->Write(&buffer,1);	buffer = 0;   data->Write(&buffer,1); 
			buffer = 0;   data->Write(&buffer,1);	buffer = 0;   data->Write(&buffer,1); 
			buffer = 1;   data->Write(&buffer,1);    
			size = GetDlgItem(IDC_SEARCHNAME)->GetWindowTextLength(); 
			data->Write(&size,2); 
			char* searchstr = new char[size+1]; 
			GetDlgItem(IDC_SEARCHNAME)->GetWindowText(searchstr,size+1); 
			data->Write(searchstr,size); 
			delete[] searchstr; 
			buffer = 2;   data->Write(&buffer,1);    
			type.Format(""); // you could filter here by a file extension(ex "mp3") 
			size=type.GetLength(); 
			cadena=type.GetBuffer(); 
			data->Write(&size,2);data->Write(cadena,size); 

			buffer = 1;   data->Write(&buffer,1);	buffer = 0;   data->Write(&buffer,1); 
			buffer = 4;   data->Write(&buffer,1);	buffer = 3;   data->Write(&buffer,1); 
			data->Write(&min,4); 
			buffer = 1;   data->Write(&buffer,1);   buffer = 1;   data->Write(&buffer,1);    
			buffer = 0;   data->Write(&buffer,1);    
			buffer = 2;   data->Write(&buffer,1);   buffer = 3;   data->Write(&buffer,1);    
			data->Write(&max,4); 
			buffer = 2;   data->Write(&buffer,1);   buffer = 1;   data->Write(&buffer,1);    
			buffer = 0;   data->Write(&buffer,1);   buffer = 2;   data->Write(&buffer,1);    
		} else { 
			if (GetResString(IDS_SEARCH_AUDIO)==typeText) type.Format("Audio"); 
			if (GetResString(IDS_SEARCH_VIDEO)==typeText) type.Format("Video"); 
			//emule servers does not differentiate between Archives and programs 
			if (GetResString(IDS_SEARCH_ARC)==typeText) type.Format("Pro"); 
			if (GetResString(IDS_SEARCH_PRG)==typeText) type.Format("Pro"); 
			if (GetResString(IDS_SEARCH_PICS)==typeText) type.Format("Image"); 
	          
			if (type.GetLength()>0) 
			{//Edonkey server filtered search for audio, video, images or programs (programs and archives) 
				buffer = 0;   data->Write(&buffer,1);       
				buffer = 0;   data->Write(&buffer,1);       
				buffer = 1;   data->Write(&buffer,1);    
				size = GetDlgItem(IDC_SEARCHNAME)->GetWindowTextLength(); 
				data->Write(&size,2); 
				char* searchstr = new char[size+1]; 
				GetDlgItem(IDC_SEARCHNAME)->GetWindowText(searchstr,size+1); 
				data->Write(searchstr,size); 
				buffer = 2;   data->Write(&buffer,1);    
				size=type.GetLength(); 
				data->Write(&size,2); 
				cadena=type.GetBuffer(); 
				data->Write(cadena,size); 
				buffer = 1;   data->Write(&buffer,1);       
				buffer = 0;   data->Write(&buffer,1);       
				buffer = 3;   data->Write(&buffer,1);          
				delete[] searchstr; 
			} 
			else if (GetResString(IDS_SEARCH_USER) == typeText)
			{// Seach user
				buffer = 1; data->Write(&buffer, 1);
				size = GetDlgItem(IDC_SEARCHNAME)->GetWindowTextLength();
				data->Write(&size, 2);
				char* searchstr = new char [size + 1];
				GetDlgItem(IDC_SEARCHNAME)->GetWindowText(searchstr, (size + 1));
				data->Write(searchstr, size);
				delete [] searchstr;
			}
			else 
			{// Search for any type or other edonkey client filtered search 
				buffer = 1; // hmmmmmm 
				data->Write(&buffer,1);
				size = GetDlgItem(IDC_SEARCHNAME)->GetWindowTextLength(); 
				data->Write(&size,2); 
				char* searchstr = new char[size+1]; 
				GetDlgItem(IDC_SEARCHNAME)->GetWindowText(searchstr,size+1); 
				data->Write(searchstr,size); 
				delete[] searchstr; 
			} 
		} 

		Packet* packet = new Packet(data);
		if (GetResString(IDS_SEARCH_USER) == typeText)
		{
			packet->opcode = OP_SEARCHUSER;
		} else {
			packet->opcode = OP_SEARCHREQUEST;
		}
		delete data;
		theApp.serverconnect->SendPacket(packet,false);
		if (IsDlgButtonChecked(IDC_SGLOBAL))
		{
			if( theApp.glob_prefs->Score() )
			{
				theApp.serverlist->ResetSearchServerPos();
			}
			searchpacket = packet;
			searchpacket->opcode = OP_GLOBSEARCHREQ;
			servercount = 0;
			searchprogress.SetRange32(0,theApp.serverlist->GetServerCount()-1);
			globsearch = true;
		}
		else
		{
			globsearch = false;
			delete packet;
		}
		CreateNewTab(searchString,m_nSearchID);
	}
}
*/

a707 3



@


1.5
log
@Minor changes to the interface and in the translations
@
text
@d523 1
a523 1
		theApp.uploadqueue->AddUpDataOverheadServer(packet->size, 0);
@


1.4
log
@Merge from plus26based branch (without new sockets code yet)
@
text
@d338 2
a339 1

@


1.3
log
@Localized the Reset Button using IDS_PW_RESET string
@
text
@a337 1
	GetDlgItem(IDC_SEARCH_RESET)->SetWindowText(GetResString(IDS_PW_RESET)); //9-2-03 EC
d419 2
d522 1
@


1.2
log
@stopped files bugfix & updated search dialog
@
text
@d338 1
@


1.2.2.1
log
@initial upgrade to .26
@
text
@a418 2
		if ( searchString.GetLength()==0 && extension.GetLength()==0) return;

a519 1
		theApp.uploadqueue->AddUpDataOverheadServer(packet->size, 0);
@


1.1
log
@*** empty log message ***
@
text
@d126 5
d250 6
a255 1
	   else if (pMsg->hwnd == GetDlgItem(IDC_SEARCHNAME)->m_hWnd)
a332 2
	GetDlgItem(IDC_SEARCHMINSIZE)->SetWindowText(GetResString(IDS_SEARCHMINSIZE));
	GetDlgItem(IDC_SEARCHMAXSIZE)->SetWindowText(GetResString(IDS_SEARCHMAXSIZE));
d334 6
a339 1
	while(typebox.GetCount() > 0) 
d366 180
d561 12
d697 1
d730 2
d776 2
d805 13
d867 2
@


1.1.4.1
log
@updating this branch...
@
text
@@

