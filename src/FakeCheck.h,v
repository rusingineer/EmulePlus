head	1.15;
access;
symbols
	PublicRelease_1_2e:1.14
	Interim_Release_1-2e_RC1:1.14
	PublicRelease_1_2d:1.14
	Interim_Release_1-2d_RC1:1.14
	Interim_Release_1-2d_beta1:1.13
	PublicRelease_1_2c:1.11
	Interim_Release_1-2c_RC1:1.11
	Interim_Release_1-2c_beta1:1.11
	PublicRelease_1_2b:1.11
	Interim_Release_1-2b_RC1:1.11
	PublicRelease_1_2a:1.11
	Interim_Release_1-2a_RC1:1.11
	Interim_Release_1-2a_beta2:1.11
	Interim_Release_1-2a_beta1:1.10
	PublicRelease_1_2:1.10
	Interim_Release_1-2_RC1:1.10
	Interim_Release_1-2_beta1:1.10
	PublicRelease_1_1g:1.9
	Interim_Release_1-1g_RC3:1.9
	Interim_Release_1-1g_RC2:1.9
	Interim_Release_1-1g_RC1:1.9
	Interim_Release_1-1g_beta2:1.9
	Interim_Release_1-1g_beta1:1.8
	PublicRelease_1_1f:1.8
	Interim_Release_1-1f_RC1:1.8
	PublicRelease_1_1e:1.8
	Interim_Release_1-1e_RC2:1.8
	Interim_Release_1-1e_RC1:1.8
	Interim_Release_1-1e_beta1:1.8
	PublicRelease_1_1d:1.8
	Interim_Release_1-1d_RC1:1.8
	PublicRelease_1_1c:1.8
	Interim_Release_1-1c_RC1:1.8
	Interim_Release_1-1c_beta2:1.8
	Interim_Release_1-1c_beta1:1.8
	PublicRelease_1_1b:1.7
	Interim_Release_1-1b_RC1:1.7
	PublicRelease_1_1a:1.7
	Interim_Release_1-1a_RC2:1.7
	Interim_Release_1-1a_RC1:1.7
	Interim_Release_1-1a_beta2:1.7
	Interim_Release_1-1a_beta1:1.7
	PublicRelease_1_1:1.6
	Interim_Release_1-1_beta1:1.6
	PublicRelease_1o:1.6
	Interim_Release_1o_RC1:1.6
	Interim_Release_1o_beta1:1.6
	PublicRelease_1n:1.6
	Interim_Release_1n_RC2:1.6
	Interim_Release_1n_RC1:1.6
	Interim_Release_1n_beta2:1.6
	Interim_Release_1n_beta1:1.6
	PublicRelease_1m:1.6
	Interim_Release_1m_beta1:1.6
	PublicRelease_1l:1.6
	Interim_Release_1l_RC3:1.6
	Interim_Release_1l_RC2:1.6
	Interim_Release_1l_RC1:1.5
	Interim_Release_1l_beta2:1.5
	Interim_Release_1l_beta1:1.5
	PublicRelease_1k:1.4
	Interim_Release_1k_RC4:1.4
	Interim_1k_RC3:1.4
	Interim_1k_RC2:1.4
	Interim_Release_1k_RC1:1.3
	Interim_Release_1k_beta5:1.3
	Intrerim_Release_1k_beta4:1.3
	Interim_Release_1k_beta1:1.2
	PublicRelease_1j:1.2
	Interim_Release_1J_RC3:1.2
	Interim_Release_1j_RC3:1.2
	Interim_Release_1j_RC2:1.2
	Interim_Release_1j_RC1:1.2
	Interim_Release_1j_beta2:1.2
	Interim_Release_1j_beta1:1.2
	PublicRelease_1i:1.2
	Interim_Release_1i_RC6:1.2
	Interim_Release_1i_RC3:1.2
	Interim_Release_1i_RC2:1.2
	Interim_Release_1i_RC1:1.2
	Interim_Release_1i_beta3:1.2
	Interim_Release_1i_beta2:1.2;
locks; strict;
comment	@ * @;


1.15
date	2009.08.01.01.45.19;	author aw3;	state Exp;
branches;
next	1.14;

1.14
date	2008.03.03.05.22.35;	author aw3;	state Exp;
branches;
next	1.13;

1.13
date	2007.12.28.09.48.50;	author eklmn;	state Exp;
branches;
next	1.12;

1.12
date	2007.11.12.23.52.20;	author fuxie-dk;	state Exp;
branches;
next	1.11;

1.11
date	2006.05.22.03.44.59;	author aw3;	state Exp;
branches;
next	1.10;

1.10
date	2006.01.06.20.05.54;	author kush_eplus;	state Exp;
branches;
next	1.9;

1.9
date	2005.09.26.05.15.57;	author aw3;	state Exp;
branches;
next	1.8;

1.8
date	2005.01.19.14.02.28;	author kush_eplus;	state Exp;
branches;
next	1.7;

1.7
date	2004.11.02.17.19.00;	author aw3;	state Exp;
branches;
next	1.6;

1.6
date	2004.05.29.12.30.21;	author dropf;	state Exp;
branches;
next	1.5;

1.5
date	2004.05.04.14.45.23;	author dropf;	state Exp;
branches;
next	1.4;

1.4
date	2004.03.28.13.44.07;	author dropf;	state Exp;
branches;
next	1.3;

1.3
date	2004.03.03.21.45.23;	author dropf;	state Exp;
branches;
next	1.2;

1.2
date	2003.10.20.10.35.19;	author morevit;	state Exp;
branches;
next	1.1;

1.1
date	2003.10.06.21.57.06;	author puritynn666;	state Exp;
branches;
next	;


desc
@@


1.15
log
@Reduced H-file dependency.
@
text
@//	This file is part of eMule Plus
//
//	This program is free software; you can redistribute it and/or
//	modify it under the terms of the GNU General Public License
//	as published by the Free Software Foundation; either
//	version 2 of the License, or (at your option) any later version.
//
//	This program is distributed in the hope that it will be useful,
//	but WITHOUT ANY WARRANTY; without even the implied warranty of
//	MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
//	GNU General Public License for more details.
//
//	You should have received a copy of the GNU General Public License
//	along with this program; if not, write to the Free Software
//	Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.

//	General idea based on eMule Morph's CFakecheck
#pragma once

#pragma warning(push)
#pragma warning(disable:4702) // unreachable code
#include <map>
#pragma warning(pop)

/////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////
//	From unrar.h (http://www.rarlab.com/rar/UnRARDLL.exe)
//	for fakes.rar support

#define ERAR_END_ARCHIVE     10
#define ERAR_NO_MEMORY       11
#define ERAR_BAD_DATA        12
#define ERAR_BAD_ARCHIVE     13
#define ERAR_UNKNOWN_FORMAT  14
#define ERAR_EOPEN           15
#define ERAR_ECREATE         16
#define ERAR_ECLOSE          17
#define ERAR_EREAD           18
#define ERAR_EWRITE          19
#define ERAR_SMALL_BUF       20
#define ERAR_UNKNOWN         21

#define RAR_OM_LIST           0
#define RAR_OM_EXTRACT        1

#define RAR_SKIP              0
#define RAR_TEST              1
#define RAR_EXTRACT           2

#define RAR_VOL_ASK           0
#define RAR_VOL_NOTIFY        1

#define RAR_DLL_VERSION       4

#pragma pack(1)
struct RARHeaderData
{
	char         ArcName[260];
	char         FileName[260];
	unsigned int Flags;
	unsigned int PackSize;
	unsigned int UnpSize;
	unsigned int HostOS;
	unsigned int FileCRC;
	unsigned int FileTime;
	unsigned int UnpVer;
	unsigned int Method;
	unsigned int FileAttr;
	char         *CmtBuf;
	unsigned int CmtBufSize;
	unsigned int CmtSize;
	unsigned int CmtState;
};

struct RAROpenArchiveDataEx
{
	const char   *ArcName;
	const wchar_t *ArcNameW;
	unsigned int OpenMode;
	unsigned int OpenResult;
	char         *CmtBuf;
	unsigned int CmtBufSize;
	unsigned int CmtSize;
	unsigned int CmtState;
	unsigned int Flags;
	unsigned int Reserved[32];
};
#pragma pack()

/////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////

typedef std::map<CString, CString>	_mapFakeMap;

class CFakeCheck
{
public:
	CFakeCheck();
	~CFakeCheck();

	void	Init(void);
	INT		LoadFromDatFile();
	void	GetFakeComment(const CString &strFileHash, const uint64 qwFileLenght, CString *pstrComment);
	BOOL	UpdateFakeList();
	BOOL	ExtractRARArchive(const CString &strArchivePath, CString strDestFolder);

private:
	bool	AddFake(const CString &strHash, const CString &strLenght, const CString &strRealTitle);
	void	RemoveAllFakes();
	BOOL	RetrieveFakesDotTxt(OUT uint32 &dwVersion, OUT CString &strED2KLink);

	void	OutOpenArchiveError(int iError, const CString& strArchivePath);
	void	OutProcessFileError(int iError);

	_mapFakeMap	m_mapFakeMap;

//	RAR support
	HANDLE	(WINAPI *pfnRAROpenArchiveEx)(RAROpenArchiveDataEx *pArchiveData);
	int		(WINAPI *pfnRARCloseArchive)(HANDLE hArcData);
	int		(WINAPI *pfnRARReadHeader)(HANDLE hArcData, RARHeaderData *pHeaderData);
	int		(WINAPI *pfnRARProcessFile)(HANDLE hArcData, int iOperation, LPTSTR strDestFolder, char* strDestName);
};

/////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////
@


1.14
log
@Removed namespace usage.
@
text
@d18 1
a19 3
#pragma once
#include "types.h"
#include "ListenSocket.h"
@


1.13
log
@1) renamed GetFakeCheckComment() into GetFakeComment()
2) GetFakeComment() returns the string over parameter
3) removed LastHit interface
@
text
@d95 1
a95 3
using namespace std;

typedef map<CString, CString>	_mapFakeMap;
@


1.12
log
@Suppressed compiler warnings [KuSh/Aw3].
@
text
@d107 1
a107 2
	CString	GetLastHit()		{ return m_strLastHit; }
	CString	GetFakeCheckComment(const CString &strFileHash, const uint64 qwFileLenght);
a118 1
	CString		m_strLastHit;
@


1.11
log
@Large file size support preparations.
@
text
@d22 2
d25 1
@


1.10
log
@UNICODE preparation (first shot)
@
text
@d105 1
a105 1
	CString	GetFakeCheckComment(const CString &strFileHash, const uint32 dwFileLenght);
@


1.9
log
@Improved string processing.
@
text
@d124 1
a124 1
	int		(WINAPI *pfnRARProcessFile)(HANDLE hArcData, int iOperation, char* strDestFolder, char* strDestName);
@


1.8
log
@Fully reworked class :
Changed class name to CFakeCheck
Optimised code
Loads current fakelist until new one is downloaded
Handles files with same hash but different lengths
Doesn't count double entries in fakelist
@
text
@d76 2
a77 2
	char         *ArcName;
	wchar_t      *ArcNameW;
d104 1
a104 1
	CString GetLastHit()		{ return m_strLastHit; }
d107 1
a107 1
	BOOL	ExtractRARArchive(CString strArchivePath, CString strDestFolder);
d121 4
a124 4
	HANDLE (WINAPI *pfnRAROpenArchiveEx)(RAROpenArchiveDataEx *pArchiveData);
	int    (WINAPI *pfnRARCloseArchive)(HANDLE hArcData);
	int    (WINAPI *pfnRARReadHeader)(HANDLE hArcData, RARHeaderData *pHeaderData);
	int    (WINAPI *pfnRARProcessFile)(HANDLE hArcData, int iOperation, char* strDestFolder, char* strDestName);
d128 1
a128 1
/////////////////////////////////////////////////////////////////////////////////////////////@


1.7
log
@Improved string processing.
@
text
@d1 1
a1 2
//this file is part of eMule
//Copyright (C)2002 Merkur ( merkur-@@users.sourceforge.net / http://www.emule-project.net )
d3 4
a6 4
//This program is free software; you can redistribute it and/or
//modify it under the terms of the GNU General Public License
//as published by the Free Software Foundation; either
//version 2 of the License, or (at your option) any later version.
d8 4
a11 4
//This program is distributed in the hope that it will be useful,
//but WITHOUT ANY WARRANTY; without even the implied warranty of
//MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
//GNU General Public License for more details.
d13 3
a15 3
//You should have received a copy of the GNU General Public License
//along with this program; if not, write to the Free Software
//Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
d17 1
a17 4

/******************************************************************
 *                 FakeCheck Based on eMule Morph                 *
 ******************************************************************/
d21 1
a21 1
#include "listensocket.h"
d26 2
a27 2
// From unrar.h (http://www.rarlab.com/rar/UnRARDLL.exe)
// for fakes.rar support
d54 1
d87 1
d94 1
a94 6
struct Fakes_Struct{
   CString			Hash;
   uint32			Lenght;
   CString			RealTitle;
   ~Fakes_Struct() {  }
};
d96 12
a107 1
typedef std::map<CString,Fakes_Struct*>	FakeMap;
a108 2
class CFakecheck
{
d110 1
a110 4
	CString	m_sLastHit;
	FakeMap	m_mapFakes;

	void	AddFake(CString Hash,uint32 Lenght,CString Realtitle);
d112 1
a112 7

//
//	RAR support
	HANDLE (WINAPI *pfnRAROpenArchiveEx)(struct RAROpenArchiveDataEx* ArchiveData);
	int    (WINAPI *pfnRARCloseArchive)(HANDLE hArcData);
	int    (WINAPI *pfnRARReadHeader)(HANDLE hArcData, struct RARHeaderData* HeaderData);
	int    (WINAPI *pfnRARProcessFile)(HANDLE hArcData, int iOperation, char* strDestFolder, char* strDestName);
a115 1
	BOOL	RetrieveFakesDotTxt(OUT uint32& rdwVersion, OUT CString& rstrED2KLink);
d117 2
a118 3
public:
	CFakecheck();
	~CFakecheck();
d120 5
a124 6
	void	Init(void);
	INT		LoadFromDatFile();
	CString GetLastHit() { return m_sLastHit;}
	CString	GetFakeCheckComment(const CString &Hash2test, uint32 lenght);
	BOOL	UpdateFakeList();
	BOOL	ExtractRARArchive(CString strArchivePath, CString strDestFolder);
d128 1
a128 1
/////////////////////////////////////////////////////////////////////////////////////////////
@


1.6
log
@the fakelist wasn't reloaded after update
@
text
@d132 1
a132 1
	CString	GetFakeCheckComment(CString Hash2test, uint32 lenght);
@


1.5
log
@new FakeCheck autoupdate system
@
text
@a112 1
	INT		LoadFromDatFile();
d130 1
@


1.4
log
@Some optimizations/corrections + Bugfix: fakes.dat weren't properly extrated to a folder which name should contain charaters such as 'é', 'è', 'ê', 'â', etc. This bugfix should be tested.
@
text
@d120 1
a120 1
	int    (WINAPI *pfnRARProcessFile)(HANDLE hArcData, int iOperation, char* strDestPath, char* strDestName);
d122 1
a122 2
	BOOL	ExtractArchive(CString strArchiveName, CString strDestFolder);
	void	OutOpenArchiveError(int iError, CString strArchiveName);
d124 1
d130 1
d133 2
a134 1
	BOOL	DownloadFakeList();
@


1.3
log
@improved fakelist download, and added fakes.rar file support
@
text
@d117 1
a117 1
	HANDLE (WINAPI *pfnRAROpenArchiveEx)(struct RAROpenArchiveDataEx *ArchiveData);
d119 1
a119 1
	int    (WINAPI *pfnRARReadHeader)(HANDLE hArcData, struct RARHeaderData *HeaderData);
d122 2
a123 2
	BOOL	ExtractArchive(char* strArchiveName, char* strDestFolder);
	void	OutOpenArchiveError(int iError, char* strArchiveName);
@


1.2
log
@Fixed a memory leak in AddFake().
@
text
@d20 1
a20 2
 *               Based on eMule v0.29c MorphNext 1c               *
 *                      Adaptation by DropF                       *
a22 1

d28 66
d107 19
d129 4
a132 9
	void	AddFake(CString Hash,uint32 Lenght,CString Realtitle);
	void	RemoveAllFakes();
	int		LoadFromDatFile();
	CString	IsFake(CString Hash2test, uint32 lenght);
	bool	DownloadFakeList();
private:
	CString m_sLastHit;
	//CMutex m_Mutex;
	FakeMap		m_mapFakes;
d134 3
@


1.1
log
@FakeCheck for Search Result and Download List (Check and Report ... made by milobac ... merged by DropF ... tested by n@@boleo and me)
@
text
@d39 2
d54 1
a54 1
	std::map<CString,Fakes_Struct*> m_FakeList;
@

