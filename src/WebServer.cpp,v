head	1.443;
access;
symbols
	PublicRelease_1_2e:1.438
	Interim_Release_1-2e_RC1:1.437
	PublicRelease_1_2d:1.425
	Interim_Release_1-2d_RC1:1.424
	Interim_Release_1-2d_beta1:1.423
	PublicRelease_1_2c:1.411
	Interim_Release_1-2c_RC1:1.411
	Interim_Release_1-2c_beta1:1.404
	PublicRelease_1_2b:1.402
	Interim_Release_1-2b_RC1:1.402
	PublicRelease_1_2a:1.402
	Interim_Release_1-2a_RC1:1.401
	Interim_Release_1-2a_beta2:1.393
	Interim_Release_1-2a_beta1:1.392
	PublicRelease_1_2:1.385
	Interim_Release_1-2_RC1:1.385
	Interim_Release_1-2_beta1:1.362
	PublicRelease_1_1g:1.346
	Interim_Release_1-1g_RC3:1.346
	Interim_Release_1-1g_RC2:1.344
	Interim_Release_1-1g_RC1:1.342
	Interim_Release_1-1g_beta2:1.337
	Interim_Release_1-1g_beta1:1.333
	PublicRelease_1_1f:1.328
	Interim_Release_1-1f_RC1:1.328
	PublicRelease_1_1e:1.325
	Interim_Release_1-1e_RC2:1.324
	Interim_Release_1-1e_RC1:1.322
	Interim_Release_1-1e_beta1:1.319
	PublicRelease_1_1d:1.316
	Interim_Release_1-1d_RC1:1.316
	PublicRelease_1_1c:1.313
	Interim_Release_1-1c_RC1:1.313
	Interim_Release_1-1c_beta2:1.313
	Interim_Release_1-1c_beta1:1.312
	PublicRelease_1_1b:1.310
	Interim_Release_1-1b_RC1:1.310
	PublicRelease_1_1a:1.307
	Interim_Release_1-1a_RC2:1.306
	Interim_Release_1-1a_RC1:1.305
	Interim_Release_1-1a_beta2:1.305
	Interim_Release_1-1a_beta1:1.303
	PublicRelease_1_1:1.299
	Interim_Release_1-1_beta1:1.299
	PublicRelease_1o:1.290
	Interim_Release_1o_RC1:1.290
	Interim_Release_1o_beta1:1.289
	PublicRelease_1n:1.286
	Interim_Release_1n_RC2:1.286
	Interim_Release_1n_RC1:1.286
	Interim_Release_1n_beta2:1.282
	Interim_Release_1n_beta1:1.279
	PublicRelease_1m:1.273
	Interim_Release_1m_beta1:1.273
	PublicRelease_1l:1.272
	Interim_Release_1l_RC3:1.272
	Interim_Release_1l_RC2:1.270
	Interim_Release_1l_RC1:1.269
	Interim_Release_1l_beta2:1.268
	Interim_Release_1l_beta1:1.264
	PublicRelease_1k:1.259
	Interim_Release_1k_RC4:1.259
	Interim_1k_RC3:1.259
	Interim_1k_RC2:1.258
	Interim_Release_1k_RC1:1.256
	Interim_Release_1k_beta5:1.251
	Intrerim_Release_1k_beta4:1.251
	Interim_Release_1k_beta1:1.246
	PublicRelease_1j:1.233
	Interim_Release_1J_RC3:1.233
	Interim_Release_1j_RC3:1.233
	Interim_Release_1j_RC2:1.229
	Interim_Release_1j_RC1:1.229
	Interim_Release_1j_beta2:1.229
	Interim_Release_1j_beta1:1.227
	PublicRelease_1i:1.221
	Interim_Release_1i_RC6:1.221
	Interim_Release_1i_RC3:1.220
	Interim_Release_1i_RC2:1.220
	Interim_Release_1i_RC1:1.213
	Interim_Release_1i_beta3:1.211
	Interim_Release_1i_beta2:1.206
	Interim_Release_1i_beta1:1.193
	PublicRelease_1h:1.165
	Interim_Release_1h_rc2:1.163
	Interim_Release_1h_RC1:1.159
	Interim_Release_1h_beta2:1.141
	Interim_Release_1h_beta1_now:1.126
	Interim_Release_1h_beta1:1.126
	PublicRelease_1g:1.116
	Interim_Release_1g_RC6_Final:1.116
	Interim_Release_1g_RC6:1.107
	Interim_Release_1g_RC5:1.106
	Interim_Release_1g_RC4:1.92
	Interim_Release_1g_RC3:1.79
	Interim_Release_1g_beta2:1.49
	Interim_Release_1g_beta1:1.41
	Interim_Release_1f_RC4:1.39
	Interim_Release_1f_RC3:1.37
	Interim_Release_1f_RC2:1.36
	Interim_Release_1f_RC:1.35
	Interim_Release_1f_beta2:1.33
	Interim_Release_1f_beta1:1.32
	PublicRelease_1e:1.29
	Interim_Release_1e_RC2:1.29
	Interim_Release_1e_RC:1.28
	Interim_Release_1e_beta3:1.28
	Interim_Release_1e_beta2:1.28
	Interim_Release_1e_beta2_before_kuchin:1.27
	Interim_Release_1e_beta1:1.24
	PublicRelease_1c:1.22
	featurestest:1.22.0.2
	Interim_Release_1c_RC:1.22
	Interim_Release_1c_beta2:1.21
	Interim_Release_1c_beta1:1.20
	threaded_downloadqueue:1.20.0.2
	PublicRelease_1b:1.17
	Interim_Release_1b_beta2:1.17
	Interim_Release_1b_beta1:1.15
	proxydeadlake:1.15.0.4
	PublicRelease_1a:1.15
	Interim_Release_1a_beta2:1.15
	BerkeleyDb:1.15.0.2
	Interim_Release_1a_beta1:1.15
	PublicRelease_1:1.15
	goldfish:1.15
	eMulePlus_1_RC2:1.13
	eMulePlus_26b_1RC1:1.11
	PreRelease_26b_i0e:1.11
	before_26d_merge:1.8
	Interim_Release_26b_i0d:1.5
	Interim_Release_26b_i0c:1.4
	Interim_Release_26b_i0b:1.4
	Interim_Release_26b_i0a:1.4
	systraydlg:1.2.0.6
	plus26based:1.2.0.4
	Interim_Release_25b_i0b:1.2
	Proxy_Dev:1.2
	Interim_Release_25b_i0a:1.2.2.1
	proxytest:1.2.2.1.0.2
	official_sockets:1.2.0.2
	eMulePlus_024b_5b:1.1.0.2;
locks; strict;
comment	@// @;


1.443
date	2009.10.30.01.59.03;	author aw3;	state Exp;
branches;
next	1.442;

1.442
date	2009.10.28.04.24.39;	author aw3;	state Exp;
branches;
next	1.441;

1.441
date	2009.08.01.01.45.19;	author aw3;	state Exp;
branches;
next	1.440;

1.440
date	2009.07.14.03.54.08;	author aw3;	state Exp;
branches;
next	1.439;

1.439
date	2009.04.29.02.52.00;	author aw3;	state Exp;
branches;
next	1.438;

1.438
date	2009.04.08.04.05.38;	author aw3;	state Exp;
branches;
next	1.437;

1.437
date	2009.03.06.06.08.26;	author aw3;	state Exp;
branches;
next	1.436;

1.436
date	2009.01.20.03.27.51;	author aw3;	state Exp;
branches;
next	1.435;

1.435
date	2008.11.24.03.13.33;	author aw3;	state Exp;
branches;
next	1.434;

1.434
date	2008.11.19.14.00.26;	author aw3;	state Exp;
branches;
next	1.433;

1.433
date	2008.11.12.03.52.08;	author aw3;	state Exp;
branches;
next	1.432;

1.432
date	2008.11.03.05.45.24;	author aw3;	state Exp;
branches;
next	1.431;

1.431
date	2008.10.28.02.41.52;	author aw3;	state Exp;
branches;
next	1.430;

1.430
date	2008.09.30.04.28.51;	author aw3;	state Exp;
branches;
next	1.429;

1.429
date	2008.07.31.12.07.25;	author aw3;	state Exp;
branches;
next	1.428;

1.428
date	2008.07.24.04.59.42;	author aw3;	state Exp;
branches;
next	1.427;

1.427
date	2008.06.29.04.13.11;	author aw3;	state Exp;
branches;
next	1.426;

1.426
date	2008.06.27.02.08.10;	author aw3;	state Exp;
branches;
next	1.425;

1.425
date	2008.04.27.02.50.47;	author aw3;	state Exp;
branches;
next	1.424;

1.424
date	2008.03.03.05.19.15;	author aw3;	state Exp;
branches;
next	1.423;

1.423
date	2008.02.09.12.29.30;	author eklmn;	state Exp;
branches;
next	1.422;

1.422
date	2008.01.31.22.50.31;	author eklmn;	state Exp;
branches;
next	1.421;

1.421
date	2007.12.28.09.48.50;	author eklmn;	state Exp;
branches;
next	1.420;

1.420
date	2007.12.27.21.04.00;	author aw3;	state Exp;
branches;
next	1.419;

1.419
date	2007.12.23.17.50.11;	author aw3;	state Exp;
branches;
next	1.418;

1.418
date	2007.12.05.22.18.24;	author eklmn;	state Exp;
branches;
next	1.417;

1.417
date	2007.11.17.05.20.26;	author aw3;	state Exp;
branches;
next	1.416;

1.416
date	2007.11.12.23.49.25;	author fuxie-dk;	state Exp;
branches;
next	1.415;

1.415
date	2007.10.31.18.14.40;	author fuxie-dk;	state Exp;
branches;
next	1.414;

1.414
date	2007.10.24.19.07.52;	author fuxie-dk;	state Exp;
branches;
next	1.413;

1.413
date	2007.10.18.14.48.51;	author fuxie-dk;	state Exp;
branches;
next	1.412;

1.412
date	2007.09.27.14.29.14;	author fuxie-dk;	state Exp;
branches;
next	1.411;

1.411
date	2007.07.27.06.21.21;	author aw3;	state Exp;
branches;
next	1.410;

1.410
date	2007.07.07.04.07.37;	author aw3;	state Exp;
branches;
next	1.409;

1.409
date	2007.06.07.04.30.07;	author aw3;	state Exp;
branches;
next	1.408;

1.408
date	2007.05.01.03.43.35;	author aw3;	state Exp;
branches;
next	1.407;

1.407
date	2007.04.25.04.46.51;	author aw3;	state Exp;
branches;
next	1.406;

1.406
date	2007.04.14.04.21.08;	author aw3;	state Exp;
branches;
next	1.405;

1.405
date	2007.03.19.19.39.03;	author kush_eplus;	state Exp;
branches;
next	1.404;

1.404
date	2007.02.19.03.41.21;	author aw3;	state Exp;
branches;
next	1.403;

1.403
date	2007.02.17.05.48.45;	author aw3;	state Exp;
branches;
next	1.402;

1.402
date	2006.10.04.05.08.36;	author aw3;	state Exp;
branches;
next	1.401;

1.401
date	2006.09.06.05.54.41;	author aw3;	state Exp;
branches;
next	1.400;

1.400
date	2006.09.04.18.31.55;	author aw3;	state Exp;
branches;
next	1.399;

1.399
date	2006.08.14.02.38.45;	author aw3;	state Exp;
branches;
next	1.398;

1.398
date	2006.08.01.04.22.24;	author aw3;	state Exp;
branches;
next	1.397;

1.397
date	2006.07.31.03.51.33;	author aw3;	state Exp;
branches;
next	1.396;

1.396
date	2006.07.29.01.55.18;	author aw3;	state Exp;
branches;
next	1.395;

1.395
date	2006.07.25.04.27.30;	author aw3;	state Exp;
branches;
next	1.394;

1.394
date	2006.07.21.00.38.24;	author aw3;	state Exp;
branches;
next	1.393;

1.393
date	2006.05.21.06.12.48;	author aw3;	state Exp;
branches;
next	1.392;

1.392
date	2006.04.26.11.57.28;	author aw3;	state Exp;
branches;
next	1.391;

1.391
date	2006.04.20.02.23.31;	author aw3;	state Exp;
branches;
next	1.390;

1.390
date	2006.04.10.03.59.28;	author aw3;	state Exp;
branches;
next	1.389;

1.389
date	2006.04.09.15.18.10;	author kush_eplus;	state Exp;
branches;
next	1.388;

1.388
date	2006.04.04.22.28.40;	author kush_eplus;	state Exp;
branches;
next	1.387;

1.387
date	2006.03.27.03.49.35;	author aw3;	state Exp;
branches;
next	1.386;

1.386
date	2006.03.05.23.59.52;	author aw3;	state Exp;
branches;
next	1.385;

1.385
date	2006.02.19.18.30.57;	author aw3;	state Exp;
branches;
next	1.384;

1.384
date	2006.02.19.16.21.36;	author aw3;	state Exp;
branches;
next	1.383;

1.383
date	2006.02.16.18.04.45;	author kush_eplus;	state Exp;
branches;
next	1.382;

1.382
date	2006.02.14.13.44.41;	author dongato;	state Exp;
branches;
next	1.381;

1.381
date	2006.02.06.11.25.20;	author morphisthebrave;	state Exp;
branches;
next	1.380;

1.380
date	2006.02.05.17.53.50;	author aw3;	state Exp;
branches;
next	1.379;

1.379
date	2006.02.05.05.06.32;	author aw3;	state Exp;
branches;
next	1.378;

1.378
date	2006.02.05.00.00.21;	author aw3;	state Exp;
branches;
next	1.377;

1.377
date	2006.02.04.23.10.26;	author aw3;	state Exp;
branches;
next	1.376;

1.376
date	2006.02.04.20.07.38;	author morphisthebrave;	state Exp;
branches;
next	1.375;

1.375
date	2006.02.04.09.03.09;	author morphisthebrave;	state Exp;
branches;
next	1.374;

1.374
date	2006.02.04.08.49.04;	author morphisthebrave;	state Exp;
branches;
next	1.373;

1.373
date	2006.02.02.23.15.27;	author morphisthebrave;	state Exp;
branches;
next	1.372;

1.372
date	2006.02.02.09.19.39;	author morphisthebrave;	state Exp;
branches;
next	1.371;

1.371
date	2006.02.02.05.36.27;	author aw3;	state Exp;
branches;
next	1.370;

1.370
date	2006.02.01.23.24.40;	author dongato;	state Exp;
branches;
next	1.369;

1.369
date	2006.02.01.21.09.29;	author morphisthebrave;	state Exp;
branches;
next	1.368;

1.368
date	2006.02.01.20.04.49;	author morphisthebrave;	state Exp;
branches;
next	1.367;

1.367
date	2006.02.01.17.16.55;	author dongato;	state Exp;
branches;
next	1.366;

1.366
date	2006.01.31.13.55.44;	author dongato;	state Exp;
branches;
next	1.365;

1.365
date	2006.01.30.13.00.20;	author aw3;	state Exp;
branches;
next	1.364;

1.364
date	2006.01.30.08.49.48;	author morphisthebrave;	state Exp;
branches;
next	1.363;

1.363
date	2006.01.30.08.22.42;	author morphisthebrave;	state Exp;
branches;
next	1.362;

1.362
date	2006.01.30.03.30.35;	author aw3;	state Exp;
branches;
next	1.361;

1.361
date	2006.01.29.00.20.39;	author aw3;	state Exp;
branches;
next	1.360;

1.360
date	2006.01.25.05.35.24;	author aw3;	state Exp;
branches;
next	1.359;

1.359
date	2006.01.22.14.56.55;	author aw3;	state Exp;
branches;
next	1.358;

1.358
date	2006.01.21.20.29.41;	author aw3;	state Exp;
branches;
next	1.357;

1.357
date	2006.01.21.16.07.29;	author aw3;	state Exp;
branches;
next	1.356;

1.356
date	2006.01.21.10.45.38;	author morphisthebrave;	state Exp;
branches;
next	1.355;

1.355
date	2006.01.19.03.54.03;	author aw3;	state Exp;
branches;
next	1.354;

1.354
date	2006.01.16.01.41.15;	author kush_eplus;	state Exp;
branches;
next	1.353;

1.353
date	2006.01.15.17.20.52;	author aw3;	state Exp;
branches;
next	1.352;

1.352
date	2006.01.10.01.47.09;	author aw3;	state Exp;
branches;
next	1.351;

1.351
date	2006.01.06.20.05.55;	author kush_eplus;	state Exp;
branches;
next	1.350;

1.350
date	2006.01.03.12.44.56;	author aw3;	state Exp;
branches;
next	1.349;

1.349
date	2005.12.28.19.16.56;	author aw3;	state Exp;
branches;
next	1.348;

1.348
date	2005.12.26.14.40.32;	author dongato;	state Exp;
branches;
next	1.347;

1.347
date	2005.12.23.21.18.04;	author aw3;	state Exp;
branches;
next	1.346;

1.346
date	2005.12.12.04.02.58;	author aw3;	state Exp;
branches;
next	1.345;

1.345
date	2005.12.10.06.22.05;	author aw3;	state Exp;
branches;
next	1.344;

1.344
date	2005.12.04.22.16.12;	author aw3;	state Exp;
branches;
next	1.343;

1.343
date	2005.12.03.04.14.03;	author aw3;	state Exp;
branches;
next	1.342;

1.342
date	2005.12.01.05.27.08;	author aw3;	state Exp;
branches;
next	1.341;

1.341
date	2005.11.28.05.25.04;	author aw3;	state Exp;
branches;
next	1.340;

1.340
date	2005.11.28.03.11.13;	author aw3;	state Exp;
branches;
next	1.339;

1.339
date	2005.11.27.22.11.51;	author eklmn;	state Exp;
branches;
next	1.338;

1.338
date	2005.11.27.20.31.05;	author eklmn;	state Exp;
branches;
next	1.337;

1.337
date	2005.11.08.05.13.27;	author aw3;	state Exp;
branches;
next	1.336;

1.336
date	2005.11.07.02.31.07;	author aw3;	state Exp;
branches;
next	1.335;

1.335
date	2005.10.18.04.11.23;	author aw3;	state Exp;
branches;
next	1.334;

1.334
date	2005.08.29.03.08.32;	author aw3;	state Exp;
branches;
next	1.333;

1.333
date	2005.08.24.04.02.45;	author aw3;	state Exp;
branches;
next	1.332;

1.332
date	2005.08.21.17.58.39;	author aw3;	state Exp;
branches;
next	1.331;

1.331
date	2005.08.21.03.08.49;	author aw3;	state Exp;
branches;
next	1.330;

1.330
date	2005.08.20.04.30.31;	author aw3;	state Exp;
branches;
next	1.329;

1.329
date	2005.08.11.05.07.30;	author aw3;	state Exp;
branches;
next	1.328;

1.328
date	2005.07.14.01.08.17;	author syrus77;	state Exp;
branches;
next	1.327;

1.327
date	2005.07.13.01.27.55;	author aw3;	state Exp;
branches;
next	1.326;

1.326
date	2005.07.12.21.24.25;	author syrus77;	state Exp;
branches;
next	1.325;

1.325
date	2005.07.11.14.10.50;	author syrus77;	state Exp;
branches;
next	1.324;

1.324
date	2005.06.25.20.56.59;	author syrus77;	state Exp;
branches;
next	1.323;

1.323
date	2005.06.23.02.37.20;	author aw3;	state Exp;
branches;
next	1.322;

1.322
date	2005.06.19.05.09.53;	author aw3;	state Exp;
branches;
next	1.321;

1.321
date	2005.06.18.01.02.46;	author aw3;	state Exp;
branches;
next	1.320;

1.320
date	2005.06.09.00.21.54;	author aw3;	state Exp;
branches;
next	1.319;

1.319
date	2005.05.22.03.16.06;	author aw3;	state Exp;
branches;
next	1.318;

1.318
date	2005.04.09.02.35.29;	author aw3;	state Exp;
branches;
next	1.317;

1.317
date	2005.04.07.04.27.19;	author aw3;	state Exp;
branches;
next	1.316;

1.316
date	2005.03.04.14.21.11;	author dongato;	state Exp;
branches;
next	1.315;

1.315
date	2005.03.04.04.24.22;	author aw3;	state Exp;
branches;
next	1.314;

1.314
date	2005.03.03.13.56.56;	author dongato;	state Exp;
branches;
next	1.313;

1.313
date	2005.02.02.07.15.34;	author aw3;	state Exp;
branches;
next	1.312;

1.312
date	2005.01.23.13.58.01;	author aw3;	state Exp;
branches;
next	1.311;

1.311
date	2005.01.07.20.44.58;	author dongato;	state Exp;
branches;
next	1.310;

1.310
date	2004.12.19.22.12.04;	author aw3;	state Exp;
branches;
next	1.309;

1.309
date	2004.12.19.13.43.28;	author eklmn;	state Exp;
branches;
next	1.308;

1.308
date	2004.12.15.19.39.21;	author aw3;	state Exp;
branches;
next	1.307;

1.307
date	2004.12.10.05.56.04;	author aw3;	state Exp;
branches;
next	1.306;

1.306
date	2004.11.29.17.32.21;	author aw3;	state Exp;
branches;
next	1.305;

1.305
date	2004.11.14.21.37.18;	author aw3;	state Exp;
branches;
next	1.304;

1.304
date	2004.11.11.05.39.05;	author aw3;	state Exp;
branches;
next	1.303;

1.303
date	2004.11.08.00.28.42;	author aw3;	state Exp;
branches;
next	1.302;

1.302
date	2004.11.02.00.31.20;	author dongato;	state Exp;
branches;
next	1.301;

1.301
date	2004.10.28.04.25.27;	author aw3;	state Exp;
branches;
next	1.300;

1.300
date	2004.10.27.20.05.28;	author dongato;	state Exp;
branches;
next	1.299;

1.299
date	2004.10.16.04.31.45;	author aw3;	state Exp;
branches;
next	1.298;

1.298
date	2004.10.12.18.01.59;	author aw3;	state Exp;
branches;
next	1.297;

1.297
date	2004.10.12.16.35.20;	author dongato;	state Exp;
branches;
next	1.296;

1.296
date	2004.10.11.23.15.39;	author aw3;	state Exp;
branches;
next	1.295;

1.295
date	2004.10.10.19.55.12;	author aw3;	state Exp;
branches;
next	1.294;

1.294
date	2004.10.09.02.25.56;	author aw3;	state Exp;
branches;
next	1.293;

1.293
date	2004.10.08.04.51.51;	author aw3;	state Exp;
branches;
next	1.292;

1.292
date	2004.10.07.18.29.01;	author syrus77;	state Exp;
branches;
next	1.291;

1.291
date	2004.09.29.19.46.04;	author aw3;	state Exp;
branches;
next	1.290;

1.290
date	2004.09.25.07.16.27;	author aw3;	state Exp;
branches;
next	1.289;

1.289
date	2004.09.20.07.18.04;	author aw3;	state Exp;
branches;
next	1.288;

1.288
date	2004.09.14.23.31.16;	author aw3;	state Exp;
branches;
next	1.287;

1.287
date	2004.09.13.22.50.41;	author aw3;	state Exp;
branches;
next	1.286;

1.286
date	2004.08.26.06.42.18;	author aw3;	state Exp;
branches;
next	1.285;

1.285
date	2004.08.15.16.34.20;	author syrus77;	state Exp;
branches;
next	1.284;

1.284
date	2004.08.13.20.35.41;	author dongato;	state Exp;
branches;
next	1.283;

1.283
date	2004.08.12.21.54.12;	author eklmn;	state Exp;
branches;
next	1.282;

1.282
date	2004.08.06.17.00.46;	author eklmn;	state Exp;
branches;
next	1.281;

1.281
date	2004.08.05.21.41.24;	author aw3;	state Exp;
branches;
next	1.280;

1.280
date	2004.08.04.18.27.23;	author aw3;	state Exp;
branches;
next	1.279;

1.279
date	2004.07.17.12.13.20;	author dongato;	state Exp;
branches;
next	1.278;

1.278
date	2004.07.08.22.11.48;	author aw3;	state Exp;
branches;
next	1.277;

1.277
date	2004.07.05.23.23.42;	author dongato;	state Exp;
branches;
next	1.276;

1.276
date	2004.07.05.20.50.57;	author dongato;	state Exp;
branches;
next	1.275;

1.275
date	2004.07.04.23.33.15;	author dongato;	state Exp;
branches;
next	1.274;

1.274
date	2004.06.30.13.38.43;	author dongato;	state Exp;
branches;
next	1.273;

1.273
date	2004.06.15.05.05.47;	author katsyonak;	state Exp;
branches;
next	1.272;

1.272
date	2004.06.08.08.19.01;	author dongato;	state Exp;
branches;
next	1.271;

1.271
date	2004.06.07.19.01.39;	author dongato;	state Exp;
branches;
next	1.270;

1.270
date	2004.05.31.19.33.07;	author aw3;	state Exp;
branches;
next	1.269;

1.269
date	2004.05.22.20.04.52;	author dongato;	state Exp;
branches;
next	1.268;

1.268
date	2004.05.21.18.37.19;	author dongato;	state Exp;
branches;
next	1.267;

1.267
date	2004.05.17.19.35.14;	author dongato;	state Exp;
branches;
next	1.266;

1.266
date	2004.05.17.13.59.53;	author dongato;	state Exp;
branches;
next	1.265;

1.265
date	2004.05.14.22.49.43;	author dropf;	state Exp;
branches;
next	1.264;

1.264
date	2004.05.05.21.10.51;	author aw3;	state Exp;
branches;
next	1.263;

1.263
date	2004.05.04.14.45.24;	author dropf;	state Exp;
branches;
next	1.262;

1.262
date	2004.05.03.09.59.44;	author netwolf1;	state Exp;
branches;
next	1.261;

1.261
date	2004.04.30.09.06.13;	author katsyonak;	state Exp;
branches;
next	1.260;

1.260
date	2004.04.12.20.44.07;	author dongato;	state Exp;
branches;
next	1.259;

1.259
date	2004.04.04.13.19.48;	author syrus77;	state Exp;
branches;
next	1.258;

1.258
date	2004.03.31.08.05.10;	author eklmn;	state Exp;
branches;
next	1.257;

1.257
date	2004.03.30.20.55.49;	author dongato;	state Exp;
branches;
next	1.256;

1.256
date	2004.03.26.10.55.37;	author dongato;	state Exp;
branches;
next	1.255;

1.255
date	2004.03.25.20.22.12;	author aw3;	state Exp;
branches;
next	1.254;

1.254
date	2004.03.25.18.13.05;	author bavariansnail;	state Exp;
branches;
next	1.253;

1.253
date	2004.03.25.06.15.39;	author aw3;	state Exp;
branches;
next	1.252;

1.252
date	2004.03.24.18.14.59;	author dongato;	state Exp;
branches;
next	1.251;

1.251
date	2004.03.18.14.28.20;	author dongato;	state Exp;
branches;
next	1.250;

1.250
date	2004.03.14.21.10.12;	author aw3;	state Exp;
branches;
next	1.249;

1.249
date	2004.03.13.05.33.36;	author aw3;	state Exp;
branches;
next	1.248;

1.248
date	2004.03.12.11.10.20;	author eklmn;	state Exp;
branches;
next	1.247;

1.247
date	2004.03.03.21.45.23;	author dropf;	state Exp;
branches;
next	1.246;

1.246
date	2004.02.19.13.47.03;	author dongato;	state Exp;
branches;
next	1.245;

1.245
date	2004.02.18.23.20.55;	author kush_eplus;	state Exp;
branches;
next	1.244;

1.244
date	2004.02.18.20.13.40;	author dongato;	state Exp;
branches;
next	1.243;

1.243
date	2004.02.18.19.10.46;	author dongato;	state Exp;
branches;
next	1.242;

1.242
date	2004.02.18.16.25.11;	author kush_eplus;	state Exp;
branches;
next	1.241;

1.241
date	2004.02.17.22.02.51;	author aw3;	state Exp;
branches;
next	1.240;

1.240
date	2004.02.16.23.23.15;	author aw3;	state Exp;
branches;
next	1.239;

1.239
date	2004.02.15.11.55.58;	author morevit;	state Exp;
branches;
next	1.238;

1.238
date	2004.02.14.21.35.25;	author kush_eplus;	state Exp;
branches;
next	1.237;

1.237
date	2004.02.13.16.13.35;	author netwolf1;	state Exp;
branches;
next	1.236;

1.236
date	2004.02.07.00.50.46;	author netwolf1;	state Exp;
branches;
next	1.235;

1.235
date	2004.02.04.21.56.49;	author katsyonak;	state Exp;
branches;
next	1.234;

1.234
date	2004.02.02.14.27.13;	author dongato;	state Exp;
branches;
next	1.233;

1.233
date	2004.01.22.19.48.26;	author dongato;	state Exp;
branches;
next	1.232;

1.232
date	2004.01.22.04.26.03;	author katsyonak;	state Exp;
branches;
next	1.231;

1.231
date	2004.01.21.23.20.46;	author dongato;	state Exp;
branches;
next	1.230;

1.230
date	2004.01.15.01.59.13;	author katsyonak;	state Exp;
branches;
next	1.229;

1.229
date	2004.01.05.23.47.55;	author dongato;	state Exp;
branches;
next	1.228;

1.228
date	2004.01.01.07.31.06;	author katsyonak;	state Exp;
branches;
next	1.227;

1.227
date	2003.12.24.01.21.14;	author katsyonak;	state Exp;
branches;
next	1.226;

1.226
date	2003.12.23.19.03.21;	author katsyonak;	state Exp;
branches;
next	1.225;

1.225
date	2003.12.23.15.35.17;	author katsyonak;	state Exp;
branches;
next	1.224;

1.224
date	2003.12.22.15.44.11;	author dongato;	state Exp;
branches;
next	1.223;

1.223
date	2003.12.20.00.40.27;	author katsyonak;	state Exp;
branches;
next	1.222;

1.222
date	2003.12.09.19.15.44;	author bavariansnail;	state Exp;
branches;
next	1.221;

1.221
date	2003.11.23.13.33.37;	author katsyonak;	state Exp;
branches;
next	1.220;

1.220
date	2003.11.16.13.59.55;	author katsyonak;	state Exp;
branches;
next	1.219;

1.219
date	2003.11.16.13.05.47;	author katsyonak;	state Exp;
branches;
next	1.218;

1.218
date	2003.11.13.21.55.25;	author katsyonak;	state Exp;
branches;
next	1.217;

1.217
date	2003.11.13.20.59.15;	author syrus77;	state Exp;
branches;
next	1.216;

1.216
date	2003.11.13.13.51.44;	author katsyonak;	state Exp;
branches;
next	1.215;

1.215
date	2003.11.13.13.02.57;	author dongato;	state Exp;
branches;
next	1.214;

1.214
date	2003.11.11.16.31.02;	author kuchin;	state Exp;
branches;
next	1.213;

1.213
date	2003.11.02.12.38.14;	author dongato;	state Exp;
branches;
next	1.212;

1.212
date	2003.11.02.10.36.41;	author katsyonak;	state Exp;
branches;
next	1.211;

1.211
date	2003.10.30.02.44.38;	author morevit;	state Exp;
branches;
next	1.210;

1.210
date	2003.10.29.21.11.31;	author katsyonak;	state Exp;
branches;
next	1.209;

1.209
date	2003.10.29.17.04.51;	author katsyonak;	state Exp;
branches;
next	1.208;

1.208
date	2003.10.28.21.42.05;	author morevit;	state Exp;
branches;
next	1.207;

1.207
date	2003.10.26.14.00.53;	author morevit;	state Exp;
branches;
next	1.206;

1.206
date	2003.10.23.17.36.43;	author kuchin;	state Exp;
branches;
next	1.205;

1.205
date	2003.10.21.14.33.59;	author dongato;	state Exp;
branches;
next	1.204;

1.204
date	2003.10.20.19.08.00;	author puritynn666;	state Exp;
branches;
next	1.203;

1.203
date	2003.10.20.14.46.58;	author dongato;	state Exp;
branches;
next	1.202;

1.202
date	2003.10.20.13.20.05;	author morevit;	state Exp;
branches;
next	1.201;

1.201
date	2003.10.16.22.02.34;	author syrus77;	state Exp;
branches;
next	1.200;

1.200
date	2003.10.15.03.51.45;	author morevit;	state Exp;
branches;
next	1.199;

1.199
date	2003.10.08.12.56.35;	author morevit;	state Exp;
branches;
next	1.198;

1.198
date	2003.10.08.01.53.33;	author morevit;	state Exp;
branches;
next	1.197;

1.197
date	2003.10.07.22.26.35;	author puritynn666;	state Exp;
branches;
next	1.196;

1.196
date	2003.10.07.13.47.36;	author dongato;	state Exp;
branches;
next	1.195;

1.195
date	2003.10.06.22.08.11;	author puritynn666;	state Exp;
branches;
next	1.194;

1.194
date	2003.10.05.17.53.56;	author morevit;	state Exp;
branches;
next	1.193;

1.193
date	2003.10.02.18.44.52;	author dongato;	state Exp;
branches;
next	1.192;

1.192
date	2003.10.02.18.42.47;	author dongato;	state Exp;
branches;
next	1.191;

1.191
date	2003.10.02.13.40.34;	author morevit;	state Exp;
branches;
next	1.190;

1.190
date	2003.10.02.00.58.14;	author morevit;	state Exp;
branches;
next	1.189;

1.189
date	2003.09.30.23.20.15;	author syrus77;	state Exp;
branches;
next	1.188;

1.188
date	2003.09.30.11.36.13;	author morevit;	state Exp;
branches;
next	1.187;

1.187
date	2003.09.29.21.21.54;	author morevit;	state Exp;
branches;
next	1.186;

1.186
date	2003.09.29.14.57.13;	author morevit;	state Exp;
branches;
next	1.185;

1.185
date	2003.09.27.18.19.24;	author dongato;	state Exp;
branches;
next	1.184;

1.184
date	2003.09.26.23.32.55;	author morevit;	state Exp;
branches;
next	1.183;

1.183
date	2003.09.26.19.15.12;	author dongato;	state Exp;
branches;
next	1.182;

1.182
date	2003.09.26.18.40.54;	author bavariansnail;	state Exp;
branches;
next	1.181;

1.181
date	2003.09.26.09.31.40;	author dongato;	state Exp;
branches;
next	1.180;

1.180
date	2003.09.25.20.24.14;	author uid110194;	state Exp;
branches;
next	1.179;

1.179
date	2003.09.25.11.24.52;	author morevit;	state Exp;
branches;
next	1.178;

1.178
date	2003.09.24.17.51.01;	author bavariansnail;	state Exp;
branches;
next	1.177;

1.177
date	2003.09.24.16.53.03;	author morevit;	state Exp;
branches;
next	1.176;

1.176
date	2003.09.24.15.16.27;	author bavariansnail;	state Exp;
branches;
next	1.175;

1.175
date	2003.09.24.10.47.36;	author morevit;	state Exp;
branches;
next	1.174;

1.174
date	2003.09.24.07.25.33;	author dongato;	state Exp;
branches;
next	1.173;

1.173
date	2003.09.23.19.34.27;	author bavariansnail;	state Exp;
branches;
next	1.172;

1.172
date	2003.09.23.16.52.50;	author morevit;	state Exp;
branches;
next	1.171;

1.171
date	2003.09.22.00.17.22;	author morevit;	state Exp;
branches;
next	1.170;

1.170
date	2003.09.21.22.05.20;	author morevit;	state Exp;
branches;
next	1.169;

1.169
date	2003.09.21.21.35.33;	author puritynn666;	state Exp;
branches;
next	1.168;

1.168
date	2003.09.20.20.47.40;	author bavariansnail;	state Exp;
branches;
next	1.167;

1.167
date	2003.09.20.15.39.32;	author morevit;	state Exp;
branches;
next	1.166;

1.166
date	2003.09.19.00.13.38;	author morevit;	state Exp;
branches;
next	1.165;

1.165
date	2003.09.16.17.59.00;	author puritynn666;	state Exp;
branches;
next	1.164;

1.164
date	2003.09.16.17.40.03;	author puritynn666;	state Exp;
branches;
next	1.163;

1.163
date	2003.09.16.15.32.57;	author puritynn666;	state Exp;
branches;
next	1.162;

1.162
date	2003.09.15.18.35.29;	author dongato;	state Exp;
branches;
next	1.161;

1.161
date	2003.09.15.14.26.31;	author dongato;	state Exp;
branches;
next	1.160;

1.160
date	2003.09.12.18.55.48;	author puritynn666;	state Exp;
branches;
next	1.159;

1.159
date	2003.09.11.10.04.10;	author dongato;	state Exp;
branches;
next	1.158;

1.158
date	2003.09.11.06.00.17;	author puritynn666;	state Exp;
branches;
next	1.157;

1.157
date	2003.09.10.20.39.22;	author dongato;	state Exp;
branches;
next	1.156;

1.156
date	2003.09.10.16.33.58;	author puritynn666;	state Exp;
branches;
next	1.155;

1.155
date	2003.09.10.09.47.22;	author dongato;	state Exp;
branches;
next	1.154;

1.154
date	2003.09.09.19.53.50;	author puritynn666;	state Exp;
branches;
next	1.153;

1.153
date	2003.09.07.19.21.08;	author dongato;	state Exp;
branches;
next	1.152;

1.152
date	2003.09.07.16.32.23;	author puritynn666;	state Exp;
branches;
next	1.151;

1.151
date	2003.09.07.14.19.44;	author puritynn666;	state Exp;
branches;
next	1.150;

1.150
date	2003.09.07.12.51.12;	author dongato;	state Exp;
branches;
next	1.149;

1.149
date	2003.09.07.02.04.01;	author syrus77;	state Exp;
branches;
next	1.148;

1.148
date	2003.09.06.12.29.41;	author puritynn666;	state Exp;
branches;
next	1.147;

1.147
date	2003.09.06.01.43.29;	author syrus77;	state Exp;
branches;
next	1.146;

1.146
date	2003.09.05.23.08.39;	author puritynn666;	state Exp;
branches;
next	1.145;

1.145
date	2003.09.05.19.03.35;	author puritynn666;	state Exp;
branches;
next	1.144;

1.144
date	2003.09.05.06.28.14;	author puritynn666;	state Exp;
branches;
next	1.143;

1.143
date	2003.09.05.02.58.36;	author dongato;	state Exp;
branches;
next	1.142;

1.142
date	2003.09.05.02.48.23;	author syrus77;	state Exp;
branches;
next	1.141;

1.141
date	2003.09.04.19.31.24;	author dongato;	state Exp;
branches;
next	1.140;

1.140
date	2003.09.04.18.13.14;	author puritynn666;	state Exp;
branches;
next	1.139;

1.139
date	2003.09.04.03.53.30;	author dongato;	state Exp;
branches;
next	1.138;

1.138
date	2003.09.03.21.13.57;	author dongato;	state Exp;
branches;
next	1.137;

1.137
date	2003.09.03.15.45.29;	author dongato;	state Exp;
branches;
next	1.136;

1.136
date	2003.09.02.22.46.39;	author dongato;	state Exp;
branches;
next	1.135;

1.135
date	2003.09.02.19.46.43;	author puritynn666;	state Exp;
branches;
next	1.134;

1.134
date	2003.09.02.18.30.44;	author puritynn666;	state Exp;
branches;
next	1.133;

1.133
date	2003.09.01.22.57.31;	author dongato;	state Exp;
branches;
next	1.132;

1.132
date	2003.08.31.16.49.55;	author dongato;	state Exp;
branches;
next	1.131;

1.131
date	2003.08.30.11.23.26;	author emoulari;	state Exp;
branches;
next	1.130;

1.130
date	2003.08.24.06.17.27;	author kuchin;	state Exp;
branches;
next	1.129;

1.129
date	2003.08.23.00.20.51;	author forcha;	state Exp;
branches;
next	1.128;

1.128
date	2003.08.20.20.57.28;	author dongato;	state Exp;
branches;
next	1.127;

1.127
date	2003.08.20.15.56.54;	author dongato;	state Exp;
branches;
next	1.126;

1.126
date	2003.08.17.16.40.02;	author puritynn666;	state Exp;
branches;
next	1.125;

1.125
date	2003.08.17.13.15.04;	author puritynn666;	state Exp;
branches;
next	1.124;

1.124
date	2003.08.15.10.08.17;	author kuchin;	state Exp;
branches;
next	1.123;

1.123
date	2003.08.10.16.42.03;	author kuchin;	state Exp;
branches;
next	1.122;

1.122
date	2003.08.10.04.42.50;	author eklmn;	state Exp;
branches;
next	1.121;

1.121
date	2003.08.01.13.43.13;	author syrus77;	state Exp;
branches;
next	1.120;

1.120
date	2003.08.01.09.50.06;	author dongato;	state Exp;
branches;
next	1.119;

1.119
date	2003.07.31.15.02.19;	author puritynn666;	state Exp;
branches;
next	1.118;

1.118
date	2003.07.30.12.29.31;	author kuchin;	state Exp;
branches;
next	1.117;

1.117
date	2003.07.27.17.32.20;	author dongato;	state Exp;
branches;
next	1.116;

1.116
date	2003.07.24.18.21.22;	author puritynn666;	state Exp;
branches;
next	1.115;

1.115
date	2003.07.24.17.17.17;	author eklmn;	state Exp;
branches;
next	1.114;

1.114
date	2003.07.23.23.37.55;	author puritynn666;	state Exp;
branches;
next	1.113;

1.113
date	2003.07.23.15.41.11;	author dongato;	state Exp;
branches;
next	1.112;

1.112
date	2003.07.23.14.36.21;	author puritynn666;	state Exp;
branches;
next	1.111;

1.111
date	2003.07.22.18.08.45;	author dongato;	state Exp;
branches;
next	1.110;

1.110
date	2003.07.22.13.46.18;	author dongato;	state Exp;
branches;
next	1.109;

1.109
date	2003.07.21.23.46.10;	author dongato;	state Exp;
branches;
next	1.108;

1.108
date	2003.07.21.17.45.46;	author puritynn666;	state Exp;
branches;
next	1.107;

1.107
date	2003.07.12.18.23.54;	author syrus77;	state Exp;
branches;
next	1.106;

1.106
date	2003.07.12.14.10.37;	author dongato;	state Exp;
branches;
next	1.105;

1.105
date	2003.07.12.12.46.00;	author dongato;	state Exp;
branches;
next	1.104;

1.104
date	2003.07.12.02.35.44;	author dongato;	state Exp;
branches;
next	1.103;

1.103
date	2003.07.11.14.34.37;	author dongato;	state Exp;
branches;
next	1.102;

1.102
date	2003.07.10.23.29.35;	author dongato;	state Exp;
branches;
next	1.101;

1.101
date	2003.07.10.21.27.51;	author dongato;	state Exp;
branches;
next	1.100;

1.100
date	2003.07.10.21.00.30;	author dongato;	state Exp;
branches;
next	1.99;

1.99
date	2003.07.10.15.37.38;	author dongato;	state Exp;
branches;
next	1.98;

1.98
date	2003.07.10.04.50.15;	author dongato;	state Exp;
branches;
next	1.97;

1.97
date	2003.07.10.01.39.39;	author dongato;	state Exp;
branches;
next	1.96;

1.96
date	2003.07.09.23.56.07;	author dongato;	state Exp;
branches;
next	1.95;

1.95
date	2003.07.09.16.17.26;	author dongato;	state Exp;
branches;
next	1.94;

1.94
date	2003.07.09.15.08.21;	author netwolf1;	state Exp;
branches;
next	1.93;

1.93
date	2003.07.09.14.00.23;	author dongato;	state Exp;
branches;
next	1.92;

1.92
date	2003.07.08.19.51.21;	author dongato;	state Exp;
branches;
next	1.91;

1.91
date	2003.07.08.18.19.58;	author puritynn666;	state Exp;
branches;
next	1.90;

1.90
date	2003.07.08.16.01.39;	author dongato;	state Exp;
branches;
next	1.89;

1.89
date	2003.07.08.10.34.08;	author dongato;	state Exp;
branches;
next	1.88;

1.88
date	2003.07.08.04.01.38;	author dongato;	state Exp;
branches;
next	1.87;

1.87
date	2003.07.08.03.37.37;	author dongato;	state Exp;
branches;
next	1.86;

1.86
date	2003.07.08.00.04.59;	author netwolf1;	state Exp;
branches;
next	1.85;

1.85
date	2003.07.06.19.14.00;	author dongato;	state Exp;
branches;
next	1.84;

1.84
date	2003.07.06.15.56.25;	author netwolf1;	state Exp;
branches;
next	1.83;

1.83
date	2003.07.06.03.10.27;	author dongato;	state Exp;
branches;
next	1.82;

1.82
date	2003.07.04.13.43.03;	author netwolf1;	state Exp;
branches;
next	1.81;

1.81
date	2003.07.04.07.43.50;	author netwolf1;	state Exp;
branches;
next	1.80;

1.80
date	2003.07.03.15.06.49;	author netwolf1;	state Exp;
branches;
next	1.79;

1.79
date	2003.07.02.13.01.01;	author netwolf1;	state Exp;
branches;
next	1.78;

1.78
date	2003.06.29.20.45.07;	author eklmn;	state Exp;
branches;
next	1.77;

1.77
date	2003.06.28.18.17.24;	author eklmn;	state Exp;
branches;
next	1.76;

1.76
date	2003.06.28.08.30.17;	author partyckip;	state Exp;
branches;
next	1.75;

1.75
date	2003.06.27.18.53.23;	author eklmn;	state Exp;
branches;
next	1.74;

1.74
date	2003.06.27.18.15.27;	author netwolf1;	state Exp;
branches;
next	1.73;

1.73
date	2003.06.25.18.32.05;	author eklmn;	state Exp;
branches;
next	1.72;

1.72
date	2003.06.24.23.16.52;	author syrus77;	state Exp;
branches;
next	1.71;

1.71
date	2003.06.23.21.55.16;	author partyckip;	state Exp;
branches;
next	1.70;

1.70
date	2003.06.23.12.57.32;	author dongato;	state Exp;
branches;
next	1.69;

1.69
date	2003.06.23.00.53.09;	author dongato;	state Exp;
branches;
next	1.68;

1.68
date	2003.06.22.23.21.07;	author dongato;	state Exp;
branches;
next	1.67;

1.67
date	2003.06.22.22.51.29;	author netwolf1;	state Exp;
branches;
next	1.66;

1.66
date	2003.06.22.22.26.03;	author syrus77;	state Exp;
branches;
next	1.65;

1.65
date	2003.06.22.16.31.18;	author netwolf1;	state Exp;
branches;
next	1.64;

1.64
date	2003.06.22.13.40.41;	author syrus77;	state Exp;
branches;
next	1.63;

1.63
date	2003.06.22.13.18.17;	author kuchin;	state Exp;
branches;
next	1.62;

1.62
date	2003.06.21.05.30.56;	author dongato;	state Exp;
branches;
next	1.61;

1.61
date	2003.06.21.05.28.19;	author dongato;	state Exp;
branches;
next	1.60;

1.60
date	2003.06.20.10.12.21;	author dongato;	state Exp;
branches;
next	1.59;

1.59
date	2003.06.19.07.47.47;	author partyckip;	state Exp;
branches;
next	1.58;

1.58
date	2003.06.17.00.11.29;	author dongato;	state Exp;
branches;
next	1.57;

1.57
date	2003.06.16.10.42.14;	author kuchin;	state Exp;
branches;
next	1.56;

1.56
date	2003.06.14.13.05.58;	author partyckip;	state Exp;
branches;
next	1.55;

1.55
date	2003.06.12.22.26.56;	author syrus77;	state Exp;
branches;
next	1.54;

1.54
date	2003.06.11.23.00.30;	author partyckip;	state Exp;
branches;
next	1.53;

1.53
date	2003.06.10.09.36.48;	author kuchin;	state Exp;
branches;
next	1.52;

1.52
date	2003.06.09.22.19.23;	author partyckip;	state Exp;
branches;
next	1.51;

1.51
date	2003.06.09.21.59.35;	author partyckip;	state Exp;
branches;
next	1.50;

1.50
date	2003.06.09.14.23.37;	author syrus77;	state Exp;
branches;
next	1.49;

1.49
date	2003.06.09.12.51.05;	author kuchin;	state Exp;
branches;
next	1.48;

1.48
date	2003.06.09.11.57.42;	author kuchin;	state Exp;
branches;
next	1.47;

1.47
date	2003.06.08.23.50.31;	author syrus77;	state Exp;
branches;
next	1.46;

1.46
date	2003.06.08.14.59.45;	author kuchin;	state Exp;
branches;
next	1.45;

1.45
date	2003.06.08.07.36.58;	author partyckip;	state Exp;
branches;
next	1.44;

1.44
date	2003.06.06.00.42.42;	author syrus77;	state Exp;
branches;
next	1.43;

1.43
date	2003.06.05.20.49.51;	author syrus77;	state Exp;
branches;
next	1.42;

1.42
date	2003.06.03.18.59.09;	author dongato;	state Exp;
branches;
next	1.41;

1.41
date	2003.05.30.21.27.00;	author partyckip;	state Exp;
branches;
next	1.40;

1.40
date	2003.05.27.04.48.30;	author dongato;	state Exp;
branches;
next	1.39;

1.39
date	2003.05.26.10.10.10;	author emoulari;	state Exp;
branches;
next	1.38;

1.38
date	2003.05.25.15.42.40;	author kuchin;	state Exp;
branches;
next	1.37;

1.37
date	2003.05.22.13.48.03;	author emoulari;	state Exp;
branches;
next	1.36;

1.36
date	2003.05.14.01.01.02;	author netwolf1;	state Exp;
branches;
next	1.35;

1.35
date	2003.05.11.19.25.47;	author lord_kiron;	state Exp;
branches;
next	1.34;

1.34
date	2003.05.11.11.37.48;	author kuchin;	state Exp;
branches;
next	1.33;

1.33
date	2003.05.05.16.22.53;	author emoulari;	state Exp;
branches;
next	1.32;

1.32
date	2003.04.29.13.25.16;	author dongato;	state Exp;
branches;
next	1.31;

1.31
date	2003.04.29.09.23.17;	author kuchin;	state Exp;
branches;
next	1.30;

1.30
date	2003.04.29.08.37.47;	author kuchin;	state Exp;
branches;
next	1.29;

1.29
date	2003.04.27.14.44.21;	author kuchin;	state Exp;
branches;
next	1.28;

1.28
date	2003.04.22.12.41.52;	author kuchin;	state Exp;
branches;
next	1.27;

1.27
date	2003.04.19.12.47.03;	author dongato;	state Exp;
branches;
next	1.26;

1.26
date	2003.04.19.07.35.34;	author kuchin;	state Exp;
branches;
next	1.25;

1.25
date	2003.04.19.07.17.00;	author kuchin;	state Exp;
branches;
next	1.24;

1.24
date	2003.04.03.10.12.20;	author kuchin;	state Exp;
branches;
next	1.23;

1.23
date	2003.03.23.19.22.30;	author emoulari;	state Exp;
branches;
next	1.22;

1.22
date	2003.03.21.11.52.53;	author partyckip;	state Exp;
branches
	1.22.2.1;
next	1.21;

1.21
date	2003.03.19.15.35.39;	author cax2;	state Exp;
branches;
next	1.20;

1.20
date	2003.03.14.16.24.22;	author partyckip;	state Exp;
branches;
next	1.19;

1.19
date	2003.03.14.14.31.46;	author lord_kiron;	state Exp;
branches;
next	1.18;

1.18
date	2003.03.11.21.34.09;	author emoulari;	state Exp;
branches;
next	1.17;

1.17
date	2003.03.08.22.28.55;	author emoulari;	state Exp;
branches;
next	1.16;

1.16
date	2003.03.08.08.12.25;	author kuchin;	state Exp;
branches;
next	1.15;

1.15
date	2003.02.20.13.40.58;	author kuchin;	state Exp;
branches;
next	1.14;

1.14
date	2003.02.20.12.15.48;	author kuchin;	state Exp;
branches;
next	1.13;

1.13
date	2003.02.20.07.25.22;	author cax2;	state Exp;
branches;
next	1.12;

1.12
date	2003.02.19.19.37.40;	author kuchin;	state Exp;
branches;
next	1.11;

1.11
date	2003.02.18.19.10.38;	author cax2;	state Exp;
branches;
next	1.10;

1.10
date	2003.02.18.14.32.25;	author cax2;	state Exp;
branches;
next	1.9;

1.9
date	2003.02.18.14.20.28;	author cax2;	state Exp;
branches;
next	1.8;

1.8
date	2003.02.16.22.01.51;	author lord_kiron;	state Exp;
branches;
next	1.7;

1.7
date	2003.02.16.17.29.37;	author kuchin;	state Exp;
branches;
next	1.6;

1.6
date	2003.02.14.10.18.51;	author kuchin;	state Exp;
branches;
next	1.5;

1.5
date	2003.02.13.18.33.58;	author kuchin;	state Exp;
branches;
next	1.4;

1.4
date	2003.02.10.19.26.20;	author kuchin;	state Exp;
branches;
next	1.3;

1.3
date	2003.02.09.18.39.42;	author kuchin;	state Exp;
branches;
next	1.2;

1.2
date	2003.01.25.19.55.13;	author emoulari;	state Exp;
branches
	1.2.2.1
	1.2.4.1;
next	1.1;

1.1
date	2003.01.21.18.21.24;	author cax2;	state Exp;
branches;
next	;

1.2.2.1
date	2003.01.28.16.54.37;	author cax2;	state Exp;
branches;
next	;

1.2.4.1
date	2003.02.06.08.53.02;	author obaldin;	state Exp;
branches;
next	;

1.22.2.1
date	2003.03.23.06.22.02;	author recdvst;	state Exp;
branches;
next	1.22.2.2;

1.22.2.2
date	2003.03.24.09.39.44;	author recdvst;	state Exp;
branches;
next	;


desc
@@


1.443
log
@Fixed a bunch of DynIP server related issues.
@
text
@//	This file is part of eMule Plus
//
//	This program is free software; you can redistribute it and/or
//	modify it under the terms of the GNU General Public License
//	as published by the Free Software Foundation; either
//	version 2 of the License, or (at your option) any later version.
//
//	This program is distributed in the hope that it will be useful,
//	but WITHOUT ANY WARRANTY; without even the implied warranty of
//	MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
//	GNU General Public License for more details.
//
//	You should have received a copy of the GNU General Public License
//	along with this program; if not, write to the Free Software
//	Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.

#include "stdafx.h"
#include "emule.h"
#include "updownclient.h"
#include "zlib/zlib.h"
#include "WebServer.h"
#include "WebSocket.h"
#ifdef OLD_SOCKETS_ENABLED
#include "sockets.h"
#endif
#include "PartFile.h"
#include "ED2KLink.h"
#include "MD5Sum.h"
#include "QArray.h"
#include "HTRichEditCtrl.h"
#include "SharedFileList.h"
#include "ServerList.h"
#include "UploadQueue.h"
#include "server.h"
#include "ListenSocket.h"

#ifdef _DEBUG
#undef THIS_FILE
static char THIS_FILE[]=__FILE__;
#define new DEBUG_NEW
#endif

#define HTTPInit "Cache-Control: no-cache, no-store, must-revalidate, max-age=0, private\r\nPragma: no-cache\r\nContent-Type: text/html\r\n"

#define WEB_SERVER_TEMPLATES_VERSION	1011

typedef struct
{
	uint32		dwResStrId;
	const TCHAR	*pcColIcon;
	const TCHAR	*pcColHdr;
	const TCHAR	*pcColMenu;
} WSListDefinition;

//SyruS CQArray-Sorting operators
bool operator > (QueueUsers & first, QueueUsers & second)
{
	return (first.sIndex.CompareNoCase(second.sIndex) > 0);
}

bool operator < (QueueUsers & first, QueueUsers & second)
{
	return (first.sIndex.CompareNoCase(second.sIndex) < 0);
}

CWebServer::CWebServer(void)
{
	m_pWSPrefs = g_App.m_pPrefs->GetWSPrefsPtr();

	m_bServerWorking = false;
	m_nIntruderDetect = 0;
	m_nStartTempDisabledTime = 0;
	m_bIsTempDisabled = false;
}

void CWebServer::ReloadTemplates()
{
	EMULE_TRY

	CString	strTmp, sFile = g_App.m_pPrefs->GetTemplate();

	if (sFile.IsEmpty() || (sFile.CompareNoCase(_T("emulexp.tmpl")) == 0))
	{
		sFile = g_App.m_pPrefs->GetAppDir();
		sFile += _T("eMuleXP.tmpl");
	}

	CStdioFile file;
	if (file.Open(sFile, CFile::modeRead | CFile::shareDenyWrite | CFile::typeText | CFile::osSequentialScan))
	{
		CString sAll;

		setvbuf(file.m_pStream, NULL, _IOFBF, 16*1024);
		for(;;)
		{
			if(!file.ReadString(strTmp))
				break;

			sAll += strTmp;
			sAll += _T('\n');
		}
		file.Close();

		long lVersion = _tstol(_LoadTemplate(sAll, _T("TMPL_VERSION")));

		if(lVersion < WEB_SERVER_TEMPLATES_VERSION)
		{
			if(g_App.m_pPrefs->GetWSIsEnabled() || m_bServerWorking)
				AddLogLine(LOG_FL_SBAR | LOG_RGB_ERROR, IDS_WS_ERR_LOADTEMPLATE, sFile);
			if (m_bServerWorking)
				StopSockets();
			m_bServerWorking = false;
			g_App.m_pPrefs->SetWSIsEnabled(false);
		}
		else
		{
			m_Templates.sHeader = _LoadTemplate(sAll,_T("TMPL_HEADER"));
			m_Templates.sHeaderStylesheet = _LoadTemplate(sAll,_T("TMPL_HEADER_STYLESHEET"));
			m_Templates.sFooter = _LoadTemplate(sAll,_T("TMPL_FOOTER"));
			m_Templates.sServerList = _LoadTemplate(sAll,_T("TMPL_SERVER_LIST"));
			m_Templates.sServerLine = _LoadTemplate(sAll,_T("TMPL_SERVER_LINE"));
			m_Templates.sTransferImages = _LoadTemplate(sAll,_T("TMPL_TRANSFER_IMAGES"));
			m_Templates.sTransferList = _LoadTemplate(sAll,_T("TMPL_TRANSFER_LIST"));
			m_Templates.sTransferDownHeader = _LoadTemplate(sAll,_T("TMPL_TRANSFER_DOWN_HEADER"));
			m_Templates.sTransferDownFooter = _LoadTemplate(sAll,_T("TMPL_TRANSFER_DOWN_FOOTER"));
			m_Templates.sTransferDownLine = _LoadTemplate(sAll,_T("TMPL_TRANSFER_DOWN_LINE"));
			m_Templates.sTransferUpHeader = _LoadTemplate(sAll,_T("TMPL_TRANSFER_UP_HEADER"));
			m_Templates.sTransferUpFooter = _LoadTemplate(sAll,_T("TMPL_TRANSFER_UP_FOOTER"));
			m_Templates.sTransferUpLine = _LoadTemplate(sAll,_T("TMPL_TRANSFER_UP_LINE"));
			m_Templates.sTransferUpQueueShow = _LoadTemplate(sAll,_T("TMPL_TRANSFER_UP_QUEUE_SHOW"));
			m_Templates.sTransferUpQueueHide = _LoadTemplate(sAll,_T("TMPL_TRANSFER_UP_QUEUE_HIDE"));
			m_Templates.sTransferUpQueueLine = _LoadTemplate(sAll,_T("TMPL_TRANSFER_UP_QUEUE_LINE"));
			m_Templates.sTransferUpQueueBannedShow = _LoadTemplate(sAll,_T("TMPL_TRANSFER_UP_QUEUE_BANNED_SHOW"));
			m_Templates.sTransferUpQueueBannedHide = _LoadTemplate(sAll,_T("TMPL_TRANSFER_UP_QUEUE_BANNED_HIDE"));
			m_Templates.sTransferUpQueueBannedLine = _LoadTemplate(sAll,_T("TMPL_TRANSFER_UP_QUEUE_BANNED_LINE"));
			m_Templates.sTransferUpQueueFriendShow = _LoadTemplate(sAll,_T("TMPL_TRANSFER_UP_QUEUE_FRIEND_SHOW"));
			m_Templates.sTransferUpQueueFriendHide = _LoadTemplate(sAll,_T("TMPL_TRANSFER_UP_QUEUE_FRIEND_HIDE"));
			m_Templates.sTransferUpQueueFriendLine = _LoadTemplate(sAll,_T("TMPL_TRANSFER_UP_QUEUE_FRIEND_LINE"));
			m_Templates.sTransferUpQueueCreditShow = _LoadTemplate(sAll,_T("TMPL_TRANSFER_UP_QUEUE_CREDIT_SHOW"));
			m_Templates.sTransferUpQueueCreditHide = _LoadTemplate(sAll,_T("TMPL_TRANSFER_UP_QUEUE_CREDIT_HIDE"));
			m_Templates.sTransferUpQueueCreditLine = _LoadTemplate(sAll,_T("TMPL_TRANSFER_UP_QUEUE_CREDIT_LINE"));
			m_Templates.sSharedList = _LoadTemplate(sAll,_T("TMPL_SHARED_LIST"));
			m_Templates.sSharedLine = _LoadTemplate(sAll,_T("TMPL_SHARED_LINE"));
			m_Templates.sGraphs = _LoadTemplate(sAll,_T("TMPL_GRAPHS"));
			m_Templates.sLog = _LoadTemplate(sAll,_T("TMPL_LOG"));
			m_Templates.sServerInfo = _LoadTemplate(sAll,_T("TMPL_SERVERINFO"));
			m_Templates.sDebugLog = _LoadTemplate(sAll,_T("TMPL_DEBUGLOG"));
			m_Templates.sStats = _LoadTemplate(sAll,_T("TMPL_STATS"));
			m_Templates.sPreferences = _LoadTemplate(sAll,_T("TMPL_PREFERENCES"));
			m_Templates.sLogin = _LoadTemplate(sAll,_T("TMPL_LOGIN"));
			m_Templates.sAddServerBox = _LoadTemplate(sAll,_T("TMPL_ADDSERVERBOX"));
			m_Templates.sSearch = _LoadTemplate(sAll,_T("TMPL_SEARCH"));
			m_Templates.dwProgressbarWidth = _tstoi(_LoadTemplate(sAll,_T("PROGRESSBARWIDTH")));
			m_Templates.sSearchHeader = _LoadTemplate(sAll,_T("TMPL_SEARCH_RESULT_HEADER"));
			m_Templates.sSearchResultLine = _LoadTemplate(sAll,_T("TMPL_SEARCH_RESULT_LINE"));
			m_Templates.sProgressbarImgs = _LoadTemplate(sAll,_T("PROGRESSBARIMGS"));
			m_Templates.sProgressbarImgsPercent = _LoadTemplate(sAll,_T("PROGRESSBARPERCENTIMG"));
			m_Templates.sCatArrow= _LoadTemplate(sAll, _T("TMPL_CATARROW"));
			m_Templates.sDownArrow= _LoadTemplate(sAll, _T("TMPL_DOWNARROW"));
			m_Templates.sUpArrow= _LoadTemplate(sAll, _T("TMPL_UPARROW"));
			m_Templates.strDownDoubleArrow = _LoadTemplate(sAll, _T("TMPL_DNDOUBLEARROW"));
			m_Templates.strUpDoubleArrow = _LoadTemplate(sAll, _T("TMPL_UPDOUBLEARROW"));

			m_Templates.sProgressbarImgsPercent.Replace(_T("[PROGRESSGIFNAME]"),_T("%s"));
			m_Templates.sProgressbarImgsPercent.Replace(_T("[PROGRESSGIFINTERNAL]"),_T("%u"));
			m_Templates.sProgressbarImgs.Replace(_T("[PROGRESSGIFNAME]"),_T("%s"));
			m_Templates.sProgressbarImgs.Replace(_T("[PROGRESSGIFINTERNAL]"),_T("%i"));
		}
	}
	else if(m_bServerWorking)
	{
		AddLogLine(LOG_FL_SBAR | LOG_RGB_ERROR, IDS_WEB_ERR_CANTLOAD, sFile);
		StopSockets();
		m_bServerWorking = false;
		g_App.m_pPrefs->SetWSIsEnabled(false);
	}

	EMULE_CATCH
}

CWebServer::~CWebServer(void)
{
	if (m_bServerWorking) StopSockets();
}

CString CWebServer::_LoadTemplate(const CString &sAll, const TCHAR *pcTemplateName)
{
	EMULE_TRY

	CString	sRet, strTmp = _T("<--");

	strTmp += pcTemplateName;

	int nStart = sAll.Find(strTmp + _T("-->"));
	int nEnd = sAll.Find(strTmp + _T("_END-->"));
	if ((nStart >= 0) && (nEnd >= 0) && (nStart < nEnd))
	{
		nStart += _tcslen(pcTemplateName) + 7;
		sRet = sAll.Mid(nStart, nEnd - nStart - 1);
	}
	else
		AddLogLine(LOG_FL_DBG | LOG_RGB_ERROR, _T("Webserver: can't load %s template"), pcTemplateName);

	return sRet;

	EMULE_CATCH

	return _T("");
}

void CWebServer::RestartServer()
{	//Cax2 - restarts the server with the new port settings
	StopSockets();
	if (m_bServerWorking)
		StartSockets(this);
}

void CWebServer::StartServer(void)
{
	EMULE_TRY

	if (m_bServerWorking == g_App.m_pPrefs->GetWSIsEnabled())
		return;
	m_bServerWorking = g_App.m_pPrefs->GetWSIsEnabled();

	if (m_bServerWorking)
	{
		ReloadTemplates();
		if (m_bServerWorking)
		{
			StartSockets(this);
			m_nIntruderDetect = 0;
			m_nStartTempDisabledTime = 0;
			m_bIsTempDisabled = false;
		}
	}
	else
		StopSockets();

	if(g_App.m_pPrefs->GetWSIsEnabled() && m_bServerWorking)
		AddLogLine(0, _T("%s: %s"), _GetPlainResString(IDS_PW_HTTPD), _GetPlainResString(IDS_ENABLED).MakeLower());
	else
		AddLogLine(0, _T("%s: %s"), _GetPlainResString(IDS_PW_HTTPD), _GetPlainResString(IDS_DISABLED).MakeLower());

	EMULE_CATCH
}

void CWebServer::_RemoveServer(const CString &strIP, uint16 uPort)
{
	EMULE_TRY

	CServer	*server = g_App.m_pServerList->GetServerByAddress(strIP, uPort);
	if (server != NULL)
		g_App.m_pMDlg->SendMessage(WEB_REMOVE_SERVER, (WPARAM)server, NULL);

	EMULE_CATCH
}

void CWebServer::_AddToStatic(const CString &strIP, uint16 uPort)
{
	EMULE_TRY

	CServer	*server = g_App.m_pServerList->GetServerByAddress(strIP, uPort);
	if (server != NULL)
		g_App.m_pMDlg->SendMessage(WEB_ADD_TO_STATIC, (WPARAM)server, NULL);

	EMULE_CATCH
}

void CWebServer::_RemoveFromStatic(const CString &strIP, uint16 uPort)
{
	EMULE_TRY

	CServer	*server = g_App.m_pServerList->GetServerByAddress(strIP, uPort);
	if (server != NULL)
		g_App.m_pMDlg->SendMessage(WEB_REMOVE_FROM_STATIC, (WPARAM)server, NULL);

	EMULE_CATCH
}

void CWebServer::AddStatsLine(UpDown *line)
{
	EMULE_TRY

	if (PointsForWeb.GetCount() >= WEB_GRAPH_WIDTH)
		PointsForWeb.RemoveAt(0);
	PointsForWeb.Add(*line);

	EMULE_CATCH
}

CString CWebServer::_SpecialChars(CString str, bool noquote /*=false*/)
{
	EMULE_TRY

	str.Replace(_T("&"), _T("&amp;"));
	str.Replace(_T("<"), _T("&lt;"));
	str.Replace(_T(">"), _T("&gt;"));
	str.Replace(_T("\""), _T("&quot;"));
	if(noquote)
	{
		str.Replace(_T("'"), _T("&#8217;"));
		str.Replace(_T("\n"), _T("\\n"));
	}
	return str;

	EMULE_CATCH

	return _T("");
}

void CWebServer::SpecialChars(CString *str)
{
	str->Replace(_T("&"), _T("&amp;"));
	str->Replace(_T("<"), _T("&lt;"));
	str->Replace(_T(">"), _T("&gt;"));
	str->Replace(_T("\""), _T("&quot;"));
}

void CWebServer::_ConnectToServer(const CString &strIP, uint16 uPort)
{
	EMULE_TRY

	CServer	*server = g_App.m_pServerList->GetServerByAddress(strIP, uPort);

	if (server != NULL)
		g_App.m_pMDlg->SendMessage(WEB_CONNECT_TO_SERVER, (WPARAM)server, NULL);

	EMULE_CATCH
}

void CWebServer::ProcessFileReq(const ThreadData &Data)
{
	EMULE_TRY

	CWebServer *pThis = (CWebServer *)Data.pThis;
	if(pThis == NULL)
		return;

	CString		filename = Data.sURL;
	CString		strExt = filename.Right(4).MakeLower();
	CStringA	strHdr;
	const char	*pcContType = "";
	bool		bGzip = false;

	if (strExt == ".gif")
		pcContType = "image/gif";
	else if (strExt == ".jpg" || filename.Right(5).MakeLower() == ".jpeg")
		pcContType = "image/jpg";
	else if (strExt == ".bmp")
	{
		pcContType = "image/bmp";
		bGzip = true;
	}
	else if (strExt == ".png")
		pcContType = "image/png";
	else if (strExt == ".ico")
	{
		pcContType = "image/x-icon";
		bGzip = true;
	}
	else if (strExt == ".css")
	{
		pcContType = "text/css";
		bGzip = true;
	}
	else if (filename.Right(3).MakeLower() == ".js")
	{
		pcContType = "text/javascript";
		bGzip = true;
	}
	else if (strExt == ".xml")
	{
		pcContType = "text/xml";
		bGzip = true;
	}
	else if (strExt == ".txt")
	{
		pcContType = "text/plain";
		bGzip = true;
	}

	bGzip = bGzip && (Data.strAcceptEncoding.Find(_T("gzip")) >= 0);
#if 0
	if (bGzip)
		AddLogLine(LOG_FL_DBG, _T("WebServer: File Request (name=%s) Should do gzip (AcceptEncoding=%s)"), filename, Data.strAcceptEncoding);
	else
		AddLogLine(LOG_FL_DBG, _T("WebServer: File Request (name=%s) Should NOT do gzip (AcceptEncoding=%s)"), filename, Data.strAcceptEncoding);
#endif

//	HTTP/1.x response header "Content-Type:"
	strHdr.Format("Content-Type: %s\r\n", pcContType);

// Relative path to file from the eMule application folder
	filename.Delete(0);
	filename.Replace(_T('/'), _T('\\'));
	filename = g_App.m_pPrefs->GetAppDir() + _T("WebServer\\") + filename;

	CFile file;
	if (file.Open(filename, CFile::modeRead | CFile::shareDenyWrite | CFile::typeBinary))
	{
		char		acGMT[EP_MAX_HTTPGMTSTR];
		FILETIME	ftModify;
		struct tm	stTm = {0};

	// Get the file's modification time
		if (::GetFileTime(file.m_hFile, NULL, NULL, &ftModify))
		{
			CTime		timeFileMod(ftModify);

			if (timeFileMod.GetGmtTm(&stTm) != NULL)
			{
				Gmt2HttpStr(acGMT, &stTm);
				if (!Data.strIfModifiedSince.IsEmpty() && (CStringA(Data.strIfModifiedSince) == acGMT))
				{
					file.Close();
					Data.pSocket->SendReply(304);
					return;
				}
			//	HTTP/1.x response header "Last-Modified:"
				strHdr.AppendFormat("Last-Modified: %s\r\n", acGMT);
			}
		}

	//	DonGato: expire images after 30 days (can be overwritten by browser)
	//	Controls for file caching expiry time
		const int	iExp_M = 1; //Months
		const int	iExp_D = 0; //Days
		const int	iExp_h = 0; //Hours
		const int	iExp_m = 0; //Minutes
		const int	iExp_s = 0; //Seconds
	//	Calculate expiry time in seconds
		int		iExpireDelta = 60 * (60 * (24 * (30 * iExp_M + iExp_D) + iExp_h) + iExp_m) + iExp_s;
		CTime	t = CTime::GetCurrentTime() + iExpireDelta;

	//	HTTP/1.0 response header "Expires:" and
	//	HTTP/1.1 response header "Cache-Control: max-age"
	//	Overrides "Expires:" only if the client understands it
	//	Is more accurate than "Expires:"
		if (t.GetGmtTm(&stTm) != NULL)
		{
			Gmt2HttpStr(acGMT, &stTm);
		//	HTTP/1.x response header "Last-Modified:"
			strHdr.AppendFormat("Expires: %s\r\nCache-Control: max-age=%u\r\n", acGMT, iExpireDelta);
		}

		uint32	dwFileSz = static_cast<uint32>(file.GetLength());
		char	*buffer = new char[dwFileSz];
		int		size = file.Read(buffer, dwFileSz);

		file.Close();
		Data.pSocket->SendContent(strHdr, buffer, size);
		delete[] buffer;
	}
	else
		Data.pSocket->SendReply(404);	//	File not found

	EMULE_CATCH
}

void CWebServer::ProcessGeneralReq(const ThreadData &Data)
{
	EMULE_TRY

	//(0.29b)//////////////////////////////////////////////////////////////////
	// Here we are in real trouble! We are accessing the entire emule main thread
	// data without any syncronization!! Either we use the message pump for m_pMDlg
	// or use some hundreds of critical sections... For now, an exception handler
	// shoul avoid the worse things.
	//////////////////////////////////////////////////////////////////////////
	CoInitialize(NULL);

	EMULE_TRY

	bool	isUseGzip = (Data.strAcceptEncoding.Find(_T("gzip")) >= 0);	// Enable gzip only if the browser supports it
	CString	Out;
	CStringA	*pstrOut = NULL;
	byte		*gzipOut = NULL;
	unsigned	uiGzipLen = 0;

	DWORD dwCurTick = ::GetTickCount();

	if (GetIsTempDisabled() &&
		((dwCurTick - m_nStartTempDisabledTime) > (g_App.m_pPrefs->GetWSTempDisableLogin() * 60000)))
	{
		m_bIsTempDisabled = false;
		m_nStartTempDisabledTime = 0;
		AddLogLine(LOG_FL_SBAR | LOG_RGB_NOTICE, IDS_WEB_INTRBLOCKEND);
	}

	Session	ses;
	long	lSession = DoAuthentication(Data, &ses);
	CString	strCmd(_ParseURL(Data.sURL, _T("w")));

#if 0
	AddLogLine(LOG_FL_DBG, _T("WebServer: start request processing (Cmd=%s)"), strCmd);
#endif
#if 0
	if (isUseGzip)
		AddLogLine(LOG_FL_DBG, _T("WebServer: Gzip is ON (AcceptEncoding=%s)"), Data.strAcceptEncoding);
	else
		AddLogLine(LOG_FL_DBG, _T("WebServer: Gzip is OFF (AcceptEncoding=%s)"), Data.strAcceptEncoding);
#endif
	if (strCmd == _T("logout"))
		RemoveSession(Data, lSession);

	if (IsLoggedIn(Data, lSession))
	{
		if (strCmd == _T("close"))
		{
			g_App.m_app_state = g_App.APP_STATE_SHUTTINGDOWN;
			SendMessage(g_App.m_pMDlg->m_hWnd, WM_CLOSE, 0, 0);
		}
		else if (strCmd == _T("shutdown"))
		{
			HANDLE hToken;
			TOKEN_PRIVILEGES tkp;	// Get a token for this process
			try
			{
				if (!OpenProcessToken(GetCurrentProcess(), TOKEN_ADJUST_PRIVILEGES | TOKEN_QUERY, &hToken))
					throw;
				LookupPrivilegeValue(NULL, SE_SHUTDOWN_NAME, &tkp.Privileges[0].Luid);
				tkp.PrivilegeCount = 1;  // one privilege to set
				tkp.Privileges[0].Attributes = SE_PRIVILEGE_ENABLED;	// Get the shutdown privilege for this process.
				AdjustTokenPrivileges(hToken, FALSE, &tkp, 0, (PTOKEN_PRIVILEGES)NULL, 0);
				ExitWindowsEx(EWX_SHUTDOWN | EWX_FORCE, 0);
			}
			catch(...)
			{
				AddLogLine(LOG_FL_SBAR | LOG_RGB_NOTICE, GetResString(IDS_WEB_SHUTDOWN) + _T(' ') + GetResString(IDS_FAILED));
			}
		}
		else if (strCmd == _T("reboot"))
		{
			HANDLE hToken;
			TOKEN_PRIVILEGES tkp;	// Get a token for this process.
			try
			{
				if (!OpenProcessToken(GetCurrentProcess(), TOKEN_ADJUST_PRIVILEGES | TOKEN_QUERY, &hToken))
					throw;
				LookupPrivilegeValue(NULL, SE_SHUTDOWN_NAME, &tkp.Privileges[0].Luid);
				tkp.PrivilegeCount = 1;  // one privilege to set
				tkp.Privileges[0].Attributes = SE_PRIVILEGE_ENABLED;	// Get the shutdown privilege for this process.
				AdjustTokenPrivileges(hToken, FALSE, &tkp, 0, (PTOKEN_PRIVILEGES)NULL, 0);
				ExitWindowsEx(EWX_REBOOT | EWX_FORCE, 0);
			}
			catch(...)
			{
				AddLogLine(LOG_FL_SBAR | LOG_RGB_NOTICE, GetResString(IDS_WEB_REBOOT) + _T(' ') + GetResString(IDS_FAILED));
			}
		}

		Out += GetHeader(Data, lSession, strCmd);
		if (strCmd == _T("server"))
			Out += GetServerList(Data);
		else if (strCmd == _T("shared"))
			Out += GetSharedFilesList(Data);
		else if (strCmd == _T("transfer"))
			Out += GetTransferList(Data);
		else if (strCmd == _T("search"))
			Out += GetSearch(Data);
		else if (strCmd == _T("graphs"))
			Out += GetGraphs(Data);
		else if (strCmd == _T("log"))
			Out += GetLog(Data);
		else if (strCmd == _T("sinfo"))
			Out += GetServerInfo(Data);
		else if (strCmd == _T("debuglog"))
			Out += GetDebugLog(Data);
		else if (strCmd == _T("stats"))
			Out += _GetStats(Data);
		else if (strCmd == _T("options"))
			Out += GetPreferences(Data);
		Out += _GetFooter(Data);
	}
	else
	{
		Out += _GetLoginScreen(Data, isUseGzip);
	}

#ifdef _UNICODE
	CStringA strUTF8;

	Str2MB(cfUTF8, &strUTF8, Out);
	pstrOut = &strUTF8;
#else
	pstrOut = &Out;
#endif

	if(isUseGzip)
	{
		bool bOk = false;
		try
		{
			unsigned uiDstLen = pstrOut->GetLength() + 1024;
			gzipOut = new byte[uiDstLen];
			if (GzipCompress((byte*)gzipOut, &uiDstLen, (const byte*)pstrOut->GetBuffer(0), pstrOut->GetLength(), Z_DEFAULT_COMPRESSION) == Z_OK)
			{
				bOk = true;
				uiGzipLen = uiDstLen;
			}
		}
		catch(...)
		{
		}
		if(!bOk)
		{
			AddLogLine(LOG_FL_DBG | LOG_RGB_ERROR, _T("WebServer: Gzip FAILED on Cmd=%s (AcceptEncoding=%s)"), strCmd, Data.strAcceptEncoding);
			isUseGzip = false;
		}
	}

#if 0
	AddLogLine(LOG_FL_DBG, _T("WebServer: request prepared (Sz=%u)"), (!isUseGzip) ? pstrOut->GetLength() : uiGzipLen);
#endif
	// send answer ...
	if(!isUseGzip)
		Data.pSocket->SendContent(HTTPInit, pstrOut->GetString(), pstrOut->GetLength());
	else
		Data.pSocket->SendContent(HTTPInit "Content-Encoding: gzip\r\n", gzipOut, uiGzipLen);

	delete[] gzipOut;

#if 0
	AddLogLine(LOG_FL_DBG, _T("WebServer: request sent"));
#endif
	EMULE_CATCH

	CoUninitialize();

	EMULE_CATCH2
}

CString CWebServer::ParseURLArray(const CString &strURL, const TCHAR *pcFieldName)
{
	EMULE_TRY

	CString strRes, strFieldName(pcFieldName);
	int		iIdx, iPos;

	strFieldName += _T('=');
	for (iIdx = 0;;)
	{
		if ((iPos = strURL.Find(strFieldName, iIdx)) < 0)
			break;
		iIdx = iPos + strFieldName.GetLength();
		if ((iPos = strURL.Find(_T('&'), iIdx)) < 0)
			iPos = strURL.GetLength();
		strRes += strURL.Mid(iIdx, iPos - iIdx);
		strRes += _T('|');
	}
	if (!strRes.IsEmpty())
	{
		strRes.Replace(_T('+'), _T(' '));
		strRes = URLDecode(strRes);
	}
	return strRes;

	EMULE_CATCH
	return _T("");
}

CString CWebServer::_ParseURL(const CString &URL, const TCHAR *pcFieldName)
{
	EMULE_TRY

	CString strVal;
	int i, iIdx, findPos, findLength = 0;

	if ((iIdx = URL.Find(_T('?'))) >= 0)
	{
		iIdx++;

		CString	fieldname(pcFieldName);

	// Search the fieldname beginning / middle and strip the rest...
		fieldname += _T('=');
		findPos = -1;
		if (URL.Find(fieldname, iIdx) == iIdx)
		{
			findPos = iIdx;
			findLength = fieldname.GetLength();
		}
		else if ((i = URL.Find(_T('&') + fieldname, iIdx)) >= 0)
		{
			findPos = i;
			findLength = fieldname.GetLength() + 1;
		}
		if (findPos >= 0)
		{
			iIdx = findPos + findLength;
			if ((findPos = URL.Find(_T('&'), iIdx)) < 0)
				findPos = URL.GetLength();
			strVal = URL.Mid(iIdx, findPos - iIdx);

		//	Decode value, CR/LF have to be preserved to allow insertion of multiple ed2k-links
			strVal.Replace(_T('+'), _T(' '));
			strVal = URLDecode(strVal, true);
		}
	}

	return strVal;

	EMULE_CATCH

	return _T("");
}

CString CWebServer::GetHeader(const ThreadData &Data, long lSession, const CString &strCommand)
{
	EMULE_TRY

	CString sSession; sSession.Format(_T("%ld"), lSession);
	CString Out(m_Templates.sHeader);

	Out.Replace(_T("[CharSet]"), GetWebCharSet());

//	Auto-refresh code
	CString sRefresh, sCat, strVersionCheck;
	CString strTmp = _ParseURL(Data.sURL, _T("cat"));
	CString strCmd(strCommand);
	bool bAdmin = IsSessionAdmin(Data,sSession);
	int cat = _tstoi(strTmp);

	if (cat != 0)
		sCat.Format(_T("&cat=%u"), cat);

	if (strCmd == _T("options") || strCmd == _T("stats") || strCmd == _T("password"))
		sRefresh = _T("0");
	else
		sRefresh.Format(_T("%d"), g_App.m_pPrefs->GetWebPageRefresh()*1000);

	strCmd.AppendFormat(_T("&amp;cat=%s&amp;dummy=%u"), strTmp, rand());
	strVersionCheck.Format(_T("http://updates.emuleplus.info/version_check.php?version=%i&language=%i"),CURRENT_PLUS_VERSION,g_App.m_pPrefs->GetLanguageID());

	Out.Replace(_T("[admin]"), (bAdmin) ? _T("admin") : _T(""));
	Out.Replace(_T("[Session]"), sSession);
	Out.Replace(_T("[RefreshVal]"), sRefresh);
	Out.Replace(_T("[wCommand]"), strCmd);

	strCmd.Replace(_T("&amp;"), _T("&"));

	Out.Replace(_T("[wCommandJ]"), strCmd);
	Out.Replace(_T("[Nick]"), _SpecialChars(g_App.m_pPrefs->GetUserNick()));
	Out.Replace(_T("[eMuleAppName]"), CLIENT_NAME);
	Out.Replace(_T("[version]"), CURRENT_VERSION_LONG);
	Out.Replace(_T("[WebControl]"), _GetPlainResString(IDS_WEB_CONTROL));
	Out.Replace(_T("[StyleSheet]"), m_Templates.sHeaderStylesheet);
	Out.Replace(_T("[Transfer]"), _GetPlainResString(IDS_CD_TRANS));
	Out.Replace(_T("[Server]"), _GetPlainResString(IDS_SERVERS));
	Out.Replace(_T("[Shared]"), _GetPlainResString(IDS_SHAREDFILES));
	Out.Replace(_T("[Graphs]"), _GetPlainResString(IDS_GRAPHS));
	Out.Replace(_T("[Log]"), _GetPlainResString(IDS_SV_LOG));
	Out.Replace(_T("[ServerInfo]"), _GetPlainResString(IDS_SV_SERVERINFO));
	Out.Replace(_T("[DebugLog]"), _GetPlainResString(IDS_SV_DEBUGLOG));
	Out.Replace(_T("[Stats]"), _GetPlainResString(IDS_STATISTICS));
	Out.Replace(_T("[Options]"), GetResString(IDS_PREFERENCES));
	Out.Replace(_T("[Ed2klink]"), _GetPlainResString(IDS_SW_LINK));
	Out.Replace(_T("[Close]"), _GetPlainResString(IDS_WEB_CLOSE, true));
	Out.Replace(_T("[Reboot]"), _GetPlainResString(IDS_WEB_REBOOT, true));
	Out.Replace(_T("[Shutdown]"), _GetPlainResString(IDS_WEB_SHUTDOWN, true));
	Out.Replace(_T("[Logout]"), _GetPlainResString(IDS_WEB_LOGOUT));
	Out.Replace(_T("[WebOptions]"), _GetPlainResString(IDS_WEB_OPTIONS));
	Out.Replace(_T("[Search]"), _GetPlainResString(IDS_SEARCH_NOUN));
	Out.Replace(_T("[Download]"), _GetPlainResString(IDS_SW_DOWNLOAD));
	Out.Replace(_T("[Start]"), _GetPlainResString(IDS_SW_START));
	Out.Replace(_T("[Version]"), _GetPlainResString(IDS_SERVER_VERSION));
	Out.Replace(_T("[VersionCheck]"), strVersionCheck);
	if (CCat::GetNumCats() > 1)
		InsertCatBox(Out, 0, m_Templates.sCatArrow, false, false, sSession, NULL);
	else
		Out.Replace(_T("[CATBOX]"), _T(""));

	Out.Replace(_T("[FileIsHashing]"), _GetPlainResString(IDS_HASHING, true));
	Out.Replace(_T("[FileIsErroneous]"), _GetPlainResString(IDS_ERRORLIKE, true));
	Out.Replace(_T("[FileIsCompleting]"), _GetPlainResString(IDS_COMPLETING, true));
	Out.Replace(_T("[FileDetails]"), _GetPlainResString(IDS_FD_TITLE, true));
	Out.Replace(_T("[ClearCompleted]"), _GetPlainResString(IDS_DL_CLEAR, true));
	Out.Replace(_T("[A4AF]"), _GetPlainResString(IDS_ALL_A4AF_TO_HERE, true));
	Out.Replace(_T("[A4AFSameCat]"), _GetPlainResString(IDS_ALL_A4AF_SAMECAT, true));
	Out.Replace(_T("[AUTOA4AF]"), _GetPlainResString(IDS_TREE_DL_A4AF_AUTO, true));
	Out.Replace(_T("[A4AFSwap]"), _GetPlainResString(IDS_ALL_A4AF_TO_OTHER, true));
	Out.Replace(_T("[Resume]"), _GetPlainResString(IDS_RESUME, true));
	Out.Replace(_T("[Stop]"), _GetPlainResString(IDS_STOP_VERB, true));
	Out.Replace(_T("[Pause]"), _GetPlainResString(IDS_PAUSE_VERB, true));
	Out.Replace(_T("[ConfirmCancel]"), _GetPlainResString(IDS_Q_CANCELDL2, true));
	Out.Replace(_T("[Cancel]"), GetResString(IDS_MAIN_BTN_CANCEL));
	Out.Replace(_T("[GetFLC]"), _GetPlainResString(IDS_MOVIE, true));
	Out.Replace(_T("[Rename]"), _GetPlainResString(IDS_RENAME, true));
	Out.Replace(_T("[Connect]"), _GetPlainResString(IDS_IRC_CONNECT, true));
	Out.Replace(_T("[ConfirmRemove]"), _GetPlainResString(IDS_WEB_CONFIRM_REMOVE_SERVER, false));	// don't change (') as a string is for message box
	Out.Replace(_T("[ConfirmClose]"), _GetPlainResString(IDS_MAIN_CLOSE, false));	// don't change (') as a string is for message box
	Out.Replace(_T("[ConfirmReboot]"), _GetPlainResString(IDS_MAIN_REBOOT, false));	// don't change (') as a string is for message box
	Out.Replace(_T("[ConfirmShutdown]"), _GetPlainResString(IDS_MAIN_SHUTDOWN, false));	// don't change (') as a string is for message box
	Out.Replace(_T("[RemoveServer]"), _GetPlainResString(IDS_REMOVETHIS, true));
	Out.Replace(_T("[StaticServer]"), _GetPlainResString(IDS_STATICSERVER, true));
	Out.Replace(_T("[ConfirmJumpstart]"), _GetPlainResString(IDS_JS_DISABLE, true) + _T("\\n"));
	Out.Replace(_T("[Friend]"), _GetPlainResString(IDS_FRIEND, true));
	Out.Replace(_T("[CatSel]"), sCat);

	Out.Replace(_T("[PriorityVeryLow]"), _GetPlainResString(IDS_PRIOVERYLOW, true));
	Out.Replace(_T("[PriorityLow]"), _GetPlainResString(IDS_PRIOLOW, true));
	Out.Replace(_T("[PriorityNormal]"), _GetPlainResString(IDS_PRIONORMAL, true));
	Out.Replace(_T("[PriorityHigh]"), _GetPlainResString(IDS_PRIOHIGH, true));
	Out.Replace(_T("[PriorityRelease]"), _GetPlainResString(IDS_PRIORELEASE, true));
	Out.Replace(_T("[PriorityAuto]"), _GetPlainResString(IDS_PRIOAUTO, true));

	Out.Replace(_T("[SetTimerOn]"), _GetPlainResString(IDS_TIMER_ON));
	Out.Replace(_T("[SetTimerOff]"), _GetPlainResString(IDS_TIMER_OFF));
	Out.Replace(_T("[SetTimerDisabled]"), _GetPlainResString(IDS_DISABLED));

	CString HTTPConText, HTTPHelp;
	CString HTTPHelpU = _T("0");
	CString HTTPHelpM = _T("0");
	CString HTTPHelpV = _T("0");
	CString HTTPHelpF = _T("0");
	TCHAR HTTPHeader[100] = _T(""), *pcHTTPConState;

	CString sCmd = _ParseURL(Data.sURL, _T("c"));

	if (sCmd.CompareNoCase(_T("togglemenulock")) == 0)
		m_pWSPrefs->bMenuLocked = !m_pWSPrefs->bMenuLocked;

	Out.Replace(_T("[MenuLocked]"), m_pWSPrefs->bMenuLocked ? _T("true") : _T("false"));
	Out.Replace(_T("[MenuLockTitle]"), _GetPlainResString(m_pWSPrefs->bMenuLocked ? IDS_MENULOCK_OFF : IDS_MENULOCK_ON));

	bool disconnectissued = (sCmd.CompareNoCase(_T("disconnect")) == 0);
	bool connectissued = (sCmd.CompareNoCase(_T("connect")) == 0);
	uint32		dwMax;

#ifdef OLD_SOCKETS_ENABLED
	if ((g_App.m_pServerConnect->IsConnecting() && !disconnectissued) || connectissued)
	{
		pcHTTPConState = _T("connecting");
		HTTPConText = _GetPlainResString(IDS_CONNECTING);
	}
	else if (g_App.m_pServerConnect->IsConnected() && !disconnectissued)
	{
		pcHTTPConState = (g_App.m_pServerConnect->IsLowID()) ? _T("low") : _T("high");

		CServer	*pCurServer = g_App.m_pServerConnect->GetCurrentServer();
		CServer	*cur_server = g_App.m_pServerList->GetServerByAddress(
			pCurServer->GetAddress(), pCurServer->GetPort() );

		if(cur_server->GetListName().GetLength() > SHORT_LENGTH)
			HTTPConText = cur_server->GetListName().Left(SHORT_LENGTH-3) + _T("...");
		else
			HTTPConText = cur_server->GetListName();
		HTTPHelpU = CastItoThousands(cur_server->GetNumUsers());
		HTTPHelpM = CastItoThousands(cur_server->GetMaxUsers());
		HTTPHelpF = CastItoThousands(cur_server->GetFiles());
		if ((dwMax = cur_server->GetMaxUsers()) != 0)
			HTTPHelpV.Format(_T("%u"), (100 * cur_server->GetNumUsers() + dwMax / 2) / dwMax);
	}
	else
#endif //OLD_SOCKETS_ENABLED
	{
		pcHTTPConState = _T("disconnected");
		HTTPConText = _GetPlainResString(IDS_DISCONNECTED);
		if (IsSessionAdmin(Data, sSession))
			HTTPConText.AppendFormat(_T(" (<a href=\"/?ses=%s&amp;w=server&amp;c=connect\">%s</a>)"), sSession, _GetPlainResString(IDS_CONNECTTOANYSERVER));
	}
	int allUsers = 0;
	int allFiles = 0;
	for (uint32 sc = 0; sc < g_App.m_pServerList->GetServerCount(); sc++)
	{
		CServer	*cur_server = g_App.m_pServerList->GetServerAt(sc);

		allUsers += cur_server->GetNumUsers();
		allFiles += cur_server->GetFiles();
	}
	Out.Replace(_T("[AllUsers]"), CastItoThousands(allUsers));
	Out.Replace(_T("[AllFiles]"), CastItoThousands(allFiles));
	Out.Replace(_T("[ConState]"), pcHTTPConState);
	Out.Replace(_T("[ConText]"), HTTPConText);
	_stprintf(HTTPHeader, _T("%.f"), static_cast<double>(100 * g_App.m_pUploadQueue->GetDataRate()) / 102.4 / g_App.m_pPrefs->GetMaxUpload());
	Out.Replace(_T("[UploadValue]"), HTTPHeader);

	if(g_App.m_pPrefs->GetMaxDownload() == UNLIMITED)
		_stprintf(HTTPHeader, _T("%.f"), static_cast<double>(100 * g_App.m_pDownloadQueue->GetDataRate()) / 102.4 / g_App.m_pPrefs->GetMaxGraphDownloadRate());
	else
		_stprintf(HTTPHeader, _T("%.f"), static_cast<double>(100 * g_App.m_pDownloadQueue->GetDataRate()) / 102.4 / g_App.m_pPrefs->GetMaxDownload());
	Out.Replace(_T("[DownloadValue]"), HTTPHeader);
#ifdef OLD_SOCKETS_ENABLED
	dwMax = g_App.m_pPrefs->GetMaxConnections();
	_stprintf(HTTPHeader, _T("%u"), (100 * g_App.m_pListenSocket->GetNumOpenSockets() + dwMax / 2) / dwMax);
	Out.Replace(_T("[ConnectionValue]"), HTTPHeader);
	_stprintf(HTTPHeader, _T("%.1f"), (static_cast<double>(g_App.m_pUploadQueue->GetDataRate())/1024.0));
	Out.Replace(_T("[CurUpload]"), HTTPHeader);
	_stprintf(HTTPHeader, _T("%.1f"), (static_cast<double>(g_App.m_pDownloadQueue->GetDataRate())/1024.0));
	Out.Replace(_T("[CurDownload]"), HTTPHeader);
	_stprintf(HTTPHeader, _T("%u"), g_App.m_pListenSocket->GetNumOpenSockets());
	Out.Replace(_T("[CurConnection]"), HTTPHeader);
#endif //OLD_SOCKETS_ENABLED

	FractionalRate2String(&HTTPHelp, g_App.m_pPrefs->GetMaxUpload());
	Out.Replace(_T("[MaxUpload]"), HTTPHelp);

	dwMax = g_App.m_pPrefs->GetMaxDownload();
	if (dwMax == UNLIMITED)
		HTTPHelp = GetResString(IDS_PW_UNLIMITED);
	else
		FractionalRate2String(&HTTPHelp, dwMax);
	Out.Replace(_T("[MaxDownload]"), HTTPHelp);

	HTTPHelp.Format(_T("%u"), g_App.m_pPrefs->GetMaxConnections());
	Out.Replace(_T("[MaxConnection]"), HTTPHelp);
	Out.Replace(_T("[UserValue]"), HTTPHelpV);
	Out.Replace(_T("[MaxUsers]"), HTTPHelpM);
	Out.Replace(_T("[CurUsers]"), HTTPHelpU);
	Out.Replace(_T("[CurFiles]"), HTTPHelpF);

	COleDateTime	CurDateTime(COleDateTime::GetCurrentTime());

	Out.Replace(_T("[CurDate]"), CurDateTime.Format(_T("%Y.%m.%d")));
	Out.Replace(_T("[CurTime]"), CurDateTime.Format(_T("%H:%M:%S")));
	Out.Replace(_T("[Connection]"), _GetPlainResString(IDS_PW_CONNECTION));
	Out.Replace(_T("[QuickStats]"), _GetPlainResString(IDS_PW_QUICKSTATS));

	Out.Replace(_T("[Users]"), _GetPlainResString(IDS_UUSERS));
	Out.Replace(_T("[Files]"), _GetPlainResString(IDS_FILES));
	Out.Replace(_T("[Con]"), _GetPlainResString(IDS_ST_ACTIVECONNECTIONS));
	Out.Replace(_T("[Up]"), _GetPlainResString(IDS_UPLOAD_NOUN));
	Out.Replace(_T("[Down]"), _GetPlainResString(IDS_DOWNLOAD_NOUN));
	return Out;

	EMULE_CATCH

	return _T("");
}

CString CWebServer::_GetFooter(const ThreadData &Data)
{
	EMULE_TRY

	CWebServer *pThis = (CWebServer *)Data.pThis;
	if(pThis == NULL)
		return _T("");

	return pThis->m_Templates.sFooter;

	EMULE_CATCH

	return _T("");
}

CString CWebServer::GetServerList(const ThreadData &Data)
{
	static const TCHAR *s_apcSrvSortTab1[WS_SRVCOL_NUMCOLUMNS] =
	{
		_T("state"),		//WS_SRVCOL_STATE
		_T("name"),			//WS_SRVCOL_NAME
		_T("ip"),			//WS_SRVCOL_IP
		_T("description"),	//WS_SRVCOL_DESCRIPTION
		_T("ping"),			//WS_SRVCOL_PING
		_T("users"),		//WS_SRVCOL_USERS
		_T("files"),		//WS_SRVCOL_FILES
		_T("priority"),		//WS_SRVCOL_PRIORITY
		_T("failed"),		//WS_SRVCOL_FAILED
		_T("limit"),		//WS_SRVCOL_LIMIT
		_T("version")		//WS_SRVCOL_VERSION
	};
	static const TCHAR *s_apcSrvSortTab2[WS_SRVCOL_NUMCOLUMNS] =
	{
		_T("[SortState]"),		//WS_SRVCOL_STATE
		_T("[SortName]"),		//WS_SRVCOL_NAME
		_T("[SortIP]"),			//WS_SRVCOL_IP
		_T("[SortDescription]"),//WS_SRVCOL_DESCRIPTION
		_T("[SortPing]"),		//WS_SRVCOL_PING
		_T("[SortUsers]"),		//WS_SRVCOL_USERS
		_T("[SortFiles]"),		//WS_SRVCOL_FILES
		_T("[SortPriority]"),	//WS_SRVCOL_PRIORITY
		_T("[SortFailed]"),		//WS_SRVCOL_FAILED
		_T("[SortLimit]"),		//WS_SRVCOL_LIMIT
		_T("[SortVersion]")		//WS_SRVCOL_VERSION
	};
	static const WSListDefinition s_aSrvColTab[ARRSIZE(m_pWSPrefs->abServerColHidden)] =
	{
		{ IDS_SL_SERVERNAME, _T("[ServernameI]"), _T("[ServernameH]"), _T("[ServernameM]") },
		{ IDS_IP, _T("[AddressI]"), _T("[AddressH]"), _T("[AddressM]") },
		{ IDS_DESCRIPTION, _T("[DescriptionI]"), _T("[DescriptionH]"), _T("[DescriptionM]") },
		{ IDS_PING, _T("[PingI]"), _T("[PingH]"), _T("[PingM]") },
		{ IDS_UUSERS, _T("[UsersI]"), _T("[UsersH]"), _T("[UsersM]") },
		{ IDS_FILES, _T("[FilesI]"), _T("[FilesH]"), _T("[FilesM]") },
		{ IDS_PRIORITY, _T("[PriorityI]"), _T("[PriorityH]"), _T("[PriorityM]") },
		{ IDS_UFAILED, _T("[FailedI]"), _T("[FailedH]"), _T("[FailedM]") },
		{ IDS_SERVER_SOFTHARDLIMIT, _T("[LimitI]"), _T("[LimitH]"), _T("[LimitM]") },
		{ IDS_SERVER_VERSION, _T("[VersionI]"), _T("[VersionH]"), _T("[VersionM]") },
	};
	EMULE_TRY

	int		iCat = _tstoi(_ParseURL(Data.sURL, _T("cat"))) & 0xFF;
	CString	sCat;

	if (iCat != 0)
		sCat.Format(_T("%u"), iCat);

	CString sSession = _ParseURL(Data.sURL, _T("ses"));
	bool bAdmin = IsSessionAdmin(Data, sSession);
	CString sAddServerBox = GetAddServerBox(Data);

	CString sCmd(_ParseURL(Data.sURL, _T("c")));
	CString sIP(_ParseURL(Data.sURL, _T("ip")));
	uint16 uPort = static_cast<uint16>(_tstoi(_ParseURL(Data.sURL, _T("port"))));
	if (bAdmin && sCmd.CompareNoCase(_T("connect")) == 0)
	{
		if(sIP.IsEmpty())
			g_App.m_pMDlg->SendMessage(WM_COMMAND, MP_CONNECT);
		else
			_ConnectToServer(sIP, uPort);
	}
	else if (bAdmin && sCmd.CompareNoCase(_T("disconnect")) == 0)
	{
#ifdef OLD_SOCKETS_ENABLED
		if (g_App.m_pServerConnect->IsConnecting())
		{
			g_App.m_pServerConnect->StopConnectionTry();
			g_App.m_pMDlg->ShowConnectionState(false);
		}
		else
#endif //OLD_SOCKETS_ENABLED
			g_App.m_pMDlg->SendMessage(WM_COMMAND, MP_DISCONNECT);
	}
	else if (bAdmin && sCmd.CompareNoCase(_T("remove")) == 0)
	{
		if(!sIP.IsEmpty())
			_RemoveServer(sIP, uPort);
	}
	else if (bAdmin && sCmd.CollateNoCase(_T("addtostatic")) == 0)
	{
		if(!sIP.IsEmpty())
			_AddToStatic(sIP, uPort);
	}
	else if (bAdmin && sCmd.CompareNoCase(_T("removefromstatic")) == 0)
	{
		if(!sIP.IsEmpty())
			_RemoveFromStatic(sIP, uPort);
	}
	else if (bAdmin && sCmd.CompareNoCase(_T("priolow")) == 0)
	{
		if(!sIP.IsEmpty())
		{
			CServer	*server = g_App.m_pServerList->GetServerByAddress(sIP, uPort);
			server->SetPreference(PR_LOW);
			if (g_App.m_pMDlg->m_wndServer)
				g_App.m_pMDlg->m_wndServer.m_ctlServerList.RefreshServer(*server);
		}
	}
	else if (bAdmin && sCmd.CompareNoCase(_T("prionormal")) == 0)
	{
		if(!sIP.IsEmpty())
		{
			CServer	*server = g_App.m_pServerList->GetServerByAddress(sIP, uPort);
			server->SetPreference(PR_NORMAL);
			if (g_App.m_pMDlg->m_wndServer)
				g_App.m_pMDlg->m_wndServer.m_ctlServerList.RefreshServer(*server);
		}
	}
	else if (bAdmin && sCmd.CompareNoCase(_T("priohigh")) == 0)
	{
		if(!sIP.IsEmpty())
		{
			CServer	*server = g_App.m_pServerList->GetServerByAddress(sIP, uPort);
			server->SetPreference(PR_HIGH);
			if (g_App.m_pMDlg->m_wndServer)
				g_App.m_pMDlg->m_wndServer.m_ctlServerList.RefreshServer(*server);
		}
	}
	else if (sCmd.CompareNoCase(_T("menu")) == 0)
		SetHiddenColumnState(Data.sURL, m_pWSPrefs->abServerColHidden, ARRSIZE(m_pWSPrefs->abServerColHidden));

	CString strTmp = _ParseURL(Data.sURL, _T("sortreverse"));
	CString strSort = _ParseURL(Data.sURL, _T("sort"));

	if (!strSort.IsEmpty())
	{
		for (unsigned ui = 0; ui < ARRSIZE(s_apcSrvSortTab1); ui++)
		{
			if (strSort.Compare(s_apcSrvSortTab1[ui]) == 0)
			{
				m_pWSPrefs->dwServerSort = ui;
				break;
			}
		}
		if (!strTmp.IsEmpty())
			m_pWSPrefs->abServerSortAsc[m_pWSPrefs->dwServerSort] = (strTmp == _T("true"));
	}

	CString Out = m_Templates.sServerList;

	Out.Replace(_T("[AddServerBox]"), sAddServerBox);
	Out.Replace(_T("[Session]"), sSession);
	Out.Replace(_T("[CatSel]"), sCat);

	const TCHAR *pcTmp = (m_pWSPrefs->abServerSortAsc[m_pWSPrefs->dwServerSort]) ? _T("&amp;sortreverse=false") : _T("&amp;sortreverse=true");

	for (unsigned ui = 0; ui < ARRSIZE(s_apcSrvSortTab2); ui++)
		Out.Replace(s_apcSrvSortTab2[ui], (m_pWSPrefs->dwServerSort == ui) ? pcTmp : _T(""));

	Out.Replace(_T("[ServerList]"), _GetPlainResString(IDS_SERVERS));

	const TCHAR *pcSortIcon = (m_pWSPrefs->abServerSortAsc[m_pWSPrefs->dwServerSort]) ? m_Templates.sUpArrow : m_Templates.sDownArrow;

	for (unsigned ui = 0; ui < ARRSIZE(s_aSrvColTab); ui++)
	{
		GetPlainResString(&strTmp, s_aSrvColTab[ui].dwResStrId, true);
		if (!m_pWSPrefs->abServerColHidden[ui])
		{
			Out.Replace( s_aSrvColTab[ui].pcColIcon,
				(m_pWSPrefs->dwServerSort == (ui + WS_SRVCOL_NAME)) ? pcSortIcon : _T("") );
			Out.Replace(s_aSrvColTab[ui].pcColHdr, strTmp);
		}
		else
		{
			Out.Replace(s_aSrvColTab[ui].pcColIcon, _T(""));
			Out.Replace(s_aSrvColTab[ui].pcColHdr, _T(""));
		}
		Out.Replace(s_aSrvColTab[ui].pcColMenu, strTmp);
	}

	Out.Replace(_T("[Actions]"), _GetPlainResString(IDS_WEB_ACTIONS));

	CArray<ServerEntry> ServerArray;

#ifdef OLD_SOCKETS_ENABLED
	CServer		*tempServer;
#endif OLD_SOCKETS_ENABLED
	// Populating array
	for (uint32 sc = 0; sc < g_App.m_pServerList->GetServerCount(); sc++)
	{
		CServer* cur_file = g_App.m_pServerList->GetServerAt(sc);
		ServerEntry Entry;
		Entry.sServerName = _SpecialChars(cur_file->GetListName());
		Entry.sServerIP = cur_file->GetAddress();
		Entry.nServerPort = cur_file->GetPort();
		Entry.sServerDescription = _SpecialChars(cur_file->GetDescription());
		Entry.nServerPing = cur_file->GetPing();
		Entry.nServerUsers = cur_file->GetNumUsers();
		Entry.nServerMaxUsers = cur_file->GetMaxUsers();
		Entry.nServerFiles = cur_file->GetFiles();
		Entry.bServerStatic = cur_file->IsStaticMember();
		if(cur_file->GetPreferences() == PR_HIGH)
		{
			Entry.sServerPriority = _GetPlainResString(IDS_PRIOHIGH);
			Entry.nServerPriority = 2;
		}
		else if(cur_file->GetPreferences() == PR_NORMAL)
		{
			Entry.sServerPriority = _GetPlainResString(IDS_PRIONORMAL);
			Entry.nServerPriority = 1;
		}
		else if(cur_file->GetPreferences() == PR_LOW)
		{
			Entry.sServerPriority = _GetPlainResString(IDS_PRIOLOW);
			Entry.nServerPriority = 0;
		}
		Entry.nServerFailed = cur_file->GetFailedCount();
		Entry.nServerSoftLimit = cur_file->GetSoftMaxFiles();
		Entry.nServerHardLimit = cur_file->GetHardMaxFiles();
		Entry.sServerVersion = cur_file->GetVersion();
		if (inet_addr(Entry.sServerIP) != INADDR_NONE)
		{
			int counter = 0;
			CString newip;
			for(int j = 0; j < 4; j++)
			{
				strTmp = Entry.sServerIP.Tokenize(_T("."), counter);
				if (strTmp.GetLength() == 1)
					newip += _T("00");
				else if (strTmp.GetLength() == 2)
					newip += _T("0");
				newip += strTmp;
			}
			Entry.sServerFullIP = newip;
		}
		else
			Entry.sServerFullIP = Entry.sServerIP;
		if (cur_file->GetFailedCount() > 0)
			Entry.sServerState = _T("failed");
		else
			Entry.sServerState = _T("disconnected");
#ifdef OLD_SOCKETS_ENABLED
		if (g_App.m_pServerConnect->IsConnecting())
		{
			tempServer = g_App.m_pServerConnect->GetConnectingServer();
			if (tempServer->GetAddress() == cur_file->GetAddress())
				Entry.sServerState = _T("connecting");
		}
		else if (g_App.m_pServerConnect->IsConnected())
		{
			tempServer = g_App.m_pServerConnect->GetCurrentServer();
			if (tempServer->GetAddress() == cur_file->GetAddress())
			{
				if (!g_App.m_pServerConnect->IsLowID())
					Entry.sServerState = _T("high");
				else
					Entry.sServerState = _T("low");
			}
		}
#endif //OLD_SOCKETS_ENABLED
		ServerArray.Add(Entry);
	}
	// Sorting (simple bubble sort, we don't have tons of data here)
	bool	bSortReverse, bSorted = true;

	bSortReverse = m_pWSPrefs->abServerSortAsc[m_pWSPrefs->dwServerSort];
	for (int nMax = 0; bSorted && nMax < ServerArray.GetCount()*2; nMax++)
	{
		bSorted = false;
		for(int i = 0; i < ServerArray.GetCount() - 1; i++)
		{
			bool bSwap = false;
			switch (m_pWSPrefs->dwServerSort)
			{
				case WS_SRVCOL_STATE:
					bSwap = ServerArray[i].sServerState.CompareNoCase(ServerArray[i+1].sServerState) > 0;
					break;
				case WS_SRVCOL_NAME:
					bSwap = ServerArray[i].sServerName.CompareNoCase(ServerArray[i+1].sServerName) < 0;
					break;
				case WS_SRVCOL_IP:
					bSwap = ServerArray[i].sServerFullIP < ServerArray[i+1].sServerFullIP;
					break;
				case WS_SRVCOL_DESCRIPTION:
					bSwap = ServerArray[i].sServerDescription.CompareNoCase(ServerArray[i+1].sServerDescription) < 0;
					break;
				case WS_SRVCOL_PING:
					bSwap = ServerArray[i].nServerPing < ServerArray[i+1].nServerPing;
					break;
				case WS_SRVCOL_USERS:
					bSwap = ServerArray[i].nServerUsers < ServerArray[i+1].nServerUsers;
					break;
				case WS_SRVCOL_FILES:
					bSwap = ServerArray[i].nServerFiles < ServerArray[i+1].nServerFiles;
					break;
				case WS_SRVCOL_PRIORITY:
					bSwap = ServerArray[i].nServerPriority < ServerArray[i+1].nServerPriority;
					break;
				case WS_SRVCOL_FAILED:
					bSwap = ServerArray[i].nServerFailed < ServerArray[i+1].nServerFailed;
					break;
				case WS_SRVCOL_LIMIT:
					bSwap = ServerArray[i].nServerSoftLimit < ServerArray[i+1].nServerSoftLimit;
					break;
				case WS_SRVCOL_VERSION:
					bSwap = ServerArray[i].sServerVersion < ServerArray[i+1].sServerVersion;
					break;
			}
			if (bSortReverse)
				bSwap = !bSwap;
			if (bSwap)
			{
				bSorted = true;
				ServerEntry TmpEntry = ServerArray[i];
				ServerArray[i] = ServerArray[i+1];
				ServerArray[i+1] = TmpEntry;
			}
		}
	}

//	Displaying
	const TCHAR	*pcTmp2;
	CString sList, HTTPProcessData, sServerPort, ed2k;
	CString OutE(m_Templates.sServerLine);

	OutE.Replace(_T("[admin]"), (bAdmin) ? _T("admin") : _T(""));
	OutE.Replace(_T("[session]"), sSession);

	for(int i = 0; i < ServerArray.GetCount(); i++)
	{
		HTTPProcessData = OutE;	// Copy Entry Line to Temp

		sServerPort.Format(_T("%u"), ServerArray[i].nServerPort);
		ed2k.Format(_T("ed2k://|server|%s|%s|/"), ServerArray[i].sServerIP, sServerPort);

		if (ServerArray[i].sServerIP == _ParseURL(Data.sURL,_T("ip")) && sServerPort == _ParseURL(Data.sURL,_T("port")))
			pcTmp = _T("checked");
		else
			pcTmp = _T("checked_no");
		HTTPProcessData.Replace(_T("[LastChangedDataset]"), pcTmp);

		if (ServerArray[i].bServerStatic)
		{
			pcTmp = _T("staticsrv");
			pcTmp2 = _T("static");
		}
		else
		{
			pcTmp = _T("");
			pcTmp2 = _T("none");
		}
		HTTPProcessData.Replace(_T("[isstatic]"), pcTmp);
		HTTPProcessData.Replace(_T("[ServerType]"), pcTmp2);

		const TCHAR *pcSrvPriority = _T("");

		switch(ServerArray[i].nServerPriority)
		{
			case 0:
				pcSrvPriority = _T("Low");
				break;
			case 1:
				pcSrvPriority = _T("Normal");
				break;
			case 2:
				pcSrvPriority = _T("High");
				break;
		}

		HTTPProcessData.Replace(_T("[ed2k]"), ed2k);
		HTTPProcessData.Replace(_T("[ip]"), ServerArray[i].sServerIP);
		HTTPProcessData.Replace(_T("[port]"), sServerPort);
		HTTPProcessData.Replace(_T("[server-priority]"), pcSrvPriority);

		// DonGato: reduced large servernames or descriptions
		if (!m_pWSPrefs->abServerColHidden[0])
		{
			if(ServerArray[i].sServerName.GetLength() > SHORT_LENGTH)
				HTTPProcessData.Replace(_T("[Servername]"), _T("<acronym title=\"") + ServerArray[i].sServerName + _T("\">") + ServerArray[i].sServerName.Left(SHORT_LENGTH-3) + _T("...") + _T("</acronym>"));
			else
				HTTPProcessData.Replace(_T("[Servername]"), ServerArray[i].sServerName);
		}
		else
			HTTPProcessData.Replace(_T("[Servername]"), _T(""));
		if (!m_pWSPrefs->abServerColHidden[1])
		{
			CString sPort; sPort.Format(_T(":%d"), ServerArray[i].nServerPort);
			HTTPProcessData.Replace(_T("[Address]"), ServerArray[i].sServerIP + sPort);
		}
		else
			HTTPProcessData.Replace(_T("[Address]"), _T(""));
		if (!m_pWSPrefs->abServerColHidden[2])
		{
			if(ServerArray[i].sServerDescription.GetLength() > SHORT_LENGTH)
				HTTPProcessData.Replace(_T("[Description]"), _T("<acronym title=\"") + ServerArray[i].sServerDescription + _T("\">") + ServerArray[i].sServerDescription.Left(SHORT_LENGTH-3) + _T("...") + _T("</acronym>"));
			else
				HTTPProcessData.Replace(_T("[Description]"), ServerArray[i].sServerDescription);
		}
		else
			HTTPProcessData.Replace(_T("[Description]"), _T(""));
		if (!m_pWSPrefs->abServerColHidden[3])
		{
			CString sPing; sPing.Format(_T("%d"), ServerArray[i].nServerPing);
			HTTPProcessData.Replace(_T("[Ping]"), sPing);
		}
		else
			HTTPProcessData.Replace(_T("[Ping]"), _T(""));
		CString sT;
		if (!m_pWSPrefs->abServerColHidden[4])
		{
			if(ServerArray[i].nServerUsers > 0)
			{
				if(ServerArray[i].nServerMaxUsers > 0)
					sT.Format(_T("%s (%s)"), CastItoThousands(ServerArray[i].nServerUsers), CastItoThousands(ServerArray[i].nServerMaxUsers));
				else
					sT.Format(_T("%s"), CastItoThousands(ServerArray[i].nServerUsers));
			}
			HTTPProcessData.Replace(_T("[Users]"), sT);
		}
		else
			HTTPProcessData.Replace(_T("[Users]"), _T(""));
		if (!m_pWSPrefs->abServerColHidden[5] && (ServerArray[i].nServerFiles > 0))
		{
			HTTPProcessData.Replace(_T("[Files]"), CastItoThousands(ServerArray[i].nServerFiles));
		}
		else
			HTTPProcessData.Replace(_T("[Files]"), _T(""));
		if (!m_pWSPrefs->abServerColHidden[6])
			HTTPProcessData.Replace(_T("[Priority]"), ServerArray[i].sServerPriority);
		else
			HTTPProcessData.Replace(_T("[Priority]"), _T(""));
		if (!m_pWSPrefs->abServerColHidden[7])
		{
			CString sFailed; sFailed.Format(_T("%d"), ServerArray[i].nServerFailed);
			HTTPProcessData.Replace(_T("[Failed]"), sFailed);
		}
		else
			HTTPProcessData.Replace(_T("[Failed]"), _T(""));
		if (!m_pWSPrefs->abServerColHidden[8])
		{
			CString		strTemp;

			strTemp.Format( _T("%s (%s)"), CastItoThousands(ServerArray[i].nServerSoftLimit),
				CastItoThousands(ServerArray[i].nServerHardLimit) );
			HTTPProcessData.Replace(_T("[Limit]"), strTemp);
		}
		else
			HTTPProcessData.Replace(_T("[Limit]"), _T(""));
		if (!m_pWSPrefs->abServerColHidden[9])
		{
			if(ServerArray[i].sServerVersion.GetLength() > SHORT_LENGTH_MIN)
				HTTPProcessData.Replace(_T("[Version]"), _T("<acronym title=\"") + ServerArray[i].sServerVersion + _T("\">") + ServerArray[i].sServerVersion.Left(SHORT_LENGTH-3) + _T("...") + _T("</acronym>"));
			else
				HTTPProcessData.Replace(_T("[Version]"), ServerArray[i].sServerVersion);
		}
		else
			HTTPProcessData.Replace(_T("[Version]"), _T(""));
		HTTPProcessData.Replace(_T("[ServerState]"), ServerArray[i].sServerState);
		sList += HTTPProcessData;
	}
	Out.Replace(_T("[ServersList]"), sList);

	return Out;

	EMULE_CATCH

	return _T("");
}

CString CWebServer::GetTransferList(const ThreadData &Data)
{
	static const TCHAR *s_apcDLSortTab1[WS_DLCOL_NUMCOLUMNS] =
	{
		_T("dstate"),		//WS_DLCOL_STATE
		_T("dtype"),		//WS_DLCOL_TYPE
		_T("dname"),		//WS_DLCOL_NAME
		_T("dsize"),		//WS_DLCOL_SIZE
		_T("dtransferred"),	//WS_DLCOL_TRANSFERRED
		_T("dprogress"),	//WS_DLCOL_PROGRESS
		_T("dspeed"),		//WS_DLCOL_SPEED
		_T("dsources"),		//WS_DLCOL_SOURCES
		_T("dpriority"),	//WS_DLCOL_PRIORITY
		_T("dcategory"),	//WS_DLCOL_CATEGORY
		_T("dfakecheck")	//WS_DLCOL_FAKECHECK
	};
	static const TCHAR *s_apcULSortTab1[WS_ULCOL_NUMCOLUMNS] =
	{
		_T("uclient"),		//WS_ULCOL_CLIENT
		_T("uuser"),		//WS_ULCOL_USER
		_T("uversion"),		//WS_ULCOL_VERSION
		_T("ufilename"),	//WS_ULCOL_FILENAME
		_T("utransferred"),	//WS_ULCOL_TRANSFERRED
		_T("uspeed")		//WS_ULCOL_SPEED
	};
	static const TCHAR *s_apcQUSortTab1[WS_QUCOL_NUMCOLUMNS] =
	{
		_T("qclient"),		//WS_QUCOL_CLIENT
		_T("quser"),		//WS_QUCOL_USER
		_T("qversion"),		//WS_QUCOL_VERSION
		_T("qfilename"),	//WS_QUCOL_FILENAME
		_T("qscore")		//WS_QUCOL_SCORE
	};
	static const TCHAR *s_apcDLSortTab2[WS_DLCOL_NUMCOLUMNS] =
	{
		_T("[SortDState]"),		//WS_DLCOL_STATE
		_T("[SortDType]"),		//WS_DLCOL_TYPE
		_T("[SortDName]"),		//WS_DLCOL_NAME
		_T("[SortDSize]"),		//WS_DLCOL_SIZE
		_T("[SortDTransferred]"),	//WS_DLCOL_TRANSFERRED
		_T("[SortDProgress]"),	//WS_DLCOL_PROGRESS
		_T("[SortDSpeed]"),		//WS_DLCOL_SPEED
		_T("[SortDSources]"),	//WS_DLCOL_SOURCES
		_T("[SortDPriority]"),	//WS_DLCOL_PRIORITY
		_T("[SortDCategory]"),	//WS_DLCOL_CATEGORY
		_T("[SortDFakeCheck]")	//WS_DLCOL_FAKECHECK
	};
	static const TCHAR *s_apcULSortTab2[WS_ULCOL_NUMCOLUMNS] =
	{
		_T("[SortUClient]"),		//WS_ULCOL_CLIENT
		_T("[SortUUser]"),			//WS_ULCOL_USER
		_T("[SortUVersion]"),		//WS_ULCOL_VERSION
		_T("[SortUFilename]"),		//WS_ULCOL_FILENAME
		_T("[SortUTransferred]"),	//WS_ULCOL_TRANSFERRED
		_T("[SortUSpeed]")			//WS_ULCOL_SPEED
	};
	static const TCHAR *s_apcQUSortTab2[WS_QUCOL_NUMCOLUMNS] =
	{
		_T("[SortQClient]"),		//WS_QUCOL_CLIENT
		_T("[SortQUser]"),			//WS_QUCOL_USER
		_T("[SortQVersion]"),		//WS_QUCOL_VERSION
		_T("[SortQFilename]"),		//WS_QUCOL_FILENAME
		_T("[SortQScore]")			//WS_QUCOL_SCORE
	};
	static const WSListDefinition s_aDLColTab[ARRSIZE(m_pWSPrefs->abDownloadColHidden)] =
	{
		{ IDS_DL_FILENAME, _T("[DFilenameI]"), _T("[DFilename]"), _T("[DFilename]") },
		{ IDS_DL_SIZE, _T("[DSizeI]"), _T("[DSize]"), _T("[DSizeM]") },
		{ IDS_SF_COMPLETED, _T("[DTransferredI]"), _T("[DTransferred]"), _T("[DTransferredM]") },
		{ IDS_DL_PROGRESS, _T("[DProgressI]"), _T("[DProgress]"), _T("[DProgressM]") },
		{ IDS_DL_SPEED, _T("[DSpeedI]"), _T("[DSpeed]"), _T("[DSpeedM]") },
		{ IDS_DL_SOURCES, _T("[DSourcesI]"), _T("[DSources]"), _T("[DSourcesM]") },
		{ IDS_PRIORITY, _T("[DPriorityI]"), _T("[DPriority]"), _T("[DPriorityM]") },
		{ IDS_CAT, _T("[DCategoryI]"), _T("[DCategory]"), _T("[DCategoryM]") },
		{ IDS_FAKE_CHECK_HEADER, _T("[DFakeCheckI]"), _T("[DFakeCheck]"), _T("[DFakeCheckM]") }
	};
	static const WSListDefinition s_aULColTab[ARRSIZE(m_pWSPrefs->abUploadColHidden)] =
	{
		{ IDS_QL_USERNAME, _T("[UUserI]"), _T("[UUser]"), _T("[UUserM]") },
		{ IDS_INFLST_USER_CLIENTVERSION, _T("[UVersionI]"), _T("[UVersion]"), _T("[UVersionM]") },
		{ IDS_DL_FILENAME, _T("[UFilenameI]"), _T("[UFilename]"), _T("[UFilenameM]") },
		{ IDS_DL_ULDL, _T("[UTransferredI]"), _T("[UTransferred]"), _T("[UTransferredM]") },
		{ IDS_DL_SPEED, _T("[USpeedI]"), _T("[USpeed]"), _T("[USpeedM]") }
	};
	static const WSListDefinition s_aQUColTab[ARRSIZE(m_pWSPrefs->abQueueColHidden)] =
	{
		{ IDS_QL_USERNAME, _T("[UserNameTitleI]"), _T("[UserNameTitle]"), _T("[UserNameTitleM]") },
		{ IDS_INFLST_USER_CLIENTVERSION, _T("[VersionI]"), _T("[Version]"), _T("[VersionM]") },
		{ IDS_DL_FILENAME, _T("[FileNameTitleI]"), _T("[FileNameTitle]"), _T("[FileNameTitleM]") },
		{ IDS_SCORE, _T("[ScoreTitleI]"), _T("[ScoreTitle]"), _T("[ScoreTitleM]") }
	};
	EMULE_TRY

	CString	strTmp, Out, sCat;
	int		iCat = _tstoi(_ParseURL(Data.sURL, _T("cat"))) & 0xFF;
	byte	abyteFileHash[16];

	if (iCat != 0)
		sCat.Format(_T("&cat=%u"), iCat);
	Out.Preallocate(50 * 1024);

	CString sSession = _ParseURL(Data.sURL, _T("ses"));

	bool bAdmin = IsSessionAdmin(Data,sSession);

	CString sClear(_ParseURL(Data.sURL, _T("clearcompleted")));
	if (bAdmin && !sClear.IsEmpty())
	{
		if (sClear.CompareNoCase(_T("all")) == 0)
		{
			EnumCategories eCatID = (iCat == 0) ? CAT_ALL : CCat::GetCatIDByUserIndex(iCat);
			_EnumCategories eCatIDforMessage = eCatID;

			g_App.m_pMDlg->SendMessage(WEB_CLEAR_COMPLETED, (WPARAM)0, static_cast<LPARAM>(eCatIDforMessage));

			iCat = (iCat == 0) ? 0 : CCat::UserCatIndexToCatIndex(iCat);
		}
		else if (md4cmp0(StringToHash(sClear, abyteFileHash)) != 0)
		{
			byte	*pabyteFileHash = new uchar[16];

			md4cpy(pabyteFileHash, abyteFileHash);
			g_App.m_pMDlg->SendMessage(WEB_CLEAR_COMPLETED, (WPARAM)1, reinterpret_cast<LPARAM>(pabyteFileHash));
		}
	}

	if (bAdmin)
	{
		strTmp = _ParseURL(Data.sURL, _T("ed2k"));
		if (!strTmp.IsEmpty())
		{
			EnumCategories	eCatID = (iCat == 0) ? CAT_NONE : CCat::GetCatIDByUserIndex(iCat);

			g_App.m_pMDlg->m_dlgSearch.AddEd2kLinksToDownload(strTmp, eCatID);
			iCat = (iCat == 0) ? 0 : CCat::UserCatIndexToCatIndex(iCat);
		}
	}

	strTmp = _ParseURL(Data.sURL, _T("c"));
	if (strTmp.Compare(_T("menudown")) == 0)
		SetHiddenColumnState(Data.sURL, m_pWSPrefs->abDownloadColHidden, ARRSIZE(m_pWSPrefs->abDownloadColHidden));
	else if (strTmp.Compare(_T("menuup")) == 0)
		SetHiddenColumnState(Data.sURL, m_pWSPrefs->abUploadColHidden, ARRSIZE(m_pWSPrefs->abUploadColHidden));
	else if (strTmp.Compare(_T("menuqueue")) == 0)
		SetHiddenColumnState(Data.sURL, m_pWSPrefs->abQueueColHidden, ARRSIZE(m_pWSPrefs->abQueueColHidden));
	else if (strTmp.Compare(_T("menuprio")) == 0)
	{
		if (bAdmin)
		{
			byte	bytePrio;
			
			strTmp = _ParseURL(Data.sURL, _T("p"));
			if(strTmp.CompareNoCase(_T("low")) == 0)
				bytePrio = PR_LOW;
			else if(strTmp.CompareNoCase(_T("high")) == 0)
				bytePrio = PR_HIGH;
			else if(strTmp.CompareNoCase(_T("auto")) == 0)
				bytePrio = PR_AUTO;
			else // _T("normal")
				bytePrio = PR_NORMAL;

			g_App.m_pDownloadQueue->SetCatPrio(iCat, bytePrio);
		}
	}

	if (bAdmin)
	{
		CString	sOp(_ParseURL(Data.sURL, _T("op")));

		if (!sOp.IsEmpty())
		{
			byte	abyteHashBuf[16];

			strTmp = _ParseURL(Data.sURL, _T("file"));
			if (!strTmp.IsEmpty())
			{
				CPartFile	*pFile;

				if ( md4cmp0(StringToHash(strTmp, abyteHashBuf)) != 0
					&& (pFile = g_App.m_pDownloadQueue->GetFileByID(abyteHashBuf)) != NULL )
				{	// All actions require a found file (removed double-check inside)
					if (sOp == _T("a4af"))
						pFile->DownloadAllA4AF();
					else if (sOp == _T("a4afsamecat"))
						pFile->DownloadAllA4AF(true);
					else if (sOp == _T("autoa4af"))
						g_App.m_pDownloadQueue->SetA4AFAutoFile(pFile);
					else if (sOp == _T("noautoa4af"))
						g_App.m_pDownloadQueue->SetA4AFAutoFile(NULL);
					else if (sOp == _T("a4afswap"))
					{
						ClientList	clientListCopy;

						pFile->GetCopySourceLists(SLM_ALLOWED_TO_A4AF_SWAP, &clientListCopy);
						for (ClientList::const_iterator cIt = clientListCopy.begin(); cIt != clientListCopy.end(); cIt++)
							(*cIt)->SwapToAnotherFile(NULL);
					}
					else if (sOp == _T("stop"))
						pFile->StopFile();
					else if (sOp == _T("pause"))
						pFile->PauseFile();
					else if (sOp == _T("resume"))
						pFile->ResumeFile();
					else if (sOp == _T("cancel"))
					{
						pFile->DeleteFile();
						g_App.m_pMDlg->m_wndTransfer.UpdateCatTabTitles();
					}
					else if (sOp == _T("getflc"))
						pFile->GetFirstLastChunk4Preview();
					else if (sOp == _T("rename"))
					{
						strTmp = _ParseURL(Data.sURL, _T("name"));
						g_App.m_pMDlg->SendMessage(WEB_FILE_RENAME, (WPARAM)pFile, (LPARAM)(LPCTSTR)strTmp);
					}
					else if (sOp == _T("priolow"))
					{
						pFile->SetAutoPriority(false);
						pFile->SetPriority(PR_LOW);
					}
					else if (sOp == _T("prionormal"))
					{
						pFile->SetAutoPriority(false);
						pFile->SetPriority(PR_NORMAL);
					}
					else if (sOp == _T("priohigh"))
					{
						pFile->SetAutoPriority(false);
						pFile->SetPriority(PR_HIGH);
					}
					else if (sOp == _T("prioauto"))
					{
						pFile->SetAutoPriority(true);
						pFile->SetPriority(PR_HIGH);
					}
					else if (sOp == _T("setcat"))
					{
						int	iMenu = _tstoi(_ParseURL(Data.sURL, _T("filecat")));

						if (iMenu != 0)
							pFile->SetCatID(CCat::GetCatIDByUserIndex(iMenu));
						else
							pFile->SetCatID(CAT_NONE);
					}
				}
			}
			else
			{
				CUpDownClient	*pClient = NULL;

				if ( (md4cmp0(StringToHash(_ParseURL(Data.sURL, _T("userhash")), abyteHashBuf)) != 0)
					&& ((pClient = g_App.m_pClientList->FindClientByUserHash(abyteHashBuf)) != NULL) )
				{
					if (sOp.CompareNoCase(_T("addfriend")) == 0)
						g_App.m_pFriendList->AddFriend(pClient);
					else if (sOp.CompareNoCase(_T("removefriend")) == 0)
						g_App.m_pFriendList->RemoveFriend(pClient);
				}
			}
		}
	}

	strTmp = _ParseURL(Data.sURL, _T("sortreverse"));

	CString strSort(_ParseURL(Data.sURL, _T("sort")));
	TCHAR	cCh = strSort.GetString()[0];

	if (!strSort.IsEmpty())
	{
		if (cCh == _T('d'))	// download list
		{
			for (unsigned ui = 0; ui < ARRSIZE(s_apcDLSortTab1); ui++)
			{
				if (strSort.Compare(s_apcDLSortTab1[ui]) == 0)
				{
					m_pWSPrefs->dwDownloadSort = ui;
					break;
				}
			}
		}
		else if (cCh == _T('u'))	// upload list
		{
			for (unsigned ui = 0; ui < ARRSIZE(s_apcULSortTab1); ui++)
			{
				if (strSort.Compare(s_apcULSortTab1[ui]) == 0)
				{
					m_pWSPrefs->dwUploadSort = ui;
					break;
				}
			}
		}
		else if (cCh == _T('q'))	// waiting queue
		{
			for (unsigned ui = 0; ui < ARRSIZE(s_apcQUSortTab1); ui++)
			{
				if (strSort.Compare(s_apcQUSortTab1[ui]) == 0)
				{
					m_pWSPrefs->dwQueueSort = ui;
					break;
				}
			}
		}
	}

	if (!strTmp.IsEmpty())
	{
		bool	bDirection = (strTmp == _T("true"));

		if (cCh == _T('d'))
			m_pWSPrefs->abDownloadSortAsc[m_pWSPrefs->dwDownloadSort] = bDirection;
		else if (cCh == _T('u'))
			m_pWSPrefs->abUploadSortAsc[m_pWSPrefs->dwUploadSort] = bDirection;
		else if (cCh == _T('q'))
			m_pWSPrefs->abQueueSortAsc[m_pWSPrefs->dwQueueSort] = bDirection;
	}

	strTmp = _ParseURL(Data.sURL, _T("showuploadqueue"));
	if (strTmp.CompareNoCase(_T("true")) == 0)
		m_pWSPrefs->bShowUploadQueue = true;
	else if (strTmp.CompareNoCase(_T("false")) == 0)
		m_pWSPrefs->bShowUploadQueue = false;

	strTmp = _ParseURL(Data.sURL, _T("showuploadqueuebanned"));
	if (strTmp.CompareNoCase(_T("true")) == 0)
		m_pWSPrefs->bShowUploadQueueBanned = true;
	else if (strTmp.CompareNoCase(_T("false")) == 0)
		m_pWSPrefs->bShowUploadQueueBanned = false;

	strTmp = _ParseURL(Data.sURL, _T("showuploadqueuefriend"));
	if (strTmp.CompareNoCase(_T("true")) == 0)
		m_pWSPrefs->bShowUploadQueueFriend = true;
	else if (strTmp.CompareNoCase(_T("false")) == 0)
		m_pWSPrefs->bShowUploadQueueFriend = false;

	strTmp = _ParseURL(Data.sURL, _T("showuploadqueuecredit"));
	if (strTmp.CompareNoCase(_T("true")) == 0)
		m_pWSPrefs->bShowUploadQueueCredit = true;
	else if (strTmp.CompareNoCase(_T("false")) == 0)
		m_pWSPrefs->bShowUploadQueueCredit = false;

	Out += m_Templates.sTransferImages;
	Out += m_Templates.sTransferList;
	Out.Replace(_T("[DownloadHeader]"), m_Templates.sTransferDownHeader);
	Out.Replace(_T("[DownloadFooter]"), m_Templates.sTransferDownFooter);
	Out.Replace(_T("[UploadHeader]"), m_Templates.sTransferUpHeader);
	Out.Replace(_T("[UploadFooter]"), m_Templates.sTransferUpFooter);
	Out.Replace(_T("[Session]"), sSession);

	InsertCatBox(Out, iCat, _T(""), true, true, sSession, NULL);

	const TCHAR	*pcTmp = (m_pWSPrefs->abDownloadSortAsc[m_pWSPrefs->dwDownloadSort]) ? _T("&amp;sortreverse=false") : _T("&amp;sortreverse=true");

	for (unsigned ui = 0; ui < ARRSIZE(s_apcDLSortTab2); ui++)
		Out.Replace(s_apcDLSortTab2[ui], (m_pWSPrefs->dwDownloadSort == ui) ? pcTmp : _T(""));

	pcTmp = (m_pWSPrefs->abUploadSortAsc[m_pWSPrefs->dwUploadSort]) ? _T("&amp;sortreverse=false") : _T("&amp;sortreverse=true");
	for (unsigned ui = 0; ui < ARRSIZE(s_apcULSortTab2); ui++)
		Out.Replace(s_apcULSortTab2[ui], (m_pWSPrefs->dwUploadSort == ui) ? pcTmp : _T(""));
	
	const TCHAR *pcSortIcon = (m_pWSPrefs->abDownloadSortAsc[m_pWSPrefs->dwDownloadSort]) ? m_Templates.sUpArrow : m_Templates.sDownArrow;

	for (unsigned ui = 0; ui < ARRSIZE(s_aDLColTab); ui++)
	{
		GetPlainResString(&strTmp, s_aDLColTab[ui].dwResStrId, true);
		if (!m_pWSPrefs->abDownloadColHidden[ui])
		{
			Out.Replace( s_aDLColTab[ui].pcColIcon,
				(m_pWSPrefs->dwDownloadSort == (ui + WS_DLCOL_NAME)) ? pcSortIcon : _T("") );
			Out.Replace(s_aDLColTab[ui].pcColHdr, strTmp);
		}
		else
		{
			Out.Replace(s_aDLColTab[ui].pcColIcon, _T(""));
			Out.Replace(s_aDLColTab[ui].pcColHdr, _T(""));
		}
		Out.Replace(s_aDLColTab[ui].pcColMenu, strTmp);
	}

	pcSortIcon = (m_pWSPrefs->abUploadSortAsc[m_pWSPrefs->dwUploadSort]) ? m_Templates.sUpArrow : m_Templates.sDownArrow;

	for (unsigned ui = 0; ui < ARRSIZE(s_aULColTab); ui++)
	{
		GetPlainResString(&strTmp, s_aULColTab[ui].dwResStrId, true);
		if (!m_pWSPrefs->abUploadColHidden[ui])
		{
			Out.Replace( s_aULColTab[ui].pcColIcon,
				(m_pWSPrefs->dwUploadSort == (ui + WS_ULCOL_USER)) ? pcSortIcon : _T("") );
			Out.Replace(s_aULColTab[ui].pcColHdr, strTmp);
		}
		else
		{
			Out.Replace(s_aULColTab[ui].pcColIcon, _T(""));
			Out.Replace(s_aULColTab[ui].pcColHdr, _T(""));
		}
		Out.Replace(s_aULColTab[ui].pcColMenu, strTmp);
	}

	Out.Replace(_T("[DownloadList]"), _GetPlainResString(IDS_ST_ACTIVEDOWNLOAD));
	Out.Replace(_T("[UploadList]"), _GetPlainResString(IDS_ST_ACTIVEUPLOAD));
	Out.Replace(_T("[Actions]"), _GetPlainResString(IDS_WEB_ACTIONS));
	Out.Replace(_T("[TotalDown]"), _GetPlainResString(IDS_INFLST_USER_TOTALDOWNLOAD));
	Out.Replace(_T("[TotalUp]"), _GetPlainResString(IDS_INFLST_USER_TOTALUPLOAD));
	Out.Replace(_T("[CatSel]"), sCat);
	Out.Replace(_T("[admin]"), (bAdmin) ? _T("admin") : _T(""));

	Out.Replace(_T("[ClearAllCompleted]"), _GetPlainResString(IDS_TREE_DL_CLEAR_ALL_COMPLETED));

	double	fTotalSpeed = 0, dTmp;
	uint64	qwTotalSize = 0, qwTotalTransferred = 0;
	CArray<DownloadFiles> FilesArray;
	bool							bLocalArray = false;
	CDownloadList::PartFileVector	*pvecPartFiles;
	CDownloadList::PartFileVector	vecPartFiles;
	if ((pvecPartFiles = g_App.m_pDownloadList->GetFiles()) == NULL)
	{
		bLocalArray = true;
		pvecPartFiles = &vecPartFiles;
		vecPartFiles.erase(vecPartFiles.begin(),vecPartFiles.end());
	//	Populating array
		for (POSITION pos=g_App.m_pDownloadQueue->m_partFileList.GetHeadPosition(); pos != NULL;)
		{
			CPartFile	*pPartFile = g_App.m_pDownloadQueue->m_partFileList.GetNext(pos);

			if (pPartFile)
				vecPartFiles.push_back(pPartFile);
		}
	}
	for (unsigned int i = 0; i < pvecPartFiles->size(); i++)
	{
		int			iFileStatus;
		CPartFile	*pPartFile = (*pvecPartFiles)[i];

		if (pPartFile != NULL)
		{
			if ( !CCat::FileBelongsToGivenCat( pPartFile, (iCat > CAT_PREDEFINED)
														 ? static_cast<_EnumCategories>(iCat)
														 : CCat::GetCatIDByIndex(iCat), true ) )
				continue;

			if(pPartFile->IsULAutoPrioritized())
				pPartFile->UpdateDownloadAutoPriority();

			DownloadFiles dFile;

			dFile.sFileName = pPartFile->GetFileName();
			SpecialChars(&dFile.sFileName);
			dFile.pcFileType = GetFileTypeForWebServer(dFile.sFileName);
			dFile.sFileNameJS = _SpecialChars(pPartFile->GetFileName(), true);	//for javascript
			dFile.m_qwFileSize = pPartFile->GetFileSize();
			dFile.m_qwFileTransferred = pPartFile->GetCompletedSize();
			dFile.m_dblCompleted = pPartFile->GetPercentCompleted();
			dFile.dwFileSpeed = pPartFile->GetDataRate();

			dFile.bIsComplete = false;
			iFileStatus = pPartFile->GetPartFileStatusID();
			switch (iFileStatus)
			{
				case PS_HASHING:
					dFile.pcFileState = _T("hashing");
					break;
				case PS_WAITINGFORHASH:
					dFile.pcFileState = _T("waitinghash");
					break;
				case PS_ERROR:
					dFile.pcFileState = _T("error");
					break;
				case PS_COMPLETING:
					dFile.bIsComplete = true;
					dFile.pcFileState = _T("completing");
					break;
				case PS_COMPLETE:
					dFile.bIsComplete = true;
					dFile.pcFileState = _T("complete");
					break;
				case PS_STOPPED:
					dFile.pcFileState = _T("stopped");
					break;
				case PS_PAUSED:
					dFile.pcFileState = _T("paused");
					break;
				case PS_DOWNLOADING:
					dFile.pcFileState = _T("downloading");
					break;
				case PS_WAITINGFORSOURCE:
					dFile.pcFileState = _T("waiting");
					break;
				case PS_STALLED:
					dFile.pcFileState = _T("stalled");
					break;
			}

			dFile.bFileAutoPrio = pPartFile->IsAutoPrioritized();
			dFile.nFilePrio = pPartFile->GetPriority();
			CCat		*pCat = CCat::GetCatByID(pPartFile->GetCatID());
			dFile.sCategory = (pCat != NULL) ? pCat->GetTitle() : GetResString(IDS_CAT_UNCATEGORIZED);
			dFile.sCategory.Replace(_T("'"), _T("\'"));
			dFile.sFileHash = HashToString(pPartFile->GetFileHash());
			dFile.lSourceCount = pPartFile->GetSourceCount();
			dFile.lNotCurrentSourceCount = pPartFile->GetNotCurrentSourcesCount();
			dFile.lTransferringSourceCount = pPartFile->GetTransferringSrcCount();
			dFile.bIsPreview = (!dFile.bIsComplete && pPartFile->AllowGet1stLast());
			dFile.bIsGetFLC = (pPartFile->GetMovieMode() != 0);

			dFile.sED2kLink = pPartFile->CreateED2kLink();
			dFile.sFileInfo = pPartFile->GetDownloadFileInfo();
			SpecialChars(&dFile.sFileInfo);
			g_App.m_pFakeCheck->GetFakeComment(HashToString(pPartFile->GetFileHash()), pPartFile->GetFileSize(), &dFile.sFakeCheck);
			dFile.cSortRank = 0;
			if (g_App.m_pPrefs->DoPausedStoppedLast())
			{
				dFile.cSortRank |= (iFileStatus == PS_PAUSED) ? 1 : 0;
				dFile.cSortRank |= (iFileStatus == PS_STOPPED) ? 2 : 0;
			}
			FilesArray.Add(dFile);
		}
	}

	if (!bLocalArray)
	{
		delete pvecPartFiles;
		pvecPartFiles = NULL;
	}

	// Sorting (simple bubble sort, we don't have tons of data here)
	bool	bSwap, bSortReverse, bSorted = true;
	int		iSortRank;
	DownloadFiles	*pFileArr = FilesArray.GetData();

	bSortReverse = m_pWSPrefs->abDownloadSortAsc[m_pWSPrefs->dwDownloadSort];
	for(int nMax = 0; bSorted && nMax < FilesArray.GetCount()*2; nMax++)
	{
		bSorted = false;
		for(int i = 0; i < FilesArray.GetCount() - 1; i++)
		{
			if ((iSortRank = (pFileArr[i].cSortRank - pFileArr[i + 1].cSortRank)) != 0)
				bSwap = (iSortRank < 0) ? false : true;
			else
			{
				switch (m_pWSPrefs->dwDownloadSort)
				{
					case WS_DLCOL_STATE:
						bSwap = _tcscmp(pFileArr[i].pcFileState, pFileArr[i+1].pcFileState) < 0;
						break;
					case WS_DLCOL_TYPE:
						bSwap = _tcscmp(pFileArr[i].pcFileType, pFileArr[i+1].pcFileType) < 0;
						break;
					case WS_DLCOL_NAME:
						bSwap = pFileArr[i].sFileName.CompareNoCase(pFileArr[i+1].sFileName) < 0;
						break;
					case WS_DLCOL_SIZE:
						bSwap = pFileArr[i].m_qwFileSize < pFileArr[i+1].m_qwFileSize;
						break;
					case WS_DLCOL_TRANSFERRED:
						bSwap = pFileArr[i].m_qwFileTransferred < pFileArr[i+1].m_qwFileTransferred;
						break;
					case WS_DLCOL_SPEED:
						bSwap = pFileArr[i].dwFileSpeed < pFileArr[i+1].dwFileSpeed;
						break;
					case WS_DLCOL_PROGRESS:
						bSwap = pFileArr[i].m_dblCompleted < pFileArr[i+1].m_dblCompleted;
						break;
					case WS_DLCOL_SOURCES:
						bSwap = pFileArr[i].lSourceCount < pFileArr[i+1].lSourceCount;
						break;
					case WS_DLCOL_PRIORITY:
						bSwap = pFileArr[i].nFilePrio < pFileArr[i+1].nFilePrio;
						break;
					case WS_DLCOL_CATEGORY:
						bSwap = pFileArr[i].sCategory.CompareNoCase(pFileArr[i+1].sCategory) < 0;
						break;
					case WS_DLCOL_FAKECHECK:
						bSwap = pFileArr[i].sFakeCheck.CompareNoCase(pFileArr[i+1].sFakeCheck) < 0;
						break;
					default:
						bSwap = false;
						break;
				}
				if (bSortReverse)
					bSwap = !bSwap;
			}
			if(bSwap)
			{
				bSorted = true;
				DownloadFiles TmpFile = pFileArr[i];
				pFileArr[i] = pFileArr[i+1];
				pFileArr[i+1] = TmpFile;
			}
		}
	}

	uint32	dwClientSoft;
	CArray<UploadUsers, UploadUsers> UploadArray;
	ClientList CopyUploadQueueList;

	g_App.m_pUploadQueue->GetCopyUploadQueueList(&CopyUploadQueueList);
	for (ClientList::const_iterator cIt = CopyUploadQueueList.begin(); cIt != CopyUploadQueueList.end(); cIt++)
	{
		CUpDownClient* cur_client = *cIt;
		UploadUsers dUser;

		dUser.sUserHash = HashToString(cur_client->GetUserHash());
		if (cur_client->GetUpDataRate() != 0)
		{
			dUser.pcActive = _T("downloading");
			dUser.pcClientState = _T("uploading");
		}
		else
		{
			dUser.pcActive = _T("waiting");
			dUser.pcClientState = _T("connecting");
		}
		dUser.sFileInfo = cur_client->GetUploadFileInfo();
		SpecialChars(&dUser.sFileInfo);
		dUser.sFileInfo.Replace(_T("\n"), _T("<br />"));
		dUser.sFileInfo.Replace(_T("'"), _T("&#8217;"));

		dwClientSoft = cur_client->GetClientSoft();
		if ( ((dwClientSoft == SO_EMULE) || (dwClientSoft == SO_PLUS)) &&
			(cur_client->m_pCredits != NULL) &&
			(cur_client->m_pCredits->GetCurrentIdentState(cur_client->GetIP()) != IS_IDENTIFIED) )
		{
			dwClientSoft = SO_OLDEMULE;
		}
		dUser.sClientSoft.Format(_T("%u"), dwClientSoft);

		if (cur_client->IsBanned())
			dUser.pcClientExtra = _T("banned");
		else if (cur_client->IsFriend())
			dUser.pcClientExtra = _T("friend");
		else if (cur_client->m_pCredits->HasHigherScoreRatio(cur_client->GetIP()))
			dUser.pcClientExtra = _T("credit");
		else
			dUser.pcClientExtra = _T("none");

		dUser.sUserName = cur_client->GetUserName();
		if(dUser.sUserName.GetLength() > SHORT_LENGTH_MIN)
		{
			dUser.sUserName.Truncate(SHORT_LENGTH_MIN - 3);
			SpecialChars(&dUser.sUserName);
			dUser.sUserName += _T("...");
		}
		else
			SpecialChars(&dUser.sUserName);

		CKnownFile* file = g_App.m_pSharedFilesList->GetFileByID(cur_client->m_reqFileHash);
		if (file != NULL)
		{
			dUser.sFileName = file->GetFileName();
			SpecialChars(&dUser.sFileName);
		}
		else
			dUser.sFileName = _GetPlainResString(IDS_REQ_UNKNOWNFILE);
		dUser.nTransferredDown = cur_client->GetTransferredDown();
		dUser.nTransferredUp = cur_client->GetTransferredUp();
		dUser.dwDataRate = cur_client->GetUpDataRate();
		dUser.sClientNameVersion = cur_client->GetFullSoftVersionString();
		UploadArray.Add(dUser);
	}

	UploadUsers	*pUploadArr = UploadArray.GetData();

	// Sorting (simple bubble sort, we don't have tons of data here)
	bSorted = true;
	bSortReverse = m_pWSPrefs->abUploadSortAsc[m_pWSPrefs->dwUploadSort];
	for(int nMax = 0; bSorted && nMax < UploadArray.GetCount()*2; nMax++)
	{
		bSorted = false;
		for(int i = 0; i < UploadArray.GetCount() - 1; i++)
		{
			bool bSwap = false;
			switch (m_pWSPrefs->dwUploadSort)
			{
				case WS_ULCOL_CLIENT:
					bSwap = pUploadArr[i].sClientSoft.Compare(pUploadArr[i+1].sClientSoft) < 0;
					break;
				case WS_ULCOL_USER:
					bSwap = pUploadArr[i].sUserName.CompareNoCase(pUploadArr[i+1].sUserName) < 0;
					break;
				case WS_ULCOL_VERSION:
					bSwap = pUploadArr[i].sClientNameVersion.CompareNoCase(pUploadArr[i+1].sClientNameVersion) < 0;
					break;
				case WS_ULCOL_FILENAME:
					bSwap = pUploadArr[i].sFileName.CompareNoCase(pUploadArr[i+1].sFileName) < 0;
					break;
				case WS_ULCOL_TRANSFERRED:
					bSwap = pUploadArr[i].nTransferredUp < pUploadArr[i+1].nTransferredUp;
					break;
				case WS_ULCOL_SPEED:
					bSwap = pUploadArr[i].dwDataRate < pUploadArr[i+1].dwDataRate;
					break;
			}
			if (bSortReverse)
				bSwap = !bSwap;
			if(bSwap)
			{
				bSorted = true;
				UploadUsers TmpUser = pUploadArr[i];
				pUploadArr[i] = pUploadArr[i+1];
				pUploadArr[i+1] = TmpUser;
			}
		}
	}

	int nCountQueue = 0;
	int nCountQueueBanned = 0;
	int nCountQueueFriend = 0;
	int nCountQueueCredit = 0;
	int nCountQueueSecure = 0;
	int nCountQueueBannedSecure = 0;
	int nCountQueueFriendSecure = 0;
	int nCountQueueCreditSecure = 0;
	int nNextPos = 0;	// position in queue of the user with the highest score -> next upload user
	uint32 dwNextScore = 0;	// highest score -> next upload user

	CQArray<QueueUsers, QueueUsers> QueueArray;
	for (POSITION pos = g_App.m_pUploadQueue->waitinglist.GetHeadPosition(); pos != NULL;)
	{
		CUpDownClient* cur_client = g_App.m_pUploadQueue->waitinglist.GetNext(pos);
		QueueUsers dUser;

		bool bSecure = (cur_client->m_pCredits != NULL) &&
			(cur_client->m_pCredits->GetCurrentIdentState(cur_client->GetIP()) == IS_IDENTIFIED);
		if (cur_client->IsBanned())
		{
			dUser.pcClientState = _T("banned");
			dUser.iClientExtra = WS_WQUETYPE_BANNED;
			nCountQueueBanned++;
			if (bSecure) nCountQueueBannedSecure++;
		}
		else if (cur_client->IsFriend())
		{
			dUser.pcClientState = _T("friend");
			dUser.iClientExtra = WS_WQUETYPE_FRIEND;
			nCountQueueFriend++;
			if (bSecure) nCountQueueFriendSecure++;
		}
		else if (cur_client->m_pCredits->HasHigherScoreRatio(cur_client->GetIP()))
		{
			dUser.pcClientState = _T("credit");
			dUser.iClientExtra = WS_WQUETYPE_CREDIT;
			nCountQueueCredit++;
			if (bSecure) nCountQueueCreditSecure++;
		}
		else
		{
			dUser.pcClientState = _T("none");
			dUser.iClientExtra = WS_WQUETYPE_NONE;
			nCountQueue++;
			if (bSecure) nCountQueueSecure++;
		}

		dUser.sUserName = cur_client->GetUserName();
		if (dUser.sUserName.GetLength() > SHORT_LENGTH_MIN)
		{
			dUser.sUserName.Truncate(SHORT_LENGTH_MIN - 3);
			SpecialChars(&dUser.sUserName);
			dUser.sUserName += _T("...");
		}
		else
			SpecialChars(&dUser.sUserName);
		dUser.sClientNameVersion = cur_client->GetFullSoftVersionString();

		CKnownFile* file = g_App.m_pSharedFilesList->GetFileByID(cur_client->m_reqFileHash);
		if (file != NULL)
		{
			dUser.sFileName = file->GetFileName();
			SpecialChars(&dUser.sFileName);
		}
		else
			dUser.sFileName = _GetPlainResString(IDS_REQ_UNKNOWNFILE);
		dUser.pcClientStateSpecial = _T("connecting");
		if ((dUser.dwScore = cur_client->GetScore()) > dwNextScore)
		{
			nNextPos = QueueArray.GetSize();
			dwNextScore = dUser.dwScore;
		}

		dwClientSoft = cur_client->GetClientSoft();
		if ( ((dwClientSoft == SO_EMULE) || (dwClientSoft == SO_PLUS)) &&
			(cur_client->m_pCredits->GetCurrentIdentState(cur_client->GetIP()) != IS_IDENTIFIED) )
		{
			dwClientSoft = SO_OLDEMULE;
		}
		dUser.sClientSoft.Format(_T("%u"), dwClientSoft);
		dUser.sUserHash = HashToString(cur_client->GetUserHash());
		//SyruS CQArray-Sorting setting sIndex according to param
		switch (m_pWSPrefs->dwQueueSort)
		{
			case WS_QUCOL_CLIENT:
				dUser.sIndex = dUser.sClientSoft;
				break;
			case WS_QUCOL_USER:
				dUser.sIndex = dUser.sUserName;
				break;
			case WS_QUCOL_VERSION:
				dUser.sIndex = dUser.sClientNameVersion;
				break;
			case WS_QUCOL_FILENAME:
				dUser.sIndex = dUser.sFileName;
				break;
			case WS_QUCOL_SCORE:
				dUser.sIndex.Format(_T("%09u"), dUser.dwScore);
				break;
			default:
				dUser.sIndex.Empty();
		}
		QueueArray.Add(dUser);
	}

	QueueUsers	*pQueueArr = QueueArray.GetData();

	if (g_App.m_pUploadQueue->waitinglist.GetHeadPosition() != 0)
	{
		pQueueArr[nNextPos].pcClientStateSpecial = pQueueArr[nNextPos].pcClientState = _T("next");
	}

	if ((nCountQueue > 0 &&	m_pWSPrefs->bShowUploadQueue) ||
		(nCountQueueBanned > 0 && m_pWSPrefs->bShowUploadQueueBanned) ||
		(nCountQueueFriend > 0 && m_pWSPrefs->bShowUploadQueueFriend) ||
		(nCountQueueCredit > 0 && m_pWSPrefs->bShowUploadQueueCredit))
	{
#ifdef _DEBUG
		DWORD dwStart = ::GetTickCount();
#endif
		QueueArray.QuickSort(m_pWSPrefs->abQueueSortAsc[m_pWSPrefs->dwQueueSort]);
#ifdef _DEBUG
		AddLogLine(LOG_FL_DBG, _T("WebServer: Waitingqueue with %u elements sorted in %u ms"), QueueArray.GetSize(), ::GetTickCount()-dwStart);
#endif
	}

	// Displaying
	CString	sDownList, HTTPProcessData;
	CString	OutE(m_Templates.sTransferDownLine);
	CString	strFInfo;
	CString	ed2k;
	const TCHAR	*pcDownPrio, *pcIsGetFLC;
	bool	bIsA4AFAutoFile;
	byte	abyteUrlFHash[16];

	StringToHash(_ParseURL(Data.sURL, _T("file")), abyteUrlFHash);
	for (int i = 0; i < FilesArray.GetCount(); i++)
	{
		HTTPProcessData = OutE;

		StringToHash(pFileArr[i].sFileHash, abyteFileHash);
		if (md4cmp(abyteFileHash, abyteUrlFHash) == 0)
			HTTPProcessData.Replace(_T("[LastChangedDataset]"), _T("checked"));
		else
			HTTPProcessData.Replace(_T("[LastChangedDataset]"), _T("checked_no"));

		bIsA4AFAutoFile = ( g_App.m_pDownloadQueue->GetA4AFAutoFile() != NULL
			&& md4cmp0(abyteFileHash) != 0
			&& (g_App.m_pDownloadQueue->GetA4AFAutoFile() == g_App.m_pDownloadQueue->GetFileByID(abyteFileHash)) );

		strFInfo = pFileArr[i].sFileInfo;
		strFInfo.Replace(_T("\\"),_T("\\\\"));
		strFInfo.Replace(_T("\n"),_T("\\n"));
		strFInfo.Replace(_T("'"),_T("&#8217;"));

		ed2k = pFileArr[i].sED2kLink;
		ed2k.Replace(_T("'"), _T("&#8217;"));

		if (!pFileArr[i].bIsPreview)
			pcIsGetFLC = _T("");
		else if(pFileArr[i].bIsGetFLC)
			pcIsGetFLC = _T("enabled");
		else
			pcIsGetFLC = _T("disabled");

		if(pFileArr[i].bFileAutoPrio)
			pcDownPrio = _T("Auto");
		else
		{
			switch(pFileArr[i].nFilePrio)
			{
				case PR_LOW:
					pcDownPrio = _T("Low");
					break;
				case PR_NORMAL:
				default:
					pcDownPrio = _T("Normal");
					break;
				case PR_HIGH:
					pcDownPrio = _T("High");
					break;
			}
		}
		HTTPProcessData.Replace(_T("[admin]"), (bAdmin) ? _T("admin") : _T(""));
		HTTPProcessData.Replace(_T("[finfo]"), strFInfo);
		HTTPProcessData.Replace(_T("[ed2k]"), ed2k);
		HTTPProcessData.Replace(_T("[DownState]"), pFileArr[i].pcFileState);
		HTTPProcessData.Replace( _T("[autoa4af]"),
			(bIsA4AFAutoFile && !pFileArr[i].bIsComplete) ? _T("autoa4af") : _T("") );
		HTTPProcessData.Replace(_T("[isgetflc]"), pcIsGetFLC);
		HTTPProcessData.Replace(_T("[fname]"), pFileArr[i].sFileNameJS);
		HTTPProcessData.Replace(_T("[session]"), sSession);
		HTTPProcessData.Replace(_T("[filehash]"), pFileArr[i].sFileHash);
		HTTPProcessData.Replace(_T("[CatSel]"), sCat);
		HTTPProcessData.Replace(_T("[down-priority]"), pcDownPrio);
		HTTPProcessData.Replace(_T("[FileType]"), pFileArr[i].pcFileType);

		if (bIsA4AFAutoFile && !pFileArr[i].bIsComplete)
			HTTPProcessData.Replace(_T("[FileIsA4AF]"), _T("a4af"));
		else
			HTTPProcessData.Replace(_T("[FileIsA4AF]"), _T("halfnone"));

		if (pFileArr[i].bIsPreview && pFileArr[i].bIsGetFLC)
			HTTPProcessData.Replace(_T("[FileIsGetFLC]"), _T("getflc"));
		else
			HTTPProcessData.Replace(_T("[FileIsGetFLC]"), _T("halfnone"));

		if (!m_pWSPrefs->abDownloadColHidden[0])
		{
			if(pFileArr[i].sFileName.GetLength() > SHORT_LENGTH_MAX)
				HTTPProcessData.Replace(_T("[ShortFileName]"), pFileArr[i].sFileName.Left(SHORT_LENGTH_MAX-3) + _T("..."));
			else
				HTTPProcessData.Replace(_T("[ShortFileName]"), pFileArr[i].sFileName);
		}
		else
			HTTPProcessData.Replace(_T("[ShortFileName]"), _T(""));

		CString sTooltip = pFileArr[i].sFileInfo;
		sTooltip.Replace(_T("\n"), _T("<br />"));
		sTooltip.Replace(_T("'"), _T("&#8217;"));
		HTTPProcessData.Replace(_T("[FileInfo]"), sTooltip);

		qwTotalSize += pFileArr[i].m_qwFileSize;

		if (!m_pWSPrefs->abDownloadColHidden[1])
			HTTPProcessData.Replace(_T("[2]"), CastItoXBytes(pFileArr[i].m_qwFileSize));
		else
			HTTPProcessData.Replace(_T("[2]"), _T(""));

		if (!m_pWSPrefs->abDownloadColHidden[2])
		{
			if(pFileArr[i].m_qwFileTransferred > 0)
			{
				qwTotalTransferred += pFileArr[i].m_qwFileTransferred;
				HTTPProcessData.Replace(_T("[3]"), CastItoXBytes(pFileArr[i].m_qwFileTransferred));
			}
			else
				HTTPProcessData.Replace(_T("[3]"), _T("-"));
		}
		else
			HTTPProcessData.Replace(_T("[3]"), _T(""));

		if (!m_pWSPrefs->abDownloadColHidden[3])
			HTTPProcessData.Replace(_T("[DownloadBar]"), GetDownloadGraph(abyteFileHash));
		else
			HTTPProcessData.Replace(_T("[DownloadBar]"), _T(""));

		if (!m_pWSPrefs->abDownloadColHidden[4])
		{
			if (pFileArr[i].dwFileSpeed != 0)
			{
				dTmp = static_cast<double>(pFileArr[i].dwFileSpeed) / 1024.0;
				fTotalSpeed += dTmp;
				strTmp.Format(_T("%.2f"), dTmp);
				HTTPProcessData.Replace(_T("[4]"), strTmp);
			}
			else
				HTTPProcessData.Replace(_T("[4]"), _T("-"));
		}
		else
			HTTPProcessData.Replace(_T("[4]"), _T(""));

		if (!m_pWSPrefs->abDownloadColHidden[5])
		{
			if(pFileArr[i].lSourceCount > 0)
			{
				if (pFileArr[i].lNotCurrentSourceCount == 0)
				{
					strTmp.Format(_T("%u&nbsp;(%i)"),
						pFileArr[i].lSourceCount,
						pFileArr[i].lTransferringSourceCount);
				}
				else
				{
					strTmp.Format(_T("%u/%u&nbsp;(%i)"),
						pFileArr[i].lSourceCount - pFileArr[i].lNotCurrentSourceCount,
						pFileArr[i].lSourceCount,
						pFileArr[i].lTransferringSourceCount);
				}
				HTTPProcessData.Replace(_T("[5]"), strTmp);
			}
			else
				HTTPProcessData.Replace(_T("[5]"), _T("-"));
		}
		else
			HTTPProcessData.Replace(_T("[5]"), _T(""));

		if (!m_pWSPrefs->abDownloadColHidden[6])
		{
			UINT	dwResStrId;

			if(pFileArr[i].bFileAutoPrio)
			{
				switch(pFileArr[i].nFilePrio)
				{
					case PR_LOW:
						dwResStrId = IDS_PRIOAUTOLOW;
						break;
					case PR_NORMAL:
					default:
						dwResStrId = IDS_PRIOAUTONORMAL;
						break;
					case PR_HIGH:
						dwResStrId = IDS_PRIOAUTOHIGH;
						break;
				}
			}
			else
			{
				switch(pFileArr[i].nFilePrio)
				{
					case PR_LOW:
						dwResStrId = IDS_PRIOLOW;
						break;
					case PR_NORMAL:
					default:
						dwResStrId = IDS_PRIONORMAL;
						break;
					case PR_HIGH:
						dwResStrId = IDS_PRIOHIGH;
						break;
				}
			}
			HTTPProcessData.Replace(_T("[PrioVal]"), GetResString(dwResStrId));
		}
		else
			HTTPProcessData.Replace(_T("[PrioVal]"), _T(""));

		if (!m_pWSPrefs->abDownloadColHidden[7])
			HTTPProcessData.Replace(_T("[Category]"), pFileArr[i].sCategory);
		else
			HTTPProcessData.Replace(_T("[Category]"), _T(""));

		if (!m_pWSPrefs->abDownloadColHidden[8])
			HTTPProcessData.Replace(_T("[FakeCheck]"), pFileArr[i].sFakeCheck);
		else
			HTTPProcessData.Replace(_T("[FakeCheck]"), _T(""));

		InsertCatBox(HTTPProcessData, 0, _T(""), false, false, sSession, abyteFileHash);

		sDownList += HTTPProcessData;
	}

	Out.Replace(_T("[DownloadFilesList]"), sDownList);
	Out.Replace(_T("[TotalDownSize]"), CastItoXBytes(qwTotalSize));
	Out.Replace(_T("[TotalDownTransferred]"), CastItoXBytes(qwTotalTransferred));

	strTmp.Format(_T("%.2f"), fTotalSpeed);
	Out.Replace(_T("[TotalDownSpeed]"), strTmp);

	strTmp.Format( _T("%s: %u, %s: %u"), GetResString(IDS_SF_FILE), g_App.m_pDownloadQueue->GetFileCount(),
					 GetResString(IDS_ST_ACTIVE), g_App.m_pDownloadQueue->GetActiveFileCount());
	Out.Replace(_T("[TotalFiles]"), strTmp);

	strTmp.Format(_T("%u"), m_Templates.dwProgressbarWidth);
	Out.Replace(_T("[PROGRESSBARWIDTHVAL]"), strTmp);

	qwTotalSize = 0;
	qwTotalTransferred = 0;
	fTotalSpeed = 0;

	CString sUpList;

	OutE = m_Templates.sTransferUpLine;
	OutE.Replace(_T("[admin]"), (bAdmin) ? _T("admin") : _T(""));

	for(int i = 0; i < UploadArray.GetCount(); i++)
	{
		HTTPProcessData = OutE;

		HTTPProcessData.Replace(_T("[UserHash]"), pUploadArr[i].sUserHash);
		HTTPProcessData.Replace(_T("[UpState]"), pUploadArr[i].pcActive);
		HTTPProcessData.Replace(_T("[FileInfo]"), pUploadArr[i].sFileInfo);
		HTTPProcessData.Replace(_T("[ClientState]"), pUploadArr[i].pcClientState);
		HTTPProcessData.Replace(_T("[ClientSoft]"), pUploadArr[i].sClientSoft);
		HTTPProcessData.Replace(_T("[ClientExtra]"), pUploadArr[i].pcClientExtra);

		pcTmp = (!m_pWSPrefs->abUploadColHidden[0]) ? pUploadArr[i].sUserName.GetString() : _T("");
		HTTPProcessData.Replace(_T("[1]"), pcTmp);

		pcTmp = (!m_pWSPrefs->abUploadColHidden[1]) ? pUploadArr[i].sClientNameVersion.GetString() : _T("");
		HTTPProcessData.Replace(_T("[ClientSoftV]"), pcTmp);

		pcTmp = (!m_pWSPrefs->abUploadColHidden[2]) ? pUploadArr[i].sFileName.GetString() : _T("");
		HTTPProcessData.Replace(_T("[2]"), pcTmp);

		pcTmp = _T("");
		if (!m_pWSPrefs->abUploadColHidden[3])
		{
			qwTotalSize += pUploadArr[i].nTransferredDown;
			qwTotalTransferred += pUploadArr[i].nTransferredUp;
			strTmp.Format(_T("%s / %s"), CastItoXBytes(pUploadArr[i].nTransferredDown),CastItoXBytes(pUploadArr[i].nTransferredUp));
			pcTmp = strTmp;
		}
		HTTPProcessData.Replace(_T("[3]"), pcTmp);

		pcTmp = _T("");
		if (!m_pWSPrefs->abUploadColHidden[4])
		{
			dTmp = static_cast<double>(pUploadArr[i].dwDataRate) / 1024.0;
			fTotalSpeed += dTmp;
			strTmp.Format(_T("%.2f"), dTmp);
			pcTmp = strTmp;
		}
		HTTPProcessData.Replace(_T("[4]"), pcTmp);

		sUpList += HTTPProcessData;
	}
	Out.Replace(_T("[UploadFilesList]"), sUpList);
	strTmp.Format(_T("%s / %s"), CastItoXBytes(qwTotalSize), CastItoXBytes(qwTotalTransferred));
	Out.Replace(_T("[TotalUpTransferred]"), strTmp);
	strTmp.Format(_T("%.2f"), fTotalSpeed);
	Out.Replace(_T("[TotalUpSpeed]"), strTmp);

	if (m_pWSPrefs->bShowUploadQueue)
	{
		Out.Replace(_T("[UploadQueue]"), m_Templates.sTransferUpQueueShow);
		Out.Replace(_T("[UploadQueueList]"), _GetPlainResString(IDS_ONQUEUE));

		CString sQueue;

		OutE = m_Templates.sTransferUpQueueLine;
		OutE.Replace(_T("[admin]"), (bAdmin) ? _T("admin") : _T(""));

		for(int i = 0; i < QueueArray.GetCount(); i++)
		{
			TCHAR HTTPTempC[100] = _T("");

			if (pQueueArr[i].iClientExtra == WS_WQUETYPE_NONE)
			{
				HTTPProcessData = OutE;
				pcTmp = (!m_pWSPrefs->abQueueColHidden[0]) ? pQueueArr[i].sUserName.GetString() : _T("");
				HTTPProcessData.Replace(_T("[UserName]"), pcTmp);

				pcTmp = (!m_pWSPrefs->abQueueColHidden[1]) ? pQueueArr[i].sClientNameVersion.GetString() : _T("");
				HTTPProcessData.Replace(_T("[ClientSoftV]"), pcTmp);

				pcTmp = (!m_pWSPrefs->abQueueColHidden[2]) ? pQueueArr[i].sFileName.GetString() : _T("");
				HTTPProcessData.Replace(_T("[FileName]"), pcTmp);

				pcTmp = _T("");
				if (!m_pWSPrefs->abQueueColHidden[3])
				{
					_stprintf(HTTPTempC, _T("%u"), pQueueArr[i].dwScore);
					pcTmp = HTTPTempC;
				}
				HTTPProcessData.Replace(_T("[Score]"), pcTmp);
				HTTPProcessData.Replace(_T("[ClientState]"), pQueueArr[i].pcClientState);
				HTTPProcessData.Replace(_T("[ClientStateSpecial]"), pQueueArr[i].pcClientStateSpecial);
				HTTPProcessData.Replace(_T("[ClientSoft]"), pQueueArr[i].sClientSoft);
				HTTPProcessData.Replace(_T("[ClientExtra]"), _T("none"));
				HTTPProcessData.Replace(_T("[UserHash]"), pQueueArr[i].sUserHash);

				sQueue += HTTPProcessData;
			}
		}
		Out.Replace(_T("[QueueList]"), sQueue);
	}
	else
		Out.Replace(_T("[UploadQueue]"), m_Templates.sTransferUpQueueHide);

	if (m_pWSPrefs->bShowUploadQueueBanned)
	{
		Out.Replace(_T("[UploadQueueBanned]"), m_Templates.sTransferUpQueueBannedShow);
		Out.Replace(_T("[UploadQueueBannedList]"), _GetPlainResString(IDS_ONQUEUEBANNED));

		CString sQueueBanned;

		OutE = m_Templates.sTransferUpQueueBannedLine;
		OutE.Replace(_T("[admin]"), (bAdmin) ? _T("admin") : _T(""));

		for(int i = 0; i < QueueArray.GetCount(); i++)
		{
			TCHAR HTTPTempC[100] = _T("");

			if (pQueueArr[i].iClientExtra == WS_WQUETYPE_BANNED)
			{
				HTTPProcessData = OutE;
				pcTmp = (!m_pWSPrefs->abQueueColHidden[0]) ? pQueueArr[i].sUserName.GetString() : _T("");
				HTTPProcessData.Replace(_T("[UserName]"), pcTmp);

				pcTmp = (!m_pWSPrefs->abQueueColHidden[1]) ? pQueueArr[i].sClientNameVersion.GetString() : _T("");
				HTTPProcessData.Replace(_T("[ClientSoftV]"), pcTmp);

				pcTmp = (!m_pWSPrefs->abQueueColHidden[2]) ? pQueueArr[i].sFileName.GetString() : _T("");
				HTTPProcessData.Replace(_T("[FileName]"), pcTmp);

				pcTmp = _T("");
				if (!m_pWSPrefs->abQueueColHidden[3])
				{
					_stprintf(HTTPTempC, _T("%u"), pQueueArr[i].dwScore);
					pcTmp = HTTPTempC;
				}
				HTTPProcessData.Replace(_T("[Score]"), pcTmp);

				HTTPProcessData.Replace(_T("[ClientState]"), pQueueArr[i].pcClientState);
				HTTPProcessData.Replace(_T("[ClientStateSpecial]"), pQueueArr[i].pcClientStateSpecial);
				HTTPProcessData.Replace(_T("[ClientSoft]"), pQueueArr[i].sClientSoft);
				HTTPProcessData.Replace(_T("[ClientExtra]"), _T("banned"));
				HTTPProcessData.Replace(_T("[UserHash]"), pQueueArr[i].sUserHash);

				sQueueBanned += HTTPProcessData;
			}
		}
		Out.Replace(_T("[QueueListBanned]"), sQueueBanned);
	}
	else
		Out.Replace(_T("[UploadQueueBanned]"), m_Templates.sTransferUpQueueBannedHide);

	if (m_pWSPrefs->bShowUploadQueueFriend)
	{
		Out.Replace(_T("[UploadQueueFriend]"), m_Templates.sTransferUpQueueFriendShow);
		Out.Replace(_T("[UploadQueueFriendList]"), _GetPlainResString(IDS_ONQUEUEFRIEND));

		CString sQueueFriend;

		OutE = m_Templates.sTransferUpQueueFriendLine;
		OutE.Replace(_T("[admin]"), (bAdmin) ? _T("admin") : _T(""));

		for(int i = 0; i < QueueArray.GetCount(); i++)
		{
			TCHAR HTTPTempC[100] = _T("");

			if (pQueueArr[i].iClientExtra == WS_WQUETYPE_FRIEND)
			{
				HTTPProcessData = OutE;
				pcTmp = (!m_pWSPrefs->abQueueColHidden[0]) ? pQueueArr[i].sUserName.GetString() : _T("");
				HTTPProcessData.Replace(_T("[UserName]"), pcTmp);

				pcTmp = (!m_pWSPrefs->abQueueColHidden[1]) ? pQueueArr[i].sClientNameVersion.GetString() : _T("");
				HTTPProcessData.Replace(_T("[ClientSoftV]"), pcTmp);

				pcTmp = (!m_pWSPrefs->abQueueColHidden[2]) ? pQueueArr[i].sFileName.GetString() : _T("");
				HTTPProcessData.Replace(_T("[FileName]"), pcTmp);

				pcTmp = _T("");
				if (!m_pWSPrefs->abQueueColHidden[3])
				{
					_stprintf(HTTPTempC, _T("%u"), pQueueArr[i].dwScore);
					pcTmp = HTTPTempC;
				}
				HTTPProcessData.Replace(_T("[Score]"), pcTmp);

				HTTPProcessData.Replace(_T("[ClientState]"), pQueueArr[i].pcClientState);
				HTTPProcessData.Replace(_T("[ClientStateSpecial]"), pQueueArr[i].pcClientStateSpecial);
				HTTPProcessData.Replace(_T("[ClientSoft]"), pQueueArr[i].sClientSoft);
				HTTPProcessData.Replace(_T("[ClientExtra]"), _T("friend"));
				HTTPProcessData.Replace(_T("[UserHash]"), pQueueArr[i].sUserHash);

				sQueueFriend += HTTPProcessData;
			}
		}
		Out.Replace(_T("[QueueListFriend]"), sQueueFriend);
	}
	else
		Out.Replace(_T("[UploadQueueFriend]"), m_Templates.sTransferUpQueueFriendHide);

	if (m_pWSPrefs->bShowUploadQueueCredit)
	{
		Out.Replace(_T("[UploadQueueCredit]"), m_Templates.sTransferUpQueueCreditShow);
		Out.Replace(_T("[UploadQueueCreditList]"), _GetPlainResString(IDS_ONQUEUECREDIT));

		CString sQueueCredit;

		OutE = m_Templates.sTransferUpQueueCreditLine;
		OutE.Replace(_T("[admin]"), (bAdmin) ? _T("admin") : _T(""));

		for(int i = 0; i < QueueArray.GetCount(); i++)
		{
			TCHAR HTTPTempC[100] = _T("");

			if (pQueueArr[i].iClientExtra == WS_WQUETYPE_CREDIT)
			{
				HTTPProcessData = OutE;
				pcTmp = (!m_pWSPrefs->abQueueColHidden[0]) ? pQueueArr[i].sUserName.GetString() : _T("");
				HTTPProcessData.Replace(_T("[UserName]"), pcTmp);

				pcTmp = (!m_pWSPrefs->abQueueColHidden[1]) ? pQueueArr[i].sClientNameVersion.GetString() : _T("");
				HTTPProcessData.Replace(_T("[ClientSoftV]"), pcTmp);

				pcTmp = (!m_pWSPrefs->abQueueColHidden[2]) ? pQueueArr[i].sFileName.GetString() : _T("");
				HTTPProcessData.Replace(_T("[FileName]"), pcTmp);

				pcTmp = _T("");
				if (!m_pWSPrefs->abQueueColHidden[3])
				{
					_stprintf(HTTPTempC, _T("%u"), pQueueArr[i].dwScore);
					pcTmp =  HTTPTempC;
				}
				HTTPProcessData.Replace(_T("[Score]"), pcTmp);

				HTTPProcessData.Replace(_T("[ClientState]"), pQueueArr[i].pcClientState);
				HTTPProcessData.Replace(_T("[ClientStateSpecial]"), pQueueArr[i].pcClientStateSpecial);
				HTTPProcessData.Replace(_T("[ClientSoft]"), pQueueArr[i].sClientSoft);
				HTTPProcessData.Replace(_T("[ClientExtra]"), _T("credit"));
				HTTPProcessData.Replace(_T("[UserHash]"), pQueueArr[i].sUserHash);

				sQueueCredit += HTTPProcessData;
			}
		}
		Out.Replace(_T("[QueueListCredit]"), sQueueCredit);
	}
	else
		Out.Replace(_T("[UploadQueueCredit]"), m_Templates.sTransferUpQueueCreditHide);

	strTmp.Format(_T("%i"), nCountQueue);
	Out.Replace(_T("[CounterQueue]"), strTmp);
	strTmp.Format(_T("%i"), nCountQueueBanned);
	Out.Replace(_T("[CounterQueueBanned]"), strTmp);
	strTmp.Format(_T("%i"), nCountQueueFriend);
	Out.Replace(_T("[CounterQueueFriend]"), strTmp);
	strTmp.Format(_T("%i"), nCountQueueCredit);
	Out.Replace(_T("[CounterQueueCredit]"), strTmp);
	strTmp.Format(_T("%i"), nCountQueueSecure);
	Out.Replace(_T("[CounterQueueSecure]"), strTmp);
	strTmp.Format(_T("%i"), nCountQueueBannedSecure);
	Out.Replace(_T("[CounterQueueBannedSecure]"), strTmp);
	strTmp.Format(_T("%i"), nCountQueueFriendSecure);
	Out.Replace(_T("[CounterQueueFriendSecure]"), strTmp);
	strTmp.Format(_T("%i"), nCountQueueCreditSecure);
	Out.Replace(_T("[CounterQueueCreditSecure]"), strTmp);
	strTmp.Format(_T("%i"), nCountQueue+nCountQueueBanned+nCountQueueFriend+nCountQueueCredit);
	Out.Replace(_T("[CounterAll]"), strTmp);
	strTmp.Format(_T("%i"), nCountQueueSecure+nCountQueueBannedSecure+nCountQueueFriendSecure+nCountQueueCreditSecure);
	Out.Replace(_T("[CounterAllSecure]"), strTmp);
	Out.Replace(_T("[CatSel]"), sCat);
	Out.Replace(_T("[Session]"), sSession);
	Out.Replace(_T("[ShowUploadQueue]"), _GetPlainResString(IDS_VIEWQUEUE));
	Out.Replace(_T("[ShowUploadQueueList]"), _GetPlainResString(IDS_WEB_SHOW_UPLOAD_QUEUE, true));
	Out.Replace(_T("[ShowUploadQueueListBanned]"), _GetPlainResString(IDS_WEB_SHOW_UPLOAD_QUEUE_BANNED, true));
	Out.Replace(_T("[ShowUploadQueueListFriend]"), _GetPlainResString(IDS_WEB_SHOW_UPLOAD_QUEUE_FRIEND, true));
	Out.Replace(_T("[ShowUploadQueueListCredit]"), _GetPlainResString(IDS_WEB_SHOW_UPLOAD_QUEUE_CREDIT, true));

	pcTmp = (m_pWSPrefs->abQueueSortAsc[m_pWSPrefs->dwQueueSort]) ? _T("&amp;sortreverse=false") : _T("&amp;sortreverse=true");

	for (unsigned ui = 0; ui < ARRSIZE(s_apcQUSortTab2); ui++)
		Out.Replace(s_apcQUSortTab2[ui], (m_pWSPrefs->dwQueueSort == ui) ? pcTmp : _T(""));

	pcSortIcon = (m_pWSPrefs->abQueueSortAsc[m_pWSPrefs->dwQueueSort]) ? m_Templates.sUpArrow : m_Templates.sDownArrow;

	for (unsigned ui = 0; ui < ARRSIZE(s_aQUColTab); ui++)
	{
		GetPlainResString(&strTmp, s_aQUColTab[ui].dwResStrId, true);
		if (!m_pWSPrefs->abQueueColHidden[ui])
		{
			Out.Replace( s_aQUColTab[ui].pcColIcon,
				(m_pWSPrefs->dwQueueSort == (ui + WS_QUCOL_USER)) ? pcSortIcon : _T("") );
			Out.Replace(s_aQUColTab[ui].pcColHdr, strTmp);
		}
		else
		{
			Out.Replace(s_aQUColTab[ui].pcColIcon, _T(""));
			Out.Replace(s_aQUColTab[ui].pcColHdr, _T(""));
		}
		Out.Replace(s_aQUColTab[ui].pcColMenu, strTmp);
	}
	return Out;

	EMULE_CATCH

	return _T("");
}

CString CWebServer::GetSharedFilesList(const ThreadData &Data)
{
	static const TCHAR *s_apcSFLSortTab1[WS_SFLCOL_NUMCOLUMNS] =
	{
		_T("state"),		//WS_SFLCOL_STATE
		_T("type"),			//WS_SFLCOL_TYPE
		_T("name"),			//WS_SFLCOL_NAME
		_T("transferred"),	//WS_SFLCOL_TRANSFERRED
		_T("requests"),		//WS_SFLCOL_REQUESTS
		_T("accepts"),		//WS_SFLCOL_ACCEPTS
		_T("size"),			//WS_SFLCOL_SIZE
		_T("completes"),	//WS_SFLCOL_COMPLETES
		_T("priority")		//WS_SFLCOL_PRIORITY
	};
	static const TCHAR *s_apcSFLSortTab2[WS_SFLCOL_NUMCOLUMNS] =
	{
		_T("[SortState]"),		//WS_SFLCOL_STATE
		_T("[SortType]"),		//WS_SFLCOL_TYPE
		_T("[SortName]"),		//WS_SFLCOL_NAME
		_T("[SortTransferred]"),//WS_SFLCOL_TRANSFERRED
		_T("[SortRequests]"),	//WS_SFLCOL_REQUESTS
		_T("[SortAccepts]"),	//WS_SFLCOL_ACCEPTS
		_T("[SortSize]"),		//WS_SFLCOL_SIZE
		_T("[SortCompletes]"),	//WS_SFLCOL_COMPLETES
		_T("[SortPriority]")	//WS_SFLCOL_PRIORITY
	};
	static const WSListDefinition s_aSFLColTab[ARRSIZE(m_pWSPrefs->abSharedColHidden)] =
	{
		{ IDS_DL_FILENAME, _T("[FilenameI]"), _T("[Filename]"), _T("[FilenameM]") },
		{ IDS_SF_TRANSFERRED, _T("[FileTransferredI]"), _T("[FileTransferred]"), _T("[FileTransferredM]") },
		{ IDS_SF_REQUESTS, _T("[FileRequestsI]"), _T("[FileRequests]"), _T("[FileRequestsM]") },
		{ IDS_SF_ACCEPTS, _T("[FileAcceptsI]"), _T("[FileAccepts]"), _T("[FileAcceptsM]") },
		{ IDS_DL_SIZE, _T("[SizeI]"), _T("[Size]"), _T("[SizeM]") },
		{ IDS_SF_COMPLETESRC, _T("[CompletesI]"), _T("[Completes]"), _T("[CompletesM]") },
		{ IDS_PRIORITY, _T("[PriorityI]"), _T("[Priority]"), _T("[PriorityM]") }
	};
	EMULE_TRY

	int		iMsk, iSortMode, iCat = _tstoi(_ParseURL(Data.sURL, _T("cat"))) & 0xFF;
	CString	strTmp, sCat;

	if (iCat != 0)
		sCat.Format(_T("%u"), iCat);

	CString	sSession = _ParseURL(Data.sURL, _T("ses"));
	bool	bReload, bUpdate, bAdmin = IsSessionAdmin(Data, sSession);
	CString	strSort = _ParseURL(Data.sURL, _T("sort"));

	if (!strSort.IsEmpty())
	{
		for (unsigned ui = 0; ui < ARRSIZE(s_apcSFLSortTab1); ui++)
		{
			if (strSort.Compare(s_apcSFLSortTab1[ui]) == 0)
			{
				m_pWSPrefs->dwSharedSort = ui;
				break;
			}
		}
		strTmp = _ParseURL(Data.sURL, _T("sortAsc"));
		if (!strTmp.IsEmpty())
			m_pWSPrefs->aiSharedSortAsc[m_pWSPrefs->dwSharedSort] = (_tstoi(strTmp) & 3);
	}

	if (bAdmin)
	{
		strTmp = _ParseURL(Data.sURL, _T("hash"));
		if (!strTmp.IsEmpty())
		{
			byte	abyteFileHash[16];

			StringToHash(strTmp, abyteFileHash);
			if (md4cmp0(abyteFileHash) != 0)
			{
				CKnownFile	*pCurFile;

				if ((pCurFile = g_App.m_pSharedFilesList->GetFileByID(abyteFileHash)) != NULL)
				{
					bUpdate = false;

					strTmp = _ParseURL(Data.sURL, _T("prio"));
					if (!strTmp.IsEmpty())
					{
						pCurFile->SetAutoULPriority(false);
						if (strTmp == _T("verylow"))
							pCurFile->SetULPriority(PR_VERYLOW);
						else if (strTmp == _T("low"))
							pCurFile->SetULPriority(PR_LOW);
						else if (strTmp == _T("normal"))
							pCurFile->SetULPriority(PR_NORMAL);
						else if (strTmp == _T("high"))
							pCurFile->SetULPriority(PR_HIGH);
						else if (strTmp == _T("release"))
							pCurFile->SetULPriority(PR_RELEASE);
						else if (strTmp == _T("auto"))
						{
							pCurFile->SetAutoULPriority(true);
							pCurFile->UpdateUploadAutoPriority();
						}
						bUpdate = true;
					}

					strTmp = _ParseURL(Data.sURL, _T("jumpstart"));
					if (strTmp == _T("true"))
					{
#ifdef OLD_SOCKETS_ENABLED
					//	Don't enable JumpStart for small files
						if (pCurFile->GetFileSize() > PARTSIZE)
							pCurFile->SetJumpstartEnabled(true);
#endif
						bUpdate = true;
					}
					else if (strTmp == _T("false"))
					{
#ifdef OLD_SOCKETS_ENABLED
						pCurFile->SetJumpstartEnabled(false);
#endif
						bUpdate = true;
					}

					if (bUpdate)
						g_App.m_pSharedFilesList->UpdateItem(pCurFile);	// Refresh GUI
				}
			}
		}
	}

	strTmp = _ParseURL(Data.sURL, _T("c"));
	if (strTmp.CompareNoCase(_T("menu")) == 0)
		SetHiddenColumnState(Data.sURL, m_pWSPrefs->abSharedColHidden, ARRSIZE(m_pWSPrefs->abSharedColHidden));

	if ((bReload = (_ParseURL(Data.sURL, _T("reload")) == _T("true"))) == true)
		g_App.m_pMDlg->SendMessage(WEB_SHARED_FILES_RELOAD);

	CString		Out(m_Templates.sSharedList);
	const TCHAR	*pcTmp;

	iSortMode = m_pWSPrefs->dwSharedSort;
	iMsk = ( (iSortMode == WS_SFLCOL_TRANSFERRED) ||
		(iSortMode == WS_SFLCOL_REQUESTS) || (iSortMode == WS_SFLCOL_ACCEPTS) ) ? 3 : 1;
	iSortMode = m_pWSPrefs->aiSharedSortAsc[iSortMode];
	strTmp.Format(_T("&amp;sortAsc=%u"), (iSortMode + 1) & iMsk);
	for (unsigned ui = 0; ui < ARRSIZE(s_apcSFLSortTab2); ui++)
		Out.Replace(s_apcSFLSortTab2[ui], (m_pWSPrefs->dwSharedSort == ui) ? strTmp.GetString() : _T(""));

	pcTmp = _T("");
	if (bReload)
	{
		g_App.m_pMDlg->m_wndServer.m_pctlLogBox->GetLastLogEntry(&strTmp);	//Pick-up last line of the log
		SpecialChars(&strTmp);
		pcTmp = strTmp.GetString();
	}
	Out.Replace(_T("[Message]"), pcTmp);

	const TCHAR *pcSortIcon = (iSortMode & 2) ?
		((iSortMode & 1) ? m_Templates.strUpDoubleArrow : m_Templates.strDownDoubleArrow) :
		((iSortMode & 1) ? m_Templates.sUpArrow : m_Templates.sDownArrow);

	for (unsigned ui = 0; ui < ARRSIZE(s_aSFLColTab); ui++)
	{
		GetPlainResString(&strTmp, s_aSFLColTab[ui].dwResStrId, true);
		if (!m_pWSPrefs->abSharedColHidden[ui])
		{
			Out.Replace( s_aSFLColTab[ui].pcColIcon,
				(m_pWSPrefs->dwSharedSort == (ui + WS_SFLCOL_NAME)) ? pcSortIcon : _T("") );
			Out.Replace(s_aSFLColTab[ui].pcColHdr, strTmp);
		}
		else
		{
			Out.Replace(s_aSFLColTab[ui].pcColIcon, _T(""));
			Out.Replace(s_aSFLColTab[ui].pcColHdr, _T(""));
		}
		Out.Replace(s_aSFLColTab[ui].pcColMenu, strTmp);
	}

	Out.Replace(_T("[Actions]"), _GetPlainResString(IDS_WEB_ACTIONS));
	Out.Replace(_T("[Reload]"), _GetPlainResString(IDS_SF_RELOAD));
	Out.Replace(_T("[Session]"), sSession);
	Out.Replace(_T("[SharedList]"), _GetPlainResString(IDS_SHAREDFILES));
	Out.Replace(_T("[CatSel]"), sCat);

	CString OutE(m_Templates.sSharedLine);
	CArray<SharedFiles, SharedFiles> SharedArray;

	// Populating array
	for (POSITION pos = g_App.m_pSharedFilesList->m_mapSharedFiles.GetStartPosition(); pos != NULL;)
	{
		CCKey bufKey;
		CKnownFile* cur_file;
		uint16 nCountLo, nCountHi;

		g_App.m_pSharedFilesList->m_mapSharedFiles.GetNextAssoc(pos,bufKey,cur_file);

		bool bPartFile = cur_file->IsPartFile();

		SharedFiles dFile;

		dFile.bIsPartFile = cur_file->IsPartFile();
		dFile.sFileName = cur_file->GetFileName();
		if (bPartFile)
			dFile.pcFileState = _T("filedown");
		else
			dFile.pcFileState = _T("file");
		dFile.pcFileType = GetFileTypeForWebServer(dFile.sFileName);
		dFile.m_qwFileSize = cur_file->GetFileSize();
		dFile.sED2kLink = cur_file->CreateED2kLink();
		dFile.nFileTransferred = cur_file->statistic.GetTransferred();
		dFile.nFileAllTimeTransferred = cur_file->statistic.GetAllTimeTransferred();
		dFile.nFileRequests = cur_file->statistic.GetRequests();
		dFile.nFileAllTimeRequests = cur_file->statistic.GetAllTimeRequests();
		dFile.nFileAccepts = cur_file->statistic.GetAccepts();
		dFile.nFileAllTimeAccepts = cur_file->statistic.GetAllTimeAccepts();
		dFile.sFileHash = HashToString(cur_file->GetFileHash());

		if (bPartFile)
		{
			((CPartFile*)cur_file)->GetCompleteSourcesRange(&nCountLo, &nCountHi);
			dFile.sFileCompletes.Format(_T("%u"), ((CPartFile*)cur_file)->GetCompleteSourcesCount());
		}
		else
		{
			cur_file->GetCompleteSourcesRange(&nCountLo, &nCountHi);
			if (nCountLo == 0)
			{
				if (nCountHi == 0)
					dFile.sFileCompletes.Empty();
				else
					dFile.sFileCompletes.Format(_T("< %u"), nCountHi);
			}
			else if (nCountLo == nCountHi)
				dFile.sFileCompletes.Format(_T("%u"), nCountLo);
			else
				dFile.sFileCompletes.Format(_T("%u - %u"), nCountLo, nCountHi);
		}
		dFile.dblFileCompletes = ((nCountLo == 0) ? ((nCountHi == 0) ? ((bPartFile) ? 2.0 : 0.0) : (2.0 - (1.0 / static_cast<double>(nCountHi)))) : static_cast<double>(nCountLo) + 3.0 - (1.0 / static_cast<double>(nCountHi)));
		dFile.sFilePriority = cur_file->GetKnownFilePriorityString();
		dFile.nFilePriority = cur_file->GetULPriority();
		dFile.bFileAutoPriority = cur_file->IsULAutoPrioritized();
		SharedArray.Add(dFile);
	}

	// Sorting (simple bubble sort, we don't have tons of data here)
	bool	bSorted = true;

	iSortMode = m_pWSPrefs->aiSharedSortAsc[m_pWSPrefs->dwSharedSort];
	for (int nMax = 0; bSorted && nMax < SharedArray.GetCount()*2; nMax++)
	{
		bSorted = false;
		for(int i = 0; i < SharedArray.GetCount() - 1; i++)
		{
			bool bSwap = false;
			switch (m_pWSPrefs->dwSharedSort)
			{
				case WS_SFLCOL_STATE:
					bSwap = _tcscmp(SharedArray[i].pcFileState, SharedArray[i+1].pcFileState) > 0;
					break;
				case WS_SFLCOL_TYPE:
					bSwap = _tcscmp(SharedArray[i].pcFileType, SharedArray[i+1].pcFileType) > 0;
					break;
				case WS_SFLCOL_NAME:
					bSwap = SharedArray[i].sFileName.CompareNoCase(SharedArray[i+1].sFileName) < 0;
					break;
				case WS_SFLCOL_SIZE:
					bSwap = SharedArray[i].m_qwFileSize < SharedArray[i+1].m_qwFileSize;
					break;
				case WS_SFLCOL_TRANSFERRED:
					if (iSortMode & 2)
						bSwap = SharedArray[i].nFileAllTimeTransferred < SharedArray[i+1].nFileAllTimeTransferred;
					else
						bSwap = SharedArray[i].nFileTransferred < SharedArray[i+1].nFileTransferred;
					break;
				case WS_SFLCOL_REQUESTS:
					if (iSortMode & 2)
						bSwap = SharedArray[i].nFileAllTimeRequests < SharedArray[i+1].nFileAllTimeRequests;
					else
						bSwap = SharedArray[i].nFileRequests < SharedArray[i+1].nFileRequests;
					break;
				case WS_SFLCOL_ACCEPTS:
					if (iSortMode & 2)
						bSwap = SharedArray[i].nFileAllTimeAccepts < SharedArray[i+1].nFileAllTimeAccepts;
					else
						bSwap = SharedArray[i].nFileAccepts < SharedArray[i+1].nFileAccepts;
					break;
				case WS_SFLCOL_COMPLETES:
					bSwap = SharedArray[i].dblFileCompletes < SharedArray[i+1].dblFileCompletes;
					break;
				case WS_SFLCOL_PRIORITY:
					//	Very low priority is define equal to 4! Must adapt sorting code
					if (SharedArray[i].nFilePriority == 4)
						bSwap = (SharedArray[i+1].nFilePriority != 4);
					else if (SharedArray[i+1].nFilePriority == 4)
						bSwap = false;
					else
						bSwap = SharedArray[i].nFilePriority < SharedArray[i+1].nFilePriority;
					break;
			}
			if (iSortMode & 1)
				bSwap = !bSwap;
			if (bSwap)
			{
				bSorted = true;
				SharedFiles TmpFile = SharedArray[i];
				SharedArray[i] = SharedArray[i+1];
				SharedArray[i+1] = TmpFile;
			}
		}
	}
	// Displaying
	CString ed2k, fname, sSharedList, HTTPProcessData;

	for(int i = 0; i < SharedArray.GetCount(); i++)
	{
		TCHAR HTTPTempC[100] = _T("");
		HTTPProcessData = OutE;

		if (SharedArray[i].sFileHash == _ParseURL(Data.sURL, _T("hash")))
			HTTPProcessData.Replace(_T("[LastChangedDataset]"), _T("checked"));
		else
			HTTPProcessData.Replace(_T("[LastChangedDataset]"), _T("checked_no"));

		const TCHAR	*pcSharedPrio, *pcIsJumpStart = _T("");

		if (SharedArray[i].bFileAutoPriority)
			pcSharedPrio = _T("Auto");
		else
		{
			switch (SharedArray[i].nFilePriority)
			{
				case PR_VERYLOW:
					pcSharedPrio = _T("VeryLow");
					break;
				case PR_LOW:
					pcSharedPrio = _T("Low");
					break;
				default:
				case PR_NORMAL:
					pcSharedPrio = _T("Normal");
					break;
				case PR_HIGH:
					pcSharedPrio = _T("High");
					break;
				case PR_RELEASE:
					pcSharedPrio = _T("Release");
					break;
			}
		}

		ed2k = SharedArray[i].sED2kLink;
		ed2k.Replace(_T("'"),_T("&#8217;"));
		fname = SharedArray[i].sFileName;
		fname.Replace(_T("'"),_T("&#8217;"));

#ifdef OLD_SOCKETS_ENABLED
		byte	abyteFileHash[16];

		if (md4cmp0(StringToHash(SharedArray[i].sFileHash, abyteFileHash)) != 0)
		{
			CKnownFile	*pCurFile;

			HTTPProcessData.Replace(_T("[hash]"), SharedArray[i].sFileHash);
			if ((pCurFile = g_App.m_pSharedFilesList->GetFileByID(abyteFileHash)) != NULL)
			{
 				if (pCurFile->GetJumpstartEnabled())
				{
					pcIsJumpStart = _T("jumpstart");
					HTTPProcessData.Replace(_T("[FileIsPriority]"), _T("jumpstart"));
				}
				else if (pCurFile->GetULPriority() == PR_RELEASE)
					HTTPProcessData.Replace(_T("[FileIsPriority]"), _T("release"));
				else
					HTTPProcessData.Replace(_T("[FileIsPriority]"), _T("none"));
			}
		}
#endif //OLD_SOCKETS_ENABLED

		HTTPProcessData.Replace(_T("[admin]"), (bAdmin) ? _T("admin") : _T(""));
		HTTPProcessData.Replace(_T("[ed2k]"), ed2k);
		HTTPProcessData.Replace(_T("[fname]"), fname);
		HTTPProcessData.Replace(_T("[session]"), sSession);
		HTTPProcessData.Replace(_T("[shared-priority]"), pcSharedPrio);
		HTTPProcessData.Replace(_T("[isjumpstart]"), pcIsJumpStart);

		HTTPProcessData.Replace(_T("[FileName]"), _SpecialChars(SharedArray[i].sFileName));
		HTTPProcessData.Replace(_T("[FileType]"), SharedArray[i].pcFileType);
		HTTPProcessData.Replace(_T("[FileState]"), SharedArray[i].pcFileState);
		if (!m_pWSPrefs->abSharedColHidden[0])
		{
			if(SharedArray[i].sFileName.GetLength() > SHORT_LENGTH)
				HTTPProcessData.Replace(_T("[ShortFileName]"), _SpecialChars(SharedArray[i].sFileName.Left(SHORT_LENGTH-3)) + _T("..."));
			else
				HTTPProcessData.Replace(_T("[ShortFileName]"), _SpecialChars(SharedArray[i].sFileName));
		}
		else
			HTTPProcessData.Replace(_T("[ShortFileName]"), _T(""));
		if (!m_pWSPrefs->abSharedColHidden[1])
		{
			HTTPProcessData.Replace(_T("[FileTransferred]"), CastItoXBytes(SharedArray[i].nFileTransferred));
			_stprintf(HTTPTempC, _T(" (%s)"), CastItoXBytes(SharedArray[i].nFileAllTimeTransferred));
			HTTPProcessData.Replace(_T("[FileAllTimeTransferred]"), HTTPTempC);
		}
		else
		{
			HTTPProcessData.Replace(_T("[FileTransferred]"), _T(""));
			HTTPProcessData.Replace(_T("[FileAllTimeTransferred]"), _T(""));
		}
		if (!m_pWSPrefs->abSharedColHidden[2])
		{
			_stprintf(HTTPTempC, _T("%i"), SharedArray[i].nFileRequests);
			HTTPProcessData.Replace(_T("[FileRequests]"), HTTPTempC);
			_stprintf(HTTPTempC, _T(" (%i)"), SharedArray[i].nFileAllTimeRequests);
			HTTPProcessData.Replace(_T("[FileAllTimeRequests]"), HTTPTempC);
		}
		else
		{
			HTTPProcessData.Replace(_T("[FileRequests]"), _T(""));
			HTTPProcessData.Replace(_T("[FileAllTimeRequests]"), _T(""));
		}
		if (!m_pWSPrefs->abSharedColHidden[3])
		{
			_stprintf(HTTPTempC, _T("%i"), SharedArray[i].nFileAccepts);
			HTTPProcessData.Replace(_T("[FileAccepts]"), HTTPTempC);
			_stprintf(HTTPTempC, _T(" (%i)"), SharedArray[i].nFileAllTimeAccepts);
			HTTPProcessData.Replace(_T("[FileAllTimeAccepts]"), HTTPTempC);
		}
		else
		{
			HTTPProcessData.Replace(_T("[FileAccepts]"), _T(""));
			HTTPProcessData.Replace(_T("[FileAllTimeAccepts]"), _T(""));
		}
		if (!m_pWSPrefs->abSharedColHidden[4])
			HTTPProcessData.Replace(_T("[FileSize]"), CastItoXBytes(SharedArray[i].m_qwFileSize));
		else
			HTTPProcessData.Replace(_T("[FileSize]"), _T(""));
		if (!m_pWSPrefs->abSharedColHidden[5])
			HTTPProcessData.Replace(_T("[Completes]"), SharedArray[i].sFileCompletes);
		else
			HTTPProcessData.Replace(_T("[Completes]"), _T(""));
		if (!m_pWSPrefs->abSharedColHidden[6])
			HTTPProcessData.Replace(_T("[Priority]"), SharedArray[i].sFilePriority);
		else
			HTTPProcessData.Replace(_T("[Priority]"), _T(""));

		HTTPProcessData.Replace(_T("[FileHash]"), SharedArray[i].sFileHash);

		sSharedList += HTTPProcessData;
	}
	Out.Replace(_T("[SharedFilesList]"), sSharedList);
	Out.Replace(_T("[Session]"), sSession);

	return Out;

	EMULE_CATCH

	return _T("");
}

CString CWebServer::GetGraphs(const ThreadData &Data)
{
	NOPRM(Data);
	EMULE_TRY

	CString Out(m_Templates.sGraphs);
	CString strGraphDownload, strGraphUpload, strGraphCons;

	unsigned	uiLmt = (PointsForWeb.GetCount() < WEB_GRAPH_WIDTH) ? PointsForWeb.GetCount() : WEB_GRAPH_WIDTH;
	
	if (uiLmt != 0)
	{
		strGraphDownload.Format(_T("%u"), PointsForWeb[0].dwDownRate);
		strGraphUpload.Format(_T("%u"), PointsForWeb[0].dwUpRate);
		strGraphCons.Format(_T("%u"), PointsForWeb[0].dwConnections);
		for (unsigned ui = 1; ui < uiLmt; ui++)
		{
			strGraphDownload.AppendFormat(_T(",%u"), PointsForWeb[ui].dwDownRate);
			strGraphUpload.AppendFormat(_T(",%u"), PointsForWeb[ui].dwUpRate);
			strGraphCons.AppendFormat(_T(",%u"), PointsForWeb[ui].dwConnections);
		}
	}

	Out.Replace(_T("[GraphDownload]"), strGraphDownload);
	Out.Replace(_T("[GraphUpload]"), strGraphUpload);
	Out.Replace(_T("[GraphConnections]"), strGraphCons);

	Out.Replace(_T("[TxtDownload]"), _GetPlainResString(IDS_ST_ACTIVEDOWNLOAD));
	Out.Replace(_T("[TxtUpload]"), _GetPlainResString(IDS_ST_ACTIVEUPLOAD));
	Out.Replace(_T("[TxtTime]"), _GetPlainResString(IDS_TIME));
	Out.Replace(_T("[KByteSec]"), _GetPlainResString(IDS_KBYTESEC));
	Out.Replace(_T("[TxtConnections]"), _GetPlainResString(IDS_ST_ACTIVECONNECTIONS));

	Out.Replace(_T("[ScaleTime]"), CastSecondsToHM(g_App.m_pPrefs->GetTrafficOMeterInterval() * WEB_GRAPH_WIDTH));

	CString s1;
	s1.Format(_T("%u"), g_App.m_pPrefs->GetMaxGraphDownloadRate() / 10);
	Out.Replace(_T("[MaxDownload]"), s1);
	s1.Format(_T("%u"), g_App.m_pPrefs->GetMaxGraphUploadRate() / 10);
	Out.Replace(_T("[MaxUpload]"), s1);
	s1.Format(_T("%u"), g_App.m_pPrefs->GetMaxConnections());
	Out.Replace(_T("[MaxConnections]"), s1);

	return Out;

	EMULE_CATCH

	return _T("");
}

CString CWebServer::GetAddServerBox(const ThreadData &Data)
{
	EMULE_TRY

	int		iCat = _tstoi(_ParseURL(Data.sURL, _T("cat"))) & 0xFF;
	CString	sCat;

	if (iCat != 0)
		sCat.Format(_T("%u"), iCat);

	CString sSession = _ParseURL(Data.sURL, _T("ses"));
	const TCHAR	*pcTmp;

	if (!IsSessionAdmin(Data, sSession))
		return _T("");

	CString	strTmp, Out(m_Templates.sAddServerBox);

	if (_ParseURL(Data.sURL, _T("addserver")) == _T("true"))
	{
		CString	strSrvAddr(_ParseURL(Data.sURL, _T("serveraddr")));
		CString	strSrvPort(_ParseURL(Data.sURL, _T("serverport")));

		if (!strSrvAddr.IsEmpty() && !strSrvPort.IsEmpty())
		{
			g_App.m_pMDlg->m_wndServer.AddServer(strSrvAddr, strSrvPort, _ParseURL(Data.sURL, _T("servername")));

			CString	strResLog;
			uint16	uSrvPort = static_cast<uint16>(_tstoi(strSrvPort));
			CServer	*server = g_App.m_pServerList->GetServerByAddress(strSrvAddr, uSrvPort);

			g_App.m_pMDlg->m_wndServer.m_pctlLogBox->GetLastLogEntry(&strResLog); //Pick-up last line of the log
			SpecialChars(&strResLog);

			strTmp = _ParseURL(Data.sURL, _T("priority"));
			if (strTmp == _T("low"))
				server->SetPreference(PR_LOW);
			else if (strTmp == _T("normal"))
				server->SetPreference(PR_NORMAL);
			else if (strTmp == _T("high"))
				server->SetPreference(PR_HIGH);
			if (g_App.m_pMDlg->m_wndServer)
				g_App.m_pMDlg->m_wndServer.m_ctlServerList.RefreshServer(*server);

			if(_ParseURL(Data.sURL, _T("addtostatic")) == _T("true"))
			{
				_AddToStatic(strSrvAddr, uSrvPort);
				strResLog += _T("<br />");
				g_App.m_pMDlg->m_wndServer.m_pctlLogBox->GetLastLogEntry(&strTmp); //Pick-up last line of the log
				SpecialChars(&strTmp);
				strResLog += strTmp;
			}
			Out.Replace(_T("[Message]"), strResLog);
			if (_ParseURL(Data.sURL, _T("connectnow")) == _T("true"))
				_ConnectToServer(strSrvAddr, uSrvPort);
		}
		else
			Out.Replace(_T("[Message]"), _GetPlainResString(IDS_INVALIDSA));
	}
	else
	{
		pcTmp = _T("");
		if(_ParseURL(Data.sURL, _T("updateservermetfromurl")) == _T("true"))
		{
			g_App.m_pMDlg->m_wndServer.UpdateServerMetFromURL(_ParseURL(Data.sURL, _T("servermeturl")));

			g_App.m_pMDlg->m_wndServer.m_pctlLogBox->GetLastLogEntry(&strTmp);
			SpecialChars(&strTmp);
			pcTmp = strTmp.GetString();
		}
		Out.Replace(_T("[Message]"), pcTmp);
	}
	Out.Replace(_T("[AddServer]"), _GetPlainResString(IDS_SV_NEWSERVER));
	Out.Replace(_T("[IP]"), _GetPlainResString(IDS_SV_ADDRESS));
	Out.Replace(_T("[Port]"), _GetPlainResString(IDS_PORT));
	Out.Replace(_T("[Name]"), _GetPlainResString(IDS_SW_NAME));
	Out.Replace(_T("[Static]"), _GetPlainResString(IDS_STATICSERVER));
	Out.Replace(_T("[ConnectNow]"), _GetPlainResString(IDS_CONNECTNOW));
	Out.Replace(_T("[Priority]"), _GetPlainResString(IDS_PRIORITY));
	Out.Replace(_T("[Low]"), _GetPlainResString(IDS_PRIOLOW));
	Out.Replace(_T("[Normal]"), _GetPlainResString(IDS_PRIONORMAL));
	Out.Replace(_T("[High]"), _GetPlainResString(IDS_PRIOHIGH));
	Out.Replace(_T("[Add]"), _GetPlainResString(IDS_SV_ADD));
	Out.Replace(_T("[UpdateServerMetFromURL]"), _GetPlainResString(IDS_SV_MET));
	Out.Replace(_T("[URL]"), _GetPlainResString(IDS_SV_URL));
	Out.Replace(_T("[Apply]"), _GetPlainResString(IDS_PW_APPLY));

	strTmp.Format(_T("/?ses=%s&amp;w=server&amp;c=disconnect&amp;cat=%s"), sSession, sCat);
	Out.Replace(_T("[URL_Disconnect]"), strTmp);
	strTmp.Format(_T("/?ses=%s&amp;w=server&amp;c=connect&amp;cat=%s"), sSession, sCat);
	Out.Replace(_T("[URL_Connect]"), strTmp);

	Out.Replace(_T("[Disconnect]"), _GetPlainResString(IDS_IRC_DISCONNECT));
	Out.Replace(_T("[Connect]"), _GetPlainResString(IDS_CONNECTTOANYSERVER));
	Out.Replace(_T("[ServerOptions]"), _GetPlainResString(IDS_FSTAT_CONNECTION));
	Out.Replace(_T("[Execute]"), _GetPlainResString(IDS_IRC_PERFORM));
	Out.Replace(_T("[CatSel]"), sCat);

	return Out;

	EMULE_CATCH

	return _T("");
}

CString CWebServer::GetLog(const ThreadData &Data)
{
	EMULE_TRY

	int		iCat = _tstoi(_ParseURL(Data.sURL, _T("cat"))) & 0xFF;
	CString	sCat;

	if (iCat != 0)
		sCat.Format(_T("%u"), iCat);

	CString sSession = _ParseURL(Data.sURL, _T("ses"));
	CString Out(m_Templates.sLog);

	if ((_ParseURL(Data.sURL, _T("clear")) == _T("yes")) && IsSessionAdmin(Data,sSession))
	{
		g_App.m_pMDlg->m_wndServer.m_pctlLogBox->Reset();
		LRESULT pDummy;
		g_App.m_pMDlg->m_wndServer.OnTcnSelchangeTab1(NULL, &pDummy);
	}
	Out.Replace(_T("[Clear]"), _GetPlainResString(IDS_PW_RESET));
	Out.Replace(_T("[Log]"), g_App.m_pMDlg->m_wndServer.m_pctlLogBox->GetHtml() + _T("<br /><a name=\"end\"></a>"));
	Out.Replace(_T("[Session]"), sSession);
	Out.Replace(_T("[CatSel]"), sCat);

	return Out;

	EMULE_CATCH

	return _T("");
}

CString CWebServer::GetServerInfo(const ThreadData &Data)
{
	EMULE_TRY

	int		iCat = _tstoi(_ParseURL(Data.sURL, _T("cat"))) & 0xFF;
	CString	sCat;

	if (iCat != 0)
		sCat.Format(_T("%u"), iCat);

	CString sSession = _ParseURL(Data.sURL, _T("ses"));
	CString Out(m_Templates.sServerInfo);

	if ((_ParseURL(Data.sURL, _T("clear")) == _T("yes")) && IsSessionAdmin(Data,sSession))
	{
		g_App.m_pMDlg->m_wndServer.m_pctlServerMsgBox->Reset();
		LRESULT pDummy;
		g_App.m_pMDlg->m_wndServer.OnTcnSelchangeTab1(NULL, &pDummy);
	}
	Out.Replace(_T("[Clear]"), _GetPlainResString(IDS_PW_RESET));
	Out.Replace(_T("[ServerInfo]"), g_App.m_pMDlg->m_wndServer.m_pctlServerMsgBox->GetHtml() + _T("<br /><a name=\"end\"></a>"));
	Out.Replace(_T("[Session]"), sSession);
	Out.Replace(_T("[CatSel]"), sCat);

	return Out;

	EMULE_CATCH

	return _T("");
}

CString CWebServer::GetDebugLog(const ThreadData &Data)
{
	EMULE_TRY

	int		iCat = _tstoi(_ParseURL(Data.sURL, _T("cat"))) & 0xFF;
	CString	sCat;

	if (iCat != 0)
		sCat.Format(_T("%u"), iCat);

	CString sSession = _ParseURL(Data.sURL, _T("ses"));
	CString Out(m_Templates.sDebugLog);

	if ((_ParseURL(Data.sURL, _T("clear")) == _T("yes")) && IsSessionAdmin(Data,sSession))
	{
		g_App.m_pMDlg->m_wndServer.m_pctlDebugBox->Reset();
		LRESULT pDummy;
		g_App.m_pMDlg->m_wndServer.OnTcnSelchangeTab1(NULL, &pDummy);
	}
	Out.Replace(_T("[Clear]"), _GetPlainResString(IDS_PW_RESET));
	Out.Replace(_T("[DebugLog]"), g_App.m_pMDlg->m_wndServer.m_pctlDebugBox->GetHtml() + _T("<br /><a name=\"end\"></a>"));
	Out.Replace(_T("[Session]"), sSession);
	Out.Replace(_T("[CatSel]"), sCat);

	return Out;

	EMULE_CATCH

	return _T("");
}

CString CWebServer::_GetStats(const ThreadData &Data)
{
	EMULE_TRY

	CWebServer *pThis = (CWebServer *)Data.pThis;
	if(pThis == NULL)
		return _T("");

	CString sSession = _ParseURL(Data.sURL, _T("ses"));

	// refresh statistics
	g_App.m_pMDlg->m_dlgStatistics.ShowStatistics(true);

	CString Out = pThis->m_Templates.sStats;
	// eklmn: new stats
	Out.Replace(_T("[Stats]"), g_App.m_pMDlg->m_dlgStatistics.stattree.GetHTMLForExport());

	return Out;

	EMULE_CATCH

	return _T("");
}

CString CWebServer::GetPreferences(const ThreadData &Data)
{
	EMULE_TRY

	int		iCat = _tstoi(_ParseURL(Data.sURL, _T("cat"))) & 0xFF;
	CString	sCat, strTmp;

	if (iCat != 0)
		sCat.Format(_T("%u"), iCat);

	CString sSession = _ParseURL(Data.sURL, _T("ses"));
	CString Out(m_Templates.sPreferences);

	Out.Replace(_T("[Session]"), sSession);

	if ((_ParseURL(Data.sURL, _T("saveprefs")) == _T("true")) && IsSessionAdmin(Data, sSession))
	{
		strTmp = _ParseURL(Data.sURL, _T("showuploadqueue"));
		m_pWSPrefs->bShowUploadQueue = ((strTmp == _T("true")) || (strTmp.CompareNoCase(_T("on")) == 0));

		strTmp = _ParseURL(Data.sURL, _T("showuploadqueuebanned"));
		m_pWSPrefs->bShowUploadQueueBanned = ((strTmp == _T("true")) || (strTmp.CompareNoCase(_T("on")) == 0));

		strTmp = _ParseURL(Data.sURL, _T("showuploadqueuefriend"));
		m_pWSPrefs->bShowUploadQueueFriend = ((strTmp == _T("true")) || (strTmp.CompareNoCase(_T("on")) == 0));

		strTmp = _ParseURL(Data.sURL, _T("showuploadqueuecredit"));
		m_pWSPrefs->bShowUploadQueueCredit = ((strTmp == _T("true")) || (strTmp.CompareNoCase(_T("on")) == 0));

		strTmp = _ParseURL(Data.sURL, _T("refresh"));
		if (!strTmp.IsEmpty())
			g_App.m_pPrefs->SetWebPageRefresh(_tstoi(strTmp));

		strTmp = _ParseURL(Data.sURL, _T("maxcapdown"));
		if (!strTmp.IsEmpty())
			g_App.m_pPrefs->SetMaxGraphDownloadRate(ValidateDownCapability(10 * _tstoi(strTmp)));
		strTmp = _ParseURL(Data.sURL, _T("maxcapup"));
		if (!strTmp.IsEmpty())
			g_App.m_pPrefs->SetMaxGraphUploadRate(ValidateUpCapability(10 * _tstoi(strTmp)));

		uint32	dwSpeed;

		strTmp = _ParseURL(Data.sURL, _T("maxdown"));
		if (!strTmp.IsEmpty())
		{
			dwSpeed = String2FranctionalRate(strTmp);
			if (dwSpeed != 0)
			{
				g_App.m_pPrefs->SetMaxDownloadWithCheck(dwSpeed);
				g_App.m_pPrefs->SetLimitlessDownload(false);	//SyruS disable limitless on setting a specific value
			}
			else
				g_App.m_pPrefs->SetLimitlessDownload(true);	//SyruS enable limitless on setting to 0
		}
		strTmp = _ParseURL(Data.sURL, _T("maxup"));
		if (!strTmp.IsEmpty())
		{
			dwSpeed = String2FranctionalRate(strTmp);
			if (dwSpeed != 0)
				g_App.m_pPrefs->SetMaxUploadWithCheck(dwSpeed);
		}

		if(!_ParseURL(Data.sURL, _T("maxsources")).IsEmpty())
			g_App.m_pPrefs->SetMaxSourcePerFile(_tstoi(_ParseURL(Data.sURL, _T("maxsources"))));
		if(!_ParseURL(Data.sURL, _T("maxconnections")).IsEmpty())
			g_App.m_pPrefs->SetMaxConnections(static_cast<uint16>(_tstoi(_ParseURL(Data.sURL, _T("maxconnections")))));
		if(!_ParseURL(Data.sURL, _T("maxconnectionsperfive")).IsEmpty())
			g_App.m_pPrefs->SetMaxDownloadConperFive(_tstoi(_ParseURL(Data.sURL, _T("maxconnectionsperfive"))));
	}

	// Fill form
	Out.Replace(_T("[ShowUploadQueueVal]"), (m_pWSPrefs->bShowUploadQueue) ? _T("checked") : _T(""));
	Out.Replace(_T("[ShowUploadQueueBannedVal]"), (m_pWSPrefs->bShowUploadQueueBanned) ? _T("checked") : _T(""));
	Out.Replace(_T("[ShowUploadQueueFriendVal]"), (m_pWSPrefs->bShowUploadQueueFriend) ? _T("checked") : _T(""));
	Out.Replace(_T("[ShowUploadQueueCreditVal]"), (m_pWSPrefs->bShowUploadQueueCredit) ? _T("checked") : _T(""));

	strTmp.Format(_T("%d"), g_App.m_pPrefs->GetWebPageRefresh());
	Out.Replace(_T("[RefreshVal]"), strTmp);

	strTmp.Format(_T("%d"), g_App.m_pPrefs->GetMaxSourcePerFile());
	Out.Replace(_T("[MaxSourcesVal]"), strTmp);

	strTmp.Format(_T("%d"), g_App.m_pPrefs->GetMaxConnections());
	Out.Replace(_T("[MaxConnectionsVal]"), strTmp);

	strTmp.Format(_T("%d"), g_App.m_pPrefs->GetMaxConPerFive());
	Out.Replace(_T("[MaxConnectionsPer5Val]"), strTmp);

	Out.Replace(_T("[KBS]"), _GetPlainResString(IDS_KBYTESEC)+_T(":"));
	Out.Replace(_T("[LimitForm]"), _GetPlainResString(IDS_WEB_CONLIMITS)+_T(":"));
	Out.Replace(_T("[MaxSources]"), _GetPlainResString(IDS_PW_MAXSOURCES)+_T(":"));
	Out.Replace(_T("[MaxConnections]"), _GetPlainResString(IDS_PW_MAXC)+_T(":"));
	Out.Replace(_T("[MaxConnectionsPer5]"), _GetPlainResString(IDS_MAXCON5_TEXT)+_T(":"));
	Out.Replace(_T("[UseGzipForm]"), _GetPlainResString(IDS_WEB_GZIP_COMPRESSION));
	Out.Replace(_T("[ShowUploadQueueForm]"), _GetPlainResString(IDS_WEB_SHOW_UPLOAD_QUEUE));
	Out.Replace(_T("[ShowUploadQueueBannedForm]"), _GetPlainResString(IDS_WEB_SHOW_UPLOAD_QUEUE_BANNED));
	Out.Replace(_T("[ShowUploadQueueFriendForm]"), _GetPlainResString(IDS_WEB_SHOW_UPLOAD_QUEUE_FRIEND));
	Out.Replace(_T("[ShowUploadQueueCreditForm]"), _GetPlainResString(IDS_WEB_SHOW_UPLOAD_QUEUE_CREDIT));
	Out.Replace(_T("[ShowUploadQueueComment]"), _GetPlainResString(IDS_WEB_UPLOAD_QUEUE_COMMENT));
	Out.Replace(_T("[ShowUploadQueueBannedComment]"), _GetPlainResString(IDS_WEB_UPLOAD_QUEUE_BANNED_COMMENT));
	Out.Replace(_T("[ShowUploadQueueFriendComment]"), _GetPlainResString(IDS_WEB_UPLOAD_QUEUE_FRIEND_COMMENT));
	Out.Replace(_T("[ShowUploadQueueCreditComment]"), _GetPlainResString(IDS_WEB_UPLOAD_QUEUE_CREDIT_COMMENT));
	Out.Replace(_T("[ShowQueue]"), _GetPlainResString(IDS_SHOW));
	Out.Replace(_T("[HideQueue]"), _GetPlainResString(IDS_HIDE));
	Out.Replace(_T("[ShowQueueBanned]"), _GetPlainResString(IDS_SHOW));
	Out.Replace(_T("[HideQueueBanned]"), _GetPlainResString(IDS_HIDE));
	Out.Replace(_T("[ShowQueueFriend]"), _GetPlainResString(IDS_SHOW));
	Out.Replace(_T("[HideQueueFriend]"), _GetPlainResString(IDS_HIDE));
	Out.Replace(_T("[ShowQueueCredit]"), _GetPlainResString(IDS_SHOW));
	Out.Replace(_T("[HideQueueCredit]"), _GetPlainResString(IDS_HIDE));
	Out.Replace(_T("[RefreshTimeForm]"), _GetPlainResString(IDS_WEB_REFRESH_TIME));
	Out.Replace(_T("[RefreshTimeComment]"), _GetPlainResString(IDS_WEB_REFRESH_COMMENT));
	Out.Replace(_T("[SpeedForm]"), _GetPlainResString(IDS_SPEED_LIMITS));
	Out.Replace(_T("[MaxDown]"), _GetPlainResString(IDS_ST_ACTIVEDOWNLOAD));
	Out.Replace(_T("[MaxUp]"), _GetPlainResString(IDS_ST_ACTIVEUPLOAD));
	Out.Replace(_T("[SpeedCapForm]"), _GetPlainResString(IDS_CAPACITY_LIMITS));
	Out.Replace(_T("[MaxCapDown]"), _GetPlainResString(IDS_ST_ACTIVEDOWNLOAD));
	Out.Replace(_T("[MaxCapUp]"), _GetPlainResString(IDS_ST_ACTIVEUPLOAD));
	Out.Replace(_T("[WebControl]"), _GetPlainResString(IDS_WEB_CONTROL));
	Out.Replace(_T("[eMuleAppName]"), CLIENT_NAME);
	Out.Replace(_T("[Apply]"), _GetPlainResString(IDS_PW_APPLY));

//	Show always 0 when limitless is enabled otherwise it can be disabled on apply
	uint32	dwNum = (g_App.m_pPrefs->LimitlessDownload()) ? UNLIMITED : g_App.m_pPrefs->GetMaxDownload();

	FractionalRate2String(&strTmp, (dwNum == UNLIMITED) ? 0 : dwNum);
	Out.Replace(_T("[MaxDownVal]"), strTmp);
	FractionalRate2String(&strTmp, g_App.m_pPrefs->GetMaxUpload());
	Out.Replace(_T("[MaxUpVal]"), strTmp);
	strTmp.Format(_T("%u"), g_App.m_pPrefs->GetMaxGraphDownloadRate() / 10);
	Out.Replace(_T("[MaxCapDownVal]"), strTmp);
	strTmp.Format(_T("%u"), g_App.m_pPrefs->GetMaxGraphUploadRate() / 10);
	Out.Replace(_T("[MaxCapUpVal]"), strTmp);

	Out.Replace(_T("[CatSel]"), sCat);

	return Out;

	EMULE_CATCH

	return _T("");
}

CString CWebServer::_GetLoginScreen(const ThreadData &Data, bool bIsUseGzip)
{
	EMULE_TRY

	CWebServer *pThis = (CWebServer *)Data.pThis;
	if(pThis == NULL)
		return _T("");

	CString Out(pThis->m_Templates.sLogin);
	CString strTmp, strTmp2(_SpecialChars(_GetPlainResString(IDS_WEB_VALID), true));

	Out.Replace(_T("[CharSet]"), GetWebCharSet());
	Out.Replace(_T("[CapsErrorText]"), _SpecialChars(_GetPlainResString(IDS_WEB_CAPSERROR), true));

	strTmp.Format(strTmp2, _T("HTML"));
	Out.Replace(_T("[ValidHTML]"), strTmp);
	strTmp.Format(strTmp2, _T("CSS"));
	Out.Replace(_T("[ValidCSS]"), strTmp);
	strTmp2 = _SpecialChars(_GetPlainResString(IDS_WEB_CHECK), true);
	strTmp.Format(strTmp2, _T("HTML"));
	Out.Replace(_T("[CheckHTML]"), strTmp);
	strTmp.Format(strTmp2, _T("CSS"));
	Out.Replace(_T("[CheckCSS]"), strTmp);

	Out.Replace(_T("[Goto]"), _SpecialChars(_GetPlainResString(IDS_WEB_GOTO), true));
	Out.Replace(_T("[Nick]"), _SpecialChars(g_App.m_pPrefs->GetUserNick()));
	Out.Replace(_T("[eMuleAppName]"), CLIENT_NAME);
	Out.Replace(_T("[version]"), CURRENT_VERSION_LONG);
	Out.Replace(_T("[Login]"), _GetPlainResString(IDS_WEB_LOGIN));
	Out.Replace(_T("[EnterPassword]"), _GetPlainResString(IDS_WEB_ENTER_PASSWORD));
	Out.Replace(_T("[LoginNow]"), _GetPlainResString(IDS_WEB_LOGIN_NOW));
	Out.Replace(_T("[WebControl]"), _GetPlainResString(IDS_WEB_CONTROL));

	if(pThis->m_nIntruderDetect >= 1)
		Out.Replace(_T("[FailedLogin]"), _T("<p class=\"failed\">") + _GetPlainResString(IDS_WEB_BADLOGINATTEMPT) + _T("</p>"));
	else
		Out.Replace(_T("[FailedLogin]"), _T("&nbsp;"));

	Out.Replace(_T("[isGziped]"), GetResString((bIsUseGzip) ? IDS_ENABLED : IDS_DISABLED));

	return Out;

	EMULE_CATCH

	return _T("");
}

// We have to add gz-header and some other stuff
// to standard zlib functions
// in order to use gzip in web pages
int CWebServer::GzipCompress(byte *pbyteDst, unsigned *puiDstLen, const byte *pbyteSrc, unsigned uiSrcLen, int level)
{
	EMULE_TRY

	const static int gz_magic[2] = {0x1f, 0x8b}; // gzip magic header
	int err;
	uLong crc;
	z_stream stream = {0};
	stream.zalloc = (alloc_func)0;
	stream.zfree = (free_func)0;
	stream.opaque = (voidpf)0;
	crc = crc32(0L, Z_NULL, 0);
	// init Zlib stream
	// NOTE windowBits is passed < 0 to suppress zlib header
	err = deflateInit2(&stream, level, Z_DEFLATED, -MAX_WBITS, MAX_MEM_LEVEL, Z_DEFAULT_STRATEGY);
	if (err != Z_OK)
		return err;

	sprintf((char*)pbyteDst, "%c%c%c%c%c%c%c%c%c%c", gz_magic[0], gz_magic[1],
		Z_DEFLATED, 0 /*flags*/, 0,0,0,0 /*time*/, 0 /*xflags*/, 255);
	// wire buffers
	stream.next_in = (Bytef*)pbyteSrc;
	stream.avail_in = (uInt)uiSrcLen;
	stream.next_out = (Bytef*)(pbyteDst + 10);
	stream.avail_out = *puiDstLen - 18;
	// doit
	err = deflate(&stream, Z_FINISH);
	if (err != Z_STREAM_END)
	{
		deflateEnd(&stream);
		return err;
	}
	err = deflateEnd(&stream);
	crc = crc32(crc, (const Bytef*)pbyteSrc, uiSrcLen);
	//CRC
	*(pbyteDst + 10 + stream.total_out + 0) = (byte)(crc & 0xFF);
	*(pbyteDst + 10 + stream.total_out + 1) = (byte)((crc >> 8) & 0xFF);
	*(pbyteDst + 10 + stream.total_out + 2) = (byte)((crc >> 16) & 0xFF);
	*(pbyteDst + 10 + stream.total_out + 3) = (byte)((crc >> 24) & 0xFF);
	// Length
	*(pbyteDst + 10 + stream.total_out + 4) = (byte)(uiSrcLen & 0xFF);
	*(pbyteDst + 10 + stream.total_out + 5) = (byte)((uiSrcLen >> 8) & 0xFF);
	*(pbyteDst + 10 + stream.total_out + 6) = (byte)((uiSrcLen >> 16) & 0xFF);
	*(pbyteDst + 10 + stream.total_out + 7) = (byte)((uiSrcLen >> 24) & 0xFF);

	*puiDstLen = 10 + stream.total_out + 8;
	return err;

	EMULE_CATCH

	return -1;
}

bool CWebServer::IsLoggedIn(const ThreadData &Data, long lSession)
{
	NOPRM(Data);
	EMULE_TRY

	UpdateSessionCount();

	if (lSession != 0)
	{
	//	Find current session
		for (int i = 0; i < Sessions.GetSize(); i++)
		{
			if (Sessions[i].lSession == lSession)
				return true;
		}
	}

	EMULE_CATCH

	return false;
}

bool CWebServer::RemoveSession(const ThreadData &Data, long lSession)
{
	NOPRM(Data);

	if (lSession == 0)
		return false;

	EMULE_TRY

//	Find current session
	for (int i = 0; i < Sessions.GetSize(); i++)
	{
		if (Sessions[i].lSession == lSession)
		{
			Sessions.RemoveAt(i);
			CString t_ulCurIP;
			t_ulCurIP.Format( _T("%u.%u.%u.%u"),
				(byte)m_ulCurIP, (byte)(m_ulCurIP>>8), (byte)(m_ulCurIP>>16), (byte)(m_ulCurIP>>24) );
			g_App.m_pMDlg->AddLogLine(LOG_FL_SBAR | LOG_RGB_NOTICE, IDS_WEB_SESSIONEND, t_ulCurIP);
			return true;
		}
	}

	EMULE_CATCH

	return false;
}

bool CWebServer::GetSessionByID(Session *ses, long lSessionID, bool bUpdateTime)
{
	EMULE_TRY

	if (lSessionID != 0)
	{
		for (int i = 0; i < Sessions.GetSize(); i++)
		{
			if (Sessions[i].lSession == lSessionID)
			{
				if (bUpdateTime)	//	Reset expiration time if required
					Sessions[i].startTime = CTime::GetCurrentTime();
				*ses = Sessions.GetAt(i);
				return true;
			}
		}
	}

	EMULE_CATCH
	return false;
}

bool CWebServer::IsSessionAdmin(const ThreadData &Data, const CString &strSsessionID)
{
	NOPRM(Data);
	EMULE_TRY

	long sessionID = _tstol(strSsessionID);

	for (int i = 0; i < Sessions.GetSize(); i++)
	{
		if (Sessions[i].lSession == sessionID && sessionID != 0)
			return Sessions[i].admin;
	}

	EMULE_CATCH
	return false;
}

CString CWebServer::_GetPlainResString(UINT nID, bool noquote)
{
	EMULE_TRY

	CString sRet = GetResString(nID);
	sRet.Remove(_T('&'));
	if(noquote)
	{
		sRet.Replace(_T("'"), _T("&#8217;"));
		sRet.Replace(_T("\n"), _T("\\n"));
	}
	return sRet;

	EMULE_CATCH

	return _T("");
}

void CWebServer::GetPlainResString(CString *pstrOut, UINT nID, bool bNoQuote/*=false*/)
{
	GetResString(pstrOut, nID);
	pstrOut->Remove(_T('&'));
	if (bNoQuote)
	{
		pstrOut->Replace(_T("'"), _T("&#8217;"));
		pstrOut->Replace(_T("\n"), _T("\\n"));
	}
}

const TCHAR* CWebServer::GetWebCharSet()
{
#ifdef _UNICODE
	return _T("utf-8");
#else
	switch (g_App.m_pPrefs->GetLanguageID())
	{
		case MAKELANGID(LANG_POLISH,SUBLANG_DEFAULT):				return _T("windows-1250");
		case MAKELANGID(LANG_RUSSIAN,SUBLANG_DEFAULT):				return _T("windows-1251");
		case MAKELANGID(LANG_GREEK,SUBLANG_DEFAULT):				return _T("ISO-8859-7");
		case MAKELANGID(LANG_HEBREW,SUBLANG_DEFAULT):				return _T("ISO-8859-8-i");
		case MAKELANGID(LANG_KOREAN,SUBLANG_DEFAULT):				return _T("EUC-KR");
		case MAKELANGID(LANG_CHINESE,SUBLANG_CHINESE_SIMPLIFIED):	return _T("GB2312");
		case MAKELANGID(LANG_CHINESE,SUBLANG_CHINESE_TRADITIONAL):	return _T("Big5");
		case MAKELANGID(LANG_LITHUANIAN,SUBLANG_DEFAULT):			return _T("windows-1257");
		case MAKELANGID(LANG_ROMANIAN,SUBLANG_DEFAULT):				return _T("windows-1250");
		case MAKELANGID(LANG_TURKISH,SUBLANG_DEFAULT):				return _T("windows-1254");
	}

	// Western (Latin) includes Catalan, Danish, Dutch, English, Faeroese, Finnish, French,
	// German, Galician, Irish, Icelandic, Italian, Norwegian, Portuguese, Spanish and Swedish
	return _T("ISO-8859-1");
#endif
}

// Ornis: creating the progress bar
CString CWebServer::GetDownloadGraph(const byte *pbyteHash)
{
	EMULE_TRY

	static const TCHAR *const apcColors[2][12] =
	{
		{ _T("p_black.gif"), _T("p_blue6.gif"), _T("p_blue5.gif"),
		  _T("p_blue4.gif"), _T("p_blue3.gif"), _T("p_blue2.gif"), _T("p_blue1.gif"),
			_T("p_red.gif"), _T("p_yellow.gif"), _T("p_green.gif"), _T("p_greenpercent.gif"), _T("transparent.gif") },
		{ _T("black.gif"), _T("blue6.gif"), _T("blue5.gif"),
		  _T("blue4.gif"), _T("blue3.gif"), _T("blue2.gif"), _T("blue1.gif"),
		  _T("red.gif"), _T("yellow.gif"), _T("green.gif"), _T("greenpercent.gif"), _T("transparent.gif") }
	};
	CPartFile	*pPartFile = g_App.m_pDownloadQueue->GetFileByID(pbyteHash);
	CString		Out;
	const TCHAR	*const *progresscolor;
	EnumPartFileStatuses	eFileStatus;

	if ( pPartFile != NULL &&
		((eFileStatus = pPartFile->GetStatus()) == PS_PAUSED || eFileStatus == PS_STOPPED) )
	{
	//	Color style (paused files)
		progresscolor = &apcColors[0][0];
	}
	else
	{
	//	Color style (active files)
		progresscolor = &apcColors[1][0];
	}

	if (pPartFile == NULL || !pPartFile->IsPartFile())
	{
		Out.AppendFormat(m_Templates.sProgressbarImgsPercent, progresscolor[10], m_Templates.dwProgressbarWidth);
		Out.AppendFormat(m_Templates.sProgressbarImgs, progresscolor[9], m_Templates.dwProgressbarWidth);
	}
	else
	{
		CString	strChunkBar;
		uint32	dwLastColor = 1, dwColor, dwLastIdx = 0;
		int		compl = static_cast<int>((m_Templates.dwProgressbarWidth / 100.0) * pPartFile->GetPercentCompleted());

		strChunkBar.Preallocate(m_Templates.dwProgressbarWidth);
		pPartFile->GetProgressString(&strChunkBar, m_Templates.dwProgressbarWidth);
	//	Make a graph out of the array - need to be in a progressive way
		Out.AppendFormat(m_Templates.sProgressbarImgsPercent,
			progresscolor[(compl > 0) ? 10 : 11], (compl > 0) ? compl : 5);

		for (uint32 i = 0; i < m_Templates.dwProgressbarWidth; i++)
		{
			dwColor = strChunkBar.GetAt(i) - _T('0');
			if (dwLastColor != dwColor)
			{
				if (i > dwLastIdx)
					Out.AppendFormat(m_Templates.sProgressbarImgs, progresscolor[dwLastColor], i - dwLastIdx);

				dwLastColor = dwColor;
				dwLastIdx = i;
			}
		}
		Out.AppendFormat(m_Templates.sProgressbarImgs, progresscolor[dwLastColor], m_Templates.dwProgressbarWidth - dwLastIdx);
	}
	return Out;

	EMULE_CATCH

	return _T("");
}

CString	CWebServer::GetSearch(const ThreadData &Data)
{
	static const WSListDefinition s_aSLColTab[ARRSIZE(m_pWSPrefs->abSearchColHidden)] =
	{
		{ IDS_DL_FILENAME, _T("[FilenameI]"), _T("[FilenameH]"), _T("[FilenameM]") },
		{ IDS_DL_SIZE, _T("[FilesizeI]"), _T("[FilesizeH]"), _T("[FilesizeM]") },
		{ IDS_FILEHASH, _T("[FilehashI]"), _T("[FilehashH]"), _T("[FilehashM]") },
		{ IDS_DL_SOURCES, _T("[SourcesI]"), _T("[SourcesH]"), _T("[SourcesM]") },
		{ IDS_FAKE_CHECK_HEADER, _T("[FakeCheckI]"), _T("[FakeCheckH]"), _T("[FakeCheckM]") }
	};
	EMULE_TRY

	int		iCat = _tstoi(_ParseURL(Data.sURL, _T("cat"))) & 0xFF;
	CString	sSession = _ParseURL(Data.sURL, _T("ses"));
	CString	strTmp, Out(m_Templates.sSearch);
	bool	bAdmin = IsSessionAdmin(Data, sSession);

	if (bAdmin)
	{
		strTmp = ParseURLArray(Data.sURL, _T("downloads"));
		if (!strTmp.IsEmpty())
		{
			EnumCategories	eCatID = (iCat == 0) ? CAT_NONE : CCat::GetCatIDByUserIndex(iCat);
			int		iCurPos = 0;
			CString	strResToken;
			byte	abyteFileHash[16];

			for (;;)
			{
				strResToken = strTmp.Tokenize(_T("|"), iCurPos);
				if (strResToken.IsEmpty())
					break;
				if (md4cmp0(StringToHash(strResToken, abyteFileHash)) != 0)
					g_App.m_pSearchList->AddFileToDownloadByHash(abyteFileHash, eCatID);
			}

			iCat = (iCat == 0) ? 0 : CCat::UserCatIndexToCatIndex(iCat);
		}
	}

	CString sCat;

	if (iCat != 0)
		sCat.Format(_T("%u"), iCat);

	CString sCmd = _ParseURL(Data.sURL, _T("c"));

	if (bAdmin && (sCmd.CompareNoCase(_T("update")) == 0))
	{
		g_App.m_pPrefs->SetFakeListURL(_ParseURL(Data.sURL, _T("url")));
		g_App.m_pFakeCheck->UpdateFakeList();
	}

	strTmp = _ParseURL(Data.sURL, _T("tosearch"));
	if (!strTmp.IsEmpty() && bAdmin)
	{
		// perform search
		g_App.m_pMDlg->m_dlgSearch.DeleteAllSearches();
		g_App.m_pMDlg->m_dlgSearch.DoNewEd2kSearch(strTmp,
			_ParseURL(Data.sURL, _T("type")),
			static_cast<uint64>(_tstol(_ParseURL(Data.sURL, _T("min")))) * 1048576ui64,
			static_cast<uint64>(_tstol(_ParseURL(Data.sURL, _T("max")))) * 1048576ui64,
			_tstoi(_ParseURL(Data.sURL, _T("avail"))),
			_ParseURL(Data.sURL, _T("ext")),
			(_ParseURL(Data.sURL, _T("global")) == _T("on")),	_T(""));
		Out.Replace(_T("[Message]"),_GetPlainResString(IDS_SW_SEARCHINGINFO));
	}
	else if (!strTmp.IsEmpty() && !bAdmin)
		Out.Replace(_T("[Message]"), _GetPlainResString(IDS_ACCESSDENIED));
	else
		Out.Replace(_T("[Message]"), _GetPlainResString(IDS_SW_REFETCHRES));

	strTmp = _ParseURL(Data.sURL, _T("sort"));
	if (!strTmp.IsEmpty())
	{
		uint32	dwNewSort = _tstoi(strTmp);

		if (dwNewSort < WS_SLCOL_NUMCOLUMNS)
		{
			m_pWSPrefs->dwSearchSort = dwNewSort;
			strTmp = _ParseURL(Data.sURL, _T("sortAsc"));
			if (!strTmp.IsEmpty())
				m_pWSPrefs->abSearchSortAsc[dwNewSort] = (_tstoi(strTmp) != 0);
		}
	}

	if (sCmd.CompareNoCase(_T("menu")) == 0)
		SetHiddenColumnState(Data.sURL, m_pWSPrefs->abSearchColHidden, ARRSIZE(m_pWSPrefs->abSearchColHidden));

	CString strResultList = m_Templates.sSearchHeader;

	strResultList += g_App.m_pSearchList->GetWebList(m_Templates.sSearchResultLine,
		m_pWSPrefs->dwSearchSort, m_pWSPrefs->abSearchSortAsc[m_pWSPrefs->dwSearchSort],
		!m_pWSPrefs->abSearchColHidden[0], !m_pWSPrefs->abSearchColHidden[1],
		!m_pWSPrefs->abSearchColHidden[2], !m_pWSPrefs->abSearchColHidden[3], !m_pWSPrefs->abSearchColHidden[4]);
	if (CCat::GetNumCats() > 1)
		InsertCatBox(Out, 0, m_Templates.sCatArrow, false, false, sSession, NULL);
	else
		Out.Replace(_T("[CATBOX]"), _T(""));

	Out.Replace(_T("[SEARCHINFOMSG]"),_T(""));
	Out.Replace(_T("[RESULTLIST]"), strResultList);
	Out.Replace(_T("[Result]"), GetResString(IDS_SW_RESULT));
	Out.Replace(_T("[Session]"), sSession);
	Out.Replace(_T("[Name]"), _GetPlainResString(IDS_SW_NAME));
	Out.Replace(_T("[Type]"), _GetPlainResString(IDS_TYPE));
	Out.Replace(_T("[Any]"), _GetPlainResString(IDS_SEARCH_ANY));
	Out.Replace(_T("[Audio]"), _GetPlainResString(IDS_SEARCH_AUDIO));
	Out.Replace(_T("[Image]"), _GetPlainResString(IDS_SEARCH_PICS));
	Out.Replace(_T("[Video]"), _GetPlainResString(IDS_SEARCH_VIDEO));
	Out.Replace(_T("[Document]"), _GetPlainResString(IDS_SEARCH_DOC));
	Out.Replace(_T("[CDImage]"), _GetPlainResString(IDS_SEARCH_CDIMG));
	Out.Replace(_T("[Program]"), _GetPlainResString(IDS_SEARCH_PRG));
	Out.Replace(_T("[Archive]"), _GetPlainResString(IDS_SEARCH_ARC));
	Out.Replace(_T("[Search]"), _GetPlainResString(IDS_SEARCH_NOUN));
	Out.Replace(_T("[Show]"), _GetPlainResString(IDS_SHOW));
	Out.Replace(_T("[Size]"), _GetPlainResString(IDS_DL_SIZE));
	Out.Replace(_T("[Sort]"), _GetPlainResString(IDS_PW_SORTING));
	Out.Replace(_T("[SizeMin]"), _GetPlainResString(IDS_SEARCHMINSIZE));
	Out.Replace(_T("[SizeMax]"), _GetPlainResString(IDS_SEARCHMAXSIZE));
	Out.Replace(_T("[Availabl]"), _GetPlainResString(IDS_SEARCHAVAIL));
	Out.Replace(_T("[Extention]"), _GetPlainResString(IDS_SEARCHEXTENSION_LBL));
	Out.Replace(_T("[Global]"), _GetPlainResString(IDS_SW_GLOBAL));
	Out.Replace(_T("[MB]"), _GetPlainResString(IDS_MBYTES));
	Out.Replace(_T("[FakeListHeader]"), _GetPlainResString(IDS_FAKE_UPDATE));
	Out.Replace(_T("[FakeListText]"), _GetPlainResString(IDS_SV_ADDRESS));
	Out.Replace(_T("[FakeListUrl]"), g_App.m_pPrefs->GetFakeListURL());
	Out.Replace(_T("[Apply]"), _GetPlainResString(IDS_PW_APPLY));
	Out.Replace(_T("[CatSel]"), sCat);
	Out.Replace(_T("[checked]"),
		(g_App.m_pPrefs->GetSearchMethod() == EP_SEARCHMETHOD_GLOB) ? _T("checked") : _T(""));

	const TCHAR *pcSortIcon = (m_pWSPrefs->abSearchSortAsc[m_pWSPrefs->dwSearchSort]) ? m_Templates.sUpArrow : m_Templates.sDownArrow;

	for (unsigned ui = 0; ui < ARRSIZE(s_aSLColTab); ui++)
	{
		GetPlainResString(&strTmp, s_aSLColTab[ui].dwResStrId);
		if (!m_pWSPrefs->abSearchColHidden[ui])
		{
			Out.Replace( s_aSLColTab[ui].pcColIcon,
				(m_pWSPrefs->dwSearchSort == (ui + WS_SLCOL_FILENAME)) ? pcSortIcon : _T("") );
			Out.Replace(s_aSLColTab[ui].pcColHdr, strTmp);
		}
		else
		{
			Out.Replace(s_aSLColTab[ui].pcColIcon, _T(""));
			Out.Replace(s_aSLColTab[ui].pcColHdr, _T(""));
		}
		Out.Replace(s_aSLColTab[ui].pcColMenu, strTmp);
	}

	Out.Replace(_T("[Download]"), _GetPlainResString(IDS_DOWNLOAD_VERB));

	for (unsigned ui = 0; ui < WS_SLCOL_NUMCOLUMNS; ui++)
	{
		strTmp.Format(_T("[SORTASCVALUE%u]"), ui);
		Out.Replace( strTmp, (m_pWSPrefs->dwSearchSort == ui) ?
			((m_pWSPrefs->abSearchSortAsc[ui]) ? _T("&amp;sortAsc=0") : _T("&amp;sortAsc=1")) : _T("") );
	}

	return Out;

	EMULE_CATCH
	return _T("");
}

int CWebServer::UpdateSessionCount()
{
	EMULE_TRY

	for (int i = 0; i < Sessions.GetSize();)
	{
		CTimeSpan ts = CTime::GetCurrentTime() - Sessions[i].startTime;
		if(ts.GetTotalSeconds() > SESSION_TIMEOUT_SECS)
			Sessions.RemoveAt(i);
		else
			i++;
	}
	return Sessions.GetCount();

	EMULE_CATCH
	return 0;
}

void CWebServer::InsertCatBox(CString &Out, int preselect, const CString &strBoxLbl, bool jump, bool extraCats, const CString &strSession, const byte *pbyteHash)
{
	EMULE_TRY

	CString	strCategory, strTmp(strBoxLbl);

	strTmp += (jump) ?
		_T("<select name=\"cat\" size=\"1\"")
		_T(" onchange=GotoCat(this.form.cat.options[this.form.cat.selectedIndex].value)>") :
		_T("<select name=\"cat\" size=\"1\">");

	for (int i = 0; i-1 < CCat::GetNumUserCats(); i++)
	{
		strCategory = (i == 0) ? _GetPlainResString(IDS_CAT_UNCATEGORIZED) : CCat::GetCatByUserIndex(i)->GetTitle();
		strCategory.Replace(_T("'"),_T("\'"));
		strTmp.AppendFormat(_T("<option%s value=\"%i\">%s</option>"), (i == preselect) ? _T(" selected") : _T(""), i, strCategory);
	}
	if (extraCats)
	{
		if (CCat::GetNumCats() > 1)
			strTmp += _T("<option>------------</option>");

		for (int i = ((CCat::GetNumCats() > 1) ? 1 : 2); i <= 14; i++)
		{
			strTmp.AppendFormat(_T("<option%s value=\"%i\">%s</option>"), (i == preselect) ? _T(" selected") : _T(""), i+100, GetSubCatLabel(i));
		}
	}
	strTmp += _T("</select>");
	Out.Replace(_T("[CATBOX]"), strTmp);

	CString	tempBuff4;
	TCHAR	acHashStr[MAX_HASHSTR_SIZE], *pcTmp, *pcHashStr;

	strTmp = _T("");

	for (int i = 0; i < CCat::GetNumCats(); i++)
	{
		if (i == preselect)
		{
			pcTmp = _T("checked.gif");
			if (i < CCat::GetNumPredefinedCats())
				tempBuff4 = CCat::GetPredefinedCatTitle(CCat::GetCatIDByIndex(i));
			else
				tempBuff4 = CCat::GetCatByIndex(i)->GetTitle();
		}
		else
			pcTmp = _T("checked_no.gif");

		strCategory = (i < CCat::GetNumPredefinedCats()) ? CCat::GetPredefinedCatTitle(CCat::GetCatIDByIndex(i)) : CCat::GetCatByIndex(i)->GetTitle();
		strCategory.Replace(_T("'"), _T("\\'"));

		strTmp.AppendFormat(_T("<a href=&quot;/?ses=%s&amp;w=transfer&amp;cat=%d&quot;>")
			_T("<div class=menuitems><img class=menuchecked src=%s>%s&nbsp;</div></a>"),
			strSession, i, pcTmp, strCategory);
	}
	if (extraCats)
	{
		for (int i = ((CCat::GetNumCats() > 1) ? 1 : 2); i <= 14; i++)
		{
			if ((i + CAT_PREDEFINED) == preselect)
			{
				pcTmp = _T("checked.gif");
				tempBuff4 = GetSubCatLabel(i);
			}
			else
				pcTmp = _T("checked_no.gif");

			strTmp.AppendFormat(_T("<a href=&quot;/?ses=%s&amp;w=transfer&amp;cat=%d&quot;>")
				_T("<div class=menuitems><img class=menuchecked src=%s>%s&nbsp;</div></a>"),
				strSession, i + CAT_PREDEFINED, pcTmp, GetSubCatLabel(i));
		}
	}
	Out.Replace(_T("[CatBox]"), strTmp);
	Out.Replace(_T("[Category]"), tempBuff4);

	strTmp = _T("");

	CPartFile	*pPartFile;

	if (pbyteHash != NULL)
	{
		pPartFile = g_App.m_pDownloadQueue->GetFileByID(pbyteHash);
		pcHashStr = md4str(pbyteHash, acHashStr);
	}
	else
	{
		pPartFile = NULL;
		pcHashStr = _T("");
	}

//	For each user category index...
	for (int i = 0; i <= CCat::GetNumUserCats(); i++)
	{
	//	Get the user category index of 'pPartFile' in 'preselect'.
		if (pPartFile != NULL)
			preselect = CCat::GetUserCatIndexByID(pPartFile->GetCatID());

		strCategory = (i == 0)? GetResString(IDS_CAT_UNASSIGN) : CCat::GetCatByUserIndex(i)->GetTitle();
		strCategory.Replace(_T("'"),_T("\\'"));

		strTmp.AppendFormat(_T("<a href=&quot;/?ses=%s&amp;w=transfer[CatSel]&amp;op=setcat&amp;file=%s&amp;filecat=%u&quot;>")
			_T("<div class=menuitems><img class=menuchecked src=%s>%s&nbsp;</div></a>"),
			strSession, pcHashStr, i,
			(i == preselect) ? _T("checked.gif") : _T("checked_no.gif"), strCategory);
	}
	Out.Replace(_T("[SetCatBox]"), strTmp);

	EMULE_CATCH
}

CString CWebServer::GetSubCatLabel(int iCat)
{
	EMULE_TRY

	CString sPlain = CCat::GetPredefinedCatTitle(static_cast<_EnumCategories>(iCat+CAT_PREDEFINED));

	sPlain.Remove(_T('&'));
	sPlain.Replace(_T("'"), _T("&#8217;"));

	return sPlain;

	EMULE_CATCH
	return _T("");
}

long CWebServer::DoAuthentication(const ThreadData &Data, Session *ses)
{
	EMULE_TRY

	ses->lSession = 0;
	ses->startTime = 0;
	ses->admin = false;
	
	CString	strTmp(_ParseURL(Data.sURL, _T("ses")));

	if (!strTmp.IsEmpty())
		GetSessionByID(ses, _tstol(strTmp), true);
	else
	{
		if ( (_ParseURL(Data.sURL, _T("w")) == _T("password")) &&
			!GetIsTempDisabled() && _ParseURL(Data.sURL, _T("c")).IsEmpty() )
		{
			byte	abyteDigest[16];

			strTmp.Format(_T("%u.%u.%u.%u"),(byte)m_ulCurIP,(byte)(m_ulCurIP>>8),(byte)(m_ulCurIP>>16),(byte)(m_ulCurIP>>24));

			if (md4cmp(MD5Sum(_ParseURL(Data.sURL, _T("p")), abyteDigest), g_App.m_pPrefs->GetWSPass()) == 0)
			{
				ses->admin = true;
				ses->startTime = CTime::GetCurrentTime();
				ses->lSession = ((rand() << 15) | rand()) + 1;
				Sessions.Add(*ses);
				AddLogLine(LOG_FL_SBAR | LOG_RGB_NOTICE, IDS_WEB_ADMINLOGIN, strTmp);
				m_nIntruderDetect = 0;
			}
			else if ( g_App.m_pPrefs->GetWSIsLowUserEnabled() &&
				(md4cmp(abyteDigest, g_App.m_pPrefs->GetWSLowPass()) == 0) )
			{
				ses->startTime = CTime::GetCurrentTime();
				ses->lSession = ((rand() << 15) | rand()) + 1;
				Sessions.Add(*ses);
				AddLogLine(LOG_FL_SBAR | LOG_RGB_NOTICE, IDS_WEB_GUESTLOGIN, strTmp);
				m_nIntruderDetect = 0;
			}
			else if (g_App.m_pPrefs->IsWSIntruderDetectionEnabled())
			{
				m_nIntruderDetect++;
				AddLogLine(LOG_FL_SBAR | LOG_RGB_NOTICE, IDS_WEB_INTRTRIESLEFT, strTmp, g_App.m_pPrefs->GetWSLoginAttemptsAllowed() - m_nIntruderDetect);
				if (m_nIntruderDetect == g_App.m_pPrefs->GetWSLoginAttemptsAllowed())
				{
					CString MessageText;

					AddLogLine(LOG_FL_SBAR | LOG_RGB_NOTICE, IDS_WEB_INTRDETECTION, m_nIntruderDetect);
					if (g_App.m_pPrefs->GetWSTempDisableLogin() > 0)
					{
						m_nStartTempDisabledTime = ::GetTickCount();
						m_bIsTempDisabled = true;
						AddLogLine(LOG_FL_SBAR | LOG_RGB_NOTICE, IDS_WEB_INTRBLOCKTIME, g_App.m_pPrefs->GetWSTempDisableLogin());
						m_nIntruderDetect = 0;
						MessageText.Format(GetResString(IDS_WEB_INTRBLOCKTIME), g_App.m_pPrefs->GetWSTempDisableLogin());
					}
					else
					{
						g_App.m_pPrefs->SetWSIsEnabled(false);
						m_bServerWorking = false;
						StopSockets();
						AddLogLine(LOG_FL_SBAR | LOG_RGB_NOTICE, IDS_WEB_INTRWEBDISABLE);
						m_nIntruderDetect = 0;
						GetResString(&MessageText, IDS_WEB_INTRWEBDISABLE);
					}
					g_App.m_pMDlg->SendMail(MessageText, g_App.m_pPrefs->GetNotifierPopOnWebServerError(), g_App.m_pPrefs->IsSMTPWarningEnabled());
					g_App.m_pMDlg->ShowNotifier(MessageText, TBN_WEBSERVER, false, g_App.m_pPrefs->GetNotifierPopOnWebServerError());
				}
			}
			else
				AddLogLine(LOG_FL_SBAR | LOG_RGB_NOTICE, IDS_WEB_BADLOGINATTEMPT);
		}
	}

	return ses->lSession;

	EMULE_CATCH

	ses->lSession = 0;
	return 0;
}

void CWebServer::SetHiddenColumnState(const CString &strURL, bool *pbCols, unsigned uiArrSz)
{
	unsigned	uiMenu = _tstoi(_ParseURL(strURL, _T("m")));
	bool		bValue = (_tstoi(_ParseURL(strURL, _T("v"))) != 0);
	
	if (uiMenu >= uiArrSz)	//outside array boundary
		return;
	pbCols[uiMenu] = bValue;
}
@


1.442
log
@WebServer: fixed DynIP server sorting in the server list (from original; issue was happening for server names with short strings between dot, e.g. w3.d.com); Reduced H-file dependecy.
@
text
@d1186 1
a1186 1
			if (tempServer->GetFullIP() == cur_file->GetFullIP())
d1192 1
a1192 1
			if (tempServer->GetFullIP() == cur_file->GetFullIP())
@


1.441
log
@Reduced H-file dependency.
@
text
@d23 3
d1161 14
a1174 10
		int counter=0;
		CString newip;
		for(int j = 0; j < 4; j++)
		{
			strTmp = Entry.sServerIP.Tokenize(_T("."), counter);
			if (strTmp.GetLength() == 1)
				newip += _T("00");
			else if (strTmp.GetLength() == 2)
				newip += _T("0");
			newip += strTmp;
d1176 2
a1177 2
		Entry.sServerFullIP = newip;

@


1.440
log
@Reduced H-file dependency.
@
text
@d32 1
@


1.439
log
@Removed unrequired H-file.
@
text
@d30 1
@


1.438
log
@Reduced H-file dependency.
@
text
@a25 1
#include "ini2.h"
@


1.437
log
@Some code improvements from original.
@
text
@d30 1
@


1.436
log
@Point manual version check links to updates.emuleplus.info to be in synch with automatic version check [Aw3/DonGato].
@
text
@d1118 1
a1118 1
	CArray<ServerEntry, ServerEntry> ServerArray;
d1810 1
a1810 1
	CArray<DownloadFiles, DownloadFiles> FilesArray;
@


1.435
log
@WebServer: improved download progress bar representation for large files {DonGato}.
@
text
@d729 1
a729 1
	strVersionCheck.Format(_T("http://emuleplus.info/version_check.php?version=%i&language=%i"),CURRENT_PLUS_VERSION,g_App.m_pPrefs->GetLanguageID());
@


1.434
log
@Pass an output string as a parameter for WS progress bar generation;
Some progress bar formatting was moved from the source code to the templates.
@
text
@d3891 6
a3896 6
		{ _T("p_green.gif"), _T("p_black.gif"), _T("p_yellow.gif"), _T("p_red.gif"),
		  _T("p_blue1.gif"), _T("p_blue2.gif"), _T("p_blue3.gif"), _T("p_blue4.gif"),
			_T("p_blue5.gif"), _T("p_blue6.gif"), _T("p_greenpercent.gif"), _T("transparent.gif") },
		{ _T("green.gif"), _T("black.gif"), _T("yellow.gif"), _T("red.gif"),
		  _T("blue1.gif"), _T("blue2.gif"), _T("blue3.gif"), _T("blue4.gif"),
		  _T("blue5.gif"), _T("blue6.gif"), _T("greenpercent.gif"), _T("transparent.gif") }
d3901 1
d3903 2
a3904 1
	if (pPartFile != NULL && (pPartFile->GetStatus() == PS_PAUSED || pPartFile->GetStatus() == PS_STOPPED))
d3918 1
a3918 1
		Out.AppendFormat(m_Templates.sProgressbarImgs, progresscolor[0], m_Templates.dwProgressbarWidth);
@


1.433
log
@Simplified logging system implementation.
@
text
@d160 1
a160 1
			m_Templates.sProgressbarImgsPercent.Replace(_T("[PROGRESSGIFINTERNAL]"),_T("%i"));
d3915 1
a3915 1
		Out.AppendFormat(m_Templates.sProgressbarImgsPercent + _T("<br />"), progresscolor[10], m_Templates.dwProgressbarWidth);
d3920 1
a3920 1
		CString	strChunkBar = pPartFile->GetProgressString(m_Templates.dwProgressbarWidth);
d3924 4
a3927 2
		// and now make a graph out of the array - need to be in a progressive way
		Out.AppendFormat(m_Templates.sProgressbarImgsPercent + _T("<br />"),
@


1.432
log
@Reduced H-file dependency.
@
text
@d104 1
a104 1
				AddLogLine(true, RGB_LOG_ERROR + GetResString(IDS_WS_ERR_LOADTEMPLATE), sFile);
d167 1
a167 1
		AddLogLine(true, RGB_LOG_ERROR + GetResString(IDS_WEB_ERR_CANTLOAD), sFile);
d197 1
a197 1
		AddDebugLogLine(RGB_LOG_ERROR_TXT _T("Webserver: can't load %s template"), pcTemplateName);
d236 1
a236 1
		AddLogLine(false, _T("%s: %s"),_GetPlainResString(IDS_PW_HTTPD), _GetPlainResString(IDS_ENABLED).MakeLower());
d238 1
a238 1
		AddLogLine(false, _T("%s: %s"),_GetPlainResString(IDS_PW_HTTPD), _GetPlainResString(IDS_DISABLED).MakeLower());
d381 1
a381 1
		AddDebugLogLine(_T("WebServer: File Request (name=%s) Should do gzip (AcceptEncoding=%s)"), filename, Data.strAcceptEncoding);
d383 1
a383 1
		AddDebugLogLine(_T("WebServer: File Request (name=%s) Should NOT do gzip (AcceptEncoding=%s)"), filename, Data.strAcceptEncoding);
d483 1
a483 1
		AddLogLine(true, RGB_LOG_NOTICE + GetResString(IDS_WEB_INTRBLOCKEND));
d491 1
a491 1
	AddDebugLogLine(_T("WebServer: start request processing (Cmd=%s)"), strCmd);
d495 1
a495 1
		AddDebugLogLine(_T("WebServer: Gzip is ON (AcceptEncoding=%s)"), Data.strAcceptEncoding);
d497 1
a497 1
		AddDebugLogLine(_T("WebServer: Gzip is OFF (AcceptEncoding=%s)"), Data.strAcceptEncoding);
d525 1
a525 1
				AddLogLine(true, RGB_LOG_NOTICE + GetResString(IDS_WEB_SHUTDOWN) + _T(' ') + GetResString(IDS_FAILED));
d544 1
a544 1
				AddLogLine(true, RGB_LOG_NOTICE + GetResString(IDS_WEB_REBOOT) + _T(' ') + GetResString(IDS_FAILED));
d603 1
a603 1
			AddDebugLogLine(RGB_LOG_ERROR_TXT _T("WebServer: Gzip FAILED on Cmd=%s (AcceptEncoding=%s)"), strCmd, Data.strAcceptEncoding);
d609 1
a609 1
	AddDebugLogLine(_T("WebServer: request prepared (Sz=%u)"), (!isUseGzip) ? pstrOut->GetLength() : uiGzipLen);
d620 1
a620 1
	AddDebugLogLine(_T("WebServer: request sent"));
d2227 1
a2227 1
		AddDebugLogLine(_T("WebServer: Waitingqueue with %u elements sorted in %u ms"), QueueArray.GetSize(), ::GetTickCount()-dwStart);
d3781 1
a3781 1
			g_App.m_pMDlg->AddLogLine(true, RGB_LOG_NOTICE + GetResString(IDS_WEB_SESSIONEND),t_ulCurIP);
d4285 1
a4285 1
				AddLogLine(true, RGB_LOG_NOTICE + GetResString(IDS_WEB_ADMINLOGIN), strTmp);
d4294 1
a4294 1
				AddLogLine(true, RGB_LOG_NOTICE + GetResString(IDS_WEB_GUESTLOGIN), strTmp);
d4300 1
a4300 1
				AddLogLine(true, RGB_LOG_NOTICE + GetResString(IDS_WEB_INTRTRIESLEFT), strTmp, g_App.m_pPrefs->GetWSLoginAttemptsAllowed()-(m_nIntruderDetect));
d4305 1
a4305 1
					AddLogLine(true, RGB_LOG_NOTICE + GetResString(IDS_WEB_INTRDETECTION), m_nIntruderDetect);
d4310 1
a4310 1
						AddLogLine(true, RGB_LOG_NOTICE + GetResString(IDS_WEB_INTRBLOCKTIME), g_App.m_pPrefs->GetWSTempDisableLogin());
d4319 1
a4319 1
						AddLogLine(true, RGB_LOG_NOTICE + GetResString(IDS_WEB_INTRWEBDISABLE));
d4328 1
a4328 1
				AddLogLine(true, RGB_LOG_NOTICE + GetResString(IDS_WEB_BADLOGINATTEMPT));
@


1.431
log
@Reduced H-file dependency.
@
text
@d29 1
@


1.430
log
@Removed duplicate delete operator -- the one below will do the job.
@
text
@d19 1
@


1.429
log
@Fixed adding a server with high priority in WebServer;
Fixed WebServer last log message report for Servers and Shared Files (broken since v1g; it displays last log message on adding new server, updating server list and shared files reload);
Removed double URL parsing for reload;
Removed logic searching for last EOL in the last log message -- it was meaningless nowadays.
@
text
@a602 2
			delete[] gzipOut;
			gzipOut = NULL;
@


1.428
log
@Fixed Unicode issue (from original); Improved string processing.
@
text
@d2813 1
a2813 1
	bool	bUpdate, bAdmin = IsSessionAdmin(Data, sSession);
d2898 1
a2898 1
	if (_ParseURL(Data.sURL, _T("reload")) == _T("true"))
d2901 2
a2902 1
	CString Out(m_Templates.sSharedList);
d2912 2
a2913 1
	if (_ParseURL(Data.sURL, _T("reload")) == _T("true"))
d2915 3
a2917 6
		CString strResLog = _SpecialChars(g_App.m_pMDlg->m_strLogText);	//Pick-up last line of the log
		strResLog.TrimRight(_T('\n'));
		int iStringIndex = strResLog.ReverseFind(_T('\n'));
		if (iStringIndex >= 0)
			strResLog = strResLog.Mid(iStringIndex);
		Out.Replace(_T("[Message]"), strResLog);
d2919 1
a2919 2
	else
		Out.Replace(_T("[Message]"), _T(""));
d3284 1
d3300 1
a3300 1
			CString	strResLog = _SpecialChars(g_App.m_pMDlg->m_strLogText); //Pick-up last line of the log
d3304 3
d3313 1
a3313 1
				server->SetPreference(PR_NORMAL);
d3321 3
a3323 1
				strResLog += _SpecialChars(g_App.m_pMDlg->m_strLogText); //Pick-up last line of the log
a3324 2
			strResLog.TrimRight(_T('\n'));
			strResLog = strResLog.Mid(strResLog.ReverseFind(_T('\n')));
d3332 1
a3332 1
	else if(_ParseURL(Data.sURL, _T("updateservermetfromurl")) == _T("true"))
d3334 10
a3343 5
		g_App.m_pMDlg->m_wndServer.UpdateServerMetFromURL(_ParseURL(Data.sURL, _T("servermeturl")));
		strTmp = _SpecialChars(g_App.m_pMDlg->m_strLogText);
		strTmp.TrimRight(_T('\n'));
		strTmp = strTmp.Mid(strTmp.ReverseFind(_T('\n')));
		Out.Replace(_T("[Message]"), strTmp);
a3344 2
	else
		Out.Replace(_T("[Message]"), _T(""));
@


1.427
log
@Optimized URL parsing; Eliminating several places parsing for the same thing;
Reworked array parsing which had few issues (used for adding downloads from search results).
@
text
@d841 1
a841 1
			HTTPConText = CString(cur_server->GetListName().Left(SHORT_LENGTH-3) + _T("..."));
d2914 2
a2915 2
		strResLog.TrimRight('\n');
		int iStringIndex = strResLog.ReverseFind('\n');
d3362 1
a3362 1
	Out.Replace(_T("[ServerOptions]"), CString(_GetPlainResString(IDS_FSTAT_CONNECTION)));
@


1.426
log
@WebServer: fixed inserting several ed2k-links {L_ignorant}.
@
text
@d469 1
a469 1
	CString	Out, strCmd;
d486 1
a487 1
	strCmd = _ParseURL(Data.sURL, _T("w"));
d546 1
a546 1
		Out += GetHeader(Data, lSession);
d629 1
a629 1
CString CWebServer::_ParseURLArray(CString URL, CString fieldname)
d633 2
a634 1
	CString res,temp;
d636 2
a637 1
	while (URL.GetLength()>0)
d639 1
a639 11
		int pos=URL.MakeLower().Find(fieldname.MakeLower() + _T('='));
		if (pos >= 0)
		{
			temp=_ParseURL(URL,fieldname);
			if (temp.IsEmpty())
				break;
			res += temp;
			res += _T('|');
			URL.Delete(pos,10);
		}
		else
d641 10
d652 1
a652 1
	return res;
d662 2
a663 2
	CString value;
	int i, findPos, findLength = 0;
d665 1
a665 1
	if ((findPos = URL.Find(_T('?'))) >= 0)
d667 2
a669 1
		CString	Parameter = URL.Mid(findPos + 1, URL.GetLength() - findPos - 1);
d674 1
a674 1
		if (Parameter.Find(fieldname) == 0)
d676 1
a676 1
			findPos = 0;
d679 1
a679 1
		if ((i = Parameter.Find(_T('&') + fieldname)) >= 0)
d686 4
a689 5
			Parameter = Parameter.Mid(findPos + findLength, Parameter.GetLength());
			if ((findPos = Parameter.Find(_T('&'))) >= 0)
				Parameter = Parameter.Mid(0, findPos);

			value = Parameter;
d692 2
a693 2
			value.Replace(_T('+'), _T(' '));
			value = URLDecode(value, true);
d697 1
a697 1
	return value;
d704 1
a704 1
CString CWebServer::GetHeader(const ThreadData &Data, long lSession)
d716 1
a716 1
	CString strCmd = _ParseURL(Data.sURL, _T("w"));
d2238 1
d2240 1
d2246 1
a2246 1
		if (pFileArr[i].sFileHash == _ParseURL(Data.sURL,_T("file")))
d3961 1
a3961 1
	if (bAdmin && !_ParseURL(Data.sURL, _T("downloads")).IsEmpty())
d3963 16
a3978 5
		strTmp = _ParseURLArray(Data.sURL, _T("downloads"));
		EnumCategories	eCatID = (iCat == 0) ? CAT_NONE : CCat::GetCatIDByUserIndex(iCat);
		int		iCurPos = 0;
		CString	strResToken;
		byte	abyteFileHash[16];
d3980 1
a3980 7
		for (;;)
		{
			strResToken = strTmp.Tokenize(_T("|"), iCurPos);
			if (strResToken.IsEmpty())
				break;
			if (md4cmp0(StringToHash(strResToken, abyteFileHash)) != 0)
				g_App.m_pSearchList->AddFileToDownloadByHash(abyteFileHash, eCatID);
a3981 2

		iCat = (iCat == 0) ? 0 : CCat::UserCatIndexToCatIndex(iCat);
@


1.425
log
@WebServer: show download list source information similar to GUI {Vladimir (SV)}.
@
text
@d689 1
a689 1
			// decode value ...
d691 1
a691 1
			value = URLDecode(value);
@


1.424
log
@GetKnownFilePriorityString() functionality moved to knownfile class.
@
text
@d2367 13
a2379 4
				strTmp.Format(_T("%i&nbsp;/&nbsp;%8i&nbsp;(%i)"),
				pFileArr[i].lSourceCount - pFileArr[i].lNotCurrentSourceCount,
				pFileArr[i].lSourceCount,
				pFileArr[i].lTransferringSourceCount);
@


1.423
log
@removed duplicated statistic update
@
text
@d2991 1
a2991 1
		dFile.sFilePriority = GetKnownFilePriorityString(cur_file);
@


1.422
log
@changed the intialization of thread locale
@
text
@a3463 1
	g_App.m_pMDlg->ShowStatistics();
@


1.421
log
@1) renamed GetFakeCheckComment() into GetFakeComment()
2) GetFakeComment() returns the string over parameter
3) removed LastHit interface
@
text
@a457 2
	SetThreadLocale(g_App.m_pPrefs->GetLanguageID());

@


1.420
log
@WebServer: fixed application date format changed after WebServer usage {glaskrug} (previous solution based on setlocale was causing time format change from time to time);
Optimized code to change JumpStart and Priority in the WS shared files list.
@
text
@d1907 1
a1907 1
			dFile.sFakeCheck = g_App.m_pFakeCheck->GetFakeCheckComment(HashToString(pPartFile->GetFileHash()),pPartFile->GetFileSize());
@


1.419
log
@Removed secure protection for password hashes -- no point to do it for something changed once in a blue moon.
@
text
@a273 48
void CWebServer::_SetSharedFileJumpstart(const CString &strFileHash)
{
	EMULE_TRY

	byte	abyteFileHash[16];

	if (md4cmp0(StringToHash(strFileHash, abyteFileHash)) != 0)
	{
		CKnownFile	*pCurFile;

		if ((pCurFile = g_App.m_pSharedFilesList->GetFileByID(abyteFileHash)) != NULL)
		{
#ifdef OLD_SOCKETS_ENABLED
		//	Don't enable JumpStart for small files
			if (pCurFile->GetFileSize() > PARTSIZE)
				pCurFile->SetJumpstartEnabled(true);
#endif //OLD_SOCKETS_ENABLED

			g_App.m_pSharedFilesList->UpdateItem(pCurFile);
		}
	}

	EMULE_CATCH
}

void CWebServer::_SetSharedFileNoJumpstart(const CString &strFileHash)
{
	EMULE_TRY

	byte	abyteFileHash[16];

	if (md4cmp0(StringToHash(strFileHash, abyteFileHash)) != 0)
	{
		CKnownFile	*pCurFile;

		if ((pCurFile = g_App.m_pSharedFilesList->GetFileByID(abyteFileHash)) != NULL)
		{
#ifdef OLD_SOCKETS_ENABLED
			pCurFile->SetJumpstartEnabled(false);
#endif //OLD_SOCKETS_ENABLED

			g_App.m_pSharedFilesList->UpdateItem(pCurFile);
		}
	}

	EMULE_CATCH
}

d395 1
a395 1
		char		acGMT[maxTimeBufferSize];
a397 1
		CString		strPrevLocale(_tsetlocale(LC_TIME, NULL));
a398 1
		_tsetlocale(LC_TIME, _T("English"));
d404 1
a404 2
			if ( (timeFileMod.GetGmtTm(&stTm) != NULL) &&
				(strftime(acGMT, maxTimeBufferSize, "%a, %d %b %Y %H:%M:%S GMT", &stTm) != 0) )
d406 1
a408 1
					_tsetlocale(LC_TIME, strPrevLocale);
d418 1
a418 1
	//	DonGato: expire images after 30 days (can be override by browser)
d433 1
a433 2
		if ( (t.GetGmtTm(&stTm) != NULL) &&
			(strftime(acGMT, maxTimeBufferSize, "%a, %d %b %Y %H:%M:%S GMT", &stTm) != 0) )
d435 1
a438 1
		_tsetlocale(LC_TIME, strPrevLocale);
d711 1
a711 1
	Out.Replace(_T("[CharSet]"), _GetWebCharSet());
d2802 1
a2802 1
	bool	bAdmin = IsSessionAdmin(Data, sSession);
d2820 1
a2820 1
	if (bAdmin && !_ParseURL(Data.sURL, _T("hash")).IsEmpty() && !_ParseURL(Data.sURL, _T("prio")).IsEmpty())
d2822 2
a2823 3
		byte	abyteFileHash[16];

		if (md4cmp0(StringToHash(_ParseURL(Data.sURL, _T("hash")), abyteFileHash)) != 0)
d2825 1
a2825 1
			CKnownFile	*pCurFile;
d2827 2
a2828 1
			if ((pCurFile = g_App.m_pSharedFilesList->GetFileByID(abyteFileHash)) != NULL)
d2830 3
a2832 13
				pCurFile->SetAutoULPriority(false);
				strTmp = _ParseURL(Data.sURL, _T("prio"));
				if (strTmp == _T("verylow"))
					pCurFile->SetULPriority(PR_VERYLOW);
				else if (strTmp == _T("low"))
					pCurFile->SetULPriority(PR_LOW);
				else if (strTmp == _T("normal"))
					pCurFile->SetULPriority(PR_NORMAL);
				else if (strTmp == _T("high"))
					pCurFile->SetULPriority(PR_HIGH);
				else if (strTmp == _T("release"))
					pCurFile->SetULPriority(PR_RELEASE);
				else if (strTmp == _T("auto"))
d2834 44
a2877 2
					pCurFile->SetAutoULPriority(true);
					pCurFile->UpdateUploadAutoPriority();
a2878 2

				g_App.m_pSharedFilesList->UpdateItem(pCurFile);	// Refresh GUI on priority change
a2886 8
	if (bAdmin)
	{
		strTmp = _ParseURL(Data.sURL, _T("jumpstart"));
		if (strTmp == _T("true"))
			_SetSharedFileJumpstart(_ParseURL(Data.sURL, _T("hash")));
		else if (strTmp == _T("false"))
			_SetSharedFileNoJumpstart(_ParseURL(Data.sURL, _T("hash")));
	}
d3634 1
a3634 1
	Out.Replace(_T("[CharSet]"), _GetWebCharSet());
d3844 1
a3844 1
const TCHAR* CWebServer::_GetWebCharSet()
a3848 2
	EMULE_TRY

a3862 2
	EMULE_CATCH

@


1.418
log
@added Unicode support for web server
@
text
@d524 2
a525 2
	CStringA *pstrOut = NULL;
	byte	*gzipOut = NULL;
d4291 1
a4291 1
			byte	abyteDigest[16], abyteWSPass[16];
d4295 1
a4295 1
			if (md4cmp(MD5Sum(_ParseURL(Data.sURL, _T("p")), abyteDigest), g_App.m_pPrefs->GetWSPass(abyteWSPass)) == 0)
d4305 1
a4305 1
				(md4cmp(abyteDigest, g_App.m_pPrefs->GetWSLowPass(abyteWSPass)) == 0) )
@


1.417
log
@Resolved VS2002 debug compilation [DoubleT].
@
text
@d524 2
a525 1
	TCHAR	*gzipOut = NULL;
d628 9
d642 3
a644 3
			unsigned uiDstLen = Out.GetLength() + 1024;
			gzipOut = new TCHAR[uiDstLen];
			if (GzipCompress((byte*)gzipOut, &uiDstLen, (const byte*)(TCHAR*)Out.GetBuffer(0), Out.GetLength(), Z_DEFAULT_COMPRESSION) == Z_OK)
d663 1
a663 1
	AddDebugLogLine(_T("WebServer: request prepared (Sz=%u)"), (!isUseGzip) ? Out.GetLength() : uiGzipLen);
d667 1
a667 1
		Data.pSocket->SendContent(HTTPInit, Out, Out.GetLength());
a736 3
			TCHAR fromReplace[4] = { _T('%') };	// decode URL
			TCHAR toReplace[2] = _T("\0");	// decode URL

d745 1
a745 8
			for (i = 0; i <= 255; i++)
			{
				_stprintf(&fromReplace[1], _T("%02x"), i);
				toReplace[0] = static_cast<TCHAR>(i);
				value.Replace(fromReplace, toReplace);
				_stprintf(&fromReplace[1], _T("%02X"), i);
				value.Replace(fromReplace, toReplace);
			}
d3874 1
a3874 1
CString	CWebServer::_GetWebCharSet()
d3876 3
d3900 1
@


1.416
log
@Preserve WebServer list statuses between restarts;
Resolved some Unicode issues; Some generic and string processing optimizations [Aw3].
@
text
@d1701 1
a1701 1
				CUpDownClient	*pClient;
d1703 2
a1704 2
				if ( md4cmp0(StringToHash(_ParseURL(Data.sURL, _T("userhash")), abyteHashBuf)) != 0
					&& (pClient = g_App.m_pClientList->FindClientByUserHash(abyteHashBuf)) != NULL )
@


1.415
log
@Suppressed compiler warnings; Shortened category services [Aw3].
@
text
@d38 9
a46 1
#define WEB_SERVER_TEMPLATES_VERSION	1010
a62 13
	m_Params.DownloadSort = DOWN_SORT_NAME;
	m_Params.bDownloadSortReverse = true;
	m_Params.UploadSort = UP_SORT_FILENAME;
	m_Params.bUploadSortReverse = true;
	m_Params.QueueSort = QU_SORT_FILENAME;
	m_Params.bQueueSortReverse = true;
	m_Params.ServerSort = SERVER_SORT_NAME;
	m_Params.bServerSortReverse = true;
	m_Params.SharedSort = SHARED_SORT_NAME;
	m_Params.bSharedSortReverse = true;
	m_iSearchSortby = 3;
	m_bSearchAsc = false;

d146 1
a146 1
			m_Templates.iProgressbarWidth = static_cast<uint16>(_tstoi(_LoadTemplate(sAll,_T("PROGRESSBARWIDTH"))));
d996 41
d1046 1
a1046 1
	bool bAdmin = IsSessionAdmin(Data,sSession);
d1124 10
a1133 33
		bool	bDirection = false;

		if(strSort == _T("state"))
			m_Params.ServerSort = SERVER_SORT_STATE;
		else if(strSort == _T("name"))
		{
			m_Params.ServerSort = SERVER_SORT_NAME;
			bDirection = true;
		}
		else if(strSort == _T("ip"))
			m_Params.ServerSort = SERVER_SORT_IP;
		else if(strSort == _T("description"))
		{
			m_Params.ServerSort = SERVER_SORT_DESCRIPTION;
			bDirection = true;
		}
		else if(strSort == _T("ping"))
			m_Params.ServerSort = SERVER_SORT_PING;
		else if(strSort == _T("users"))
			m_Params.ServerSort = SERVER_SORT_USERS;
		else if(strSort == _T("files"))
			m_Params.ServerSort = SERVER_SORT_FILES;
		else if(strSort == _T("priority"))
			m_Params.ServerSort = SERVER_SORT_PRIORITY;
		else if(strSort == _T("failed"))
			m_Params.ServerSort = SERVER_SORT_FAILED;
		else if(strSort == _T("limit"))
			m_Params.ServerSort = SERVER_SORT_LIMIT;
		else if(strSort == _T("version"))
			m_Params.ServerSort = SERVER_SORT_VERSION;

		if (strTmp.IsEmpty())
			m_Params.bServerSortReverse = bDirection;
a1134 2
	if (!strTmp.IsEmpty())
		m_Params.bServerSortReverse = (strTmp == "true");
d1142 4
a1145 1
	const TCHAR *pcTmp = (m_Params.bServerSortReverse) ? _T("&amp;sortreverse=false") : _T("&amp;sortreverse=true");
a1146 11
	Out.Replace(_T("[SortState]"), (m_Params.ServerSort == SERVER_SORT_STATE) ? pcTmp : _T(""));
	Out.Replace(_T("[SortName]"), (m_Params.ServerSort == SERVER_SORT_NAME) ? pcTmp : _T(""));
	Out.Replace(_T("[SortIP]"), (m_Params.ServerSort == SERVER_SORT_IP) ? pcTmp : _T(""));
	Out.Replace(_T("[SortDescription]"), (m_Params.ServerSort == SERVER_SORT_DESCRIPTION) ? pcTmp : _T(""));
	Out.Replace(_T("[SortPing]"), (m_Params.ServerSort == SERVER_SORT_PING) ? pcTmp : _T(""));
	Out.Replace(_T("[SortUsers]"), (m_Params.ServerSort == SERVER_SORT_USERS) ? pcTmp : _T(""));
	Out.Replace(_T("[SortFiles]"), (m_Params.ServerSort == SERVER_SORT_FILES) ? pcTmp : _T(""));
	Out.Replace(_T("[SortPriority]"), (m_Params.ServerSort == SERVER_SORT_PRIORITY) ? pcTmp : _T(""));
	Out.Replace(_T("[SortFailed]"), (m_Params.ServerSort == SERVER_SORT_FAILED) ? pcTmp : _T(""));
	Out.Replace(_T("[SortLimit]"), (m_Params.ServerSort == SERVER_SORT_LIMIT) ? pcTmp : _T(""));
	Out.Replace(_T("[SortVersion]"), (m_Params.ServerSort == SERVER_SORT_VERSION) ? pcTmp : _T(""));
d1149 1
a1149 1
	const TCHAR *pcSortIcon = (m_Params.bServerSortReverse) ? m_Templates.sUpArrow : m_Templates.sDownArrow;
d1151 1
a1151 2
	_GetPlainResString(&strTmp, IDS_SL_SERVERNAME, true);
	if (!m_pWSPrefs->abServerColHidden[0])
d1153 13
a1165 124
		Out.Replace(_T("[ServernameI]"), (m_Params.ServerSort == SERVER_SORT_NAME) ? pcSortIcon : _T(""));
		Out.Replace(_T("[ServernameH]"), strTmp);
	}
	else
	{
		Out.Replace(_T("[ServernameI]"), _T(""));
		Out.Replace(_T("[ServernameH]"), _T(""));
	}
	Out.Replace(_T("[ServernameM]"), strTmp);

	_GetPlainResString(&strTmp, IDS_IP, true);
	if (!m_pWSPrefs->abServerColHidden[1])
	{
		Out.Replace(_T("[AddressI]"), (m_Params.ServerSort == SERVER_SORT_IP) ? pcSortIcon : _T(""));
		Out.Replace(_T("[AddressH]"), strTmp);
	}
	else
	{
		Out.Replace(_T("[AddressI]"), _T(""));
		Out.Replace(_T("[AddressH]"), _T(""));
	}
	Out.Replace(_T("[AddressM]"), strTmp);

	_GetPlainResString(&strTmp, IDS_DESCRIPTION, true);
	if (!m_pWSPrefs->abServerColHidden[2])
	{
		Out.Replace(_T("[DescriptionI]"), (m_Params.ServerSort == SERVER_SORT_DESCRIPTION) ? pcSortIcon : _T(""));
		Out.Replace(_T("[DescriptionH]"), strTmp);
	}
	else
	{
		Out.Replace(_T("[DescriptionI]"), _T(""));
		Out.Replace(_T("[DescriptionH]"), _T(""));
	}
	Out.Replace(_T("[DescriptionM]"), strTmp);

	_GetPlainResString(&strTmp, IDS_PING, true);
	if (!m_pWSPrefs->abServerColHidden[3])
	{
		Out.Replace(_T("[PingI]"), (m_Params.ServerSort == SERVER_SORT_PING) ? pcSortIcon : _T(""));
		Out.Replace(_T("[PingH]"), strTmp);
	}
	else
	{
		Out.Replace(_T("[PingI]"), _T(""));
		Out.Replace(_T("[PingH]"), _T(""));
	}
	Out.Replace(_T("[PingM]"), strTmp);

	_GetPlainResString(&strTmp, IDS_UUSERS, true);
	if (!m_pWSPrefs->abServerColHidden[4])
	{
		Out.Replace(_T("[UsersI]"), (m_Params.ServerSort == SERVER_SORT_USERS) ? pcSortIcon : _T(""));
		Out.Replace(_T("[UsersH]"), strTmp);
	}
	else
	{
		Out.Replace(_T("[UsersI]"), _T(""));
		Out.Replace(_T("[UsersH]"), _T(""));
	}
	Out.Replace(_T("[UsersM]"), strTmp);

	_GetPlainResString(&strTmp, IDS_FILES, true);
	if (!m_pWSPrefs->abServerColHidden[5])
	{
		Out.Replace(_T("[FilesI]"), (m_Params.ServerSort == SERVER_SORT_FILES) ? pcSortIcon : _T(""));
		Out.Replace(_T("[FilesH]"), strTmp);
	}
	else
	{
		Out.Replace(_T("[FilesI]"), _T(""));
		Out.Replace(_T("[FilesH]"), _T(""));
	}
	Out.Replace(_T("[FilesM]"), strTmp);

	_GetPlainResString(&strTmp, IDS_PRIORITY, true);
	if (!m_pWSPrefs->abServerColHidden[6])
	{
		Out.Replace(_T("[PriorityI]"), (m_Params.ServerSort == SERVER_SORT_PRIORITY) ? pcSortIcon : _T(""));
		Out.Replace(_T("[PriorityH]"), strTmp);
	}
	else
	{
		Out.Replace(_T("[PriorityI]"), _T(""));
		Out.Replace(_T("[PriorityH]"), _T(""));
	}
	Out.Replace(_T("[PriorityM]"), strTmp);

	_GetPlainResString(&strTmp, IDS_UFAILED, true);
	if (!m_pWSPrefs->abServerColHidden[7])
	{
		Out.Replace(_T("[FailedI]"), (m_Params.ServerSort == SERVER_SORT_FAILED) ? pcSortIcon : _T(""));
		Out.Replace(_T("[FailedH]"), strTmp);
	}
	else
	{
		Out.Replace(_T("[FailedI]"), _T(""));
		Out.Replace(_T("[FailedH]"), _T(""));
	}
	Out.Replace(_T("[FailedM]"), strTmp);

	_GetPlainResString(&strTmp, IDS_SERVER_SOFTHARDLIMIT, true);
	if (!m_pWSPrefs->abServerColHidden[8])
	{
		Out.Replace(_T("[LimitI]"), (m_Params.ServerSort == SERVER_SORT_LIMIT) ? pcSortIcon : _T(""));
		Out.Replace(_T("[LimitH]"), strTmp);
	}
	else
	{
		Out.Replace(_T("[LimitI]"), _T(""));
		Out.Replace(_T("[LimitH]"), _T(""));
	}
	Out.Replace(_T("[LimitM]"), strTmp);

	_GetPlainResString(&strTmp, IDS_SERVER_VERSION, true);
	if (!m_pWSPrefs->abServerColHidden[9])
	{
		Out.Replace(_T("[VersionI]"), (m_Params.ServerSort == SERVER_SORT_VERSION) ? pcSortIcon : _T(""));
		Out.Replace(_T("[VersionH]"), strTmp);
	}
	else
	{
		Out.Replace(_T("[VersionI]"), _T(""));
		Out.Replace(_T("[VersionH]"), _T(""));
a1166 1
	Out.Replace(_T("[VersionM]"), strTmp);
d1176 1
a1176 1
	for (uint32 sc=0;sc<g_App.m_pServerList->GetServerCount();sc++)
d1247 4
a1250 2
	bool bSorted = true;
	for(int nMax = 0;bSorted && nMax < ServerArray.GetCount()*2; nMax++)
d1256 1
a1256 1
			switch (m_Params.ServerSort)
d1258 33
a1290 33
			case SERVER_SORT_STATE:
				bSwap = ServerArray[i].sServerState.CompareNoCase(ServerArray[i+1].sServerState) > 0;
				break;
			case SERVER_SORT_NAME:
				bSwap = ServerArray[i].sServerName.CompareNoCase(ServerArray[i+1].sServerName) < 0;
				break;
			case SERVER_SORT_IP:
				bSwap = ServerArray[i].sServerFullIP < ServerArray[i+1].sServerFullIP;
				break;
			case SERVER_SORT_DESCRIPTION:
				bSwap = ServerArray[i].sServerDescription.CompareNoCase(ServerArray[i+1].sServerDescription) < 0;
				break;
			case SERVER_SORT_PING:
				bSwap = ServerArray[i].nServerPing < ServerArray[i+1].nServerPing;
				break;
			case SERVER_SORT_USERS:
				bSwap = ServerArray[i].nServerUsers < ServerArray[i+1].nServerUsers;
				break;
			case SERVER_SORT_FILES:
				bSwap = ServerArray[i].nServerFiles < ServerArray[i+1].nServerFiles;
				break;
			case SERVER_SORT_PRIORITY:
				bSwap = ServerArray[i].nServerPriority < ServerArray[i+1].nServerPriority;
				break;
			case SERVER_SORT_FAILED:
				bSwap = ServerArray[i].nServerFailed < ServerArray[i+1].nServerFailed;
				break;
			case SERVER_SORT_LIMIT:
				bSwap = ServerArray[i].nServerSoftLimit < ServerArray[i+1].nServerSoftLimit;
				break;
			case SERVER_SORT_VERSION:
				bSwap = ServerArray[i].sServerVersion < ServerArray[i+1].sServerVersion;
				break;
d1292 1
a1292 1
			if (m_Params.bServerSortReverse)
d1294 1
a1294 1
			if(bSwap)
d1455 89
a1623 1
			CString	sFile(_ParseURL(Data.sURL, _T("file")));
d1626 2
a1627 1
			if (!sFile.IsEmpty())
d1631 1
a1631 1
				if ( md4cmp0(StringToHash(sFile, abyteHashBuf)) != 0
d1717 2
a1718 2
	CString sSort(_ParseURL(Data.sURL, _T("sort")));
	bool	bDirection;
d1720 1
a1720 1
	if (!sSort.IsEmpty())
d1722 32
a1753 72
		bDirection = false;
		if(sSort.CompareNoCase(_T("dstate")) == 0)
			m_Params.DownloadSort = DOWN_SORT_STATE;
		else if(sSort.CompareNoCase(_T("dtype")) == 0)
			m_Params.DownloadSort = DOWN_SORT_TYPE;
		else if(sSort.CompareNoCase(_T("dname")) == 0)
		{
			m_Params.DownloadSort = DOWN_SORT_NAME;
			bDirection = true;
		}
		else if(sSort.CompareNoCase(_T("dsize")) == 0)
			m_Params.DownloadSort = DOWN_SORT_SIZE;
		else if(sSort.CompareNoCase(_T("dtransferred")) == 0)
			m_Params.DownloadSort = DOWN_SORT_TRANSFERRED;
		else if(sSort.CompareNoCase(_T("dspeed")) == 0)
			m_Params.DownloadSort = DOWN_SORT_SPEED;
		else if(sSort.CompareNoCase(_T("dprogress")) == 0)
			m_Params.DownloadSort = DOWN_SORT_PROGRESS;
		else if(sSort.CompareNoCase(_T("dsources")) == 0)
			m_Params.DownloadSort = DOWN_SORT_SOURCES;
		else if(sSort.CompareNoCase(_T("dpriority")) == 0)
			m_Params.DownloadSort = DOWN_SORT_PRIORITY;
		else if(sSort.CompareNoCase(_T("dcategory")) == 0)
		{
			m_Params.DownloadSort = DOWN_SORT_CATEGORY;
			bDirection = true;
		}
		else if(sSort.CompareNoCase(_T("dfakecheck")) == 0)
			m_Params.DownloadSort = DOWN_SORT_FAKECHECK;
		else if(sSort.CompareNoCase(_T("uuser")) == 0)
		{
			m_Params.UploadSort = UP_SORT_USER;
			bDirection = true;
		}
		else if(sSort.CompareNoCase(_T("uclient")) == 0)
			m_Params.UploadSort = UP_SORT_CLIENT;
		else if(sSort.CompareNoCase(_T("uversion")) == 0)
			m_Params.UploadSort = UP_SORT_VERSION;
		else if(sSort.CompareNoCase(_T("ufilename")) == 0)
		{
			m_Params.UploadSort = UP_SORT_FILENAME;
			bDirection = true;
		}
		else if(sSort.CompareNoCase(_T("utransferred")) == 0)
			m_Params.UploadSort = UP_SORT_TRANSFERRED;
		else if(sSort.CompareNoCase(_T("uspeed")) == 0)
			m_Params.UploadSort = UP_SORT_SPEED;
		else if(sSort.CompareNoCase(_T("qclient")) == 0)
			m_Params.QueueSort = QU_SORT_CLIENT;
		else if(sSort.CompareNoCase(_T("quser")) == 0)
		{
			m_Params.QueueSort = QU_SORT_USER;
			bDirection = true;
		}
		else if(sSort.CompareNoCase(_T("qversion")) == 0)
			m_Params.QueueSort = QU_SORT_VERSION;
		else if(sSort.CompareNoCase(_T("qfilename")) == 0)
		{
			m_Params.QueueSort = QU_SORT_FILENAME;
			bDirection = true;
		}
		else if(sSort.CompareNoCase(_T("qscore")) == 0)
			m_Params.QueueSort = QU_SORT_SCORE;

		if (strTmp.IsEmpty())
		{
			if (sSort.GetAt(0) == 'd')
				m_Params.bDownloadSortReverse = bDirection;
			else if (sSort.GetAt(0) == 'u')
				m_Params.bUploadSortReverse = bDirection;
			else if (sSort.GetAt(0) == 'q')
				m_Params.bQueueSortReverse = bDirection;
d1759 8
a1766 7
		bDirection = (strTmp == "true");
		if (sSort.GetAt(0) == 'd')
			m_Params.bDownloadSortReverse = bDirection;
		else if (sSort.GetAt(0) == 'u')
			m_Params.bUploadSortReverse = bDirection;
		else if (sSort.GetAt(0) == 'q')
			m_Params.bQueueSortReverse = bDirection;
d1803 1
a1803 1
	const TCHAR	*pcTmp = (m_Params.bDownloadSortReverse) ? _T("&amp;sortreverse=false") : _T("&amp;sortreverse=true");
d1805 2
a1806 20
	Out.Replace(_T("[SortDState]"), (m_Params.DownloadSort == DOWN_SORT_STATE) ? pcTmp : _T(""));
	Out.Replace(_T("[SortDType]"), (m_Params.DownloadSort == DOWN_SORT_TYPE) ? pcTmp : _T(""));
	Out.Replace(_T("[SortDName]"), (m_Params.DownloadSort == DOWN_SORT_NAME) ? pcTmp : _T(""));
	Out.Replace(_T("[SortDSize]"), (m_Params.DownloadSort == DOWN_SORT_SIZE) ? pcTmp : _T(""));
	Out.Replace(_T("[SortDTransferred]"), (m_Params.DownloadSort == DOWN_SORT_TRANSFERRED) ? pcTmp : _T(""));
	Out.Replace(_T("[SortDSpeed]"), (m_Params.DownloadSort == DOWN_SORT_SPEED) ? pcTmp : _T(""));
	Out.Replace(_T("[SortDProgress]"), (m_Params.DownloadSort == DOWN_SORT_PROGRESS) ? pcTmp : _T(""));
	Out.Replace(_T("[SortDSources]"), (m_Params.DownloadSort == DOWN_SORT_SOURCES) ? pcTmp : _T(""));
	Out.Replace(_T("[SortDPriority]"), (m_Params.DownloadSort == DOWN_SORT_PRIORITY) ? pcTmp : _T(""));
	Out.Replace(_T("[SortDCategory]"), (m_Params.DownloadSort == DOWN_SORT_CATEGORY) ? pcTmp : _T(""));
	Out.Replace(_T("[SortDFakeCheck]"), (m_Params.DownloadSort == DOWN_SORT_FAKECHECK) ? pcTmp : _T(""));

	pcTmp = (m_Params.bUploadSortReverse) ? _T("&amp;sortreverse=false") : _T("&amp;sortreverse=true");

	Out.Replace(_T("[SortUClient]"), (m_Params.UploadSort == UP_SORT_CLIENT) ? pcTmp : _T(""));
	Out.Replace(_T("[SortUUser]"), (m_Params.UploadSort == UP_SORT_USER) ? pcTmp : _T(""));
	Out.Replace(_T("[SortUVersion]"), (m_Params.UploadSort == UP_SORT_VERSION) ? pcTmp : _T(""));
	Out.Replace(_T("[SortUFilename]"), (m_Params.UploadSort == UP_SORT_FILENAME) ? pcTmp : _T(""));
	Out.Replace(_T("[SortUTransferred]"), (m_Params.UploadSort == UP_SORT_TRANSFERRED) ? pcTmp : _T(""));
	Out.Replace(_T("[SortUSpeed]"), (m_Params.UploadSort == UP_SORT_SPEED) ? pcTmp : _T(""));
d1808 5
a1812 1
	const TCHAR *pcSortIcon = (m_Params.bDownloadSortReverse) ? m_Templates.sUpArrow : m_Templates.sDownArrow;
d1814 1
a1814 2
	_GetPlainResString(&strTmp, IDS_DL_FILENAME, true);
	if (!m_pWSPrefs->abDownloadColHidden[0])
d1816 13
a1828 2
		Out.Replace(_T("[DFilenameI]"), (m_Params.DownloadSort == DOWN_SORT_NAME) ? pcSortIcon : _T(""));
		Out.Replace(_T("[DFilename]"), strTmp);
a1829 6
	else
	{
		Out.Replace(_T("[DFilenameI]"), _T(""));
		Out.Replace(_T("[DFilename]"), _T(""));
	}
	Out.Replace(_T("[DFilenameM]"), strTmp);
d1831 1
a1831 12
	_GetPlainResString(&strTmp, IDS_DL_SIZE, true);
	if (!m_pWSPrefs->abDownloadColHidden[1])
	{
		Out.Replace(_T("[DSizeI]"), (m_Params.DownloadSort == DOWN_SORT_SIZE) ? pcSortIcon : _T(""));
		Out.Replace(_T("[DSize]"), strTmp);
	}
	else
	{
		Out.Replace(_T("[DSizeI]"), _T(""));
		Out.Replace(_T("[DSize]"), _T(""));
	}
	Out.Replace(_T("[DSizeM]"), strTmp);
d1833 1
a1833 2
	_GetPlainResString(&strTmp, IDS_SF_COMPLETED, true);
	if (!m_pWSPrefs->abDownloadColHidden[2])
d1835 13
a1847 46
		Out.Replace(_T("[DTransferredI]"), (m_Params.DownloadSort == DOWN_SORT_TRANSFERRED) ? pcSortIcon : _T(""));
		Out.Replace(_T("[DTransferred]"), strTmp);
	}
	else
	{
		Out.Replace(_T("[DTransferredI]"), _T(""));
		Out.Replace(_T("[DTransferred]"), _T(""));
	}
	Out.Replace(_T("[DTransferredM]"), strTmp);

	_GetPlainResString(&strTmp, IDS_DL_PROGRESS, true);
	if (!m_pWSPrefs->abDownloadColHidden[3])
	{
		Out.Replace(_T("[DProgressI]"), (m_Params.DownloadSort == DOWN_SORT_PROGRESS) ? pcSortIcon : _T(""));
		Out.Replace(_T("[DProgress]"), strTmp);
	}
	else
	{
		Out.Replace(_T("[DProgressI]"), _T(""));
		Out.Replace(_T("[DProgress]"), _T(""));
	}
	Out.Replace(_T("[DProgressM]"), strTmp);

	_GetPlainResString(&strTmp, IDS_DL_SPEED, true);
	if (!m_pWSPrefs->abDownloadColHidden[4])
	{
		Out.Replace(_T("[DSpeedI]"), (m_Params.DownloadSort == DOWN_SORT_SPEED) ? pcSortIcon : _T(""));
		Out.Replace(_T("[DSpeed]"), strTmp);
	}
	else
	{
		Out.Replace(_T("[DSpeedI]"), _T(""));
		Out.Replace(_T("[DSpeed]"), _T(""));
	}
	Out.Replace(_T("[DSpeedM]"), strTmp);

	_GetPlainResString(&strTmp, IDS_DL_SOURCES, true);
	if (!m_pWSPrefs->abDownloadColHidden[5])
	{
		Out.Replace(_T("[DSourcesI]"), (m_Params.DownloadSort == DOWN_SORT_SOURCES) ? pcSortIcon : _T(""));
		Out.Replace(_T("[DSources]"), strTmp);
	}
	else
	{
		Out.Replace(_T("[DSourcesI]"), _T(""));
		Out.Replace(_T("[DSources]"), _T(""));
a1848 107
	Out.Replace(_T("[DSourcesM]"), strTmp);

	_GetPlainResString(&strTmp, IDS_PRIORITY, true);
	if (!m_pWSPrefs->abDownloadColHidden[6])
	{
		Out.Replace(_T("[DPriorityI]"), (m_Params.DownloadSort == DOWN_SORT_PRIORITY) ? pcSortIcon : _T(""));
		Out.Replace(_T("[DPriority]"), strTmp);
	}
	else
	{
		Out.Replace(_T("[DPriorityI]"), _T(""));
		Out.Replace(_T("[DPriority]"), _T(""));
	}
	Out.Replace(_T("[DPriorityM]"), strTmp);

	_GetPlainResString(&strTmp, IDS_CAT, true);
	if (!m_pWSPrefs->abDownloadColHidden[7])
	{
		Out.Replace(_T("[DCategoryI]"), (m_Params.DownloadSort == DOWN_SORT_CATEGORY) ? pcSortIcon : _T(""));
		Out.Replace(_T("[DCategory]"), strTmp);
	}
	else
	{
		Out.Replace(_T("[DCategoryI]"), _T(""));
		Out.Replace(_T("[DCategory]"), _T(""));
	}
	Out.Replace(_T("[DCategoryM]"), strTmp);

	_GetPlainResString(&strTmp, IDS_FAKE_CHECK_HEADER, true);
	if (!m_pWSPrefs->abDownloadColHidden[8])
	{
		Out.Replace(_T("[DFakeCheckI]"), (m_Params.DownloadSort == DOWN_SORT_FAKECHECK) ? pcSortIcon : _T(""));
		Out.Replace(_T("[DFakeCheck]"), strTmp);
	}
	else
	{
		Out.Replace(_T("[DFakeCheckI]"), _T(""));
		Out.Replace(_T("[DFakeCheck]"), _T(""));
	}
	Out.Replace(_T("[DFakeCheckM]"), strTmp);

	pcSortIcon = (m_Params.bUploadSortReverse) ? m_Templates.sUpArrow : m_Templates.sDownArrow;

	_GetPlainResString(&strTmp, IDS_QL_USERNAME, true);
	if (!m_pWSPrefs->abUploadColHidden[0])
	{
		Out.Replace(_T("[UUserI]"), (m_Params.UploadSort == UP_SORT_USER) ? pcSortIcon : _T(""));
		Out.Replace(_T("[UUser]"), strTmp);
	}
	else
	{
		Out.Replace(_T("[UUserI]"), _T(""));
		Out.Replace(_T("[UUser]"), _T(""));
	}
	Out.Replace(_T("[UUserM]"), strTmp);

	_GetPlainResString(&strTmp, IDS_INFLST_USER_CLIENTVERSION, true);
	if (!m_pWSPrefs->abUploadColHidden[1])
	{
		Out.Replace(_T("[UVersionI]"), (m_Params.UploadSort == UP_SORT_VERSION) ? pcSortIcon : _T(""));
		Out.Replace(_T("[UVersion]"), strTmp);
	}
	else
	{
		Out.Replace(_T("[UVersionI]"), _T(""));
		Out.Replace(_T("[UVersion]"), _T(""));
	}
	Out.Replace(_T("[UVersionM]"), strTmp);

	_GetPlainResString(&strTmp, IDS_DL_FILENAME, true);
	if (!m_pWSPrefs->abUploadColHidden[2])
	{
		Out.Replace(_T("[UFilenameI]"), (m_Params.UploadSort == UP_SORT_FILENAME) ? pcSortIcon : _T(""));
		Out.Replace(_T("[UFilename]"), strTmp);
	}
	else
	{
		Out.Replace(_T("[UFilenameI]"), _T(""));
		Out.Replace(_T("[UFilename]"), _T(""));
	}
	Out.Replace(_T("[UFilenameM]"), strTmp);

	_GetPlainResString(&strTmp, IDS_DL_ULDL, true);
	if (!m_pWSPrefs->abUploadColHidden[3])
	{
		Out.Replace(_T("[UTransferredI]"), (m_Params.UploadSort == UP_SORT_TRANSFERRED) ? pcSortIcon : _T(""));
		Out.Replace(_T("[UTransferred]"), strTmp);
	}
	else
	{
		Out.Replace(_T("[UTransferredI]"), _T(""));
		Out.Replace(_T("[UTransferred]"), _T(""));
	}
	Out.Replace(_T("[UTransferredM]"), strTmp);

	_GetPlainResString(&strTmp, IDS_DL_SPEED, true);
	if (!m_pWSPrefs->abUploadColHidden[4])
	{
		Out.Replace(_T("[USpeedI]"), (m_Params.UploadSort == UP_SORT_SPEED) ? pcSortIcon : _T(""));
		Out.Replace(_T("[USpeed]"), strTmp);
	}
	else
	{
		Out.Replace(_T("[USpeedI]"), _T(""));
		Out.Replace(_T("[USpeed]"), _T(""));
	}
	Out.Replace(_T("[USpeedM]"), strTmp);
d1977 1
a1977 1
	bool	bSwap, bSorted = true;
d1981 1
d1991 1
a1991 1
				switch (m_Params.DownloadSort)
d1993 1
a1993 1
					case DOWN_SORT_STATE:
d1996 1
a1996 1
					case DOWN_SORT_TYPE:
d1999 1
a1999 1
					case DOWN_SORT_NAME:
d2002 1
a2002 1
					case DOWN_SORT_SIZE:
d2005 1
a2005 1
					case DOWN_SORT_TRANSFERRED:
d2008 1
a2008 1
					case DOWN_SORT_SPEED:
d2011 1
a2011 1
					case DOWN_SORT_PROGRESS:
d2014 1
a2014 1
					case DOWN_SORT_SOURCES:
d2017 1
a2017 1
					case DOWN_SORT_PRIORITY:
d2020 1
a2020 1
					case DOWN_SORT_CATEGORY:
d2023 1
a2023 1
					case DOWN_SORT_FAKECHECK:
d2030 1
a2030 1
				if (m_Params.bDownloadSortReverse)
d2116 1
d2123 1
a2123 1
			switch (m_Params.UploadSort)
d2125 18
a2142 18
			case UP_SORT_CLIENT:
				bSwap = pUploadArr[i].sClientSoft.Compare(pUploadArr[i+1].sClientSoft) < 0;
				break;
			case UP_SORT_USER:
				bSwap = pUploadArr[i].sUserName.CompareNoCase(pUploadArr[i+1].sUserName) < 0;
				break;
			case UP_SORT_VERSION:
				bSwap = pUploadArr[i].sClientNameVersion.CompareNoCase(pUploadArr[i+1].sClientNameVersion) < 0;
				break;
			case UP_SORT_FILENAME:
				bSwap = pUploadArr[i].sFileName.CompareNoCase(pUploadArr[i+1].sFileName) < 0;
				break;
			case UP_SORT_TRANSFERRED:
				bSwap = pUploadArr[i].nTransferredUp < pUploadArr[i+1].nTransferredUp;
				break;
			case UP_SORT_SPEED:
				bSwap = pUploadArr[i].dwDataRate < pUploadArr[i+1].dwDataRate;
				break;
d2144 1
a2144 1
			if (m_Params.bUploadSortReverse)
d2239 1
a2239 1
		switch (m_Params.QueueSort)
d2241 17
a2257 17
		case QU_SORT_CLIENT:
			dUser.sIndex = dUser.sClientSoft;
			break;
		case QU_SORT_USER:
			dUser.sIndex = dUser.sUserName;
			break;
		case QU_SORT_VERSION:
			dUser.sIndex = dUser.sClientNameVersion;
			break;
		case QU_SORT_FILENAME:
			dUser.sIndex = dUser.sFileName;
			break;
		case QU_SORT_SCORE:
			dUser.sIndex.Format(_T("%09u"), dUser.dwScore);
			break;
		default:
			dUser.sIndex.Empty();
d2275 1
a2275 1
	DWORD dwStart = ::GetTickCount();
d2277 1
a2277 1
	QueueArray.QuickSort(m_Params.bQueueSortReverse);
d2279 1
a2279 1
	AddDebugLogLine(_T("WebServer: Waitingqueue with %u elements sorted in %u ms"), QueueArray.GetSize(), ::GetTickCount()-dwStart);
d2398 1
a2398 1
			HTTPProcessData.Replace(_T("[DownloadBar]"), _GetDownloadGraph(Data, abyteFileHash));
d2500 1
a2500 1
	strTmp.Format(_T("%i"), m_Templates.iProgressbarWidth);
d2779 1
a2779 1
	pcTmp = (m_Params.bQueueSortReverse) ? _T("&amp;sortreverse=false") : _T("&amp;sortreverse=true");
d2781 2
a2782 5
	Out.Replace(_T("[SortQClient]"), (m_Params.QueueSort == QU_SORT_CLIENT) ? pcTmp : _T(""));
	Out.Replace(_T("[SortQUser]"), (m_Params.QueueSort == QU_SORT_USER) ? pcTmp : _T(""));
	Out.Replace(_T("[SortQVersion]"), (m_Params.QueueSort == QU_SORT_VERSION) ? pcTmp : _T(""));
	Out.Replace(_T("[SortQFilename]"), (m_Params.QueueSort == QU_SORT_FILENAME) ? pcTmp : _T(""));
	Out.Replace(_T("[SortQScore]"), (m_Params.QueueSort == QU_SORT_SCORE) ? pcTmp : _T(""));
d2784 1
a2784 1
	pcSortIcon = (m_Params.bQueueSortReverse) ? m_Templates.sUpArrow : m_Templates.sDownArrow;
d2786 1
a2786 2
	_GetPlainResString(&strTmp, IDS_QL_USERNAME, true);
	if (!m_pWSPrefs->abQueueColHidden[0])
d2788 13
a2800 15
		Out.Replace(_T("[UserNameTitleI]"), (m_Params.QueueSort == QU_SORT_USER) ? pcSortIcon : _T(""));
		Out.Replace(_T("[UserNameTitle]"), strTmp);
	}
	else
	{
		Out.Replace(_T("[UserNameTitleI]"), _T(""));
		Out.Replace(_T("[UserNameTitle]"), _T(""));
	}
	Out.Replace(_T("[UserNameTitleM]"), strTmp);

	_GetPlainResString(&strTmp, IDS_INFLST_USER_CLIENTVERSION, true);
	if (!m_pWSPrefs->abQueueColHidden[1])
	{
		Out.Replace(_T("[VersionI]"), (m_Params.QueueSort == QU_SORT_VERSION) ? pcSortIcon : _T(""));
		Out.Replace(_T("[Version]"), strTmp);
a2801 32
	else
	{
		Out.Replace(_T("[VersionI]"), _T(""));
		Out.Replace(_T("[Version]"), _T(""));
	}
	Out.Replace(_T("[VersionM]"), strTmp);

	_GetPlainResString(&strTmp, IDS_DL_FILENAME, true);
	if (!m_pWSPrefs->abQueueColHidden[2])
	{
		Out.Replace(_T("[FileNameTitleI]"), (m_Params.QueueSort == QU_SORT_FILENAME) ? pcSortIcon : _T(""));
		Out.Replace(_T("[FileNameTitle]"), strTmp);
	}
	else
	{
		Out.Replace(_T("[FileNameTitleI]"), _T(""));
		Out.Replace(_T("[FileNameTitle]"), _T(""));
	}
	Out.Replace(_T("[FileNameTitleM]"), strTmp);

	_GetPlainResString(&strTmp, IDS_SCORE, true);
	if (!m_pWSPrefs->abQueueColHidden[3])
	{
		Out.Replace(_T("[ScoreTitleI]"), (m_Params.QueueSort == QU_SORT_SCORE) ? pcSortIcon : _T(""));
		Out.Replace(_T("[ScoreTitle]"), strTmp);
	}
	else
	{
		Out.Replace(_T("[ScoreTitleI]"), _T(""));
		Out.Replace(_T("[ScoreTitle]"), _T(""));
	}
	Out.Replace(_T("[ScoreTitleM]"), strTmp);
d2811 34
d2847 1
a2847 1
	int		iCat = _tstoi(_ParseURL(Data.sURL, _T("cat"))) & 0xFF;
d2854 1
a2854 1
	bool	bAdmin = IsSessionAdmin(Data,sSession);
a2856 1
	strTmp = _ParseURL(Data.sURL, _T("sortreverse"));
d2859 11
a2869 32
		bool	bDirection = false;

		if (strSort == "state")
			m_Params.SharedSort = SHARED_SORT_STATE;
		else if (strSort == "type")
			m_Params.SharedSort = SHARED_SORT_TYPE;
		else if (strSort == "name")
		{
			m_Params.SharedSort = SHARED_SORT_NAME;
			bDirection = true;
		}
		else if (strSort == _T("size"))
			m_Params.SharedSort = SHARED_SORT_SIZE;
		else if (strSort == _T("transferred"))
			m_Params.SharedSort = SHARED_SORT_TRANSFERRED;
		else if (strSort == _T("alltimetransferred"))
			m_Params.SharedSort = SHARED_SORT_ALL_TIME_TRANSFERRED;
		else if (strSort == _T("requests"))
			m_Params.SharedSort = SHARED_SORT_REQUESTS;
		else if (strSort == _T("alltimerequests"))
			m_Params.SharedSort = SHARED_SORT_ALL_TIME_REQUESTS;
		else if (strSort == _T("accepts"))
			m_Params.SharedSort = SHARED_SORT_ACCEPTS;
		else if (strSort == _T("alltimeaccepts"))
			m_Params.SharedSort = SHARED_SORT_ALL_TIME_ACCEPTS;
		else if (strSort == _T("completes"))
			m_Params.SharedSort = SHARED_SORT_COMPLETES;
		else if (strSort == _T("priority"))
			m_Params.SharedSort = SHARED_SORT_PRIORITY;

		if (strTmp.IsEmpty())
			m_Params.bSharedSortReverse = bDirection;
a2870 2
	if (!strTmp.IsEmpty())
		m_Params.bSharedSortReverse = (strTmp == _T("true"));
d2872 1
a2872 1
	if (!_ParseURL(Data.sURL, _T("hash")).IsEmpty() && !_ParseURL(Data.sURL, _T("prio")).IsEmpty() && IsSessionAdmin(Data,sSession))
d2905 2
a2906 2
	CString sCmd = _ParseURL(Data.sURL, _T("c"));
	if (sCmd.CompareNoCase(_T("menu")) == 0)
d2917 1
a2917 1
	if(_ParseURL(Data.sURL, _T("reload")) == _T("true"))
a2920 1
	const TCHAR *pcTmp = (m_Params.bSharedSortReverse) ? _T("&amp;sortreverse=false") : _T("&amp;sortreverse=true");
d2922 7
a2928 45
	Out.Replace(_T("[SortState]"), (m_Params.SharedSort == SHARED_SORT_STATE) ? pcTmp : _T(""));
	Out.Replace(_T("[SortType]"), (m_Params.SharedSort == SHARED_SORT_TYPE) ? pcTmp : _T(""));
	Out.Replace(_T("[SortName]"), (m_Params.SharedSort == SHARED_SORT_NAME) ? pcTmp : _T(""));
	Out.Replace(_T("[SortSize]"), (m_Params.SharedSort == SHARED_SORT_SIZE) ? pcTmp : _T(""));
	Out.Replace(_T("[SortCompletes]"), (m_Params.SharedSort == SHARED_SORT_COMPLETES) ? pcTmp : _T(""));
	Out.Replace(_T("[SortPriority]"), (m_Params.SharedSort == SHARED_SORT_PRIORITY) ? pcTmp : _T(""));
//	Transferred sorting link
	pcTmp = _T("transferred&amp;sortreverse=false");
	if (m_Params.SharedSort == SHARED_SORT_TRANSFERRED)
	{
		pcTmp = (m_Params.bSharedSortReverse) ?
			_T("alltimetransferred&amp;sortreverse=false") : _T("transferred&amp;sortreverse=true");
	}
	else if (m_Params.SharedSort == SHARED_SORT_ALL_TIME_TRANSFERRED)
	{
		if (!m_Params.bSharedSortReverse)
			pcTmp = _T("alltimetransferred&amp;sortreverse=true");
	}
	Out.Replace(_T("[SortTransferred]"), pcTmp);
//	Request sorting link
	pcTmp = _T("requests&amp;sortreverse=false");
	if (m_Params.SharedSort == SHARED_SORT_REQUESTS)
	{
		pcTmp = (m_Params.bSharedSortReverse) ?
			_T("alltimerequests&amp;sortreverse=false") : _T("requests&amp;sortreverse=true");
	}
	else if (m_Params.SharedSort == SHARED_SORT_ALL_TIME_REQUESTS)
	{
		if (!m_Params.bSharedSortReverse)
			pcTmp = _T("alltimerequests&amp;sortreverse=true");
	}
	Out.Replace(_T("[SortRequests]"), pcTmp);
//	Accepts sorting link
	pcTmp = _T("accepts&amp;sortreverse=false");
	if (m_Params.SharedSort == SHARED_SORT_ACCEPTS)
	{
		pcTmp = (m_Params.bSharedSortReverse) ?
			_T("alltimeaccepts&amp;sortreverse=false") : _T("accepts&amp;sortreverse=true");
	}
	else if (m_Params.SharedSort == SHARED_SORT_ALL_TIME_ACCEPTS)
	{
		if (!m_Params.bSharedSortReverse)
			pcTmp = _T("alltimeaccepts&amp;sortreverse=true");
	}
	Out.Replace(_T("[SortAccepts]"), pcTmp);
d2930 1
a2930 1
	if(_ParseURL(Data.sURL, _T("reload")) == "true")
d2942 3
a2944 2
	const TCHAR *pcSortIcon = (m_Params.bSharedSortReverse) ? m_Templates.sUpArrow : m_Templates.sDownArrow;
	const TCHAR *pcIconTmp;
d2946 1
a2946 2
	_GetPlainResString(&strTmp, IDS_DL_FILENAME, true);
	if (!m_pWSPrefs->abSharedColHidden[0])
d2948 13
a2960 2
		Out.Replace(_T("[FilenameI]"), (m_Params.SharedSort == SHARED_SORT_NAME) ? pcSortIcon : _T(""));
		Out.Replace(_T("[Filename]"), strTmp);
a2961 93
	else
	{
		Out.Replace(_T("[FilenameI]"), _T(""));
		Out.Replace(_T("[Filename]"), _T(""));
	}
	Out.Replace(_T("[FilenameM]"), strTmp);

	_GetPlainResString(&strTmp, IDS_SF_TRANSFERRED, true);
	if (!m_pWSPrefs->abSharedColHidden[1])
	{
		pcIconTmp = (m_Params.SharedSort == SHARED_SORT_TRANSFERRED) ? pcSortIcon : _T("");
		if (m_Params.SharedSort == SHARED_SORT_ALL_TIME_TRANSFERRED)
			pcIconTmp = (m_Params.bSharedSortReverse) ? m_Templates.strUpDoubleArrow : m_Templates.strDownDoubleArrow;
		Out.Replace(_T("[FileTransferredI]"), pcIconTmp);
		Out.Replace(_T("[FileTransferred]"), strTmp);
	}
	else
	{
		Out.Replace(_T("[FileTransferredI]"), _T(""));
		Out.Replace(_T("[FileTransferred]"),  _T(""));
	}
	Out.Replace(_T("[FileTransferredM]"), strTmp);

	_GetPlainResString(&strTmp, IDS_SF_REQUESTS, true);
	if (!m_pWSPrefs->abSharedColHidden[2])
	{
		pcIconTmp = (m_Params.SharedSort == SHARED_SORT_REQUESTS) ? pcSortIcon : _T("");
		if (m_Params.SharedSort == SHARED_SORT_ALL_TIME_REQUESTS)
			pcIconTmp = (m_Params.bSharedSortReverse) ? m_Templates.strUpDoubleArrow : m_Templates.strDownDoubleArrow;
		Out.Replace(_T("[FileRequestsI]"), pcIconTmp);
		Out.Replace(_T("[FileRequests]"), strTmp);
	}
	else
	{
		Out.Replace(_T("[FileRequestsI]"), _T(""));
		Out.Replace(_T("[FileRequests]"),  _T(""));
	}
	Out.Replace(_T("[FileRequestsM]"), strTmp);

	_GetPlainResString(&strTmp, IDS_SF_ACCEPTS, true);
	if (!m_pWSPrefs->abSharedColHidden[3])
	{
		pcIconTmp = (m_Params.SharedSort == SHARED_SORT_ACCEPTS) ? pcSortIcon : _T("");
		if (m_Params.SharedSort == SHARED_SORT_ALL_TIME_ACCEPTS)
			pcIconTmp = (m_Params.bSharedSortReverse) ? m_Templates.strUpDoubleArrow : m_Templates.strDownDoubleArrow;
		Out.Replace(_T("[FileAcceptsI]"), pcIconTmp);
		Out.Replace(_T("[FileAccepts]"), strTmp);
	}
	else
	{
		Out.Replace(_T("[FileAcceptsI]"), _T(""));
		Out.Replace(_T("[FileAccepts]"),  _T(""));
	}
	Out.Replace(_T("[FileAcceptsM]"), strTmp);

	_GetPlainResString(&strTmp, IDS_DL_SIZE, true);
	if (!m_pWSPrefs->abSharedColHidden[4])
	{
		Out.Replace(_T("[SizeI]"), (m_Params.SharedSort == SHARED_SORT_SIZE) ? pcSortIcon : _T(""));
		Out.Replace(_T("[Size]"), strTmp);
	}
	else
	{
		Out.Replace(_T("[SizeI]"), _T(""));
		Out.Replace(_T("[Size]"), _T(""));
	}
	Out.Replace(_T("[SizeM]"), strTmp);

	_GetPlainResString(&strTmp, IDS_SF_COMPLETESRC, true);
	if (!m_pWSPrefs->abSharedColHidden[5])
	{
		Out.Replace(_T("[CompletesI]"), (m_Params.SharedSort == SHARED_SORT_COMPLETES) ? pcSortIcon : _T(""));
		Out.Replace(_T("[Completes]"), strTmp);
	}
	else
	{
		Out.Replace(_T("[CompletesI]"), _T(""));
		Out.Replace(_T("[Completes]"),  _T(""));
	}
	Out.Replace(_T("[CompletesM]"), strTmp);

	_GetPlainResString(&strTmp, IDS_PRIORITY, true);
	if (!m_pWSPrefs->abSharedColHidden[6])
	{
		Out.Replace(_T("[PriorityI]"), (m_Params.SharedSort == SHARED_SORT_PRIORITY) ? pcSortIcon : _T(""));
		Out.Replace(_T("[Priority]"), strTmp);
	}
	else
	{
		Out.Replace(_T("[PriorityI]"), _T(""));
		Out.Replace(_T("[Priority]"),  _T(""));
	}
	Out.Replace(_T("[PriorityM]"), strTmp);
d3030 1
a3030 1
	bool bSorted = true;
d3032 2
a3033 1
	for(int nMax = 0; bSorted && nMax < SharedArray.GetCount()*2; nMax++)
d3039 1
a3039 1
			switch(m_Params.SharedSort)
d3041 38
a3078 38
			case SHARED_SORT_STATE:
				bSwap = _tcscmp(SharedArray[i].pcFileState, SharedArray[i+1].pcFileState) > 0;
				break;
			case SHARED_SORT_TYPE:
				bSwap = _tcscmp(SharedArray[i].pcFileType, SharedArray[i+1].pcFileType) > 0;
				break;
			case SHARED_SORT_NAME:
				bSwap = SharedArray[i].sFileName.CompareNoCase(SharedArray[i+1].sFileName) < 0;
				break;
			case SHARED_SORT_SIZE:
				bSwap = SharedArray[i].m_qwFileSize < SharedArray[i+1].m_qwFileSize;
				break;
			case SHARED_SORT_TRANSFERRED:
				bSwap = SharedArray[i].nFileTransferred < SharedArray[i+1].nFileTransferred;
				break;
			case SHARED_SORT_ALL_TIME_TRANSFERRED:
				bSwap = SharedArray[i].nFileAllTimeTransferred < SharedArray[i+1].nFileAllTimeTransferred;
				break;
			case SHARED_SORT_REQUESTS:
				bSwap = SharedArray[i].nFileRequests < SharedArray[i+1].nFileRequests;
				break;
			case SHARED_SORT_ALL_TIME_REQUESTS:
				bSwap = SharedArray[i].nFileAllTimeRequests < SharedArray[i+1].nFileAllTimeRequests;
				break;
			case SHARED_SORT_ACCEPTS:
				bSwap = SharedArray[i].nFileAccepts < SharedArray[i+1].nFileAccepts;
				break;
			case SHARED_SORT_ALL_TIME_ACCEPTS:
				bSwap = SharedArray[i].nFileAllTimeAccepts < SharedArray[i+1].nFileAllTimeAccepts;
				break;
			case SHARED_SORT_COMPLETES:
				bSwap = SharedArray[i].dblFileCompletes < SharedArray[i+1].dblFileCompletes;
				break;
			case SHARED_SORT_PRIORITY:
				//Very low priority is define equal to 4 ! Must adapte sorting code
				if(SharedArray[i].nFilePriority == 4)
				{
					if(SharedArray[i+1].nFilePriority == 4)
d3081 2
a3082 12
						bSwap = true;
				}
				else if(SharedArray[i+1].nFilePriority == 4)
				{
						if(SharedArray[i].nFilePriority == 4)
							bSwap = true;
						else
							bSwap = false;
				}
				else
					bSwap = SharedArray[i].nFilePriority < SharedArray[i+1].nFilePriority;
				break;
d3084 1
a3084 1
			if (m_Params.bSharedSortReverse)
d3086 1
a3086 1
			if(bSwap)
d3110 3
a3112 1
		switch (SharedArray[i].nFilePriority)
d3114 19
a3132 16
			case PR_VERYLOW:
				pcSharedPrio = _T("VeryLow");
				break;
			case PR_LOW:
				pcSharedPrio = _T("Low");
				break;
			default:
			case PR_NORMAL:
				pcSharedPrio = _T("Normal");
				break;
			case PR_HIGH:
				pcSharedPrio = _T("High");
				break;
			case PR_RELEASE:
				pcSharedPrio = _T("Release");
				break;
a3133 2
		if (SharedArray[i].bFileAutoPriority)
			pcSharedPrio = _T("Auto");
d3184 3
a3186 4
			_stprintf(HTTPTempC, _T("%s"),CastItoXBytes(SharedArray[i].nFileTransferred));
			HTTPProcessData.Replace(_T("[FileTransferred]"), CString(HTTPTempC));
			_stprintf(HTTPTempC, _T("%s"),CastItoXBytes(SharedArray[i].nFileAllTimeTransferred));
			HTTPProcessData.Replace(_T("[FileAllTimeTransferred]"), _T(" (") + CString(HTTPTempC) + _T(")"));
d3196 3
a3198 3
			HTTPProcessData.Replace(_T("[FileRequests]"), CString(HTTPTempC));
			_stprintf(HTTPTempC, _T("%i"), SharedArray[i].nFileAllTimeRequests);
			HTTPProcessData.Replace(_T("[FileAllTimeRequests]"), _T(" (") + CString(HTTPTempC) + _T(")"));
d3208 3
a3210 3
			HTTPProcessData.Replace(_T("[FileAccepts]"), CString(HTTPTempC));
			_stprintf(HTTPTempC, _T("%i"), SharedArray[i].nFileAllTimeAccepts);
			HTTPProcessData.Replace(_T("[FileAllTimeAccepts]"), _T(" (") + CString(HTTPTempC) + _T(")"));
d3218 1
a3218 4
		{
			_stprintf(HTTPTempC, _T("%s"),CastItoXBytes(SharedArray[i].m_qwFileSize));
			HTTPProcessData.Replace(_T("[FileSize]"), CString(HTTPTempC));
		}
d3863 1
a3863 1
void CWebServer::_GetPlainResString(CString *pstrOut, UINT nID, bool noquote /*=false*/)
d3867 1
a3867 1
	if(noquote)
d3899 2
a3900 2
// Ornis: creating the progressbar. colored if ressources are given/available
CString CWebServer::_GetDownloadGraph(const ThreadData &Data, const byte *pbyteHash)
d3904 9
a3912 5
	CWebServer	*pThis = reinterpret_cast<CWebServer *>(Data.pThis);

	if (pThis == NULL)
		return _T("");

d3915 1
a3915 1
	CString 	progresscolor[12];
d3920 1
a3920 12
		progresscolor[0]=_T("p_green.gif");
		progresscolor[1]=_T("p_black.gif");
		progresscolor[2]=_T("p_yellow.gif");
		progresscolor[3]=_T("p_red.gif");
		progresscolor[4]=_T("p_blue1.gif");
		progresscolor[5]=_T("p_blue2.gif");
		progresscolor[6]=_T("p_blue3.gif");
		progresscolor[7]=_T("p_blue4.gif");
		progresscolor[8]=_T("p_blue5.gif");
		progresscolor[9]=_T("p_blue6.gif");
		progresscolor[10]=_T("p_greenpercent.gif");
		progresscolor[11]=_T("transparent.gif");
d3925 1
a3925 12
		progresscolor[0]=_T("green.gif");
		progresscolor[1]=_T("black.gif");
		progresscolor[2]=_T("yellow.gif");
		progresscolor[3]=_T("red.gif");
		progresscolor[4]=_T("blue1.gif");
		progresscolor[5]=_T("blue2.gif");
		progresscolor[6]=_T("blue3.gif");
		progresscolor[7]=_T("blue4.gif");
		progresscolor[8]=_T("blue5.gif");
		progresscolor[9]=_T("blue6.gif");
		progresscolor[10]=_T("greenpercent.gif");
		progresscolor[11]=_T("transparent.gif");
d3930 2
a3931 2
		Out.AppendFormat(pThis->m_Templates.sProgressbarImgsPercent + _T("<br />"), progresscolor[10], pThis->m_Templates.iProgressbarWidth);
		Out.AppendFormat(pThis->m_Templates.sProgressbarImgs,progresscolor[0], pThis->m_Templates.iProgressbarWidth);
d3935 3
a3937 1
		CString s_ChunkBar=pPartFile->GetProgressString(pThis->m_Templates.iProgressbarWidth);
d3940 1
a3940 6
		byte lastcolor = 1, byteColor;
		uint16 lastindex = 0;

		int		compl = static_cast<int>((pThis->m_Templates.iProgressbarWidth / 100.0) * pPartFile->GetPercentCompleted());

		Out.AppendFormat(pThis->m_Templates.sProgressbarImgsPercent + _T("<br />"),
d3943 1
a3943 1
		for (uint16 i=0;i<pThis->m_Templates.iProgressbarWidth;i++)
d3945 2
a3946 2
			byteColor = static_cast<byte>(_tstoi(s_ChunkBar.Mid(i, 1)));
			if (lastcolor != byteColor)
d3948 2
a3949 2
				if (i > lastindex)
					Out.AppendFormat(pThis->m_Templates.sProgressbarImgs, progresscolor[lastcolor], i-lastindex);
d3951 2
a3952 2
				lastcolor = byteColor;
				lastindex=i;
d3955 1
a3955 1
		Out.AppendFormat(pThis->m_Templates.sProgressbarImgs, progresscolor[lastcolor], pThis->m_Templates.iProgressbarWidth-lastindex);
d3966 8
d3978 1
a3978 1
	CString	Out(m_Templates.sSearch);
d3981 1
a3981 1
	if (!_ParseURL(Data.sURL, _T("downloads")).IsEmpty() && bAdmin)
d3983 1
a3983 1
		CString	strDownloads = _ParseURLArray(Data.sURL, _T("downloads"));
d3986 1
a3986 1
		CString	strResToken = strDownloads.Tokenize(_T("|"), iCurPos);
d3989 1
a3989 1
		while (!strResToken.IsEmpty())
d3991 3
a3995 1
			strResToken = strDownloads.Tokenize(_T("|"), iCurPos);
d4008 1
a4008 1
	if (sCmd.CompareNoCase(_T("update")) == 0 && bAdmin)
d4014 2
a4015 1
	if (!_ParseURL(Data.sURL, _T("tosearch")).IsEmpty() && bAdmin)
d4019 1
a4019 2
		g_App.m_pMDlg->m_dlgSearch.DoNewEd2kSearch(
			_ParseURL(Data.sURL, _T("tosearch")),
d4028 2
a4029 2
	else if (!_ParseURL(Data.sURL, _T("tosearch")).IsEmpty() && !bAdmin)
		Out.Replace(_T("[Message]"),_GetPlainResString(IDS_ACCESSDENIED));
d4033 4
a4036 1
	CString strTmp = _ParseURL(Data.sURL, _T("sort"));
d4038 8
a4045 5
	if (!strTmp.IsEmpty())
		m_iSearchSortby = _tstoi(strTmp);
	strTmp = _ParseURL(Data.sURL, _T("sortAsc"));
	if (!strTmp.IsEmpty())
		m_bSearchAsc = (_tstoi(strTmp) != 0);
a4046 1
	sCmd = _ParseURL(Data.sURL, _T("c"));
d4052 2
a4053 1
	strResultList += g_App.m_pSearchList->GetWebList(m_Templates.sSearchResultLine, m_iSearchSortby, m_bSearchAsc,
a4089 1

d4093 1
a4093 1
	const TCHAR *pcSortIcon = (m_bSearchAsc) ? m_Templates.sUpArrow : m_Templates.sDownArrow;
d4095 1
a4095 2
	_GetPlainResString(&strTmp, IDS_DL_FILENAME);
	if (!m_pWSPrefs->abSearchColHidden[0])
d4097 13
a4109 2
		Out.Replace(_T("[FilenameI]"), (m_iSearchSortby == 0) ? pcSortIcon : _T(""));
		Out.Replace(_T("[FilenameH]"), strTmp);
a4110 6
	else
	{
		Out.Replace(_T("[FilenameI]"), _T(""));
		Out.Replace(_T("[FilenameH]"), _T(""));
	}
	Out.Replace(_T("[FilenameM]"), strTmp);
d4112 1
a4112 12
	_GetPlainResString(&strTmp, IDS_DL_SIZE);
	if (!m_pWSPrefs->abSearchColHidden[1])
	{
		Out.Replace(_T("[FilesizeI]"), (m_iSearchSortby == 1) ? pcSortIcon : _T(""));
		Out.Replace(_T("[FilesizeH]"), strTmp);
	}
	else
	{
		Out.Replace(_T("[FilesizeI]"), _T(""));
		Out.Replace(_T("[FilesizeH]"), _T(""));
	}
	Out.Replace(_T("[FilesizeM]"), strTmp);
d4114 1
a4114 2
	_GetPlainResString(&strTmp, IDS_FILEHASH);
	if (!m_pWSPrefs->abSearchColHidden[2])
d4116 3
a4118 2
		Out.Replace(_T("[FilehashI]"), (m_iSearchSortby == 2) ? pcSortIcon : _T(""));
		Out.Replace(_T("[FilehashH]"), strTmp);
a4119 42
	else
	{
		Out.Replace(_T("[FilehashI]"), _T(""));
		Out.Replace(_T("[FilehashH]"), _T(""));
	}
	Out.Replace(_T("[FilehashM]"), strTmp);

	_GetPlainResString(&strTmp, IDS_DL_SOURCES);
	if (!m_pWSPrefs->abSearchColHidden[3])
	{
		Out.Replace(_T("[SourcesI]"), (m_iSearchSortby == 3) ? pcSortIcon : _T(""));
		Out.Replace(_T("[SourcesH]"), strTmp);
	}
	else
	{
		Out.Replace(_T("[SourcesI]"), _T(""));
		Out.Replace(_T("[SourcesH]"), _T(""));
	}
	Out.Replace(_T("[SourcesM]"), strTmp);

	_GetPlainResString(&strTmp, IDS_FAKE_CHECK_HEADER);
	if (!m_pWSPrefs->abSearchColHidden[4])
	{
		Out.Replace(_T("[FakeCheckI]"), (m_iSearchSortby == 4) ? pcSortIcon : _T(""));
		Out.Replace(_T("[FakeCheckH]"), strTmp);
	}
	else
	{
		Out.Replace(_T("[FakeCheckI]"), _T(""));
		Out.Replace(_T("[FakeCheckH]"), _T(""));
	}
	Out.Replace(_T("[FakeCheckM]"), strTmp);

	Out.Replace(_T("[Download]"), _GetPlainResString(IDS_DOWNLOAD_VERB));

	Out.Replace(_T("[SORTASCVALUE0]"), ((m_iSearchSortby != 0) || (m_bSearchAsc == 0)) ? _T("1") : _T("0"));
	Out.Replace(_T("[SORTASCVALUE1]"), ((m_iSearchSortby != 1) || (m_bSearchAsc == 0)) ? _T("1") : _T("0"));
	Out.Replace(_T("[SORTASCVALUE2]"), ((m_iSearchSortby != 2) || (m_bSearchAsc == 0)) ? _T("1") : _T("0"));
	Out.Replace(_T("[SORTASCVALUE3]"), ((m_iSearchSortby != 3) || (m_bSearchAsc == 0)) ? _T("1") : _T("0"));
	Out.Replace(_T("[SORTASCVALUE4]"), ((m_iSearchSortby != 4) || (m_bSearchAsc == 0)) ? _T("1") : _T("0"));
	Out.Replace(_T("[SORTASCVALUE5]"), ((m_iSearchSortby != 5) || (m_bSearchAsc == 0)) ? _T("1") : _T("0"));
	Out.Replace(_T("[SORTASCVALUE6]"), ((m_iSearchSortby != 6) || (m_bSearchAsc == 0)) ? _T("1") : _T("0"));
@


1.414
log
@Preserve client queue statuses between restarts (preferences.ini) [Aw3];
Don't load/save preferences.ini on change of particular parameters (load is done only on startup to avoid double preferences.ini reading when WS is enabled; Save is done with other preferences when it happens) [Aw3];
Checks array boundaries to avoid memory corruption by specially prepared template (could happen on disabling/enabling list columns) [Aw3];
Improved string processing [Aw3].
@
text
@a64 1

d67 1
d219 2
a220 3
	if(m_bServerWorking != g_App.m_pPrefs->GetWSIsEnabled())
		m_bServerWorking = g_App.m_pPrefs->GetWSIsEnabled();
	else
d222 1
d1003 1
a1003 1
	byte	cat = _tstoi(_ParseURL(Data.sURL, _T("cat")));
d1006 2
a1007 2
	if (cat != 0)
		sCat.Format(_T("%u"), cat);
d1566 1
a1566 1
	byte	cat = _tstoi(_ParseURL(Data.sURL, _T("cat")));
d1569 2
a1570 2
	if (cat != 0)
		sCat.Format(_T("&cat=%u"), cat);
d1582 1
a1582 2
			EnumCategories eCatID = (cat == 0) ? CAT_ALL : CCat::GetCatIDByUserIndex(cat);

d1587 1
a1587 1
			cat = cat == 0 ? 0 : CCat::UserCatIndexToCatIndex(cat);
d1603 1
a1603 1
			EnumCategories	eCatID = cat == 0 ? CAT_NONE : CCat::GetCatIDByUserIndex(cat);
d1606 1
a1606 1
			cat = cat == 0 ? 0 : CCat::UserCatIndexToCatIndex(cat);
d1619 1
a1619 1
		if(bAdmin)
d1621 11
a1631 11
			CString sPrio(_ParseURL(Data.sURL, _T("p")));
			int prio = PR_NORMAL;

			if(sPrio.CompareNoCase(_T("low")) == 0)
				prio = PR_LOW;
			else if(sPrio.CompareNoCase(_T("normal")) == 0)
				prio = PR_NORMAL;
			else if(sPrio.CompareNoCase(_T("high")) == 0)
				prio = PR_HIGH;
			else if(sPrio.CompareNoCase(_T("auto")) == 0)
				prio = PR_AUTO;
d1633 1
a1633 4
			if(cat != 0)
				g_App.m_pDownloadQueue->SetCatPrio(cat, prio);
			else
				g_App.m_pDownloadQueue->SetCatPrio(0, prio);
d1712 1
a1712 1
							pFile->SetCatID(CCat::GetCatIDByIndex(CCat::UserCatIndexToCatIndex(iMenu)));
d1859 1
a1859 1
	InsertCatBox(Out, cat, _T(""), true, true, sSession, NULL);
d2080 2
a2081 1
	double fTotalSize = 0, fTotalTransferred = 0, fTotalSpeed = 0, dTmp;
d2107 3
a2109 3
			if ( !CCat::FileBelongsToGivenCat( pPartFile, (cat > CAT_PREDEFINED)
														 ? static_cast<_EnumCategories>(cat)
														 : CCat::GetCatIDByIndex(cat), true ) )
d2168 1
a2168 1
			dFile.sCategory.Replace(_T("'"),_T("\'"));
d2595 1
a2595 1
		fTotalSize += pFileArr[i].m_qwFileSize;
d2606 1
a2606 1
				fTotalTransferred += pFileArr[i].m_qwFileTransferred;
d2708 2
a2709 3
	Out.Replace(_T("[TotalDownSize]"), CastItoXBytes(fTotalSize));

	Out.Replace(_T("[TotalDownTransferred]"), CastItoXBytes(fTotalTransferred));
d2721 2
a2722 2
	fTotalSize = 0;
	fTotalTransferred = 0;
d2753 2
a2754 2
			fTotalSize += pUploadArr[i].nTransferredDown;
			fTotalTransferred += pUploadArr[i].nTransferredUp;
d2773 1
a2773 1
	strTmp.Format(_T("%s / %s"), CastItoXBytes(fTotalSize), CastItoXBytes(fTotalTransferred));
d3069 1
a3069 1
	byte	cat = _tstoi(_ParseURL(Data.sURL, _T("cat")));
d3072 2
a3073 2
	if (cat != 0)
		sCat.Format(_T("%u"), cat);
d3675 1
a3675 1
	byte	cat = _tstoi(_ParseURL(Data.sURL, _T("cat")));
d3678 2
a3679 2
	if (cat != 0)
		sCat.Format(_T("%u"), cat);
d3773 1
a3773 1
	byte	cat = _tstoi(_ParseURL(Data.sURL, _T("cat")));
d3776 2
a3777 2
	if (cat != 0)
		sCat.Format(_T("%u"), cat);
d3804 1
a3804 1
	byte	cat = _tstoi(_ParseURL(Data.sURL, _T("cat")));
d3807 2
a3808 2
	if (cat != 0)
		sCat.Format(_T("%u"), cat);
d3835 1
a3835 1
	byte	cat = _tstoi(_ParseURL(Data.sURL, _T("cat")));
d3838 2
a3839 2
	if (cat != 0)
		sCat.Format(_T("%u"), cat);
d3891 1
a3891 1
	byte	cat = _tstoi(_ParseURL(Data.sURL, _T("cat")));
d3894 2
a3895 2
	if (cat != 0)
		sCat.Format(_T("%u"), cat);
d3952 1
a3952 1
			g_App.m_pPrefs->SetMaxConnections(_tstoi(_ParseURL(Data.sURL, _T("maxconnections"))));
d4366 1
a4366 1
	byte	cat = _tstoi(_ParseURL(Data.sURL, _T("cat")));
d4374 1
a4374 1
		EnumCategories	eCatID = cat == 0 ? CAT_NONE : CCat::GetCatIDByUserIndex(cat);
d4386 1
a4386 1
		cat = cat == 0 ? 0 : CCat::UserCatIndexToCatIndex(cat);
d4391 2
a4392 2
	if (cat != 0)
		sCat.Format(_T("%u"), cat);
d4427 1
a4427 1
		m_bSearchAsc = _tstoi(strTmp);
d4590 1
a4590 1
		strCategory = (i == 0) ? _GetPlainResString(IDS_CAT_UNCATEGORIZED) : CCat::GetUserCatByIndex(i)->GetTitle();
d4687 1
a4687 1
CString CWebServer::GetSubCatLabel(byte iCat)
d4787 1
a4787 1
	bool		bValue = _tstoi(_ParseURL(strURL, _T("v")));
@


1.413
log
@Speeded up some disk operations [Aw3].
@
text
@a50 7
static bool	WSdownloadColumnHidden[9];
static bool	WSuploadColumnHidden[5];
static bool	WSqueueColumnHidden[4];
static bool	WSsharedColumnHidden[7];
static bool	WSserverColumnHidden[10];
static bool	WSsearchColumnHidden[5];

d53 1
a53 4
	m_Params.bShowUploadQueue = false;
	m_Params.bShowUploadQueueBanned = false;
	m_Params.bShowUploadQueueFriend = false;
	m_Params.bShowUploadQueueCredit = false;
a65 2
	m_Params.bMenuLocked = g_App.m_pPrefs->GetWSMenuLocked();

a114 13
			strTmp.Format(_T("%spreferences.ini"), g_App.m_pPrefs->GetConfigDir());

			CIni ini(strTmp, true);

			ini.SetDefaultCategory(_T("WebServer"));
			ini.GetArray(WSdownloadColumnHidden, ARRSIZE(WSdownloadColumnHidden), _T("downloadColumnHidden"));
			ini.GetArray(WSuploadColumnHidden, ARRSIZE(WSuploadColumnHidden), _T("uploadColumnHidden"));
			ini.GetArray(WSqueueColumnHidden, ARRSIZE(WSqueueColumnHidden), _T("queueColumnHidden"));
			ini.GetArray(WSsearchColumnHidden, ARRSIZE(WSsearchColumnHidden), _T("searchColumnHidden"));
			ini.GetArray(WSsharedColumnHidden, ARRSIZE(WSsharedColumnHidden), _T("sharedColumnHidden"));
			ini.GetArray(WSserverColumnHidden, ARRSIZE(WSserverColumnHidden), _T("serverColumnHidden"));
			ini.CloseWithoutSave();

d874 4
a877 6
	{
		m_Params.bMenuLocked = !m_Params.bMenuLocked;
		g_App.m_pPrefs->SetWSMenuLocked(m_Params.bMenuLocked);
	}
	Out.Replace(_T("[MenuLocked]"), m_Params.bMenuLocked ? _T("true") : _T("false"));
	Out.Replace(_T("[MenuLockTitle]"), _GetPlainResString(m_Params.bMenuLocked ? IDS_MENULOCK_OFF : IDS_MENULOCK_ON));
d1081 1
a1081 12
	{
		int iMenu = _tstoi(_ParseURL(Data.sURL, _T("m")));
		bool bValue = _tstoi(_ParseURL(Data.sURL, _T("v")));
		WSserverColumnHidden[iMenu] = bValue;
		CString fullpath;
		fullpath.Format(_T("%spreferences.ini"),g_App.m_pPrefs->GetConfigDir());
		CIni ini(fullpath);

		ini.SetDefaultCategory(_T("WebServer"));
		ini.SetArray(WSserverColumnHidden, ARRSIZE(WSserverColumnHidden), _T("serverColumnHidden"));
		ini.SaveAndClose();
	}
d1149 1
a1149 1
	if (!WSserverColumnHidden[0])
d1162 1
a1162 1
	if (!WSserverColumnHidden[1])
d1175 1
a1175 1
	if (!WSserverColumnHidden[2])
d1188 1
a1188 1
	if (!WSserverColumnHidden[3])
d1201 1
a1201 1
	if (!WSserverColumnHidden[4])
d1214 1
a1214 1
	if (!WSserverColumnHidden[5])
d1227 1
a1227 1
	if (!WSserverColumnHidden[6])
d1240 1
a1240 1
	if (!WSserverColumnHidden[7])
d1253 1
a1253 1
	if (!WSserverColumnHidden[8])
d1266 1
a1266 1
	if (!WSserverColumnHidden[9])
d1467 1
a1467 1
		if (!WSserverColumnHidden[0])
d1476 1
a1476 1
		if (!WSserverColumnHidden[1])
d1483 1
a1483 1
		if (!WSserverColumnHidden[2])
d1492 1
a1492 1
		if (!WSserverColumnHidden[3])
d1500 1
a1500 1
		if (!WSserverColumnHidden[4])
d1513 1
a1513 1
		if (!WSserverColumnHidden[5] && (ServerArray[i].nServerFiles > 0))
d1519 1
a1519 1
		if (!WSserverColumnHidden[6])
d1523 1
a1523 1
		if (!WSserverColumnHidden[7])
d1530 1
a1530 1
		if (!WSserverColumnHidden[8])
d1540 1
a1540 1
		if (!WSserverColumnHidden[9])
d1613 1
a1613 12
	{
		int iMenu = _tstoi(_ParseURL(Data.sURL, _T("m")));
		bool bValue = _tstoi(_ParseURL(Data.sURL, _T("v")));
		WSdownloadColumnHidden[iMenu] = bValue;
		CString fullpath;
		fullpath.Format(_T("%spreferences.ini"),g_App.m_pPrefs->GetConfigDir());
		CIni ini(fullpath);

		ini.SetDefaultCategory(_T("WebServer"));
		ini.SetArray(WSdownloadColumnHidden, ARRSIZE(WSdownloadColumnHidden), _T("downloadColumnHidden"));
		ini.SaveAndClose();
	}
d1615 1
a1615 12
	{
		int iMenu = _tstoi(_ParseURL(Data.sURL, _T("m")));
		bool bValue = _tstoi(_ParseURL(Data.sURL, _T("v")));
		WSuploadColumnHidden[iMenu] = bValue;
		CString fullpath;
		fullpath.Format(_T("%spreferences.ini"),g_App.m_pPrefs->GetConfigDir());
		CIni ini(fullpath);

		ini.SetDefaultCategory(_T("WebServer"));
		ini.SetArray(WSuploadColumnHidden, ARRSIZE(WSuploadColumnHidden), _T("uploadColumnHidden"));
		ini.SaveAndClose();
	}
d1617 1
a1617 12
	{
		int iMenu = _tstoi(_ParseURL(Data.sURL, _T("m")));
		bool bValue = _tstoi(_ParseURL(Data.sURL, _T("v")));
		WSqueueColumnHidden[iMenu] = bValue;
		CString fullpath;
		fullpath.Format(_T("%spreferences.ini"),g_App.m_pPrefs->GetConfigDir());
		CIni ini(fullpath);

		ini.SetDefaultCategory(_T("WebServer"));
		ini.SetArray(WSqueueColumnHidden, ARRSIZE(WSqueueColumnHidden), _T("queueColumnHidden"));
		ini.SaveAndClose();
	}
d1833 1
a1833 1
		m_Params.bShowUploadQueue = true;
d1835 1
a1835 1
		m_Params.bShowUploadQueue = false;
d1839 1
a1839 1
		m_Params.bShowUploadQueueBanned = true;
d1841 1
a1841 1
		m_Params.bShowUploadQueueBanned = false;
d1845 1
a1845 1
		m_Params.bShowUploadQueueFriend = true;
d1847 1
a1847 1
		m_Params.bShowUploadQueueFriend = false;
d1851 1
a1851 1
		m_Params.bShowUploadQueueCredit = true;
d1853 1
a1853 1
		m_Params.bShowUploadQueueCredit = false;
d1891 1
a1891 1
	if (!WSdownloadColumnHidden[0])
d1904 1
a1904 1
	if (!WSdownloadColumnHidden[1])
d1917 1
a1917 1
	if (!WSdownloadColumnHidden[2])
d1930 1
a1930 1
	if (!WSdownloadColumnHidden[3])
d1943 1
a1943 1
	if (!WSdownloadColumnHidden[4])
d1956 1
a1956 1
	if (!WSdownloadColumnHidden[5])
d1969 1
a1969 1
	if (!WSdownloadColumnHidden[6])
d1982 1
a1982 1
	if (!WSdownloadColumnHidden[7])
d1995 1
a1995 1
	if (!WSdownloadColumnHidden[8])
d2010 1
a2010 1
	if (!WSuploadColumnHidden[0])
d2023 1
a2023 1
	if (!WSuploadColumnHidden[1])
d2036 1
a2036 1
	if (!WSuploadColumnHidden[2])
d2049 1
a2049 1
	if (!WSuploadColumnHidden[3])
d2062 1
a2062 1
	if (!WSuploadColumnHidden[4])
d2490 4
a2493 4
	if ((nCountQueue > 0 &&	m_Params.bShowUploadQueue) ||
		(nCountQueueBanned > 0 && m_Params.bShowUploadQueueBanned) ||
		(nCountQueueFriend > 0 && m_Params.bShowUploadQueueFriend) ||
		(nCountQueueCredit > 0 && m_Params.bShowUploadQueueCredit))
d2583 1
a2583 1
		if (!WSdownloadColumnHidden[0])
d2600 1
a2600 1
		if (!WSdownloadColumnHidden[1])
d2605 1
a2605 1
		if (!WSdownloadColumnHidden[2])
d2618 1
a2618 1
		if (!WSdownloadColumnHidden[3])
d2623 1
a2623 1
		if (!WSdownloadColumnHidden[4])
d2638 1
a2638 1
		if (!WSdownloadColumnHidden[5])
d2654 1
a2654 1
		if (!WSdownloadColumnHidden[6])
d2695 1
a2695 1
		if (!WSdownloadColumnHidden[7])
d2700 1
a2700 1
		if (!WSdownloadColumnHidden[8])
d2745 1
a2745 1
		pcTmp = (!WSuploadColumnHidden[0]) ? pUploadArr[i].sUserName.GetString() : _T("");
d2748 1
a2748 1
		pcTmp = (!WSuploadColumnHidden[1]) ? pUploadArr[i].sClientNameVersion.GetString() : _T("");
d2751 1
a2751 1
		pcTmp = (!WSuploadColumnHidden[2]) ? pUploadArr[i].sFileName.GetString() : _T("");
d2755 1
a2755 1
		if (!WSuploadColumnHidden[3])
d2765 1
a2765 1
		if (!WSuploadColumnHidden[4])
d2782 1
a2782 1
	if (m_Params.bShowUploadQueue)
d2799 1
a2799 1
				pcTmp = (!WSqueueColumnHidden[0]) ? pQueueArr[i].sUserName.GetString() : _T("");
d2802 1
a2802 1
				pcTmp = (!WSqueueColumnHidden[1]) ? pQueueArr[i].sClientNameVersion.GetString() : _T("");
d2805 1
a2805 1
				pcTmp = (!WSqueueColumnHidden[2]) ? pQueueArr[i].sFileName.GetString() : _T("");
d2809 1
a2809 1
				if (!WSqueueColumnHidden[3])
d2829 1
a2829 1
	if (m_Params.bShowUploadQueueBanned)
d2846 1
a2846 1
				pcTmp = (!WSqueueColumnHidden[0]) ? pQueueArr[i].sUserName.GetString() : _T("");
d2849 1
a2849 1
				pcTmp = (!WSqueueColumnHidden[1]) ? pQueueArr[i].sClientNameVersion.GetString() : _T("");
d2852 1
a2852 1
				pcTmp = (!WSqueueColumnHidden[2]) ? pQueueArr[i].sFileName.GetString() : _T("");
d2856 1
a2856 1
				if (!WSqueueColumnHidden[3])
d2877 1
a2877 1
	if (m_Params.bShowUploadQueueFriend)
d2894 1
a2894 1
				pcTmp = (!WSqueueColumnHidden[0]) ? pQueueArr[i].sUserName.GetString() : _T("");
d2897 1
a2897 1
				pcTmp = (!WSqueueColumnHidden[1]) ? pQueueArr[i].sClientNameVersion.GetString() : _T("");
d2900 1
a2900 1
				pcTmp = (!WSqueueColumnHidden[2]) ? pQueueArr[i].sFileName.GetString() : _T("");
d2904 1
a2904 1
				if (!WSqueueColumnHidden[3])
d2925 1
a2925 1
	if (m_Params.bShowUploadQueueCredit)
d2942 1
a2942 1
				pcTmp = (!WSqueueColumnHidden[0]) ? pQueueArr[i].sUserName.GetString() : _T("");
d2945 1
a2945 1
				pcTmp =  (!WSqueueColumnHidden[1]) ? pQueueArr[i].sClientNameVersion.GetString() : _T("");
d2948 1
a2948 1
				pcTmp =  (!WSqueueColumnHidden[2]) ? pQueueArr[i].sFileName.GetString() : _T("");
d2952 1
a2952 1
				if (!WSqueueColumnHidden[3])
d3012 1
a3012 1
	if (!WSqueueColumnHidden[0])
d3025 1
a3025 1
	if (!WSqueueColumnHidden[1])
d3038 1
a3038 1
	if (!WSqueueColumnHidden[2])
d3051 1
a3051 1
	if (!WSqueueColumnHidden[3])
d3157 2
a3158 12
	{
		int iMenu = _tstoi(_ParseURL(Data.sURL, _T("m")));
		bool bValue = _tstoi(_ParseURL(Data.sURL, _T("v")));
		WSsharedColumnHidden[iMenu] = bValue;
		CString fullpath;
		fullpath.Format(_T("%spreferences.ini"), g_App.m_pPrefs->GetConfigDir());
		CIni ini(fullpath);

		ini.SetDefaultCategory(_T("WebServer"));
		ini.SetArray(WSsharedColumnHidden, ARRSIZE(WSsharedColumnHidden), _T("sharedColumnHidden"));
		ini.SaveAndClose();
	}
d3235 1
a3235 1
	if (!WSsharedColumnHidden[0])
d3248 1
a3248 1
	if (!WSsharedColumnHidden[1])
d3264 1
a3264 1
	if (!WSsharedColumnHidden[2])
d3280 1
a3280 1
	if (!WSsharedColumnHidden[3])
d3296 1
a3296 1
	if (!WSsharedColumnHidden[4])
d3309 1
a3309 1
	if (!WSsharedColumnHidden[5])
d3322 1
a3322 1
	if (!WSsharedColumnHidden[6])
d3550 1
a3550 1
		if (!WSsharedColumnHidden[0])
d3559 1
a3559 1
		if (!WSsharedColumnHidden[1])
d3571 1
a3571 1
		if (!WSsharedColumnHidden[2])
d3583 1
a3583 1
		if (!WSsharedColumnHidden[3])
d3595 1
a3595 1
		if (!WSsharedColumnHidden[4])
d3602 1
a3602 1
		if (!WSsharedColumnHidden[5])
d3606 1
a3606 1
		if (!WSsharedColumnHidden[6])
d3906 1
a3906 1
	if ((_ParseURL(Data.sURL, _T("saveprefs")) == _T("true")) && IsSessionAdmin(Data,sSession) )
d3908 15
a3922 18
		if ((_ParseURL(Data.sURL, _T("showuploadqueue")) == _T("true")) || (_ParseURL(Data.sURL, _T("showuploadqueue")).MakeLower() == _T("on")))
			m_Params.bShowUploadQueue = true;
		else
			m_Params.bShowUploadQueue = false;
		if ((_ParseURL(Data.sURL, _T("showuploadqueuebanned")) == _T("true")) || (_ParseURL(Data.sURL, _T("showuploadqueuebanned")).MakeLower() == _T("on")))
			m_Params.bShowUploadQueueBanned = true;
		else
			m_Params.bShowUploadQueueBanned = false;
		if ((_ParseURL(Data.sURL, _T("showuploadqueuefriend")) == _T("true")) || (_ParseURL(Data.sURL, _T("showuploadqueuefriend")).MakeLower() == _T("on")))
			m_Params.bShowUploadQueueFriend = true;
		else
			m_Params.bShowUploadQueueFriend = false;
		if ((_ParseURL(Data.sURL, _T("showuploadqueuecredit")) == _T("true")) || (_ParseURL(Data.sURL, _T("showuploadqueuecredit")).MakeLower() == _T("on")))
			m_Params.bShowUploadQueueCredit = true;
		else
			m_Params.bShowUploadQueueCredit = false;
		if(!_ParseURL(Data.sURL, _T("refresh")).IsEmpty())
			g_App.m_pPrefs->SetWebPageRefresh(_tstoi(_ParseURL(Data.sURL, _T("refresh"))));
d3925 1
a3925 1
		if(!strTmp.IsEmpty())
d3928 1
a3928 1
		if(!strTmp.IsEmpty())
d3962 7
a3968 17
	if (m_Params.bShowUploadQueue)
		Out.Replace(_T("[ShowUploadQueueVal]"), _T("checked"));
	else
		Out.Replace(_T("[ShowUploadQueueVal]"), _T(""));
	if (m_Params.bShowUploadQueueBanned)
		Out.Replace(_T("[ShowUploadQueueBannedVal]"), _T("checked"));
	else
		Out.Replace(_T("[ShowUploadQueueBannedVal]"), _T(""));
	if (m_Params.bShowUploadQueueFriend)
		Out.Replace(_T("[ShowUploadQueueFriendVal]"), _T("checked"));
	else
		Out.Replace(_T("[ShowUploadQueueFriendVal]"), _T(""));
	if (m_Params.bShowUploadQueueCredit)
		Out.Replace(_T("[ShowUploadQueueCreditVal]"), _T("checked"));
	else
		Out.Replace(_T("[ShowUploadQueueCreditVal]"), _T(""));
	CString sRefresh;
d3970 2
a3971 2
	sRefresh.Format(_T("%d"), g_App.m_pPrefs->GetWebPageRefresh());
	Out.Replace(_T("[RefreshVal]"), sRefresh);
d3973 2
a3974 2
	sRefresh.Format(_T("%d"), g_App.m_pPrefs->GetMaxSourcePerFile());
	Out.Replace(_T("[MaxSourcesVal]"), sRefresh);
d3976 2
a3977 5
	sRefresh.Format(_T("%d"), g_App.m_pPrefs->GetMaxConnections());
	Out.Replace(_T("[MaxConnectionsVal]"), sRefresh);

	sRefresh.Format(_T("%d"), g_App.m_pPrefs->GetMaxConPerFive());
	Out.Replace(_T("[MaxConnectionsPer5Val]"), sRefresh);
d4435 1
a4435 16
	{
		int		iMenu = _tstoi(_ParseURL(Data.sURL, _T("m")));
		bool	bValue = _tstoi(_ParseURL(Data.sURL, _T("v")));

		WSsearchColumnHidden[iMenu] = bValue;

		CString	strFullPath = g_App.m_pPrefs->GetConfigDir();

		strFullPath += _T("preferences.ini");

		CIni	ini(strFullPath);

		ini.SetDefaultCategory(_T("WebServer"));
		ini.SetArray(WSsearchColumnHidden, ARRSIZE(WSsearchColumnHidden), _T("searchColumnHidden"));
		ini.SaveAndClose();
	}
d4439 3
a4441 1
	strResultList += g_App.m_pSearchList->GetWebList(m_Templates.sSearchResultLine, m_iSearchSortby, m_bSearchAsc,!WSsearchColumnHidden[0],!WSsearchColumnHidden[1],!WSsearchColumnHidden[2],!WSsearchColumnHidden[3],!WSsearchColumnHidden[4]);
d4483 1
a4483 1
	if (!WSsearchColumnHidden[0])
d4496 1
a4496 1
	if (!WSsearchColumnHidden[1])
d4509 1
a4509 1
	if (!WSsearchColumnHidden[2])
d4522 1
a4522 1
	if (!WSsearchColumnHidden[3])
d4535 1
a4535 1
	if (!WSsearchColumnHidden[4])
d4787 10
@


1.412
log
@Fixed messed waiting for hash and hashing file statuses in GUI and WebServer {Fuxie - DK} [Aw3] (hashing icon was never displayed).
@
text
@d99 1
a99 1
	if (file.Open(sFile, CFile::modeRead|CFile::shareDenyWrite|CFile::typeText))
d102 2
d129 1
a129 1
			CIni ini(strTmp);
@


1.411
log
@Suppressed level 4 warnings.
@
text
@d2174 2
a2175 2
		EnumPartFileStatuses	eFileStatus;
		CPartFile		*pPartFile = (*pvecPartFiles)[i];
d2199 2
a2200 2
			eFileStatus = pPartFile->GetStatus();
			switch(eFileStatus)
d2225 9
a2233 11
				default:
				{
					int	iFStat = pPartFile->GetPartFileStatusID();

					if (iFStat == PS_DOWNLOADING)
						dFile.pcFileState = _T("downloading");
					else if (iFStat == PS_STALLED)
						dFile.pcFileState = _T("stalled");
					else
						dFile.pcFileState = _T("waiting");
				}
d2255 2
a2256 2
				dFile.cSortRank |= (eFileStatus == PS_PAUSED) ? 1 : 0;
				dFile.cSortRank |= (eFileStatus == PS_STOPPED) ? 2 : 0;
@


1.410
log
@Reduced #include depedency.
@
text
@d130 6
a135 6
			ini.GetArray(WSdownloadColumnHidden, ELEMENT_COUNT(WSdownloadColumnHidden), _T("downloadColumnHidden"));
			ini.GetArray(WSuploadColumnHidden, ELEMENT_COUNT(WSuploadColumnHidden), _T("uploadColumnHidden"));
			ini.GetArray(WSqueueColumnHidden, ELEMENT_COUNT(WSqueueColumnHidden), _T("queueColumnHidden"));
			ini.GetArray(WSsearchColumnHidden, ELEMENT_COUNT(WSsearchColumnHidden), _T("searchColumnHidden"));
			ini.GetArray(WSsharedColumnHidden, ELEMENT_COUNT(WSsharedColumnHidden), _T("sharedColumnHidden"));
			ini.GetArray(WSserverColumnHidden, ELEMENT_COUNT(WSserverColumnHidden), _T("serverColumnHidden"));
d1115 1
a1115 1
		ini.SetArray(WSserverColumnHidden, ELEMENT_COUNT(WSserverColumnHidden), _T("serverColumnHidden"));
d1658 1
a1658 1
		ini.SetArray(WSdownloadColumnHidden, ELEMENT_COUNT(WSdownloadColumnHidden), _T("downloadColumnHidden"));
d1671 1
a1671 1
		ini.SetArray(WSuploadColumnHidden, ELEMENT_COUNT(WSuploadColumnHidden), _T("uploadColumnHidden"));
d1684 1
a1684 1
		ini.SetArray(WSqueueColumnHidden, ELEMENT_COUNT(WSqueueColumnHidden), _T("queueColumnHidden"));
d2158 1
a2158 1
	if (!(pvecPartFiles = g_App.m_pDownloadList->GetFiles()))
d3237 1
a3237 1
		ini.SetArray(WSsharedColumnHidden, ELEMENT_COUNT(WSsharedColumnHidden), _T("sharedColumnHidden"));
d3708 1
d4236 1
d4258 2
d4308 1
d4545 1
a4545 1
		ini.SetArray(WSsearchColumnHidden, ELEMENT_COUNT(WSsearchColumnHidden), _T("searchColumnHidden"));
@


1.409
log
@Speeded up preparation of the search list; Changed template version.
@
text
@d28 1
@


1.408
log
@WebServer: added file menu 'Swap all A4AF sources to other files' {Fuxie - DK};
Proper localization of "Download from all A4AF sources (auto)";
Unicode corrections; Improved string processing.
@
text
@d37 1
a37 1
#define WEB_SERVER_TEMPLATES_VERSION	1009
d4653 7
a4659 12
	strTmp.Format(_T("%i"), (m_iSearchSortby!=0 || (m_iSearchSortby==0 && m_bSearchAsc==0 ))?1:0 );
	Out.Replace(_T("[SORTASCVALUE0]"), strTmp);
	strTmp.Format(_T("%i"), (m_iSearchSortby!=1 || (m_iSearchSortby==1 && m_bSearchAsc==0 ))?1:0 );
	Out.Replace(_T("[SORTASCVALUE1]"), strTmp);
	strTmp.Format(_T("%i"), (m_iSearchSortby!=2 || (m_iSearchSortby==2 && m_bSearchAsc==0 ))?1:0 );
	Out.Replace(_T("[SORTASCVALUE2]"), strTmp);
	strTmp.Format(_T("%i"), (m_iSearchSortby!=3 || (m_iSearchSortby==3 && m_bSearchAsc==0 ))?1:0 );
	Out.Replace(_T("[SORTASCVALUE3]"), strTmp);
	strTmp.Format(_T("%i"), (m_iSearchSortby!=4 || (m_iSearchSortby==4 && m_bSearchAsc==0 ))?1:0 );
	Out.Replace(_T("[SORTASCVALUE4]"), strTmp);
	strTmp.Format(_T("%i"), (m_iSearchSortby!=5 || (m_iSearchSortby==5 && m_bSearchAsc==0 ))?1:0 );
	Out.Replace(_T("[SORTASCVALUE5]"), strTmp);
@


1.407
log
@Optimized string processing while generating server box;
Removed useless IsSessionAdmin checks (verification is done in the beginning of GetAddServerBox);
Minor Unicode correction; Removed unrequired code.
@
text
@d37 1
a37 1
#define WEB_SERVER_TEMPLATES_VERSION	1008
d855 2
a856 1
	Out.Replace(_T("[AUTOA4AF]"), _GetPlainResString(IDS_ALL_A4AF_TO_HERE, true) + _T(" (") + _GetPlainResString(IDS_PRIOAUTO, true).MakeLower() + _T(")"));
d1703 1
a1703 1
				g_App.m_pDownloadQueue->SetCatPrio(cat,prio);
d1705 1
a1705 1
				g_App.m_pDownloadQueue->SetCatPrio(0,prio);
d1725 1
a1725 1
					if (sOp.CompareNoCase(_T("a4af")) == 0)
d1727 1
a1727 1
					else if (sOp.CompareNoCase(_T("a4afsamecat")) == 0)
d1729 1
a1729 1
					else if (sOp.CompareNoCase(_T("autoa4af")) == 0)
d1731 1
a1731 1
					else if (sOp.CompareNoCase(_T("noautoa4af")) == 0)
d1733 9
a1741 1
					else if (sOp.CompareNoCase(_T("stop")) == 0)
d1743 1
a1743 1
					else if (sOp.CompareNoCase(_T("pause")) == 0)
d1745 1
a1745 1
					else if (sOp.CompareNoCase(_T("resume")) == 0)
d1747 1
a1747 1
					else if (sOp.CompareNoCase(_T("cancel")) == 0)
d1752 1
a1752 1
					else if (sOp.CompareNoCase(_T("getflc")) == 0)
d1754 1
a1754 1
					else if (sOp.CompareNoCase(_T("rename")) == 0)
d1756 2
a1757 3
						CString	sNewName(_ParseURL(Data.sURL, _T("name")));

						g_App.m_pMDlg->SendMessage(WEB_FILE_RENAME, (WPARAM)pFile, (LPARAM)(LPCTSTR)sNewName);
d1759 1
a1759 1
					else if (sOp.CompareNoCase(_T("priolow")) == 0)
d1764 1
a1764 1
					else if (sOp.CompareNoCase(_T("prionormal")) == 0)
d1769 1
a1769 1
					else if (sOp.CompareNoCase(_T("priohigh")) == 0)
d1774 1
a1774 1
					else if (sOp.CompareNoCase(_T("prioauto")) == 0)
d1779 1
a1779 1
					else if (sOp.CompareNoCase(_T("setcat")) == 0)
d2587 1
a2587 1
		if (pFileArr[i].sFileHash == _ParseURL(Data.sURL,_T("file")) )
d3167 1
a3167 1
		else if (strSort == "size")
d3169 1
a3169 1
		else if (strSort == "transferred")
d3171 1
a3171 1
		else if (strSort == "alltimetransferred")
d3173 1
a3173 1
		else if (strSort == "requests")
d3175 1
a3175 1
		else if (strSort == "alltimerequests")
d3177 1
a3177 1
		else if (strSort == "accepts")
d3179 1
a3179 1
		else if (strSort == "alltimeaccepts")
d3181 1
a3181 1
		else if (strSort == "completes")
d3183 1
a3183 1
		else if (strSort == "priority")
d3190 1
a3190 1
		m_Params.bSharedSortReverse = (strTmp == "true");
d3241 2
a3242 1
		if (_ParseURL(Data.sURL, _T("jumpstart")) == _T("true"))
d3244 1
a3244 1
		else if (_ParseURL(Data.sURL, _T("jumpstart")) == _T("false"))
@


1.406
log
@zlib types were removed from class definition.
@
text
@d697 1
a697 1
	EMULE_CATCH
d3292 6
a3297 6
		CString strResultLog = _SpecialChars(g_App.m_pMDlg->m_strLogText);	//Pick-up last line of the log
		strResultLog = strResultLog.TrimRight('\n');
		int iStringIndex = strResultLog.ReverseFind('\n');
		if (iStringIndex != -1)
			strResultLog = strResultLog.Mid(iStringIndex);
		Out.Replace(_T("[Message]"), strResultLog);
d3757 1
a3757 1
	if (!IsSessionAdmin(Data,sSession))
d3760 1
a3760 1
	CString	Out(m_Templates.sAddServerBox);
d3762 1
a3762 1
	if(_ParseURL(Data.sURL, _T("addserver")) == "true")
d3764 4
a3767 1
		if (!_ParseURL(Data.sURL, _T("serveraddr")).IsEmpty() && !_ParseURL(Data.sURL, _T("serverport")).IsEmpty())
d3769 1
a3769 2
			g_App.m_pMDlg->m_wndServer.AddServer(_ParseURL(Data.sURL, _T("serveraddr")),_ParseURL(Data.sURL, _T("serverport")),_ParseURL(Data.sURL, _T("servername")));
			CString resultlog = _SpecialChars(g_App.m_pMDlg->m_strLogText); //Pick-up last line of the log
d3771 6
a3776 2
			CServer* server = g_App.m_pServerList->GetServerByAddress(_ParseURL(Data.sURL, _T("serveraddr")), _tstoi(_ParseURL(Data.sURL, _T("serverport"))));
			if (_ParseURL(Data.sURL, _T("priority")) == _T("low"))
d3778 1
a3778 1
			else if (_ParseURL(Data.sURL, _T("priority")) == _T("normal"))
d3780 1
a3780 1
			else if (_ParseURL(Data.sURL, _T("priority")) == _T("high"))
d3787 3
a3789 3
				_AddToStatic(_ParseURL(Data.sURL, _T("serveraddr")), static_cast<uint16>(_tstoi(_ParseURL(Data.sURL, _T("serverport")))));
				resultlog += _T("<br />");
				resultlog += _SpecialChars(g_App.m_pMDlg->m_strLogText); //Pick-up last line of the log
d3791 3
a3793 3
			resultlog = resultlog.TrimRight(_T('\n'));
			resultlog = resultlog.Mid(resultlog.ReverseFind(_T('\n')));
			Out.Replace(_T("[Message]"), resultlog);
d3795 1
a3795 1
				_ConnectToServer(_ParseURL(Data.sURL, _T("serveraddr")), static_cast<uint16>(_tstoi(_ParseURL(Data.sURL, _T("serverport")))));
d3803 4
a3806 4
		CString resultlog = _SpecialChars(g_App.m_pMDlg->m_strLogText);
		resultlog = resultlog.TrimRight(_T('\n'));
		resultlog = resultlog.Mid(resultlog.ReverseFind(_T('\n')));
		Out.Replace(_T("[Message]"),resultlog);
d3824 6
a3829 2
	Out.Replace(_T("[URL_Disconnect]"), IsSessionAdmin(Data,sSession)?CString(_T("/?ses=") + sSession + _T("&amp;w=server&amp;c=disconnect&amp;cat=") + sCat):GetPermissionDenied());
	Out.Replace(_T("[URL_Connect]"), IsSessionAdmin(Data,sSession)?CString(_T("/?ses=") + sSession + _T("&amp;w=server&amp;c=connect&amp;cat=") + sCat):GetPermissionDenied());
a4307 5
CString CWebServer::GetPermissionDenied()
{
	return _T("javascript:alert(\'")+_GetPlainResString(IDS_ACCESSDENIED)+_T("\')");
}

@


1.405
log
@fix compilation warnings under VC2005
@
text
@d552 1
a552 1
	long	gzipLen=0;
d659 3
a661 3
			uLongf destLen = Out.GetLength() + 1024;
			gzipOut = new TCHAR[destLen];
			if(_GzipCompress((Bytef*)gzipOut, &destLen, (const Bytef*)(TCHAR*)Out.GetBuffer(0), Out.GetLength(), Z_DEFAULT_COMPRESSION) == Z_OK)
d664 1
a664 1
				gzipLen = destLen;
d680 1
a680 1
	AddDebugLogLine(_T("WebServer: request prepared (Sz=%u)"), (!isUseGzip) ? Out.GetLength() : gzipLen);
d686 1
a686 1
		Data.pSocket->SendContent(HTTPInit "Content-Encoding: gzip\r\n", gzipOut, gzipLen);
d4160 1
a4160 1
int CWebServer::_GzipCompress(Bytef *dest, uLongf *destLen, const Bytef *source, uLong sourceLen, int level)
d4178 1
a4178 1
	sprintf((char*)dest , "%c%c%c%c%c%c%c%c%c%c", gz_magic[0], gz_magic[1],
d4181 4
a4184 4
	stream.next_in = (Bytef*) source ;
	stream.avail_in = (uInt)sourceLen;
	stream.next_out = ((Bytef*) dest) + 10;
	stream.avail_out = *destLen - 18;
d4193 1
a4193 1
	crc = crc32(crc, (const Bytef *) source ,  sourceLen );
d4195 4
a4198 4
	*(((Bytef*) dest)+10+stream.total_out) = (Bytef)(crc & 0xFF);
	*(((Bytef*) dest)+10+stream.total_out+1) = (Bytef)((crc>>8) & 0xFF);
	*(((Bytef*) dest)+10+stream.total_out+2) = (Bytef)((crc>>16) & 0xFF);
	*(((Bytef*) dest)+10+stream.total_out+3) = (Bytef)((crc>>24) & 0xFF);
d4200 6
a4205 6
	*(((Bytef*) dest)+10+stream.total_out+4) = (Bytef)( sourceLen  & 0xFF);
	*(((Bytef*) dest)+10+stream.total_out+5) = (Bytef)(( sourceLen >>8) & 0xFF);
	*(((Bytef*) dest)+10+stream.total_out+6) = (Bytef)(( sourceLen >>16) &	0xFF);
	*(((Bytef*) dest)+10+stream.total_out+7) = (Bytef)(( sourceLen >>24) &	0xFF);
	// return  destLength
	*destLen = 10 + stream.total_out + 8;
@


1.404
log
@Fixed rare crash while processing client lists (score access when pClient->m_pCredits = NULL) {ompz};
Optimized score calculation and higher score status detection.
@
text
@d472 1
a472 1
		struct tm*	ptm;
d481 2
a482 2
			if ( ((ptm = timeFileMod.GetGmtTm()) != NULL) &&
				(strftime(acGMT, maxTimeBufferSize, "%a, %d %b %Y %H:%M:%S GMT", ptm) != 0) )
d511 2
a512 2
		if ( ((ptm = t.GetGmtTm()) != NULL) &&
			(strftime(acGMT, maxTimeBufferSize, "%a, %d %b %Y %H:%M:%S GMT", ptm) != 0) )
@


1.403
log
@Don't calculate score for downloading sources.
@
text
@d2355 1
d2366 1
a2366 1
		else if (cur_client->m_pCredits->GetScoreRatio(cur_client->GetIP()) > 1)
d2456 2
a2457 1
		bool bSecure = (cur_client->m_pCredits->GetCurrentIdentState(cur_client->GetIP()) == IS_IDENTIFIED);
d2472 1
a2472 1
		else if (cur_client->m_pCredits->GetScoreRatio(cur_client->GetIP()) > 1)
@


1.402
log
@Fixed recently introduced WebServer session disconnection (after 5 minutes) {DonGato};
Slightly improved string processing; Disabled extra debug logging.
@
text
@d2505 1
a2505 1
		if ((dUser.dwScore = cur_client->GetScore(false)) > dwNextScore)
@


1.401
log
@Renamed APP_STATE_SHUTINGDOWN -> APP_STATE_SHUTTINGDOWN.
@
text
@d568 1
a568 1
#if 1
d679 1
a679 1
#if 1
d690 1
a690 1
#if 1
d4258 1
a4258 1
bool CWebServer::GetSessionByID(const ThreadData &Data, Session *ses, long sessionID)
d4262 1
a4262 1
	if (sessionID != 0)
d4266 1
a4266 1
			if (Sessions[i].lSession == sessionID)
d4268 2
d4807 4
a4810 6
	if (!_ParseURL(Data.sURL, _T("ses")).IsEmpty())
	{
	// if Session found, reset expiration time
		if (GetSessionByID(Data, ses, _tstol(_ParseURL(Data.sURL, _T("ses")))))
			ses->startTime = CTime::GetCurrentTime();
	}
d4817 2
a4818 2
			CString	t_ulCurIP;
			t_ulCurIP.Format(_T("%u.%u.%u.%u"),(byte)m_ulCurIP,(byte)(m_ulCurIP>>8),(byte)(m_ulCurIP>>16),(byte)(m_ulCurIP>>24));
d4826 1
a4826 1
				AddLogLine(true, RGB_LOG_NOTICE + GetResString(IDS_WEB_ADMINLOGIN), t_ulCurIP);
d4835 1
a4835 1
				AddLogLine(true, RGB_LOG_NOTICE + GetResString(IDS_WEB_GUESTLOGIN), t_ulCurIP);
d4841 1
a4841 1
				AddLogLine(true, RGB_LOG_NOTICE + GetResString(IDS_WEB_INTRTRIESLEFT), t_ulCurIP, g_App.m_pPrefs->GetWSLoginAttemptsAllowed()-(m_nIntruderDetect));
@


1.400
log
@WebServer: usage of <br /> tag.
@
text
@d584 1
a584 1
			g_App.m_app_state = g_App.APP_STATE_SHUTINGDOWN;
@


1.399
log
@Large file size support preparations.
@
text
@d1 16
d2350 1
a2350 1
		dUser.sFileInfo.Replace(_T("\n"), _T("<br>"));
d2654 1
a2654 1
		sTooltip.Replace(_T("\n"), _T("<br>"));
d3780 1
a3780 1
				resultlog += _T("<br>");
d3851 1
a3851 1
	Out.Replace(_T("[Log]"), g_App.m_pMDlg->m_wndServer.m_pctlLogBox->GetHtml() + _T("<br><a name=\"end\"></a>"));
d3882 1
a3882 1
	Out.Replace(_T("[ServerInfo]"), g_App.m_pMDlg->m_wndServer.m_pctlServerMsgBox->GetHtml() + _T("<br><a name=\"end\"></a>"));
d3913 1
a3913 1
	Out.Replace(_T("[DebugLog]"), g_App.m_pMDlg->m_wndServer.m_pctlDebugBox->GetHtml() + _T("<br><a name=\"end\"></a>"));
d4402 1
a4402 1
		Out.AppendFormat(pThis->m_Templates.sProgressbarImgsPercent+_T("<br>"), progresscolor[10], pThis->m_Templates.iProgressbarWidth);
d4415 1
a4415 1
		Out.AppendFormat(pThis->m_Templates.sProgressbarImgsPercent+_T("<br>"),
@


1.398
log
@Source cleanup and formatting; Some refactoring ideas by Darklord.
@
text
@d4466 2
a4467 2
		g_App.m_pMDlg->m_dlgSearch.DeleteAllSearchs();
		g_App.m_pMDlg->m_dlgSearch.DoNewSearch(
d4470 2
a4471 2
			_tstol(_ParseURL(Data.sURL, _T("min")))*1048576,
			_tstol(_ParseURL(Data.sURL, _T("max")))*1048576,
@


1.397
log
@Faster plot statistics processing for WebServer and MobileMule;
Removed unused code/variables; Renamed some static methods
Improved string processing.
@
text
@a520 4
	CWebServer *pThis = (CWebServer *)Data.pThis;
	if(pThis == NULL)
		return;

d540 2
a541 6
	long lSession = 0;
	if(!_ParseURL(Data.sURL, _T("ses")).IsEmpty())
		lSession = _tstol(_ParseURL(Data.sURL, _T("ses")));

	if(pThis->GetIsTempDisabled() &&
		((dwCurTick - pThis->m_nStartTempDisabledTime) > (g_App.m_pPrefs->GetWSTempDisableLogin() * 60000)))
d543 2
a544 2
		pThis->m_bIsTempDisabled = false;
		pThis->m_nStartTempDisabledTime = 0;
d548 2
a549 60
	if ((_ParseURL(Data.sURL, _T("w")) == _T("password")) && !pThis->GetIsTempDisabled() && _ParseURL(Data.sURL, _T("c")).IsEmpty())
	{
		byte	abyteDigest[16], abyteWSPass[16];
		CString	t_ulCurIP;
		t_ulCurIP.Format(_T("%u.%u.%u.%u"),(byte)pThis->m_ulCurIP,(byte)(pThis->m_ulCurIP>>8),(byte)(pThis->m_ulCurIP>>16),(byte)(pThis->m_ulCurIP>>24));

		if (md4cmp(MD5Sum(_ParseURL(Data.sURL, _T("p")), abyteDigest), g_App.m_pPrefs->GetWSPass(abyteWSPass)) == 0)
		{
			Session ses;
			ses.admin=true;
			ses.startTime = CTime::GetCurrentTime();
			ses.lSession = lSession = ((rand() << 15) | rand()) + 1;
			Sessions.Add(ses);
			AddLogLine(true, RGB_LOG_NOTICE + GetResString(IDS_WEB_ADMINLOGIN), t_ulCurIP);
			pThis->m_nIntruderDetect = 0;
		}
		else if ( g_App.m_pPrefs->GetWSIsLowUserEnabled() &&
			(md4cmp(abyteDigest, g_App.m_pPrefs->GetWSLowPass(abyteWSPass)) == 0) )
		{
			Session ses;
			ses.admin=false;
			ses.startTime = CTime::GetCurrentTime();
			ses.lSession = lSession = ((rand() << 15) | rand()) + 1;
			Sessions.Add(ses);
			AddLogLine(true, RGB_LOG_NOTICE + GetResString(IDS_WEB_GUESTLOGIN), t_ulCurIP);
			pThis->m_nIntruderDetect = 0;
		}
		else if(g_App.m_pPrefs->IsWSIntruderDetectionEnabled())
		{
			pThis->m_nIntruderDetect++;
			AddLogLine(true, RGB_LOG_NOTICE + GetResString(IDS_WEB_INTRTRIESLEFT), t_ulCurIP, g_App.m_pPrefs->GetWSLoginAttemptsAllowed()-(pThis->m_nIntruderDetect));
			if (pThis->m_nIntruderDetect == g_App.m_pPrefs->GetWSLoginAttemptsAllowed())
			{
				CString MessageText;

				AddLogLine(true, RGB_LOG_NOTICE + GetResString(IDS_WEB_INTRDETECTION), pThis->m_nIntruderDetect);
				if (g_App.m_pPrefs->GetWSTempDisableLogin() > 0)
				{
					pThis->m_nStartTempDisabledTime = dwCurTick;
					pThis->m_bIsTempDisabled = true;
					pThis->AddLogLine(true, RGB_LOG_NOTICE + GetResString(IDS_WEB_INTRBLOCKTIME), g_App.m_pPrefs->GetWSTempDisableLogin());
					pThis->m_nIntruderDetect = 0;
					MessageText.Format(GetResString(IDS_WEB_INTRBLOCKTIME), g_App.m_pPrefs->GetWSTempDisableLogin());
				}
				else
				{
					g_App.m_pPrefs->SetWSIsEnabled(false);
					pThis->m_bServerWorking = false;
					StopSockets();
					AddLogLine(true, RGB_LOG_NOTICE + GetResString(IDS_WEB_INTRWEBDISABLE));
					pThis->m_nIntruderDetect = 0;
					GetResString(&MessageText, IDS_WEB_INTRWEBDISABLE);
				}
				g_App.m_pMDlg->SendMail(MessageText, g_App.m_pPrefs->GetNotifierPopOnWebServerError(), g_App.m_pPrefs->IsSMTPWarningEnabled());
				g_App.m_pMDlg->ShowNotifier(MessageText, TBN_WEBSERVER, false, g_App.m_pPrefs->GetNotifierPopOnWebServerError());
			}
		}
		else
			AddLogLine(true, RGB_LOG_NOTICE + GetResString(IDS_WEB_BADLOGINATTEMPT));
	}
a770 4
	CWebServer *pThis = (CWebServer *)Data.pThis;
	if(pThis == NULL)
		return _T("");

d772 1
a772 2

	CString Out = pThis->m_Templates.sHeader;
d806 1
a806 1
	Out.Replace(_T("[StyleSheet]"), pThis->m_Templates.sHeaderStylesheet);
d828 1
a828 1
		InsertCatBox(Out, 0, pThis->m_Templates.sCatArrow, false, false, sSession, NULL);
d880 2
a881 2
		pThis->m_Params.bMenuLocked = !pThis->m_Params.bMenuLocked;
		g_App.m_pPrefs->SetWSMenuLocked(pThis->m_Params.bMenuLocked);
d883 2
a884 2
	Out.Replace(_T("[MenuLocked]"), pThis->m_Params.bMenuLocked ? _T("true") : _T("false"));
	Out.Replace(_T("[MenuLockTitle]"), _GetPlainResString(pThis->m_Params.bMenuLocked ? IDS_MENULOCK_OFF : IDS_MENULOCK_ON));
d1010 2
a1011 7
	CWebServer *pThis = (CWebServer *)Data.pThis;
	if(pThis == NULL)
		return _T("");

	byte		cat = _tstoi(_ParseURL(Data.sURL, _T("cat")));

	CString sCat;
d1109 1
a1109 1
			pThis->m_Params.ServerSort = SERVER_SORT_STATE;
d1112 1
a1112 1
			pThis->m_Params.ServerSort = SERVER_SORT_NAME;
d1116 1
a1116 1
			pThis->m_Params.ServerSort = SERVER_SORT_IP;
d1119 1
a1119 1
			pThis->m_Params.ServerSort = SERVER_SORT_DESCRIPTION;
d1123 1
a1123 1
			pThis->m_Params.ServerSort = SERVER_SORT_PING;
d1125 1
a1125 1
			pThis->m_Params.ServerSort = SERVER_SORT_USERS;
d1127 1
a1127 1
			pThis->m_Params.ServerSort = SERVER_SORT_FILES;
d1129 1
a1129 1
			pThis->m_Params.ServerSort = SERVER_SORT_PRIORITY;
d1131 1
a1131 1
			pThis->m_Params.ServerSort = SERVER_SORT_FAILED;
d1133 1
a1133 1
			pThis->m_Params.ServerSort = SERVER_SORT_LIMIT;
d1135 1
a1135 1
			pThis->m_Params.ServerSort = SERVER_SORT_VERSION;
d1138 1
a1138 1
			pThis->m_Params.bServerSortReverse = bDirection;
d1141 1
a1141 1
		pThis->m_Params.bServerSortReverse = (strTmp == "true");
d1143 1
a1143 1
	CString Out = pThis->m_Templates.sServerList;
d1149 1
a1149 1
	const TCHAR *pcTmp = (pThis->m_Params.bServerSortReverse) ? _T("&amp;sortreverse=false") : _T("&amp;sortreverse=true");
d1151 11
a1161 11
	Out.Replace(_T("[SortState]"), (pThis->m_Params.ServerSort == SERVER_SORT_STATE) ? pcTmp : _T(""));
	Out.Replace(_T("[SortName]"), (pThis->m_Params.ServerSort == SERVER_SORT_NAME) ? pcTmp : _T(""));
	Out.Replace(_T("[SortIP]"), (pThis->m_Params.ServerSort == SERVER_SORT_IP) ? pcTmp : _T(""));
	Out.Replace(_T("[SortDescription]"), (pThis->m_Params.ServerSort == SERVER_SORT_DESCRIPTION) ? pcTmp : _T(""));
	Out.Replace(_T("[SortPing]"), (pThis->m_Params.ServerSort == SERVER_SORT_PING) ? pcTmp : _T(""));
	Out.Replace(_T("[SortUsers]"), (pThis->m_Params.ServerSort == SERVER_SORT_USERS) ? pcTmp : _T(""));
	Out.Replace(_T("[SortFiles]"), (pThis->m_Params.ServerSort == SERVER_SORT_FILES) ? pcTmp : _T(""));
	Out.Replace(_T("[SortPriority]"), (pThis->m_Params.ServerSort == SERVER_SORT_PRIORITY) ? pcTmp : _T(""));
	Out.Replace(_T("[SortFailed]"), (pThis->m_Params.ServerSort == SERVER_SORT_FAILED) ? pcTmp : _T(""));
	Out.Replace(_T("[SortLimit]"), (pThis->m_Params.ServerSort == SERVER_SORT_LIMIT) ? pcTmp : _T(""));
	Out.Replace(_T("[SortVersion]"), (pThis->m_Params.ServerSort == SERVER_SORT_VERSION) ? pcTmp : _T(""));
d1164 1
a1164 1
	const TCHAR *pcSortIcon = (pThis->m_Params.bServerSortReverse) ? pThis->m_Templates.sUpArrow : pThis->m_Templates.sDownArrow;
d1169 1
a1169 1
		Out.Replace(_T("[ServernameI]"), (pThis->m_Params.ServerSort == SERVER_SORT_NAME) ? pcSortIcon : _T(""));
d1182 1
a1182 1
		Out.Replace(_T("[AddressI]"), (pThis->m_Params.ServerSort == SERVER_SORT_IP) ? pcSortIcon : _T(""));
d1195 1
a1195 1
		Out.Replace(_T("[DescriptionI]"), (pThis->m_Params.ServerSort == SERVER_SORT_DESCRIPTION) ? pcSortIcon : _T(""));
d1208 1
a1208 1
		Out.Replace(_T("[PingI]"), (pThis->m_Params.ServerSort == SERVER_SORT_PING) ? pcSortIcon : _T(""));
d1221 1
a1221 1
		Out.Replace(_T("[UsersI]"), (pThis->m_Params.ServerSort == SERVER_SORT_USERS) ? pcSortIcon : _T(""));
d1234 1
a1234 1
		Out.Replace(_T("[FilesI]"), (pThis->m_Params.ServerSort == SERVER_SORT_FILES) ? pcSortIcon : _T(""));
d1247 1
a1247 1
		Out.Replace(_T("[PriorityI]"), (pThis->m_Params.ServerSort == SERVER_SORT_PRIORITY) ? pcSortIcon : _T(""));
d1260 1
a1260 1
		Out.Replace(_T("[FailedI]"), (pThis->m_Params.ServerSort == SERVER_SORT_FAILED) ? pcSortIcon : _T(""));
d1273 1
a1273 1
		Out.Replace(_T("[LimitI]"), (pThis->m_Params.ServerSort == SERVER_SORT_LIMIT) ? pcSortIcon : _T(""));
d1286 1
a1286 1
		Out.Replace(_T("[VersionI]"), (pThis->m_Params.ServerSort == SERVER_SORT_VERSION) ? pcSortIcon : _T(""));
d1382 1
a1382 1
			switch(pThis->m_Params.ServerSort)
d1418 1
a1418 1
			if(pThis->m_Params.bServerSortReverse)
d1433 1
a1433 1
	CString OutE = pThis->m_Templates.sServerLine;
a1582 4
	CWebServer *pThis = (CWebServer *)Data.pThis;
	if(pThis == NULL)
		return _T("");

d1791 1
a1791 1
			pThis->m_Params.DownloadSort = DOWN_SORT_STATE;
d1793 1
a1793 1
			pThis->m_Params.DownloadSort = DOWN_SORT_TYPE;
d1796 1
a1796 1
			pThis->m_Params.DownloadSort = DOWN_SORT_NAME;
d1800 1
a1800 1
			pThis->m_Params.DownloadSort = DOWN_SORT_SIZE;
d1802 1
a1802 1
			pThis->m_Params.DownloadSort = DOWN_SORT_TRANSFERRED;
d1804 1
a1804 1
			pThis->m_Params.DownloadSort = DOWN_SORT_SPEED;
d1806 1
a1806 1
			pThis->m_Params.DownloadSort = DOWN_SORT_PROGRESS;
d1808 1
a1808 1
			pThis->m_Params.DownloadSort = DOWN_SORT_SOURCES;
d1810 1
a1810 1
			pThis->m_Params.DownloadSort = DOWN_SORT_PRIORITY;
d1813 1
a1813 1
			pThis->m_Params.DownloadSort = DOWN_SORT_CATEGORY;
d1817 1
a1817 1
			pThis->m_Params.DownloadSort = DOWN_SORT_FAKECHECK;
d1820 1
a1820 1
			pThis->m_Params.UploadSort = UP_SORT_USER;
d1824 1
a1824 1
			pThis->m_Params.UploadSort = UP_SORT_CLIENT;
d1826 1
a1826 1
			pThis->m_Params.UploadSort = UP_SORT_VERSION;
d1829 1
a1829 1
			pThis->m_Params.UploadSort = UP_SORT_FILENAME;
d1833 1
a1833 1
			pThis->m_Params.UploadSort = UP_SORT_TRANSFERRED;
d1835 1
a1835 1
			pThis->m_Params.UploadSort = UP_SORT_SPEED;
d1837 1
a1837 1
			pThis->m_Params.QueueSort = QU_SORT_CLIENT;
d1840 1
a1840 1
			pThis->m_Params.QueueSort = QU_SORT_USER;
d1844 1
a1844 1
			pThis->m_Params.QueueSort = QU_SORT_VERSION;
d1847 1
a1847 1
			pThis->m_Params.QueueSort = QU_SORT_FILENAME;
d1851 1
a1851 1
			pThis->m_Params.QueueSort = QU_SORT_SCORE;
d1856 1
a1856 1
				pThis->m_Params.bDownloadSortReverse = bDirection;
d1858 1
a1858 1
				pThis->m_Params.bUploadSortReverse = bDirection;
d1860 1
a1860 1
				pThis->m_Params.bQueueSortReverse = bDirection;
d1868 1
a1868 1
			pThis->m_Params.bDownloadSortReverse = bDirection;
d1870 1
a1870 1
			pThis->m_Params.bUploadSortReverse = bDirection;
d1872 1
a1872 1
			pThis->m_Params.bQueueSortReverse = bDirection;
d1877 1
a1877 1
		pThis->m_Params.bShowUploadQueue = true;
d1879 1
a1879 1
		pThis->m_Params.bShowUploadQueue = false;
d1883 1
a1883 1
		pThis->m_Params.bShowUploadQueueBanned = true;
d1885 1
a1885 1
		pThis->m_Params.bShowUploadQueueBanned = false;
d1889 1
a1889 1
		pThis->m_Params.bShowUploadQueueFriend = true;
d1891 1
a1891 1
		pThis->m_Params.bShowUploadQueueFriend = false;
d1895 1
a1895 1
		pThis->m_Params.bShowUploadQueueCredit = true;
d1897 1
a1897 1
		pThis->m_Params.bShowUploadQueueCredit = false;
d1899 6
a1904 6
	Out += pThis->m_Templates.sTransferImages;
	Out += pThis->m_Templates.sTransferList;
	Out.Replace(_T("[DownloadHeader]"), pThis->m_Templates.sTransferDownHeader);
	Out.Replace(_T("[DownloadFooter]"), pThis->m_Templates.sTransferDownFooter);
	Out.Replace(_T("[UploadHeader]"), pThis->m_Templates.sTransferUpHeader);
	Out.Replace(_T("[UploadFooter]"), pThis->m_Templates.sTransferUpFooter);
d1909 1
a1909 1
	const TCHAR	*pcTmp = (pThis->m_Params.bDownloadSortReverse) ? _T("&amp;sortreverse=false") : _T("&amp;sortreverse=true");
d1911 20
a1930 20
	Out.Replace(_T("[SortDState]"), (pThis->m_Params.DownloadSort == DOWN_SORT_STATE) ? pcTmp : _T(""));
	Out.Replace(_T("[SortDType]"), (pThis->m_Params.DownloadSort == DOWN_SORT_TYPE) ? pcTmp : _T(""));
	Out.Replace(_T("[SortDName]"), (pThis->m_Params.DownloadSort == DOWN_SORT_NAME) ? pcTmp : _T(""));
	Out.Replace(_T("[SortDSize]"), (pThis->m_Params.DownloadSort == DOWN_SORT_SIZE) ? pcTmp : _T(""));
	Out.Replace(_T("[SortDTransferred]"), (pThis->m_Params.DownloadSort == DOWN_SORT_TRANSFERRED) ? pcTmp : _T(""));
	Out.Replace(_T("[SortDSpeed]"), (pThis->m_Params.DownloadSort == DOWN_SORT_SPEED) ? pcTmp : _T(""));
	Out.Replace(_T("[SortDProgress]"), (pThis->m_Params.DownloadSort == DOWN_SORT_PROGRESS) ? pcTmp : _T(""));
	Out.Replace(_T("[SortDSources]"), (pThis->m_Params.DownloadSort == DOWN_SORT_SOURCES) ? pcTmp : _T(""));
	Out.Replace(_T("[SortDPriority]"), (pThis->m_Params.DownloadSort == DOWN_SORT_PRIORITY) ? pcTmp : _T(""));
	Out.Replace(_T("[SortDCategory]"), (pThis->m_Params.DownloadSort == DOWN_SORT_CATEGORY) ? pcTmp : _T(""));
	Out.Replace(_T("[SortDFakeCheck]"), (pThis->m_Params.DownloadSort == DOWN_SORT_FAKECHECK) ? pcTmp : _T(""));

	pcTmp = (pThis->m_Params.bUploadSortReverse) ? _T("&amp;sortreverse=false") : _T("&amp;sortreverse=true");

	Out.Replace(_T("[SortUClient]"), (pThis->m_Params.UploadSort == UP_SORT_CLIENT) ? pcTmp : _T(""));
	Out.Replace(_T("[SortUUser]"), (pThis->m_Params.UploadSort == UP_SORT_USER) ? pcTmp : _T(""));
	Out.Replace(_T("[SortUVersion]"), (pThis->m_Params.UploadSort == UP_SORT_VERSION) ? pcTmp : _T(""));
	Out.Replace(_T("[SortUFilename]"), (pThis->m_Params.UploadSort == UP_SORT_FILENAME) ? pcTmp : _T(""));
	Out.Replace(_T("[SortUTransferred]"), (pThis->m_Params.UploadSort == UP_SORT_TRANSFERRED) ? pcTmp : _T(""));
	Out.Replace(_T("[SortUSpeed]"), (pThis->m_Params.UploadSort == UP_SORT_SPEED) ? pcTmp : _T(""));
d1932 1
a1932 1
	const TCHAR *pcSortIcon = (pThis->m_Params.bDownloadSortReverse) ? pThis->m_Templates.sUpArrow : pThis->m_Templates.sDownArrow;
d1937 1
a1937 1
		Out.Replace(_T("[DFilenameI]"), (pThis->m_Params.DownloadSort == DOWN_SORT_NAME) ? pcSortIcon : _T(""));
d1950 1
a1950 1
		Out.Replace(_T("[DSizeI]"), (pThis->m_Params.DownloadSort == DOWN_SORT_SIZE) ? pcSortIcon : _T(""));
d1963 1
a1963 1
		Out.Replace(_T("[DTransferredI]"), (pThis->m_Params.DownloadSort == DOWN_SORT_TRANSFERRED) ? pcSortIcon : _T(""));
d1976 1
a1976 1
		Out.Replace(_T("[DProgressI]"), (pThis->m_Params.DownloadSort == DOWN_SORT_PROGRESS) ? pcSortIcon : _T(""));
d1989 1
a1989 1
		Out.Replace(_T("[DSpeedI]"), (pThis->m_Params.DownloadSort == DOWN_SORT_SPEED) ? pcSortIcon : _T(""));
d2002 1
a2002 1
		Out.Replace(_T("[DSourcesI]"), (pThis->m_Params.DownloadSort == DOWN_SORT_SOURCES) ? pcSortIcon : _T(""));
d2015 1
a2015 1
		Out.Replace(_T("[DPriorityI]"), (pThis->m_Params.DownloadSort == DOWN_SORT_PRIORITY) ? pcSortIcon : _T(""));
d2028 1
a2028 1
		Out.Replace(_T("[DCategoryI]"), (pThis->m_Params.DownloadSort == DOWN_SORT_CATEGORY) ? pcSortIcon : _T(""));
d2041 1
a2041 1
		Out.Replace(_T("[DFakeCheckI]"), (pThis->m_Params.DownloadSort == DOWN_SORT_FAKECHECK) ? pcSortIcon : _T(""));
d2051 1
a2051 1
	pcSortIcon = (pThis->m_Params.bUploadSortReverse) ? pThis->m_Templates.sUpArrow : pThis->m_Templates.sDownArrow;
d2056 1
a2056 1
		Out.Replace(_T("[UUserI]"), (pThis->m_Params.UploadSort == UP_SORT_USER) ? pcSortIcon : _T(""));
d2069 1
a2069 1
		Out.Replace(_T("[UVersionI]"), (pThis->m_Params.UploadSort == UP_SORT_VERSION) ? pcSortIcon : _T(""));
d2082 1
a2082 1
		Out.Replace(_T("[UFilenameI]"), (pThis->m_Params.UploadSort == UP_SORT_FILENAME) ? pcSortIcon : _T(""));
d2095 1
a2095 1
		Out.Replace(_T("[UTransferredI]"), (pThis->m_Params.UploadSort == UP_SORT_TRANSFERRED) ? pcSortIcon : _T(""));
d2108 1
a2108 1
		Out.Replace(_T("[USpeedI]"), (pThis->m_Params.UploadSort == UP_SORT_SPEED) ? pcSortIcon : _T(""));
d2259 1
a2259 1
				switch(pThis->m_Params.DownloadSort)
d2298 1
a2298 1
				if(pThis->m_Params.bDownloadSortReverse)
d2389 1
a2389 1
			switch(pThis->m_Params.UploadSort)
d2410 1
a2410 1
			if(pThis->m_Params.bUploadSortReverse)
d2504 1
a2504 1
		switch(pThis->m_Params.QueueSort)
d2534 4
a2537 4
	if ((nCountQueue > 0 &&	pThis->m_Params.bShowUploadQueue) ||
		(nCountQueueBanned > 0 && pThis->m_Params.bShowUploadQueueBanned) ||
		(nCountQueueFriend > 0 && pThis->m_Params.bShowUploadQueueFriend) ||
		(nCountQueueCredit > 0 && pThis->m_Params.bShowUploadQueueCredit))
d2542 1
a2542 1
	QueueArray.QuickSort(pThis->m_Params.bQueueSortReverse);
d2550 1
a2550 1
	CString	OutE = pThis->m_Templates.sTransferDownLine;
d2766 1
a2766 1
	strTmp.Format(_T("%i"), pThis->m_Templates.iProgressbarWidth);
d2775 1
a2775 1
	OutE = pThis->m_Templates.sTransferUpLine;
d2826 1
a2826 1
	if(pThis->m_Params.bShowUploadQueue)
d2828 1
a2828 1
		Out.Replace(_T("[UploadQueue]"), pThis->m_Templates.sTransferUpQueueShow);
d2833 1
a2833 1
		OutE = pThis->m_Templates.sTransferUpQueueLine;
d2871 1
a2871 1
		Out.Replace(_T("[UploadQueue]"), pThis->m_Templates.sTransferUpQueueHide);
d2873 1
a2873 1
	if(pThis->m_Params.bShowUploadQueueBanned)
d2875 1
a2875 1
		Out.Replace(_T("[UploadQueueBanned]"), pThis->m_Templates.sTransferUpQueueBannedShow);
d2880 1
a2880 1
		OutE = pThis->m_Templates.sTransferUpQueueBannedLine;
d2919 1
a2919 1
		Out.Replace(_T("[UploadQueueBanned]"), pThis->m_Templates.sTransferUpQueueBannedHide);
d2921 1
a2921 1
	if(pThis->m_Params.bShowUploadQueueFriend)
d2923 1
a2923 1
		Out.Replace(_T("[UploadQueueFriend]"), pThis->m_Templates.sTransferUpQueueFriendShow);
d2928 1
a2928 1
		OutE = pThis->m_Templates.sTransferUpQueueFriendLine;
d2967 1
a2967 1
		Out.Replace(_T("[UploadQueueFriend]"), pThis->m_Templates.sTransferUpQueueFriendHide);
d2969 1
a2969 1
	if(pThis->m_Params.bShowUploadQueueCredit)
d2971 1
a2971 1
		Out.Replace(_T("[UploadQueueCredit]"), pThis->m_Templates.sTransferUpQueueCreditShow);
d2976 1
a2976 1
		OutE = pThis->m_Templates.sTransferUpQueueCreditLine;
d3015 1
a3015 1
		Out.Replace(_T("[UploadQueueCredit]"), pThis->m_Templates.sTransferUpQueueCreditHide);
d3045 1
a3045 1
	pcTmp = (pThis->m_Params.bQueueSortReverse) ? _T("&amp;sortreverse=false") : _T("&amp;sortreverse=true");
d3047 5
a3051 5
	Out.Replace(_T("[SortQClient]"), (pThis->m_Params.QueueSort == QU_SORT_CLIENT) ? pcTmp : _T(""));
	Out.Replace(_T("[SortQUser]"), (pThis->m_Params.QueueSort == QU_SORT_USER) ? pcTmp : _T(""));
	Out.Replace(_T("[SortQVersion]"), (pThis->m_Params.QueueSort == QU_SORT_VERSION) ? pcTmp : _T(""));
	Out.Replace(_T("[SortQFilename]"), (pThis->m_Params.QueueSort == QU_SORT_FILENAME) ? pcTmp : _T(""));
	Out.Replace(_T("[SortQScore]"), (pThis->m_Params.QueueSort == QU_SORT_SCORE) ? pcTmp : _T(""));
d3053 1
a3053 1
	pcSortIcon = (pThis->m_Params.bQueueSortReverse) ? pThis->m_Templates.sUpArrow : pThis->m_Templates.sDownArrow;
d3058 1
a3058 1
		Out.Replace(_T("[UserNameTitleI]"), (pThis->m_Params.QueueSort == QU_SORT_USER) ? pcSortIcon : _T(""));
d3071 1
a3071 1
		Out.Replace(_T("[VersionI]"), (pThis->m_Params.QueueSort == QU_SORT_VERSION) ? pcSortIcon : _T(""));
d3084 1
a3084 1
		Out.Replace(_T("[FileNameTitleI]"), (pThis->m_Params.QueueSort == QU_SORT_FILENAME) ? pcSortIcon : _T(""));
d3097 1
a3097 1
		Out.Replace(_T("[ScoreTitleI]"), (pThis->m_Params.QueueSort == QU_SORT_SCORE) ? pcSortIcon : _T(""));
a3116 4
	CWebServer *pThis = (CWebServer *)Data.pThis;
	if(pThis == NULL)
		return _T("");

d3133 1
a3133 1
			pThis->m_Params.SharedSort = SHARED_SORT_STATE;
d3135 1
a3135 1
			pThis->m_Params.SharedSort = SHARED_SORT_TYPE;
d3138 1
a3138 1
			pThis->m_Params.SharedSort = SHARED_SORT_NAME;
d3142 1
a3142 1
			pThis->m_Params.SharedSort = SHARED_SORT_SIZE;
d3144 1
a3144 1
			pThis->m_Params.SharedSort = SHARED_SORT_TRANSFERRED;
d3146 1
a3146 1
			pThis->m_Params.SharedSort = SHARED_SORT_ALL_TIME_TRANSFERRED;
d3148 1
a3148 1
			pThis->m_Params.SharedSort = SHARED_SORT_REQUESTS;
d3150 1
a3150 1
			pThis->m_Params.SharedSort = SHARED_SORT_ALL_TIME_REQUESTS;
d3152 1
a3152 1
			pThis->m_Params.SharedSort = SHARED_SORT_ACCEPTS;
d3154 1
a3154 1
			pThis->m_Params.SharedSort = SHARED_SORT_ALL_TIME_ACCEPTS;
d3156 1
a3156 1
			pThis->m_Params.SharedSort = SHARED_SORT_COMPLETES;
d3158 1
a3158 1
			pThis->m_Params.SharedSort = SHARED_SORT_PRIORITY;
d3161 1
a3161 1
			pThis->m_Params.bSharedSortReverse = bDirection;
d3164 1
a3164 1
		pThis->m_Params.bSharedSortReverse = (strTmp == "true");
d3223 2
a3224 1
	CString Out = pThis->m_Templates.sSharedList;
d3226 6
a3231 8
	const TCHAR *pcTmp = (pThis->m_Params.bSharedSortReverse) ? _T("&amp;sortreverse=false") : _T("&amp;sortreverse=true");

	Out.Replace(_T("[SortState]"), (pThis->m_Params.SharedSort == SHARED_SORT_STATE) ? pcTmp : _T(""));
	Out.Replace(_T("[SortType]"), (pThis->m_Params.SharedSort == SHARED_SORT_TYPE) ? pcTmp : _T(""));
	Out.Replace(_T("[SortName]"), (pThis->m_Params.SharedSort == SHARED_SORT_NAME) ? pcTmp : _T(""));
	Out.Replace(_T("[SortSize]"), (pThis->m_Params.SharedSort == SHARED_SORT_SIZE) ? pcTmp : _T(""));
	Out.Replace(_T("[SortCompletes]"), (pThis->m_Params.SharedSort == SHARED_SORT_COMPLETES) ? pcTmp : _T(""));
	Out.Replace(_T("[SortPriority]"), (pThis->m_Params.SharedSort == SHARED_SORT_PRIORITY) ? pcTmp : _T(""));
d3234 1
a3234 1
	if(pThis->m_Params.SharedSort == SHARED_SORT_TRANSFERRED)
d3236 1
a3236 1
		pcTmp = (pThis->m_Params.bSharedSortReverse) ?
d3239 1
a3239 1
	else if(pThis->m_Params.SharedSort == SHARED_SORT_ALL_TIME_TRANSFERRED)
d3241 1
a3241 1
		if (!pThis->m_Params.bSharedSortReverse)
d3247 1
a3247 1
	if(pThis->m_Params.SharedSort == SHARED_SORT_REQUESTS)
d3249 1
a3249 1
		pcTmp = (pThis->m_Params.bSharedSortReverse) ?
d3252 1
a3252 1
	else if(pThis->m_Params.SharedSort == SHARED_SORT_ALL_TIME_REQUESTS)
d3254 1
a3254 1
		if (!pThis->m_Params.bSharedSortReverse)
d3260 1
a3260 1
	if(pThis->m_Params.SharedSort == SHARED_SORT_ACCEPTS)
d3262 1
a3262 1
		pcTmp = (pThis->m_Params.bSharedSortReverse) ?
d3265 1
a3265 1
	else if(pThis->m_Params.SharedSort == SHARED_SORT_ALL_TIME_ACCEPTS)
d3267 1
a3267 1
		if (!pThis->m_Params.bSharedSortReverse)
d3284 1
a3284 1
	const TCHAR *pcSortIcon = (pThis->m_Params.bSharedSortReverse) ? pThis->m_Templates.sUpArrow : pThis->m_Templates.sDownArrow;
d3290 1
a3290 1
		Out.Replace(_T("[FilenameI]"), (pThis->m_Params.SharedSort == SHARED_SORT_NAME) ? pcSortIcon : _T(""));
d3303 3
a3305 3
		pcIconTmp = (pThis->m_Params.SharedSort == SHARED_SORT_TRANSFERRED) ? pcSortIcon : _T("");
		if (pThis->m_Params.SharedSort == SHARED_SORT_ALL_TIME_TRANSFERRED)
			pcIconTmp = (pThis->m_Params.bSharedSortReverse) ? pThis->m_Templates.strUpDoubleArrow : pThis->m_Templates.strDownDoubleArrow;
d3319 3
a3321 3
		pcIconTmp = (pThis->m_Params.SharedSort == SHARED_SORT_REQUESTS) ? pcSortIcon : _T("");
		if (pThis->m_Params.SharedSort == SHARED_SORT_ALL_TIME_REQUESTS)
			pcIconTmp = (pThis->m_Params.bSharedSortReverse) ? pThis->m_Templates.strUpDoubleArrow : pThis->m_Templates.strDownDoubleArrow;
d3335 3
a3337 3
		pcIconTmp = (pThis->m_Params.SharedSort == SHARED_SORT_ACCEPTS) ? pcSortIcon : _T("");
		if (pThis->m_Params.SharedSort == SHARED_SORT_ALL_TIME_ACCEPTS)
			pcIconTmp = (pThis->m_Params.bSharedSortReverse) ? pThis->m_Templates.strUpDoubleArrow : pThis->m_Templates.strDownDoubleArrow;
d3351 1
a3351 1
		Out.Replace(_T("[SizeI]"), (pThis->m_Params.SharedSort == SHARED_SORT_SIZE) ? pcSortIcon : _T(""));
d3364 1
a3364 1
		Out.Replace(_T("[CompletesI]"), (pThis->m_Params.SharedSort == SHARED_SORT_COMPLETES) ? pcSortIcon : _T(""));
d3377 1
a3377 1
		Out.Replace(_T("[PriorityI]"), (pThis->m_Params.SharedSort == SHARED_SORT_PRIORITY) ? pcSortIcon : _T(""));
d3393 2
a3394 1
	CString OutE = pThis->m_Templates.sSharedLine;
a3395 1
	CArray<SharedFiles, SharedFiles> SharedArray;
d3462 1
a3462 1
			switch(pThis->m_Params.SharedSort)
d3517 1
a3517 1
			if(pThis->m_Params.bSharedSortReverse)
d3682 1
a3682 5
	CWebServer *pThis = (CWebServer *)Data.pThis;
	if(pThis == NULL)
		return _T("");

	CString Out = pThis->m_Templates.sGraphs;
d3731 2
a3732 7
	CWebServer *pThis = (CWebServer *)Data.pThis;
	if(pThis == NULL)
		return _T("");

	byte		cat = _tstoi(_ParseURL(Data.sURL, _T("cat")));

	CString sCat;
d3742 2
a3743 1
	CString Out = pThis->m_Templates.sAddServerBox;
d3819 2
a3820 7
	CWebServer *pThis = (CWebServer *)Data.pThis;
	if(pThis == NULL)
		return _T("");

	byte		cat = _tstoi(_ParseURL(Data.sURL, _T("cat")));

	CString sCat;
d3826 1
a3826 2

	CString Out = pThis->m_Templates.sLog;
d3850 2
a3851 7
	CWebServer *pThis = (CWebServer *)Data.pThis;
	if(pThis == NULL)
		return _T("");

	byte		cat = _tstoi(_ParseURL(Data.sURL, _T("cat")));

	CString sCat;
d3857 1
a3857 2

	CString Out = pThis->m_Templates.sServerInfo;
d3881 2
a3882 7
	CWebServer *pThis = (CWebServer *)Data.pThis;
	if(pThis == NULL)
		return _T("");

	byte		cat = _tstoi(_ParseURL(Data.sURL, _T("cat")));

	CString sCat;
d3888 1
a3888 2

	CString Out = pThis->m_Templates.sDebugLog;
d3937 2
a3938 7
	CWebServer *pThis = (CWebServer *)Data.pThis;
	if(pThis == NULL)
		return _T("");

	byte		cat = _tstoi(_ParseURL(Data.sURL, _T("cat")));

	CString sCat, strTmp;
d3944 1
a3945 1
	CString Out = pThis->m_Templates.sPreferences;
d3951 1
a3951 1
			pThis->m_Params.bShowUploadQueue = true;
d3953 1
a3953 1
			pThis->m_Params.bShowUploadQueue = false;
d3955 1
a3955 1
			pThis->m_Params.bShowUploadQueueBanned = true;
d3957 1
a3957 1
			pThis->m_Params.bShowUploadQueueBanned = false;
d3959 1
a3959 1
			pThis->m_Params.bShowUploadQueueFriend = true;
d3961 1
a3961 1
			pThis->m_Params.bShowUploadQueueFriend = false;
d3963 1
a3963 1
			pThis->m_Params.bShowUploadQueueCredit = true;
d3965 1
a3965 1
			pThis->m_Params.bShowUploadQueueCredit = false;
d4007 1
a4007 1
	if(pThis->m_Params.bShowUploadQueue)
d4011 1
a4011 1
	if(pThis->m_Params.bShowUploadQueueBanned)
d4015 1
a4015 1
	if(pThis->m_Params.bShowUploadQueueFriend)
d4019 1
a4019 1
	if(pThis->m_Params.bShowUploadQueueCredit)
a4198 4
	CWebServer *pThis = (CWebServer *)Data.pThis;
	if(pThis == NULL)
		return false;

a4206 3
			{
				// if found, also reset expiration time
				Sessions[i].startTime = CTime::GetCurrentTime();
a4207 1
			}
d4242 1
a4242 1
Session CWebServer::GetSessionByID(const ThreadData &Data, long sessionID)
d4245 4
a4248 3
	CWebServer *pThis = (CWebServer *)Data.pThis;
	if(pThis != NULL) {
		for(int i = 0; i < Sessions.GetSize(); i++)
d4250 5
a4254 2
			if (Sessions[i].lSession == sessionID && sessionID != 0)
				return Sessions.GetAt(i);
d4259 1
a4259 6

	Session ses;
	ses.admin=false;
	ses.startTime = 0;

	return ses;
d4267 2
a4268 2
	CWebServer *pThis = (CWebServer *)Data.pThis;
	if(pThis != NULL)
d4270 2
a4271 5
		for(int i = 0; i < Sessions.GetSize(); i++)
		{
			if(Sessions[i].lSession == sessionID && sessionID != 0)
				return Sessions[i].admin;
		}
d4273 1
a4426 4
	CWebServer *pThis = (CWebServer *)Data.pThis;
	if(pThis == NULL)
		return _T("");

d4429 1
a4429 1
	CString	Out = pThis->m_Templates.sSearch;
d4485 1
a4485 1
		pThis->m_iSearchSortby = _tstoi(strTmp);
d4488 1
a4488 1
		pThis->m_bSearchAsc = _tstoi(strTmp);
d4509 1
a4509 1
	CString strResultList = pThis->m_Templates.sSearchHeader;
d4511 1
a4511 1
	strResultList += g_App.m_pSearchList->GetWebList(pThis->m_Templates.sSearchResultLine,pThis->m_iSearchSortby,pThis->m_bSearchAsc,!WSsearchColumnHidden[0],!WSsearchColumnHidden[1],!WSsearchColumnHidden[2],!WSsearchColumnHidden[3],!WSsearchColumnHidden[4]);
d4513 1
a4513 1
		InsertCatBox(Out, 0, pThis->m_Templates.sCatArrow, false, false, sSession, NULL);
d4550 1
a4550 1
	const TCHAR *pcSortIcon = (pThis->m_bSearchAsc) ? pThis->m_Templates.sUpArrow : pThis->m_Templates.sDownArrow;
d4555 1
a4555 1
		Out.Replace(_T("[FilenameI]"), (pThis->m_iSearchSortby == 0) ? pcSortIcon : _T(""));
d4568 1
a4568 1
		Out.Replace(_T("[FilesizeI]"), (pThis->m_iSearchSortby == 1) ? pcSortIcon : _T(""));
d4581 1
a4581 1
		Out.Replace(_T("[FilehashI]"), (pThis->m_iSearchSortby == 2) ? pcSortIcon : _T(""));
d4594 1
a4594 1
		Out.Replace(_T("[SourcesI]"), (pThis->m_iSearchSortby == 3) ? pcSortIcon : _T(""));
d4607 1
a4607 1
		Out.Replace(_T("[FakeCheckI]"), (pThis->m_iSearchSortby == 4) ? pcSortIcon : _T(""));
d4619 1
a4619 1
	strTmp.Format(_T("%i"), (pThis->m_iSearchSortby!=0 || (pThis->m_iSearchSortby==0 && pThis->m_bSearchAsc==0 ))?1:0 );
d4621 1
a4621 1
	strTmp.Format(_T("%i"), (pThis->m_iSearchSortby!=1 || (pThis->m_iSearchSortby==1 && pThis->m_bSearchAsc==0 ))?1:0 );
d4623 1
a4623 1
	strTmp.Format(_T("%i"), (pThis->m_iSearchSortby!=2 || (pThis->m_iSearchSortby==2 && pThis->m_bSearchAsc==0 ))?1:0 );
d4625 1
a4625 1
	strTmp.Format(_T("%i"), (pThis->m_iSearchSortby!=3 || (pThis->m_iSearchSortby==3 && pThis->m_bSearchAsc==0 ))?1:0 );
d4627 1
a4627 1
	strTmp.Format(_T("%i"), (pThis->m_iSearchSortby!=4 || (pThis->m_iSearchSortby==4 && pThis->m_bSearchAsc==0 ))?1:0 );
d4629 1
a4629 1
	strTmp.Format(_T("%i"), (pThis->m_iSearchSortby!=5 || (pThis->m_iSearchSortby==5 && pThis->m_bSearchAsc==0 ))?1:0 );
d4780 84
@


1.396
log
@Corrected session number generation to avoid zero.
@
text
@d333 1
a333 1
void CWebServer::AddStatsLine(UpDown line)
d337 3
a339 3
	m_Params.PointsForWeb.Add(line);
	if(m_Params.PointsForWeb.GetCount() > WEB_GRAPH_WIDTH)
		m_Params.PointsForWeb.RemoveAt(0);
d568 1
a568 1
			pThis->m_Params.Sessions.Add(ses);
d579 1
a579 1
			pThis->m_Params.Sessions.Add(ses);
d628 1
a628 1
		_RemoveSession(Data, lSession);
d630 1
a630 1
	if(_IsLoggedIn(Data, lSession))
d676 1
a676 1
		Out += _GetHeader(Data, lSession);
d678 1
a678 1
			Out += _GetServerList(Data);
d680 1
a680 1
			Out += _GetSharedFilesList(Data);
d682 1
a682 1
			Out += _GetTransferList(Data);
d684 1
a684 1
			Out += _GetSearch(Data);
d686 1
a686 1
			Out += _GetGraphs(Data);
d688 1
a688 1
			Out += _GetLog(Data);
d690 1
a690 1
			Out += _GetServerInfo(Data);
d692 1
a692 1
			Out += _GetDebugLog(Data);
d696 1
a696 1
			Out += _GetPreferences(Data);
d833 1
a833 1
CString CWebServer::_GetHeader(const ThreadData &Data, long lSession)
d899 1
a899 1
		InsertCatBox(Out, 0, pThis->m_Templates.sCatArrow, false, false, sSession, _T(""));
d1077 1
a1077 1
CString CWebServer::_GetServerList(const ThreadData &Data)
d1094 1
a1094 1
	CString sAddServerBox = _GetAddServerBox(Data);
d1655 1
a1655 1
CString CWebServer::_GetTransferList(const ThreadData &Data)
d1663 3
a1665 2
	CString strTmp, Out, sCat;
	byte		cat = _tstoi(_ParseURL(Data.sURL, _T("cat")));
d1688 1
a1688 1
		else
d1690 1
a1690 5
			byte	abyteFileHash[16];

			if (md4cmp0(StringToHash(sClear, abyteFileHash)) != 0)
			{
				byte	*pabyteFileHash = new uchar[16];
d1692 2
a1693 3
				md4cpy(pabyteFileHash, abyteFileHash);
				g_App.m_pMDlg->SendMessage(WEB_CLEAR_COMPLETED, (WPARAM)1, reinterpret_cast<LPARAM>(pabyteFileHash));
			}
d1987 1
a1987 1
	InsertCatBox(Out, cat, _T(""), true, true, sSession, _T(""));
a2627 2
	uchar abyteFileHashA4AF[16];

d2640 1
d2647 2
a2648 2
			&& md4cmp0(StringToHash(pFileArr[i].sFileHash, abyteFileHashA4AF)) != 0
			&& (g_App.m_pDownloadQueue->GetA4AFAutoFile() == g_App.m_pDownloadQueue->GetFileByID(abyteFileHashA4AF)) );
d2743 1
a2743 1
			HTTPProcessData.Replace(_T("[DownloadBar]"), _GetDownloadGraph(Data, pFileArr[i].sFileHash));
d2829 1
a2829 1
		InsertCatBox(HTTPProcessData, 0, _T(""), false, false, sSession, pFileArr[i].sFileHash);
d3193 1
a3193 1
CString CWebServer::_GetSharedFilesList(const ThreadData &Data)
d3763 1
a3763 1
CString CWebServer::_GetGraphs(const ThreadData &Data)
a3771 1

d3774 12
a3785 19
	for(int i = 0; i < WEB_GRAPH_WIDTH; i++)
	{
		if(i < pThis->m_Params.PointsForWeb.GetCount())
		{
			if(i != 0)
			{
				strGraphDownload += _T(',');
				strGraphUpload += _T(',');
				strGraphCons += _T(',');
			}

			// download
			strGraphDownload.AppendFormat(_T("%u"), (uint32)(pThis->m_Params.PointsForWeb[i].download*1024));

			// upload
			strGraphUpload.AppendFormat(_T("%u"), (uint32)(pThis->m_Params.PointsForWeb[i].upload*1024));

			// connections
			strGraphCons.AppendFormat(_T("%u"), (uint32)(pThis->m_Params.PointsForWeb[i].connections));
d3816 1
a3816 1
CString CWebServer::_GetAddServerBox(const ThreadData &Data)
d3908 1
a3908 1
CString CWebServer::_GetLog(const ThreadData &Data)
d3945 1
a3945 1
CString CWebServer::_GetServerInfo(const ThreadData &Data)
d3982 1
a3982 1
CString CWebServer::_GetDebugLog(const ThreadData &Data)
d4044 1
a4044 1
CString CWebServer::_GetPreferences(const ThreadData &Data)
d4311 1
a4311 1
bool CWebServer::_IsLoggedIn(const ThreadData &Data, long lSession)
d4319 1
a4319 1
	_RemoveTimeOuts(Data);
d4321 1
a4321 3
	// find our session
	// i should have used CMap there, but i like CArray more ;-)
	for(int i = 0; i < pThis->m_Params.Sessions.GetSize(); i++)
d4323 2
a4324 1
		if(pThis->m_Params.Sessions[i].lSession == lSession && lSession != 0)
d4326 6
a4331 3
			// if found, also reset expiration time
			pThis->m_Params.Sessions[i].startTime = CTime::GetCurrentTime();
			return true;
d4340 1
a4340 1
void CWebServer::_RemoveTimeOuts(const ThreadData &Data)
d4342 2
a4343 8
	EMULE_TRY

	// remove expired sessions
	CWebServer *pThis = (CWebServer *)Data.pThis;
	pThis->UpdateSessionCount();

	EMULE_CATCH
}
a4344 2
bool CWebServer::_RemoveSession(const ThreadData &Data, long lSession)
{
d4347 2
a4348 6
	CWebServer *pThis = (CWebServer *)Data.pThis;
	if(pThis == NULL)
		return false;

	// find our session
	for(int i = 0; i < pThis->m_Params.Sessions.GetSize(); i++)
d4350 1
a4350 1
		if(pThis->m_Params.Sessions[i].lSession == lSession && lSession != 0)
d4352 1
a4352 1
			pThis->m_Params.Sessions.RemoveAt(i);
d4354 2
a4355 1
			t_ulCurIP.Format(_T("%u.%u.%u.%u"),(byte)pThis->m_ulCurIP,(byte)(pThis->m_ulCurIP>>8),(byte)(pThis->m_ulCurIP>>16),(byte)(pThis->m_ulCurIP>>24));
d4366 1
a4366 1
Session CWebServer::GetSessionByID(const ThreadData &Data,long sessionID)
d4371 1
a4371 1
		for(int i = 0; i < pThis->m_Params.Sessions.GetSize(); i++)
d4373 2
a4374 2
			if(pThis->m_Params.Sessions[i].lSession == sessionID && sessionID != 0)
				return pThis->m_Params.Sessions.GetAt(i);
d4395 1
a4395 1
		for(int i = 0; i < pThis->m_Params.Sessions.GetSize(); i++)
d4397 2
a4398 2
			if(pThis->m_Params.Sessions[i].lSession == sessionID && sessionID != 0)
				return pThis->m_Params.Sessions[i].admin;
d4465 1
a4465 1
CString CWebServer::_GetDownloadGraph(const ThreadData &Data, const CString &strFileHash)
d4474 1
a4474 6
	byte	abyteFileHash[16];

	if (md4cmp0(StringToHash(strFileHash, abyteFileHash)) == 0)
		return _T("");

	CPartFile	*pPartFile = g_App.m_pDownloadQueue->GetFileByID(abyteFileHash);
d4550 1
a4550 1
CString	CWebServer::_GetSearch(const ThreadData &Data)
d4643 2
a4644 2
	if (CCat::GetNumCats()>1)
		InsertCatBox(Out,0,pThis->m_Templates.sCatArrow,false,false,sSession,_T(""));
d4773 1
a4773 2
	int oldvalue=m_Params.Sessions.GetSize();
	for(int i = 0; i < m_Params.Sessions.GetSize();)
d4775 1
a4775 1
		CTimeSpan ts = CTime::GetCurrentTime() - m_Params.Sessions[i].startTime;
d4777 1
a4777 1
			m_Params.Sessions.RemoveAt(i);
d4781 1
a4781 2

	return m_Params.Sessions.GetCount();
d4787 1
a4787 1
void CWebServer::InsertCatBox(CString &Out, int preselect, const CString &strBoxLbl, bool jump, bool extraCats, const CString &strSession, CString sFileHash)
d4817 2
a4818 1
	CString tempBuff3, tempBuff4;
d4824 1
a4824 1
		if (i==preselect)
d4826 1
a4826 1
			tempBuff3 = _T("checked.gif");
d4833 1
a4833 1
			tempBuff3 = _T("checked_no.gif");
d4836 1
a4836 1
		strCategory.Replace(_T("'"),_T("\\'"));
d4840 1
a4840 1
			strSession, i, tempBuff3, strCategory);
d4846 1
a4846 1
			if ((i+CAT_PREDEFINED)==preselect)
d4848 1
a4848 1
				tempBuff3= _T("checked.gif");
d4852 1
a4852 1
				tempBuff3 = _T("checked_no.gif");
d4856 1
a4856 1
				strSession, i + CAT_PREDEFINED, tempBuff3, GetSubCatLabel(i));
d4864 1
a4864 2
	byte		abyteFileHash[16];
	CPartFile	*pPartFile = NULL;
d4866 10
a4875 2
	if (md4cmp0(StringToHash(sFileHash, abyteFileHash)) != 0)
		pPartFile = g_App.m_pDownloadQueue->GetFileByID(abyteFileHash);
a4883 2
		tempBuff3 = (i == preselect) ? _T("checked.gif") : _T("checked_no.gif");

d4887 1
a4887 1
		strTmp.AppendFormat(_T("<a href=&quot;/?ses=%s&amp;w=transfer[CatSel]&amp;op=setcat&amp;file=%s&amp;filecat=%d&quot;>")
d4889 2
a4890 1
			strSession, sFileHash, i, tempBuff3, strCategory);
@


1.395
log
@Removed srand() as it's done on application startup;
Minor Unicode correction; Some renaming {Darklord}.
@
text
@d567 1
a567 1
			ses.lSession = lSession = rand() * 10000L + rand();
d578 1
a578 1
			ses.lSession = lSession = rand() * 10000L + rand();
@


1.394
log
@Improved string processing; Removed unused parameter; Proper type casting.
@
text
@d384 1
a384 1
void CWebServer::ProcessImgFileReq(const ThreadData &Data)
d517 1
a517 1
void CWebServer::ProcessURL(const ThreadData &Data)
a541 1
	srand(time(NULL));
d556 1
a556 1
	if ((_ParseURL(Data.sURL, _T("w")) == "password") && !pThis->GetIsTempDisabled() && _ParseURL(Data.sURL, _T("c")).IsEmpty())
@


1.393
log
@Fixed sorting of erroneous files under 'Show paused and stopped files last' {Fuxie - DK}
(erroneous file are excluded from stopped/paused group).
@
text
@d157 1
a157 1
			m_Templates.iProgressbarWidth = _tstoi(_LoadTemplate(sAll,_T("PROGRESSBARWIDTH")));
d252 1
a252 1
void CWebServer::_RemoveServer(CString sIP, int nPort)
d256 1
a256 1
	CServer	*server = g_App.m_pServerList->GetServerByAddress(sIP.GetBuffer(), nPort);
d263 1
a263 1
void CWebServer::_AddToStatic(CString sIP, int nPort)
d267 1
a267 1
	CServer	*server = g_App.m_pServerList->GetServerByAddress(sIP.GetBuffer(), nPort);
d274 1
a274 1
void CWebServer::_RemoveFromStatic(CString sIP, int nPort)
d278 1
a278 1
	CServer	*server = g_App.m_pServerList->GetServerByAddress(sIP.GetBuffer(), nPort);
d372 1
a372 1
void CWebServer::_ConnectToServer(CString sIP, int nPort)
d376 1
a376 1
	CServer	*server = g_App.m_pServerList->GetServerByAddress(sIP.GetBuffer(), nPort);
d725 2
a726 5
			if(gzipOut != NULL)
			{
				delete[] gzipOut;
				gzipOut = NULL;
			}
d738 2
a739 2
	if(gzipOut != NULL)
		delete[] gzipOut;
d1097 4
a1100 4
	CString sCmd = _ParseURL(Data.sURL, _T("c"));
	CString sIP = _ParseURL(Data.sURL, _T("ip"));
	int nPort = _tstoi(_ParseURL(Data.sURL, _T("port")));
	if (bAdmin &&  sCmd.CompareNoCase(_T("connect")) == 0)
d1105 1
a1105 1
			_ConnectToServer(sIP, nPort);
d1122 1
a1122 1
			_RemoveServer(sIP, nPort);
d1127 1
a1127 1
			_AddToStatic(sIP, nPort);
d1132 1
a1132 1
			_RemoveFromStatic(sIP, nPort);
d1138 1
a1138 1
			CServer* server=g_App.m_pServerList->GetServerByAddress(sIP.GetBuffer(), nPort);
d1148 1
a1148 1
			CServer* server=g_App.m_pServerList->GetServerByAddress(sIP.GetBuffer(), nPort);
d1158 1
a1158 1
			CServer* server=g_App.m_pServerList->GetServerByAddress(sIP.GetBuffer(), nPort);
d3870 1
a3870 1
				_AddToStatic(_ParseURL(Data.sURL, _T("serveraddr")), _tstoi(_ParseURL(Data.sURL, _T("serverport"))));
d3878 1
a3878 1
				_ConnectToServer(_ParseURL(Data.sURL, _T("serveraddr")), _tstoi(_ParseURL(Data.sURL, _T("serverport"))));
d4333 1
a4333 1
	_RemoveTimeOuts(Data,lSession);
d4352 1
a4352 1
void CWebServer::_RemoveTimeOuts(const ThreadData &Data, long lSession)
d4549 2
a4550 2
		byte lastcolor=1;
		uint16 lastindex=0;
d4559 2
a4560 1
			if (lastcolor!= _tstoi(s_ChunkBar.Mid(i,1)))
d4562 1
a4562 2
				if (i>lastindex)
				{
d4564 2
a4565 2
				}
				lastcolor=_tstoi(s_ChunkBar.Mid(i,1));
@


1.392
log
@Reduced H-file dependency.
@
text
@d2237 1
d2262 2
a2263 1
			switch(pPartFile->GetStatus())
d2318 1
a2318 2
			if ( g_App.m_pPrefs->DoPausedStoppedLast() &&
				pPartFile->IsPartFile() && !pPartFile->IsCompleting() )
d2320 2
a2321 2
				dFile.cSortRank |= (pPartFile->IsPaused()) ? 1 : 0;
				dFile.cSortRank |= (pPartFile->IsStopped()) ? 2 : 0;
@


1.391
log
@Proper localization of Check/Valid strings.
@
text
@d3 1
d5 2
a10 1
#include <stdlib.h>
@


1.390
log
@Fixed compilation (thanks roytam1).
@
text
@d4231 1
d4235 11
a4245 2
	Out.Replace(_T("[Valid]"), _SpecialChars(_GetPlainResString(IDS_WEB_VALID), true));
	Out.Replace(_T("[Check]"), _SpecialChars(_GetPlainResString(IDS_WEB_CHECK), true));
@


1.389
log
@UNICODE preparations
@
text
@d2633 1
a2633 1
	uchar FileHashA4AF[16];
@


1.388
log
@new email notifier code (adapted from original) - fully UNICODE ready;
option to send email notification messages in subject
@
text
@d1691 1
a1691 1
			uchar	FileHash[16];
d1693 1
a1693 1
			if (md4cmp0(StringToHash(sClear, FileHash)) != 0)
d1695 1
a1695 1
				uchar* pFileHash = new uchar[16];
d1697 2
a1698 2
				md4cpy(pFileHash, FileHash);
				g_App.m_pMDlg->SendMessage(WEB_CLEAR_COMPLETED, (WPARAM)1, reinterpret_cast<LPARAM>(pFileHash));
d1709 1
d1780 1
a1780 1
		CString sOp(_ParseURL(Data.sURL, _T("op")));
d1784 2
a1785 2
			CString sFile(_ParseURL(Data.sURL, _T("file")));
			uchar FileHash[16], UserHash[16];
d1789 5
a1793 3
				CPartFile *found_file = g_App.m_pDownloadQueue->GetFileByID(StringToHash(sFile, FileHash));
				if(found_file)
				{	// SyruS all actions require a found file (removed double-check inside)
d1795 1
a1795 1
						found_file->DownloadAllA4AF();
d1797 1
a1797 1
						found_file->DownloadAllA4AF(true);
d1799 1
a1799 1
						g_App.m_pDownloadQueue->SetA4AFAutoFile(found_file);
d1803 1
a1803 1
						found_file->StopFile();
d1805 1
a1805 1
						found_file->PauseFile();
d1807 1
a1807 1
						found_file->ResumeFile();
d1810 1
a1810 1
						found_file->DeleteFile();
d1814 1
a1814 1
						found_file->GetFirstLastChunk4Preview();
d1817 3
a1819 2
						CString sNewName(_ParseURL(Data.sURL, _T("name")));
						g_App.m_pMDlg->SendMessage(WEB_FILE_RENAME, (WPARAM)found_file, (LPARAM)(LPCTSTR)sNewName);
d1823 2
a1824 2
						found_file->SetAutoPriority(false);
						found_file->SetPriority(PR_LOW);
d1828 2
a1829 2
						found_file->SetAutoPriority(false);
						found_file->SetPriority(PR_NORMAL);
d1833 2
a1834 2
						found_file->SetAutoPriority(false);
						found_file->SetPriority(PR_HIGH);
d1838 2
a1839 2
						found_file->SetAutoPriority(true);
						found_file->SetPriority(PR_HIGH);
d1843 2
a1844 1
						int iMenu = _tstoi(_ParseURL(Data.sURL, _T("filecat")));
d1846 1
a1846 4
						{
							byte iCatIndex = CCat::UserCatIndexToCatIndex(iMenu);
							found_file->SetCatID(CCat::GetCatIDByIndex(iCatIndex));
						}
d1848 1
a1848 1
							found_file->SetCatID(CAT_NONE);
d1854 1
a1854 1
				CString sUser(_ParseURL(Data.sURL, _T("userhash")));
d1856 2
a1857 1
				if (md4cmp0(StringToHash(sUser, UserHash)) != 0)
d1859 4
a1862 8
					CUpDownClient* cur_client = g_App.m_pClientList->FindClientByUserHash(UserHash);
					if(cur_client)
					{
						if (sOp.CompareNoCase(_T("addfriend")) == 0)
							g_App.m_pFriendList->AddFriend(cur_client);
						else if (sOp.CompareNoCase(_T("removefriend")) == 0)
							g_App.m_pFriendList->RemoveFriend(cur_client);
					}
d2636 6
a2641 4
	CString sDownList, HTTPProcessData;
	CString OutE = pThis->m_Templates.sTransferDownLine;
	CString strFInfo;
	CString ed2k;			//ed2klink
d2643 1
a2643 1
	for(int i = 0; i < FilesArray.GetCount(); i++)
d2652 3
a2654 2
		const TCHAR	*pcDownPrio, *pcIsGetFLC;
		CPartFile	*found_file = g_App.m_pDownloadQueue->GetFileByID(StringToHash(pFileArr[i].sFileHash, FileHashA4AF));
d2694 1
a2694 2
			(g_App.m_pDownloadQueue->GetA4AFAutoFile() == found_file && !pFileArr[i].bIsComplete) ?
			_T("autoa4af") : _T("") );
d2703 1
a2703 1
		if (g_App.m_pDownloadQueue->GetA4AFAutoFile() == found_file && !pFileArr[i].bIsComplete)
d2773 3
a2775 3
			    pFileArr[i].lSourceCount - pFileArr[i].lNotCurrentSourceCount,
			    pFileArr[i].lSourceCount,
			    pFileArr[i].lTransferringSourceCount);
d3893 1
a3893 1
    Out.Replace(_T("[AddServer]"), _GetPlainResString(IDS_SV_NEWSERVER));
d4883 5
a4887 2
	uchar		FileHash[16];
	CPartFile	*pPartFile = g_App.m_pDownloadQueue->GetFileByID(StringToHash(sFileHash, FileHash));
d4893 1
a4893 1
		if (pPartFile)
@


1.387
log
@Simplified client upload data rate processing -- never return negative (Mantis #518);
Simplified calculations of file and upload client data rates.
@
text
@a5 1
#include "Smtp.h"
d608 1
a608 1
				g_App.m_pSMTPConnection->SendMail(MessageText, g_App.m_pPrefs->GetNotifierPopOnWebServerError(), g_App.m_pPrefs->IsSMTPWarningEnabled());
@


1.386
log
@WebServer: faster preparation of the tranfer and shared files pages; Formatting;
I enabled some WS messages to check current processing speed.
@
text
@d2216 1
a2216 1
	double fTotalSize = 0, fTotalTransferred = 0, fTotalSpeed = 0;
d2258 1
a2258 1
			dFile.lFileSpeed = pPartFile->GetDataRate();
d2364 1
a2364 1
						bSwap = pFileArr[i].lFileSpeed < pFileArr[i+1].lFileSpeed;
d2409 1
a2409 1
		if (cur_client->GetDataRate() > 0)
d2461 1
a2461 2
		sint32 iDataRate = cur_client->GetDataRate();
		dUser.nDataRate = ((iDataRate == -1) ? 0 : iDataRate);
d2494 1
a2494 1
				bSwap = pUploadArr[i].nDataRate < pUploadArr[i+1].nDataRate;
d2755 1
a2755 1
			if(pFileArr[i].lFileSpeed > 0.0f)
d2757 3
a2759 2
				fTotalSpeed += pFileArr[i].lFileSpeed;
				strTmp.Format(_T("%8.2f"), pFileArr[i].lFileSpeed / 1024.0);
d2845 1
a2845 1
	strTmp.Format(_T("%8.2f"), fTotalSpeed / 1024.0);
d2897 3
a2899 2
			fTotalSpeed += pUploadArr[i].nDataRate;
			strTmp.Format(_T("%8.2f"), max((double)pUploadArr[i].nDataRate / 1024, 0.0));
d2909 1
a2909 1
	strTmp.Format(_T("%8.2f"), max(fTotalSpeed / 1024, 0.0));
@


1.385
log
@Removed not required anymore IDS_WEB_GZIP_COMMENT.
@
text
@d347 4
a350 4
	str.Replace(_T("&"),_T("&amp;"));
	str.Replace(_T("<"),_T("&lt;"));
	str.Replace(_T(">"),_T("&gt;"));
	str.Replace(_T("\""),_T("&quot;"));
d363 8
d375 4
a378 2
	CServer* server=g_App.m_pServerList->GetServerByAddress(sIP.GetBuffer(), nPort);
	if (server!=NULL) g_App.m_pMDlg->SendMessage(WEB_CONNECT_TO_SERVER, (WPARAM)server, NULL);
d618 3
a621 1
	AddDebugLogLine(_T("WebServer: start request processing (Cmd=%s)"), strCmd);
d732 1
a732 1
#if 0
d743 1
a743 1
#if 0
d1666 1
a1668 2
	CString sCat;

d1671 1
a1672 1
	CString HTTPTemp;
a1676 2
	CString Out;

d1704 1
a1704 3
	HTTPTemp = _ParseURL(Data.sURL, _T("ed2k"));

	if (bAdmin && !HTTPTemp.IsEmpty())
d1706 7
a1712 3
		EnumCategories	eCatID = cat == 0 ? CAT_NONE : CCat::GetCatIDByUserIndex(cat);
		g_App.m_pMDlg->m_dlgSearch.AddEd2kLinksToDownload(HTTPTemp,eCatID);
		cat = cat == 0 ? 0 : CCat::UserCatIndexToCatIndex(cat);
d1715 2
a1716 3
	HTTPTemp = _ParseURL(Data.sURL, _T("c"));

	if (HTTPTemp.CompareNoCase(_T("menudown")) == 0)
d1729 1
a1729 1
	else if (HTTPTemp.CompareNoCase(_T("menuup")) == 0)
d1742 1
a1742 1
	else if (HTTPTemp.CompareNoCase(_T("menuqueue")) == 0)
d1755 1
a1755 1
	else if (HTTPTemp.CompareNoCase(_T("menuprio")) == 0)
d1870 2
a1871 1
	CString strTmp = _ParseURL(Data.sURL, _T("sortreverse"));
d1963 2
a1964 2
	HTTPTemp.SetString(_ParseURL(Data.sURL, _T("showuploadqueue")));
	if (HTTPTemp.CompareNoCase(_T("true")) == 0)
d1966 1
a1966 1
	else if (HTTPTemp.CompareNoCase(_T("false")) == 0)
d1969 2
a1970 2
	HTTPTemp.SetString(_ParseURL(Data.sURL, _T("showuploadqueuebanned")));
	if (HTTPTemp.CompareNoCase(_T("true")) == 0)
d1972 1
a1972 1
	else if (HTTPTemp.CompareNoCase(_T("false")) == 0)
d1975 2
a1976 2
	HTTPTemp.SetString(_ParseURL(Data.sURL, _T("showuploadqueuefriend")));
	if (HTTPTemp.CompareNoCase(_T("true")) == 0)
d1978 1
a1978 1
	else if (HTTPTemp.CompareNoCase(_T("false")) == 0)
d1981 2
a1982 2
	HTTPTemp.SetString(_ParseURL(Data.sURL, _T("showuploadqueuecredit")));
	if (HTTPTemp.CompareNoCase(_T("true")) == 0)
d1984 1
a1984 1
	else if (HTTPTemp.CompareNoCase(_T("false")) == 0)
d2239 1
a2239 1
		if (pPartFile)
d2241 1
a2241 1
			if ( !CCat::FileBelongsToGivenCat( pPartFile, ( cat > CAT_PREDEFINED)
d2250 4
a2253 2
			dFile.sFileName = _SpecialChars(pPartFile->GetFileName());
			dFile.sFileType = GetFileTypeForWebServer(dFile.sFileName);
a2259 12
			if(pPartFile->GetDataRate() > 0)
			{
				dFile.sFileState = _T("downloading");
			}
			else
			{
				if (pPartFile != NULL && pPartFile->GetPartFileStatusID() == PS_STALLED)
					dFile.sFileState = _T("stalled");
				else
					dFile.sFileState = _T("waiting");
			}

d2264 1
a2264 1
					dFile.sFileState = _T("hashing");
d2267 1
a2267 1
					dFile.sFileState = _T("waitinghash");
d2270 1
a2270 1
					dFile.sFileState = _T("error");
d2274 1
a2274 1
					dFile.sFileState = _T("completing");
d2278 1
a2278 1
					dFile.sFileState = _T("complete");
d2281 1
a2281 1
					dFile.sFileState = _T("stopped");
d2284 2
a2285 1
					dFile.sFileState = _T("paused");
d2287 10
a2296 1
					break;
d2312 2
a2313 1
			dFile.sFileInfo = _SpecialChars(pPartFile->GetDownloadFileInfo());
d2349 1
a2349 1
						bSwap = pFileArr[i].sFileState.Compare(pFileArr[i+1].sFileState) < 0;
d2352 1
a2352 1
						bSwap = pFileArr[i].sFileType.CompareNoCase(pFileArr[i+1].sFileType) < 0;
d2407 1
a2407 1
		CString sTemp;
d2419 4
a2422 4
		sTemp = _SpecialChars(cur_client->GetUploadFileInfo());
		sTemp.Replace(_T("\n"), _T("<br>"));
		sTemp.Replace(_T("'"), _T("&#8217;"));
		dUser.sFileInfo = sTemp;
d2430 2
a2431 2
		sTemp.Format(_T("%u"), dwClientSoft);
		dUser.sClientSoft = sTemp;
d2440 8
a2447 2
		if(cur_client->GetUserName().GetLength() > SHORT_LENGTH_MIN)
			dUser.sUserName = _SpecialChars(cur_client->GetUserName().Left(SHORT_LENGTH_MIN-3)) + _T("...");
d2449 2
a2450 1
			dUser.sUserName = _SpecialChars(cur_client->GetUserName());
d2452 5
a2456 2
		if (file)
			dUser.sFileName = _SpecialChars(CString(file->GetFileName()));
d2471 1
a2471 1
	for(int nMax = 0;bSorted && nMax < UploadArray.GetCount()*2; nMax++)
a2525 1
		CString sTemp;
d2557 7
a2563 2
		if(cur_client->GetUserName().GetLength() > SHORT_LENGTH_MIN)
			dUser.sUserName = _SpecialChars(cur_client->GetUserName().Left(SHORT_LENGTH_MIN-3)) + _T("...");
d2565 1
a2565 1
			dUser.sUserName = _SpecialChars(cur_client->GetUserName());
d2567 1
d2569 5
a2573 2
		if (file)
			dUser.sFileName = _SpecialChars(CString(file->GetFileName()));
d2589 1
a2589 2
		sTemp.Format(_T("%u"), dwClientSoft);
		dUser.sClientSoft = sTemp;
d2692 1
a2692 1
		HTTPProcessData.Replace(_T("[DownState]"), pFileArr[i].sFileState);
d2702 1
a2702 1
		HTTPProcessData.Replace(_T("[FileType]"), pFileArr[i].sFileType);
d2759 2
a2760 2
				HTTPTemp.Format(_T("%8.2f"), pFileArr[i].lFileSpeed / 1024.0);
				HTTPProcessData.Replace(_T("[4]"), HTTPTemp);
d2772 2
a2773 2
				HTTPTemp.Format(_T("%i&nbsp;/&nbsp;%8i&nbsp;(%i)"),
			    pFileArr[i].lSourceCount-pFileArr[i].lNotCurrentSourceCount,
d2776 1
a2776 1
				HTTPProcessData.Replace(_T("[5]"), HTTPTemp);
d2845 2
a2846 2
	HTTPTemp.Format(_T("%8.2f"), fTotalSpeed/1024.0);
	Out.Replace(_T("[TotalDownSpeed]"), HTTPTemp);
d2848 1
a2848 1
	HTTPTemp.Format( _T("%s: %i, %s: %i"), GetResString(IDS_SF_FILE), g_App.m_pDownloadQueue->GetFileCount(),
d2850 1
a2850 1
	Out.Replace(_T("[TotalFiles]"), HTTPTemp);
d2852 2
a2853 2
	HTTPTemp.Format(_T("%i"),pThis->m_Templates.iProgressbarWidth);
	Out.Replace(_T("[PROGRESSBARWIDTHVAL]"),HTTPTemp);
d2889 2
a2890 2
			HTTPTemp.Format(_T("%s / %s"), CastItoXBytes(pUploadArr[i].nTransferredDown),CastItoXBytes(pUploadArr[i].nTransferredUp));
			pcTmp = HTTPTemp;
d2898 2
a2899 2
			HTTPTemp.Format(_T("%8.2f "), max((double)pUploadArr[i].nDataRate/1024, 0.0));
			pcTmp = HTTPTemp;
d2906 4
a2909 4
	HTTPTemp.Format(_T("%s / %s"), CastItoXBytes(fTotalSize), CastItoXBytes(fTotalTransferred));
	Out.Replace(_T("[TotalUpTransferred]"), HTTPTemp);
	HTTPTemp.Format(_T("%8.2f "), max(fTotalSpeed/1024, 0.0));
	Out.Replace(_T("[TotalUpSpeed]"), HTTPTemp);
d2923 2
a2924 1
            TCHAR HTTPTempC[100] = _T("");
d2970 2
a2971 1
            TCHAR HTTPTempC[100] = _T("");
d3018 2
a3019 1
            TCHAR HTTPTempC[100] = _T("");
d3066 2
a3067 1
            TCHAR HTTPTempC[100] = _T("");
d3101 21
a3121 21
	CString mCounter;
	mCounter.Format(_T("%i"),nCountQueue);
	Out.Replace(_T("[CounterQueue]"), mCounter);
	mCounter.Format(_T("%i"),nCountQueueBanned);
	Out.Replace(_T("[CounterQueueBanned]"), mCounter);
	mCounter.Format(_T("%i"),nCountQueueFriend);
	Out.Replace(_T("[CounterQueueFriend]"), mCounter);
	mCounter.Format(_T("%i"),nCountQueueCredit);
	Out.Replace(_T("[CounterQueueCredit]"), mCounter);
	mCounter.Format(_T("%i"),nCountQueueSecure);
	Out.Replace(_T("[CounterQueueSecure]"), mCounter);
	mCounter.Format(_T("%i"),nCountQueueBannedSecure);
	Out.Replace(_T("[CounterQueueBannedSecure]"), mCounter);
	mCounter.Format(_T("%i"),nCountQueueFriendSecure);
	Out.Replace(_T("[CounterQueueFriendSecure]"), mCounter);
	mCounter.Format(_T("%i"),nCountQueueCreditSecure);
	Out.Replace(_T("[CounterQueueCreditSecure]"), mCounter);
	mCounter.Format(_T("%i"),nCountQueue+nCountQueueBanned+nCountQueueFriend+nCountQueueCredit);
	Out.Replace(_T("[CounterAll]"), mCounter);
	mCounter.Format(_T("%i"),nCountQueueSecure+nCountQueueBannedSecure+nCountQueueFriendSecure+nCountQueueCreditSecure);
	Out.Replace(_T("[CounterAllSecure]"), mCounter);
d3130 1
a3130 1
	strTmp = (pThis->m_Params.bQueueSortReverse) ? _T("&amp;sortreverse=false") : _T("&amp;sortreverse=true");
d3132 5
a3136 20
	if(pThis->m_Params.QueueSort == QU_SORT_CLIENT)
		Out.Replace(_T("[SortQClient]"), strTmp);
	else
		Out.Replace(_T("[SortQClient]"), _T(""));
	if(pThis->m_Params.QueueSort == QU_SORT_USER)
		Out.Replace(_T("[SortQUser]"), strTmp);
	else
		Out.Replace(_T("[SortQUser]"), _T(""));
	if(pThis->m_Params.QueueSort == QU_SORT_VERSION)
		Out.Replace(_T("[SortQVersion]"), strTmp);
	else
		Out.Replace(_T("[SortQVersion]"), _T(""));
	if(pThis->m_Params.QueueSort == QU_SORT_FILENAME)
		Out.Replace(_T("[SortQFilename]"), strTmp);
	else
		Out.Replace(_T("[SortQFilename]"), _T(""));
	if(pThis->m_Params.QueueSort == QU_SORT_SCORE)
		Out.Replace(_T("[SortQScore]"), strTmp);
	else
		Out.Replace(_T("[SortQScore]"), _T(""));
d3498 1
a3498 1
		//dFile.sFileName = _SpecialChars(cur_file->GetFileName());
d3501 2
a3502 2
		if(bPartFile)
			dFile.sFileState = _T("filedown");
d3504 2
a3505 2
			dFile.sFileState = _T("file");
		dFile.sFileType = GetFileTypeForWebServer(_SpecialChars(dFile.sFileName));
d3546 1
a3546 1
	for(int nMax = 0;bSorted && nMax < SharedArray.GetCount()*2; nMax++)
d3555 1
a3555 1
				bSwap = SharedArray[i].sFileState.CompareNoCase(SharedArray[i+1].sFileState) > 0;
d3558 1
a3558 1
				bSwap = SharedArray[i].sFileType.CompareNoCase(SharedArray[i+1].sFileType) > 0;
d3597 1
a3597 1
					{
d3602 3
a3604 3
					}
					else
						bSwap = SharedArray[i].nFilePriority < SharedArray[i+1].nFilePriority;
d3619 2
a3620 1
	CString sSharedList, HTTPProcessData;
d3631 1
a3631 6
		CString ed2k;				//ed2klink
		CString session;			//session
		CString hash;				//hash
		CString fname;				//filename
		CString sharedpriority;		//priority
		CString isjumpstart;		//jumpstart
d3633 1
a3633 1
		switch(SharedArray[i].nFilePriority)
d3636 1
a3636 1
				sharedpriority = _T("VeryLow");
d3639 1
a3639 1
				sharedpriority = _T("Low");
d3641 1
d3643 1
a3643 1
				sharedpriority = _T("Normal");
d3646 1
a3646 1
				sharedpriority = _T("High");
d3649 1
a3649 1
				sharedpriority = _T("Release");
d3653 1
a3653 1
			sharedpriority = _T("Auto");
a3656 2
		session = sSession;
		hash = SharedArray[i].sFileHash;
d3663 1
a3663 1
		if (md4cmp0(StringToHash(hash, abyteFileHash)) != 0)
d3667 1
a3667 1
			HTTPProcessData.Replace(_T("[hash]"), hash);
d3672 1
a3672 1
					isjumpstart = _T("jumpstart");
d3686 3
a3688 3
		HTTPProcessData.Replace(_T("[session]"), session);
		HTTPProcessData.Replace(_T("[shared-priority]"), sharedpriority); //DonGato: priority change
		HTTPProcessData.Replace(_T("[isjumpstart]"), isjumpstart);
d3691 2
a3692 2
		HTTPProcessData.Replace(_T("[FileType]"), SharedArray[i].sFileType);
		HTTPProcessData.Replace(_T("[FileState]"), SharedArray[i].sFileState);
@


1.384
log
@Removed preferences stuff (not used anymore) related to gzip compression;
Slightly improved string processing; Disabled gzip test messages.
@
text
@a4158 1
	Out.Replace(_T("[UseGzipComment]"), _GetPlainResString(IDS_WEB_GZIP_COMMENT));
@


1.383
log
@minor UNICODE preparation
@
text
@d425 1
a425 1
#if 1
a525 1
//	bool	isUseGzip = g_App.m_pPrefs->GetWebUseGzip(); // Old but keep for the moment
a604 1
//		isUseGzip = false;
d608 1
a608 1
#if 1
a683 2
		{
//			isUseGzip = false;
a684 1
		}
a685 3

//		if (strCmd.IsEmpty())
//			isUseGzip = false;
a688 1
//		isUseGzip = false;
d720 1
a720 1
#if 1
d731 1
a731 1
#if 1
a4065 4
		if ((_ParseURL(Data.sURL, _T("gzip")) == _T("true")) || (_ParseURL(Data.sURL, _T("gzip")).MakeLower() == _T("on")))
			g_App.m_pPrefs->SetWebUseGzip(true);
		if ((_ParseURL(Data.sURL, _T("gzip")) == _T("false")) || _ParseURL(Data.sURL, _T("gzip")).IsEmpty())
			g_App.m_pPrefs->SetWebUseGzip(false);
a4122 4
	if(g_App.m_pPrefs->GetWebUseGzip())
		Out.Replace(_T("[UseGzipVal]"), _T("checked"));
	else
		Out.Replace(_T("[UseGzipVal]"), _T(""));
a4187 1
	CString	sT;
d4191 8
a4198 8
	FractionalRate2String(&sT, (dwNum == UNLIMITED) ? 0 : dwNum);
	Out.Replace(_T("[MaxDownVal]"), sT);
	FractionalRate2String(&sT, g_App.m_pPrefs->GetMaxUpload());
	Out.Replace(_T("[MaxUpVal]"), sT);
	sT.Format(_T("%u"), g_App.m_pPrefs->GetMaxGraphDownloadRate() / 10);
	Out.Replace(_T("[MaxCapDownVal]"), sT);
	sT.Format(_T("%u"), g_App.m_pPrefs->GetMaxGraphUploadRate() / 10);
	Out.Replace(_T("[MaxCapUpVal]"), sT);
@


1.382
log
@Some fixes and localization for Web Server changes by morphis
@
text
@d205 1
a205 1
		AddDebugLogLine(RGB_LOG_ERROR_TXT "Webserver: can't load %s template", pcTemplateName);
d527 1
a527 1
	bool    isUseGzip = (Data.strAcceptEncoding.Find("gzip") >= 0); // Enable gzip only if the browser supports it
@


1.381
log
@WebServer: Send a 304 Not Modified message if the web client/browser already has the file with the same modification date.
@
text
@d4239 3
@


1.380
log
@Webserver: added appropriate response if a requested file is not found;
Created a routine for sending simple replies.
@
text
@d457 7
@


1.379
log
@Rolled back recent changes in HTTP header date format {roytam1},
@
text
@d490 1
a490 1
		Data.pSocket->SendContent(200, strHdr, buffer, size);
d493 2
d727 1
a727 1
		Data.pSocket->SendContent(200, HTTPInit, Out, Out.GetLength());
d729 1
a729 1
		Data.pSocket->SendContent(200, HTTPInit "Content-Encoding: gzip\r\n", gzipOut, gzipLen);
@


1.378
log
@Improved process of all client requests.
@
text
@d446 1
d448 1
d483 1
@


1.377
log
@Removed left-overs from the previously removed code;
Finished corrections of Unicode issues related to HTTP response preparation;
Reduced file access while obtaining file time; Optimized string processing;
Enable compression also for well compressed images (i.e. ico and bmp);
Removed setting of locate to form GMT time (it seems to be not required).
@
text
@d373 1
a373 1
void CWebServer::ProcessImgFileReq(ThreadData Data)
d494 1
a494 1
void CWebServer::ProcessURL(ThreadData Data)
d667 1
a667 1
		if (strCmd == _T("sinfo"))
d669 1
a669 1
		if (strCmd == _T("debuglog"))
d671 1
a671 1
		if (strCmd == _T("stats"))
d673 1
a673 1
		if (strCmd == _T("options"))
d821 1
a821 1
CString CWebServer::_GetHeader(ThreadData Data, long lSession)
d1050 1
a1050 1
CString CWebServer::_GetFooter(ThreadData Data)
d1065 1
a1065 1
CString CWebServer::_GetServerList(ThreadData Data)
d1643 1
a1643 1
CString CWebServer::_GetTransferList(ThreadData Data)
d3177 1
a3177 1
CString CWebServer::_GetSharedFilesList(ThreadData Data)
d3752 1
a3752 1
CString CWebServer::_GetGraphs(ThreadData Data)
d3813 1
a3813 1
CString CWebServer::_GetAddServerBox(ThreadData Data)
d3905 1
a3905 1
CString CWebServer::_GetLog(ThreadData Data)
d3942 1
a3942 1
CString CWebServer::_GetServerInfo(ThreadData Data)
d3979 1
a3979 1
CString CWebServer::_GetDebugLog(ThreadData Data)
d4016 1
a4016 1
CString CWebServer::_GetStats(ThreadData Data)
d4041 1
a4041 1
CString CWebServer::_GetPreferences(ThreadData Data)
d4215 1
a4215 1
CString CWebServer::_GetLoginScreen(ThreadData Data, bool bIsUseGzip)
d4305 1
a4305 1
bool CWebServer::_IsLoggedIn(ThreadData Data, long lSession)
d4332 1
a4332 1
void CWebServer::_RemoveTimeOuts(ThreadData Data, long lSession)
d4343 1
a4343 1
bool CWebServer::_RemoveSession(ThreadData Data, long lSession)
d4369 1
a4369 1
Session CWebServer::GetSessionByID(ThreadData Data,long sessionID)
d4390 1
a4390 1
bool CWebServer::IsSessionAdmin(ThreadData Data, const CString &strSsessionID)
d4468 1
a4468 1
CString CWebServer::_GetDownloadGraph(ThreadData Data, const CString &strFileHash)
d4558 1
a4558 1
CString	CWebServer::_GetSearch(ThreadData Data)
@


1.376
log
@Fixed some errors. unused variable, "=" instead of "==" and input wrong type for Find()
@
text
@d72 1
a72 1
	CString	strTmp(setlocale(LC_TIME, NULL));
a73 1
	CString sFile = g_App.m_pPrefs->GetTemplate();
d382 4
a385 2
	CString		strContentType = filename.Right(4).MakeLower();
	CString		pcContType;
d387 1
a387 1
	if (strContentType == ".gif")
d389 1
a389 1
	else if (strContentType == ".jpg" || filename.Right(5).MakeLower() == ".jpeg")
d391 2
a392 1
	else if (strContentType == ".bmp")
d394 3
a396 1
	else if (strContentType == ".png")
d398 2
a399 1
	else if (strContentType == ".ico")
d401 4
a404 1
	else if (strContentType == ".css")
d406 2
d409 1
d411 4
a414 1
	else if (strContentType == ".xml")
d416 4
a419 1
	else if (strContentType == ".txt")
d421 2
d424 1
d426 1
a426 3
	int iIdx = Data.strAcceptEncoding.Find("gzip");
	int iIdx2 = pcContType.Find("text/");
	if (iIdx >= 0 && iIdx2 == 0)
d432 3
d440 11
a450 5
// Get the file's modification time
	CFileStatus filestatus;
	CTime timeFileMod;
	if (CFile::GetStatus(filename, filestatus))
		timeFileMod = filestatus.m_mtime;
d452 7
a458 2
//	HTTP/1.x response header "Content-Type:"
	strContentType.Format(_T("Content-Type: %s\r\n"), pcContType);
d460 10
a469 2
//	HTTP/1.x response header "Last-Modified:"
	strContentType.AppendFormat(_T("Last-Modified: %s\r\n"), timeFileMod.FormatGmt("%a, %d %b %Y %H:%M:%S GMT"));
d471 10
a480 20
//	DonGato: expire images after 30 days (can be override by browser)
//	Controls for file caching expiry time
	const int	iExp_M = 1; //Months
	const int	iExp_D = 0; //Days
	const int	iExp_h = 0; //Hours
	const int	iExp_m = 0; //Minutes
	const int	iExp_s = 0; //Seconds
//	Calculate expiry time in seconds
	int		iExpireDelta = 60 * (60 * (24 * (30 * iExp_M + iExp_D) + iExp_h) + iExp_m) + iExp_s;
	CString sPrevLocale(setlocale(LC_TIME, NULL));
	_tsetlocale(LC_TIME, _T("English"));
	CTime	t = CTime::GetCurrentTime() + iExpireDelta;

//	HTTP/1.0 response header "Expires:" and
//	HTTP/1.1 response header "Cache-Control: max-age"
//	Overrides "Expires:" only if the client understands it
//	Is more accurate than "Expires:"
	strContentType.AppendFormat(_T("Expires: %s\r\nCache-Control: max-age=%u\r\n"),
		t.FormatGmt("%a, %d %b %Y %H:%M:%S GMT"), iExpireDelta);
	_tsetlocale(LC_TIME, sPrevLocale);
a481 3
	CFile file;
	if(file.Open(filename, CFile::modeRead|CFile::shareDenyWrite|CFile::typeBinary))
	{
d487 1
a487 1
		Data.pSocket->SendContent(200, strContentType, buffer, size);
a515 1

d707 1
a707 1
			AddDebugLogLine(RGB_LOG_ERROR_TXT "WebServer: Gzip FAILED on (Cmd=%s) (AcceptEncoding=%s)", strCmd, Data.strAcceptEncoding);
@


1.375
log
@Clean-up of some WebServer debug messages
@
text
@a71 1
	byte	abyteDigest[16];
d384 1
a384 1
	const TCHAR	*pcContType = _T("");
d408 1
a408 1
	if (iIdx >= 0 && iIdx2 = 0)
@


1.374
log
@WebSocket: Added the ablity for SendContent() to send HTTP headers other than "200 OK"
@
text
@a382 10
#if 1
	AddDebugLogLine(_T("WebServer: ProcessImgFileReq strAcceptEncoding->%s<-"), Data.strAcceptEncoding);
	int iIdx;
	iIdx = Data.strAcceptEncoding.Find("gzip");
	if ( iIdx >= 0 )
		AddDebugLogLine(_T("WebServer: ProcessImgFileReq Should do gzip"));
	else
		AddDebugLogLine(_T("WebServer: ProcessImgFileReq Should NOT do gzip"));
#endif

d406 9
a489 7
#if 1
	AddDebugLogLine(_T("WebServer: ProcessURL strAcceptEncoding->%s<-"), Data.strAcceptEncoding);
    if (isUseGzip)
        AddDebugLogLine(_T("WebServer: ProcessURL Going to gzip"));
    else
        AddDebugLogLine(_T("WebServer: ProcessURL NOT Going to gzip (%s)"), Data.strAcceptEncoding);
#endif
d575 4
a665 3
#if 1
		AddDebugLogLine(_T("WebServer: Gziping (Cmd=%s)"), strCmd);
#endif
d682 1
a682 3
#if 1
			AddDebugLogLine(_T("WebServer: Gziping FAILED (Cmd=%s)"), strCmd);
#endif
@


1.373
log
@Updated the "Last-Modified:" HTTP header to the file's actual modification time.
@
text
@d462 1
a462 1
		Data.pSocket->SendContent(strContentType, buffer, size);
d706 1
a706 1
		Data.pSocket->SendContent(HTTPInit, Out, Out.GetLength());
d708 1
a708 1
		Data.pSocket->SendContent(HTTPInit "Content-Encoding: gzip\r\n", gzipOut, gzipLen);
@


1.372
log
@Removed the Header "ETag:"
Removed sETag and sLastModifided
@
text
@d416 11
d431 1
a431 3
//		Disabled until the HTTP request header "If-Modified-Since" is supported
//		and the requested file's actual modification time is done. DO NOT DELETE.
//	strContentType.AppendFormat(_T("Last-Modified: max-age=%u\r\n"), pThis->m_Params.sLastModified);
a453 3
	filename.Delete(0);
	filename.Replace(_T('/'), _T('\\'));
	filename = g_App.m_pPrefs->GetAppDir() + _T("WebServer\\") + filename;
@


1.371
log
@Unicode corrections; Removed unused code; Better string processing; Formatting.
@
text
@a57 2
	m_Params.sLastModified.Empty();
	m_Params.sETag.Empty();
a74 6
	_tsetlocale(LC_TIME, _T("English"));
	CTime t = CTime::GetCurrentTime();
	m_Params.sLastModified = t.FormatGmt("%a, %d %b %Y %H:%M:%S GMT");
	m_Params.sETag = HashToString(MD5Sum(m_Params.sLastModified, abyteDigest));
	_tsetlocale(LC_TIME, strTmp);

d419 3
a421 1
//	HTTP/1.x response header "Last-Modified:" (Disabled until the HTTP request header "If-Modified-Since" is supported)
a423 3
//	HTTP/1.1 response header "ETag:" (Disabled until the HTTP request header "If-None-Match" is supported)
//	strContentType.AppendFormat(_T("ETag: max-age=%u\r\n"), pThis->m_Params.sETag);

@


1.370
log
@More appealing color and position and updated to use translated strings
@
text
@d18 1
a18 1
#define HTTPInit _T("Cache-Control: no-cache, no-store, must-revalidate, max-age=0, private\r\nPragma: no-cache\r\nContent-Type: text/html\r\n")
d668 1
a668 1
		Out += _GetLoginScreen(Data,isUseGzip);
d711 1
a711 1
		Data.pSocket->SendContent(HTTPInit _T("Content-Encoding: gzip\r\n"), gzipOut, gzipLen);
d4202 1
a4202 1
CString CWebServer::_GetLoginScreen(ThreadData Data,bool isUseGzip)
d4210 1
a4210 5
	CString sSession = _ParseURL(Data.sURL, _T("ses"));

	CString Out;

	Out += pThis->m_Templates.sLogin;
d4227 1
a4227 4
	if(isUseGzip)
		Out.Replace(_T("[isGziped]"), _GetPlainResString(IDS_ENABLED));
	else
		Out.Replace(_T("[isGziped]"), _GetPlainResString(IDS_DISABLED));
@


1.369
log
@Moved the HTTP headers "Connection: close" and "Server:" to CWebSocket::SendContent().
Added the HTTP header "Date:" to CWebSocket::SendContent().
Modified the HTTP header "Server:" its value is now "<App Name>/<Version>".
@
text
@d4232 1
a4232 1
		Out.Replace(_T("[isGziped]"), _T("enabled"));
d4234 1
a4234 1
		Out.Replace(_T("[isGziped]"), _T("disabled"));
@


1.368
log
@Added [isGziped] to login page processing
@
text
@d18 1
a18 1
#define HTTPInit _T("Server: eMule\r\nCache-Control: no-cache, no-store, must-revalidate, max-age=0, private\r\nPragma: no-cache\r\nConnection: close\r\nContent-Type: text/html\r\n")
@


1.367
log
@Fixed an issue with Caps Lock changes
@
text
@d668 1
a668 1
		Out += _GetLoginScreen(Data);
d4202 1
a4202 1
CString CWebServer::_GetLoginScreen(ThreadData Data)
d4231 5
@


1.366
log
@Localization of Caps Lock Web error message
@
text
@d4217 1
a4217 1
	Out.Replace(_T("[CapsErrorText]"), _GetPlainResString(IDS_WEB_CAPSERROR));
@


1.365
log
@Corrected time string preparation; Reduced a number of string operations.
@
text
@d4217 1
@


1.364
log
@WebServer: Added support for the HTTP request header "Accept-Encoding".
Output of pages are now automatically gziped only if the browser supports it.
Hid the Preference controls in the templates for manually turning gzip on/off.
@
text
@a444 4
	_tsetlocale(LC_TIME, sPrevLocale);

//	HTTP/1.0 response header "Expires:"
	strContentType.AppendFormat(_T("Expires: %s\r\n"), t.FormatGmt("%a, %d %b %Y %H:%M:%S GMT"));
d446 1
d450 3
a452 1
	strContentType.AppendFormat(_T("Cache-Control: max-age=%u\r\n"), iExpireDelta);
a702 1
//
@


1.363
log
@WebServer: General cleanup and readiness for "Accept-Encoding" support
@
text
@d391 10
d493 10
a502 1
	bool	isUseGzip = g_App.m_pPrefs->GetWebUseGzip();
d581 1
a581 1
		isUseGzip = false;
d658 1
a658 1
			isUseGzip = false;
d663 2
a664 2
		if (strCmd.IsEmpty())
			isUseGzip = false;
d668 1
a668 1
		isUseGzip = false;
@


1.362
log
@Don't add sources to created ed2k links in the transfer and shared files lists;
Corrected message text reporting missed template (also moved to debug log).
@
text
@d18 1
a18 2
#define HTTPInit _T("Server: eMule\r\nConnection: close\r\nContent-Type: text/html\r\n")
#define HTTPInitGZ _T("Server: eMule\r\nConnection: close\r\nContent-Type: text/html\r\nContent-Encoding: gzip\r\n")
d414 8
a421 2
	strContentType.Format(_T("Content-Type: %s\r\nLast-Modified: %s\r\nETag: %s\r\n"),
		pcContType, pThis->m_Params.sLastModified, pThis->m_Params.sETag);
a423 4
//	HTTP/1.0 header "Expires:"
	CString sPrevLocale(setlocale(LC_TIME, NULL));
	_tsetlocale(LC_TIME, _T("English"));

d432 2
d435 1
d437 2
a438 3
	strContentType += _T("Expires: ");
	strContentType += t.FormatGmt("%a, %d %b %Y %H:%M:%S GMT");
	_tsetlocale(LC_TIME, sPrevLocale);
d440 1
a440 1
//	HTTP/1.1 header "Cache-Control: max-age"
d443 1
a443 1
	strContentType.AppendFormat(_T("\r\nCache-Control: max-age=%u\r\n"), iExpireDelta);
d646 6
d653 7
a659 1
		if(isUseGzip)
d661 3
a663 2
			bool bOk = false;
			try
d665 2
a666 7
				uLongf destLen = Out.GetLength() + 1024;
				gzipOut = new TCHAR[destLen];
				if(_GzipCompress((Bytef*)gzipOut, &destLen, (const Bytef*)(TCHAR*)Out.GetBuffer(0), Out.GetLength(), Z_DEFAULT_COMPRESSION) == Z_OK)
				{
					bOk = true;
					gzipLen = destLen;
				}
d668 11
a678 1
			catch(...)
d680 2
a681 9
			}
			if(!bOk)
			{
				isUseGzip = false;
				if(gzipOut != NULL)
				{
					delete[] gzipOut;
					gzipOut = NULL;
				}
d685 1
a685 5
	else
	{
		isUseGzip = false;
		Out += _GetLoginScreen(Data);
	}
d694 1
a694 1
		Data.pSocket->SendContent(HTTPInitGZ, gzipOut, gzipLen);
@


1.361
log
@Removed incorrect and useless error report on template loading;
WebServer: more sources added to ed2k link generated in transfer list (like in GUI)
(before only own reference added as a source);
WebServer: simplified and corrected ed2k link creation in the shared files list
(before LowID users could create a link with own reference added as a source).
@
text
@d216 1
a216 1
		AddLogLine(false, RGB_LOG_ERROR + GetResString(IDS_WEB_ERR_CANTLOAD), pcTemplateName);
d2257 1
a2257 6
#ifdef OLD_SOCKETS_ENABLED
			if (g_App.m_pServerConnect->IsConnected() && !g_App.m_pServerConnect->IsLowID())
				dFile.sED2kLink = pPartFile->CreateED2KSourceLink(7, 10);
			else
#endif //OLD_SOCKETS_ENABLED
				dFile.sED2kLink = pPartFile->CreateED2kLink();
d3446 1
a3446 1
		dFile.sED2kLink = cur_file->CreateED2kSourceLink();
@


1.360
log
@Improved string processing; Unicode corrections;
WebServer: reduced file I/O while loading templates.
@
text
@d216 2
a217 6
	{
		if (_tcscmp(pcTemplateName, _T("TMPL_VERSION")) == 0)
			AddLogLine(true, RGB_LOG_ERROR + GetResString(IDS_WS_ERR_LOADTEMPLATE), pcTemplateName);
		if (nStart == -1)
			AddLogLine(false, RGB_LOG_ERROR + GetResString(IDS_WEB_ERR_CANTLOAD), pcTemplateName);
	}
d2259 1
a2259 1
				dFile.sED2kLink = pPartFile->CreateED2kSourceLink();
d3451 1
a3451 6
#ifdef OLD_SOCKETS_ENABLED
		if (g_App.m_pServerConnect->IsConnected())
			dFile.sED2kLink = cur_file->CreateED2kSourceLink();
		else
#endif //OLD_SOCKETS_ENABLED
		dFile.sED2kLink = cur_file->CreateED2kLink();
@


1.359
log
@Better memory management for Unicode (thanks KuSh).
@
text
@d76 1
a76 1
	CString	sPrevLocale(setlocale(LC_TIME, NULL));
d82 1
a82 1
	_tsetlocale(LC_TIME, sPrevLocale);
d86 4
a89 1
		sFile = g_App.m_pPrefs->GetAppDir() + CString("eMuleXP.tmpl");
d94 1
a94 1
		CString sAll, sLine;
d97 1
a97 1
			if(!file.ReadString(sLine))
d100 1
a100 1
			sAll += sLine;
d105 2
a106 2
		CString sVersion = _LoadTemplate(sAll,_T("TMPL_VERSION"));
		long lVersion = _tstol(sVersion);
d110 1
a110 1
				AddLogLine(true,RGB_LOG_ERROR + GetResString(IDS_WS_ERR_LOADTEMPLATE), sFile);
d118 13
d200 1
a200 1
CString CWebServer::_LoadTemplate(CString sAll, CString sTemplateName)
d204 7
a210 16
	CString fullpath;
	fullpath.Format(_T("%spreferences.ini"),g_App.m_pPrefs->GetConfigDir());
	CIni ini( fullpath );

	ini.SetDefaultCategory(_T("WebServer"));
	ini.GetArray(WSdownloadColumnHidden, ELEMENT_COUNT(WSdownloadColumnHidden), _T("downloadColumnHidden"));
	ini.GetArray(WSuploadColumnHidden, ELEMENT_COUNT(WSuploadColumnHidden), _T("uploadColumnHidden"));
	ini.GetArray(WSqueueColumnHidden, ELEMENT_COUNT(WSqueueColumnHidden), _T("queueColumnHidden"));
	ini.GetArray(WSsearchColumnHidden, ELEMENT_COUNT(WSsearchColumnHidden), _T("searchColumnHidden"));
	ini.GetArray(WSsharedColumnHidden, ELEMENT_COUNT(WSsharedColumnHidden), _T("sharedColumnHidden"));
	ini.GetArray(WSserverColumnHidden, ELEMENT_COUNT(WSserverColumnHidden), _T("serverColumnHidden"));
	ini.SaveAndClose();
	CString sRet;
	int nStart = sAll.Find(_T("<--") + sTemplateName + _T("-->"));
	int nEnd = sAll.Find(_T("<--") + sTemplateName + _T("_END-->"));
	if(nStart != -1 && nEnd != -1 && nStart<nEnd)
d212 1
a212 1
		nStart += sTemplateName.GetLength() + 7;
d217 4
a220 4
		if (sTemplateName=="TMPL_VERSION")
			AddLogLine(true, RGB_LOG_ERROR + GetResString(IDS_WS_ERR_LOADTEMPLATE), sTemplateName);
		if (nStart==-1)
			AddLogLine(false, RGB_LOG_ERROR + GetResString(IDS_WEB_ERR_CANTLOAD), sTemplateName);
@


1.358
log
@WebServer: optimized preparation of the tranfer page;
Some Unicode corrections; Formatting.
@
text
@d446 1
a446 1
		TCHAR	*buffer = new TCHAR[dwFileSz];
@


1.357
log
@Fixed compilation;
WebServer: optimized processing of the requests for auxiliary files.
@
text
@d1940 1
a1940 1
	strTmp = (pThis->m_Params.bDownloadSortReverse) ? _T("&amp;sortreverse=false") : _T("&amp;sortreverse=true");
d1942 20
a1961 71
	if(pThis->m_Params.DownloadSort == DOWN_SORT_STATE)
		Out.Replace(_T("[SortDState]"), strTmp);
	else
		Out.Replace(_T("[SortDState]"), _T(""));
	if(pThis->m_Params.DownloadSort == DOWN_SORT_TYPE)
		Out.Replace(_T("[SortDType]"), strTmp);
	else
		Out.Replace(_T("[SortDType]"), _T(""));
	if(pThis->m_Params.DownloadSort == DOWN_SORT_NAME)
		Out.Replace(_T("[SortDName]"), strTmp);
	else
		Out.Replace(_T("[SortDName]"), _T(""));
	if(pThis->m_Params.DownloadSort == DOWN_SORT_SIZE)
		Out.Replace(_T("[SortDSize]"), strTmp);
	else
		Out.Replace(_T("[SortDSize]"), _T(""));
	if(pThis->m_Params.DownloadSort == DOWN_SORT_TRANSFERRED)
		Out.Replace(_T("[SortDTransferred]"), strTmp);
	else
		Out.Replace(_T("[SortDTransferred]"), _T(""));
	if(pThis->m_Params.DownloadSort == DOWN_SORT_SPEED)
		Out.Replace(_T("[SortDSpeed]"), strTmp);
	else
		Out.Replace(_T("[SortDSpeed]"), _T(""));
	if(pThis->m_Params.DownloadSort == DOWN_SORT_PROGRESS)
		Out.Replace(_T("[SortDProgress]"), strTmp);
	else
		Out.Replace(_T("[SortDProgress]"), _T(""));
	if(pThis->m_Params.DownloadSort == DOWN_SORT_SOURCES)
		Out.Replace(_T("[SortDSources]"), strTmp);
	else
		Out.Replace(_T("[SortDSources]"), _T(""));
	if(pThis->m_Params.DownloadSort == DOWN_SORT_PRIORITY)
		Out.Replace(_T("[SortDPriority]"), strTmp);
	else
		Out.Replace(_T("[SortDPriority]"), _T(""));
	if(pThis->m_Params.DownloadSort == DOWN_SORT_CATEGORY)
		Out.Replace(_T("[SortDCategory]"), strTmp);
	else
		Out.Replace(_T("[SortDCategory]"), _T(""));
	if(pThis->m_Params.DownloadSort == DOWN_SORT_FAKECHECK)
		Out.Replace(_T("[SortDFakeCheck]"), strTmp);
	else
		Out.Replace(_T("[SortDFakeCheck]"), _T(""));

	strTmp = (pThis->m_Params.bUploadSortReverse) ? _T("&amp;sortreverse=false") : _T("&amp;sortreverse=true");

	if(pThis->m_Params.UploadSort == UP_SORT_CLIENT)
		Out.Replace(_T("[SortUClient]"), strTmp);
	else
		Out.Replace(_T("[SortUClient]"), _T(""));
	if(pThis->m_Params.UploadSort == UP_SORT_USER)
		Out.Replace(_T("[SortUUser]"), strTmp);
	else
		Out.Replace(_T("[SortUUser]"), _T(""));
	if(pThis->m_Params.UploadSort == UP_SORT_VERSION)
		Out.Replace(_T("[SortUVersion]"), strTmp);
	else
		Out.Replace(_T("[SortUVersion]"), _T(""));
	if(pThis->m_Params.UploadSort == UP_SORT_FILENAME)
		Out.Replace(_T("[SortUFilename]"), strTmp);
	else
		Out.Replace(_T("[SortUFilename]"), _T(""));
	if(pThis->m_Params.UploadSort == UP_SORT_TRANSFERRED)
		Out.Replace(_T("[SortUTransferred]"), strTmp);
	else
		Out.Replace(_T("[SortUTransferred]"), _T(""));
	if(pThis->m_Params.UploadSort == UP_SORT_SPEED)
		Out.Replace(_T("[SortUSpeed]"), strTmp);
	else
		Out.Replace(_T("[SortUSpeed]"), _T(""));
a2183 1

d2282 1
d2289 1
a2289 1
			if ((iSortRank = (FilesArray[i].cSortRank - FilesArray[i + 1].cSortRank)) != 0)
d2296 1
a2296 1
						bSwap = FilesArray[i].sFileState.CompareNoCase(FilesArray[i+1].sFileState) < 0;
d2299 1
a2299 1
						bSwap = FilesArray[i].sFileType.CompareNoCase(FilesArray[i+1].sFileType) < 0;
d2302 1
a2302 1
						bSwap = FilesArray[i].sFileName.CompareNoCase(FilesArray[i+1].sFileName) < 0;
d2305 1
a2305 1
						bSwap = FilesArray[i].m_qwFileSize < FilesArray[i+1].m_qwFileSize;
d2308 1
a2308 1
						bSwap = FilesArray[i].m_qwFileTransferred < FilesArray[i+1].m_qwFileTransferred;
d2311 1
a2311 1
						bSwap = FilesArray[i].lFileSpeed < FilesArray[i+1].lFileSpeed;
d2314 1
a2314 1
						bSwap = FilesArray[i].m_dblCompleted  < FilesArray[i+1].m_dblCompleted;
d2317 1
a2317 1
						bSwap = FilesArray[i].lSourceCount  < FilesArray[i+1].lSourceCount;
d2320 1
a2320 1
						bSwap = FilesArray[i].nFilePrio < FilesArray[i+1].nFilePrio;
d2323 1
a2323 1
						bSwap = FilesArray[i].sCategory.CompareNoCase(FilesArray[i+1].sCategory) < 0;
d2326 1
a2326 1
						bSwap = FilesArray[i].sFakeCheck.CompareNoCase(FilesArray[i+1].sFakeCheck) < 0;
d2338 3
a2340 3
				DownloadFiles TmpFile = FilesArray[i];
				FilesArray[i] = FilesArray[i+1];
				FilesArray[i+1] = TmpFile;
d2358 2
a2359 2
			dUser.sActive = _T("downloading");
			dUser.sClientState = _T("uploading");
d2363 2
a2364 2
			dUser.sActive = _T("waiting");
			dUser.sClientState = _T("connecting");
a2378 1
		dUser.sClientSoftSpecial = sTemp;
d2380 1
a2380 1
			dUser.sClientExtra = _T("banned");
d2382 1
a2382 1
			dUser.sClientExtra = _T("friend");
d2384 1
a2384 1
			dUser.sClientExtra = _T("credit");
d2386 1
a2386 1
			dUser.sClientExtra = _T("none");
d2404 2
d2417 1
a2417 1
				bSwap = UploadArray[i].sClientSoftSpecial.CompareNoCase(UploadArray[i+1].sClientSoftSpecial) < 0;
d2420 1
a2420 1
				bSwap = UploadArray[i].sUserName.CompareNoCase(UploadArray[i+1].sUserName) < 0;
d2423 1
a2423 1
				bSwap = UploadArray[i].sClientNameVersion.CompareNoCase(UploadArray[i+1].sClientNameVersion) < 0;
d2426 1
a2426 1
				bSwap = UploadArray[i].sFileName.CompareNoCase(UploadArray[i+1].sFileName) < 0;
d2429 1
a2429 1
				bSwap = UploadArray[i].nTransferredUp < UploadArray[i+1].nTransferredUp;
d2432 1
a2432 1
				bSwap = UploadArray[i].nDataRate < UploadArray[i+1].nDataRate;
d2440 3
a2442 3
				UploadUsers TmpUser = UploadArray[i];
				UploadArray[i] = UploadArray[i+1];
				UploadArray[i+1] = TmpUser;
d2455 2
d2468 2
a2469 1
			dUser.sClientExtra = _T("banned");
d2475 2
a2476 1
			dUser.sClientExtra = _T("friend");
d2482 2
a2483 1
			dUser.sClientExtra = _T("credit");
d2489 2
a2490 1
			dUser.sClientExtra = _T("none");
d2505 6
a2510 3
		dUser.sClientState = dUser.sClientExtra;
		dUser.sClientStateSpecial = _T("connecting");
		dUser.nScore = cur_client->GetScore(false);
a2519 1
		dUser.sClientSoftSpecial = sTemp;
d2525 1
a2525 1
			dUser.sIndex = dUser.sClientSoftSpecial;
d2537 1
a2537 1
			dUser.sIndex.Format(_T("%09u"), dUser.nScore);
d2545 2
a2546 10
	int nNextPos = 0;	// position in queue of the user with the highest score -> next upload user
	uint32 nNextScore = 0;	// highest score -> next upload user
	for(int i = 0; i < QueueArray.GetCount(); i++)
	{
		if (QueueArray[i].nScore > nNextScore)
		{
			nNextPos = i;
			nNextScore = QueueArray[i].nScore;
		}
	}
d2549 1
a2549 2
		QueueArray[nNextPos].sClientState = _T("next");
		QueueArray[nNextPos].sClientStateSpecial = QueueArray[nNextPos].sClientState;
a2570 1
	CString fname;			//filename
a2572 1
	CString isgetflc;		//getflc
d2578 2
a2579 2
		if (FilesArray[i].sFileHash == _ParseURL(Data.sURL,_T("file")) )
            HTTPProcessData.Replace(_T("[LastChangedDataset]"), _T("checked"));
d2581 1
a2581 1
            HTTPProcessData.Replace(_T("[LastChangedDataset]"), _T("checked_no"));
d2583 2
a2584 5
		CString state;			//state
		CString autoa4af;		//autoa4af
		CString session;		//session
		CString filehash;		//filehash
		CString downpriority;	//priority
d2586 1
a2586 3
		CPartFile *found_file = g_App.m_pDownloadQueue->GetFileByID(StringToHash(FilesArray[i].sFileHash, FileHashA4AF));

		strFInfo = FilesArray[i].sFileInfo;
d2591 1
a2591 1
		ed2k = FilesArray[i].sED2kLink;
a2592 7
		fname = FilesArray[i].sFileNameJS;
		state = FilesArray[i].sFileState;
		session = sSession;
		filehash = FilesArray[i].sFileHash;

		if (g_App.m_pDownloadQueue->GetA4AFAutoFile() == found_file && !FilesArray[i].bIsComplete)
			autoa4af = _T("autoa4af");
d2594 4
a2597 4
		if (!FilesArray[i].bIsPreview)
			isgetflc = _T("");
		else if(FilesArray[i].bIsGetFLC)
			isgetflc = _T("enabled");
d2599 1
a2599 1
			isgetflc = _T("disabled");
d2601 2
a2602 2
		if(FilesArray[i].bFileAutoPrio)
			downpriority = _T("Auto");
d2605 1
a2605 1
			switch(FilesArray[i].nFilePrio)
d2607 2
a2608 2
				case 0:
					downpriority = _T("Low");
d2610 3
a2612 2
				case 1:
					downpriority = _T("Normal");
d2614 2
a2615 2
				case 2:
					downpriority = _T("High");
a2618 1

d2622 8
a2629 6
		HTTPProcessData.Replace(_T("[DownState]"), state);
		HTTPProcessData.Replace(_T("[autoa4af]"), autoa4af);
		HTTPProcessData.Replace(_T("[isgetflc]"), isgetflc);
		HTTPProcessData.Replace(_T("[fname]"), fname);
		HTTPProcessData.Replace(_T("[session]"), session);
		HTTPProcessData.Replace(_T("[filehash]"), filehash);
d2631 2
a2632 3
		HTTPProcessData.Replace(_T("[down-priority]"), downpriority);

		HTTPProcessData.Replace(_T("[FileType]"), FilesArray[i].sFileType);
d2634 1
a2634 1
		if (g_App.m_pDownloadQueue->GetA4AFAutoFile() == found_file && !FilesArray[i].bIsComplete)
d2639 1
a2639 1
		if (FilesArray[i].bIsPreview && FilesArray[i].bIsGetFLC)
d2646 2
a2647 2
			if(FilesArray[i].sFileName.GetLength() > (SHORT_LENGTH_MAX))
				HTTPProcessData.Replace(_T("[ShortFileName]"), FilesArray[i].sFileName.Left(SHORT_LENGTH_MAX-3) + _T("..."));
d2649 1
a2649 1
				HTTPProcessData.Replace(_T("[ShortFileName]"), FilesArray[i].sFileName);
d2654 1
a2654 1
		CString sTooltip = FilesArray[i].sFileInfo;
d2659 1
a2659 1
		fTotalSize += FilesArray[i].m_qwFileSize;
d2662 1
a2662 1
			HTTPProcessData.Replace(_T("[2]"), CastItoXBytes(FilesArray[i].m_qwFileSize));
d2668 1
a2668 1
			if(FilesArray[i].m_qwFileTransferred > 0)
d2670 2
a2671 2
				fTotalTransferred += FilesArray[i].m_qwFileTransferred;
				HTTPProcessData.Replace(_T("[3]"), CastItoXBytes(FilesArray[i].m_qwFileTransferred));
d2680 1
a2680 1
			HTTPProcessData.Replace(_T("[DownloadBar]"), _GetDownloadGraph(Data,FilesArray[i].sFileHash));
a2683 2
		HTTPTemp.Empty();

d2686 1
a2686 1
			if(FilesArray[i].lFileSpeed > 0.0f)
d2688 2
a2689 2
				fTotalSpeed += FilesArray[i].lFileSpeed;
				HTTPTemp.Format(_T("%8.2f"), FilesArray[i].lFileSpeed/1024.0);
d2700 1
a2700 1
			if(FilesArray[i].lSourceCount > 0)
d2703 3
a2705 3
			    FilesArray[i].lSourceCount-FilesArray[i].lNotCurrentSourceCount,
			    FilesArray[i].lSourceCount,
			    FilesArray[i].lTransferringSourceCount);
d2716 3
a2718 1
			if(FilesArray[i].bFileAutoPrio)
d2720 1
a2720 1
				switch(FilesArray[i].nFilePrio)
d2722 10
a2731 3
					case 0: HTTPTemp=GetResString(IDS_PRIOAUTOLOW); break;
					case 1: HTTPTemp=GetResString(IDS_PRIOAUTONORMAL); break;
					case 2: HTTPTemp=GetResString(IDS_PRIOAUTOHIGH); break;
d2736 1
a2736 1
				switch(FilesArray[i].nFilePrio)
d2738 10
a2747 3
					case  0: HTTPTemp=GetResString(IDS_PRIOLOW); break;
					case  1: HTTPTemp=GetResString(IDS_PRIONORMAL); break;
					case  2: HTTPTemp=GetResString(IDS_PRIOHIGH); break;
d2750 1
a2750 1
			HTTPProcessData.Replace(_T("[PrioVal]"), HTTPTemp);
d2756 1
a2756 1
			HTTPProcessData.Replace(_T("[Category]"), FilesArray[i].sCategory);
d2761 1
a2761 1
			HTTPProcessData.Replace(_T("[FakeCheck]"), FilesArray[i].sFakeCheck);
d2765 1
a2765 1
		InsertCatBox(HTTPProcessData, 0, _T(""), false, false, sSession, FilesArray[i].sFileHash);
a2789 1
	const TCHAR	*pcTmp;
d2798 6
a2803 7
		HTTPProcessData.Replace(_T("[UserHash]"), UploadArray[i].sUserHash);
		HTTPProcessData.Replace(_T("[UpState]"), UploadArray[i].sActive);
		HTTPProcessData.Replace(_T("[FileInfo]"), UploadArray[i].sFileInfo);
		HTTPProcessData.Replace(_T("[ClientState]"), UploadArray[i].sClientState);
		HTTPProcessData.Replace(_T("[ClientSoft]"), UploadArray[i].sClientSoft);
		HTTPProcessData.Replace(_T("[ClientSoftSpecial]"), UploadArray[i].sClientSoftSpecial);
		HTTPProcessData.Replace(_T("[ClientExtra]"), UploadArray[i].sClientExtra);
d2805 1
a2805 1
		pcTmp = (!WSuploadColumnHidden[0]) ? UploadArray[i].sUserName.GetString() : _T("");
d2808 1
a2808 1
		pcTmp = (!WSuploadColumnHidden[1]) ? UploadArray[i].sClientNameVersion.GetString() : _T("");
d2811 1
a2811 1
		pcTmp = (!WSuploadColumnHidden[2]) ? UploadArray[i].sFileName.GetString() : _T("");
d2817 3
a2819 3
			fTotalSize += UploadArray[i].nTransferredDown;
			fTotalTransferred += UploadArray[i].nTransferredUp;
			HTTPTemp.Format(_T("%s / %s"), CastItoXBytes(UploadArray[i].nTransferredDown),CastItoXBytes(UploadArray[i].nTransferredUp));
d2827 2
a2828 2
			fTotalSpeed += UploadArray[i].nDataRate;
			HTTPTemp.Format(_T("%8.2f "), max((double)UploadArray[i].nDataRate/1024, 0.0));
d2854 1
a2854 1
			if (QueueArray[i].sClientExtra == "none")
d2857 1
a2857 1
				pcTmp = (!WSqueueColumnHidden[0]) ? QueueArray[i].sUserName.GetString() : _T("");
d2860 1
a2860 1
				pcTmp = (!WSqueueColumnHidden[1]) ? QueueArray[i].sClientNameVersion.GetString() : _T("");
d2863 1
a2863 1
				pcTmp = (!WSqueueColumnHidden[2]) ? QueueArray[i].sFileName.GetString() : _T("");
d2869 1
a2869 1
					_stprintf(HTTPTempC, _T("%i") , QueueArray[i].nScore);
d2873 5
a2877 6
				HTTPProcessData.Replace(_T("[ClientState]"), QueueArray[i].sClientState);
				HTTPProcessData.Replace(_T("[ClientStateSpecial]"), QueueArray[i].sClientStateSpecial);
				HTTPProcessData.Replace(_T("[ClientSoft]"), QueueArray[i].sClientSoft);
				HTTPProcessData.Replace(_T("[ClientSoftSpecial]"), QueueArray[i].sClientSoftSpecial);
				HTTPProcessData.Replace(_T("[ClientExtra]"), QueueArray[i].sClientExtra);
				HTTPProcessData.Replace(_T("[UserHash]"), QueueArray[i].sUserHash);
d2900 1
a2900 1
			if (QueueArray[i].sClientExtra == _T("banned"))
d2903 1
a2903 1
				pcTmp = (!WSqueueColumnHidden[0]) ? QueueArray[i].sUserName.GetString() : _T("");
d2906 1
a2906 1
				pcTmp = (!WSqueueColumnHidden[1]) ? QueueArray[i].sClientNameVersion.GetString() : _T("");
d2909 1
a2909 1
				pcTmp = (!WSqueueColumnHidden[2]) ? QueueArray[i].sFileName.GetString() : _T("");
d2915 1
a2915 1
					_stprintf(HTTPTempC, _T("%i") , QueueArray[i].nScore);
d2920 5
a2924 6
				HTTPProcessData.Replace(_T("[ClientState]"), QueueArray[i].sClientState);
				HTTPProcessData.Replace(_T("[ClientStateSpecial]"), QueueArray[i].sClientStateSpecial);
				HTTPProcessData.Replace(_T("[ClientSoft]"), QueueArray[i].sClientSoft);
				HTTPProcessData.Replace(_T("[ClientSoftSpecial]"), QueueArray[i].sClientSoftSpecial);
				HTTPProcessData.Replace(_T("[ClientExtra]"), QueueArray[i].sClientExtra);
				HTTPProcessData.Replace(_T("[UserHash]"), QueueArray[i].sUserHash);
d2947 1
a2947 1
			if (QueueArray[i].sClientExtra == "friend")
d2950 1
a2950 1
				pcTmp = (!WSqueueColumnHidden[0]) ? QueueArray[i].sUserName.GetString() : _T("");
d2953 1
a2953 1
				pcTmp = (!WSqueueColumnHidden[1]) ? QueueArray[i].sClientNameVersion.GetString() : _T("");
d2956 1
a2956 1
				pcTmp = (!WSqueueColumnHidden[2]) ? QueueArray[i].sFileName.GetString() : _T("");
d2962 1
a2962 1
					_stprintf(HTTPTempC, _T("%i") , QueueArray[i].nScore);
d2967 5
a2971 6
				HTTPProcessData.Replace(_T("[ClientState]"), QueueArray[i].sClientState);
				HTTPProcessData.Replace(_T("[ClientStateSpecial]"), QueueArray[i].sClientStateSpecial);
				HTTPProcessData.Replace(_T("[ClientSoft]"), QueueArray[i].sClientSoft);
				HTTPProcessData.Replace(_T("[ClientSoftSpecial]"), QueueArray[i].sClientSoftSpecial);
				HTTPProcessData.Replace(_T("[ClientExtra]"), QueueArray[i].sClientExtra);
				HTTPProcessData.Replace(_T("[UserHash]"), QueueArray[i].sUserHash);
d2994 1
a2994 1
			if (QueueArray[i].sClientExtra == _T("credit"))
d2997 1
a2997 1
				pcTmp = (!WSqueueColumnHidden[0]) ? QueueArray[i].sUserName.GetString() : _T("");
d3000 1
a3000 1
				pcTmp =  (!WSqueueColumnHidden[1]) ? QueueArray[i].sClientNameVersion.GetString() : _T("");
d3003 1
a3003 1
				pcTmp =  (!WSqueueColumnHidden[2]) ? QueueArray[i].sFileName.GetString() : _T("");
d3009 1
a3009 1
					_stprintf(HTTPTempC, _T("%i") , QueueArray[i].nScore);
d3014 5
a3018 6
				HTTPProcessData.Replace(_T("[ClientState]"), QueueArray[i].sClientState);
				HTTPProcessData.Replace(_T("[ClientStateSpecial]"), QueueArray[i].sClientStateSpecial);
				HTTPProcessData.Replace(_T("[ClientSoft]"), QueueArray[i].sClientSoft);
				HTTPProcessData.Replace(_T("[ClientSoftSpecial]"), QueueArray[i].sClientSoftSpecial);
				HTTPProcessData.Replace(_T("[ClientExtra]"), QueueArray[i].sClientExtra);
				HTTPProcessData.Replace(_T("[UserHash]"), QueueArray[i].sUserHash);
@


1.356
log
@Added support for sending the HTTP/1.1 header "Cache-Control: max-age" for file requests.
Added easy controls for file caching time.
@
text
@d389 22
a410 2
	CString filename=Data.sURL;
	CString contenttype;
d412 5
a416 36
	if (filename.Right(4).MakeLower()==".gif") contenttype="Content-Type: image/gif\r\n";
	else if (filename.Right(4).MakeLower()==".jpg"  || filename.Right(5).MakeLower()==".jpeg")
		contenttype="Content-Type: image/jpg\r\n";
	else if (filename.Right(4).MakeLower()==".bmp")
		contenttype="Content-Type: image/bmp\r\n";
	else if (filename.Right(4).MakeLower()==".png")
		contenttype="Content-Type: image/png\r\n";
	else if (filename.Right(4).MakeLower()==".ico")
		contenttype="Content-Type: image/x-icon\r\n";
	else if (filename.Right(4).MakeLower()==".css")
		contenttype="Content-Type: text/css\r\n";
	else if (filename.Right(3).MakeLower()==".js")
		contenttype="Content-Type: text/javascript\r\n";
	else if (filename.Right(4).MakeLower()==".xml")
		contenttype="Content-Type: text/xml\r\n";
	else if (filename.Right(4).MakeLower()==".txt")
		contenttype="Content-Type: text/plain\r\n";

	contenttype += _T("Last-Modified: ") + pThis->m_Params.sLastModified + _T("\r\n") + _T("ETag: ") + pThis->m_Params.sETag + _T("\r\n");

	// DonGato: expire images after 30 days (can be override by browser)
	// Controls for file caching expiry time
	int iExp_M	= 1; //Months
	int iExp_D	= 0; //Days
	int iExp_h	= 0; //Hours
	int iExp_m	= 0; //Minutes
	int iExp_s	= 0; //Seconds
	
	// Calculate expiry time in seconds
	int iExpireDelta  = iExp_s;
	iExpireDelta += 60*iExp_m;
	iExpireDelta += 60*60*iExp_h;
	iExpireDelta += 60*60*24*iExp_D;
	iExpireDelta += 60*60*24*30*iExp_M;
	
	// HTTP/1.0 header "Expires:"
d419 13
a431 3
	CTime t = CTime::GetCurrentTime();
	t += iExpireDelta;
	CString expires = t.FormatGmt("%a, %d %b %Y %H:%M:%S GMT");
a432 1
	contenttype += _T("Expires: ") + expires + _T("\r\n");
d434 4
a437 6
	// HTTP/1.1 header "Cache-Control: max-age"
	// Overrides "Expires:" only if the client understands it
	// Is more accurate than "Expires:"
	CString strExpireDelta;
	strExpireDelta.Format(_T("%u"), iExpireDelta);
	contenttype += _T("Cache-Control: max-age=") + expire_delta_str + _T("\r\n");
d440 2
a441 2
	filename.Replace('/','\\');
	filename=CString(g_App.m_pPrefs->GetAppDir())+_T("WebServer\\")+filename;
d445 4
a448 2
		TCHAR* buffer=new TCHAR[file.GetLength()];
		int size=file.Read(buffer,file.GetLength());
d450 1
a450 1
		Data.pSocket->SendContent(contenttype, buffer, size);
@


1.355
log
@Added log messages to measure WS performance.
@
text
@d413 15
d431 1
a431 1
	t += 60*60*24*30;
d436 7
@


1.354
log
@UNICODE preparation (first shot)
@
text
@d540 3
d654 3
d665 3
@


1.353
log
@Removed processing of unsupported limitless upload.
@
text
@d292 1
a292 1
void CWebServer::_SetSharedFileJumpstart(CString hash)
d296 1
a296 4
	CKnownFile* cur_file;
	uchar fileid[16];
	if (hash.GetLength()!=32 || !DecodeBase16(hash.GetBuffer(),hash.GetLength(),fileid,ARRSIZE(fileid)))
		return;
d298 3
a300 4
	cur_file=g_App.m_pSharedFilesList->GetFileByID(fileid);

	if (cur_file==0)
 		return;
d302 2
d305 3
a307 3
//	Don't allow to enable JumpStart for small files
	if (cur_file->GetFileSize() > PARTSIZE)
		cur_file->SetJumpstartEnabled(true);
d310 3
a312 1
	g_App.m_pSharedFilesList->UpdateItem(cur_file);
d317 1
a317 1
void CWebServer::_SetSharedFileNoJumpstart(CString hash)
d321 1
a321 2
	CKnownFile* cur_file;
	uchar fileid[16];
d323 3
a325 7
	if (hash.GetLength()!=32 || !DecodeBase16(hash.GetBuffer(),hash.GetLength(),fileid,ARRSIZE(fileid)))
		return;

	cur_file=g_App.m_pSharedFilesList->GetFileByID(fileid);

	if (cur_file==0)
 		return;
d327 2
d330 1
a330 1
	cur_file->SetJumpstartEnabled(false);
d333 3
a335 1
	g_App.m_pSharedFilesList->UpdateItem(cur_file);
d3223 1
a3223 1
	if(!_ParseURL(Data.sURL, _T("hash")).IsEmpty() && !_ParseURL(Data.sURL, _T("prio")).IsEmpty() && IsSessionAdmin(Data,sSession))
d3225 3
a3227 4
		CKnownFile* cur_file;
		uchar fileid[16];
		CString hash = _ParseURL(Data.sURL, _T("hash"));
		if (hash.GetLength()==32 && DecodeBase16(hash.GetBuffer(),hash.GetLength(),fileid,ARRSIZE(fileid)))
d3229 1
a3229 1
			cur_file = g_App.m_pSharedFilesList->GetFileByID(fileid);
d3231 1
a3231 1
			if (cur_file != 0)
d3233 1
a3233 1
				cur_file->SetAutoULPriority(false);
d3236 1
a3236 1
					cur_file->SetULPriority(PR_VERYLOW);
d3238 1
a3238 1
					cur_file->SetULPriority(PR_LOW);
d3240 1
a3240 1
					cur_file->SetULPriority(PR_NORMAL);
d3242 1
a3242 1
					cur_file->SetULPriority(PR_HIGH);
d3244 1
a3244 1
					cur_file->SetULPriority(PR_RELEASE);
d3247 2
a3248 2
					cur_file->SetAutoULPriority(true);
					cur_file->UpdateUploadAutoPriority();
d3251 1
a3251 1
				g_App.m_pSharedFilesList->UpdateItem(cur_file); // refresh GUI on priority change
d3638 2
a3639 5
		CKnownFile* cur_file;
		uchar fileid[16];
		if (hash.GetLength()==32 && DecodeBase16(hash.GetBuffer(),hash.GetLength(),fileid,ARRSIZE(fileid)))
			HTTPProcessData.Replace(_T("[hash]"), hash);
		cur_file=g_App.m_pSharedFilesList->GetFileByID(fileid);
d3641 1
a3641 2
#ifdef OLD_SOCKETS_ENABLED
		if (cur_file != NULL)
d3643 4
a3646 1
 			if (cur_file->GetJumpstartEnabled())
d3648 9
a3656 2
				isjumpstart = _T("jumpstart");
				HTTPProcessData.Replace(_T("[FileIsPriority]"), _T("jumpstart"));
a3657 4
			else if (cur_file->GetULPriority() == PR_RELEASE)
				HTTPProcessData.Replace(_T("[FileIsPriority]"), _T("release"));
			else
				HTTPProcessData.Replace(_T("[FileIsPriority]"), _T("none"));
d4463 1
a4463 1
CString CWebServer::_GetDownloadGraph(ThreadData Data, CString filehash)
d4467 3
a4469 2
	CWebServer *pThis = (CWebServer *)Data.pThis;
	if(pThis == NULL)
d4472 3
a4474 3
	CPartFile* pPartFile;
	uchar fileid[16];
	if (filehash.GetLength()!=32 || !DecodeBase16(filehash.GetBuffer(), filehash.GetLength(), fileid,ARRSIZE(fileid)))
d4477 3
a4479 4
	CString Out;
	CString progresscolor[12];

	pPartFile = g_App.m_pDownloadQueue->GetFileByID(fileid);
d4568 1
a4568 2
		CString downloads=_ParseURLArray(Data.sURL,_T("downloads"));

d4570 9
a4578 11

		CString resToken;
		int curPos=0;
		resToken= downloads.Tokenize(_T("|"),curPos);

		while (!resToken.IsEmpty())
		{
			uchar fileid[16];
			if (resToken.GetLength()==32 && DecodeBase16(resToken.GetBuffer(),resToken.GetLength(),fileid,ARRSIZE(fileid)))
				g_App.m_pSearchList->AddFileToDownloadByHash(fileid,eCatID);
			resToken= downloads.Tokenize(_T("|"),curPos);
@


1.352
log
@Increased template version.
@
text
@d4193 1
a4193 2
	dwNum = g_App.m_pPrefs->GetMaxUpload();
	FractionalRate2String(&sT, (dwNum == UNLIMITED) ? 0 : dwNum);
@


1.351
log
@UNICODE preparation (first shot)
@
text
@d21 1
a21 1
#define WEB_SERVER_TEMPLATES_VERSION	1007
@


1.350
log
@Unicode corrections; Improved string processing;
Removed unused variables/code; Formatting.
@
text
@d156 5
a160 5
			m_Templates.sCatArrow= _LoadTemplate(sAll,"TMPL_CATARROW");
			m_Templates.sDownArrow= _LoadTemplate(sAll,"TMPL_DOWNARROW");
			m_Templates.sUpArrow= _LoadTemplate(sAll,"TMPL_UPARROW");
			m_Templates.strDownDoubleArrow = _LoadTemplate(sAll,"TMPL_DNDOUBLEARROW");
			m_Templates.strUpDoubleArrow = _LoadTemplate(sAll,"TMPL_UPDOUBLEARROW");
d818 1
a818 1
		Out.Replace("[CATBOX]", _T(""));
d1005 1
a1005 1
	
d1082 2
a1083 2
		int iMenu = atoi(_ParseURL(Data.sURL, _T("m")));
		bool bValue = atoi(_ParseURL(Data.sURL, _T("v")));
d1583 1
a1583 1
	
d2604 1
a2604 1
            HTTPProcessData.Replace(_T("[LastChangedDataset]"), "checked");
d2606 1
a2606 1
            HTTPProcessData.Replace(_T("[LastChangedDataset]"), "checked_no");
d2800 1
a2800 1
	HTTPTemp.Format( _T("%s: %i, %s: %i"), GetResString(IDS_SF_FILE), g_App.m_pDownloadQueue->GetFileCount(), 
d2918 1
a2918 1
		
d2966 1
a2966 1
		
d3177 1
a3177 1
	
d3261 2
a3262 2
		int iMenu = atoi(_ParseURL(Data.sURL, _T("m")));
		bool bValue = atoi(_ParseURL(Data.sURL, _T("v")));
d3265 1
a3265 1
		fullpath.Format(_T("%spreferences.ini"),g_App.m_pPrefs->GetConfigDir());
d3818 1
a3818 1
	
d3910 1
a3910 1
	
d3913 1
a3913 1
	
d3947 1
a3947 1
	
d3984 1
a3984 1
	
d3987 1
a3987 1
	
d4046 1
a4046 1
	
d4202 1
a4202 1
	
d4589 1
a4589 1
	
d4621 1
a4621 1
	
d4631 3
a4633 2
		int iMenu = atoi(_ParseURL(Data.sURL, _T("m")));
		bool bValue = atoi(_ParseURL(Data.sURL, _T("v")));
d4635 6
a4640 3
		CString fullpath;
		fullpath.Format(_T("%spreferences.ini"),g_App.m_pPrefs->GetConfigDir());
		CIni ini(fullpath);
@


1.349
log
@Removed unused code.
@
text
@a456 6
	bool isUseGzip = g_App.m_pPrefs->GetWebUseGzip();
	CString Out;
	CString OutE;	// List Entry Templates
	CString OutS;	// ServerStatus Templates
	TCHAR *gzipOut = NULL;
	long gzipLen=0;
d458 6
a463 2
	CString HTTPProcessData;
	srand ( time(NULL) );
d471 1
a471 1
	((dwCurTick - pThis->m_nStartTempDisabledTime) > (g_App.m_pPrefs->GetWSTempDisableLogin() * 60000)))
d507 7
a513 5
				pThis->m_nIntruderDetect++;
				AddLogLine(true, RGB_LOG_NOTICE + GetResString(IDS_WEB_INTRTRIESLEFT), t_ulCurIP, g_App.m_pPrefs->GetWSLoginAttemptsAllowed()-(pThis->m_nIntruderDetect));
				if (pThis->m_nIntruderDetect == g_App.m_pPrefs->GetWSLoginAttemptsAllowed())
				{
					AddLogLine(true, RGB_LOG_NOTICE + GetResString(IDS_WEB_INTRDETECTION), pThis->m_nIntruderDetect);
d516 1
a516 1
					pThis->m_nStartTempDisabledTime = ::GetTickCount();
a519 1
					CString MessageText;
a520 2
					g_App.m_pSMTPConnection->SendMail(MessageText, g_App.m_pPrefs->GetNotifierPopOnWebServerError(), g_App.m_pPrefs->IsSMTPWarningEnabled());
	                g_App.m_pMDlg->ShowNotifier(MessageText, TBN_WEBSERVER, false, g_App.m_pPrefs->GetNotifierPopOnWebServerError());
d525 1
a525 1
		            pThis->m_bServerWorking = false;
d529 1
a529 4
					CString MessageText;
					MessageText.Format(GetResString(IDS_WEB_INTRWEBDISABLE));
					g_App.m_pSMTPConnection->SendMail(MessageText, g_App.m_pPrefs->GetNotifierPopOnWebServerError(), g_App.m_pPrefs->IsSMTPWarningEnabled());
	                g_App.m_pMDlg->ShowNotifier(MessageText, TBN_WEBSERVER, false, g_App.m_pPrefs->GetNotifierPopOnWebServerError());
d531 2
d540 2
a541 3
	CString sSession; sSession.Format(_T("%ld"), lSession);

	if (_ParseURL(Data.sURL, _T("w")) == "logout")
d546 1
a546 1
		if (_ParseURL(Data.sURL, _T("w")) == "close")
d549 1
a549 1
			SendMessage(g_App.m_pMDlg->m_hWnd,WM_CLOSE,0,0);
d551 1
a551 1
		else if (_ParseURL(Data.sURL, _T("w")) == "shutdown")
d554 1
a554 1
			TOKEN_PRIVILEGES tkp;	// Get a token for this process.
d570 1
a570 1
		else if (_ParseURL(Data.sURL, _T("w")) == "reboot")
d591 1
a591 2
		CString sPage = _ParseURL(Data.sURL, _T("w"));
		if (sPage == _T("server"))
d593 1
a593 1
		else if (sPage == _T("shared"))
d595 1
a595 1
		else if (sPage == _T("transfer"))
d597 1
a597 1
		else if (sPage == _T("search"))
d599 1
a599 1
		else if (sPage == _T("graphs"))
d601 1
a601 1
		else if (sPage == _T("log"))
d603 1
a603 1
		if (sPage == _T("sinfo"))
d605 1
a605 1
		if (sPage == _T("debuglog"))
d607 1
a607 1
		if (sPage == _T("stats"))
d609 1
a609 1
		if (sPage == _T("options"))
d616 1
a616 1
		if (sPage.IsEmpty())
d661 1
d857 1
a857 1
	CString HTTPConState,HTTPConText,HTTPHelp;
d862 1
a862 1
	TCHAR HTTPHeader[100] = _T("");
d881 1
a881 1
		HTTPConState = "connecting";
d886 1
a886 4
		if(!g_App.m_pServerConnect->IsLowID())
			HTTPConState = "high";
		else
			HTTPConState = "low";
d905 1
a905 1
		HTTPConState = "disconnected";
d921 1
a921 1
	Out.Replace(_T("[ConState]"), HTTPConState);
d1095 1
a1095 1
	CString sSort = _ParseURL(Data.sURL, _T("sort"));
d1097 1
a1097 1
	if (!sSort.IsEmpty())
d1101 1
a1101 1
		if(sSort == "state")
d1103 1
a1103 1
		else if(sSort == "name")
d1108 1
a1108 1
		else if(sSort == "ip")
d1110 1
a1110 1
		else if(sSort == "description")
d1115 1
a1115 1
		else if(sSort == "ping")
d1117 1
a1117 1
		else if(sSort == "users")
d1119 1
a1119 1
		else if(sSort == "files")
d1121 1
a1121 1
		else if(sSort == "priority")
d1123 1
a1123 1
		else if(sSort == "failed")
d1125 1
a1125 1
		else if(sSort == "limit")
d1127 1
a1127 1
		else if(sSort == "version")
@


1.348
log
@Fix for WS, and changed to post ed2k link.
@
text
@a33 1
static dwThread = 0;
a68 1
	dwThread = GetCurrentThreadId();
@


1.347
log
@Removed unused tags {roytam1}.
@
text
@d793 4
@


1.346
log
@Corrected some WebServer incorrections related to '&' {morphis}.
@
text
@a4674 4
	Out.Replace(_T("[Collection]"), _GetPlainResString(IDS_COLLECTION));
	Out.Replace(_T("[Ascending]"), _GetPlainResString(IDS_ASCENDING));
	Out.Replace(_T("[Relevance]"), _GetPlainResString(IDS_RELEVANCE));
	Out.Replace(_T("[Match]"), _GetPlainResString(IDS_MATCH));
@


1.345
log
@WebServer: fixed appearance of 'Get first/last chunks for preview' menu {muleteer};
More secure check for complete file status -- consider completing as complete (like in GUI).
@
text
@d1918 1
a1918 1
	strTmp = (pThis->m_Params.bDownloadSortReverse) ? _T("&sortreverse=false") : _T("&sortreverse=true");
d1965 1
a1965 1
	strTmp = (pThis->m_Params.bUploadSortReverse) ? _T("&sortreverse=false") : _T("&sortreverse=true");
d3090 1
a3090 1
	strTmp = (pThis->m_Params.bQueueSortReverse) ? _T("&sortreverse=false") : _T("&sortreverse=true");
@


1.344
log
@WebServer: fixed nested form tags [morphis/Aw3].
@
text
@d2243 1
d2256 1
d2260 1
a2267 1
					break;
d2281 1
a2281 2
			dFile.bIsComplete = !pPartFile->IsPartFile();
			dFile.bIsPreview = pPartFile->PreviewAvailable();
d2603 1
a2615 1
		CString isgetflc;		//getflc
d2637 1
a2637 1
		if (FilesArray[i].bIsPreview)
d2681 1
a2681 1
		if (!FilesArray[i].bIsPreview && FilesArray[i].bIsGetFLC && !FilesArray[i].bIsComplete)
@


1.343
log
@WebServer show remote date/time for another time zone {Fuxie - DK}.
@
text
@d4808 1
a4808 1
		_T("<form><select name=\"cat\" size=\"1\"")
d4810 1
a4810 1
		_T("<form><select name=\"cat\" size=\"1\">");
d4828 1
a4828 1
	strTmp += _T("</select></form>");
@


1.342
log
@Inverted tooltips for toolbar scrolling.
@
text
@d965 5
@


1.341
log
@Corrected WebServer incorrections related to '&' for [Session] tag {morphis};
Improved string processin.
@
text
@d875 1
a875 1
	Out.Replace(_T("[MenuLockTitle]"), _GetPlainResString(pThis->m_Params.bMenuLocked ? IDS_MENULOCK_ON : IDS_MENULOCK_OFF));
@


1.340
log
@Renaming in comments.
@
text
@d819 1
a819 1
		InsertCatBox(Out, 0, pThis->m_Templates.sCatArrow, false, false, sSession, "");
d821 1
a821 1
		Out.Replace("[CATBOX]",_T(""));
d914 1
a914 1
			HTTPConText.AppendFormat(_T(" (<a href=\"/?ses=%s&w=server&c=connect\">%s</a>)"), sSession, _GetPlainResString(IDS_CONNECTTOANYSERVER));
d4562 4
a4565 3
	byte cat = _tstoi(_ParseURL(Data.sURL, _T("cat")));
	CString sSession = _ParseURL(Data.sURL, _T("ses"));
	CString Out = pThis->m_Templates.sSearch;
d4567 1
a4567 1
	if (!_ParseURL(Data.sURL, _T("downloads")).IsEmpty() && IsSessionAdmin(Data,sSession))
d4595 1
a4595 1
	if (sCmd.CompareNoCase(_T("update")) == 0 && IsSessionAdmin(Data,sSession))
d4601 1
a4601 1
	if(!_ParseURL(Data.sURL, _T("tosearch")).IsEmpty() && IsSessionAdmin(Data,sSession) )
d4615 1
a4615 1
	else if(!_ParseURL(Data.sURL, _T("tosearch")).IsEmpty() && !IsSessionAdmin(Data,sSession))
d4796 1
a4796 1
void CWebServer::InsertCatBox(CString &Out,int preselect,CString boxlabel,bool jump,bool extraCats,CString sSession,CString sFileHash)
d4800 1
a4800 1
	CString	strCategory, strTmp(boxlabel);
d4846 1
a4846 1
		strTmp.AppendFormat(_T("<a href=&quot;/?ses=%s&w=transfer&cat=%d&quot;>")
d4848 1
a4848 1
			sSession, i, tempBuff3, strCategory);
d4862 1
a4862 1
			strTmp.AppendFormat(_T("<a href=&quot;/?ses=%s&w=transfer&cat=%d&quot;>")
d4864 1
a4864 1
				sSession, i + CAT_PREDEFINED, tempBuff3, GetSubCatLabel(i));
d4872 3
d4878 3
a4880 7
		uchar FileHash[16];

		CPartFile *found_file = g_App.m_pDownloadQueue->GetFileByID(StringToHash(sFileHash, FileHash));
	//	Get the user category index of 'found_file' in 'preselect'.
		if (found_file)
			preselect = CCat::GetUserCatIndexByID(found_file->GetCatID());
			//preselect = (CCat::GetUserCatIndexByID(found_file->GetCatID()) == 255)? 0 : CCat::GetUserCatIndexByID(found_file->GetCatID());
d4887 1
a4887 1
		strTmp.AppendFormat(_T("<a href=&quot;/?ses=%s&w=transfer[CatSel]&op=setcat&file=%s&filecat=%d&quot;>")
d4889 1
a4889 1
			sSession, sFileHash, i, tempBuff3, strCategory);
@


1.339
log
@renamed g_pPrefs->m_pPrefs (f... paste & copy :( )
@
text
@d452 1
a452 1
	// data without any syncronization!! Either we use the message pump for m_pdlgEmule
@


1.338
log
@renamed 3 variables
@
text
@d62 1
a62 1
	m_Params.bMenuLocked = g_App.g_pPrefs->GetWSMenuLocked();
d86 1
a86 1
	CString sFile = g_App.g_pPrefs->GetTemplate();
d88 1
a88 1
		sFile = g_App.g_pPrefs->GetAppDir() + CString("eMuleXP.tmpl");
d108 1
a108 1
			if(g_App.g_pPrefs->GetWSIsEnabled() || m_bServerWorking)
d113 1
a113 1
			g_App.g_pPrefs->SetWSIsEnabled(false);
d175 1
a175 1
		g_App.g_pPrefs->SetWSIsEnabled(false);
d191 1
a191 1
	fullpath.Format(_T("%spreferences.ini"),g_App.g_pPrefs->GetConfigDir());
d234 2
a235 2
	if(m_bServerWorking != g_App.g_pPrefs->GetWSIsEnabled())
		m_bServerWorking = g_App.g_pPrefs->GetWSIsEnabled();
d253 1
a253 1
	if(g_App.g_pPrefs->GetWSIsEnabled() && m_bServerWorking)
d426 1
a426 1
	filename=CString(g_App.g_pPrefs->GetAppDir())+_T("WebServer\\")+filename;
d448 1
a448 1
	SetThreadLocale(g_App.g_pPrefs->GetLanguageID());
d459 1
a459 1
	bool isUseGzip = g_App.g_pPrefs->GetWebUseGzip();
d475 1
a475 1
	((dwCurTick - pThis->m_nStartTempDisabledTime) > (g_App.g_pPrefs->GetWSTempDisableLogin() * 60000)))
d488 1
a488 1
		if (md4cmp(MD5Sum(_ParseURL(Data.sURL, _T("p")), abyteDigest), g_App.g_pPrefs->GetWSPass(abyteWSPass)) == 0)
d498 2
a499 2
		else if ( g_App.g_pPrefs->GetWSIsLowUserEnabled() &&
			(md4cmp(abyteDigest, g_App.g_pPrefs->GetWSLowPass(abyteWSPass)) == 0) )
d509 1
a509 1
		else if(g_App.g_pPrefs->IsWSIntruderDetectionEnabled())
d512 2
a513 2
				AddLogLine(true, RGB_LOG_NOTICE + GetResString(IDS_WEB_INTRTRIESLEFT), t_ulCurIP, g_App.g_pPrefs->GetWSLoginAttemptsAllowed()-(pThis->m_nIntruderDetect));
				if (pThis->m_nIntruderDetect == g_App.g_pPrefs->GetWSLoginAttemptsAllowed())
d516 1
a516 1
				if (g_App.g_pPrefs->GetWSTempDisableLogin() > 0)
d520 1
a520 1
					pThis->AddLogLine(true, RGB_LOG_NOTICE + GetResString(IDS_WEB_INTRBLOCKTIME), g_App.g_pPrefs->GetWSTempDisableLogin());
d523 3
a525 3
					MessageText.Format(GetResString(IDS_WEB_INTRBLOCKTIME), g_App.g_pPrefs->GetWSTempDisableLogin());
					g_App.m_pSMTPConnection->SendMail(MessageText, g_App.g_pPrefs->GetNotifierPopOnWebServerError(), g_App.g_pPrefs->IsSMTPWarningEnabled());
	                g_App.m_pMDlg->ShowNotifier(MessageText, TBN_WEBSERVER, false, g_App.g_pPrefs->GetNotifierPopOnWebServerError());
d529 1
a529 1
					g_App.g_pPrefs->SetWSIsEnabled(false);
d536 2
a537 2
					g_App.m_pSMTPConnection->SendMail(MessageText, g_App.g_pPrefs->GetNotifierPopOnWebServerError(), g_App.g_pPrefs->IsSMTPWarningEnabled());
	                g_App.m_pMDlg->ShowNotifier(MessageText, TBN_WEBSERVER, false, g_App.g_pPrefs->GetNotifierPopOnWebServerError());
d784 1
a784 1
		sRefresh.Format(_T("%d"), g_App.g_pPrefs->GetWebPageRefresh()*1000);
d787 1
a787 1
	strVersionCheck.Format(_T("http://emuleplus.info/version_check.php?version=%i&language=%i"),CURRENT_PLUS_VERSION,g_App.g_pPrefs->GetLanguageID());
d793 1
a793 1
	Out.Replace(_T("[Nick]"), _SpecialChars(g_App.g_pPrefs->GetUserNick()));
d872 1
a872 1
		g_App.g_pPrefs->SetWSMenuLocked(pThis->m_Params.bMenuLocked);
d929 1
a929 1
	_stprintf(HTTPHeader, _T("%.f"), static_cast<double>(100 * g_App.m_pUploadQueue->GetDataRate()) / 102.4 / g_App.g_pPrefs->GetMaxUpload());
d932 2
a933 2
	if(g_App.g_pPrefs->GetMaxDownload() == UNLIMITED)
		_stprintf(HTTPHeader, _T("%.f"), static_cast<double>(100 * g_App.m_pDownloadQueue->GetDataRate()) / 102.4 / g_App.g_pPrefs->GetMaxGraphDownloadRate());
d935 1
a935 1
		_stprintf(HTTPHeader, _T("%.f"), static_cast<double>(100 * g_App.m_pDownloadQueue->GetDataRate()) / 102.4 / g_App.g_pPrefs->GetMaxDownload());
d938 1
a938 1
	dwMax = g_App.g_pPrefs->GetMaxConnections();
d949 1
a949 1
	FractionalRate2String(&HTTPHelp, g_App.g_pPrefs->GetMaxUpload());
d952 1
a952 1
	dwMax = g_App.g_pPrefs->GetMaxDownload();
d959 1
a959 1
	HTTPHelp.Format(_T("%u"), g_App.g_pPrefs->GetMaxConnections());
d1087 1
a1087 1
		fullpath.Format(_T("%spreferences.ini"),g_App.g_pPrefs->GetConfigDir());
d1639 1
a1639 1
		fullpath.Format(_T("%spreferences.ini"),g_App.g_pPrefs->GetConfigDir());
d1652 1
a1652 1
		fullpath.Format(_T("%spreferences.ini"),g_App.g_pPrefs->GetConfigDir());
d1665 1
a1665 1
		fullpath.Format(_T("%spreferences.ini"),g_App.g_pPrefs->GetConfigDir());
d2287 1
a2287 1
			if ( g_App.g_pPrefs->DoPausedStoppedLast() &&
d3265 1
a3265 1
		fullpath.Format(_T("%spreferences.ini"),g_App.g_pPrefs->GetConfigDir());
d3790 1
a3790 1
	Out.Replace(_T("[ScaleTime]"), CastSecondsToHM(g_App.g_pPrefs->GetTrafficOMeterInterval() * WEB_GRAPH_WIDTH));
d3793 1
a3793 1
	s1.Format(_T("%u"), g_App.g_pPrefs->GetMaxGraphDownloadRate() / 10);
d3795 1
a3795 1
	s1.Format(_T("%u"), g_App.g_pPrefs->GetMaxGraphUploadRate() / 10);
d3797 1
a3797 1
	s1.Format(_T("%u"), g_App.g_pPrefs->GetMaxConnections());
d4058 1
a4058 1
			g_App.g_pPrefs->SetWebUseGzip(true);
d4060 1
a4060 1
			g_App.g_pPrefs->SetWebUseGzip(false);
d4078 1
a4078 1
			g_App.g_pPrefs->SetWebPageRefresh(_tstoi(_ParseURL(Data.sURL, _T("refresh"))));
d4082 1
a4082 1
			g_App.g_pPrefs->SetMaxGraphDownloadRate(ValidateDownCapability(10 * _tstoi(strTmp)));
d4085 1
a4085 1
			g_App.g_pPrefs->SetMaxGraphUploadRate(ValidateUpCapability(10 * _tstoi(strTmp)));
d4095 2
a4096 2
				g_App.g_pPrefs->SetMaxDownloadWithCheck(dwSpeed);
				g_App.g_pPrefs->SetLimitlessDownload(false);	//SyruS disable limitless on setting a specific value
d4099 1
a4099 1
				g_App.g_pPrefs->SetLimitlessDownload(true);	//SyruS enable limitless on setting to 0
d4106 1
a4106 1
				g_App.g_pPrefs->SetMaxUploadWithCheck(dwSpeed);
d4110 1
a4110 1
			g_App.g_pPrefs->SetMaxSourcePerFile(_tstoi(_ParseURL(Data.sURL, _T("maxsources"))));
d4112 1
a4112 1
			g_App.g_pPrefs->SetMaxConnections(_tstoi(_ParseURL(Data.sURL, _T("maxconnections"))));
d4114 1
a4114 1
			g_App.g_pPrefs->SetMaxDownloadConperFive(_tstoi(_ParseURL(Data.sURL, _T("maxconnectionsperfive"))));
d4118 1
a4118 1
	if(g_App.g_pPrefs->GetWebUseGzip())
d4140 1
a4140 1
	sRefresh.Format(_T("%d"), g_App.g_pPrefs->GetWebPageRefresh());
d4143 1
a4143 1
	sRefresh.Format(_T("%d"), g_App.g_pPrefs->GetMaxSourcePerFile());
d4146 1
a4146 1
	sRefresh.Format(_T("%d"), g_App.g_pPrefs->GetMaxConnections());
d4149 1
a4149 1
	sRefresh.Format(_T("%d"), g_App.g_pPrefs->GetMaxConPerFive());
d4189 1
a4189 1
	uint32	dwNum = (g_App.g_pPrefs->LimitlessDownload()) ? UNLIMITED : g_App.g_pPrefs->GetMaxDownload();
d4193 1
a4193 1
	dwNum = g_App.g_pPrefs->GetMaxUpload();
d4196 1
a4196 1
	sT.Format(_T("%u"), g_App.g_pPrefs->GetMaxGraphDownloadRate() / 10);
d4198 1
a4198 1
	sT.Format(_T("%u"), g_App.g_pPrefs->GetMaxGraphUploadRate() / 10);
d4225 1
a4225 1
	Out.Replace(_T("[Nick]"), _SpecialChars(g_App.g_pPrefs->GetUserNick()));
d4442 1
a4442 1
	switch (g_App.g_pPrefs->GetLanguageID())
d4596 1
a4596 1
		g_App.g_pPrefs->SetFakeListURL(_ParseURL(Data.sURL, _T("url")));
d4634 1
a4634 1
		fullpath.Format(_T("%spreferences.ini"),g_App.g_pPrefs->GetConfigDir());
d4680 1
a4680 1
	Out.Replace(_T("[FakeListUrl]"), g_App.g_pPrefs->GetFakeListURL());
d4685 1
a4685 1
		(g_App.g_pPrefs->GetSearchMethod() == EP_SEARCHMETHOD_GLOB) ? _T("checked") : _T(""));
@


1.337
log
@Removed unrequired fractional numbers for auto scale percentages {morphis};
Remove unsupported code related to unlimited upload rate and unlimited connections;
Improved string processing.
@
text
@d62 1
a62 1
	m_Params.bMenuLocked = g_eMuleApp.m_pGlobPrefs->GetWSMenuLocked();
d86 1
a86 1
	CString sFile = g_eMuleApp.m_pGlobPrefs->GetTemplate();
d88 1
a88 1
		sFile = g_eMuleApp.m_pGlobPrefs->GetAppDir() + CString("eMuleXP.tmpl");
d108 1
a108 1
			if(g_eMuleApp.m_pGlobPrefs->GetWSIsEnabled() || m_bServerWorking)
d113 1
a113 1
			g_eMuleApp.m_pGlobPrefs->SetWSIsEnabled(false);
d175 1
a175 1
		g_eMuleApp.m_pGlobPrefs->SetWSIsEnabled(false);
d191 1
a191 1
	fullpath.Format(_T("%spreferences.ini"),g_eMuleApp.m_pGlobPrefs->GetConfigDir());
d234 2
a235 2
	if(m_bServerWorking != g_eMuleApp.m_pGlobPrefs->GetWSIsEnabled())
		m_bServerWorking = g_eMuleApp.m_pGlobPrefs->GetWSIsEnabled();
d253 1
a253 1
	if(g_eMuleApp.m_pGlobPrefs->GetWSIsEnabled() && m_bServerWorking)
d265 1
a265 1
	CServer	*server = g_eMuleApp.m_pServerList->GetServerByAddress(sIP.GetBuffer(), nPort);
d267 1
a267 1
		g_eMuleApp.m_pdlgEmule->SendMessage(WEB_REMOVE_SERVER, (WPARAM)server, NULL);
d276 1
a276 1
	CServer	*server = g_eMuleApp.m_pServerList->GetServerByAddress(sIP.GetBuffer(), nPort);
d278 1
a278 1
		g_eMuleApp.m_pdlgEmule->SendMessage(WEB_ADD_TO_STATIC, (WPARAM)server, NULL);
d287 1
a287 1
	CServer	*server = g_eMuleApp.m_pServerList->GetServerByAddress(sIP.GetBuffer(), nPort);
d289 1
a289 1
		g_eMuleApp.m_pdlgEmule->SendMessage(WEB_REMOVE_FROM_STATIC, (WPARAM)server, NULL);
d303 1
a303 1
	cur_file=g_eMuleApp.m_pSharedFilesList->GetFileByID(fileid);
d314 1
a314 1
	g_eMuleApp.m_pSharedFilesList->UpdateItem(cur_file);
d329 1
a329 1
	cur_file=g_eMuleApp.m_pSharedFilesList->GetFileByID(fileid);
d338 1
a338 1
	g_eMuleApp.m_pSharedFilesList->UpdateItem(cur_file);
d378 2
a379 2
	CServer* server=g_eMuleApp.m_pServerList->GetServerByAddress(sIP.GetBuffer(), nPort);
	if (server!=NULL) g_eMuleApp.m_pdlgEmule->SendMessage(WEB_CONNECT_TO_SERVER, (WPARAM)server, NULL);
d426 1
a426 1
	filename=CString(g_eMuleApp.m_pGlobPrefs->GetAppDir())+_T("WebServer\\")+filename;
d448 1
a448 1
	SetThreadLocale(g_eMuleApp.m_pGlobPrefs->GetLanguageID());
d459 1
a459 1
	bool isUseGzip = g_eMuleApp.m_pGlobPrefs->GetWebUseGzip();
d475 1
a475 1
	((dwCurTick - pThis->m_nStartTempDisabledTime) > (g_eMuleApp.m_pGlobPrefs->GetWSTempDisableLogin() * 60000)))
d488 1
a488 1
		if (md4cmp(MD5Sum(_ParseURL(Data.sURL, _T("p")), abyteDigest), g_eMuleApp.m_pGlobPrefs->GetWSPass(abyteWSPass)) == 0)
d498 2
a499 2
		else if ( g_eMuleApp.m_pGlobPrefs->GetWSIsLowUserEnabled() &&
			(md4cmp(abyteDigest, g_eMuleApp.m_pGlobPrefs->GetWSLowPass(abyteWSPass)) == 0) )
d509 1
a509 1
		else if(g_eMuleApp.m_pGlobPrefs->IsWSIntruderDetectionEnabled())
d512 2
a513 2
				AddLogLine(true, RGB_LOG_NOTICE + GetResString(IDS_WEB_INTRTRIESLEFT), t_ulCurIP, g_eMuleApp.m_pGlobPrefs->GetWSLoginAttemptsAllowed()-(pThis->m_nIntruderDetect));
				if (pThis->m_nIntruderDetect == g_eMuleApp.m_pGlobPrefs->GetWSLoginAttemptsAllowed())
d516 1
a516 1
				if (g_eMuleApp.m_pGlobPrefs->GetWSTempDisableLogin() > 0)
d520 1
a520 1
					pThis->AddLogLine(true, RGB_LOG_NOTICE + GetResString(IDS_WEB_INTRBLOCKTIME), g_eMuleApp.m_pGlobPrefs->GetWSTempDisableLogin());
d523 3
a525 3
					MessageText.Format(GetResString(IDS_WEB_INTRBLOCKTIME), g_eMuleApp.m_pGlobPrefs->GetWSTempDisableLogin());
					g_eMuleApp.m_pSMTPConnection->SendMail(MessageText, g_eMuleApp.m_pGlobPrefs->GetNotifierPopOnWebServerError(), g_eMuleApp.m_pGlobPrefs->IsSMTPWarningEnabled());
	                g_eMuleApp.m_pdlgEmule->ShowNotifier(MessageText, TBN_WEBSERVER, false, g_eMuleApp.m_pGlobPrefs->GetNotifierPopOnWebServerError());
d529 1
a529 1
					g_eMuleApp.m_pGlobPrefs->SetWSIsEnabled(false);
d536 2
a537 2
					g_eMuleApp.m_pSMTPConnection->SendMail(MessageText, g_eMuleApp.m_pGlobPrefs->GetNotifierPopOnWebServerError(), g_eMuleApp.m_pGlobPrefs->IsSMTPWarningEnabled());
	                g_eMuleApp.m_pdlgEmule->ShowNotifier(MessageText, TBN_WEBSERVER, false, g_eMuleApp.m_pGlobPrefs->GetNotifierPopOnWebServerError());
d555 2
a556 2
			g_eMuleApp.m_app_state = g_eMuleApp.APP_STATE_SHUTINGDOWN;
			SendMessage(g_eMuleApp.m_pdlgEmule->m_hWnd,WM_CLOSE,0,0);
d784 1
a784 1
		sRefresh.Format(_T("%d"), g_eMuleApp.m_pGlobPrefs->GetWebPageRefresh()*1000);
d787 1
a787 1
	strVersionCheck.Format(_T("http://emuleplus.info/version_check.php?version=%i&language=%i"),CURRENT_PLUS_VERSION,g_eMuleApp.m_pGlobPrefs->GetLanguageID());
d793 1
a793 1
	Out.Replace(_T("[Nick]"), _SpecialChars(g_eMuleApp.m_pGlobPrefs->GetUserNick()));
d872 1
a872 1
		g_eMuleApp.m_pGlobPrefs->SetWSMenuLocked(pThis->m_Params.bMenuLocked);
d882 1
a882 1
	if ((g_eMuleApp.m_pServerConnect->IsConnecting() && !disconnectissued) || connectissued)
d887 1
a887 1
	else if (g_eMuleApp.m_pServerConnect->IsConnected() && !disconnectissued)
d889 1
a889 1
		if(!g_eMuleApp.m_pServerConnect->IsLowID())
d894 2
a895 2
		CServer	*pCurServer = g_eMuleApp.m_pServerConnect->GetCurrentServer();
		CServer	*cur_server = g_eMuleApp.m_pServerList->GetServerByAddress(
d918 1
a918 1
	for (uint32 sc = 0; sc < g_eMuleApp.m_pServerList->GetServerCount(); sc++)
d920 1
a920 1
		CServer	*cur_server = g_eMuleApp.m_pServerList->GetServerAt(sc);
d929 1
a929 1
	_stprintf(HTTPHeader, _T("%.f"), static_cast<double>(100 * g_eMuleApp.m_pUploadQueue->GetDataRate()) / 102.4 / g_eMuleApp.m_pGlobPrefs->GetMaxUpload());
d932 2
a933 2
	if(g_eMuleApp.m_pGlobPrefs->GetMaxDownload() == UNLIMITED)
		_stprintf(HTTPHeader, _T("%.f"), static_cast<double>(100 * g_eMuleApp.m_pDownloadQueue->GetDataRate()) / 102.4 / g_eMuleApp.m_pGlobPrefs->GetMaxGraphDownloadRate());
d935 1
a935 1
		_stprintf(HTTPHeader, _T("%.f"), static_cast<double>(100 * g_eMuleApp.m_pDownloadQueue->GetDataRate()) / 102.4 / g_eMuleApp.m_pGlobPrefs->GetMaxDownload());
d938 2
a939 2
	dwMax = g_eMuleApp.m_pGlobPrefs->GetMaxConnections();
	_stprintf(HTTPHeader, _T("%u"), (100 * g_eMuleApp.m_pListenSocket->GetNumOpenSockets() + dwMax / 2) / dwMax);
d941 1
a941 1
	_stprintf(HTTPHeader, _T("%.1f"), (static_cast<double>(g_eMuleApp.m_pUploadQueue->GetDataRate())/1024.0));
d943 1
a943 1
	_stprintf(HTTPHeader, _T("%.1f"), (static_cast<double>(g_eMuleApp.m_pDownloadQueue->GetDataRate())/1024.0));
d945 1
a945 1
	_stprintf(HTTPHeader, _T("%u"), g_eMuleApp.m_pListenSocket->GetNumOpenSockets());
d949 1
a949 1
	FractionalRate2String(&HTTPHelp, g_eMuleApp.m_pGlobPrefs->GetMaxUpload());
d952 1
a952 1
	dwMax = g_eMuleApp.m_pGlobPrefs->GetMaxDownload();
d959 1
a959 1
	HTTPHelp.Format(_T("%u"), g_eMuleApp.m_pGlobPrefs->GetMaxConnections());
d1020 1
a1020 1
			g_eMuleApp.m_pdlgEmule->SendMessage(WM_COMMAND, MP_CONNECT);
d1027 1
a1027 1
		if (g_eMuleApp.m_pServerConnect->IsConnecting())
d1029 2
a1030 2
			g_eMuleApp.m_pServerConnect->StopConnectionTry();
			g_eMuleApp.m_pdlgEmule->ShowConnectionState(false);
d1034 1
a1034 1
			g_eMuleApp.m_pdlgEmule->SendMessage(WM_COMMAND, MP_DISCONNECT);
d1055 1
a1055 1
			CServer* server=g_eMuleApp.m_pServerList->GetServerByAddress(sIP.GetBuffer(), nPort);
d1057 2
a1058 2
			if (g_eMuleApp.m_pdlgEmule->m_wndServer)
				g_eMuleApp.m_pdlgEmule->m_wndServer.m_ctlServerList.RefreshServer(*server);
d1065 1
a1065 1
			CServer* server=g_eMuleApp.m_pServerList->GetServerByAddress(sIP.GetBuffer(), nPort);
d1067 2
a1068 2
			if (g_eMuleApp.m_pdlgEmule->m_wndServer)
				g_eMuleApp.m_pdlgEmule->m_wndServer.m_ctlServerList.RefreshServer(*server);
d1075 1
a1075 1
			CServer* server=g_eMuleApp.m_pServerList->GetServerByAddress(sIP.GetBuffer(), nPort);
d1077 2
a1078 2
			if (g_eMuleApp.m_pdlgEmule->m_wndServer)
				g_eMuleApp.m_pdlgEmule->m_wndServer.m_ctlServerList.RefreshServer(*server);
d1087 1
a1087 1
		fullpath.Format(_T("%spreferences.ini"),g_eMuleApp.m_pGlobPrefs->GetConfigDir());
d1298 1
a1298 1
	for (uint32 sc=0;sc<g_eMuleApp.m_pServerList->GetServerCount();sc++)
d1300 1
a1300 1
		CServer* cur_file = g_eMuleApp.m_pServerList->GetServerAt(sc);
d1348 1
a1348 1
		if (g_eMuleApp.m_pServerConnect->IsConnecting())
d1350 1
a1350 1
			tempServer = g_eMuleApp.m_pServerConnect->GetConnectingServer();
d1354 1
a1354 1
		else if (g_eMuleApp.m_pServerConnect->IsConnected())
d1356 1
a1356 1
			tempServer = g_eMuleApp.m_pServerConnect->GetCurrentServer();
d1359 1
a1359 1
				if (!g_eMuleApp.m_pServerConnect->IsLowID())
d1604 1
a1604 1
			g_eMuleApp.m_pdlgEmule->SendMessage(WEB_CLEAR_COMPLETED, (WPARAM)0, static_cast<LPARAM>(eCatIDforMessage));
d1617 1
a1617 1
				g_eMuleApp.m_pdlgEmule->SendMessage(WEB_CLEAR_COMPLETED, (WPARAM)1, reinterpret_cast<LPARAM>(pFileHash));
d1627 1
a1627 1
		g_eMuleApp.m_pdlgEmule->m_dlgSearch.AddEd2kLinksToDownload(HTTPTemp,eCatID);
d1639 1
a1639 1
		fullpath.Format(_T("%spreferences.ini"),g_eMuleApp.m_pGlobPrefs->GetConfigDir());
d1652 1
a1652 1
		fullpath.Format(_T("%spreferences.ini"),g_eMuleApp.m_pGlobPrefs->GetConfigDir());
d1665 1
a1665 1
		fullpath.Format(_T("%spreferences.ini"),g_eMuleApp.m_pGlobPrefs->GetConfigDir());
d1689 1
a1689 1
				g_eMuleApp.m_pDownloadQueue->SetCatPrio(cat,prio);
d1691 1
a1691 1
				g_eMuleApp.m_pDownloadQueue->SetCatPrio(0,prio);
d1706 1
a1706 1
				CPartFile *found_file = g_eMuleApp.m_pDownloadQueue->GetFileByID(StringToHash(sFile, FileHash));
d1714 1
a1714 1
						g_eMuleApp.m_pDownloadQueue->SetA4AFAutoFile(found_file);
d1716 1
a1716 1
						g_eMuleApp.m_pDownloadQueue->SetA4AFAutoFile(NULL);
d1726 1
a1726 1
						g_eMuleApp.m_pdlgEmule->m_wndTransfer.UpdateCatTabTitles();
d1733 1
a1733 1
						g_eMuleApp.m_pdlgEmule->SendMessage(WEB_FILE_RENAME, (WPARAM)found_file, (LPARAM)(LPCTSTR)sNewName);
d1774 1
a1774 1
					CUpDownClient* cur_client = g_eMuleApp.m_pClientList->FindClientByUserHash(UserHash);
d1778 1
a1778 1
							g_eMuleApp.m_pFriendList->AddFriend(cur_client);
d1780 1
a1780 1
							g_eMuleApp.m_pFriendList->RemoveFriend(cur_client);
d2188 1
a2188 1
	if (!(pvecPartFiles = g_eMuleApp.m_pDownloadList->GetFiles()))
d2194 1
a2194 1
		for (POSITION pos=g_eMuleApp.m_pDownloadQueue->m_partFileList.GetHeadPosition(); pos != NULL;)
d2196 1
a2196 1
			CPartFile	*pPartFile = g_eMuleApp.m_pDownloadQueue->m_partFileList.GetNext(pos);
d2279 1
a2279 1
			if (g_eMuleApp.m_pServerConnect->IsConnected() && !g_eMuleApp.m_pServerConnect->IsLowID())
d2285 1
a2285 1
			dFile.sFakeCheck = g_eMuleApp.m_pFakeCheck->GetFakeCheckComment(HashToString(pPartFile->GetFileHash()),pPartFile->GetFileSize());
d2287 1
a2287 1
			if ( g_eMuleApp.m_pGlobPrefs->DoPausedStoppedLast() &&
d2372 1
a2372 1
	g_eMuleApp.m_pUploadQueue->GetCopyUploadQueueList(&CopyUploadQueueList);
d2415 1
a2415 1
		CKnownFile* file = g_eMuleApp.m_pSharedFilesList->GetFileByID(cur_client->m_reqFileHash);
d2479 1
a2479 1
	for (POSITION pos = g_eMuleApp.m_pUploadQueue->waitinglist.GetHeadPosition(); pos != NULL;)
d2481 1
a2481 1
		CUpDownClient* cur_client = g_eMuleApp.m_pUploadQueue->waitinglist.GetNext(pos);
d2516 1
a2516 1
		CKnownFile* file = g_eMuleApp.m_pSharedFilesList->GetFileByID(cur_client->m_reqFileHash);
d2569 1
a2569 1
	if (g_eMuleApp.m_pUploadQueue->waitinglist.GetHeadPosition() != 0)
d2614 1
a2614 1
		CPartFile *found_file = g_eMuleApp.m_pDownloadQueue->GetFileByID(StringToHash(FilesArray[i].sFileHash, FileHashA4AF));
d2628 1
a2628 1
		if (g_eMuleApp.m_pDownloadQueue->GetA4AFAutoFile() == found_file && !FilesArray[i].bIsComplete)
d2670 1
a2670 1
		if (g_eMuleApp.m_pDownloadQueue->GetA4AFAutoFile() == found_file && !FilesArray[i].bIsComplete)
d2800 2
a2801 2
	HTTPTemp.Format( _T("%s: %i, %s: %i"), GetResString(IDS_SF_FILE), g_eMuleApp.m_pDownloadQueue->GetFileCount(), 
					 GetResString(IDS_ST_ACTIVE), g_eMuleApp.m_pDownloadQueue->GetActiveFileCount());
d3231 1
a3231 1
			cur_file = g_eMuleApp.m_pSharedFilesList->GetFileByID(fileid);
d3253 1
a3253 1
				g_eMuleApp.m_pSharedFilesList->UpdateItem(cur_file); // refresh GUI on priority change
d3265 1
a3265 1
		fullpath.Format(_T("%spreferences.ini"),g_eMuleApp.m_pGlobPrefs->GetConfigDir());
d3280 1
a3280 1
		g_eMuleApp.m_pdlgEmule->SendMessage(WEB_SHARED_FILES_RELOAD);
d3334 1
a3334 1
		CString strResultLog = _SpecialChars(g_eMuleApp.m_pdlgEmule->m_strLogText);	//Pick-up last line of the log
d3457 1
a3457 1
	for (POSITION pos = g_eMuleApp.m_pSharedFilesList->m_mapSharedFiles.GetStartPosition(); pos != NULL;)
d3463 1
a3463 1
		g_eMuleApp.m_pSharedFilesList->m_mapSharedFiles.GetNextAssoc(pos,bufKey,cur_file);
d3478 1
a3478 1
		if (g_eMuleApp.m_pServerConnect->IsConnected())
d3644 1
a3644 1
		cur_file=g_eMuleApp.m_pSharedFilesList->GetFileByID(fileid);
d3790 1
a3790 1
	Out.Replace(_T("[ScaleTime]"), CastSecondsToHM(g_eMuleApp.m_pGlobPrefs->GetTrafficOMeterInterval() * WEB_GRAPH_WIDTH));
d3793 1
a3793 1
	s1.Format(_T("%u"), g_eMuleApp.m_pGlobPrefs->GetMaxGraphDownloadRate() / 10);
d3795 1
a3795 1
	s1.Format(_T("%u"), g_eMuleApp.m_pGlobPrefs->GetMaxGraphUploadRate() / 10);
d3797 1
a3797 1
	s1.Format(_T("%u"), g_eMuleApp.m_pGlobPrefs->GetMaxConnections());
d3832 2
a3833 2
			g_eMuleApp.m_pdlgEmule->m_wndServer.AddServer(_ParseURL(Data.sURL, _T("serveraddr")),_ParseURL(Data.sURL, _T("serverport")),_ParseURL(Data.sURL, _T("servername")));
			CString resultlog = _SpecialChars(g_eMuleApp.m_pdlgEmule->m_strLogText); //Pick-up last line of the log
d3835 1
a3835 1
			CServer* server = g_eMuleApp.m_pServerList->GetServerByAddress(_ParseURL(Data.sURL, _T("serveraddr")), _tstoi(_ParseURL(Data.sURL, _T("serverport"))));
d3842 2
a3843 2
			if (g_eMuleApp.m_pdlgEmule->m_wndServer)
				g_eMuleApp.m_pdlgEmule->m_wndServer.m_ctlServerList.RefreshServer(*server);
d3849 1
a3849 1
				resultlog += _SpecialChars(g_eMuleApp.m_pdlgEmule->m_strLogText); //Pick-up last line of the log
d3862 2
a3863 2
		g_eMuleApp.m_pdlgEmule->m_wndServer.UpdateServerMetFromURL(_ParseURL(Data.sURL, _T("servermeturl")));
		CString resultlog = _SpecialChars(g_eMuleApp.m_pdlgEmule->m_strLogText);
d3920 1
a3920 1
		g_eMuleApp.m_pdlgEmule->m_wndServer.m_pctlLogBox->Reset();
d3922 1
a3922 1
		g_eMuleApp.m_pdlgEmule->m_wndServer.OnTcnSelchangeTab1(NULL, &pDummy);
d3925 1
a3925 1
	Out.Replace(_T("[Log]"), g_eMuleApp.m_pdlgEmule->m_wndServer.m_pctlLogBox->GetHtml() + _T("<br><a name=\"end\"></a>"));
d3957 1
a3957 1
		g_eMuleApp.m_pdlgEmule->m_wndServer.m_pctlServerMsgBox->Reset();
d3959 1
a3959 1
		g_eMuleApp.m_pdlgEmule->m_wndServer.OnTcnSelchangeTab1(NULL, &pDummy);
d3962 1
a3962 1
	Out.Replace(_T("[ServerInfo]"), g_eMuleApp.m_pdlgEmule->m_wndServer.m_pctlServerMsgBox->GetHtml() + _T("<br><a name=\"end\"></a>"));
d3994 1
a3994 1
		g_eMuleApp.m_pdlgEmule->m_wndServer.m_pctlDebugBox->Reset();
d3996 1
a3996 1
		g_eMuleApp.m_pdlgEmule->m_wndServer.OnTcnSelchangeTab1(NULL, &pDummy);
d3999 1
a3999 1
	Out.Replace(_T("[DebugLog]"), g_eMuleApp.m_pdlgEmule->m_wndServer.m_pctlDebugBox->GetHtml() + _T("<br><a name=\"end\"></a>"));
d4021 2
a4022 2
	g_eMuleApp.m_pdlgEmule->ShowStatistics();
	g_eMuleApp.m_pdlgEmule->m_dlgStatistics.ShowStatistics(true);
d4026 1
a4026 1
	Out.Replace(_T("[Stats]"), g_eMuleApp.m_pdlgEmule->m_dlgStatistics.stattree.GetHTMLForExport());
d4058 1
a4058 1
			g_eMuleApp.m_pGlobPrefs->SetWebUseGzip(true);
d4060 1
a4060 1
			g_eMuleApp.m_pGlobPrefs->SetWebUseGzip(false);
d4078 1
a4078 1
			g_eMuleApp.m_pGlobPrefs->SetWebPageRefresh(_tstoi(_ParseURL(Data.sURL, _T("refresh"))));
d4082 1
a4082 1
			g_eMuleApp.m_pGlobPrefs->SetMaxGraphDownloadRate(ValidateDownCapability(10 * _tstoi(strTmp)));
d4085 1
a4085 1
			g_eMuleApp.m_pGlobPrefs->SetMaxGraphUploadRate(ValidateUpCapability(10 * _tstoi(strTmp)));
d4095 2
a4096 2
				g_eMuleApp.m_pGlobPrefs->SetMaxDownloadWithCheck(dwSpeed);
				g_eMuleApp.m_pGlobPrefs->SetLimitlessDownload(false);	//SyruS disable limitless on setting a specific value
d4099 1
a4099 1
				g_eMuleApp.m_pGlobPrefs->SetLimitlessDownload(true);	//SyruS enable limitless on setting to 0
d4106 1
a4106 1
				g_eMuleApp.m_pGlobPrefs->SetMaxUploadWithCheck(dwSpeed);
d4110 1
a4110 1
			g_eMuleApp.m_pGlobPrefs->SetMaxSourcePerFile(_tstoi(_ParseURL(Data.sURL, _T("maxsources"))));
d4112 1
a4112 1
			g_eMuleApp.m_pGlobPrefs->SetMaxConnections(_tstoi(_ParseURL(Data.sURL, _T("maxconnections"))));
d4114 1
a4114 1
			g_eMuleApp.m_pGlobPrefs->SetMaxDownloadConperFive(_tstoi(_ParseURL(Data.sURL, _T("maxconnectionsperfive"))));
d4118 1
a4118 1
	if(g_eMuleApp.m_pGlobPrefs->GetWebUseGzip())
d4140 1
a4140 1
	sRefresh.Format(_T("%d"), g_eMuleApp.m_pGlobPrefs->GetWebPageRefresh());
d4143 1
a4143 1
	sRefresh.Format(_T("%d"), g_eMuleApp.m_pGlobPrefs->GetMaxSourcePerFile());
d4146 1
a4146 1
	sRefresh.Format(_T("%d"), g_eMuleApp.m_pGlobPrefs->GetMaxConnections());
d4149 1
a4149 1
	sRefresh.Format(_T("%d"), g_eMuleApp.m_pGlobPrefs->GetMaxConPerFive());
d4189 1
a4189 1
	uint32	dwNum = (g_eMuleApp.m_pGlobPrefs->LimitlessDownload()) ? UNLIMITED : g_eMuleApp.m_pGlobPrefs->GetMaxDownload();
d4193 1
a4193 1
	dwNum = g_eMuleApp.m_pGlobPrefs->GetMaxUpload();
d4196 1
a4196 1
	sT.Format(_T("%u"), g_eMuleApp.m_pGlobPrefs->GetMaxGraphDownloadRate() / 10);
d4198 1
a4198 1
	sT.Format(_T("%u"), g_eMuleApp.m_pGlobPrefs->GetMaxGraphUploadRate() / 10);
d4225 1
a4225 1
	Out.Replace(_T("[Nick]"), _SpecialChars(g_eMuleApp.m_pGlobPrefs->GetUserNick()));
d4355 1
a4355 1
			g_eMuleApp.m_pdlgEmule->AddLogLine(true, RGB_LOG_NOTICE + GetResString(IDS_WEB_SESSIONEND),t_ulCurIP);
d4442 1
a4442 1
	switch (g_eMuleApp.m_pGlobPrefs->GetLanguageID())
d4480 1
a4480 1
	pPartFile = g_eMuleApp.m_pDownloadQueue->GetFileByID(fileid);
d4580 1
a4580 1
				g_eMuleApp.m_pSearchList->AddFileToDownloadByHash(fileid,eCatID);
d4596 2
a4597 2
		g_eMuleApp.m_pGlobPrefs->SetFakeListURL(_ParseURL(Data.sURL, _T("url")));
		g_eMuleApp.m_pFakeCheck->UpdateFakeList();
d4603 2
a4604 2
		g_eMuleApp.m_pdlgEmule->m_dlgSearch.DeleteAllSearchs();
		g_eMuleApp.m_pdlgEmule->m_dlgSearch.DoNewSearch(
d4634 1
a4634 1
		fullpath.Format(_T("%spreferences.ini"),g_eMuleApp.m_pGlobPrefs->GetConfigDir());
d4644 1
a4644 1
	strResultList += g_eMuleApp.m_pSearchList->GetWebList(pThis->m_Templates.sSearchResultLine,pThis->m_iSearchSortby,pThis->m_bSearchAsc,!WSsearchColumnHidden[0],!WSsearchColumnHidden[1],!WSsearchColumnHidden[2],!WSsearchColumnHidden[3],!WSsearchColumnHidden[4]);
d4680 1
a4680 1
	Out.Replace(_T("[FakeListUrl]"), g_eMuleApp.m_pGlobPrefs->GetFakeListURL());
d4685 1
a4685 1
		(g_eMuleApp.m_pGlobPrefs->GetSearchMethod() == EP_SEARCHMETHOD_GLOB) ? _T("checked") : _T(""));
d4876 1
a4876 1
		CPartFile *found_file = g_eMuleApp.m_pDownloadQueue->GetFileByID(StringToHash(sFileHash, FileHash));
@


1.336
log
@Corrected some WebServer incorrections related to '&' {morphis};
Unified some places and improved string processing.
@
text
@d879 1
d901 6
a906 13
			HTTPConText = CString(cur_server->GetListName());
		_stprintf(HTTPHeader, _T("%s"), CastItoThousands(cur_server->GetNumUsers()));
		HTTPHelpU = CString(HTTPHeader);
		_stprintf(HTTPHeader, _T("%s"), CastItoThousands(cur_server->GetMaxUsers()));
		HTTPHelpM = CString(HTTPHeader);
		_stprintf(HTTPHeader, _T("%s"), CastItoThousands(cur_server->GetFiles()));
		HTTPHelpF = CString(HTTPHeader);
		if ( cur_server->GetMaxUsers() > 0 )
			_stprintf(HTTPHeader, _T("%.1f "), (static_cast<double>(cur_server->GetNumUsers()) / cur_server->GetMaxUsers()) * 100.0);
		else
			_stprintf(HTTPHeader, _T("%.1f "), 0.0);
		HTTPHelpV = CString(HTTPHeader);

d913 2
a914 1
		if (IsSessionAdmin(Data,sSession)) HTTPConText+=_T(" (<a href=\"/?ses=") + sSession + _T("&w=server&c=connect\">")+_GetPlainResString(IDS_CONNECTTOANYSERVER)+_T("</a>)");
d918 1
a918 1
	for (uint32 sc=0;sc<g_eMuleApp.m_pServerList->GetServerCount();sc++)
d920 4
a923 3
		CServer* cur_server = g_eMuleApp.m_pServerList->GetServerAt(sc);
	    allUsers += cur_server->GetNumUsers();
	    allFiles += cur_server->GetFiles();
d929 1
a929 4
	if(g_eMuleApp.m_pGlobPrefs->GetMaxUpload() == UNLIMITED)
		_stprintf(HTTPHeader, _T("%.1f"), static_cast<double>(100 * g_eMuleApp.m_pUploadQueue->GetDataRate()) / 102.4 / g_eMuleApp.m_pGlobPrefs->GetMaxGraphUploadRate());
	else
		_stprintf(HTTPHeader, _T("%.1f"), static_cast<double>(100 * g_eMuleApp.m_pUploadQueue->GetDataRate()) / 102.4 / g_eMuleApp.m_pGlobPrefs->GetMaxUpload());
d933 1
a933 1
		_stprintf(HTTPHeader, _T("%.1f"), static_cast<double>(100 * g_eMuleApp.m_pDownloadQueue->GetDataRate()) / 102.4 / g_eMuleApp.m_pGlobPrefs->GetMaxGraphDownloadRate());
d935 1
a935 1
		_stprintf(HTTPHeader, _T("%.1f"), static_cast<double>(100 * g_eMuleApp.m_pDownloadQueue->GetDataRate()) / 102.4 / g_eMuleApp.m_pGlobPrefs->GetMaxDownload());
d938 2
a939 1
	_stprintf(HTTPHeader, _T("%.1f"), (static_cast<double>(g_eMuleApp.m_pListenSocket->GetNumOpenSockets()))/(g_eMuleApp.m_pGlobPrefs->GetMaxConnections())*100.0);
d945 1
a945 1
	_stprintf(HTTPHeader, _T("%.0f"), (static_cast<double>(g_eMuleApp.m_pListenSocket->GetNumOpenSockets())));
d949 1
a949 7
	uint32		dwMax;

	dwMax = g_eMuleApp.m_pGlobPrefs->GetMaxUpload();
	if (dwMax == UNLIMITED)
		HTTPHelp = GetResString(IDS_PW_UNLIMITED);
	else
		FractionalRate2String(&HTTPHelp, dwMax);
d959 1
a959 5
	dwMax = g_eMuleApp.m_pGlobPrefs->GetMaxConnections();
	if (dwMax == UNLIMITED)
		HTTPHelp = GetResString(IDS_PW_UNLIMITED);
	else
		HTTPHelp.Format(_T("%u"), dwMax);
@


1.335
log
@WebServer: 'Show paused and stopped files last'.
@
text
@d21 1
a21 1
#define WEB_SERVER_TEMPLATES_VERSION	1006
d772 3
a774 2
	CString sRefresh, strDummyNumber, strCat;
	CString sPage = _ParseURL(Data.sURL, _T("w"));
d776 1
d778 2
a779 1
	strCat = _T("&cat=") + _ParseURL(Data.sURL, _T("cat"));
d781 2
a782 2
	if (sPage == _T("options") || sPage == _T("stats") || sPage == _T("password"))
		sRefresh.Format(_T("0"));
d786 1
a786 4
	strDummyNumber.Format(_T("%d"), rand());

	CString strVersionCheck;

a788 7
	int cat = _tstoi(_ParseURL(Data.sURL, _T("cat")));

	CString sCat;
	
	if (cat != 0)
		sCat.Format(_T("&cat=%u"), cat);

d792 1
a792 1
	Out.Replace(_T("[wCommand]"), _ParseURL(Data.sURL, _T("w")) + strCat + _T("&dummy=") + strDummyNumber);
d1159 1
a1159 1
	strTmp = (pThis->m_Params.bServerSortReverse) ? _T("&sortreverse=false") : _T("&sortreverse=true");
d1161 11
a1171 44
	if(pThis->m_Params.ServerSort == SERVER_SORT_STATE)
		Out.Replace(_T("[SortState]"), strTmp);
	else
		Out.Replace(_T("[SortState]"), _T(""));
	if(pThis->m_Params.ServerSort == SERVER_SORT_NAME)
		Out.Replace(_T("[SortName]"), strTmp);
	else
		Out.Replace(_T("[SortName]"), _T(""));
	if(pThis->m_Params.ServerSort == SERVER_SORT_IP)
		Out.Replace(_T("[SortIP]"), strTmp);
	else
		Out.Replace(_T("[SortIP]"), _T(""));
	if(pThis->m_Params.ServerSort == SERVER_SORT_DESCRIPTION)
		Out.Replace(_T("[SortDescription]"), strTmp);
	else
		Out.Replace(_T("[SortDescription]"), _T(""));
	if(pThis->m_Params.ServerSort == SERVER_SORT_PING)
		Out.Replace(_T("[SortPing]"), strTmp);
	else
		Out.Replace(_T("[SortPing]"), _T(""));
	if(pThis->m_Params.ServerSort == SERVER_SORT_USERS)
		Out.Replace(_T("[SortUsers]"), strTmp);
	else
		Out.Replace(_T("[SortUsers]"), _T(""));
	if(pThis->m_Params.ServerSort == SERVER_SORT_FILES)
		Out.Replace(_T("[SortFiles]"), strTmp);
	else
		Out.Replace(_T("[SortFiles]"), _T(""));
	if(pThis->m_Params.ServerSort == SERVER_SORT_PRIORITY)
		Out.Replace(_T("[SortPriority]"), strTmp);
	else
		Out.Replace(_T("[SortPriority]"), _T(""));
	if(pThis->m_Params.ServerSort == SERVER_SORT_FAILED)
		Out.Replace(_T("[SortFailed]"), strTmp);
	else
		Out.Replace(_T("[SortFailed]"), _T(""));
	if(pThis->m_Params.ServerSort == SERVER_SORT_LIMIT)
		Out.Replace(_T("[SortLimit]"), strTmp);
	else
		Out.Replace(_T("[SortLimit]"), _T(""));
	if(pThis->m_Params.ServerSort == SERVER_SORT_VERSION)
		Out.Replace(_T("[SortVersion]"), strTmp);
	else
		Out.Replace(_T("[SortVersion]"), _T(""));
d1440 2
a1441 2
	// Displaying
	const TCHAR	*pcTmp, *pcTmp2;
d2610 3
a2622 1
		CString ed2k;			//ed2klink
a2625 2
		CString fname;			//filename
		CString fsize;			//filesize
d2632 1
a2632 2
		CString strFInfo = FilesArray[i].sFileInfo;

d2637 2
a2638 4
		CString JSED2kLink=FilesArray[i].sED2kLink;
		JSED2kLink.Replace(_T("'"),_T("&#8217;"));

		ed2k = JSED2kLink;
a2640 1
		fsize.Format(_T("%d"),FilesArray[i].m_qwFileSize);
a2678 1
		HTTPProcessData.Replace(_T("[fsize]"), fsize);
d3300 1
a3300 1
	strTmp = (pThis->m_Params.bSharedSortReverse) ? _T("false") : _T("true");
d3302 8
a3309 31
	//State sorting link
	if(pThis->m_Params.SharedSort == SHARED_SORT_STATE)
		Out.Replace(_T("[SortState]"), _T("sort=state&sortreverse=") + strTmp);
	else
		Out.Replace(_T("[SortState]"), _T("sort=state"));
    //Type sorting link
	if(pThis->m_Params.SharedSort == SHARED_SORT_TYPE)
		Out.Replace(_T("[SortType]"), _T("sort=type&sortreverse=") + strTmp);
	else
		Out.Replace(_T("[SortType]"), _T("sort=type"));
    //Name sorting link
	if(pThis->m_Params.SharedSort == SHARED_SORT_NAME)
		Out.Replace(_T("[SortName]"), _T("sort=name&sortreverse=") + strTmp);
	else
		Out.Replace(_T("[SortName]"), _T("sort=name"));
	//Size sorting Link
	if(pThis->m_Params.SharedSort == SHARED_SORT_SIZE)
		Out.Replace(_T("[SortSize]"), _T("sort=size&sortreverse=") + strTmp);
	else
		Out.Replace(_T("[SortSize]"), _T("sort=size"));
	//Complete Sources sorting Link
	if(pThis->m_Params.SharedSort == SHARED_SORT_COMPLETES)
		Out.Replace(_T("[SortCompletes]"), _T("sort=completes&sortreverse=") + strTmp);
	else
		Out.Replace(_T("[SortCompletes]"), _T("sort=completes"));
	//Priority sorting Link
	if(pThis->m_Params.SharedSort == SHARED_SORT_PRIORITY)
		Out.Replace(_T("[SortPriority]"), _T("sort=priority&sortreverse=") + strTmp);
	else
		Out.Replace(_T("[SortPriority]"), _T("sort=priority"));
    //Transferred sorting link
d3312 2
a3313 4
		if(pThis->m_Params.bSharedSortReverse)
			Out.Replace(_T("[SortTransferred]"), _T("sort=alltimetransferred&sortreverse=") + strTmp);
		else
			Out.Replace(_T("[SortTransferred]"), _T("sort=transferred&sortreverse=") + strTmp);
d3315 1
a3315 2
	else
	if(pThis->m_Params.SharedSort == SHARED_SORT_ALL_TIME_TRANSFERRED)
d3317 2
a3318 4
		if(pThis->m_Params.bSharedSortReverse)
			Out.Replace(_T("[SortTransferred]"), _T("sort=transferred&sortreverse=") + strTmp);
		else
			Out.Replace(_T("[SortTransferred]"), _T("sort=alltimetransferred&sortreverse=") + strTmp);
d3320 3
a3322 3
	else
		Out.Replace(_T("[SortTransferred]"), _T("&sort=transferred&sortreverse=false"));
    //Request sorting link
d3325 2
a3326 4
		if(pThis->m_Params.bSharedSortReverse)
			Out.Replace(_T("[SortRequests]"), _T("sort=alltimerequests&sortreverse=") + strTmp);
		else
			Out.Replace(_T("[SortRequests]"), _T("sort=requests&sortreverse=") + strTmp);
d3328 1
a3328 2
	else
	if(pThis->m_Params.SharedSort == SHARED_SORT_ALL_TIME_REQUESTS)
d3330 2
a3331 4
		if(pThis->m_Params.bSharedSortReverse)
			Out.Replace(_T("[SortRequests]"), _T("sort=requests&sortreverse=") + strTmp);
		else
			Out.Replace(_T("[SortRequests]"), _T("sort=alltimerequests&sortreverse=") + strTmp);
d3333 3
a3335 3
	else
        Out.Replace(_T("[SortRequests]"), _T("&sort=requests&sortreverse=false"));
    //Accepts sorting link
d3338 2
a3339 4
		if(pThis->m_Params.bSharedSortReverse)
            Out.Replace(_T("[SortAccepts]"), _T("sort=alltimeaccepts&sortreverse=") + strTmp);
		else
			Out.Replace(_T("[SortAccepts]"), _T("sort=accepts&sortreverse=") + strTmp);
d3343 2
a3344 4
		if(pThis->m_Params.bSharedSortReverse)
            Out.Replace(_T("[SortAccepts]"), _T("sort=accepts&sortreverse=") + strTmp);
		else
			Out.Replace(_T("[SortAccepts]"), _T("sort=alltimeaccepts&sortreverse=") + strTmp);
d3346 1
a3346 2
	else
		Out.Replace(_T("[SortAccepts]"), _T("&sort=accepts&sortreverse=false"));
d3649 2
a3650 4
		CString JSED2kLink=SharedArray[i].sED2kLink;
		JSED2kLink.Replace(_T("'"),_T("&#8217;"));

		ed2k = JSED2kLink;
d3900 2
a3901 2
	Out.Replace(_T("[URL_Disconnect]"), IsSessionAdmin(Data,sSession)?CString(_T("/?ses=") + sSession + _T("&w=server&c=disconnect&cat=") + sCat):GetPermissionDenied());
	Out.Replace(_T("[URL_Connect]"), IsSessionAdmin(Data,sSession)?CString(_T("/?ses=") + sSession + _T("&w=server&c=connect&cat=") + sCat):GetPermissionDenied());
@


1.334
log
@Modified preparation of the server search request packet to make it clearer.
@
text
@d2324 2
a2325 3
			CString		strCategory = (pCat != NULL) ? pCat->GetTitle() : GetResString(IDS_CAT_UNCATEGORIZED);
			strCategory.Replace(_T("'"),_T("\'"));
			dFile.sCategory = strCategory;
d2342 7
d2360 4
a2363 2
	bool bSorted = true;
	for(int nMax = 0;bSorted && nMax < FilesArray.GetCount()*2; nMax++)
d2368 3
a2370 2
			bool bSwap = false;
			switch(pThis->m_Params.DownloadSort)
d2372 41
a2412 33
			case DOWN_SORT_STATE:
				bSwap = FilesArray[i].sFileState.CompareNoCase(FilesArray[i+1].sFileState) < 0;
				break;
			case DOWN_SORT_TYPE:
				bSwap = FilesArray[i].sFileType.CompareNoCase(FilesArray[i+1].sFileType) < 0;
				break;
			case DOWN_SORT_NAME:
				bSwap = FilesArray[i].sFileName.CompareNoCase(FilesArray[i+1].sFileName) < 0;
				break;
			case DOWN_SORT_SIZE:
				bSwap = FilesArray[i].m_qwFileSize < FilesArray[i+1].m_qwFileSize;
				break;
			case DOWN_SORT_TRANSFERRED:
				bSwap = FilesArray[i].m_qwFileTransferred < FilesArray[i+1].m_qwFileTransferred;
				break;
			case DOWN_SORT_SPEED:
				bSwap = FilesArray[i].lFileSpeed < FilesArray[i+1].lFileSpeed;
				break;
			case DOWN_SORT_PROGRESS:
				bSwap = FilesArray[i].m_dblCompleted  < FilesArray[i+1].m_dblCompleted ;
				break;
			case DOWN_SORT_SOURCES:
				bSwap = FilesArray[i].lSourceCount  < FilesArray[i+1].lSourceCount ;
				break;
			case DOWN_SORT_PRIORITY:
				bSwap = FilesArray[i].nFilePrio < FilesArray[i+1].nFilePrio ;
				break;
			case DOWN_SORT_CATEGORY:
				bSwap = FilesArray[i].sCategory.CompareNoCase(FilesArray[i+1].sCategory) < 0;
				break;
			case DOWN_SORT_FAKECHECK:
				bSwap = FilesArray[i].sFakeCheck.CompareNoCase(FilesArray[i+1].sFakeCheck) < 0;
				break;
a2413 2
			if(pThis->m_Params.bDownloadSortReverse)
				bSwap = !bSwap;
@


1.333
log
@IDS_SEARCH_NOUN substitutes IDS_SW_SEARCHBOX.
@
text
@d4695 1
a4695 3
		//	Because the availability is used with the 'Min' operator, we decrement the entered value by one to get
		//	more 'useable' results from the server (from a user's POV).
			_tstoi(_ParseURL(Data.sURL, _T("avail"))) - 1,
@


1.332
log
@IDS_SF_STATISTICS renamed into IDS_STATISTICS.
@
text
@d820 1
a820 1
	Out.Replace(_T("[Search]"), _GetPlainResString(IDS_SW_SEARCHBOX));
d4752 1
a4752 1
	Out.Replace(_T("[Search]"), _GetPlainResString(IDS_SW_SEARCHBOX));
@


1.331
log
@"Serverlist" -> "Servers"; IDS_DL_STOP renamed into IDS_STOP_VERB;
IDS_DL_PAUSE renamed into IDS_PAUSE_VERB;
IDS_DL_RESUME renamed into IDS_RESUME.
@
text
@d812 1
a812 1
	Out.Replace(_T("[Stats]"), _GetPlainResString(IDS_SF_STATISTICS));
@


1.330
log
@IDS_EM_PREFS renamed into IDS_PREFERENCES.
@
text
@d806 1
a806 1
	Out.Replace(_T("[Server]"), _GetPlainResString(IDS_SV_SERVERLIST));
d838 3
a840 3
	Out.Replace(_T("[Resume]"), _GetPlainResString(IDS_DL_RESUME, true));
	Out.Replace(_T("[Stop]"), _GetPlainResString(IDS_DL_STOP, true));
	Out.Replace(_T("[Pause]"), _GetPlainResString(IDS_DL_PAUSE, true));
d1212 1
a1212 1
	Out.Replace(_T("[ServerList]"), _GetPlainResString(IDS_SV_SERVERLIST));
@


1.329
log
@Removed colon from MP_CLEARALLCOMPLETED.
@
text
@d813 1
a813 1
	Out.Replace(_T("[Options]"), GetResString(IDS_EM_PREFS));
@


1.328
log
@WebServer: ability to host xml and txt files
@
text
@d2237 1
a2237 3
	_GetPlainResString(&strTmp, IDS_TREE_DL_CLEAR_ALL_COMPLETED);
	strTmp.Replace(_T(":"), _T(""));
	Out.Replace(_T("[ClearAllCompleted]"), strTmp);
@


1.327
log
@Minor string usage optimization (probably it's already too much changes for one string).
@
text
@d408 4
@


1.326
log
@interchange [MenuLockTitle]
@
text
@d878 1
a878 1
	Out.Replace(_T("[MenuLockTitle]"), pThis->m_Params.bMenuLocked ? _GetPlainResString(IDS_MENULOCK_ON) : _GetPlainResString(IDS_MENULOCK_OFF));
@


1.325
log
@* all latest changes for ws-menulock
* fix filedonkey search in ws
@
text
@d878 1
a878 1
	Out.Replace(_T("[MenuLockTitle]"), pThis->m_Params.bMenuLocked ? _GetPlainResString(IDS_MENULOCK_OFF) : _GetPlainResString(IDS_MENULOCK_ON));
@


1.324
log
@main menu lock
@
text
@d478 1
a478 1
	if ((_ParseURL(Data.sURL, _T("w")) == "password") && !pThis->GetIsTempDisabled())
d878 1
@


1.323
log
@WebServer: fixed display of apostrophe in message box {BouRock}.
@
text
@d62 3
a64 1
	m_iSearchSortby=3;
a65 2

	dwThread = GetCurrentThreadId();
a66 1

d70 1
a868 1
#ifdef OLD_SOCKETS_ENABLED
d871 8
d882 1
@


1.322
log
@Unified way to display client name and version.
@
text
@d842 4
a845 4
	Out.Replace(_T("[ConfirmRemove]"), _GetPlainResString(IDS_WEB_CONFIRM_REMOVE_SERVER, true));
	Out.Replace(_T("[ConfirmClose]"), _GetPlainResString(IDS_MAIN_CLOSE, true));
	Out.Replace(_T("[ConfirmReboot]"), _GetPlainResString(IDS_MAIN_REBOOT, true));
	Out.Replace(_T("[ConfirmShutdown]"), _GetPlainResString(IDS_MAIN_SHUTDOWN, true));
@


1.321
log
@Optimized GetCurrentServer() calls (cache value for consecutive usage).
@
text
@d2454 1
a2454 1
		dUser.sClientNameVersion = cur_client->GetClientNameAndVersionString();
d2545 1
a2545 1
		dUser.sClientNameVersion = cur_client->GetClientNameAndVersionString();
@


1.320
log
@WebServer: fixed javascript error while showing menu in Turkish {BouRock}.
@
text
@d886 4
a889 3
		CServer* cur_server = g_eMuleApp.m_pServerList->GetServerByAddress(
			g_eMuleApp.m_pServerConnect->GetCurrentServer()->GetAddress(),
			g_eMuleApp.m_pServerConnect->GetCurrentServer()->GetPort() );
@


1.319
log
@Unicode preparations; Improved string processing;
Corrected missed space during preparation of category box stuff;
Formatting; Minor corrections.
@
text
@d811 3
a813 3
	Out.Replace(_T("[Close]"), _GetPlainResString(IDS_WEB_CLOSE));
	Out.Replace(_T("[Reboot]"), _GetPlainResString(IDS_WEB_REBOOT));
	Out.Replace(_T("[Shutdown]"), _GetPlainResString(IDS_WEB_SHUTDOWN));
@


1.318
log
@Some renaming.
@
text
@d265 3
a267 2
	CServer* server=g_eMuleApp.m_pServerList->GetServerByAddress(sIP.GetBuffer(), nPort);
	if (server!=NULL) g_eMuleApp.m_pdlgEmule->SendMessage(WEB_REMOVE_SERVER, (WPARAM)server, NULL);
d276 3
a278 2
	CServer* server=g_eMuleApp.m_pServerList->GetServerByAddress(sIP.GetBuffer(), nPort);
	if (server!=NULL) g_eMuleApp.m_pdlgEmule->SendMessage(WEB_ADD_TO_STATIC, (WPARAM)server, NULL);
d287 3
a289 2
	CServer* server=g_eMuleApp.m_pServerList->GetServerByAddress(sIP.GetBuffer(), nPort);
	if (server!=NULL) g_eMuleApp.m_pdlgEmule->SendMessage(WEB_REMOVE_FROM_STATIC, (WPARAM)server, NULL);
d595 1
a595 1
		if (sPage == "server")
d597 1
a597 1
		else if (sPage == "shared")
d599 1
a599 1
		else if (sPage == "transfer")
d601 1
a601 1
		else if (sPage == "search")
d603 1
a603 1
		else if (sPage == "graphs")
d605 1
a605 1
		else if (sPage == "log")
d607 1
a607 1
		if (sPage == "sinfo")
d609 1
a609 1
		if (sPage == "debuglog")
d611 1
a611 1
		if (sPage == "stats")
d613 1
a613 1
		if (sPage == "options")
d772 1
a772 1
	strCat="&cat="+_ParseURL(Data.sURL, "cat");
d774 1
a774 1
	if (sPage == "options" || sPage == "stats" || sPage == "password")
d785 1
a785 1
	int cat=atoi(_ParseURL(Data.sURL,"cat"));
d790 1
a790 1
		sCat.Format("&cat=%i", cat);
d927 1
a927 1
		_stprintf(HTTPHeader, "%.1f", static_cast<double>(100 * g_eMuleApp.m_pUploadQueue->GetDataRate()) / 102.4 / g_eMuleApp.m_pGlobPrefs->GetMaxGraphUploadRate());
d929 1
a929 1
		_stprintf(HTTPHeader, "%.1f", static_cast<double>(100 * g_eMuleApp.m_pUploadQueue->GetDataRate()) / 102.4 / g_eMuleApp.m_pGlobPrefs->GetMaxUpload());
d933 1
a933 1
		_stprintf(HTTPHeader, "%.1f", static_cast<double>(100 * g_eMuleApp.m_pDownloadQueue->GetDataRate()) / 102.4 / g_eMuleApp.m_pGlobPrefs->GetMaxGraphDownloadRate());
d935 1
a935 1
		_stprintf(HTTPHeader, "%.1f", static_cast<double>(100 * g_eMuleApp.m_pDownloadQueue->GetDataRate()) / 102.4 / g_eMuleApp.m_pGlobPrefs->GetMaxDownload());
d938 1
a938 1
	_stprintf(HTTPHeader, "%.1f", (static_cast<double>(g_eMuleApp.m_pListenSocket->GetNumOpenSockets()))/(g_eMuleApp.m_pGlobPrefs->GetMaxConnections())*100.0);
d940 1
a940 1
	_stprintf(HTTPHeader, "%.1f", (static_cast<double>(g_eMuleApp.m_pUploadQueue->GetDataRate())/1024.0));
d942 1
a942 1
	_stprintf(HTTPHeader, "%.1f", (static_cast<double>(g_eMuleApp.m_pDownloadQueue->GetDataRate())/1024.0));
d944 1
a944 1
	_stprintf(HTTPHeader, "%.0f", (static_cast<double>(g_eMuleApp.m_pListenSocket->GetNumOpenSockets())));
d965 1
a965 1
	if (dwMax == 65535)
d1012 1
a1012 1
	byte		cat = atoi(_ParseURL(Data.sURL,"cat"));
d1017 1
a1017 1
		sCat.Format("%i", cat);
d1205 1
a1205 1
		Out.Replace(_T("[ServernameI]"), (pThis->m_Params.ServerSort == SERVER_SORT_NAME) ? pcSortIcon : "");
d1218 1
a1218 1
		Out.Replace(_T("[AddressI]"), (pThis->m_Params.ServerSort == SERVER_SORT_IP) ? pcSortIcon : "");
d1231 1
a1231 1
		Out.Replace(_T("[DescriptionI]"), (pThis->m_Params.ServerSort == SERVER_SORT_DESCRIPTION) ? pcSortIcon : "");
d1244 1
a1244 1
		Out.Replace(_T("[PingI]"), (pThis->m_Params.ServerSort == SERVER_SORT_PING) ? pcSortIcon : "");
d1257 1
a1257 1
		Out.Replace(_T("[UsersI]"), (pThis->m_Params.ServerSort == SERVER_SORT_USERS) ? pcSortIcon : "");
d1270 1
a1270 1
		Out.Replace(_T("[FilesI]"), (pThis->m_Params.ServerSort == SERVER_SORT_FILES) ? pcSortIcon : "");
d1283 1
a1283 1
		Out.Replace(_T("[PriorityI]"), (pThis->m_Params.ServerSort == SERVER_SORT_PRIORITY) ? pcSortIcon : "");
d1296 1
a1296 1
		Out.Replace(_T("[FailedI]"), (pThis->m_Params.ServerSort == SERVER_SORT_FAILED) ? pcSortIcon : "");
d1309 1
a1309 1
		Out.Replace(_T("[LimitI]"), (pThis->m_Params.ServerSort == SERVER_SORT_LIMIT) ? pcSortIcon : "");
d1322 1
a1322 1
		Out.Replace(_T("[VersionI]"), (pThis->m_Params.ServerSort == SERVER_SORT_VERSION) ? pcSortIcon : "");
d1373 2
a1374 2
		CString temp,newip;
		for(int j=0; j<4; j++)
d1376 7
a1382 8
			temp = Entry.sServerIP.Tokenize(_T("."),counter);
			if (temp.GetLength() == 1)
				newip.AppendFormat("00" + temp);
			else if (temp.GetLength() == 2)
				newip.AppendFormat("0" + temp);
			else if (temp.GetLength() == 3)
				newip.AppendFormat("" + temp);
        }
d1386 1
a1386 1
			Entry.sServerState = "failed";
d1388 1
a1388 1
			Entry.sServerState = "disconnected";
d1394 1
a1394 1
				Entry.sServerState = "connecting";
d1402 1
a1402 1
					Entry.sServerState = "high";
d1404 1
a1404 1
					Entry.sServerState = "low";
d1482 1
a1482 1
			pcTmp = "checked";
d1484 1
a1484 1
			pcTmp = "checked_no";
d1623 1
a1623 1
	byte		cat = atoi(_ParseURL(Data.sURL,"cat"));
d1628 1
a1628 1
		sCat.Format("&cat=%i", cat);
d1677 2
a1678 2
		int iMenu = atoi(_ParseURL(Data.sURL, _T("m")));
		bool bValue = atoi(_ParseURL(Data.sURL, _T("v")));
d1690 2
a1691 2
		int iMenu = atoi(_ParseURL(Data.sURL, _T("m")));
		bool bValue = atoi(_ParseURL(Data.sURL, _T("v")));
d1703 2
a1704 2
		int iMenu = atoi(_ParseURL(Data.sURL, _T("m")));
		bool bValue = atoi(_ParseURL(Data.sURL, _T("v")));
d1799 1
a1799 1
						int iMenu = atoi(_ParseURL(Data.sURL, _T("filecat")));
d1953 1
a1953 1
	InsertCatBox(Out,cat,"",true,true,sSession,"");
d2034 1
a2034 1
		Out.Replace(_T("[DFilenameI]"), (pThis->m_Params.DownloadSort == DOWN_SORT_NAME) ? pcSortIcon : "");
d2047 1
a2047 1
		Out.Replace(_T("[DSizeI]"), (pThis->m_Params.DownloadSort == DOWN_SORT_SIZE) ? pcSortIcon : "");
d2060 1
a2060 1
		Out.Replace(_T("[DTransferredI]"), (pThis->m_Params.DownloadSort == DOWN_SORT_TRANSFERRED) ? pcSortIcon : "");
d2073 1
a2073 1
		Out.Replace(_T("[DProgressI]"), (pThis->m_Params.DownloadSort == DOWN_SORT_PROGRESS) ? pcSortIcon : "");
d2086 1
a2086 1
		Out.Replace(_T("[DSpeedI]"), (pThis->m_Params.DownloadSort == DOWN_SORT_SPEED) ? pcSortIcon : "");
d2099 1
a2099 1
		Out.Replace(_T("[DSourcesI]"), (pThis->m_Params.DownloadSort == DOWN_SORT_SOURCES) ? pcSortIcon : "");
d2112 1
a2112 1
		Out.Replace(_T("[DPriorityI]"), (pThis->m_Params.DownloadSort == DOWN_SORT_PRIORITY) ? pcSortIcon : "");
d2125 1
a2125 1
		Out.Replace(_T("[DCategoryI]"), (pThis->m_Params.DownloadSort == DOWN_SORT_CATEGORY) ? pcSortIcon : "");
d2138 1
a2138 1
		Out.Replace(_T("[DFakeCheckI]"), (pThis->m_Params.DownloadSort == DOWN_SORT_FAKECHECK) ? pcSortIcon : "");
d2153 1
a2153 1
		Out.Replace(_T("[UUserI]"), (pThis->m_Params.UploadSort == UP_SORT_USER) ? pcSortIcon : "");
d2166 1
a2166 1
		Out.Replace(_T("[UVersionI]"), (pThis->m_Params.UploadSort == UP_SORT_VERSION) ? pcSortIcon : "");
d2179 1
a2179 1
		Out.Replace(_T("[UFilenameI]"), (pThis->m_Params.UploadSort == UP_SORT_FILENAME) ? pcSortIcon : "");
d2192 1
a2192 1
		Out.Replace(_T("[UTransferredI]"), (pThis->m_Params.UploadSort == UP_SORT_TRANSFERRED) ? pcSortIcon : "");
d2205 1
a2205 1
		Out.Replace(_T("[USpeedI]"), (pThis->m_Params.UploadSort == UP_SORT_SPEED) ? pcSortIcon : "");
d2272 1
a2272 1
				dFile.sFileState = "downloading";
d2277 1
a2277 1
					dFile.sFileState = "stalled";
d2279 1
a2279 1
					dFile.sFileState = "waiting";
d2285 1
a2285 1
					dFile.sFileState = "hashing";
d2288 1
a2288 1
					dFile.sFileState = "waitinghash";
d2291 1
a2291 1
					dFile.sFileState = "error";
d2294 1
a2294 1
					dFile.sFileState = "completing";
d2297 1
a2297 1
					dFile.sFileState = "complete";
d2300 1
a2300 1
					dFile.sFileState = "stopped";
d2303 1
a2303 1
					dFile.sFileState = "paused";
d2821 1
a2821 1
		InsertCatBox(HTTPProcessData,0,"",false,false,sSession,FilesArray[i].sFileHash);
d2959 1
a2959 1
			if (QueueArray[i].sClientExtra == "banned")
d3055 1
a3055 1
			if (QueueArray[i].sClientExtra == "credit")
d3146 1
a3146 1
		Out.Replace(_T("[UserNameTitleI]"), (pThis->m_Params.QueueSort == QU_SORT_USER) ? pcSortIcon : "");
d3159 1
a3159 1
		Out.Replace(_T("[VersionI]"), (pThis->m_Params.QueueSort == QU_SORT_VERSION) ? pcSortIcon : "");
d3172 1
a3172 1
		Out.Replace(_T("[FileNameTitleI]"), (pThis->m_Params.QueueSort == QU_SORT_FILENAME) ? pcSortIcon : "");
d3185 1
a3185 1
		Out.Replace(_T("[ScoreTitleI]"), (pThis->m_Params.QueueSort == QU_SORT_SCORE) ? pcSortIcon : "");
d3209 1
a3209 1
	byte	cat = atoi(_ParseURL(Data.sURL, "cat"));
d3213 1
a3213 1
		sCat.Format("%i", cat);
d3271 1
a3271 1
				if (strTmp == "verylow")
d3273 1
a3273 1
				else if (strTmp == "low")
d3275 1
a3275 1
				else if (strTmp == "normal")
d3277 1
a3277 1
				else if (strTmp == "high")
d3279 1
a3279 1
				else if (strTmp == "release")
d3281 1
a3281 1
				else if (strTmp == "auto")
d3308 1
a3308 1
		if (_ParseURL(Data.sURL, _T("jumpstart")) == "true")
d3310 1
a3310 1
		else if (_ParseURL(Data.sURL, _T("jumpstart")) == "false")
d3313 1
a3313 1
	if(_ParseURL(Data.sURL, _T("reload")) == "true")
d3318 1
a3318 1
	strTmp = (pThis->m_Params.bSharedSortReverse) ? "false" : "true";
d3422 1
a3422 1
		Out.Replace(_T("[FilenameI]"), (pThis->m_Params.SharedSort == SHARED_SORT_NAME) ? pcSortIcon : "");
d3435 1
a3435 1
		pcIconTmp = (pThis->m_Params.SharedSort == SHARED_SORT_TRANSFERRED) ? pcSortIcon : "";
d3451 1
a3451 1
		pcIconTmp = (pThis->m_Params.SharedSort == SHARED_SORT_REQUESTS) ? pcSortIcon : "";
d3467 1
a3467 1
		pcIconTmp = (pThis->m_Params.SharedSort == SHARED_SORT_ACCEPTS) ? pcSortIcon : "";
d3483 1
a3483 1
		Out.Replace(_T("[SizeI]"), (pThis->m_Params.SharedSort == SHARED_SORT_SIZE) ? pcSortIcon : "");
d3496 1
a3496 1
		Out.Replace(_T("[CompletesI]"), (pThis->m_Params.SharedSort == SHARED_SORT_COMPLETES) ? pcSortIcon : "");
d3509 1
a3509 1
		Out.Replace(_T("[PriorityI]"), (pThis->m_Params.SharedSort == SHARED_SORT_PRIORITY) ? pcSortIcon : "");
d3672 2
a3673 2
		if (SharedArray[i].sFileHash == _ParseURL(Data.sURL,_T("hash")) )
            HTTPProcessData.Replace(_T("[LastChangedDataset]"), "checked");
d3675 1
a3675 1
            HTTPProcessData.Replace(_T("[LastChangedDataset]"), "checked_no");
d3726 1
a3726 1
				HTTPProcessData.Replace(_T("[FileIsPriority]"), "jumpstart");
d3729 1
a3729 1
				HTTPProcessData.Replace(_T("[FileIsPriority]"), "release");
d3731 1
a3731 1
				HTTPProcessData.Replace(_T("[FileIsPriority]"), "none");
d3759 1
a3759 1
			HTTPProcessData.Replace(_T("[FileAllTimeTransferred]"), " ("+CString(HTTPTempC)+")");
d3771 1
a3771 1
			HTTPProcessData.Replace(_T("[FileAllTimeRequests]"), " ("+CString(HTTPTempC)+")");
d3783 1
a3783 1
			HTTPProcessData.Replace(_T("[FileAllTimeAccepts]"), " ("+CString(HTTPTempC)+")");
d3889 1
a3889 1
	byte		cat = atoi(_ParseURL(Data.sURL,"cat"));
d3894 1
a3894 1
		sCat.Format("%i", cat);
d3909 2
a3910 2
			CServer* server=g_eMuleApp.m_pServerList->GetServerByAddress(_ParseURL(Data.sURL, _T("serveraddr")),atoi(_ParseURL(Data.sURL, _T("serverport"))));
			if (_ParseURL(Data.sURL, _T("priority")) == "low")
d3912 1
a3912 1
			else if (_ParseURL(Data.sURL, _T("priority")) == "normal")
d3914 1
a3914 1
			else if (_ParseURL(Data.sURL, _T("priority")) == "high")
d3919 1
a3919 1
			if(_ParseURL(Data.sURL, _T("addtostatic")) == "true")
d3921 2
a3922 2
				_AddToStatic(_ParseURL(Data.sURL, _T("serveraddr")),atoi(_ParseURL(Data.sURL, _T("serverport"))));
				resultlog += "<br>";
d3925 2
a3926 2
			resultlog = resultlog.TrimRight('\n');
			resultlog = resultlog.Mid(resultlog.ReverseFind('\n'));
d3928 2
a3929 2
			if(_ParseURL(Data.sURL, _T("connectnow")) == "true")
				_ConnectToServer(_ParseURL(Data.sURL, _T("serveraddr")),atoi(_ParseURL(Data.sURL, _T("serverport"))));
d3934 1
a3934 1
	else if(_ParseURL(Data.sURL, _T("updateservermetfromurl")) == "true")
d3938 2
a3939 2
		resultlog = resultlog.TrimRight('\n');
		resultlog = resultlog.Mid(resultlog.ReverseFind('\n'));
d3981 1
a3981 1
	byte		cat = atoi(_ParseURL(Data.sURL,"cat"));
d3986 1
a3986 1
		sCat.Format("%i", cat);
d3992 1
a3992 1
	if (_ParseURL(Data.sURL, _T("clear")) == "yes" && IsSessionAdmin(Data,sSession))
d3999 1
a3999 1
	Out.Replace(_T("[Log]"), g_eMuleApp.m_pdlgEmule->m_wndServer.m_pctlLogBox->GetHtml()+"<br><a name=\"end\"></a>");
d4018 1
a4018 1
	byte		cat = atoi(_ParseURL(Data.sURL,"cat"));
d4023 1
a4023 1
		sCat.Format("%i", cat);
d4029 1
a4029 1
	if (_ParseURL(Data.sURL, _T("clear")) == "yes" && IsSessionAdmin(Data,sSession))
d4036 1
a4036 1
	Out.Replace(_T("[ServerInfo]"), g_eMuleApp.m_pdlgEmule->m_wndServer.m_pctlServerMsgBox->GetHtml()+"<br><a name=\"end\"></a>" );
d4055 1
a4055 1
	byte		cat = atoi(_ParseURL(Data.sURL,"cat"));
d4060 1
a4060 1
		sCat.Format("%i", cat);
d4066 1
a4066 1
	if (_ParseURL(Data.sURL, _T("clear")) == "yes" && IsSessionAdmin(Data,sSession))
d4073 1
a4073 1
	Out.Replace(_T("[DebugLog]"), g_eMuleApp.m_pdlgEmule->m_wndServer.m_pctlDebugBox->GetHtml()+"<br><a name=\"end\"></a>" );
d4117 1
a4117 1
	byte		cat = atoi(_ParseURL(Data.sURL,"cat"));
d4122 1
a4122 1
		sCat.Format("%i", cat);
d4129 1
a4129 1
	if ((_ParseURL(Data.sURL, _T("saveprefs")) == "true") && IsSessionAdmin(Data,sSession) )
d4131 1
a4131 1
		if(_ParseURL(Data.sURL, _T("gzip")) == "true" || _ParseURL(Data.sURL, _T("gzip")).MakeLower() == "on")
d4133 1
a4133 1
		if(_ParseURL(Data.sURL, _T("gzip")) == "false" || _ParseURL(Data.sURL, _T("gzip")).IsEmpty())
d4135 1
a4135 1
		if(_ParseURL(Data.sURL, _T("showuploadqueue")) == "true" || _ParseURL(Data.sURL, _T("showuploadqueue")).MakeLower() == "on" )
d4139 1
a4139 1
		if(_ParseURL(Data.sURL, _T("showuploadqueuebanned")) == "true" || _ParseURL(Data.sURL, _T("showuploadqueuebanned")).MakeLower() == "on" )
d4143 1
a4143 1
		if(_ParseURL(Data.sURL, _T("showuploadqueuefriend")) == "true" || _ParseURL(Data.sURL, _T("showuploadqueuefriend")).MakeLower() == "on" )
d4147 1
a4147 1
		if(_ParseURL(Data.sURL, _T("showuploadqueuecredit")) == "true" || _ParseURL(Data.sURL, _T("showuploadqueuecredit")).MakeLower() == "on" )
d4310 1
a4310 1
		Out.Replace(_T("[FailedLogin]"), "&nbsp;");
d4381 1
a4381 1
		return _T("");
d4419 1
a4419 1
		return _T("");
d4464 1
a4464 1
	long sessionID = _tstoi64(strSsessionID);
d4636 1
a4636 1
	byte cat=atoi(_ParseURL(Data.sURL, "cat"));
d4664 1
a4664 1
		sCat.Format("%i", cat);
d4687 1
a4687 1
			(_ParseURL(Data.sURL, _T("global"))=="on"),	_T(""));
d4695 1
a4695 1
	CString strTmp = _ParseURL(Data.sURL, "sort");
d4698 2
a4699 2
		pThis->m_iSearchSortby = atoi(strTmp);
	strTmp = _ParseURL(Data.sURL, "sortAsc");
d4701 1
a4701 1
		pThis->m_bSearchAsc = atoi(strTmp);
d4724 1
a4724 1
		Out.Replace("[CATBOX]",_T(""));
d4760 2
a4761 4
	CString checked;
	if(g_eMuleApp.m_pGlobPrefs->GetSearchMethod() == EP_SEARCHMETHOD_GLOB)
		checked = "checked";
	Out.Replace(_T("[checked]"), checked);
d4768 1
a4768 1
		Out.Replace(_T("[FilenameI]"), (pThis->m_iSearchSortby == 0) ? pcSortIcon : "");
d4781 1
a4781 1
		Out.Replace(_T("[FilesizeI]"), (pThis->m_iSearchSortby == 1) ? pcSortIcon : "");
d4794 1
a4794 1
		Out.Replace(_T("[FilehashI]"), (pThis->m_iSearchSortby == 2) ? pcSortIcon : "");
d4807 1
a4807 1
		Out.Replace(_T("[SourcesI]"), (pThis->m_iSearchSortby == 3) ? pcSortIcon : "");
d4820 1
a4820 1
		Out.Replace(_T("[FakeCheckI]"), (pThis->m_iSearchSortby == 4) ? pcSortIcon : "");
d4832 12
a4843 12
	strTmp.Format("%i",(pThis->m_iSearchSortby!=0 || (pThis->m_iSearchSortby==0 && pThis->m_bSearchAsc==0 ))?1:0 );
	Out.Replace("[SORTASCVALUE0]", strTmp);
	strTmp.Format("%i",(pThis->m_iSearchSortby!=1 || (pThis->m_iSearchSortby==1 && pThis->m_bSearchAsc==0 ))?1:0 );
	Out.Replace("[SORTASCVALUE1]", strTmp);
	strTmp.Format("%i",(pThis->m_iSearchSortby!=2 || (pThis->m_iSearchSortby==2 && pThis->m_bSearchAsc==0 ))?1:0 );
	Out.Replace("[SORTASCVALUE2]", strTmp);
	strTmp.Format("%i",(pThis->m_iSearchSortby!=3 || (pThis->m_iSearchSortby==3 && pThis->m_bSearchAsc==0 ))?1:0 );
	Out.Replace("[SORTASCVALUE3]", strTmp);
	strTmp.Format("%i",(pThis->m_iSearchSortby!=4 || (pThis->m_iSearchSortby==4 && pThis->m_bSearchAsc==0 ))?1:0 );
	Out.Replace("[SORTASCVALUE4]", strTmp);
	strTmp.Format("%i",(pThis->m_iSearchSortby!=5 || (pThis->m_iSearchSortby==5 && pThis->m_bSearchAsc==0 ))?1:0 );
	Out.Replace("[SORTASCVALUE5]", strTmp);
d4875 1
a4875 1
	CString tempBuf = "<form><select name=\"cat\" size=\"1\"";
d4877 4
a4880 4
	if (jump)
		tempBuf += "onchange=GotoCat(this.form.cat.options[this.form.cat.selectedIndex].value)>";
	else
		tempBuf += ">";
d4884 1
a4884 1
		CString strCategory = (i==0)?_GetPlainResString(IDS_CAT_UNCATEGORIZED):CCat::GetUserCatByIndex(i)->GetTitle();
d4886 1
a4886 1
		tempBuf.AppendFormat("<option%s value=\"%i\">%s</option>", (i == preselect) ? " selected" : "", i, strCategory);
d4891 1
a4891 3
		{
			tempBuf += "<option>------------</option>";
		}
d4895 1
a4895 1
			tempBuf.AppendFormat("<option%s value=\"%i\">%s</option>", (i == preselect) ? " selected" : "", i+100, GetSubCatLabel(i));
d4898 2
a4899 2
	tempBuf.Append("</select></form>");
	Out.Replace("[CATBOX]",boxlabel+tempBuf);
d4902 2
a4903 2
	CString tempBuff;
	CString		strCategory;
d4909 1
a4909 1
			tempBuff3 = "checked.gif";
d4916 1
a4916 1
			tempBuff3 = "checked_no.gif";
d4921 2
a4922 2
		tempBuff.AppendFormat("<a href=&quot;/?ses=%s&w=transfer&cat=%d&quot;>"
			"<div class=menuitems><img class=menuchecked src=%s>%s&nbsp;</div></a>",
d4931 1
a4931 1
				tempBuff3= "checked.gif";
d4935 1
a4935 1
				tempBuff3 = "checked_no.gif";
d4937 2
a4938 2
			tempBuff.AppendFormat("<a href=&quot;/?ses=%s&w=transfer&cat=%d&quot;>"
				"<div class=menuitems><img class=menuchecked src=%s>%s&nbsp;</div></a>",
d4942 2
a4943 2
	Out.Replace("[CatBox]",tempBuff);
	Out.Replace("[Category]",tempBuff4);
d4945 1
a4945 1
	tempBuff.Empty();
d4957 2
a4958 7
		if (i==preselect)
		{
			tempBuff3 = "checked.gif";
			tempBuff4 = CCat::GetCatByUserIndex(i)->GetTitle();
		}
		else
			tempBuff3 = "checked_no.gif";
d4963 2
a4964 2
		tempBuff.AppendFormat("<a href=&quot;/?ses=%s&w=transfer[CatSel]&op=setcat&file=%s&filecat=%d&quot;>"
			"<div class=menuitems><img class=menuchecked src=%s>%s&nbsp;</div></a>",
d4967 1
a4967 1
	Out.Replace("[SetCatBox]",tempBuff);
@


1.317
log
@Unified search methods.
@
text
@d4759 1
a4759 1
	if(g_eMuleApp.m_pGlobPrefs->GetSearchMethod() == EP_SEARCHTYPE_GLOB)
@


1.316
log
@Modifications for the legends of Page Refresh (Timer) and page title
@
text
@d4759 1
a4759 1
	if(g_eMuleApp.m_pGlobPrefs->GetMethod()==1)
@


1.315
log
@A little bit faster string processing.
@
text
@d793 1
d796 1
a797 1
	Out.Replace(_T("[WebControl]"), _GetPlainResString(IDS_WEB_CONTROL));
d856 3
a858 2
	Out.Replace(_T("[SetTimerOn]"), _GetPlainResString(IDS_TIMER_ON, true));
	Out.Replace(_T("[SetTimerOff]"), _GetPlainResString(IDS_TIMER_OFF, true));
d4297 1
@


1.314
log
@WebServer: added tooltips for Clear All and Timer On/Off
@
text
@d2219 3
a2221 3
	CString strClearAllCompleted = _GetPlainResString(IDS_TREE_DL_CLEAR_ALL_COMPLETED);
	strClearAllCompleted.Replace(_T(":"), _T(""));
	Out.Replace(_T("[ClearAllCompleted]"), strClearAllCompleted);
@


1.313
log
@Unified processing of server priorities.
@
text
@d855 3
d2219 4
@


1.312
log
@Unified display of file permission and upload file priority.
@
text
@d1057 1
a1057 1
			server->SetPreference((CServer::EnumServerPriority)PR_LOW);
d1067 1
a1067 1
			server->SetPreference((CServer::EnumServerPriority)PR_NORMAL);
d1077 1
a1077 1
			server->SetPreference((CServer::EnumServerPriority)PR_HIGH);
d1345 1
a1345 1
		if(cur_file->GetPreferences()== CServer::SERVERPRIORITY_HIGH)
d1350 1
a1350 1
		else if(cur_file->GetPreferences()== CServer::SERVERPRIORITY_NORMAL)
d1355 1
a1355 1
		else if(cur_file->GetPreferences()== CServer::SERVERPRIORITY_LOW)
d3900 1
a3900 1
				server->SetPreference((CServer::EnumServerPriority)PR_LOW);
d3902 1
a3902 1
				server->SetPreference((CServer::EnumServerPriority)PR_NORMAL);
d3904 1
a3904 1
				server->SetPreference((CServer::EnumServerPriority)PR_NORMAL);
@


1.311
log
@Minor fix for WebServer (display of get first/last for a complete file) and a minor change (added total active downloads to the download footer)
@
text
@a3522 1
		uint32	dwResId;
d3573 1
a3573 29

		if (cur_file->IsULAutoPrioritized())
		{
			if (cur_file->GetULPriority() == PR_NORMAL)
				dwResId = IDS_PRIOAUTONORMAL;
			else if (cur_file->GetULPriority() == PR_HIGH)
				dwResId = IDS_PRIOAUTOHIGH;
			else if (cur_file->GetULPriority() == PR_RELEASE)
				dwResId = IDS_PRIOAUTORELEASE;
			else	//PR_LOW
				dwResId = IDS_PRIOAUTOLOW;
		}
		else
		{
			if (cur_file->GetULPriority() == PR_LOW)
				dwResId = IDS_PRIOLOW;
			else if (cur_file->GetULPriority() == PR_NORMAL)
				dwResId = IDS_PRIONORMAL;
			else if (cur_file->GetULPriority() == PR_HIGH)
				dwResId = IDS_PRIOHIGH;
			else if (cur_file->GetULPriority() == PR_RELEASE)
				dwResId = IDS_PRIORELEASE;
			else	//PR_VERYLOW
				dwResId = IDS_PRIOVERYLOW;
		}
		if (cur_file->GetJumpstartEnabled())
			dFile.sFilePriority.Format(_T("JumpStart[%s]"), GetResString(dwResId));
		else
			GetResString(&dFile.sFilePriority, dwResId);
@


1.310
log
@Changed inteface for the previous "UL queue improvement" to reduce performance loss.
@
text
@d2698 1
a2698 1
		if (!FilesArray[i].bIsPreview && FilesArray[i].bIsGetFLC)
d2823 2
a2824 1
	HTTPTemp.Format(_T("%s: %i"), GetResString(IDS_SF_FILE), g_eMuleApp.m_pDownloadQueue->GetFileCount());
@


1.309
log
@improvement for UL queue:
1) used STL
2) fixed access to the queue from WebServer
@
text
@d2388 1
a2388 2
	ClientList* pCopyUploadQueueList = g_eMuleApp.m_pUploadQueue->GetCopyUploadQueueList();
	ClientList::const_iterator cIt;
d2390 2
a2391 1
	if (pCopyUploadQueueList)
d2393 10
a2402 1
		for ( cIt = pCopyUploadQueueList->begin( ); cIt != pCopyUploadQueueList->end( ); cIt++ )
d2404 2
a2405 51
			CUpDownClient* cur_client = *cIt;
			UploadUsers dUser;
			CString sTemp;
			dUser.sUserHash = HashToString(cur_client->GetUserHash());
			if (cur_client->GetDataRate() > 0)
			{
				dUser.sActive = _T("downloading");
				dUser.sClientState = _T("uploading");
			}
			else
			{
				dUser.sActive = _T("waiting");
				dUser.sClientState = _T("connecting");
			}
			sTemp = _SpecialChars(cur_client->GetUploadFileInfo());
			sTemp.Replace(_T("\n"), _T("<br>"));
			sTemp.Replace(_T("'"), _T("&#8217;"));
			dUser.sFileInfo = sTemp;

			dwClientSoft = cur_client->GetClientSoft();
			if ( ((dwClientSoft == SO_EMULE) || (dwClientSoft == SO_PLUS)) &&
				(cur_client->m_pCredits->GetCurrentIdentState(cur_client->GetIP()) != IS_IDENTIFIED) )
			{
				dwClientSoft = SO_OLDEMULE;
			}
			sTemp.Format(_T("%u"), dwClientSoft);
			dUser.sClientSoft = sTemp;
			dUser.sClientSoftSpecial = sTemp;
			if (cur_client->IsBanned())
				dUser.sClientExtra = _T("banned");
			else if (cur_client->IsFriend())
				dUser.sClientExtra = _T("friend");
			else if (cur_client->m_pCredits->GetScoreRatio(cur_client->GetIP()) > 1)
				dUser.sClientExtra = _T("credit");
			else
				dUser.sClientExtra = _T("none");
			if(cur_client->GetUserName().GetLength() > SHORT_LENGTH_MIN)
				dUser.sUserName = _SpecialChars(cur_client->GetUserName().Left(SHORT_LENGTH_MIN-3)) + _T("...");
			else
				dUser.sUserName = _SpecialChars(cur_client->GetUserName());
			CKnownFile* file = g_eMuleApp.m_pSharedFilesList->GetFileByID(cur_client->m_reqFileHash);
			if (file)
				dUser.sFileName = _SpecialChars(CString(file->GetFileName()));
			else
				dUser.sFileName = _GetPlainResString(IDS_REQ_UNKNOWNFILE);
			dUser.nTransferredDown = cur_client->GetTransferredDown();
			dUser.nTransferredUp = cur_client->GetTransferredUp();
			sint32 iDataRate = cur_client->GetDataRate();
			dUser.nDataRate = ((iDataRate == -1) ? 0 : iDataRate);
			dUser.sClientNameVersion = cur_client->GetClientNameAndVersionString();
			UploadArray.Add(dUser);
d2407 4
d2412 32
a2443 1
		delete pCopyUploadQueueList;
d2446 1
a2446 1
// Sorting (simple bubble sort, we don't have tons of data here)
@


1.308
log
@WebServer: socket closure after template loading error {muleteer};
Improved string processing; Formatting.
@
text
@d2387 3
d2391 1
a2391 2
	CArray<UploadUsers, UploadUsers> UploadArray;
	for (POSITION pos = g_eMuleApp.m_pUploadQueue->uploadinglist.GetHeadPosition(); pos != NULL;)
d2393 1
a2393 5
		CUpDownClient* cur_client = g_eMuleApp.m_pUploadQueue->uploadinglist.GetNext(pos);
		UploadUsers dUser;
		CString sTemp;
		dUser.sUserHash = HashToString(cur_client->GetUserHash());
		if (cur_client->GetDataRate() > 0)
d2395 51
a2445 7
			dUser.sActive = _T("downloading");
			dUser.sClientState = _T("uploading");
		}
		else
		{
			dUser.sActive = _T("waiting");
			dUser.sClientState = _T("connecting");
a2446 4
		sTemp = _SpecialChars(cur_client->GetUploadFileInfo());
		sTemp.Replace(_T("\n"), _T("<br>"));
		sTemp.Replace(_T("'"), _T("&#8217;"));
		dUser.sFileInfo = sTemp;
d2448 1
a2448 32
		dwClientSoft = cur_client->GetClientSoft();
		if ( ((dwClientSoft == SO_EMULE) || (dwClientSoft == SO_PLUS)) &&
			(cur_client->m_pCredits->GetCurrentIdentState(cur_client->GetIP()) != IS_IDENTIFIED) )
		{
			dwClientSoft = SO_OLDEMULE;
		}
		sTemp.Format(_T("%u"), dwClientSoft);
		dUser.sClientSoft = sTemp;
		dUser.sClientSoftSpecial = sTemp;
		if (cur_client->IsBanned())
			dUser.sClientExtra = _T("banned");
		else if (cur_client->IsFriend())
			dUser.sClientExtra = _T("friend");
		else if (cur_client->m_pCredits->GetScoreRatio(cur_client->GetIP()) > 1)
			dUser.sClientExtra = _T("credit");
		else
			dUser.sClientExtra = _T("none");
		if(cur_client->GetUserName().GetLength() > SHORT_LENGTH_MIN)
			dUser.sUserName = _SpecialChars(cur_client->GetUserName().Left(SHORT_LENGTH_MIN-3)) + _T("...");
		else
			dUser.sUserName = _SpecialChars(cur_client->GetUserName());
		CKnownFile* file = g_eMuleApp.m_pSharedFilesList->GetFileByID(cur_client->m_reqFileHash);
		if (file)
			dUser.sFileName = _SpecialChars(CString(file->GetFileName()));
		else
			dUser.sFileName = _GetPlainResString(IDS_REQ_UNKNOWNFILE);
		dUser.nTransferredDown = cur_client->GetTransferredDown();
		dUser.nTransferredUp = cur_client->GetTransferredUp();
		sint32 iDataRate = cur_client->GetDataRate();
		dUser.nDataRate = ((iDataRate == -1) ? 0 : iDataRate);
		dUser.sClientNameVersion = cur_client->GetClientNameAndVersionString();
		UploadArray.Add(dUser);
d2451 1
a2451 1
	// Sorting (simple bubble sort, we don't have tons of data here)
@


1.307
log
@WebServer: improved selection of the sorting direction for alphabetical columns;
WebServer: fixed possibility to apply Auto upload priority for shared files;
WebServer: fixed reporting JumpStart together with Auto upload priority;
Improved string processing and general optimization.
@
text
@d86 3
a88 5
	CString sFile;
	if (g_eMuleApp.m_pGlobPrefs->GetTemplate().IsEmpty() || g_eMuleApp.m_pGlobPrefs->GetTemplate().MakeLower()=="emulexp.tmpl")
		sFile= g_eMuleApp.m_pGlobPrefs->GetAppDir() + CString("eMuleXP.tmpl");
	else
		sFile=g_eMuleApp.m_pGlobPrefs->GetTemplate();
d112 1
a112 1
            m_bServerWorking = false;
d170 7
a176 8
	else
        if(m_bServerWorking)
		{
			AddLogLine(true, RGB_LOG_ERROR + GetResString(IDS_WEB_ERR_CANTLOAD), sFile);
			StopSockets();
            m_bServerWorking = false;
			g_eMuleApp.m_pGlobPrefs->SetWSIsEnabled(false);
		}
d242 7
a248 4
		StartSockets(this);
		m_nIntruderDetect = 0;
		m_nStartTempDisabledTime = 0;
		m_bIsTempDisabled = false;
@


1.306
log
@JumpStart was allowed for small files causing malfunction;
Removed unrequired string localization.
@
text
@d1101 2
d1106 1
d1108 2
d1113 1
d1115 2
d1133 1
a1133 1
			pThis->m_Params.bServerSortReverse = false;
a1623 1

d1824 1
d1828 1
d1834 1
d1836 2
d1851 1
d1853 2
d1858 1
d1860 2
d1867 1
d1869 2
d1878 1
d1880 2
d1885 1
d1887 2
d1892 9
a1900 6
		if ((sSort.GetAt(0) == 'd') && strTmp.IsEmpty())
			pThis->m_Params.bDownloadSortReverse = false;
		if ((sSort.GetAt(0) == 'u') && strTmp.IsEmpty())
			pThis->m_Params.bUploadSortReverse = false;
		if ((sSort.GetAt(0) == 'q') && strTmp.IsEmpty())
			pThis->m_Params.bQueueSortReverse = false;
d1905 1
d1907 5
a1911 5
			pThis->m_Params.bDownloadSortReverse = (strTmp == "true");
		if (sSort.GetAt(0) == 'u')
			pThis->m_Params.bUploadSortReverse = (strTmp == "true");
		if (sSort.GetAt(0) == 'q')
			pThis->m_Params.bQueueSortReverse = (strTmp == "true");
d3195 2
a3196 3
	byte		cat = atoi(_ParseURL(Data.sURL,"cat"));

	CString sCat;
d3201 3
a3203 2
	CString sSession = _ParseURL(Data.sURL, _T("ses"));
	bool bAdmin = IsSessionAdmin(Data,sSession);
d3205 2
a3206 1
	if (!_ParseURL(Data.sURL, _T("sort")).IsEmpty())
d3208 3
a3210 1
		if(_ParseURL(Data.sURL, _T("sort")) == "state")
d3212 1
a3212 1
		else if(_ParseURL(Data.sURL, _T("sort")) == "type")
d3214 2
a3215 1
		else if(_ParseURL(Data.sURL, _T("sort")) == "name")
d3217 3
a3219 1
		else if(_ParseURL(Data.sURL, _T("sort")) == "size")
d3221 1
a3221 1
		else if(_ParseURL(Data.sURL, _T("sort")) == "transferred")
d3223 1
a3223 1
		else if(_ParseURL(Data.sURL, _T("sort")) == "alltimetransferred")
d3225 1
a3225 1
		else if(_ParseURL(Data.sURL, _T("sort")) == "requests")
d3227 1
a3227 1
		else if(_ParseURL(Data.sURL, _T("sort")) == "alltimerequests")
d3229 1
a3229 1
		else if(_ParseURL(Data.sURL, _T("sort")) == "accepts")
d3231 1
a3231 1
		else if(_ParseURL(Data.sURL, _T("sort")) == "alltimeaccepts")
d3233 1
a3233 1
		else if(_ParseURL(Data.sURL, _T("sort")) == "completes")
d3235 1
a3235 1
		else if(_ParseURL(Data.sURL, _T("sort")) == "priority")
d3238 2
a3239 2
		if(_ParseURL(Data.sURL, _T("sortreverse")).IsEmpty())
			pThis->m_Params.bSharedSortReverse = false;
d3241 2
a3242 2
	if (!_ParseURL(Data.sURL, _T("sortreverse")).IsEmpty())
		pThis->m_Params.bSharedSortReverse = (_ParseURL(Data.sURL, _T("sortreverse")) == "true");
d3251 1
a3251 2

			cur_file=g_eMuleApp.m_pSharedFilesList->GetFileByID(fileid);
d3255 3
a3257 3
				if(_ParseURL(Data.sURL, _T("prio")) == "verylow")
				{
					cur_file->SetAutoULPriority(false);
d3259 1
a3259 4
				}
				if(_ParseURL(Data.sURL, _T("prio")) == "low")
				{
					cur_file->SetAutoULPriority(false);
d3261 1
a3261 4
				}
				if(_ParseURL(Data.sURL, _T("prio")) == "normal")
				{
					cur_file->SetAutoULPriority(false);
d3263 1
a3263 4
				}
				if(_ParseURL(Data.sURL, _T("prio")) == "high")
				{
					cur_file->SetAutoULPriority(false);
d3265 1
a3265 4
				}
				if(_ParseURL(Data.sURL, _T("prio")) == "release")
				{
					cur_file->SetAutoULPriority(false);
d3267 1
a3267 2
				}
				else if(_ParseURL(Data.sURL, _T("prio")) == "auto" && cur_file->IsPartFile())
d3273 1
a3273 1
				g_eMuleApp.m_pSharedFilesList->UpdateItem(cur_file); // DonGato: refresh GUI on priority change
d3303 2
a3304 1
	CString strTmp = (pThis->m_Params.bSharedSortReverse) ? "false" : "true";
d3322 1
a3322 1
    if(pThis->m_Params.SharedSort == SHARED_SORT_SIZE)
d3327 1
a3327 1
    if(pThis->m_Params.SharedSort == SHARED_SORT_COMPLETES)
a3518 1
		CString buffer;
d3520 1
d3574 2
a3575 4
			if (cur_file->GetULPriority() == PR_LOW)
				dFile.sFilePriority = _GetPlainResString(IDS_PRIOAUTOLOW);
			else if (cur_file->GetULPriority() == PR_NORMAL)
				dFile.sFilePriority = _GetPlainResString(IDS_PRIOAUTONORMAL);
d3577 1
a3577 1
				dFile.sFilePriority = _GetPlainResString(IDS_PRIOAUTOHIGH);
d3579 3
a3581 1
				dFile.sFilePriority = _GetPlainResString(IDS_PRIOAUTORELEASE);
d3585 2
a3586 5
			// unused  CString sPriority;
			if (cur_file->GetULPriority() == PR_VERYLOW)
				dFile.sFilePriority = _GetPlainResString(IDS_PRIOVERYLOW);
			else if (cur_file->GetULPriority() == PR_LOW)
				dFile.sFilePriority = _GetPlainResString(IDS_PRIOLOW);
d3588 1
a3588 1
				dFile.sFilePriority = _GetPlainResString(IDS_PRIONORMAL);
d3590 1
a3590 1
				dFile.sFilePriority = _GetPlainResString(IDS_PRIOHIGH);
d3592 3
a3594 6
				dFile.sFilePriority = _GetPlainResString(IDS_PRIORELEASE);
			if (cur_file->GetJumpstartEnabled())
			{
				buffer.Format(_T("JumpStart[%s]"), dFile.sFilePriority);
				dFile.sFilePriority = buffer;
			}
d3596 4
@


1.305
log
@WebServer: fixed limitless download configuration when upload limit < 10 {muleteer}.
@
text
@d306 3
a308 1
	cur_file->SetJumpstartEnabled(true);
a844 1
	Out.Replace(_T("[Jumpstart]"), _T("JumpStart"));
@


1.304
log
@WebServer: faster way to detect file type as well as more file extentions added
(thanks eklmn for idea);
WebServer: some file types were incorrectly represented in the lists.
@
text
@a1656 2
	else
		HTTPTemp.Empty();
d4254 2
a4255 1
	uint32	dwNum = g_eMuleApp.m_pGlobPrefs->GetMaxDownload();
@


1.303
log
@Renamed resource strings tags for better meaning.
@
text
@d2222 1
a2222 3
			CString strFileName = _SpecialChars(pPartFile->GetFileName());
			strFileName.MakeLower(); // Purity: show FileType Icons in WebServer
			dFile.sFileType = g_eMuleApp.m_pSearchList->GetFileType(strFileName.Right(4));
a3506 1
		CString strFileName = _SpecialChars(cur_file->GetFileName());
d3511 1
a3511 2
		strFileName.MakeLower();
		dFile.sFileType = g_eMuleApp.m_pSearchList->GetFileType(strFileName.Right(4));
@


1.302
log
@Minor change in how we limit file/server names
@
text
@d971 2
a972 2
	Out.Replace(_T("[Up]"), _GetPlainResString(IDS_PW_CON_UPLBL));
	Out.Replace(_T("[Down]"), _GetPlainResString(IDS_PW_CON_DOWNLBL));
d4828 1
a4828 1
	Out.Replace(_T("[Download]"), _GetPlainResString(IDS_DOWNLOAD));
@


1.301
log
@Removed double strings.
@
text
@d882 1
a882 1
			HTTPConText = CString(cur_server->GetListName().Left(SHORT_LENGTH) + _T("..."));
d1508 1
a1508 1
				HTTPProcessData.Replace(_T("[Servername]"), _T("<acronym title=\"") + ServerArray[i].sServerName + _T("\">") + ServerArray[i].sServerName.Left(SHORT_LENGTH) + _T("...") + _T("</acronym>"));
d1524 1
a1524 1
				HTTPProcessData.Replace(_T("[Description]"), _T("<acronym title=\"") + ServerArray[i].sServerDescription + _T("\">") + ServerArray[i].sServerDescription.Left(SHORT_LENGTH) + _T("...") + _T("</acronym>"));
d1581 1
a1581 1
				HTTPProcessData.Replace(_T("[Version]"), _T("<acronym title=\"") + ServerArray[i].sServerVersion + _T("\">") + ServerArray[i].sServerVersion.Left(SHORT_LENGTH) + _T("...") + _T("</acronym>"));
d2400 1
a2400 1
			dUser.sUserName = _SpecialChars(cur_client->GetUserName().Left(SHORT_LENGTH_MIN)) + _T("...");
d2500 1
a2500 1
			dUser.sUserName = _SpecialChars(cur_client->GetUserName().Left(SHORT_LENGTH_MIN)) + _T("...");
d2675 2
a2676 2
			if(FilesArray[i].sFileName.GetLength() > SHORT_LENGTH_MAX)
				HTTPProcessData.Replace(_T("[ShortFileName]"), FilesArray[i].sFileName.Left(SHORT_LENGTH_MAX) + _T("..."));
d3746 1
a3746 1
				HTTPProcessData.Replace(_T("[ShortFileName]"), _SpecialChars(SharedArray[i].sFileName.Left(SHORT_LENGTH)) + _T("..."));
@


1.300
log
@WebServer: added Total Files being downloaded to download footer
@
text
@d247 2
a248 2
	    m_nStartTempDisabledTime = 0;
	    m_bIsTempDisabled = false;
d3944 1
a3944 1
	Out.Replace(_T("[Port]"), _GetPlainResString(IDS_SV_PORT));
@


1.299
log
@More robust settings validation.
@
text
@d2793 3
@


1.298
log
@Improved string processing.
@
text
@d4151 1
a4151 1
			g_eMuleApp.m_pGlobPrefs->SetMaxGraphDownloadRate(10 * _tstoi(strTmp));
d4154 1
a4154 1
			g_eMuleApp.m_pGlobPrefs->SetMaxGraphUploadRate(10 * _tstoi(strTmp));
@


1.297
log
@Fixed reverse sorting in some windows
@
text
@d1094 2
d1097 1
d1123 1
a1123 1
		if(_ParseURL(Data.sURL, _T("sortreverse")).IsEmpty())
d1126 2
a1127 2
	if (!_ParseURL(Data.sURL, _T("sortreverse")).IsEmpty())
		pThis->m_Params.bServerSortReverse = (_ParseURL(Data.sURL, _T("sortreverse")) == "true");
d1135 1
a1135 2
	CString strTmp =
		(pThis->m_Params.bServerSortReverse) ? _T("&sortreverse=false") : _T("&sortreverse=true");
d1816 1
d1818 1
d1866 1
a1866 1
		if (sSort.Left(1) == "d" && _ParseURL(Data.sURL, _T("sortreverse")).IsEmpty())
d1868 1
a1868 1
		if (sSort.Left(1) == "u" && _ParseURL(Data.sURL, _T("sortreverse")).IsEmpty())
d1870 1
a1870 1
		if (sSort.Left(1) == "q" && _ParseURL(Data.sURL, _T("sortreverse")).IsEmpty())
a1871 1

d1874 1
a1874 1
	if (!_ParseURL(Data.sURL, _T("sortreverse")).IsEmpty())
d1876 6
a1881 6
		if (sSort.Left(1) == "d")
			pThis->m_Params.bDownloadSortReverse = (_ParseURL(Data.sURL, _T("sortreverse")) == "true");
		if (sSort.Left(1) == "u")
			pThis->m_Params.bUploadSortReverse = (_ParseURL(Data.sURL, _T("sortreverse")) == "true");
		if (sSort.Left(1) == "q")
			pThis->m_Params.bQueueSortReverse = (_ParseURL(Data.sURL, _T("sortreverse")) == "true");
d1918 1
a1918 2
	CString strTmp =
		(pThis->m_Params.bDownloadSortReverse) ? _T("&sortreverse=false") : _T("&sortreverse=true");
@


1.296
log
@WebServer: Fixed queue disabling in the Web Control Panel {muleteer};
WebServer: Fixed disabling of Servername column in Serverlist;
WebServer: Significantly increased performance and reduced CPU usage;
WebServer: Improved string to hash conversion.
@
text
@d50 1
a50 1
	m_Params.bDownloadSortReverse = false;
d52 1
a52 1
	m_Params.bUploadSortReverse = false;
d54 1
a54 1
	m_Params.bQueueSortReverse = false;
d56 1
a56 1
	m_Params.bServerSortReverse = false;
d58 1
a58 1
	m_Params.bSharedSortReverse = false;
d1119 3
d1123 2
a1124 5
	sSort.SetString(_ParseURL(Data.sURL, _T("sortreverse")));
	if (sSort.IsEmpty())
		pThis->m_Params.bServerSortReverse = false;
	else
		pThis->m_Params.bServerSortReverse = (sSort.CompareNoCase(_T("true")) == 0);
d1861 8
d1871 1
a1871 8
	CString sSortReverse(_ParseURL(Data.sURL, _T("sortreverse")));
	if (sSortReverse.IsEmpty())
	{
		pThis->m_Params.bDownloadSortReverse = false;
		pThis->m_Params.bUploadSortReverse = false;
		pThis->m_Params.bQueueSortReverse = false;
	}
	else
d1874 1
a1874 1
			pThis->m_Params.bDownloadSortReverse = (sSortReverse.CompareNoCase(_T("true")) == 0);
d1876 1
a1876 1
			pThis->m_Params.bUploadSortReverse = (sSortReverse.CompareNoCase(_T("true")) == 0);
d1878 1
a1878 1
			pThis->m_Params.bQueueSortReverse = (sSortReverse.CompareNoCase(_T("true")) == 0);
@


1.295
log
@WebServer: added double sorting arrows for the second level sorting;
Removed unused template "TMPL_TRANSFER_BAD_LINK";
Default template eMule.tmpl -> eMuleXP.tmpl;
Improved string processing; Template version 1006.
@
text
@a543 1

d763 1
a763 1
	CString sRefresh, strDummyNumber, strCat, admin;
a775 3
	if (bAdmin)
		admin = _T("admin");

d787 1
a787 1
	Out.Replace(_T("[admin]"), admin);
a1314 2
	CString OutE = pThis->m_Templates.sServerLine;

d1449 7
a1455 1
	CString sList;
d1458 1
a1458 9
		CString HTTPProcessData = OutE;	// Copy Entry Line to Temp

		CString admin;			//admin rights
		CString ed2k;			//ed2k
		CString session;		//session
		CString ip;				//ip
		CString port;			//port
		CString isstatic;		//serverstatic
		CString srvpriority;	//priority
d1460 1
a1460 2
		CString sServerPort;
		sServerPort.Format(_T("%d"), ServerArray[i].nServerPort);
d1464 1
a1464 1
			HTTPProcessData.Replace(_T("[LastChangedDataset]"), "checked");
d1466 2
a1467 8
			HTTPProcessData.Replace(_T("[LastChangedDataset]"), "checked_no");

		if (bAdmin)
			admin = _T("admin");

		session.Format(CString(sSession));
		ip.Format(CString(ServerArray[i].sServerIP));
		port = sServerPort;
d1471 2
a1472 2
			isstatic = _T("staticsrv");
			HTTPProcessData.Replace(_T("[ServerType]"), _T("static"));
d1475 8
a1482 1
			HTTPProcessData.Replace(_T("[ServerType]"), _T("none"));
d1487 1
a1487 1
				srvpriority = _T("Low");
d1490 1
a1490 1
				srvpriority = _T("Normal");
d1493 1
a1493 1
				srvpriority = _T("High");
a1496 1
		HTTPProcessData.Replace(_T("[admin]"), admin);
d1498 3
a1500 5
		HTTPProcessData.Replace(_T("[session]"), session);
		HTTPProcessData.Replace(_T("[ip]"), ip);
		HTTPProcessData.Replace(_T("[port]"), port);
		HTTPProcessData.Replace(_T("[isstatic]"), isstatic);
		HTTPProcessData.Replace(_T("[server-priority]"), srvpriority);
d1511 1
a1511 1
			HTTPProcessData.Replace(_T("[Name]"), _T(""));
d1635 7
a1641 2
			uchar* pFileHash = new uchar[16];
			if (_GetFileHash(sClear, pFileHash))
d1643 1
a1643 2
			else
				delete[] pFileHash;
d1725 68
a1792 27
		CString sFile(_ParseURL(Data.sURL, _T("file")));
		CString sUser(_ParseURL(Data.sURL, _T("userhash")));
		uchar FileHash[16], UserHash[16];

		if (!sOp.IsEmpty() && !sFile.IsEmpty() && /*failsafe*/ _GetFileHash(sFile, FileHash))
		{
			CPartFile* found_file = g_eMuleApp.m_pDownloadQueue->GetFileByID(FileHash);
			if(found_file)
			{	// SyruS all actions require a found file (removed double-check inside)
				if (sOp.CompareNoCase(_T("a4af")) == 0)
					found_file->DownloadAllA4AF();
				else if (sOp.CompareNoCase(_T("a4afsamecat")) == 0)
					found_file->DownloadAllA4AF(true);
				else if (sOp.CompareNoCase(_T("autoa4af")) == 0)
					g_eMuleApp.m_pDownloadQueue->SetA4AFAutoFile(found_file);
				else if (sOp.CompareNoCase(_T("noautoa4af")) == 0)
					g_eMuleApp.m_pDownloadQueue->SetA4AFAutoFile(NULL);
				else if (sOp.CompareNoCase(_T("stop")) == 0)
					found_file->StopFile();
				else if (sOp.CompareNoCase(_T("pause")) == 0)
					found_file->PauseFile();
				else if (sOp.CompareNoCase(_T("resume")) == 0)
					found_file->ResumeFile();
				else if (sOp.CompareNoCase(_T("cancel")) == 0)
				{
					found_file->DeleteFile();
					g_eMuleApp.m_pdlgEmule->m_wndTransfer.UpdateCatTabTitles();
d1794 6
a1799 8
				else if (sOp.CompareNoCase(_T("getflc")) == 0)
					found_file->GetFirstLastChunk4Preview();
				else if (sOp.CompareNoCase(_T("rename")) == 0)
				{
					CString sNewName(_ParseURL(Data.sURL, _T("name")));
					g_eMuleApp.m_pdlgEmule->SendMessage(WEB_FILE_RENAME, (WPARAM)found_file, (LPARAM)(LPCTSTR)sNewName);
				}
				else if (sOp.CompareNoCase(_T("priolow")) == 0)
d1801 2
a1802 22
					found_file->SetAutoPriority(false);
					found_file->SetPriority(PR_LOW);
				}
				else if (sOp.CompareNoCase(_T("prionormal")) == 0)
				{
					found_file->SetAutoPriority(false);
					found_file->SetPriority(PR_NORMAL);
				}
				else if (sOp.CompareNoCase(_T("priohigh")) == 0)
				{
					found_file->SetAutoPriority(false);
					found_file->SetPriority(PR_HIGH);
				}
				else if (sOp.CompareNoCase(_T("prioauto")) == 0)
				{
					found_file->SetAutoPriority(true);
					found_file->SetPriority(PR_HIGH);
				}
				else if (sOp.CompareNoCase(_T("setcat")) == 0)
				{
					int iMenu = atoi(_ParseURL(Data.sURL, _T("filecat")));
					if (iMenu != 0)
d1804 4
a1807 2
						byte iCatIndex = CCat::UserCatIndexToCatIndex(iMenu);
						found_file->SetCatID(CCat::GetCatIDByIndex(iCatIndex));
a1808 2
					else
						found_file->SetCatID(CAT_NONE);
a1811 11
		else if (!sOp.IsEmpty() && !sUser.IsEmpty() && /*failsafe*/ _GetFileHash(sUser, UserHash))
		{
			CUpDownClient* cur_client = g_eMuleApp.m_pClientList->FindClientByUserHash(UserHash);
			if(cur_client)
			{
				if (sOp.CompareNoCase(_T("addfriend")) == 0)
					g_eMuleApp.m_pFriendList->AddFriend(cur_client);
				else if (sOp.CompareNoCase(_T("removefriend")) == 0)
					g_eMuleApp.m_pFriendList->RemoveFriend(cur_client);
			}
		}
a2182 2
	CString OutE = pThis->m_Templates.sTransferDownLine;

d2578 1
d2599 1
a2599 2
		_GetFileHash(FilesArray[i].sFileHash, FileHashA4AF);
		CPartFile* found_file = g_eMuleApp.m_pDownloadQueue->GetFileByID(FileHashA4AF);
a2788 1
	OutE = pThis->m_Templates.sTransferUpLine;
d2798 5
a2804 1
		CString HTTPProcessData;
a2807 5
		bool bAdmin = IsSessionAdmin(Data,sSession);
		CString admin;
		if (bAdmin)
			admin = _T("admin");
		HTTPProcessData.Replace(_T("[admin]"), admin);
d2814 11
a2824 12
		if (!WSuploadColumnHidden[0])
			HTTPProcessData.Replace(_T("[1]"), UploadArray[i].sUserName);
		else
			HTTPProcessData.Replace(_T("[1]"), _T(""));
		if (!WSuploadColumnHidden[1])
			HTTPProcessData.Replace(_T("[ClientSoftV]"), UploadArray[i].sClientNameVersion);
		else
			HTTPProcessData.Replace(_T("[ClientSoftV]"), _T(""));
		if (!WSuploadColumnHidden[2])
			HTTPProcessData.Replace(_T("[2]"), UploadArray[i].sFileName);
		else
			HTTPProcessData.Replace(_T("[2]"), _T(""));
d2830 1
a2830 1
			HTTPProcessData.Replace(_T("[3]"), HTTPTemp);
d2832 3
a2834 2
		else
			HTTPProcessData.Replace(_T("[3]"), _T(""));
d2839 1
a2839 1
			HTTPProcessData.Replace(_T("[4]"), HTTPTemp);
d2841 1
a2841 2
		else
			HTTPProcessData.Replace(_T("[4]"), _T(""));
d2855 1
a2855 1
		CString OutE = pThis->m_Templates.sTransferUpQueueLine;
d2857 4
a2862 1
			CString HTTPProcessData;
d2865 1
d2867 24
a2890 16
			if (!WSqueueColumnHidden[0])
				HTTPProcessData.Replace(_T("[UserName]"), QueueArray[i].sUserName);
			else
				HTTPProcessData.Replace(_T("[UserName]"), _T(""));
			if (!WSqueueColumnHidden[1])
				HTTPProcessData.Replace(_T("[ClientSoftV]"), QueueArray[i].sClientNameVersion);
			else
				HTTPProcessData.Replace(_T("[ClientSoftV]"), _T(""));
			if (!WSqueueColumnHidden[2])
				HTTPProcessData.Replace(_T("[FileName]"), QueueArray[i].sFileName);
			else
				HTTPProcessData.Replace(_T("[FileName]"), _T(""));
			if (!WSqueueColumnHidden[3])
			{
				_stprintf(HTTPTempC, _T("%i") , QueueArray[i].nScore);
				HTTPProcessData.Replace(_T("[Score]"), HTTPTempC);
a2891 14
			else
				HTTPProcessData.Replace(_T("[Score]"), _T(""));
			HTTPProcessData.Replace(_T("[ClientState]"), QueueArray[i].sClientState);
			HTTPProcessData.Replace(_T("[ClientStateSpecial]"), QueueArray[i].sClientStateSpecial);
			HTTPProcessData.Replace(_T("[ClientSoft]"), QueueArray[i].sClientSoft);
			HTTPProcessData.Replace(_T("[ClientSoftSpecial]"), QueueArray[i].sClientSoftSpecial);
			HTTPProcessData.Replace(_T("[ClientExtra]"), QueueArray[i].sClientExtra);
			HTTPProcessData.Replace(_T("[UserHash]"), QueueArray[i].sUserHash);
			bool bAdmin = IsSessionAdmin(Data,sSession);
			CString admin;
			if (bAdmin)
				admin = _T("admin");
			HTTPProcessData.Replace(_T("[admin]"), admin);
			sQueue += HTTPProcessData;
d2902 1
a2902 1
		CString OutE2 = pThis->m_Templates.sTransferUpQueueBannedLine;
d2904 4
a2909 1
			CString HTTPProcessData;
a2911 14
				HTTPProcessData = OutE2;
			if (!WSqueueColumnHidden[0])
				HTTPProcessData.Replace(_T("[UserName]"), QueueArray[i].sUserName);
			else
				HTTPProcessData.Replace(_T("[UserName]"), _T(""));
			if (!WSqueueColumnHidden[1])
				HTTPProcessData.Replace(_T("[ClientSoftV]"), QueueArray[i].sClientNameVersion);
			else
				HTTPProcessData.Replace(_T("[ClientSoftV]"), _T(""));
			if (!WSqueueColumnHidden[2])
				HTTPProcessData.Replace(_T("[FileName]"), QueueArray[i].sFileName);
			else
				HTTPProcessData.Replace(_T("[FileName]"), _T(""));
			if (!WSqueueColumnHidden[3])
d2913 26
a2938 2
				_stprintf(HTTPTempC, _T("%i") , QueueArray[i].nScore);
				HTTPProcessData.Replace(_T("[Score]"), HTTPTempC);
a2939 14
			else
				HTTPProcessData.Replace(_T("[Score]"), _T(""));
			HTTPProcessData.Replace(_T("[ClientState]"), QueueArray[i].sClientState);
			HTTPProcessData.Replace(_T("[ClientStateSpecial]"), QueueArray[i].sClientStateSpecial);
			HTTPProcessData.Replace(_T("[ClientSoft]"), QueueArray[i].sClientSoft);
			HTTPProcessData.Replace(_T("[ClientSoftSpecial]"), QueueArray[i].sClientSoftSpecial);
			HTTPProcessData.Replace(_T("[ClientExtra]"), QueueArray[i].sClientExtra);
			HTTPProcessData.Replace(_T("[UserHash]"), QueueArray[i].sUserHash);
			bool bAdmin = IsSessionAdmin(Data,sSession);
			CString admin;
			if (bAdmin)
				admin = _T("admin");
			HTTPProcessData.Replace(_T("[admin]"), admin);
			sQueueBanned += HTTPProcessData;
d2950 1
a2950 1
		CString OutE3 = pThis->m_Templates.sTransferUpQueueFriendLine;
d2952 4
a2957 1
			CString HTTPProcessData;
a2959 14
				HTTPProcessData = OutE3;
			if (!WSqueueColumnHidden[0])
				HTTPProcessData.Replace(_T("[UserName]"), QueueArray[i].sUserName);
			else
				HTTPProcessData.Replace(_T("[UserName]"), _T(""));
			if (!WSqueueColumnHidden[1])
				HTTPProcessData.Replace(_T("[ClientSoftV]"), QueueArray[i].sClientNameVersion);
			else
				HTTPProcessData.Replace(_T("[ClientSoftV]"), _T(""));
			if (!WSqueueColumnHidden[2])
				HTTPProcessData.Replace(_T("[FileName]"), QueueArray[i].sFileName);
			else
				HTTPProcessData.Replace(_T("[FileName]"), _T(""));
			if (!WSqueueColumnHidden[3])
d2961 26
a2986 2
				_stprintf(HTTPTempC, _T("%i") , QueueArray[i].nScore);
				HTTPProcessData.Replace(_T("[Score]"), HTTPTempC);
a2987 14
			else
				HTTPProcessData.Replace(_T("[Score]"), _T(""));
			HTTPProcessData.Replace(_T("[ClientState]"), QueueArray[i].sClientState);
			HTTPProcessData.Replace(_T("[ClientStateSpecial]"), QueueArray[i].sClientStateSpecial);
			HTTPProcessData.Replace(_T("[ClientSoft]"), QueueArray[i].sClientSoft);
			HTTPProcessData.Replace(_T("[ClientSoftSpecial]"), QueueArray[i].sClientSoftSpecial);
			HTTPProcessData.Replace(_T("[ClientExtra]"), QueueArray[i].sClientExtra);
			HTTPProcessData.Replace(_T("[UserHash]"), QueueArray[i].sUserHash);
			bool bAdmin = IsSessionAdmin(Data,sSession);
			CString admin;
			if (bAdmin)
				admin = _T("admin");
			HTTPProcessData.Replace(_T("[admin]"), admin);
			sQueueFriend += HTTPProcessData;
d2998 1
a2998 1
		CString OutE4 = pThis->m_Templates.sTransferUpQueueCreditLine;
d3000 4
a3005 1
			CString HTTPProcessData;
a3007 14
				HTTPProcessData = OutE4;
			if (!WSqueueColumnHidden[0])
				HTTPProcessData.Replace(_T("[UserName]"), QueueArray[i].sUserName);
			else
				HTTPProcessData.Replace(_T("[UserName]"), _T(""));
			if (!WSqueueColumnHidden[1])
				HTTPProcessData.Replace(_T("[ClientSoftV]"), QueueArray[i].sClientNameVersion);
			else
				HTTPProcessData.Replace(_T("[ClientSoftV]"), _T(""));
			if (!WSqueueColumnHidden[2])
				HTTPProcessData.Replace(_T("[FileName]"), QueueArray[i].sFileName);
			else
				HTTPProcessData.Replace(_T("[FileName]"), _T(""));
			if (!WSqueueColumnHidden[3])
d3009 26
a3034 2
				_stprintf(HTTPTempC, _T("%i") , QueueArray[i].nScore);
				HTTPProcessData.Replace(_T("[Score]"), HTTPTempC);
a3035 14
			else
				HTTPProcessData.Replace(_T("[Score]"), _T(""));
			HTTPProcessData.Replace(_T("[ClientState]"), QueueArray[i].sClientState);
			HTTPProcessData.Replace(_T("[ClientStateSpecial]"), QueueArray[i].sClientStateSpecial);
			HTTPProcessData.Replace(_T("[ClientSoft]"), QueueArray[i].sClientSoft);
			HTTPProcessData.Replace(_T("[ClientSoftSpecial]"), QueueArray[i].sClientSoftSpecial);
			HTTPProcessData.Replace(_T("[ClientExtra]"), QueueArray[i].sClientExtra);
			HTTPProcessData.Replace(_T("[UserHash]"), QueueArray[i].sUserHash);
			bool bAdmin = IsSessionAdmin(Data,sSession);
			CString admin;
			if (bAdmin)
				admin = _T("admin");
			HTTPProcessData.Replace(_T("[admin]"), admin);
			sQueueCredit += HTTPProcessData;
d3266 7
a3272 5
	if (bAdmin && _ParseURL(Data.sURL, _T("jumpstart")) == "true")
		_SetSharedFileJumpstart(_ParseURL(Data.sURL, _T("hash")));
	else if (bAdmin &&  _ParseURL(Data.sURL, _T("jumpstart")) == "false")
		_SetSharedFileNoJumpstart(_ParseURL(Data.sURL, _T("hash")));

d3658 1
a3658 1
	CString sSharedList;
d3662 1
a3662 2
		CString HTTPProcessData;
        HTTPProcessData = OutE;
a3668 1
		CString admin;				//admin rights
a3696 3
		if (bAdmin)
			admin = _T("admin");

d3727 1
a3727 1
		HTTPProcessData.Replace(_T("[admin]"), admin);
d4124 1
a4124 1
		    g_eMuleApp.m_pGlobPrefs->SetWebUseGzip(true);
d4126 1
a4126 1
		    g_eMuleApp.m_pGlobPrefs->SetWebUseGzip(false);
d4128 3
a4130 1
		    pThis->m_Params.bShowUploadQueue = true;
d4132 3
a4134 1
		    pThis->m_Params.bShowUploadQueueBanned = true;
d4136 3
a4138 1
		    pThis->m_Params.bShowUploadQueueFriend = true;
d4140 3
a4142 1
		    pThis->m_Params.bShowUploadQueueCredit = true;
d4144 1
a4144 1
		    g_eMuleApp.m_pGlobPrefs->SetWebPageRefresh(_tstoi(_ParseURL(Data.sURL, _T("refresh"))));
d4450 1
a4450 1
bool CWebServer::IsSessionAdmin(ThreadData Data,CString SsessionID)
d4453 2
a4454 1
	long sessionID=_tstoi64(SsessionID);
a4472 32
bool CWebServer::_GetFileHash(CString sHash, uchar *FileHash)
{
	EMULE_TRY

	if (sHash.GetLength() != 32)
		return false;
	char hex_byte[3];
	int byte;
	hex_byte[2] = '\0';
	for (int i = 0; i < 16; i++)
	{
		hex_byte[0] = sHash.GetAt(i*2);
		hex_byte[1] = sHash.GetAt((i*2 + 1));
		if (!_istxdigit(hex_byte[0]) || !_istxdigit(hex_byte[1]))
		{
			md4clr(FileHash);
			return false;
		}
		else
		{
			sscanf(hex_byte, "%02x", &byte);
			FileHash[i] = (uchar)byte;
		}
	}
	return true;

	EMULE_CATCH

	md4clr(FileHash);
	return false;
}

a4944 1
		_GetFileHash(sFileHash, FileHash);
d4946 1
a4946 1
		CPartFile* found_file = g_eMuleApp.m_pDownloadQueue->GetFileByID(FileHash);
@


1.294
log
@WebServer: Fixed sorting directions for several columns;
WebServer: Fixed disabling of Files column in Serverlist;
WebServer: faster columns processing;
WebServer: "Completed" title is corrected to be the same as for the main interface {orokulus}.
@
text
@d21 1
a21 2
#define WEB_SERVER_TEMPLATES_VERSION	1005
#define ELEMENT_COUNT(X) (sizeof(X) / sizeof(X[0]))
d87 2
a88 2
	if (g_eMuleApp.m_pGlobPrefs->GetTemplate().IsEmpty() || g_eMuleApp.m_pGlobPrefs->GetTemplate().MakeLower()=="emule.tmpl")
		sFile= g_eMuleApp.m_pGlobPrefs->GetAppDir() + CString("eMule.tmpl");
a143 1
			m_Templates.sTransferBadLink = _LoadTemplate(sAll,_T("TMPL_TRANSFER_BAD_LINK"));
d163 2
d1185 1
a1185 1
	CString strSortIcon = (pThis->m_Params.bServerSortReverse) ? pThis->m_Templates.sUpArrow : pThis->m_Templates.sDownArrow;
d1190 1
a1190 1
		Out.Replace(_T("[ServernameI]"), CString((pThis->m_Params.ServerSort == SERVER_SORT_NAME)?strSortIcon:""));
d1203 1
a1203 1
		Out.Replace(_T("[AddressI]"), CString((pThis->m_Params.ServerSort == SERVER_SORT_IP)?strSortIcon:""));
d1216 1
a1216 1
		Out.Replace(_T("[DescriptionI]"), CString((pThis->m_Params.ServerSort == SERVER_SORT_DESCRIPTION)?strSortIcon:""));
d1229 1
a1229 1
		Out.Replace(_T("[PingI]"), CString((pThis->m_Params.ServerSort == SERVER_SORT_PING)?strSortIcon:""));
d1242 1
a1242 1
		Out.Replace(_T("[UsersI]"), CString((pThis->m_Params.ServerSort == SERVER_SORT_USERS)?strSortIcon:""));
d1255 1
a1255 1
		Out.Replace(_T("[FilesI]"), CString((pThis->m_Params.ServerSort == SERVER_SORT_FILES)?strSortIcon:""));
d1268 1
a1268 1
		Out.Replace(_T("[PriorityI]"), CString((pThis->m_Params.ServerSort == SERVER_SORT_PRIORITY)?strSortIcon:""));
d1281 1
a1281 1
		Out.Replace(_T("[FailedI]"), CString((pThis->m_Params.ServerSort == SERVER_SORT_FAILED)?strSortIcon:""));
d1294 1
a1294 1
		Out.Replace(_T("[LimitI]"), CString((pThis->m_Params.ServerSort == SERVER_SORT_LIMIT)?strSortIcon:""));
d1307 1
a1307 1
		Out.Replace(_T("[VersionI]"), CString((pThis->m_Params.ServerSort == SERVER_SORT_VERSION)?strSortIcon:""));
a1626 1
	CString admin;
a1628 3
	if (bAdmin)
		admin = _T("admin");

d1988 1
a1988 1
	CString strSortIcon = (pThis->m_Params.bDownloadSortReverse) ? pThis->m_Templates.sUpArrow : pThis->m_Templates.sDownArrow;
d1993 1
a1993 1
		Out.Replace(_T("[DFilenameI]"), CString((pThis->m_Params.DownloadSort == DOWN_SORT_NAME)?strSortIcon:""));
d2006 1
a2006 1
		Out.Replace(_T("[DSizeI]"), CString((pThis->m_Params.DownloadSort == DOWN_SORT_SIZE)?strSortIcon:""));
d2019 1
a2019 1
		Out.Replace(_T("[DTransferredI]"), CString((pThis->m_Params.DownloadSort == DOWN_SORT_TRANSFERRED)?strSortIcon:""));
d2032 1
a2032 1
		Out.Replace(_T("[DProgressI]"), CString((pThis->m_Params.DownloadSort == DOWN_SORT_PROGRESS)?strSortIcon:""));
d2045 1
a2045 1
		Out.Replace(_T("[DSpeedI]"), CString((pThis->m_Params.DownloadSort == DOWN_SORT_SPEED)?strSortIcon:""));
d2058 1
a2058 1
		Out.Replace(_T("[DSourcesI]"), CString((pThis->m_Params.DownloadSort == DOWN_SORT_SOURCES)?strSortIcon:""));
d2071 1
a2071 1
		Out.Replace(_T("[DPriorityI]"), CString((pThis->m_Params.DownloadSort == DOWN_SORT_PRIORITY)?strSortIcon:""));
d2084 1
a2084 1
		Out.Replace(_T("[DCategoryI]"), CString((pThis->m_Params.DownloadSort == DOWN_SORT_CATEGORY)?strSortIcon:""));
d2097 1
a2097 1
		Out.Replace(_T("[DFakeCheckI]"), CString((pThis->m_Params.DownloadSort == DOWN_SORT_FAKECHECK)?strSortIcon:""));
d2107 1
a2107 1
	strSortIcon = (pThis->m_Params.bUploadSortReverse) ? pThis->m_Templates.sUpArrow : pThis->m_Templates.sDownArrow;
d2112 1
a2112 1
		Out.Replace(_T("[UUserI]"), CString((pThis->m_Params.UploadSort == UP_SORT_USER)?strSortIcon:""));
d2125 1
a2125 1
		Out.Replace(_T("[UVersionI]"), CString((pThis->m_Params.UploadSort == UP_SORT_VERSION)?strSortIcon:""));
d2138 1
a2138 1
		Out.Replace(_T("[UFilenameI]"), CString((pThis->m_Params.UploadSort == UP_SORT_FILENAME)?strSortIcon:""));
d2151 1
a2151 1
		Out.Replace(_T("[UTransferredI]"), CString((pThis->m_Params.UploadSort == UP_SORT_TRANSFERRED)?strSortIcon:""));
d2164 1
a2164 1
		Out.Replace(_T("[USpeedI]"), CString((pThis->m_Params.UploadSort == UP_SORT_SPEED)?strSortIcon:""));
d2180 1
a2180 1
	Out.Replace(_T("[admin]"), admin);
d2578 2
a2579 1
	CString sDownList;
a2581 1
		CString HTTPProcessData;
a2588 1
		CString admin;			//admin rights
a2627 3
		if (bAdmin)
			admin = _T("admin");

d2646 1
a2646 1
		HTTPProcessData.Replace(_T("[admin]"), admin);
d3102 1
a3102 1
	strSortIcon = (pThis->m_Params.bQueueSortReverse) ? pThis->m_Templates.sUpArrow : pThis->m_Templates.sDownArrow;
d3107 1
a3107 1
		Out.Replace(_T("[UserNameTitleI]"), CString((pThis->m_Params.QueueSort == QU_SORT_USER)?strSortIcon:""));
d3120 1
a3120 1
		Out.Replace(_T("[VersionI]"), CString((pThis->m_Params.QueueSort == QU_SORT_VERSION)?strSortIcon:""));
d3133 1
a3133 1
		Out.Replace(_T("[FileNameTitleI]"), CString((pThis->m_Params.QueueSort == QU_SORT_FILENAME)?strSortIcon:""));
d3146 1
a3146 1
		Out.Replace(_T("[ScoreTitleI]"), CString((pThis->m_Params.QueueSort == QU_SORT_SCORE)?strSortIcon:""));
d3382 2
a3383 1
	CString strSortIcon = (pThis->m_Params.bSharedSortReverse) ? pThis->m_Templates.sUpArrow : pThis->m_Templates.sDownArrow;
d3388 1
a3388 1
		Out.Replace(_T("[FilenameI]"), CString((pThis->m_Params.SharedSort == SHARED_SORT_NAME)?strSortIcon:""));
d3401 4
a3404 1
		Out.Replace(_T("[FileTransferredI]"), CString((pThis->m_Params.SharedSort == SHARED_SORT_TRANSFERRED)?strSortIcon:""));
d3417 4
a3420 1
		Out.Replace(_T("[FileRequestsI]"), CString((pThis->m_Params.SharedSort == SHARED_SORT_REQUESTS)?strSortIcon:""));
d3433 4
a3436 1
		Out.Replace(_T("[FileAcceptsI]"), CString((pThis->m_Params.SharedSort == SHARED_SORT_ACCEPTS)?strSortIcon:""));
d3449 1
a3449 1
		Out.Replace(_T("[SizeI]"), CString((pThis->m_Params.SharedSort == SHARED_SORT_SIZE)?strSortIcon:""));
d3462 1
a3462 1
		Out.Replace(_T("[CompletesI]"), CString((pThis->m_Params.SharedSort == SHARED_SORT_COMPLETES)?strSortIcon:""));
d3475 1
a3475 1
		Out.Replace(_T("[PriorityI]"), CString((pThis->m_Params.SharedSort == SHARED_SORT_PRIORITY)?strSortIcon:""));
d4790 1
a4790 1
	CString strSortIcon = (pThis->m_bSearchAsc) ? pThis->m_Templates.sUpArrow : pThis->m_Templates.sDownArrow;
d4795 1
a4795 1
		Out.Replace(_T("[FilenameI]"), CString((pThis->m_iSearchSortby==0)?strSortIcon:""));
d4808 1
a4808 1
		Out.Replace(_T("[FilesizeI]"), CString((pThis->m_iSearchSortby==1)?strSortIcon:""));
d4821 1
a4821 1
		Out.Replace(_T("[FilehashI]"), CString((pThis->m_iSearchSortby==2)?strSortIcon:""));
d4834 1
a4834 1
		Out.Replace(_T("[SourcesI]"), CString((pThis->m_iSearchSortby==3)?strSortIcon:""));
d4847 1
a4847 1
		Out.Replace(_T("[FakeCheckI]"), CString((pThis->m_iSearchSortby==4)?strSortIcon:""));
@


1.293
log
@Fractional upload/download limits (min 1 KB/s, granularity 0.1 KB/s);
WebServer: faster processing of WebServer replies.
@
text
@d64 1
a64 1
	m_bSearchAsc=0;
d457 1
a457 1
	CString HTTPProcessData,HTTPTemp;
a1013 2
	CString HTTPTemp;

d1130 1
a1130 5
	CString sServerSortRev;
	if(pThis->m_Params.bServerSortReverse)
		sServerSortRev = "false";
	else
		sServerSortRev = "true";
d1132 1
a1132 2
	CString Out = pThis->m_Templates.sServerList;
    Out.Replace(_T("[AddServerBox]"), sAddServerBox);
d1135 4
d1140 1
a1140 1
		Out.Replace(_T("[SortState]"), _T("&sortreverse=") + sServerSortRev);
d1144 1
a1144 1
		Out.Replace(_T("[SortName]"), _T("&sortreverse=") + sServerSortRev);
d1148 1
a1148 1
		Out.Replace(_T("[SortIP]"), _T("&sortreverse=") + sServerSortRev);
d1152 1
a1152 1
		Out.Replace(_T("[SortDescription]"), _T("&sortreverse=") + sServerSortRev);
d1156 1
a1156 1
		Out.Replace(_T("[SortPing]"), _T("&sortreverse=") + sServerSortRev);
d1160 1
a1160 1
		Out.Replace(_T("[SortUsers]"), _T("&sortreverse=") + sServerSortRev);
d1164 1
a1164 1
		Out.Replace(_T("[SortFiles]"), _T("&sortreverse=") + sServerSortRev);
d1168 1
a1168 1
		Out.Replace(_T("[SortPriority]"), _T("&sortreverse=") + sServerSortRev);
d1172 1
a1172 1
		Out.Replace(_T("[SortFailed]"), _T("&sortreverse=") + sServerSortRev);
d1176 1
a1176 1
		Out.Replace(_T("[SortLimit]"), _T("&sortreverse=") + sServerSortRev);
d1180 1
a1180 1
		Out.Replace(_T("[SortVersion]"), _T("&sortreverse=") + sServerSortRev);
d1185 1
a1185 5
	CString strSortIcon;
	if (pThis->m_Params.bServerSortReverse)
		strSortIcon=pThis->m_Templates.sUpArrow;
	else
		 strSortIcon=pThis->m_Templates.sDownArrow;
d1187 1
d1191 1
a1191 2
		Out.Replace(_T("[ServernameH]"), _GetPlainResString(IDS_SL_SERVERNAME, true));
		Out.Replace(_T("[ServernameM]"), _GetPlainResString(IDS_SL_SERVERNAME, true));
a1196 1
		Out.Replace(_T("[ServernameM]"), _GetPlainResString(IDS_SL_SERVERNAME, true));
d1198 3
d1204 1
a1204 2
		Out.Replace(_T("[AddressH]"), _GetPlainResString(IDS_IP, true));
		Out.Replace(_T("[AddressM]"), _GetPlainResString(IDS_IP, true));
a1209 1
		Out.Replace(_T("[AddressM]"), _GetPlainResString(IDS_IP, true));
d1211 3
d1217 1
a1217 2
		Out.Replace(_T("[DescriptionH]"), _GetPlainResString(IDS_DESCRIPTION, true));
		Out.Replace(_T("[DescriptionM]"), _GetPlainResString(IDS_DESCRIPTION, true));
a1222 1
		Out.Replace(_T("[DescriptionM]"), _GetPlainResString(IDS_DESCRIPTION, true));
d1224 3
d1230 1
a1230 2
		Out.Replace(_T("[PingH]"), _GetPlainResString(IDS_PING, true));
		Out.Replace(_T("[PingM]"), _GetPlainResString(IDS_PING, true));
a1235 1
		Out.Replace(_T("[PingM]"), _GetPlainResString(IDS_PING, true));
d1237 3
d1243 1
a1243 2
		Out.Replace(_T("[UsersH]"), _GetPlainResString(IDS_UUSERS, true));
		Out.Replace(_T("[UsersM]"), _GetPlainResString(IDS_UUSERS, true));
a1248 1
		Out.Replace(_T("[UsersM]"), _GetPlainResString(IDS_UUSERS, true));
d1250 3
d1256 1
a1256 2
		Out.Replace(_T("[FilesH]"), _GetPlainResString(IDS_FILES, true));
		Out.Replace(_T("[FilesM]"), _GetPlainResString(IDS_FILES, true));
d1260 1
a1260 1
		Out.Replace(_T("[UsersI]"), _T(""));
a1261 1
		Out.Replace(_T("[FilesM]"), _GetPlainResString(IDS_FILES, true));
d1263 3
d1269 1
a1269 2
		Out.Replace(_T("[PriorityH]"), _GetPlainResString(IDS_PRIORITY, true));
		Out.Replace(_T("[PriorityM]"), _GetPlainResString(IDS_PRIORITY, true));
a1274 1
		Out.Replace(_T("[PriorityM]"), _GetPlainResString(IDS_PRIORITY, true));
d1276 3
d1282 1
a1282 2
		Out.Replace(_T("[FailedH]"), _GetPlainResString(IDS_UFAILED, true));
		Out.Replace(_T("[FailedM]"), _GetPlainResString(IDS_UFAILED, true));
a1287 1
		Out.Replace(_T("[FailedM]"), _GetPlainResString(IDS_UFAILED, true));
d1289 3
d1295 1
a1295 2
		Out.Replace(_T("[LimitH]"), _GetPlainResString(IDS_SERVER_SOFTHARDLIMIT, true));
		Out.Replace(_T("[LimitM]"), _GetPlainResString(IDS_SERVER_SOFTHARDLIMIT, true));
a1300 1
		Out.Replace(_T("[LimitM]"), _GetPlainResString(IDS_SERVER_SOFTHARDLIMIT, true));
d1302 3
d1308 1
a1308 2
		Out.Replace(_T("[VersionH]"), _GetPlainResString(IDS_SERVER_VERSION, true));
		Out.Replace(_T("[VersionM]"), _GetPlainResString(IDS_SERVER_VERSION, true));
a1313 1
		Out.Replace(_T("[VersionM]"), _GetPlainResString(IDS_SERVER_VERSION, true));
d1315 2
d1336 1
a1336 1
        Entry.nServerUsers = cur_file->GetNumUsers();
d1412 1
a1412 1
				bSwap = ServerArray[i].sServerName.CompareNoCase(ServerArray[i+1].sServerName) > 0;
a1906 18
	CString sDownloadSortRev;
	if(pThis->m_Params.bDownloadSortReverse)
		sDownloadSortRev = "false";
	else
		sDownloadSortRev = "true";

	CString sUploadSortRev;
	if(pThis->m_Params.bUploadSortReverse)
		sUploadSortRev = "false";
	else
		sUploadSortRev = "true";

	CString sQueueSortRev;
	if(pThis->m_Params.bQueueSortReverse)
		sQueueSortRev = "false";
	else
		sQueueSortRev = "true";

d1917 3
d1921 1
a1921 1
		Out.Replace(_T("[SortDState]"), _T("&sortreverse=") + sDownloadSortRev);
d1925 1
a1925 1
		Out.Replace(_T("[SortDType]"), _T("&sortreverse=") + sDownloadSortRev);
d1929 1
a1929 1
		Out.Replace(_T("[SortDName]"), _T("&sortreverse=") + sDownloadSortRev);
d1933 1
a1933 1
		Out.Replace(_T("[SortDSize]"), _T("&sortreverse=") + sDownloadSortRev);
d1937 1
a1937 1
		Out.Replace(_T("[SortDTransferred]"), _T("&sortreverse=") + sDownloadSortRev);
d1941 1
a1941 1
		Out.Replace(_T("[SortDSpeed]"), _T("&sortreverse=") + sDownloadSortRev);
d1945 1
a1945 1
		Out.Replace(_T("[SortDProgress]"), _T("&sortreverse=") + sDownloadSortRev);
d1949 1
a1949 1
		Out.Replace(_T("[SortDSources]"), _T("&sortreverse=") + sDownloadSortRev);
d1953 1
a1953 1
		Out.Replace(_T("[SortDPriority]"), _T("&sortreverse=") + sDownloadSortRev);
d1957 1
a1957 1
		Out.Replace(_T("[SortDCategory]"), _T("&sortreverse=") + sDownloadSortRev);
d1961 1
a1961 1
		Out.Replace(_T("[SortDFakeCheck]"), _T("&sortreverse=") + sDownloadSortRev);
d1964 3
d1968 1
a1968 1
		Out.Replace(_T("[SortUClient]"), _T("&sortreverse=") + sUploadSortRev);
d1972 1
a1972 1
		Out.Replace(_T("[SortUUser]"), _T("&sortreverse=") + sUploadSortRev);
d1976 1
a1976 1
		Out.Replace(_T("[SortUVersion]"), _T("&sortreverse=") + sUploadSortRev);
d1980 1
a1980 1
		Out.Replace(_T("[SortUFilename]"), _T("&sortreverse=") + sUploadSortRev);
d1984 1
a1984 1
		Out.Replace(_T("[SortUTransferred]"), _T("&sortreverse=") + sUploadSortRev);
d1988 1
a1988 1
		Out.Replace(_T("[SortUSpeed]"), _T("&sortreverse=") + sUploadSortRev);
d1992 1
a1992 5
	CString strSortIcon;

	if (pThis->m_Params.bDownloadSortReverse) strSortIcon=pThis->m_Templates.sUpArrow;
	else
		strSortIcon=pThis->m_Templates.sDownArrow;
d1994 1
d1998 1
a1998 2
		Out.Replace(_T("[DFilename]"), _GetPlainResString(IDS_DL_FILENAME, true));
		Out.Replace(_T("[DFilenameM]"), _GetPlainResString(IDS_DL_FILENAME, true));
a2003 1
		Out.Replace(_T("[DFilenameM]"), _GetPlainResString(IDS_DL_FILENAME, true));
d2005 1
d2007 1
d2011 1
a2011 2
		Out.Replace(_T("[DSize]"), _GetPlainResString(IDS_DL_SIZE, true));
		Out.Replace(_T("[DSizeM]"), _GetPlainResString(IDS_DL_SIZE, true));
a2016 1
		Out.Replace(_T("[DSizeM]"), _GetPlainResString(IDS_DL_SIZE, true));
d2018 1
d2020 1
d2024 1
a2024 2
		Out.Replace(_T("[DTransferred]"), _GetPlainResString(IDS_COMPLETE, true));
		Out.Replace(_T("[DTransferredM]"), _GetPlainResString(IDS_COMPLETE, true));
a2029 1
		Out.Replace(_T("[DTransferredM]"), _GetPlainResString(IDS_COMPLETE, true));
d2031 1
d2033 1
d2037 1
a2037 2
		Out.Replace(_T("[DProgress]"), _GetPlainResString(IDS_DL_PROGRESS, true));
		Out.Replace(_T("[DProgressM]"), _GetPlainResString(IDS_DL_PROGRESS, true));
a2042 1
		Out.Replace(_T("[DProgressM]"), _GetPlainResString(IDS_DL_PROGRESS, true));
d2044 1
d2046 1
d2050 1
a2050 2
		Out.Replace(_T("[DSpeed]"), _GetPlainResString(IDS_DL_SPEED, true));
		Out.Replace(_T("[DSpeedM]"), _GetPlainResString(IDS_DL_SPEED, true));
a2055 1
		Out.Replace(_T("[DSpeedM]"), _GetPlainResString(IDS_DL_SPEED, true));
d2057 1
d2059 1
d2063 1
a2063 2
		Out.Replace(_T("[DSources]"), _GetPlainResString(IDS_DL_SOURCES, true));
		Out.Replace(_T("[DSourcesM]"), _GetPlainResString(IDS_DL_SOURCES, true));
a2068 1
		Out.Replace(_T("[DSourcesM]"), _GetPlainResString(IDS_DL_SOURCES, true));
d2070 1
d2072 1
d2076 1
a2076 2
		Out.Replace(_T("[DPriority]"), _GetPlainResString(IDS_PRIORITY, true));
		Out.Replace(_T("[DPriorityM]"), _GetPlainResString(IDS_PRIORITY, true));
a2081 1
		Out.Replace(_T("[DPriorityM]"), _GetPlainResString(IDS_PRIORITY, true));
d2083 1
d2085 1
d2089 1
a2089 2
		Out.Replace(_T("[DCategory]"), _GetPlainResString(IDS_CAT, true));
		Out.Replace(_T("[DCategoryM]"), _GetPlainResString(IDS_CAT, true));
a2094 1
		Out.Replace(_T("[DCategoryM]"), _GetPlainResString(IDS_CAT, true));
d2096 1
d2098 1
d2102 1
a2102 2
		Out.Replace(_T("[DFakeCheck]"), _GetPlainResString(IDS_FAKE_CHECK_HEADER, true));
		Out.Replace(_T("[DFakeCheckM]"), _GetPlainResString(IDS_FAKE_CHECK_HEADER, true));
a2107 1
		Out.Replace(_T("[DFakeCheckM]"), _GetPlainResString(IDS_FAKE_CHECK_HEADER, true));
d2109 1
d2111 1
a2111 3
	if (pThis->m_Params.bUploadSortReverse) strSortIcon=pThis->m_Templates.sUpArrow;
	else
		strSortIcon=pThis->m_Templates.sDownArrow;
d2113 1
d2117 1
a2117 2
		Out.Replace(_T("[UUser]"), _GetPlainResString(IDS_QL_USERNAME, true));
		Out.Replace(_T("[UUserM]"), _GetPlainResString(IDS_QL_USERNAME, true));
a2122 1
		Out.Replace(_T("[UUserM]"), _GetPlainResString(IDS_QL_USERNAME, true));
d2124 1
d2126 1
d2130 1
a2130 2
		Out.Replace(_T("[UVersion]"), _GetPlainResString(IDS_INFLST_USER_CLIENTVERSION, true));
		Out.Replace(_T("[UVersionM]"), _GetPlainResString(IDS_INFLST_USER_CLIENTVERSION, true));
a2135 1
		Out.Replace(_T("[UVersionM]"), _GetPlainResString(IDS_INFLST_USER_CLIENTVERSION, true));
d2137 1
d2139 1
d2143 1
a2143 2
		Out.Replace(_T("[UFilename]"), _GetPlainResString(IDS_DL_FILENAME, true));
		Out.Replace(_T("[UFilenameM]"), _GetPlainResString(IDS_DL_FILENAME, true));
a2148 1
		Out.Replace(_T("[UFilenameM]"), _GetPlainResString(IDS_DL_FILENAME, true));
d2150 1
d2152 1
d2156 1
a2156 2
		Out.Replace(_T("[UTransferred]"), _GetPlainResString(IDS_DL_ULDL, true));
		Out.Replace(_T("[UTransferredM]"), _GetPlainResString(IDS_DL_ULDL, true));
a2161 1
		Out.Replace(_T("[UTransferredM]"), _GetPlainResString(IDS_DL_ULDL, true));
d2163 1
d2165 1
d2169 1
a2169 2
		Out.Replace(_T("[USpeed]"), _GetPlainResString(IDS_DL_SPEED, true));
		Out.Replace(_T("[USpeedM]"), _GetPlainResString(IDS_DL_SPEED, true));
a2174 1
		Out.Replace(_T("[USpeedM]"), _GetPlainResString(IDS_DL_SPEED, true));
d2176 1
d2315 1
a2315 1
				bSwap = FilesArray[i].sFileState.CompareNoCase(FilesArray[i+1].sFileState) > 0;
d2318 1
a2318 1
				bSwap = FilesArray[i].sFileType.CompareNoCase(FilesArray[i+1].sFileType) > 0;
d2321 1
a2321 1
				bSwap = FilesArray[i].sFileName.CompareNoCase(FilesArray[i+1].sFileName) > 0;
d2342 1
a2342 1
				bSwap = FilesArray[i].sCategory.CompareNoCase(FilesArray[i+1].sCategory) > 0;
d2345 1
a2345 1
				bSwap = FilesArray[i].sFakeCheck.CompareNoCase(FilesArray[i+1].sFakeCheck) > 0;
d2429 1
a2429 1
				bSwap = UploadArray[i].sClientSoftSpecial.CompareNoCase(UploadArray[i+1].sClientSoftSpecial) > 0;
d2432 1
a2432 1
				bSwap = UploadArray[i].sUserName.CompareNoCase(UploadArray[i+1].sUserName) > 0;
d2435 1
a2435 1
				bSwap = UploadArray[i].sClientNameVersion.CompareNoCase(UploadArray[i+1].sClientNameVersion) > 0;
d2438 1
a2438 1
				bSwap = UploadArray[i].sFileName.CompareNoCase(UploadArray[i+1].sFileName) > 0;
d2441 1
a2441 1
				bSwap = UploadArray[i].nTransferredUp < UploadArray[i+1].nTransferredUp ;
d2444 1
a2444 1
				bSwap = UploadArray[i].nDataRate < UploadArray[i+1].nDataRate ;
d2573 1
a2573 1
	QueueArray.QuickSort(!pThis->m_Params.bQueueSortReverse);
d3086 3
d3090 1
a3090 1
		Out.Replace(_T("[SortQClient]"), _T("&sortreverse=") + sQueueSortRev);
d3094 1
a3094 1
		Out.Replace(_T("[SortQUser]"), _T("&sortreverse=") + sQueueSortRev);
d3098 1
a3098 1
		Out.Replace(_T("[SortQVersion]"), _T("&sortreverse=") + sQueueSortRev);
d3102 1
a3102 1
		Out.Replace(_T("[SortQFilename]"), _T("&sortreverse=") + sQueueSortRev);
d3106 1
a3106 1
		Out.Replace(_T("[SortQScore]"), _T("&sortreverse=") + sQueueSortRev);
d3110 1
a3110 3
	if (pThis->m_Params.bQueueSortReverse) strSortIcon=pThis->m_Templates.sUpArrow;
	else
		strSortIcon=pThis->m_Templates.sDownArrow;
d3112 1
d3116 1
a3116 2
		Out.Replace(_T("[UserNameTitle]"), _GetPlainResString(IDS_QL_USERNAME, true));
		Out.Replace(_T("[UserNameTitleM]"), _GetPlainResString(IDS_QL_USERNAME, true));
a3121 1
		Out.Replace(_T("[UserNameTitleM]"), _GetPlainResString(IDS_QL_USERNAME, true));
d3123 3
d3129 1
a3129 2
		Out.Replace(_T("[Version]"), _GetPlainResString(IDS_INFLST_USER_CLIENTVERSION, true));
		Out.Replace(_T("[VersionM]"), _GetPlainResString(IDS_INFLST_USER_CLIENTVERSION, true));
a3134 1
		Out.Replace(_T("[VersionM]"), _GetPlainResString(IDS_INFLST_USER_CLIENTVERSION, true));
d3136 3
d3142 1
a3142 2
		Out.Replace(_T("[FileNameTitle]"), _GetPlainResString(IDS_DL_FILENAME, true));
		Out.Replace(_T("[FileNameTitleM]"), _GetPlainResString(IDS_DL_FILENAME, true));
a3147 1
		Out.Replace(_T("[FileNameTitleM]"), _GetPlainResString(IDS_DL_FILENAME, true));
d3149 3
d3155 1
a3155 2
		Out.Replace(_T("[ScoreTitle]"), _GetPlainResString(IDS_SCORE, true));
		Out.Replace(_T("[ScoreTitleM]"), _GetPlainResString(IDS_SCORE, true));
a3160 1
		Out.Replace(_T("[ScoreTitleM]"), _GetPlainResString(IDS_SCORE, true));
d3162 1
a3184 2
	CString HTTPTemp;

a3290 5
	CString sSharedSortRev;
	if(pThis->m_Params.bSharedSortReverse)
		sSharedSortRev = "false";
	else
		sSharedSortRev = "true";
d3292 3
a3294 1
    //State sorting link
d3296 1
a3296 1
		Out.Replace(_T("[SortState]"), _T("sort=state&sortreverse=") + sSharedSortRev);
d3301 1
a3301 1
		Out.Replace(_T("[SortType]"), _T("sort=type&sortreverse=") + sSharedSortRev);
d3306 1
a3306 1
		Out.Replace(_T("[SortName]"), _T("sort=name&sortreverse=") + sSharedSortRev);
d3311 1
a3311 1
		Out.Replace(_T("[SortSize]"), _T("sort=size&sortreverse=") + sSharedSortRev);
d3316 1
a3316 1
		Out.Replace(_T("[SortCompletes]"), _T("sort=completes&sortreverse=") + sSharedSortRev);
d3320 2
a3321 2
    if(pThis->m_Params.SharedSort == SHARED_SORT_PRIORITY)
		Out.Replace(_T("[SortPriority]"), _T("sort=priority&sortreverse=") + sSharedSortRev);
d3328 1
a3328 1
            Out.Replace(_T("[SortTransferred]"), _T("sort=alltimetransferred&sortreverse=") + sSharedSortRev);
d3330 1
a3330 1
			Out.Replace(_T("[SortTransferred]"), _T("sort=transferred&sortreverse=") + sSharedSortRev);
d3336 1
a3336 1
            Out.Replace(_T("[SortTransferred]"), _T("sort=transferred&sortreverse=") + sSharedSortRev);
d3338 1
a3338 1
			Out.Replace(_T("[SortTransferred]"), _T("sort=alltimetransferred&sortreverse=") + sSharedSortRev);
d3341 1
a3341 1
        Out.Replace(_T("[SortTransferred]"), _T("&sort=transferred&sortreverse=false"));
d3346 1
a3346 1
            Out.Replace(_T("[SortRequests]"), _T("sort=alltimerequests&sortreverse=") + sSharedSortRev);
d3348 1
a3348 1
			Out.Replace(_T("[SortRequests]"), _T("sort=requests&sortreverse=") + sSharedSortRev);
d3354 1
a3354 1
            Out.Replace(_T("[SortRequests]"), _T("sort=requests&sortreverse=") + sSharedSortRev);
d3356 1
a3356 1
			Out.Replace(_T("[SortRequests]"), _T("sort=alltimerequests&sortreverse=") + sSharedSortRev);
d3364 1
a3364 1
            Out.Replace(_T("[SortAccepts]"), _T("sort=alltimeaccepts&sortreverse=") + sSharedSortRev);
d3366 1
a3366 1
			Out.Replace(_T("[SortAccepts]"), _T("sort=accepts&sortreverse=") + sSharedSortRev);
d3371 1
a3371 1
            Out.Replace(_T("[SortAccepts]"), _T("sort=accepts&sortreverse=") + sSharedSortRev);
d3373 1
a3373 1
			Out.Replace(_T("[SortAccepts]"), _T("sort=alltimeaccepts&sortreverse=") + sSharedSortRev);
d3376 1
a3376 1
        Out.Replace(_T("[SortAccepts]"), _T("&sort=accepts&sortreverse=false"));
d3388 1
a3388 1
        Out.Replace(_T("[Message]"), _T(""));
d3390 1
a3390 3
	CString strSortIcon;
	if (pThis->m_Params.bSharedSortReverse) strSortIcon=pThis->m_Templates.sUpArrow;
		else strSortIcon=pThis->m_Templates.sDownArrow;
d3392 1
d3396 1
a3396 2
		Out.Replace(_T("[Filename]"), _GetPlainResString(IDS_DL_FILENAME, true));
		Out.Replace(_T("[FilenameM]"), _GetPlainResString(IDS_DL_FILENAME, true));
a3401 1
		Out.Replace(_T("[FilenameM]"), _GetPlainResString(IDS_DL_FILENAME, true));
d3403 3
d3409 1
a3409 2
		Out.Replace(_T("[FileTransferred]"),  _GetPlainResString(IDS_SF_TRANSFERRED, true));
		Out.Replace(_T("[FileTransferredM]"),  _GetPlainResString(IDS_SF_TRANSFERRED, true));
a3414 1
		Out.Replace(_T("[FileTransferredM]"),  _GetPlainResString(IDS_SF_TRANSFERRED, true));
d3416 3
d3422 1
a3422 2
		Out.Replace(_T("[FileRequests]"),  _GetPlainResString(IDS_SF_REQUESTS, true));
		Out.Replace(_T("[FileRequestsM]"),  _GetPlainResString(IDS_SF_REQUESTS, true));
a3427 1
		Out.Replace(_T("[FileRequestsM]"),  _GetPlainResString(IDS_SF_REQUESTS, true));
d3429 3
d3435 1
a3435 2
		Out.Replace(_T("[FileAccepts]"),  _GetPlainResString(IDS_SF_ACCEPTS, true));
		Out.Replace(_T("[FileAcceptsM]"),  _GetPlainResString(IDS_SF_ACCEPTS, true));
a3440 1
		Out.Replace(_T("[FileAcceptsM]"),  _GetPlainResString(IDS_SF_ACCEPTS, true));
d3442 3
d3448 1
a3448 2
		Out.Replace(_T("[Size]"), _GetPlainResString(IDS_DL_SIZE, true));
		Out.Replace(_T("[SizeM]"), _GetPlainResString(IDS_DL_SIZE, true));
a3453 1
		Out.Replace(_T("[SizeM]"), _GetPlainResString(IDS_DL_SIZE, true));
d3455 3
d3461 1
a3461 2
		Out.Replace(_T("[Completes]"),  _GetPlainResString(IDS_SF_COMPLETESRC, true));
		Out.Replace(_T("[CompletesM]"),  _GetPlainResString(IDS_SF_COMPLETESRC, true));
a3466 1
		Out.Replace(_T("[CompletesM]"),  _GetPlainResString(IDS_SF_COMPLETESRC, true));
d3468 3
d3474 1
a3474 2
		Out.Replace(_T("[Priority]"),  _GetPlainResString(IDS_PRIORITY, true));
		Out.Replace(_T("[PriorityM]"),  _GetPlainResString(IDS_PRIORITY, true));
a3479 1
		Out.Replace(_T("[PriorityM]"),  _GetPlainResString(IDS_PRIORITY, true));
d3481 2
d3521 1
a3521 1
            dFile.sED2kLink = cur_file->CreateED2kLink();
d3605 1
a3605 1
				bSwap = SharedArray[i].sFileName.CompareNoCase(SharedArray[i+1].sFileName) > 0;
d4506 1
a4506 1
CString	CWebServer::_GetPlainResString(UINT nID, bool noquote)
d4524 11
d4718 7
a4724 2
	CString sSort = _ParseURL(Data.sURL, "sort");	if (sSort.GetLength()>0) pThis->m_iSearchSortby=atoi(sSort);
	sSort = _ParseURL(Data.sURL, "sortAsc");		if (sSort.GetLength()>0) pThis->m_bSearchAsc=atoi(sSort);
d4788 1
a4788 5
	CString strSortIcon;
	if (pThis->m_bSearchAsc)
		strSortIcon=pThis->m_Templates.sUpArrow;
	else
		strSortIcon=pThis->m_Templates.sDownArrow;
d4790 1
d4794 1
a4794 2
		Out.Replace(_T("[FilenameH]"), _GetPlainResString(IDS_DL_FILENAME));
		Out.Replace(_T("[FilenameM]"), _GetPlainResString(IDS_DL_FILENAME));
a4799 1
		Out.Replace(_T("[FilenameM]"), _GetPlainResString(IDS_DL_FILENAME));
d4801 3
d4807 1
a4807 2
		Out.Replace(_T("[FilesizeH]"), _GetPlainResString(IDS_DL_SIZE));
		Out.Replace(_T("[FilesizeM]"), _GetPlainResString(IDS_DL_SIZE));
a4812 1
		Out.Replace(_T("[FilesizeM]"), _GetPlainResString(IDS_DL_SIZE));
d4814 3
d4820 1
a4820 2
		Out.Replace(_T("[FilehashH]"), _GetPlainResString(IDS_FILEHASH));
		Out.Replace(_T("[FilehashM]"), _GetPlainResString(IDS_FILEHASH));
a4825 1
		Out.Replace(_T("[FilehashM]"), _GetPlainResString(IDS_FILEHASH));
d4827 3
d4833 1
a4833 2
		Out.Replace(_T("[SourcesH]"), _GetPlainResString(IDS_DL_SOURCES));
		Out.Replace(_T("[SourcesM]"), _GetPlainResString(IDS_DL_SOURCES));
a4838 1
		Out.Replace(_T("[SourcesM]"), _GetPlainResString(IDS_DL_SOURCES));
d4840 3
d4846 1
a4846 2
		Out.Replace(_T("[FakeCheckH]"), _GetPlainResString(IDS_FAKE_CHECK_HEADER));
		Out.Replace(_T("[FakeCheckM]"), _GetPlainResString(IDS_FAKE_CHECK_HEADER));
a4851 1
		Out.Replace(_T("[FakeCheckM]"), _GetPlainResString(IDS_FAKE_CHECK_HEADER));
d4853 2
d4857 12
a4868 13
	CString val;
	val.Format("%i",(pThis->m_iSearchSortby!=0 || (pThis->m_iSearchSortby==0 && pThis->m_bSearchAsc==0 ))?1:0 );
	Out.Replace("[SORTASCVALUE0]", val);
	val.Format("%i",(pThis->m_iSearchSortby!=1 || (pThis->m_iSearchSortby==1 && pThis->m_bSearchAsc==0 ))?1:0 );
	Out.Replace("[SORTASCVALUE1]", val);
	val.Format("%i",(pThis->m_iSearchSortby!=2 || (pThis->m_iSearchSortby==2 && pThis->m_bSearchAsc==0 ))?1:0 );
	Out.Replace("[SORTASCVALUE2]", val);
	val.Format("%i",(pThis->m_iSearchSortby!=3 || (pThis->m_iSearchSortby==3 && pThis->m_bSearchAsc==0 ))?1:0 );
	Out.Replace("[SORTASCVALUE3]", val);
	val.Format("%i",(pThis->m_iSearchSortby!=4 || (pThis->m_iSearchSortby==4 && pThis->m_bSearchAsc==0 ))?1:0 );
	Out.Replace("[SORTASCVALUE4]", val);
	val.Format("%i",(pThis->m_iSearchSortby!=5 || (pThis->m_iSearchSortby==5 && pThis->m_bSearchAsc==0 ))?1:0 );
	Out.Replace("[SORTASCVALUE5]", val);
@


1.292
log
@removed leftover filesettings in ws/preferences
@
text
@d1 1
a1 1
#include "StdAfx.h"
d675 1
a675 1
		if (pos>-1)
d693 1
a693 1
CString CWebServer::_ParseURL(CString URL, CString fieldname)
d697 2
a698 6
	CString value,Parameter;
	TCHAR fromReplace[4] = _T("");	// decode URL
	TCHAR toReplace[2] = _T("");	// decode URL
	int i = 0;
	int findPos = -1;
	int findLength = 0;
d700 1
a700 1
	if (URL.Find(_T('?')) > -1)
d702 2
a703 1
		Parameter = URL.Mid(URL.Find(_T('?')) + 1, URL.GetLength() - URL.Find(_T('?')) - 1);
d705 4
a708 2
		// search the fieldname beginning / middle and strip the rest...
		if (Parameter.Find(fieldname + _T('=')) == 0)
d711 1
a711 1
			findLength = fieldname.GetLength() + 1;
d713 1
a713 1
		if (Parameter.Find(_T('&') + fieldname + _T('=')) > -1)
d715 2
a716 2
			findPos = Parameter.Find(_T('&') + fieldname + _T('='));
			findLength = fieldname.GetLength() + 2;
d718 1
a718 1
		if (findPos > -1)
d720 3
d724 2
a725 2
			if (Parameter.Find(_T('&')) > -1)
				Parameter = Parameter.Mid(0, Parameter.Find(_T('&')));
d731 1
a731 1
			for (i = 0 ; i <= 255 ; i++)
d733 2
a734 3
				_stprintf(fromReplace, _T("%%%02x"), i);
				toReplace[0] = (char)i;
				toReplace[1] = NULL;
d736 1
a736 1
				_stprintf(fromReplace, _T("%%%02X"), i);
d922 1
a922 1
		_stprintf(HTTPHeader, "%.1f", (static_cast<double>(g_eMuleApp.m_pUploadQueue->GetDataRate())/1024.0)/(g_eMuleApp.m_pGlobPrefs->GetMaxGraphUploadRate())*100.0);
d924 1
a924 1
		_stprintf(HTTPHeader, "%.1f", (static_cast<double>(g_eMuleApp.m_pUploadQueue->GetDataRate())/1024.0)/(g_eMuleApp.m_pGlobPrefs->GetMaxUpload())*100.0);
d928 1
a928 1
		_stprintf(HTTPHeader, "%.1f", (static_cast<double>(g_eMuleApp.m_pDownloadQueue->GetDataRate())/1024.0)/(g_eMuleApp.m_pGlobPrefs->GetMaxGraphDownloadRate())*100.0);
d930 1
a930 1
		_stprintf(HTTPHeader, "%.1f", (static_cast<double>(g_eMuleApp.m_pDownloadQueue->GetDataRate())/1024.0)/(g_eMuleApp.m_pGlobPrefs->GetMaxDownload())*100.0);
d949 1
a949 1
		HTTPHelp.Format(_T("%u"), dwMax);
d956 1
a956 1
		HTTPHelp.Format(_T("%u"), dwMax);
d3880 1
a3880 1
	s1.Format(_T("%d"), g_eMuleApp.m_pGlobPrefs->GetMaxGraphDownloadRate());
d3882 1
a3882 1
	s1.Format(_T("%d"), g_eMuleApp.m_pGlobPrefs->GetMaxGraphUploadRate());
d4132 1
a4132 1
	CString sCat;
d4158 12
a4169 1
		if(!_ParseURL(Data.sURL, _T("maxdown")).IsEmpty())
d4171 2
a4172 1
			if(_tstoi(_ParseURL(Data.sURL, _T("maxdown")))>0)
d4174 1
a4174 1
				g_eMuleApp.m_pGlobPrefs->SetMaxDownload(_tstoi(_ParseURL(Data.sURL, _T("maxdown"))));
d4180 2
a4181 1
		if(!_ParseURL(Data.sURL, _T("maxup")).IsEmpty())
d4183 4
a4186 9
		    if(_tstoi(_ParseURL(Data.sURL, _T("maxup")))>0)
			    g_eMuleApp.m_pGlobPrefs->SetMaxUpload(_tstoi(_ParseURL(Data.sURL, _T("maxup"))));
//		    else
//			    g_eMuleApp.m_pGlobPrefs->SetMaxUpload(UNLIMITED);
	    }
		if(!_ParseURL(Data.sURL, _T("maxcapdown")).IsEmpty())
		    g_eMuleApp.m_pGlobPrefs->SetMaxGraphDownloadRate(_tstoi(_ParseURL(Data.sURL, _T("maxcapdown"))));
		if(!_ParseURL(Data.sURL, _T("maxcapup")).IsEmpty())
		    g_eMuleApp.m_pGlobPrefs->SetMaxGraphUploadRate(_tstoi(_ParseURL(Data.sURL, _T("maxcapup"))));
d4269 1
a4269 1
	sT.Format(_T("%u"), (dwNum == UNLIMITED) ? 0 : dwNum);
d4272 1
a4272 1
	sT.Format(_T("%u"), (dwNum == UNLIMITED) ? 0 : dwNum);
d4274 1
a4274 1
	sT.Format(_T("%d"), g_eMuleApp.m_pGlobPrefs->GetMaxGraphDownloadRate());
d4276 1
a4276 1
	sT.Format(_T("%d"), g_eMuleApp.m_pGlobPrefs->GetMaxGraphUploadRate());
@


1.291
log
@Use defines instead of numbers.
@
text
@a4222 1
	Out.Replace(_T("[FileSettings]"), CString(_GetPlainResString(IDS_WEB_FILESETTINGS)+_T(":")));
@


1.290
log
@Own client type for eMule Plus clients; Simplified way to select client pictures.
@
text
@d945 1
a945 1
	if (dwMax == 65535)
d952 1
a952 1
	if (dwMax == 65535)
d4158 1
a4158 1
	    {
d4168 1
a4168 1
	    {
d4192 1
a4192 1
    if(pThis->m_Params.bShowUploadQueue)
d4196 1
a4196 1
    if(pThis->m_Params.bShowUploadQueueBanned)
d4200 1
a4200 1
    if(pThis->m_Params.bShowUploadQueueFriend)
d4204 1
a4204 1
    if(pThis->m_Params.bShowUploadQueueCredit)
d4258 4
a4261 4
	CString sT;
	int n = (int)g_eMuleApp.m_pGlobPrefs->GetMaxDownload();
	if(n < 0 || n == 65535) n = 0;
	sT.Format(_T("%d"), n);
d4263 2
a4264 3
	n = (int)g_eMuleApp.m_pGlobPrefs->GetMaxUpload();
	if(n < 0 || n == 65535) n = 0;
	sT.Format(_T("%d"), n);
@


1.289
log
@Faster processing of ini-file settings and preferences values; MD5 optimization.
@
text
@d2374 2
d2397 8
a2404 3
		sTemp.Format(_T("%u"), cur_client->GetClientSoft());
		if ((cur_client->m_pCredits->GetCurrentIdentState(cur_client->GetIP()) != IS_IDENTIFIED) && (cur_client->GetClientSoft() == 0))
			sTemp = "x";
d2528 8
a2535 3
		sTemp.Format(_T("%u"), cur_client->GetClientSoft());
		if ((cur_client->m_pCredits->GetCurrentIdentState(cur_client->GetIP()) != IS_IDENTIFIED) && (cur_client->GetClientSoft() == 0))
			sTemp = "x";
@


1.288
log
@Fixed double percentage sign in WebServer messagebox File Details;
Improved string processing.
@
text
@d78 3
a80 1
	CString sPrevLocale(setlocale(LC_TIME, NULL));
d84 1
a84 1
	m_Params.sETag = MD5Sum(m_Params.sLastModified).GetHash();
d196 8
a203 6
	ini.GetArray(WSdownloadColumnHidden, ELEMENT_COUNT(WSdownloadColumnHidden), _T("downloadColumnHidden"), _T("WebServer"));
	ini.GetArray(WSuploadColumnHidden, ELEMENT_COUNT(WSuploadColumnHidden), _T("uploadColumnHidden"), _T("WebServer"));
	ini.GetArray(WSqueueColumnHidden, ELEMENT_COUNT(WSqueueColumnHidden), _T("queueColumnHidden"), _T("WebServer"));
	ini.GetArray(WSsearchColumnHidden, ELEMENT_COUNT(WSsearchColumnHidden), _T("searchColumnHidden"), _T("WebServer"));
	ini.GetArray(WSsharedColumnHidden, ELEMENT_COUNT(WSsharedColumnHidden), _T("sharedColumnHidden"), _T("WebServer"));
	ini.GetArray(WSserverColumnHidden, ELEMENT_COUNT(WSserverColumnHidden), _T("serverColumnHidden"), _T("WebServer"));
d468 2
a469 2
        pThis->m_bIsTempDisabled = false;
        pThis->m_nStartTempDisabledTime = 0;
d473 1
a473 2
	if ((_ParseURL(Data.sURL, _T("w")) == "password")
	&& (!pThis->GetIsTempDisabled()))
d475 2
a476 2
		CString test=MD5Sum(_ParseURL(Data.sURL, _T("p"))).GetHash();
		CString t_ulCurIP;
d479 1
a479 1
		if(MD5Sum(_ParseURL(Data.sURL, _T("p"))).GetHash() == g_eMuleApp.m_pGlobPrefs->GetWSPass())
d489 2
a490 1
		else if(g_eMuleApp.m_pGlobPrefs->GetWSIsLowUserEnabled() && !g_eMuleApp.m_pGlobPrefs->GetWSLowPass().IsEmpty() && MD5Sum(_ParseURL(Data.sURL, _T("p"))).GetHash() == g_eMuleApp.m_pGlobPrefs->GetWSLowPass())
d501 1
a501 1
			{
d1093 4
a1096 2
		CIni ini( fullpath );
		ini.SetArray(WSserverColumnHidden, ELEMENT_COUNT(WSserverColumnHidden), _T("serverColumnHidden"), _T("WebServer"));
d1674 4
a1677 2
		CIni ini( fullpath );
		ini.SetArray(WSdownloadColumnHidden, ELEMENT_COUNT(WSdownloadColumnHidden), _T("downloadColumnHidden"), _T("WebServer"));
d1687 4
a1690 2
		CIni ini( fullpath );
		ini.SetArray(WSuploadColumnHidden, ELEMENT_COUNT(WSuploadColumnHidden), _T("uploadColumnHidden"), _T("WebServer"));
d1700 4
a1703 2
		CIni ini( fullpath );
		ini.SetArray(WSqueueColumnHidden, ELEMENT_COUNT(WSqueueColumnHidden), _T("queueColumnHidden"), _T("WebServer"));
d3277 4
a3280 2
		CIni ini( fullpath );
		ini.SetArray(WSsharedColumnHidden, ELEMENT_COUNT(WSsharedColumnHidden), _T("sharedColumnHidden"), _T("WebServer"));
d4710 4
a4713 2
		CIni ini( fullpath );
		ini.SetArray(WSsearchColumnHidden, ELEMENT_COUNT(WSsearchColumnHidden), _T("searchColumnHidden"), _T("WebServer"));
@


1.287
log
@Fixed GUI update after file deletion from Web Server and MobileMule {reported by Fuxie - DK};
Faster processing of file operations.
@
text
@a2583 1
		CString finfo;			//fileinfo
d2597 5
a2601 5
		CString JSfileinfo=FilesArray[i].sFileInfo;
		JSfileinfo.Replace(_T("\\"),_T("\\\\"));
		JSfileinfo.Replace(_T("\n"),_T("\\n"));
		JSfileinfo.Replace(_T("%"),_T("%%"));
		JSfileinfo.Replace(_T("'"),_T("&#8217;"));
a2605 1
		finfo = JSfileinfo;
d2645 1
a2645 1
		HTTPProcessData.Replace(_T("[finfo]"), finfo);
@


1.286
log
@Removed some specific client icons (as they were incorrect).
@
text
@d773 1
a773 1
		admin.Format(_T("admin"));
d814 2
a815 1
	if (CCat::GetNumCats()>1) InsertCatBox(Out,0,pThis->m_Templates.sCatArrow,false,false,sSession,"");
d1717 1
a1717 6
	CString sOp(_ParseURL(Data.sURL, _T("op")));
	CString sFile(_ParseURL(Data.sURL, _T("file")));
	CString sUser(_ParseURL(Data.sURL, _T("userhash")));
	uchar FileHash[16];
	uchar UserHash[16];
	if (!sOp.IsEmpty() && !sFile.IsEmpty() && /*failsafe*/ _GetFileHash(sFile, FileHash))
d1719 57
a1775 50
		CPartFile* found_file = g_eMuleApp.m_pDownloadQueue->GetFileByID(FileHash);
		if(found_file)
		{	// SyruS all actions require a found file (removed double-check inside)
			if(bAdmin && sOp.CompareNoCase(_T("a4af")) == 0)
				found_file->DownloadAllA4AF();
			else if(bAdmin && sOp.CompareNoCase(_T("a4afsamecat")) == 0)
				found_file->DownloadAllA4AF(true);
			else if(bAdmin && sOp.CompareNoCase(_T("autoa4af")) == 0)
				g_eMuleApp.m_pDownloadQueue->SetA4AFAutoFile(found_file);
			else if(bAdmin && sOp.CompareNoCase(_T("noautoa4af")) == 0)
				g_eMuleApp.m_pDownloadQueue->SetA4AFAutoFile(NULL);
			else if(bAdmin && sOp.CompareNoCase(_T("stop")) == 0)
				found_file->StopFile();
			else if(bAdmin && sOp.CompareNoCase(_T("pause")) == 0)
				found_file->PauseFile();
			else if(bAdmin && sOp.CompareNoCase(_T("resume")) == 0)
				found_file->ResumeFile();
			else if(bAdmin && sOp.CompareNoCase(_T("cancel")) == 0)
				found_file->DeleteFile();
			else if(bAdmin && sOp.CompareNoCase(_T("getflc")) == 0)
				found_file->GetFirstLastChunk4Preview();
			else if(bAdmin && sOp.CompareNoCase(_T("rename")) == 0)
			{
				CString sNewName(_ParseURL(Data.sURL, _T("name")));
				g_eMuleApp.m_pdlgEmule->SendMessage(WEB_FILE_RENAME, (WPARAM)found_file, (LPARAM)(LPCTSTR)sNewName);
			}
			else if(bAdmin && sOp.CompareNoCase(_T("priolow")) == 0)
			{
				found_file->SetAutoPriority(false);
				found_file->SetPriority(PR_LOW);
			}
			else if(bAdmin && sOp.CompareNoCase(_T("prionormal")) == 0)
			{
				found_file->SetAutoPriority(false);
				found_file->SetPriority(PR_NORMAL);
			}
			else if(bAdmin && sOp.CompareNoCase(_T("priohigh")) == 0)
			{
				found_file->SetAutoPriority(false);
				found_file->SetPriority(PR_HIGH);
			}
			else if(bAdmin && sOp.CompareNoCase(_T("prioauto")) == 0)
			{
				found_file->SetAutoPriority(true);
				found_file->SetPriority(PR_HIGH);
			}
			else if(bAdmin && sOp.CompareNoCase(_T("setcat")) == 0)
			{
				int iMenu = atoi(_ParseURL(Data.sURL, _T("filecat")));
				if (iMenu != 0)
d1777 8
a1784 2
					byte iCatIndex = CCat::UserCatIndexToCatIndex(iMenu);
					found_file->SetCatID(CCat::GetCatIDByIndex(iCatIndex));
a1785 2
				else
					found_file->SetCatID(CAT_NONE);
d1788 1
a1788 5
	}
	else if (!sOp.IsEmpty() && !sUser.IsEmpty() && /*failsafe*/ _GetFileHash(sUser, UserHash))
	{
		CUpDownClient* cur_client = g_eMuleApp.m_pClientList->FindClientByUserHash(UserHash);
		if(cur_client)
d1790 8
a1797 4
			if(bAdmin && sOp.CompareNoCase(_T("addfriend")) == 0)
				g_eMuleApp.m_pFriendList->AddFriend(cur_client);
			else if(bAdmin && sOp.CompareNoCase(_T("removefriend")) == 0)
				g_eMuleApp.m_pFriendList->RemoveFriend(cur_client);
@


1.285
log
@fixed fix ;) now all signed (or: how does an uint32 become -1)
@
text
@a2379 4
		if (cur_client->GetMuleVersion() > 56 && cur_client->GetMuleVersion() < 66)
			sTemp = "h";
		if (cur_client->GetPlusVersion())
			sTemp = "p";
a2380 2
		if (cur_client->GetMuleVersion() > 56 && cur_client->GetMuleVersion() < 66) dUser.sClientSoftSpecial = _T("h");
		if (cur_client->GetPlusVersion()) dUser.sClientSoftSpecial = _T("p");
a2505 4
		if (cur_client->GetMuleVersion() > 56 && cur_client->GetMuleVersion() < 66)
			sTemp = "h";
		if (cur_client->GetPlusVersion())
			sTemp = "p";
@


1.284
log
@Minor correction for an old WebServer bug
@
text
@d2406 1
a2406 1
		uint32 iDataRate = cur_client->GetDataRate();
@


1.283
log
@rollback of old waiting queue
@
text
@d2406 2
a2407 1
		dUser.nDataRate = cur_client->GetDataRate();
@


1.282
log
@SSWQ
@
text
@d2462 1
a2462 3
	ClientList::iterator clientIt;

	for (clientIt = g_eMuleApp.m_pUploadQueue->m_waitingList.begin(); clientIt != g_eMuleApp.m_pUploadQueue->m_waitingList.end(); clientIt++)
d2464 1
a2464 1
		CUpDownClient* cur_client = *clientIt;
d2506 1
a2506 1
		dUser.nScore = cur_client->GetWaitingScore();
d2551 1
a2551 2
	//if (g_eMuleApp.m_pUploadQueue->waitinglist.GetHeadPosition() != 0)
	if (!g_eMuleApp.m_pUploadQueue->m_waitingList.empty())
@


1.281
log
@Preparations for new client version report code.
@
text
@d2214 1
a2214 1
			if(pPartFile->IsAutoPrioritized())
d2462 3
a2464 1
	for (POSITION pos = g_eMuleApp.m_pUploadQueue->waitinglist.GetHeadPosition(); pos != NULL;)
d2466 1
a2466 1
		CUpDownClient* cur_client = g_eMuleApp.m_pUploadQueue->waitinglist.GetNext(pos);
d2508 1
a2508 1
		dUser.nScore = cur_client->GetScore(false);
d2553 2
a2554 1
	if (g_eMuleApp.m_pUploadQueue->waitinglist.GetHeadPosition() != 0)
d3230 2
a3231 2
					cur_file->SetAutoPriority(false);
					cur_file->SetPriority(PR_VERYLOW);
d3235 2
a3236 2
					cur_file->SetAutoPriority(false);
					cur_file->SetPriority(PR_LOW);
d3240 2
a3241 2
					cur_file->SetAutoPriority(false);
					cur_file->SetPriority(PR_NORMAL);
d3245 2
a3246 2
					cur_file->SetAutoPriority(false);
					cur_file->SetPriority(PR_HIGH);
d3250 2
a3251 2
					cur_file->SetAutoPriority(false);
					cur_file->SetPriority(PR_RELEASE);
d3255 1
a3255 1
					cur_file->SetAutoPriority(true);
d3543 1
a3543 1
		if (cur_file->IsAutoPrioritized())
d3545 1
a3545 1
			if (cur_file->GetPriority() == PR_LOW)
d3547 1
a3547 1
			else if (cur_file->GetPriority() == PR_NORMAL)
d3549 1
a3549 1
			else if (cur_file->GetPriority() == PR_HIGH)
d3551 1
a3551 1
			else if (cur_file->GetPriority() == PR_RELEASE)
d3557 1
a3557 1
			if (cur_file->GetPriority() == PR_VERYLOW)
d3559 1
a3559 1
			else if (cur_file->GetPriority() == PR_LOW)
d3561 1
a3561 1
			else if (cur_file->GetPriority() == PR_NORMAL)
d3563 1
a3563 1
			else if (cur_file->GetPriority() == PR_HIGH)
d3565 1
a3565 1
			else if (cur_file->GetPriority() == PR_RELEASE)
d3573 2
a3574 2
		dFile.nFilePriority = cur_file->GetPriority();
		dFile.bFileAutoPriority = cur_file->IsAutoPrioritized();
d3721 1
a3721 1
			else if (cur_file->GetPriority() == PR_RELEASE)
@


1.280
log
@IDS_MAIN_BTN_CANCEL, IDS_MAIN_BTN_CONNECT, IDS_EM_TRANS, IDS_EM_SEARCH,
IDS_EM_FILES, IDS_EM_MESSAGES and IDS_EM_STATISTIC don't contain '&' any more.
@
text
@d2407 1
a2407 1
		dUser.sClientNameVersion = GetClientNameAndVersionString(cur_client);
d2498 1
a2498 1
		dUser.sClientNameVersion = GetClientNameAndVersionString(cur_client);
@


1.279
log
@Updated WebTemplates version and added A4AF SameCat to web menu
@
text
@d830 1
a830 1
	Out.Replace(_T("[Cancel]"), _GetPlainResString(IDS_MAIN_BTN_CANCEL, true));
@


1.278
log
@IDS_EM_PREFS doesn't contain '&' any more;
Improved string processing; formatting.
@
text
@d21 1
a21 1
#define WEB_SERVER_TEMPLATES_VERSION	1004
d824 2
a825 1
	Out.Replace(_T("[AUTOA4AF]"), _GetPlainResString(IDS_ALL_A4AF_TO_HERE, true) + _T(" (") + _GetPlainResString(IDS_PRIOAUTO, true) + _T(")"));
d1728 2
@


1.277
log
@Some changes...
@
text
@d781 4
a784 1
	CString sCat; (cat!=0)?sCat.Format("&cat=%i",cat):sCat="";
d802 1
a802 1
	Out.Replace(_T("[Options]"), _GetPlainResString(IDS_EM_PREFS));
d1002 4
a1005 1
	CString sCat; (cat!=0)?sCat.Format("%i",cat):sCat="";
d1606 4
a1609 1
	CString sCat; (cat!=0)?sCat.Format("&cat=%i",cat):sCat="";
d3167 4
a3170 1
	CString sCat; (cat!=0)?sCat.Format("%i",cat):sCat="";
d3878 4
a3881 1
	CString sCat; (cat!=0)?sCat.Format("%i",cat):sCat="";
d3970 4
a3973 1
	CString sCat; (cat!=0)?sCat.Format("%i",cat):sCat="";
d4007 4
a4010 1
	CString sCat; (cat!=0)?sCat.Format("%i",cat):sCat="";
d4044 4
a4047 1
	CString sCat; (cat!=0)?sCat.Format("%i",cat):sCat="";
d4106 4
a4109 1
	CString sCat; (cat!=0)?sCat.Format("%i",cat):sCat="";
d4652 5
a4656 1
	CString sCat; (cat!=0)?sCat.Format("%i",cat):sCat="";
@


1.276
log
@WebServer: added Get First/Last chunk for Preview
@
text
@d2266 2
a2267 1
			dFile.bIsGetFLC = (!pPartFile->PreviewAvailable() && (pPartFile->GetMovieMode() != 0));
d2608 6
a2613 2
		if (FilesArray[i].bIsGetFLC)
			isgetflc = _T("isgetflc");
d2656 1
a2656 1
		if (FilesArray[i].bIsGetFLC)
@


1.275
log
@Removed JumpStart localization (IDS_PRIOJUMPSTART) and changed Comments/Rating code on Shared Files.
@
text
@d827 1
d1730 2
d2266 1
d2577 1
d2607 3
d2636 1
d2651 5
@


1.274
log
@Removed AddDebugLogLine statusbar message option, added client transfer debug log option
@
text
@d836 1
a836 1
	Out.Replace(_T("[Jumpstart]"), _GetPlainResString(IDS_PRIOJUMPSTART, true));
d3532 1
a3532 1
				buffer.Format(_T("%s[%s]"), _GetPlainResString(IDS_PRIOJUMPSTART),dFile.sFilePriority);
@


1.273
log
@IRC channel messages now supports background color coded messages (Thanks SyruS!);
Added a Word Wrap context menu option to logs, IRC & messages;
Fixed category tabs padding (Mantis bug #0000415);
Improved logs, IRC & messages code + formatting & name changes
@
text
@d2550 1
a2550 1
	AddDebugLogLine(false, _T("WebServer: Waitingqueue with %u elements sorted in %u ms"), QueueArray.GetSize(), ::GetTickCount()-dwStart);
@


1.272
log
@Minor fix
@
text
@d3944 1
a3944 1
		g_eMuleApp.m_pdlgEmule->m_wndServer.logbox->Reset();
d3949 1
a3949 1
	Out.Replace(_T("[Log]"), g_eMuleApp.m_pdlgEmule->m_wndServer.logbox->GetHtml()+"<br><a name=\"end\"></a>");
d4012 1
a4012 1
		g_eMuleApp.m_pdlgEmule->m_wndServer.debugbox->Reset();
d4017 1
a4017 1
	Out.Replace(_T("[DebugLog]"), g_eMuleApp.m_pdlgEmule->m_wndServer.debugbox->GetHtml()+"<br><a name=\"end\"></a>" );
@


1.271
log
@Removed old code and fixed issues with categories in WebServer templates
@
text
@d765 1
a765 1
	if (sPage == "options" || sPage == "stats")
d770 1
a770 1
		strDummyNumber.Format(_T("%d"), rand());
@


1.270
log
@Use defined client name (not from resources).
@
text
@d763 1
a763 2
	if (sPage == "transfer")
		strCat="&cat="+_ParseURL(Data.sURL, "cat");
d765 3
a767 2
	if ( (sPage == "transfer") || (sPage == "server") || (sPage == "graphs") ||
		 (sPage == "log") || (sPage == "sinfo") || (sPage == "debuglog") || (sPage == "stats") )
a768 2
	else
		sRefresh.Format(_T("0"));
d996 4
d1125 1
d3137 4
d3441 1
d3845 4
d3911 2
a3912 2
	Out.Replace(_T("[URL_Disconnect]"), IsSessionAdmin(Data,sSession)?CString(_T("/?ses=") + sSession + _T("&w=server&c=disconnect")):GetPermissionDenied());
	Out.Replace(_T("[URL_Connect]"), IsSessionAdmin(Data,sSession)?CString(_T("/?ses=") + sSession + _T("&w=server&c=connect")):GetPermissionDenied());
d3917 1
d3934 4
d3951 1
d3968 4
d3985 1
d4002 4
d4019 1
d4061 4
d4201 2
d4581 1
a4588 2
		byte cat=atoi(_ParseURL(Data.sURL, "cat"));

d4606 1
d4608 1
d4692 1
@


1.269
log
@Removed Drop SuperCompressed blocks feature from WebServer
@
text
@d789 1
a789 1
	Out.Replace(_T("[eMuleAppName]"), _GetPlainResString(IDS_EMULE_PLUS));
d4152 1
a4152 1
	Out.Replace(_T("[eMuleAppName]"), _GetPlainResString(IDS_EMULE_PLUS));
d4191 1
a4191 1
	Out.Replace(_T("[eMuleAppName]"), _GetPlainResString(IDS_EMULE_PLUS));
@


1.268
log
@Final DebugLog formating and changes
@
text
@a823 1
	Out.Replace(_T("[DropSCB]"), _GetPlainResString(IDS_DROPSUPERCOMPRESSED, true));
a1750 2
			else if(bAdmin && sOp.CompareNoCase(_T("compressed")) == 0)
				found_file->SetDiscardSuperCompressed( !found_file->GetDiscardSuperCompressed() );
a2258 1
			dFile.bCompress = pPartFile->GetDiscardSuperCompressed();
a2568 1
		CString scb;			//dropscb
a2595 3
		if (FilesArray[i].bCompress && !FilesArray[i].bIsComplete)
			scb = _T("scb");

a2623 1
		HTTPProcessData.Replace(_T("[scb]"), scb);
a2631 5
		if (FilesArray[i].bCompress && !FilesArray[i].bIsComplete)
			HTTPProcessData.Replace(_T("[FileIsSCB]"), _T("scb"));
		else
			HTTPProcessData.Replace(_T("[FileIsSCB]"), _T("halfnone"));

@


1.267
log
@Fix for WS page reload (IE shouldn't reload all images again now) - following kuchin recommendation ;-)
@
text
@d214 1
a214 1
			AddDebugLogLine(false, RGB_LOG_ERROR + GetResString(IDS_WEB_ERR_CANTLOAD), sTemplateName);
@


1.266
log
@Minor fix
@
text
@d21 1
a21 1
#define WEB_SERVER_TEMPLATES_VERSION	1003
a118 1
			m_Templates.sHeaderMetaRefresh = _LoadTemplate(sAll,_T("TMPL_HEADER_META_REFRESH"));
d758 15
a772 21
	if(g_eMuleApp.m_pGlobPrefs->GetWebPageRefresh() != 0)
	{
		CString sPage = _ParseURL(Data.sURL, _T("w"));
		if ((sPage == "transfer") ||
			(sPage == "server") ||
			(sPage == "graphs") ||
			(sPage == "log") ||
			(sPage == "sinfo") ||
			(sPage == "debuglog") ||
			(sPage == "stats"))
		{
			CString sT = pThis->m_Templates.sHeaderMetaRefresh;
			CString sRefresh; sRefresh.Format(_T("%d"), g_eMuleApp.m_pGlobPrefs->GetWebPageRefresh());
			sT.Replace(_T("[RefreshVal]"), sRefresh);
			CString catadd;
			if (sPage == "transfer")
				catadd="&cat="+_ParseURL(Data.sURL, "cat");
			sT.Replace(_T("[wCommand]"), _ParseURL(Data.sURL, _T("w"))+catadd);
			Out.Replace(_T("[HeaderMeta]"), sT);
		}
	}
a773 2
	bool bAdmin = IsSessionAdmin(Data,sSession);
	CString admin;
d778 1
d787 2
a788 1
	Out.Replace(_T("[HeaderMeta]"), _T("")); // In case there are no meta
@


1.265
log
@Many changes/improvements/bugfixes to new FakeCheck system
@
text
@d3353 6
a3358 4
		CString resultlog = _SpecialChars(g_eMuleApp.m_pdlgEmule->m_strLogText);	//Pick-up last line of the log
		resultlog = resultlog.TrimRight('\n');
		resultlog = resultlog.Mid(resultlog.ReverseFind('\n'));
		Out.Replace(_T("[Message]"),resultlog);
d3361 1
a3361 1
        Out.Replace(_T("[Message]"),_T(""));
@


1.264
log
@Fixed open of configuration files accessed for reading by other processes
<thanks Fuxie - DK for report and testing>;
Improved string processing.
@
text
@d4596 1
a4596 2
		if(!g_eMuleApp.m_pFakeCheck->UpdateFakeList())
			g_eMuleApp.m_pdlgEmule->AddLogLine(true, GetResString(IDS_FAKE_CHECKUPERROR));
@


1.263
log
@new FakeCheck autoupdate system
@
text
@d92 1
a92 1
	if(file.Open(sFile, CFile::modeRead|CFile::typeText))
d94 1
a94 1
		CString sAll;
a96 1
			CString sLine;
@


1.262
log
@minor changes (Partfile --> PartFile...)
@
text
@d4597 1
a4597 1
		if(!g_eMuleApp.m_pFakeCheck->DownloadFakeList())
@


1.261
log
@better string processing
@
text
@d2227 1
a2227 1
				if (pPartFile != NULL && pPartFile->GetPartfileStatusID() == PS_STALLED)
@


1.260
log
@Fix for WebServer File Info alert
@
text
@d61 2
a62 2
	m_Params.sLastModified = _T("");
	m_Params.sETag = _T("");
d86 1
a86 1
	if (g_eMuleApp.m_pGlobPrefs->GetTemplate()=="" || g_eMuleApp.m_pGlobPrefs->GetTemplate().MakeLower()=="emule.tmpl")
d203 1
a203 1
	CString sRet = _T("");
d449 3
a451 3
	CString Out = _T("");
	CString OutE = _T("");	// List Entry Templates
	CString OutS = _T("");	// ServerStatus Templates
d455 1
a455 2
	CString HTTPProcessData = _T("");
	CString HTTPTemp = _T("");
d460 1
a460 1
	if(_ParseURL(Data.sURL, _T("ses")) != "")
d488 1
a488 1
		else if(g_eMuleApp.m_pGlobPrefs->GetWSIsLowUserEnabled() && g_eMuleApp.m_pGlobPrefs->GetWSLowPass()!="" && MD5Sum(_ParseURL(Data.sURL, _T("p"))).GetHash() == g_eMuleApp.m_pGlobPrefs->GetWSLowPass())
d614 1
a614 1
		if (sPage == "")
d676 2
a677 1
			if (temp=="") break;
d695 1
a695 2
	CString value = _T("");
	CString Parameter = _T("");
d774 1
a774 1
			CString catadd="";
d823 1
a823 1
		Out.Replace("[CATBOX]","");
d831 1
a831 1
	Out.Replace(_T("[AUTOA4AF]"), _GetPlainResString(IDS_ALL_A4AF_TO_HERE, true) + " (" + _GetPlainResString(IDS_PRIOAUTO, true) + ")");
d858 1
a858 3
	CString HTTPConState = _T("");
	CString HTTPConText = _T("");
	CString HTTPHelp;
d1092 1
a1092 1
	if (sSort != "")
d1192 2
a1193 2
		Out.Replace(_T("[ServernameI]"), "");
		Out.Replace(_T("[ServernameH]"), "");
d1204 2
a1205 2
		Out.Replace(_T("[AddressI]"), "");
		Out.Replace(_T("[AddressH]"), "");
d1216 2
a1217 2
		Out.Replace(_T("[DescriptionI]"), "");
		Out.Replace(_T("[DescriptionH]"), "");
d1228 2
a1229 2
		Out.Replace(_T("[PingI]"), "");
		Out.Replace(_T("[PingH]"), "");
d1240 2
a1241 2
		Out.Replace(_T("[UsersI]"), "");
		Out.Replace(_T("[UsersH]"), "");
d1252 2
a1253 2
		Out.Replace(_T("[UsersI]"), "");
		Out.Replace(_T("[FilesH]"), "");
d1264 2
a1265 2
		Out.Replace(_T("[PriorityI]"), "");
		Out.Replace(_T("[PriorityH]"), "");
d1276 2
a1277 2
		Out.Replace(_T("[FailedI]"), "");
		Out.Replace(_T("[FailedH]"), "");
d1288 2
a1289 2
		Out.Replace(_T("[LimitI]"), "");
		Out.Replace(_T("[LimitH]"), "");
d1300 2
a1301 2
		Out.Replace(_T("[VersionI]"), "");
		Out.Replace(_T("[VersionH]"), "");
d1347 1
a1347 2
		CString temp="";
		CString newip="";
d1442 1
a1442 1
	CString sList = _T("");
d1447 7
a1453 7
		CString admin = "";			//admin rights
		CString ed2k = "";			//ed2k
		CString session = "";		//session
		CString ip = "";			//ip
		CString port;				//port
		CString isstatic = "";		//serverstatic
		CString srvpriority = "";	//priority
d1509 1
a1509 1
			HTTPProcessData.Replace(_T("[Name]"), "");
d1516 1
a1516 1
			HTTPProcessData.Replace(_T("[Address]"), "");
d1525 1
a1525 1
			HTTPProcessData.Replace(_T("[Description]"), "");
d1532 1
a1532 1
			HTTPProcessData.Replace(_T("[Ping]"), "");
d1546 1
a1546 1
			HTTPProcessData.Replace(_T("[Users]"), "");
d1552 1
a1552 1
			HTTPProcessData.Replace(_T("[Files]"), "");
d1556 1
a1556 1
			HTTPProcessData.Replace(_T("[Priority]"), "");
d1563 1
a1563 1
			HTTPProcessData.Replace(_T("[Failed]"), "");
d1573 1
a1573 1
			HTTPProcessData.Replace(_T("[Limit]"), "");
d1582 1
a1582 1
			HTTPProcessData.Replace(_T("[Version]"), "");
d1617 1
a1617 1
	CString Out = _T("");
d1988 2
a1989 2
		Out.Replace(_T("[DFilenameI]"), "");
		Out.Replace(_T("[DFilename]"), "");
d2001 2
a2002 2
		Out.Replace(_T("[DSizeI]"), "");
		Out.Replace(_T("[DSize]"), "");
d2014 2
a2015 2
		Out.Replace(_T("[DTransferredI]"), "");
		Out.Replace(_T("[DTransferred]"), "");
d2027 2
a2028 2
		Out.Replace(_T("[DProgressI]"), "");
		Out.Replace(_T("[DProgress]"), "");
d2040 2
a2041 2
		Out.Replace(_T("[DSpeedI]"), "");
		Out.Replace(_T("[DSpeed]"), "");
d2053 2
a2054 2
		Out.Replace(_T("[DSourcesI]"), "");
		Out.Replace(_T("[DSources]"), "");
d2066 2
a2067 2
		Out.Replace(_T("[DPriorityI]"), "");
		Out.Replace(_T("[DPriority]"), "");
d2079 2
a2080 2
		Out.Replace(_T("[DCategoryI]"), "");
		Out.Replace(_T("[DCategory]"), "");
d2092 2
a2093 2
		Out.Replace(_T("[DFakeCheckI]"), "");
		Out.Replace(_T("[DFakeCheck]"), "");
d2109 2
a2110 2
		Out.Replace(_T("[UUserI]"), "");
		Out.Replace(_T("[UUser]"), "");
d2122 2
a2123 2
		Out.Replace(_T("[UVersionI]"), "");
		Out.Replace(_T("[UVersion]"), "");
d2135 2
a2136 2
		Out.Replace(_T("[UFilenameI]"), "");
		Out.Replace(_T("[UFilename]"), "");
d2148 2
a2149 2
		Out.Replace(_T("[UTransferredI]"), "");
		Out.Replace(_T("[UTransferred]"), "");
d2161 2
a2162 2
		Out.Replace(_T("[USpeedI]"), "");
		Out.Replace(_T("[USpeed]"), "");
d2566 1
a2566 1
	CString sDownList = _T("");
d2577 11
a2587 11
		CString admin = "";			//admin rights
		CString finfo;				//fileinfo
		CString ed2k;				//ed2klink
		CString state;				//state
		CString scb = "";			//dropscb
		CString autoa4af = "";		//autoa4af
		CString fname;				//filename
		CString fsize;				//filesize
		CString session;			//session
		CString filehash;			//filehash
		CString downpriority = "";	//priority
d2669 1
a2669 1
			HTTPProcessData.Replace(_T("[ShortFileName]"), "");
d2681 1
a2681 1
			HTTPProcessData.Replace(_T("[2]"), "");
d2694 1
a2694 1
			HTTPProcessData.Replace(_T("[3]"), "");
d2699 1
a2699 1
			HTTPProcessData.Replace(_T("[DownloadBar]"), "");
d2701 1
a2701 1
		HTTPTemp = "";
d2715 1
a2715 1
			HTTPProcessData.Replace(_T("[4]"), "");
d2731 1
a2731 1
			HTTPProcessData.Replace(_T("[5]"), "");
d2756 1
a2756 1
			HTTPProcessData.Replace(_T("[PrioVal]"), "");
d2761 1
a2761 1
			HTTPProcessData.Replace(_T("[Category]"), "");
d2766 1
a2766 1
			HTTPProcessData.Replace(_T("[FakeCheck]"), "");
d2789 1
a2789 1
	CString sUpList = _T("");
d2810 1
a2810 1
			HTTPProcessData.Replace(_T("[1]"), "");
d2814 1
a2814 1
			HTTPProcessData.Replace(_T("[ClientSoftV]"), "");
d2818 1
a2818 1
			HTTPProcessData.Replace(_T("[2]"), "");
d2827 1
a2827 1
			HTTPProcessData.Replace(_T("[3]"), "");
d2835 1
a2835 1
			HTTPProcessData.Replace(_T("[4]"), "");
d2850 1
a2850 1
		CString sQueue = _T("");
d2860 1
a2860 1
				HTTPProcessData.Replace(_T("[UserName]"), "");
d2864 1
a2864 1
				HTTPProcessData.Replace(_T("[ClientSoftV]"), "");
d2868 1
a2868 1
				HTTPProcessData.Replace(_T("[FileName]"), "");
d2875 1
a2875 1
				HTTPProcessData.Replace(_T("[Score]"), "");
d2899 1
a2899 1
		CString sQueueBanned = _T("");
d2909 1
a2909 1
				HTTPProcessData.Replace(_T("[UserName]"), "");
d2913 1
a2913 1
				HTTPProcessData.Replace(_T("[ClientSoftV]"), "");
d2917 1
a2917 1
				HTTPProcessData.Replace(_T("[FileName]"), "");
d2924 1
a2924 1
				HTTPProcessData.Replace(_T("[Score]"), "");
d2948 1
a2948 1
		CString sQueueFriend = _T("");
d2958 1
a2958 1
				HTTPProcessData.Replace(_T("[UserName]"), "");
d2962 1
a2962 1
				HTTPProcessData.Replace(_T("[ClientSoftV]"), "");
d2966 1
a2966 1
				HTTPProcessData.Replace(_T("[FileName]"), "");
d2973 1
a2973 1
				HTTPProcessData.Replace(_T("[Score]"), "");
d2997 1
a2997 1
		CString sQueueCredit = _T("");
d3007 1
a3007 1
				HTTPProcessData.Replace(_T("[UserName]"), "");
d3011 1
a3011 1
				HTTPProcessData.Replace(_T("[ClientSoftV]"), "");
d3015 1
a3015 1
				HTTPProcessData.Replace(_T("[FileName]"), "");
d3022 1
a3022 1
				HTTPProcessData.Replace(_T("[Score]"), "");
d3101 2
a3102 2
		Out.Replace(_T("[UserNameTitleI]"), "");
		Out.Replace(_T("[UserNameTitle]"), "");
d3113 2
a3114 2
		Out.Replace(_T("[VersionI]"), "");
		Out.Replace(_T("[Version]"), "");
d3125 2
a3126 2
		Out.Replace(_T("[FileNameTitleI]"), "");
		Out.Replace(_T("[FileNameTitle]"), "");
d3137 2
a3138 2
		Out.Replace(_T("[ScoreTitleI]"), "");
		Out.Replace(_T("[ScoreTitle]"), "");
d3161 1
a3161 1
	if (_ParseURL(Data.sURL, _T("sort")) != "")
d3188 1
a3188 1
		if(_ParseURL(Data.sURL, _T("sortreverse")) == "")
d3191 1
a3191 1
	if (_ParseURL(Data.sURL, _T("sortreverse")) != "")
d3194 1
a3194 1
	if(_ParseURL(Data.sURL, _T("hash")) != "" && _ParseURL(Data.sURL, _T("prio")) != "" && IsSessionAdmin(Data,sSession))
d3374 2
a3375 2
		Out.Replace(_T("[FilenameI]"), "");
		Out.Replace(_T("[Filename]"), "");
d3386 2
a3387 2
		Out.Replace(_T("[FileTransferredI]"), "");
		Out.Replace(_T("[FileTransferred]"),  "");
d3398 2
a3399 2
		Out.Replace(_T("[FileRequestsI]"), "");
		Out.Replace(_T("[FileRequests]"),  "");
d3410 2
a3411 2
		Out.Replace(_T("[FileAcceptsI]"), "");
		Out.Replace(_T("[FileAccepts]"),  "");
d3422 2
a3423 2
		Out.Replace(_T("[SizeI]"), "");
		Out.Replace(_T("[Size]"), "");
d3434 2
a3435 2
		Out.Replace(_T("[CompletesI]"), "");
		Out.Replace(_T("[Completes]"),  "");
d3446 2
a3447 2
		Out.Replace(_T("[PriorityI]"), "");
		Out.Replace(_T("[Priority]"),  "");
d3507 1
a3507 1
					dFile.sFileCompletes= _T("");
d3629 1
a3629 1
	CString sSharedList = _T("");
d3641 7
a3647 7
		CString admin = "";				//admin rights
		CString ed2k;					//ed2klink
		CString session;				//session
		CString hash;					//hash
		CString fname;					//filename
		CString sharedpriority = "";	//priority
		CString isjumpstart = "";		//jumpstart
d3721 1
a3721 1
			HTTPProcessData.Replace(_T("[ShortFileName]"), "");
d3731 2
a3732 2
			HTTPProcessData.Replace(_T("[FileTransferred]"), "");
			HTTPProcessData.Replace(_T("[FileAllTimeTransferred]"), "");
d3743 2
a3744 2
			HTTPProcessData.Replace(_T("[FileRequests]"), "");
			HTTPProcessData.Replace(_T("[FileAllTimeRequests]"), "");
d3755 2
a3756 2
			HTTPProcessData.Replace(_T("[FileAccepts]"), "");
			HTTPProcessData.Replace(_T("[FileAllTimeAccepts]"), "");
d3764 1
a3764 1
			HTTPProcessData.Replace(_T("[FileSize]"), "");
d3768 1
a3768 1
			HTTPProcessData.Replace(_T("[Completes]"), "");
d3772 1
a3772 1
			HTTPProcessData.Replace(_T("[Priority]"), "");
d3859 2
a3860 1
	if (!IsSessionAdmin(Data,sSession)) return _T("");
d3865 1
a3865 1
		if(_ParseURL(Data.sURL, _T("serveraddr")) != "" && _ParseURL(Data.sURL, _T("serverport")) != "")
d4062 1
a4062 1
		if(_ParseURL(Data.sURL, _T("gzip")) == "false" || _ParseURL(Data.sURL, _T("gzip")) == "")
d4072 1
a4072 1
	    if(_ParseURL(Data.sURL, _T("refresh")) != "")
d4074 1
a4074 1
		if(_ParseURL(Data.sURL, _T("maxdown")) != "")
d4084 1
a4084 1
	    if(_ParseURL(Data.sURL, _T("maxup")) != "")
d4091 1
a4091 1
	    if(_ParseURL(Data.sURL, _T("maxcapdown")) != "")
d4093 1
a4093 1
	    if(_ParseURL(Data.sURL, _T("maxcapup")) != "")
d4096 1
a4096 1
		if(_ParseURL(Data.sURL, _T("maxsources")) != "")
d4098 1
a4098 1
		if(_ParseURL(Data.sURL, _T("maxconnections")) != "")
d4100 1
a4100 1
		if(_ParseURL(Data.sURL, _T("maxconnectionsperfive")) != "")
d4206 1
a4206 1
	CString Out = _T("");
d4292 1
a4292 1
		return "";
d4330 1
a4330 1
		return "";
d4430 1
a4430 1
	sRet.Replace(_T("&"), _T(""));
d4570 1
a4570 1
	if (_ParseURL(Data.sURL, _T("downloads")) != "" && IsSessionAdmin(Data,sSession))
d4582 1
a4582 1
		while (resToken != "")
d4601 1
a4601 1
	if(_ParseURL(Data.sURL, _T("tosearch")) != "" && IsSessionAdmin(Data,sSession) )
d4614 1
a4614 3
			(_ParseURL(Data.sURL, _T("global"))=="on"),
			_T("")
			);
d4617 1
a4617 1
	else if(_ParseURL(Data.sURL, _T("tosearch")) != "" && !IsSessionAdmin(Data,sSession) )
d4642 1
a4642 1
		InsertCatBox(Out,0,pThis->m_Templates.sCatArrow,false,false,sSession,"");
d4644 1
a4644 1
		Out.Replace("[CATBOX]","");
d4679 1
a4679 1
	CString checked = "";
d4698 2
a4699 2
		Out.Replace(_T("[FilenameI]"), "");
		Out.Replace(_T("[FilenameH]"), "");
d4710 2
a4711 2
		Out.Replace(_T("[FilesizeI]"), "");
		Out.Replace(_T("[FilesizeH]"), "");
d4722 2
a4723 2
		Out.Replace(_T("[FilehashI]"), "");
		Out.Replace(_T("[FilehashH]"), "");
d4734 2
a4735 2
		Out.Replace(_T("[SourcesI]"), "");
		Out.Replace(_T("[SourcesH]"), "");
d4746 2
a4747 2
		Out.Replace(_T("[FakeCheckI]"), "");
		Out.Replace(_T("[FakeCheckH]"), "");
@


1.259
log
@fixed security exploit in IRC module and Web server (from official) [katsyonak]
@
text
@d2597 1
d2600 1
a2600 1
		JSfileinfo.Replace(_T("'"),_T("&#8217;")); // EC 22/5 - Chararacter ' causes a problem in javascript:alert()
@


1.258
log
@replaced  pos != 0 to pos != NULL
@
text
@d295 2
a296 1
	DecodeBase16(hash.GetBuffer(),hash.GetLength(),fileid);
d300 2
a301 1
	if (cur_file==0) return;
d318 3
a320 1
	DecodeBase16(hash.GetBuffer(),hash.GetLength(),fileid);
d324 2
a325 1
	if (cur_file==0) return;
d3202 2
a3203 1
		DecodeBase16(hash.GetBuffer(),hash.GetLength(),fileid);
d3205 1
a3205 1
		cur_file=g_eMuleApp.m_pSharedFilesList->GetFileByID(fileid);
d3207 1
a3207 3
		if (cur_file!=0)
		{
			if(_ParseURL(Data.sURL, _T("prio")) == "verylow")
d3209 32
a3240 2
				cur_file->SetAutoPriority(false);
				cur_file->SetPriority(PR_VERYLOW);
a3241 27
			if(_ParseURL(Data.sURL, _T("prio")) == "low")
			{
				cur_file->SetAutoPriority(false);
				cur_file->SetPriority(PR_LOW);
			}
			if(_ParseURL(Data.sURL, _T("prio")) == "normal")
			{
				cur_file->SetAutoPriority(false);
				cur_file->SetPriority(PR_NORMAL);
			}
			if(_ParseURL(Data.sURL, _T("prio")) == "high")
			{
				cur_file->SetAutoPriority(false);
				cur_file->SetPriority(PR_HIGH);
			}
			if(_ParseURL(Data.sURL, _T("prio")) == "release")
			{
				cur_file->SetAutoPriority(false);
				cur_file->SetPriority(PR_RELEASE);
			}
			else if(_ParseURL(Data.sURL, _T("prio")) == "auto" && cur_file->IsPartFile())
			{
				cur_file->SetAutoPriority(true);
				cur_file->UpdateUploadAutoPriority();
			}

			g_eMuleApp.m_pSharedFilesList->UpdateItem(cur_file); // DonGato: refresh GUI on priority change
d3687 2
a3688 1
		DecodeBase16(hash.GetBuffer(),hash.GetLength(),fileid);
d3692 1
a3692 1
		if (cur_file->GetJumpstartEnabled())
d3694 9
a3702 2
			isjumpstart = _T("jumpstart");
			HTTPProcessData.Replace(_T("[FileIsPriority]"), "jumpstart");
a3703 4
		else if (cur_file->GetPriority() == PR_RELEASE)
			HTTPProcessData.Replace(_T("[FileIsPriority]"), "release");
		else
			HTTPProcessData.Replace(_T("[FileIsPriority]"), "none");
a3707 1
		HTTPProcessData.Replace(_T("[hash]"), hash);
d4481 2
a4482 1
	DecodeBase16(filehash.GetBuffer(), filehash.GetLength(), fileid);
d4587 2
a4588 4
			DecodeBase16(resToken.GetBuffer(),resToken.GetLength(),fileid);

			g_eMuleApp.m_pSearchList->AddFileToDownloadByHash(fileid,eCatID);

@


1.257
log
@I'm a sinner! WebServer rename feature added
@
text
@d2186 1
a2186 1
		for (POSITION pos=g_eMuleApp.m_pDownloadQueue->m_partFileList.GetHeadPosition(); pos != 0;)
d2347 1
a2347 1
	for (POSITION pos = g_eMuleApp.m_pUploadQueue->uploadinglist.GetHeadPosition(); pos != 0;)
d2453 1
a2453 1
	for (POSITION pos = g_eMuleApp.m_pUploadQueue->waitinglist.GetHeadPosition(); pos != 0;)
d3455 1
a3455 1
	for (POSITION pos = g_eMuleApp.m_pSharedFilesList->m_mapSharedFiles.GetStartPosition();pos != 0;)
@


1.256
log
@Fixes for Search "xxx (x)" and WebServer progress bar. :P
@
text
@d834 1
d1734 5
@


1.255
log
@Improved string processing
@
text
@d4517 6
a4535 5

		int		compl = static_cast<int>((pThis->m_Templates.iProgressbarWidth / 100.0) * pPartFile->GetPercentCompleted());

		Out.AppendFormat(pThis->m_Templates.sProgressbarImgsPercent+_T("<br>"),
			progresscolor[(compl > 0) ? 10 : 11], (compl > 0) ? compl : 5);
@


1.254
log
@bugfix: fakelist update within webserver didnt work because fakes.dat was always added to url, now i.e. fakes.rar is already included in url
@
text
@a192 1
	CString buffer;
d939 8
a946 2
	HTTPHelp.Format(_T("%i"),g_eMuleApp.m_pGlobPrefs->GetMaxUpload());
	if (HTTPHelp == "65535")  HTTPHelp = GetResString(IDS_PW_UNLIMITED);
d948 6
a953 2
	HTTPHelp.Format(_T("%i"),g_eMuleApp.m_pGlobPrefs->GetMaxDownload());
	if (HTTPHelp == "65535") HTTPHelp = GetResString(IDS_PW_UNLIMITED);
d955 6
a960 2
	HTTPHelp.Format(_T("%i"),g_eMuleApp.m_pGlobPrefs->GetMaxConnections());
	if (HTTPHelp == "65535") HTTPHelp = GetResString(IDS_PW_UNLIMITED);
a1081 1
		CString buffer;
a1657 1
		CString buffer;
a1668 1
		CString buffer;
a1679 1
		CString buffer;
a1705 1

a3237 1
		CString buffer;
d3785 2
a3786 3
	CString sGraphDownload = _T(""), sGraphUpload = _T(""), sGraphCons = _T("");
	CString sTmp = _T("");
	int nPrevValUp = 0, nPrevValDown = 0;
d3793 3
a3795 3
				sGraphDownload += _T(",");
				sGraphUpload += _T(",");
				sGraphCons += _T(",");
d3799 1
a3799 2
			sTmp.Format(_T("%d") , (uint32) (pThis->m_Params.PointsForWeb[i].download*1024));
			sGraphDownload += sTmp;
d3802 1
a3802 2
			sTmp.Format(_T("%d") , (uint32) (pThis->m_Params.PointsForWeb[i].upload*1024));
			sGraphUpload += sTmp;
d3805 1
a3805 2
			sTmp.Format(_T("%d") , (uint32) (pThis->m_Params.PointsForWeb[i].connections));
			sGraphCons += sTmp;
d3809 3
a3811 3
	Out.Replace(_T("[GraphDownload]"), sGraphDownload);
	Out.Replace(_T("[GraphUpload]"), sGraphUpload);
	Out.Replace(_T("[GraphConnections]"), sGraphCons);
d4467 1
a4467 2
	CString Out = _T("");
	CString temp = _T("");
d4507 2
a4508 4
		temp.Format(pThis->m_Templates.sProgressbarImgsPercent+_T("<br>"),progresscolor[10],pThis->m_Templates.iProgressbarWidth);
		Out+=temp;
		temp.Format(pThis->m_Templates.sProgressbarImgs,progresscolor[0],pThis->m_Templates.iProgressbarWidth);
		Out+=temp;
d4523 1
a4523 3
					temp.Format(pThis->m_Templates.sProgressbarImgs ,progresscolor[lastcolor],i-lastindex);

					Out+=temp;
d4529 1
a4529 2
		temp.Format(pThis->m_Templates.sProgressbarImgs,progresscolor[lastcolor],pThis->m_Templates.iProgressbarWidth-lastindex);
		Out+=temp;
d4533 2
a4534 2
		(compl>0)?temp.Format(pThis->m_Templates.sProgressbarImgsPercent+_T("<br>"),progresscolor[10],compl) :temp.Format(pThis->m_Templates.sProgressbarImgsPercent+_T("<br>"),progresscolor[11],5);
		Out=temp+Out;
a4618 1
		CString buffer;
a4783 1
	CString tempBuf3;
d4795 1
a4795 2
		tempBuf3= (i==preselect)? " selected":"";
		tempBuf.AppendFormat("<option%s value=\"%i\">%s</option>", tempBuf3, i, strCategory);
d4799 1
a4799 1
		if (CCat::GetNumCats()>1)
d4806 1
a4806 2
			tempBuf3= ((i)==preselect)? " selected":"";
			tempBuf.AppendFormat("<option%s value=\"%i\">%s</option>", tempBuf3, i+100, GetSubCatLabel(i));
d4812 3
a4814 2
	CString tempBuff2,tempBuff3, tempBuff4, strI;
	CString tempBuff="";
d4816 1
a4816 1
	for (int i=0;i< CCat::GetNumCats();i++)
a4817 1
		strI.Format(_T("%d"),i);
d4820 1
a4820 1
			tempBuff3 = " src=checked.gif";
d4827 1
a4827 1
			tempBuff3 = " src=checked_no.gif";
d4829 1
a4829 6
		tempBuff2 = CString("<a href=&quot;/?ses=" + sSession + "&w=transfer&cat=");
		tempBuff2+= strI;
		tempBuff2+= CString("&quot;><div class=menuitems><img class=menuchecked");
		tempBuff2+= tempBuff3;
		tempBuff2+= CString(">");
		CString		strCategory = (i < CCat::GetNumPredefinedCats()) ? CCat::GetPredefinedCatTitle(CCat::GetCatIDByIndex(i)) : CCat::GetCatByIndex(i)->GetTitle();
d4831 4
a4834 3
		tempBuff2+= strCategory;
		tempBuff2+= CString("&nbsp;</div></a>");
		tempBuff.Append(tempBuff2);
d4838 1
a4838 1
		for (int i=(CCat::GetNumCats()>1)?1:2;i<=14;i++)
a4839 1
			strI.Format(_T("%d"),i+CAT_PREDEFINED);
d4842 1
a4842 1
				tempBuff3= " src=checked.gif";
d4846 1
a4846 1
				tempBuff3 = " src=checked_no.gif";
d4848 3
a4850 8
			tempBuff2 = CString("<a href=&quot;/?ses=" + sSession + "&w=transfer&cat=");
			tempBuff2+= strI;
			tempBuff2+= CString("&quot;><div class=menuitems><img class=menuchecked");
			tempBuff2+= tempBuff3;
			tempBuff2+= CString(">");
			tempBuff2+= GetSubCatLabel(i);
			tempBuff2+= CString("&nbsp;</div></a>");
			tempBuff.Append(tempBuff2);
d4856 1
a4856 3

	tempBuff="";
	tempBuff2="";
a4868 1
		strI.Format(_T("%d"),i);
d4871 1
a4871 1
			tempBuff3 = " src=checked.gif";
d4875 1
a4875 1
			tempBuff3 = " src=checked_no.gif";
d4877 1
a4877 7
		tempBuff2 = CString("<a href=&quot;/?ses=" + sSession + "&w=transfer[CatSel]&op=setcat&file=" + sFileHash + "&filecat=");
		tempBuff2+= strI;
		tempBuff2+= CString("&quot;><div class=menuitems><img class=menuchecked");
		tempBuff2+= tempBuff3;
		tempBuff2+= CString(">");
		CString strCategory = (i == 0)? GetResString(IDS_CAT_UNASSIGN) : CCat::GetCatByUserIndex(i)->GetTitle();
		//CString strCategory = (i == 0)? GetResString(IDS_CAT_UNCATEGORIZED) : CCat::GetCatByUserIndex(i)->GetTitle();
d4879 4
a4882 3
		tempBuff2+= strCategory;
		tempBuff2+= CString("&nbsp;</div></a>");
		tempBuff.Append(tempBuff2);
@


1.253
log
@Improved string processing; minor optimization.
@
text
@d4585 1
a4585 1
		g_eMuleApp.m_pGlobPrefs->SetFakeListURL(_ParseURL(Data.sURL, _T("url")) + "fakes.dat");
@


1.252
log
@WebServer: added Complete Sources column for Shared Files page
@
text
@d473 1
a473 1
		t_ulCurIP.Format(_T("%i.%i.%i.%i"),(byte)pThis->m_ulCurIP,(byte)(pThis->m_ulCurIP>>8),(byte)(pThis->m_ulCurIP>>16),(byte)(pThis->m_ulCurIP>>24));
d856 1
a856 1
	CString HTTPHelp = _T("");
d915 2
a916 4
	HTTPHelp.Format(_T("%s"), CastItoThousands(allUsers));
	Out.Replace(_T("[AllUsers]"), HTTPHelp);
	HTTPHelp.Format(_T("%s"), CastItoThousands(allFiles));
	Out.Replace(_T("[AllFiles]"), HTTPHelp);
d1437 1
a1437 1
		CString port = "";			//port
d1443 1
a1443 1
		ed2k.Format(CString(_T("ed2k://|server|") + ServerArray[i].sServerIP + "|" + sServerPort + _T("|/")));
d1446 1
a1446 1
            HTTPProcessData.Replace(_T("[LastChangedDataset]"), "checked");
d1448 1
a1448 1
            HTTPProcessData.Replace(_T("[LastChangedDataset]"), "checked_no");
d1451 1
a1451 1
			admin.Format(_T("admin"));
d1455 1
a1455 1
		port.Format(CString(sServerPort));
d1459 1
a1459 1
			isstatic.Format(_T("staticsrv"));
d1468 1
a1468 1
				srvpriority.Format(_T("Low"));
d1471 1
a1471 1
				srvpriority.Format(_T("Normal"));
d1474 1
a1474 1
				srvpriority.Format(_T("High"));
d1533 1
a1533 2
		sT = _T("");
		if (!WSserverColumnHidden[5])
d1535 1
a1535 3
			if(ServerArray[i].nServerFiles > 0)
				sT.Format(_T("%s"), CastItoThousands(ServerArray[i].nServerFiles));
			HTTPProcessData.Replace(_T("[Files]"), sT);
d1552 5
a1556 3
			CString sSoftLimit; sSoftLimit.Format(_T("%s"), CastItoThousands(ServerArray[i].nServerSoftLimit));
			CString sHardLimit; sHardLimit.Format(_T("%s"), CastItoThousands(ServerArray[i].nServerHardLimit));
			HTTPProcessData.Replace(_T("[Limit]"), sSoftLimit + " (" + sHardLimit + ")");
d1601 1
a1601 1
		admin.Format(_T("admin"));
d2563 3
a2565 3
		CString finfo = "";			//fileinfo
		CString ed2k = "";			//ed2klink
		CString state = "";			//state
d2568 4
a2571 4
		CString fname = "";			//filename
		CString fsize = "";			//filesize
		CString session = "";		//session
		CString filehash = "";		//filehash
d2585 4
a2588 4
		finfo.Format(JSfileinfo);
		ed2k.Format(JSED2kLink);
		fname.Format(FilesArray[i].sFileNameJS);
		state.Format(FilesArray[i].sFileState);
d2590 2
a2591 2
		session.Format(CString(sSession));
		filehash.Format(FilesArray[i].sFileHash);
d2594 1
a2594 1
			scb.Format(_T("scb"));
d2597 1
a2597 1
			autoa4af.Format(_T("autoa4af"));
d2600 1
a2600 1
			admin.Format(_T("admin"));
d2603 1
a2603 1
			downpriority.Format(_T("Auto"));
d2609 1
a2609 1
					downpriority.Format(_T("Low"));
d2612 1
a2612 1
					downpriority.Format(_T("Normal"));
d2615 1
a2615 1
					downpriority.Format(_T("High"));
d2783 1
a2783 1
			admin.Format(_T("admin"));
d2869 1
a2869 1
				admin.Format(_T("admin"));
d2918 1
a2918 1
				admin.Format(_T("admin"));
d2967 1
a2967 1
				admin.Format(_T("admin"));
d3016 1
a3016 1
				admin.Format(_T("admin"));
d3625 4
a3628 4
		CString ed2k = "";				//ed2klink
		CString session = "";			//session
		CString hash = "";				//hash
		CString fname = "";				//filename
d3635 1
a3635 1
				sharedpriority.Format(_T("VeryLow"));
d3638 1
a3638 1
				sharedpriority.Format(_T("Low"));
d3641 1
a3641 1
				sharedpriority.Format(_T("Normal"));
d3644 1
a3644 1
				sharedpriority.Format(_T("High"));
d3647 1
a3647 1
				sharedpriority.Format(_T("Release"));
d3650 2
a3651 2
		if(SharedArray[i].bFileAutoPriority)
				sharedpriority.Format(_T("Auto"));
d3654 1
a3654 1
			admin.Format(_T("admin"));
d3659 6
a3664 5
		ed2k.Format(JSED2kLink);
		session.Format(CString(sSession));
		hash.Format(CString(SharedArray[i].sFileHash));
		fname.Format(CString(SharedArray[i].sFileName));
        fname.Replace(_T("'"),_T("&#8217;"));
d3673 1
a3673 1
			isjumpstart.Format(_T("jumpstart"));
d3816 1
a3816 2
	CString sScale;
	sScale.Format(_T("%s"), CastSecondsToHM(g_eMuleApp.m_pGlobPrefs->GetTrafficOMeterInterval() * WEB_GRAPH_WIDTH) );
d3818 1
a3818 1
	CString s1, s2, s3;
a3819 4
	s2.Format(_T("%d"), g_eMuleApp.m_pGlobPrefs->GetMaxGraphUploadRate());
	s3.Format(_T("%d"), g_eMuleApp.m_pGlobPrefs->GetMaxConnections());

	Out.Replace(_T("[ScaleTime]"), sScale);
d3821 4
a3824 2
	Out.Replace(_T("[MaxUpload]"), s2);
	Out.Replace(_T("[MaxConnections]"), s3);
d4322 1
a4322 1
			t_ulCurIP.Format(_T("%i.%i.%i.%i"),(byte)pThis->m_ulCurIP,(byte)(pThis->m_ulCurIP>>8),(byte)(pThis->m_ulCurIP>>16),(byte)(pThis->m_ulCurIP>>24));
d4788 3
a4790 1
	CString tempBuf2,tempBuf3;
d4792 1
a4792 1
		tempBuf2="onchange=GotoCat(this.form.cat.options[this.form.cat.selectedIndex].value)>";
d4794 1
a4794 3
		tempBuf2=">";

	CString tempBuf="<form><select name=\"cat\" size=\"1\""+tempBuf2;
d4796 1
a4796 1
	for (int i=0;i-1< CCat::GetNumUserCats();i++)
d4801 1
a4801 2
		tempBuf2.Format("<option%s value=\"%i\">%s</option>",tempBuf3,i, strCategory);
		tempBuf.Append(tempBuf2);
d4807 1
a4807 2
			tempBuf2.Format("<option>------------</option>");
			tempBuf.Append(tempBuf2);
d4810 1
a4810 1
		for (int i=(CCat::GetNumCats()>1)?1:2;i<=14;i++)
d4813 1
a4813 2
			tempBuf2.Format("<option%s value=\"%i\">%s</option>",tempBuf3,i+100, GetSubCatLabel(i));
			tempBuf.Append(tempBuf2);
@


1.251
log
@Minor fix on WebServer
@
text
@d21 1
a21 1
#define WEB_SERVER_TEMPLATES_VERSION	1002
d39 1
a39 1
static bool	WSsharedColumnHidden[6];
d3170 2
d3274 5
d3414 12
d3450 1
d3454 2
d3461 1
a3461 1
		if(cur_file->IsPartFile())
a3473 1

d3480 23
a3503 1
		dFile.sFileHash = HashToString(cur_file->GetFileHash());
d3580 3
d3748 4
@


1.250
log
@Improved string processing
@
text
@a2194 1
			//DonGato: update priorities on Auto files
a2197 2
			bool bIsComplete = false;

d2210 1
d2212 1
d2220 1
a2236 1
					bIsComplete = true;
a2238 1
					if(!bIsComplete)
a2241 1
					if(!bIsComplete)
d2247 1
a2249 1

a2251 1

d2259 2
a2576 2
		bool bIsComplete = false;

d2596 1
a2596 1
		if (FilesArray[i].bCompress && !bIsComplete)
d2599 1
a2599 1
		if (g_eMuleApp.m_pDownloadQueue->GetA4AFAutoFile() == found_file && !bIsComplete)
d2636 1
a2636 1
		if (FilesArray[i].bCompress && !bIsComplete)
d2643 1
a2643 1
		if (g_eMuleApp.m_pDownloadQueue->GetA4AFAutoFile() == found_file && !bIsComplete)
@


1.249
log
@Improved string processing
@
text
@d101 2
a102 1
			sAll += sLine + _T("\n");
d561 1
a561 1
				AddLogLine(true, RGB_LOG_NOTICE + GetResString(IDS_WEB_SHUTDOWN) + _T(" ") + GetResString(IDS_FAILED));
d580 1
a580 1
				AddLogLine(true, RGB_LOG_NOTICE + GetResString(IDS_WEB_REBOOT) + _T(" ") + GetResString(IDS_FAILED));
d4589 1
a4589 1
	CString result=pThis->m_Templates.sSearchHeader + g_eMuleApp.m_pSearchList->GetWebList(pThis->m_Templates.sSearchResultLine,pThis->m_iSearchSortby,pThis->m_bSearchAsc,!WSsearchColumnHidden[0],!WSsearchColumnHidden[1],!WSsearchColumnHidden[2],!WSsearchColumnHidden[3],!WSsearchColumnHidden[4]);
d4591 1
d4598 2
a4599 2
	Out.Replace(_T("[RESULTLIST]"), result);
	Out.Replace(_T("[Result]"), GetResString(IDS_SW_RESULT) );
@


1.248
log
@pointer check
@
text
@d668 1
a668 1
		int pos=URL.MakeLower().Find(fieldname.MakeLower() + _T("="));
d673 2
a674 1
			res.Append(temp + _T("|"));
d698 1
a698 1
	if (URL.Find(_T("?")) > -1)
d700 1
a700 1
		Parameter = URL.Mid(URL.Find(_T("?"))+1, URL.GetLength()-URL.Find(_T("?"))-1);
d703 1
a703 1
		if (Parameter.Find(fieldname + _T("=")) == 0)
d708 1
a708 1
		if (Parameter.Find(_T("&") + fieldname + _T("=")) > -1)
d710 1
a710 1
			findPos = Parameter.Find(_T("&") + fieldname + _T("="));
d716 2
a717 2
			if (Parameter.Find(_T("&")) > -1)
				Parameter = Parameter.Mid(0, Parameter.Find(_T("&")));
d722 1
a722 1
			value.Replace(_T("+"), _T(" "));
d4880 1
a4880 1
	sPlain.Replace(_T("&"), _T(""));
@


1.247
log
@improved fakelist download, and added fakes.rar file support
@
text
@d2177 2
a2178 1
			vecPartFiles.push_back(pPartFile);
@


1.246
log
@Fix to my changes
@
text
@d2267 1
a2267 1
			dFile.sFakeCheck = g_eMuleApp.m_pFakeCheck->IsFake(HashToString(pPartFile->GetFileHash()),pPartFile->GetFileSize());
@


1.245
log
@formatting;
removed duplicate code for Starting a Search and Creates ED2KLinks;
first few changes in both code and gui to implement the new search method (ED2KProtocol), don't worry :)
@
text
@d4408 1
a4408 1
CString CWebServer::_GetDownloadGraph(ThreadData Data,CString filehash)
d4418 1
a4418 1
	DecodeBase16(filehash.GetBuffer(),filehash.GetLength(),fileid);
d4426 1
a4426 1
	if (pPartFile->GetStatus() == PS_PAUSED || pPartFile->GetStatus() == PS_STOPPED)
d4459 1
a4459 1
	if (pPartFile == 0 || !pPartFile->IsPartFile())
@


1.244
log
@Minor change for dimmed progress bar in WebServer
@
text
@d4424 1
a4424 1
	pPartFile=g_eMuleApp.m_pDownloadQueue->GetFileByID(fileid);
@


1.243
log
@Added paused/stopped dimmed progress bar for WebServer
@
text
@d4439 1
a4439 1
		progresscolor[10]=_T("greenpercent.gif");
@


1.242
log
@formatting;
minor change in LanCast preferences loading;
changed the SearchDlg code to not duplicate the code
@
text
@d4416 1
a4416 1
	CPartFile* cur_file;
d4422 1
d4424 1
a4424 16
	// cool style
	CString progresscolor[12];	//Ju1i3n - merged with eMulePlus by janes bong
	progresscolor[0]=_T("green.gif");
	progresscolor[1]=_T("black.gif");
	progresscolor[2]=_T("yellow.gif");
	progresscolor[3]=_T("red.gif");
	//Ju1i3n start - merged with eMulePlus by janes bong
	progresscolor[4]=_T("blue1.gif");
	progresscolor[5]=_T("blue2.gif");
	progresscolor[6]=_T("blue3.gif");
	progresscolor[7]=_T("blue4.gif");
	progresscolor[8]=_T("blue5.gif");
	progresscolor[9]=_T("blue6.gif");
	progresscolor[10]=_T("greenpercent.gif");
	progresscolor[11]=_T("transparent.gif");
	//Ju1i3n end
d4426 34
a4459 2
	cur_file=g_eMuleApp.m_pDownloadQueue->GetFileByID(fileid);
	if (cur_file == 0 || !cur_file->IsPartFile())
d4468 1
a4468 1
		CString s_ChunkBar=cur_file->GetProgressString(pThis->m_Templates.iProgressbarWidth);
d4490 1
a4490 1
		int		compl = static_cast<int>((pThis->m_Templates.iProgressbarWidth / 100.0) * cur_file->GetPercentCompleted());
@


1.241
log
@Improved hash to string conversion
@
text
@d4537 3
a4539 1
			_tstoi(_ParseURL(Data.sURL, _T("avail"))),
d4541 2
a4542 1
			(_ParseURL(Data.sURL, _T("global"))=="on")
@


1.240
log
@Improved hash to string conversion
@
text
@d2255 1
a2255 1
			dFile.sFileHash = EncodeBase16(pPartFile->GetFileHash(), 16);
d2267 1
a2267 1
			dFile.sFakeCheck = g_eMuleApp.m_pFakeCheck->IsFake(EncodeBase16(pPartFile->GetFileHash(), 16),pPartFile->GetFileSize());
d3461 1
a3461 1
		dFile.sFileHash = EncodeBase16(cur_file->GetFileHash(), 16);
@


1.239
log
@Changed uint32 to unsigned long from unsigned int and made necessary code changes. Got rid of _unsigned_ types int8,int16,int32,int64. Eliminated uint8 to avoid confusion. Use "byte".
@
text
@d2340 1
a2340 1
		dUser.sUserHash = FileHashToString(cur_client->GetUserHash());
d2495 1
a2495 1
		dUser.sUserHash = FileHashToString(cur_client->GetUserHash());
@


1.238
log
@few changes and formatting + corrected a previous change that is not working
@
text
@d472 1
a472 1
		t_ulCurIP.Format(_T("%i.%i.%i.%i"),(uint8)pThis->m_ulCurIP,(uint8)(pThis->m_ulCurIP>>8),(uint8)(pThis->m_ulCurIP>>16),(uint8)(pThis->m_ulCurIP>>24));
d1590 1
a1590 1
	uint8		cat = atoi(_ParseURL(Data.sURL,"cat"));
d1753 1
a1753 1
					uint8 iCatIndex = CCat::UserCatIndexToCatIndex(iMenu);
d4278 1
a4278 1
			t_ulCurIP.Format(_T("%i.%i.%i.%i"),(uint8)pThis->m_ulCurIP,(uint8)(pThis->m_ulCurIP>>8),(uint8)(pThis->m_ulCurIP>>16),(uint8)(pThis->m_ulCurIP>>24));
d4453 1
a4453 1
		uint8 lastcolor=1;
d4499 1
a4499 1
		uint8 cat=atoi(_ParseURL(Data.sURL, "cat"));
d4851 1
a4851 1
CString CWebServer::GetSubCatLabel(uint8 iCat)
@


1.237
log
@removed MOBILE_MULE and JUMPSTART defines + minor improvements (thx aw3)
@
text
@d4441 1
a4441 1
	if (cur_file==0 || !cur_file->IsPartFile())
@


1.236
log
@upload auto priority sets very well spread files to low prio + minor changes + cleanup
@
text
@a3485 1
#if JUMPSTART
a3490 1
#endif
@


1.235
log
@added color to the WebServer logs
@
text
@d3214 1
a3214 1
				cur_file->SetPriority(PR_VERYHIGH);
d3464 3
a3466 1
			if (cur_file->GetPriority() == PR_NORMAL)
d3470 1
a3470 1
			else if (cur_file->GetPriority() == PR_VERYHIGH)
d3484 1
a3484 1
			else if (cur_file->GetPriority() == PR_VERYHIGH)
d3606 1
a3606 1
			case PR_VERYHIGH:
d3635 1
a3635 1
		else if (cur_file->GetPriority() == PR_VERYHIGH)
@


1.234
log
@Minor change on reverse sorting (WS)
@
text
@d3891 1
a3891 1
	Out.Replace(_T("[Log]"), _SpecialChars(g_eMuleApp.m_pdlgEmule->m_wndServer.logbox->GetText())+"<br><a name=\"end\"></a>" );
d3920 1
a3920 1
	Out.Replace(_T("[ServerInfo]"), _SpecialChars(g_eMuleApp.m_pdlgEmule->m_wndServer.m_pctlServerMsgBox->GetText()));
d3949 1
a3949 1
	Out.Replace(_T("[DebugLog]"), _SpecialChars(g_eMuleApp.m_pdlgEmule->m_wndServer.debugbox->GetText())+"<br><a name=\"end\"></a>" );
@


1.233
log
@Minor updates (domain change)
@
text
@d1822 2
a1823 2
	sSort.SetString(_ParseURL(Data.sURL, _T("sortreverse")));
	if (sSort.IsEmpty())
d1831 6
a1836 3
		pThis->m_Params.bDownloadSortReverse = (sSort.CompareNoCase(_T("true")) == 0);
		pThis->m_Params.bUploadSortReverse = (sSort.CompareNoCase(_T("true")) == 0);
		pThis->m_Params.bQueueSortReverse = (sSort.CompareNoCase(_T("true")) == 0);
@


1.232
log
@Colored some log lines
@
text
@d783 1
a783 1
	strVersionCheck.Format(_T("http://emuleplus.sourceforge.net/version_check.php?version=%i&language=%i"),CURRENT_PLUS_VERSION,g_eMuleApp.m_pGlobPrefs->GetLanguageID());
@


1.231
log
@More Kush changes for localization, minor optimizations and fix for Upload AutoPriority.
@
text
@d464 1
a464 1
		AddLogLine(true, IDS_WEB_INTRBLOCKEND);
d497 1
a497 1
				AddLogLine(true, IDS_WEB_INTRTRIESLEFT, t_ulCurIP, g_eMuleApp.m_pGlobPrefs->GetWSLoginAttemptsAllowed()-(pThis->m_nIntruderDetect));
d500 1
a500 1
					AddLogLine(true, IDS_WEB_INTRDETECTION, pThis->m_nIntruderDetect);
d505 1
a505 1
					pThis->AddLogLine(true, IDS_WEB_INTRBLOCKTIME, g_eMuleApp.m_pGlobPrefs->GetWSTempDisableLogin());
d517 1
a517 1
					AddLogLine(true, IDS_WEB_INTRWEBDISABLE);
@


1.230
log
@Fixed clear non visible log via WebServer
@
text
@d112 2
a113 2
				StopSockets(); 
            m_bServerWorking = false; 
d157 2
a158 2
			m_Templates.sSearchHeader = _LoadTemplate(sAll,_T("TMPL_SEARCH_RESULT_HEADER"));			
			m_Templates.sSearchResultLine = _LoadTemplate(sAll,_T("TMPL_SEARCH_RESULT_LINE"));			
d161 1
a161 1
			m_Templates.sCatArrow= _LoadTemplate(sAll,"TMPL_CATARROW");			
d175 2
a176 2
			StopSockets(); 
            m_bServerWorking = false; 
d196 7
a202 7
	ini.GetArray(WSdownloadColumnHidden, ELEMENT_COUNT(WSdownloadColumnHidden), _T("downloadColumnHidden"), _T("WebServer")); 
	ini.GetArray(WSuploadColumnHidden, ELEMENT_COUNT(WSuploadColumnHidden), _T("uploadColumnHidden"), _T("WebServer")); 
	ini.GetArray(WSqueueColumnHidden, ELEMENT_COUNT(WSqueueColumnHidden), _T("queueColumnHidden"), _T("WebServer")); 
	ini.GetArray(WSsearchColumnHidden, ELEMENT_COUNT(WSsearchColumnHidden), _T("searchColumnHidden"), _T("WebServer")); 
	ini.GetArray(WSsharedColumnHidden, ELEMENT_COUNT(WSsharedColumnHidden), _T("sharedColumnHidden"), _T("WebServer")); 
	ini.GetArray(WSserverColumnHidden, ELEMENT_COUNT(WSserverColumnHidden), _T("serverColumnHidden"), _T("WebServer")); 
	ini.SaveAndClose(); 
d215 1
a215 1
		if (nStart==-1) 
d228 1
a228 1
	if (m_bServerWorking)	
d240 1
a240 1
	if (m_bServerWorking) 
d243 1
a243 1
		StartSockets(this); 
d298 1
a298 1
	
d319 1
a319 1
	
d342 1
a342 1
CString CWebServer::_SpecialChars(CString str, bool noquote /*=false*/) 
d449 1
a449 1
	
d515 1
a515 1
		            pThis->m_bServerWorking = false; 
d533 1
a533 1
	if (_ParseURL(Data.sURL, _T("w")) == "logout") 
d546 1
a546 1
			HANDLE hToken; 
d550 4
a553 4
				if (!OpenProcessToken(GetCurrentProcess(), TOKEN_ADJUST_PRIVILEGES | TOKEN_QUERY, &hToken)) 
					throw; 
				LookupPrivilegeValue(NULL, SE_SHUTDOWN_NAME, &tkp.Privileges[0].Luid); 
				tkp.PrivilegeCount = 1;  // one privilege to set    
d555 1
a555 1
				AdjustTokenPrivileges(hToken, FALSE, &tkp, 0, (PTOKEN_PRIVILEGES)NULL, 0); 
d565 1
a565 1
			HANDLE hToken; 
d569 4
a572 4
				if (!OpenProcessToken(GetCurrentProcess(), TOKEN_ADJUST_PRIVILEGES | TOKEN_QUERY, &hToken)) 
					throw; 
				LookupPrivilegeValue(NULL, SE_SHUTDOWN_NAME, &tkp.Privileges[0].Luid); 
				tkp.PrivilegeCount = 1;  // one privilege to set    
d574 1
a574 1
				AdjustTokenPrivileges(hToken, FALSE, &tkp, 0, (PTOKEN_PRIVILEGES)NULL, 0); 
d585 1
a585 1
		if (sPage == "server") 
d587 1
a587 1
		else if (sPage == "shared") 
d589 1
a589 1
		else if (sPage == "transfer") 
d591 1
a591 1
		else if (sPage == "search") 
d595 1
a595 1
		else if (sPage == "log") 
d597 1
a597 1
		if (sPage == "sinfo") 
d599 1
a599 1
		if (sPage == "debuglog") 
d601 1
a601 1
		if (sPage == "stats") 
d603 1
a603 1
		if (sPage == "options") 
d640 1
a640 1
	else 
d717 1
a717 1
	
d867 1
a867 1
	{ 
d871 1
a871 1
	else if (g_eMuleApp.m_pServerConnect->IsConnected() && !disconnectissued) 
d877 2
a878 2
		CServer* cur_server = g_eMuleApp.m_pServerList->GetServerByAddress( 
			g_eMuleApp.m_pServerConnect->GetCurrentServer()->GetAddress(), 
d920 1
a920 1
		_stprintf(HTTPHeader, "%.1f", (static_cast<double>(g_eMuleApp.m_pUploadQueue->GetDataRate())/1024.0)/(g_eMuleApp.m_pGlobPrefs->GetMaxGraphUploadRate())*100.0); 
d922 1
a922 1
		_stprintf(HTTPHeader, "%.1f", (static_cast<double>(g_eMuleApp.m_pUploadQueue->GetDataRate())/1024.0)/(g_eMuleApp.m_pGlobPrefs->GetMaxUpload())*100.0); 
d933 1
a933 1
	_stprintf(HTTPHeader, "%.1f", (static_cast<double>(g_eMuleApp.m_pUploadQueue->GetDataRate())/1024.0)); 
d1006 2
a1007 2
	}	
	else if (bAdmin && sCmd.CompareNoCase(_T("disconnect")) == 0) 
d1018 2
a1019 2
	}	
	else if (bAdmin && sCmd.CompareNoCase(_T("remove")) == 0) 
d1023 2
a1024 2
	}	
	else if (bAdmin && sCmd.CollateNoCase(_T("addtostatic")) == 0) 
d1029 1
a1029 1
	else if (bAdmin && sCmd.CompareNoCase(_T("removefromstatic")) == 0) 
d1040 1
a1040 1
			if (g_eMuleApp.m_pdlgEmule->m_wndServer) 
d1050 1
a1050 1
			if (g_eMuleApp.m_pdlgEmule->m_wndServer) 
d1060 1
a1060 1
			if (g_eMuleApp.m_pdlgEmule->m_wndServer) 
d1064 1
a1064 1
	else if (sCmd.CompareNoCase(_T("menu")) == 0) 
d1073 2
a1074 2
		ini.SetArray(WSserverColumnHidden, ELEMENT_COUNT(WSserverColumnHidden), _T("serverColumnHidden"), _T("WebServer")); 
		ini.SaveAndClose(); 
d1077 1
a1077 1
	if (sSort != "") 
d1335 2
a1336 2
		{  
			temp = Entry.sServerIP.Tokenize(_T("."),counter); 
d1338 1
a1338 1
				newip.AppendFormat("00" + temp); 
d1340 1
a1340 1
				newip.AppendFormat("0" + temp); 
d1352 1
a1352 1
		{ 
d1361 4
a1364 4
			{  
				if (!g_eMuleApp.m_pServerConnect->IsLowID())  
					Entry.sServerState = "high";  
				else  
d1607 1
a1607 1
	if (bAdmin && !sClear.IsEmpty()) 
d1614 1
a1614 1
			 
d1637 1
a1637 1
	else 
d1642 1
a1642 1
	if (HTTPTemp.CompareNoCase(_T("menudown")) == 0) 
d1651 2
a1652 2
		ini.SetArray(WSdownloadColumnHidden, ELEMENT_COUNT(WSdownloadColumnHidden), _T("downloadColumnHidden"), _T("WebServer")); 
		ini.SaveAndClose(); 
d1654 1
a1654 1
	else if (HTTPTemp.CompareNoCase(_T("menuup")) == 0) 
d1663 2
a1664 2
		ini.SetArray(WSuploadColumnHidden, ELEMENT_COUNT(WSuploadColumnHidden), _T("uploadColumnHidden"), _T("WebServer")); 
		ini.SaveAndClose(); 
d1666 1
a1666 1
	else if (HTTPTemp.CompareNoCase(_T("menuqueue")) == 0) 
d1675 2
a1676 2
		ini.SetArray(WSqueueColumnHidden, ELEMENT_COUNT(WSqueueColumnHidden), _T("queueColumnHidden"), _T("WebServer")); 
		ini.SaveAndClose(); 
d1774 1
a1774 1
	if (!sSort.IsEmpty()) 
d1789 1
a1789 1
			pThis->m_Params.DownloadSort = DOWN_SORT_PROGRESS;		
d2156 1
a2156 1
	
d2170 1
a2170 1
		for (POSITION pos=g_eMuleApp.m_pDownloadQueue->m_partFileList.GetHeadPosition(); pos != 0; g_eMuleApp.m_pDownloadQueue->m_partFileList.GetNext(pos))
d2172 1
a2172 1
			CPartFile	*pPartFile = g_eMuleApp.m_pDownloadQueue->m_partFileList.GetAt(pos);
d2217 1
a2217 1
				case PS_HASHING: 
d2251 1
a2251 1
			dFile.sCategory = strCategory;			
d2332 1
a2332 1
	for (POSITION pos = g_eMuleApp.m_pUploadQueue->uploadinglist.GetHeadPosition(); pos != 0;g_eMuleApp.m_pUploadQueue->uploadinglist.GetNext(pos))
d2334 1
a2334 1
		CUpDownClient* cur_client = g_eMuleApp.m_pUploadQueue->uploadinglist.GetAt(pos);
d2386 1
a2386 1
		
d2438 1
a2438 1
	for (POSITION pos = g_eMuleApp.m_pUploadQueue->waitinglist.GetHeadPosition(); pos != 0;g_eMuleApp.m_pUploadQueue->waitinglist.GetNext(pos))
d2440 1
a2440 1
		CUpDownClient* cur_client = g_eMuleApp.m_pUploadQueue->waitinglist.GetAt(pos);
d2596 1
a2596 1
					
d2762 1
a2762 1
	
d2830 1
a2830 1
	if(pThis->m_Params.bShowUploadQueue) 
d2879 1
a2879 1
	if(pThis->m_Params.bShowUploadQueueBanned) 
d2928 1
a2928 1
	if(pThis->m_Params.bShowUploadQueueFriend) 
d2977 1
a2977 1
	if(pThis->m_Params.bShowUploadQueueCredit) 
d3146 1
a3146 1
	if (_ParseURL(Data.sURL, _T("sort")) != "") 
d3174 1
a3174 1
	if (_ParseURL(Data.sURL, _T("sortreverse")) != "") 
d3224 1
a3224 1
	if (sCmd.CompareNoCase(_T("menu")) == 0) 
d3233 2
a3234 2
		ini.SetArray(WSsharedColumnHidden, ELEMENT_COUNT(WSsharedColumnHidden), _T("sharedColumnHidden"), _T("WebServer")); 
		ini.SaveAndClose(); 
d3420 1
a3420 1
	CString OutE = pThis->m_Templates.sSharedLine; 
d3429 1
a3429 1
		
d3445 1
a3445 1
		if (g_eMuleApp.m_pServerConnect->IsConnected()) 
d3496 1
a3496 1
	
d3543 1
a3543 1
				}        
d3799 2
a3800 2
	if(_ParseURL(Data.sURL, _T("addserver")) == "true") 
	{ 
d3803 2
a3804 2
			g_eMuleApp.m_pdlgEmule->m_wndServer.AddServer(_ParseURL(Data.sURL, _T("serveraddr")),_ParseURL(Data.sURL, _T("serverport")),_ParseURL(Data.sURL, _T("servername"))); 
			CString resultlog = _SpecialChars(g_eMuleApp.m_pdlgEmule->m_strLogText); //Pick-up last line of the log 
d3813 1
a3813 1
			if (g_eMuleApp.m_pdlgEmule->m_wndServer) 
d3816 1
a3816 1
			if(_ParseURL(Data.sURL, _T("addtostatic")) == "true") 
d3818 1
a3818 1
				_AddToStatic(_ParseURL(Data.sURL, _T("serveraddr")),atoi(_ParseURL(Data.sURL, _T("serverport")))); 
d3820 1
a3820 1
				resultlog += _SpecialChars(g_eMuleApp.m_pdlgEmule->m_strLogText); //Pick-up last line of the log 
d3822 2
a3823 2
			resultlog = resultlog.TrimRight('\n'); 
			resultlog = resultlog.Mid(resultlog.ReverseFind('\n')); 
d3825 3
a3827 3
			if(_ParseURL(Data.sURL, _T("connectnow")) == "true") 
				_ConnectToServer(_ParseURL(Data.sURL, _T("serveraddr")),atoi(_ParseURL(Data.sURL, _T("serverport")))); 
		} 
d3830 1
a3830 1
	} 
d4062 1
a4062 1
	
d4170 1
a4170 1
{ 
d4338 1
a4338 1
	for (int i = 0; i < 16; i++) 
d4516 1
a4516 1
	
d4549 1
a4549 1
	if (sCmd.CompareNoCase(_T("menu")) == 0) 
d4558 2
a4559 2
		ini.SetArray(WSsearchColumnHidden, ELEMENT_COUNT(WSsearchColumnHidden), _T("searchColumnHidden"), _T("WebServer")); 
		ini.SaveAndClose(); 
d4561 1
a4561 1
	
d4742 1
a4742 1
	
d4770 6
a4775 6
		tempBuff2 = CString("<a href=&quot;/?ses=" + sSession + "&w=transfer&cat="); 
		tempBuff2+= strI; 
		tempBuff2+= CString("&quot;><div class=menuitems><img class=menuchecked"); 
		tempBuff2+= tempBuff3; 
		tempBuff2+= CString(">"); 
		CString		strCategory = (i < CCat::GetNumPredefinedCats()) ? CCat::GetPredefinedCatTitle(CCat::GetCatIDByIndex(i)) : CCat::GetCatByIndex(i)->GetTitle(); 
d4777 2
a4778 2
		tempBuff2+= strCategory; 
		tempBuff2+= CString("&nbsp;</div></a>"); 
d4794 1
a4794 1
			tempBuff2 = CString("<a href=&quot;/?ses=" + sSession + "&w=transfer&cat="); 
d4796 1
a4796 1
			tempBuff2+= CString("&quot;><div class=menuitems><img class=menuchecked"); 
d4831 2
a4832 2
		tempBuff2 = CString("<a href=&quot;/?ses=" + sSession + "&w=transfer[CatSel]&op=setcat&file=" + sFileHash + "&filecat="); 
		tempBuff2+= strI; 
d4839 2
a4840 2
		tempBuff2+= strCategory; 
		tempBuff2+= CString("&nbsp;</div></a>"); 
@


1.229
log
@WebServer: fixed some Javascript errors when using localizations
@
text
@d3882 1
d3884 3
d3911 1
d3913 3
d3940 5
a3944 1
				g_eMuleApp.m_pdlgEmule->m_wndServer.debugbox->Reset();
@


1.228
log
@Fixed log clear from WebServer + Some measurements in try to prevent log lines gaps
@
text
@d1172 2
a1173 2
		Out.Replace(_T("[ServernameH]"), _GetPlainResString(IDS_SL_SERVERNAME));
		Out.Replace(_T("[ServernameM]"), _GetPlainResString(IDS_SL_SERVERNAME));
d1179 1
a1179 1
		Out.Replace(_T("[ServernameM]"), _GetPlainResString(IDS_SL_SERVERNAME));
d1184 2
a1185 2
		Out.Replace(_T("[AddressH]"), _GetPlainResString(IDS_IP));
		Out.Replace(_T("[AddressM]"), _GetPlainResString(IDS_IP));
d1191 1
a1191 1
		Out.Replace(_T("[AddressM]"), _GetPlainResString(IDS_IP));
d1196 2
a1197 2
		Out.Replace(_T("[DescriptionH]"), _GetPlainResString(IDS_DESCRIPTION));
		Out.Replace(_T("[DescriptionM]"), _GetPlainResString(IDS_DESCRIPTION));
d1203 1
a1203 1
		Out.Replace(_T("[DescriptionM]"), _GetPlainResString(IDS_DESCRIPTION));
d1208 2
a1209 2
		Out.Replace(_T("[PingH]"), _GetPlainResString(IDS_PING));
		Out.Replace(_T("[PingM]"), _GetPlainResString(IDS_PING));
d1215 1
a1215 1
		Out.Replace(_T("[PingM]"), _GetPlainResString(IDS_PING));
d1220 2
a1221 2
		Out.Replace(_T("[UsersH]"), _GetPlainResString(IDS_UUSERS));
		Out.Replace(_T("[UsersM]"), _GetPlainResString(IDS_UUSERS));
d1227 1
a1227 1
		Out.Replace(_T("[UsersM]"), _GetPlainResString(IDS_UUSERS));
d1232 2
a1233 2
		Out.Replace(_T("[FilesH]"), _GetPlainResString(IDS_FILES));
		Out.Replace(_T("[FilesM]"), _GetPlainResString(IDS_FILES));
d1239 1
a1239 1
		Out.Replace(_T("[FilesM]"), _GetPlainResString(IDS_FILES));
d1244 2
a1245 2
		Out.Replace(_T("[PriorityH]"), _GetPlainResString(IDS_PRIORITY));
		Out.Replace(_T("[PriorityM]"), _GetPlainResString(IDS_PRIORITY));
d1251 1
a1251 1
		Out.Replace(_T("[PriorityM]"), _GetPlainResString(IDS_PRIORITY));
d1256 2
a1257 2
		Out.Replace(_T("[FailedH]"), _GetPlainResString(IDS_UFAILED));
		Out.Replace(_T("[FailedM]"), _GetPlainResString(IDS_UFAILED));
d1263 1
a1263 1
		Out.Replace(_T("[FailedM]"), _GetPlainResString(IDS_UFAILED));
d1268 2
a1269 2
		Out.Replace(_T("[LimitH]"), _GetPlainResString(IDS_SERVER_SOFTHARDLIMIT));
		Out.Replace(_T("[LimitM]"), _GetPlainResString(IDS_SERVER_SOFTHARDLIMIT));
d1275 1
a1275 1
		Out.Replace(_T("[LimitM]"), _GetPlainResString(IDS_SERVER_SOFTHARDLIMIT));
d1280 2
a1281 2
		Out.Replace(_T("[VersionH]"), _GetPlainResString(IDS_SERVER_VERSION));
		Out.Replace(_T("[VersionM]"), _GetPlainResString(IDS_SERVER_VERSION));
d1287 1
a1287 1
		Out.Replace(_T("[VersionM]"), _GetPlainResString(IDS_SERVER_VERSION));
d1966 2
a1967 2
		Out.Replace(_T("[DFilename]"), _GetPlainResString(IDS_DL_FILENAME));
		Out.Replace(_T("[DFilenameM]"), _GetPlainResString(IDS_DL_FILENAME));
d1973 1
a1973 1
		Out.Replace(_T("[DFilenameM]"), _GetPlainResString(IDS_DL_FILENAME));
d1979 2
a1980 2
		Out.Replace(_T("[DSize]"), _GetPlainResString(IDS_DL_SIZE));
		Out.Replace(_T("[DSizeM]"), _GetPlainResString(IDS_DL_SIZE));
d1986 1
a1986 1
		Out.Replace(_T("[DSizeM]"), _GetPlainResString(IDS_DL_SIZE));
d1992 2
a1993 2
		Out.Replace(_T("[DTransferred]"), _GetPlainResString(IDS_COMPLETE));
		Out.Replace(_T("[DTransferredM]"), _GetPlainResString(IDS_COMPLETE));
d1999 1
a1999 1
		Out.Replace(_T("[DTransferredM]"), _GetPlainResString(IDS_COMPLETE));
d2005 2
a2006 2
		Out.Replace(_T("[DProgress]"), _GetPlainResString(IDS_DL_PROGRESS));
		Out.Replace(_T("[DProgressM]"), _GetPlainResString(IDS_DL_PROGRESS));
d2012 1
a2012 1
		Out.Replace(_T("[DProgressM]"), _GetPlainResString(IDS_DL_PROGRESS));
d2018 2
a2019 2
		Out.Replace(_T("[DSpeed]"), _GetPlainResString(IDS_DL_SPEED));
		Out.Replace(_T("[DSpeedM]"), _GetPlainResString(IDS_DL_SPEED));
d2025 1
a2025 1
		Out.Replace(_T("[DSpeedM]"), _GetPlainResString(IDS_DL_SPEED));
d2031 2
a2032 2
		Out.Replace(_T("[DSources]"), _GetPlainResString(IDS_DL_SOURCES));
		Out.Replace(_T("[DSourcesM]"), _GetPlainResString(IDS_DL_SOURCES));
d2038 1
a2038 1
		Out.Replace(_T("[DSourcesM]"), _GetPlainResString(IDS_DL_SOURCES));
d2044 2
a2045 2
		Out.Replace(_T("[DPriority]"), _GetPlainResString(IDS_PRIORITY));
		Out.Replace(_T("[DPriorityM]"), _GetPlainResString(IDS_PRIORITY));
d2051 1
a2051 1
		Out.Replace(_T("[DPriorityM]"), _GetPlainResString(IDS_PRIORITY));
d2057 2
a2058 2
		Out.Replace(_T("[DCategory]"), _GetPlainResString(IDS_CAT));
		Out.Replace(_T("[DCategoryM]"), _GetPlainResString(IDS_CAT));
d2064 1
a2064 1
		Out.Replace(_T("[DCategoryM]"), _GetPlainResString(IDS_CAT));
d2070 2
a2071 2
		Out.Replace(_T("[DFakeCheck]"), _GetPlainResString(IDS_FAKE_CHECK_HEADER));
		Out.Replace(_T("[DFakeCheckM]"), _GetPlainResString(IDS_FAKE_CHECK_HEADER));
d2077 1
a2077 1
		Out.Replace(_T("[DFakeCheckM]"), _GetPlainResString(IDS_FAKE_CHECK_HEADER));
d2087 2
a2088 2
		Out.Replace(_T("[UUser]"), _GetPlainResString(IDS_QL_USERNAME));
		Out.Replace(_T("[UUserM]"), _GetPlainResString(IDS_QL_USERNAME));
d2094 1
a2094 1
		Out.Replace(_T("[UUserM]"), _GetPlainResString(IDS_QL_USERNAME));
d2100 2
a2101 2
		Out.Replace(_T("[UVersion]"), _GetPlainResString(IDS_INFLST_USER_CLIENTVERSION));
		Out.Replace(_T("[UVersionM]"), _GetPlainResString(IDS_INFLST_USER_CLIENTVERSION));
d2107 1
a2107 1
		Out.Replace(_T("[UVersionM]"), _GetPlainResString(IDS_INFLST_USER_CLIENTVERSION));
d2113 2
a2114 2
		Out.Replace(_T("[UFilename]"), _GetPlainResString(IDS_DL_FILENAME));
		Out.Replace(_T("[UFilenameM]"), _GetPlainResString(IDS_DL_FILENAME));
d2120 1
a2120 1
		Out.Replace(_T("[UFilenameM]"), _GetPlainResString(IDS_DL_FILENAME));
d2126 2
a2127 2
		Out.Replace(_T("[UTransferred]"), _GetPlainResString(IDS_DL_ULDL));
		Out.Replace(_T("[UTransferredM]"), _GetPlainResString(IDS_DL_ULDL));
d2133 1
a2133 1
		Out.Replace(_T("[UTransferredM]"), _GetPlainResString(IDS_DL_ULDL));
d2139 2
a2140 2
		Out.Replace(_T("[USpeed]"), _GetPlainResString(IDS_DL_SPEED));
		Out.Replace(_T("[USpeedM]"), _GetPlainResString(IDS_DL_SPEED));
d2146 1
a2146 1
		Out.Replace(_T("[USpeedM]"), _GetPlainResString(IDS_DL_SPEED));
d3049 4
a3052 4
	Out.Replace(_T("[ShowUploadQueueList]"), _GetPlainResString(IDS_WEB_SHOW_UPLOAD_QUEUE));
	Out.Replace(_T("[ShowUploadQueueListBanned]"), _GetPlainResString(IDS_WEB_SHOW_UPLOAD_QUEUE_BANNED));
	Out.Replace(_T("[ShowUploadQueueListFriend]"), _GetPlainResString(IDS_WEB_SHOW_UPLOAD_QUEUE_FRIEND));
	Out.Replace(_T("[ShowUploadQueueListCredit]"), _GetPlainResString(IDS_WEB_SHOW_UPLOAD_QUEUE_CREDIT));
d3081 2
a3082 2
		Out.Replace(_T("[UserNameTitle]"), _GetPlainResString(IDS_QL_USERNAME));
		Out.Replace(_T("[UserNameTitleM]"), _GetPlainResString(IDS_QL_USERNAME));
d3088 1
a3088 1
		Out.Replace(_T("[UserNameTitleM]"), _GetPlainResString(IDS_QL_USERNAME));
d3093 2
a3094 2
		Out.Replace(_T("[Version]"), _GetPlainResString(IDS_INFLST_USER_CLIENTVERSION));
		Out.Replace(_T("[VersionM]"), _GetPlainResString(IDS_INFLST_USER_CLIENTVERSION));
d3100 1
a3100 1
		Out.Replace(_T("[VersionM]"), _GetPlainResString(IDS_INFLST_USER_CLIENTVERSION));
d3105 2
a3106 2
		Out.Replace(_T("[FileNameTitle]"), _GetPlainResString(IDS_DL_FILENAME));
		Out.Replace(_T("[FileNameTitleM]"), _GetPlainResString(IDS_DL_FILENAME));
d3112 1
a3112 1
		Out.Replace(_T("[FileNameTitleM]"), _GetPlainResString(IDS_DL_FILENAME));
d3117 2
a3118 2
		Out.Replace(_T("[ScoreTitle]"), _GetPlainResString(IDS_SCORE));
		Out.Replace(_T("[ScoreTitleM]"), _GetPlainResString(IDS_SCORE));
d3124 1
a3124 1
		Out.Replace(_T("[ScoreTitleM]"), _GetPlainResString(IDS_SCORE));
d3346 2
a3347 2
		Out.Replace(_T("[Filename]"), _GetPlainResString(IDS_DL_FILENAME));
		Out.Replace(_T("[FilenameM]"), _GetPlainResString(IDS_DL_FILENAME));
d3353 1
a3353 1
		Out.Replace(_T("[FilenameM]"), _GetPlainResString(IDS_DL_FILENAME));
d3358 2
a3359 2
		Out.Replace(_T("[FileTransferred]"),  _GetPlainResString(IDS_SF_TRANSFERRED));
		Out.Replace(_T("[FileTransferredM]"),  _GetPlainResString(IDS_SF_TRANSFERRED));
d3365 1
a3365 1
		Out.Replace(_T("[FileTransferredM]"),  _GetPlainResString(IDS_SF_TRANSFERRED));
d3370 2
a3371 2
		Out.Replace(_T("[FileRequests]"),  _GetPlainResString(IDS_SF_REQUESTS));
		Out.Replace(_T("[FileRequestsM]"),  _GetPlainResString(IDS_SF_REQUESTS));
d3377 1
a3377 1
		Out.Replace(_T("[FileRequestsM]"),  _GetPlainResString(IDS_SF_REQUESTS));
d3382 2
a3383 2
		Out.Replace(_T("[FileAccepts]"),  _GetPlainResString(IDS_SF_ACCEPTS));
		Out.Replace(_T("[FileAcceptsM]"),  _GetPlainResString(IDS_SF_ACCEPTS));
d3389 1
a3389 1
		Out.Replace(_T("[FileAcceptsM]"),  _GetPlainResString(IDS_SF_ACCEPTS));
d3394 2
a3395 2
		Out.Replace(_T("[Size]"), _GetPlainResString(IDS_DL_SIZE));
		Out.Replace(_T("[SizeM]"), _GetPlainResString(IDS_DL_SIZE));
d3401 1
a3401 1
		Out.Replace(_T("[SizeM]"), _GetPlainResString(IDS_DL_SIZE));
d3406 2
a3407 2
		Out.Replace(_T("[Priority]"),  _GetPlainResString(IDS_PRIORITY));
		Out.Replace(_T("[PriorityM]"),  _GetPlainResString(IDS_PRIORITY));
d3413 1
a3413 1
		Out.Replace(_T("[PriorityM]"),  _GetPlainResString(IDS_PRIORITY));
@


1.227
log
@Added RGB_LOG_ERROR, RGB_LOG_WARNING, RGB_LOG_NOTICE, RGB_LOG_DIMMED & RGB_LOG_SUCCESS for easier changing of log colors
@
text
@d3882 1
a3882 1
		g_eMuleApp.m_pdlgEmule->m_wndServer.logbox->SetWindowText(_T(""));
d3907 1
a3907 1
		g_eMuleApp.m_pdlgEmule->m_wndServer.m_pctlServerMsgBox->SetWindowText(_T(""));
d3932 1
a3932 1
				g_eMuleApp.m_pdlgEmule->m_wndServer.debugbox->SetWindowText(_T(""));
@


1.226
log
@Changed to predefined colors  - thx DoubleT ;-)
@
text
@d110 1
a110 1
				AddLogLine(true,RGB_RED + GetResString(IDS_WS_ERR_LOADTEMPLATE), sFile);
d174 1
a174 1
			AddLogLine(true, RGB_RED + GetResString(IDS_WEB_ERR_CANTLOAD), sFile);
d214 1
a214 1
			AddLogLine(true, RGB_RED + GetResString(IDS_WS_ERR_LOADTEMPLATE), sTemplateName);
d216 1
a216 1
			AddDebugLogLine(false, RGB_RED + GetResString(IDS_WEB_ERR_CANTLOAD), sTemplateName);
d481 1
a481 1
			AddLogLine(true, RGB_PLUM + GetResString(IDS_WEB_ADMINLOGIN), t_ulCurIP);
d491 1
a491 1
			AddLogLine(true, RGB_PLUM + GetResString(IDS_WEB_GUESTLOGIN), t_ulCurIP);
d527 1
a527 1
			AddLogLine(true, RGB_VIOLET + GetResString(IDS_WEB_BADLOGINATTEMPT));
d560 1
a560 1
				AddLogLine(true, RGB_PLUM + GetResString(IDS_WEB_SHUTDOWN) + _T(" ") + GetResString(IDS_FAILED));
d579 1
a579 1
				AddLogLine(true, RGB_PLUM + GetResString(IDS_WEB_REBOOT) + _T(" ") + GetResString(IDS_FAILED));
d4264 1
a4264 1
			g_eMuleApp.m_pdlgEmule->AddLogLine(true, RGB_PLUM + GetResString(IDS_WEB_SESSIONEND),t_ulCurIP);
@


1.225
log
@Added some colors to the logs...
@
text
@d110 1
a110 1
				AddLogLine(true,_T("<COLOR=255,0,0>") + GetResString(IDS_WS_ERR_LOADTEMPLATE),sFile);
d174 1
a174 1
			AddLogLine(true,_T("<COLOR=255,0,0>") + GetResString(IDS_WEB_ERR_CANTLOAD), sFile);
d214 1
a214 1
			AddLogLine(true,_T("<COLOR=255,0,0>") + GetResString(IDS_WS_ERR_LOADTEMPLATE),sTemplateName);
d216 1
a216 1
			AddDebugLogLine(false,_T("<COLOR=255,0,0>") + GetResString(IDS_WEB_ERR_CANTLOAD),sTemplateName);
d252 1
a252 1
		AddLogLine(false,_T("%s: %s"),_GetPlainResString(IDS_PW_HTTPD), _GetPlainResString(IDS_ENABLED).MakeLower());
d254 1
a254 1
		AddLogLine(false,_T("%s: %s"),_GetPlainResString(IDS_PW_HTTPD), _GetPlainResString(IDS_DISABLED).MakeLower());
d464 1
a464 1
		AddLogLine(true,IDS_WEB_INTRBLOCKEND);
d481 1
a481 1
			AddLogLine(true,_T("<COLOR=153,51,102>") + GetResString(IDS_WEB_ADMINLOGIN),t_ulCurIP);
d491 1
a491 1
			AddLogLine(true,_T("<COLOR=153,51,102>") + GetResString(IDS_WEB_GUESTLOGIN),t_ulCurIP);
d497 1
a497 1
				AddLogLine(true,IDS_WEB_INTRTRIESLEFT,t_ulCurIP,g_eMuleApp.m_pGlobPrefs->GetWSLoginAttemptsAllowed()-(pThis->m_nIntruderDetect));
d500 1
a500 1
					AddLogLine(true,IDS_WEB_INTRDETECTION, pThis->m_nIntruderDetect);
d505 1
a505 1
					pThis->AddLogLine(true,IDS_WEB_INTRBLOCKTIME, g_eMuleApp.m_pGlobPrefs->GetWSTempDisableLogin());
d517 1
a517 1
					AddLogLine(true,IDS_WEB_INTRWEBDISABLE);
d527 1
a527 1
			AddLogLine(true,_T("<COLOR=128,0,128>") + GetResString(IDS_WEB_BADLOGINATTEMPT));
d560 1
a560 1
				AddLogLine(true,_T("<COLOR=153,51,102>") + GetResString(IDS_WEB_SHUTDOWN) + _T(" ") + GetResString(IDS_FAILED));
d579 1
a579 1
				AddLogLine(true,_T("<COLOR=153,51,102>") + GetResString(IDS_WEB_REBOOT) + _T(" ") + GetResString(IDS_FAILED));
d2543 1
a2543 1
	AddDebugLogLine(false,_T("WebServer: Waitingqueue with %u elements sorted in %u ms"), QueueArray.GetSize(), ::GetTickCount()-dwStart);
d4264 1
a4264 1
			g_eMuleApp.m_pdlgEmule->AddLogLine(true,_T("<COLOR=153,51,102>") + GetResString(IDS_WEB_SESSIONEND),t_ulCurIP);
@


1.224
log
@Changed fix for 255.255.255.255 server issue
@
text
@d110 1
a110 1
				AddLogLine(true,IDS_WS_ERR_LOADTEMPLATE,sFile);
d174 1
a174 1
			AddLogLine(true,IDS_WEB_ERR_CANTLOAD, sFile);
d214 1
a214 1
			AddLogLine(true,IDS_WS_ERR_LOADTEMPLATE,sTemplateName);
d216 1
a216 1
			AddDebugLogLine(false,IDS_WEB_ERR_CANTLOAD,sTemplateName);
d481 1
a481 1
			AddLogLine(true,IDS_WEB_ADMINLOGIN,t_ulCurIP);
d491 1
a491 1
			AddLogLine(true,IDS_WEB_GUESTLOGIN,t_ulCurIP);
d527 1
a527 1
			AddLogLine(true,IDS_WEB_BADLOGINATTEMPT);
d560 1
a560 1
				AddLogLine(true,IDS_WEB_SHUTDOWN+" "+IDS_FAILED);
d579 1
a579 1
				AddLogLine(true,IDS_WEB_REBOOT+" "+IDS_FAILED);
d4264 1
a4264 1
			g_eMuleApp.m_pdlgEmule->AddLogLine(true,IDS_WEB_SESSIONEND,t_ulCurIP);
@


1.223
log
@Log & Debug log scrollbars auto show + fixed IRC links click
@
text
@d877 4
a880 1
		CServer* cur_server = g_eMuleApp.m_pServerConnect->GetCurrentServer();
@


1.222
log
@bugfix: integer size of transferred bytes in webserver is too small for files over 2gb
@
text
@d3879 1
a3879 1
		g_eMuleApp.m_pdlgEmule->ResetLog();
d3881 1
a3881 1
	Out.Replace(_T("[Log]"), _SpecialChars(g_eMuleApp.m_pdlgEmule->GetAllLogEntries())+"<br><a name=\"end\"></a>" );
d3929 1
a3929 1
		g_eMuleApp.m_pdlgEmule->ResetDebugLog();
d3931 1
a3931 1
	Out.Replace(_T("[DebugLog]"), _SpecialChars(g_eMuleApp.m_pdlgEmule->GetAllDebugLogEntries())+"<br><a name=\"end\"></a>" );
@


1.221
log
@Correct localization of decimal point & thousands seperator + Correct encoding for Hebrew language in WebServer
@
text
@d2199 1
a2199 1
			dFile.lFileTransferred = pPartFile->GetCompletedSize();
d2295 1
a2295 1
				bSwap = FilesArray[i].lFileTransferred < FilesArray[i+1].lFileTransferred;
d2667 1
a2667 1
			if(FilesArray[i].lFileTransferred > 0)
d2669 2
a2670 2
				fTotalTransferred += FilesArray[i].lFileTransferred;
				HTTPProcessData.Replace(_T("[3]"), CastItoXBytes(FilesArray[i].lFileTransferred));
@


1.220
log
@some more formatting...
@
text
@d882 1
a882 1
		_stprintf(HTTPHeader, _T("%s"), CastItoIdots(cur_server->GetNumUsers()));
d884 1
a884 1
		_stprintf(HTTPHeader, _T("%s"), CastItoIdots(cur_server->GetMaxUsers()));
d886 1
a886 1
		_stprintf(HTTPHeader, _T("%s"), CastItoIdots(cur_server->GetFiles()));
d910 1
a910 1
	HTTPHelp.Format(_T("%s"), CastItoIdots(allUsers));
d912 1
a912 1
	HTTPHelp.Format(_T("%s"), CastItoIdots(allFiles));
d1522 1
a1522 1
					sT.Format(_T("%s (%s)"), CastItoIdots(ServerArray[i].nServerUsers), CastItoIdots(ServerArray[i].nServerMaxUsers));
d1524 1
a1524 1
					sT.Format(_T("%s"), CastItoIdots(ServerArray[i].nServerUsers));
d1534 1
a1534 1
				sT.Format(_T("%s"), CastItoIdots(ServerArray[i].nServerFiles));
d1552 2
a1553 2
			CString sSoftLimit; sSoftLimit.Format(_T("%s"), CastItoIdots(ServerArray[i].nServerSoftLimit));
			CString sHardLimit; sHardLimit.Format(_T("%s"), CastItoIdots(ServerArray[i].nServerHardLimit));
d3767 2
a3768 2
	s1.Format(_T("%d"), g_eMuleApp.m_pGlobPrefs->GetMaxGraphDownloadRate() + 4);
	s2.Format(_T("%d"), g_eMuleApp.m_pGlobPrefs->GetMaxGraphUploadRate() + 4);
d4373 1
a4373 1
		case MAKELANGID(LANG_HEBREW,SUBLANG_DEFAULT):				return _T("ISO-8859-8");
@


1.219
log
@Formatting and cleanup
@
text
@d225 2
a226 1
void CWebServer::RestartServer() {	//Cax2 - restarts the server with the new port settings
d372 2
a373 1
void CWebServer::ProcessImgFileReq(ThreadData Data) {
d498 2
a499 1
				if (pThis->m_nIntruderDetect == g_eMuleApp.m_pGlobPrefs->GetWSLoginAttemptsAllowed()){
a526 2
		{

a527 1
		}
a715 1
			{
a716 1
			}
a1412 1
			{
a1413 1
			}
a1743 1
			{
a1744 1
			}
a1763 1
			{
a1764 1
			}
a2316 1
			{
a2317 1
			}
a3552 1
			{
a3553 1
			}
a3878 1
	{
a3879 1
	}
a3903 1
	{
a3904 1
	}
a3928 1
	{
a3929 1
	}
a3981 1
	    {
a3982 1
	    }
a3983 1
	    {
a3984 1
	    }
a3985 1
	    {
a3986 1
	    }
a3987 1
	    {
a3988 1
	    }
a3989 1
	    {
a3990 1
	    }
a3991 1
	    {
a3992 1
	    }
a3993 1
	    {
a3994 1
	    }
a4012 1
	    {
a4013 1
	    }
a4014 1
	    {
a4015 1
	    }
a4017 1
		{
a4018 1
		}
a4019 1
		{
a4020 1
		}
a4021 1
		{
a4022 1
		}
@


1.218
log
@minor change on bugfix for #0000457
@
text
@d88 2
a89 1
	else sFile=g_eMuleApp.m_pGlobPrefs->GetTemplate();
d210 3
a212 1
	} else	{
d246 3
a248 1
	} else StopSockets();
d382 12
a393 6
	else if (filename.Right(4).MakeLower()==".jpg"  || filename.Right(5).MakeLower()==".jpeg") contenttype="Content-Type: image/jpg\r\n";
	else if (filename.Right(4).MakeLower()==".bmp") contenttype="Content-Type: image/bmp\r\n";
	else if (filename.Right(4).MakeLower()==".png") contenttype="Content-Type: image/png\r\n";
	else if (filename.Right(4).MakeLower()==".ico") contenttype="Content-Type: image/x-icon\r\n";
	else if (filename.Right(4).MakeLower()==".css") contenttype="Content-Type: text/css\r\n";
	else if (filename.Right(3).MakeLower()==".js") contenttype="Content-Type: text/javascript\r\n";
d440 1
a440 1
	EMULE_TRY	//(0.29b)
a456 1
	//Added by Johnny-B -IntruderDetection
a463 1
	//End Johnny-B
d469 2
a470 2
		CString t_ulCurIP;//log intruder
		t_ulCurIP.Format(_T("%i.%i.%i.%i"),(uint8)pThis->m_ulCurIP,(uint8)(pThis->m_ulCurIP>>8),(uint8)(pThis->m_ulCurIP>>16),(uint8)(pThis->m_ulCurIP>>24));//log intruder
d491 2
a492 1
		} else if(g_eMuleApp.m_pGlobPrefs->IsWSIntruderDetectionEnabled())
a503 1
					// DonGato - Sending message for WebServer intrussion (Login temporally disabled)
d508 3
a510 1
				} else {
a515 1
					// Purity - Sending message for WebServer intrussion (WebServer disabled)
d522 4
a525 1
		}else{//End Johnny-B -IntruderDetection
d528 1
a528 1
		isUseGzip = false; // [Julien]
a585 1
		{
d587 1
a587 4
		}
		else
		if (sPage == "shared") 
		{ 
d589 1
a589 4
		}
		else
		if (sPage == "transfer") 
		{
d591 1
a591 4
		}
		else
		if (sPage == "search") 
		{
d593 1
a593 4
		}
		else
		if (sPage == "graphs")
		{
d595 1
a595 4
		}
		else
		if (sPage == "log") 
		{
a596 1
		}
a597 1
		{
a598 1
		}
a599 1
		{
a600 1
		}
a601 1
		{
a602 1
		}
a647 1
	{
a648 1
	}
a649 1
	{
a650 1
	}
d660 2
a661 1
CString CWebServer::_ParseURLArray(CString URL, CString fieldname) {
d666 2
a667 1
	while (URL.GetLength()>0) {
d669 2
a670 1
		if (pos>-1) {
d675 3
a677 1
		} else break;
d697 2
a698 1
	if (URL.Find(_T("?")) > -1) {
d702 2
a703 1
		if (Parameter.Find(fieldname + _T("=")) == 0) {
d707 2
a708 1
		if (Parameter.Find(_T("&") + fieldname + _T("=")) > -1) {
d712 2
a713 1
		if (findPos > -1) {
d715 2
a716 1
			if (Parameter.Find(_T("&")) > -1) {
d724 2
a725 1
			for (i = 0 ; i <= 255 ; i++) {
d784 1
a784 1
	CString strVersionCheck; //Purity: eMulePlus Version Check
d818 3
a820 1
	if (CCat::GetNumCats()>1) InsertCatBox(Out,0,pThis->m_Templates.sCatArrow,false,false,sSession,""); else Out.Replace("[CATBOX]","");
d828 1
a828 1
	Out.Replace(_T("[AUTOA4AF]"), _GetPlainResString(IDS_ALL_A4AF_TO_HERE, true) + " (" + _GetPlainResString(IDS_PRIOAUTO, true) + ")"); // Purity: Auto-A4AF
d868 2
a869 1
	if ((g_eMuleApp.m_pServerConnect->IsConnecting() && !disconnectissued) || connectissued) { 
d896 2
a897 1
	} else
d1033 1
a1033 1
	else if (bAdmin && sCmd.CompareNoCase(_T("priolow")) == 0) //DonGato: priority change
d1043 1
a1043 1
	else if (bAdmin && sCmd.CompareNoCase(_T("prionormal")) == 0) //DonGato: priority change
d1053 1
a1053 1
	else if (bAdmin && sCmd.CompareNoCase(_T("priohigh")) == 0) //DonGato: priority change
d1080 1
a1080 2
		else
		if(sSort == "name")
d1082 1
a1082 2
		else
		if(sSort == "ip")
d1084 1
a1084 2
		else
		if(sSort == "description")
d1086 1
a1086 2
		else
		if(sSort == "ping")
d1088 1
a1088 2
		else
		if(sSort == "users")
d1090 1
a1090 2
		else
		if(sSort == "files")
d1092 1
a1092 2
		else
		if(sSort == "priority")
d1094 1
a1094 2
		else
		if(sSort == "failed")
d1096 1
a1096 2
		else
		if(sSort == "limit")
d1098 1
a1098 2
		else
		if(sSort == "version")
d1102 1
a1102 1
	if (sSort.IsEmpty()) {
d1104 1
a1104 1
	} else {
a1105 1
	}
d1163 4
a1166 2
	if (pThis->m_Params.bServerSortReverse) strSortIcon=pThis->m_Templates.sUpArrow;
		else strSortIcon=pThis->m_Templates.sDownArrow;
d1168 2
a1169 1
	if (!WSserverColumnHidden[0]){
d1172 4
a1175 2
		Out.Replace(_T("[ServernameM]"), _GetPlainResString(IDS_SL_SERVERNAME)); }
	else {
d1178 4
a1181 2
		Out.Replace(_T("[ServernameM]"), _GetPlainResString(IDS_SL_SERVERNAME)); }
	if (!WSserverColumnHidden[1]) {
d1184 4
a1187 2
		Out.Replace(_T("[AddressM]"), _GetPlainResString(IDS_IP)); }
	else {
d1190 4
a1193 2
		Out.Replace(_T("[AddressM]"), _GetPlainResString(IDS_IP)); }
	if (!WSserverColumnHidden[2]) {
d1196 4
a1199 2
		Out.Replace(_T("[DescriptionM]"), _GetPlainResString(IDS_DESCRIPTION)); }
	else {
d1202 4
a1205 2
		Out.Replace(_T("[DescriptionM]"), _GetPlainResString(IDS_DESCRIPTION)); }
	if (!WSserverColumnHidden[3]) {
d1208 4
a1211 2
		Out.Replace(_T("[PingM]"), _GetPlainResString(IDS_PING)); }
	else {
d1214 4
a1217 2
		Out.Replace(_T("[PingM]"), _GetPlainResString(IDS_PING)); }
	if (!WSserverColumnHidden[4]) {
d1220 4
a1223 2
		Out.Replace(_T("[UsersM]"), _GetPlainResString(IDS_UUSERS)); }
	else {
d1226 4
a1229 2
		Out.Replace(_T("[UsersM]"), _GetPlainResString(IDS_UUSERS)); }
	if (!WSserverColumnHidden[5]) {
d1232 4
a1235 2
		Out.Replace(_T("[FilesM]"), _GetPlainResString(IDS_FILES)); }
	else {
d1238 4
a1241 2
		Out.Replace(_T("[FilesM]"), _GetPlainResString(IDS_FILES)); }
	if (!WSserverColumnHidden[6]) {
d1244 4
a1247 2
		Out.Replace(_T("[PriorityM]"), _GetPlainResString(IDS_PRIORITY)); }
	else {
d1250 4
a1253 2
		Out.Replace(_T("[PriorityM]"), _GetPlainResString(IDS_PRIORITY)); }
	if (!WSserverColumnHidden[7]) {
d1256 4
a1259 2
		Out.Replace(_T("[FailedM]"), _GetPlainResString(IDS_UFAILED)); }
	else {
d1262 4
a1265 2
		Out.Replace(_T("[FailedM]"), _GetPlainResString(IDS_UFAILED)); }
	if (!WSserverColumnHidden[8]) {
d1268 4
a1271 2
		Out.Replace(_T("[LimitM]"), _GetPlainResString(IDS_SERVER_SOFTHARDLIMIT)); }
	else {
d1274 4
a1277 2
		Out.Replace(_T("[LimitM]"), _GetPlainResString(IDS_SERVER_SOFTHARDLIMIT)); }
	if (!WSserverColumnHidden[9]) {
d1280 4
a1283 2
		Out.Replace(_T("[VersionM]"), _GetPlainResString(IDS_SERVER_VERSION)); }
	else {
d1286 2
a1287 1
		Out.Replace(_T("[VersionM]"), _GetPlainResString(IDS_SERVER_VERSION)); }
d1310 3
a1312 2
		Entry.bServerStatic = cur_file->IsStaticMember();	// Purity (Add Remove from Static Server List in WebServer)
		if(cur_file->GetPreferences()== CServer::SERVERPRIORITY_HIGH) {
d1315 3
a1317 1
		} else if(cur_file->GetPreferences()== CServer::SERVERPRIORITY_NORMAL) {
d1320 3
a1322 1
		} else if(cur_file->GetPreferences()== CServer::SERVERPRIORITY_LOW) {
d1333 2
a1334 1
		for(int j=0; j<4; j++) {  
d1336 6
a1341 3
			if (temp.GetLength() == 1) newip.AppendFormat("00" + temp); 
			else if (temp.GetLength() == 2) newip.AppendFormat("0" + temp); 
			else if (temp.GetLength() == 3) newip.AppendFormat("" + temp);
d1350 2
a1351 1
		if (g_eMuleApp.m_pServerConnect->IsConnecting()) { 
d1356 2
a1357 1
		else if (g_eMuleApp.m_pServerConnect->IsConnected()) {
d1366 1
a1366 1
		} // end IsConnected
a1457 1
		// DonGato: static server showing
a1465 1
		//DonGato: priority change
d1488 2
a1489 1
		if (!WSserverColumnHidden[0]) {
d1494 2
a1495 1
		} else
d1497 2
a1498 1
		if (!WSserverColumnHidden[1]) {
d1501 2
a1502 1
		} else
d1504 2
a1505 1
		if (!WSserverColumnHidden[2]) {
d1510 2
a1511 1
		} else
d1513 2
a1514 1
		if (!WSserverColumnHidden[3]) {
d1517 2
a1518 1
		} else
d1521 2
a1522 1
		if (!WSserverColumnHidden[4]) {
d1531 2
a1532 1
		} else
d1535 2
a1536 1
		if (!WSserverColumnHidden[5]) {
d1540 2
a1541 1
		} else
d1547 2
a1548 1
		if (!WSserverColumnHidden[7]) {
d1551 2
a1552 1
		} else
d1554 2
a1555 1
		if (!WSserverColumnHidden[8]) {
d1559 2
a1560 1
		} else
d1562 2
a1563 1
		if (!WSserverColumnHidden[9]) {
d1568 2
a1569 1
		} else
d1623 1
a1623 1
			if (_GetFileHash(sClear, pFileHash))	//failsafe
d1639 1
a1639 1
		HTTPTemp.Empty();	//free for reusing
d1679 1
a1679 1
	else if (HTTPTemp.CompareNoCase(_T("menuprio")) == 0) //DonGato: category priority change
d1713 1
a1713 2
			if(bAdmin && sOp.CompareNoCase(_T("a4af")) == 0) // DonGato: added A4AF action
			{
a1714 1
			}
d1716 1
a1716 3
			{
				g_eMuleApp.m_pDownloadQueue->SetA4AFAutoFile(found_file); // Purity: Auto-A4AF
			}
d1718 1
a1718 3
			{
				g_eMuleApp.m_pDownloadQueue->SetA4AFAutoFile(NULL); // Purity: Auto-A4AF
			}
a1719 1
			{
a1720 1
			}
a1721 1
			{
a1722 1
			}
a1723 1
			{
a1724 1
			}
a1725 1
			{
d1727 1
a1727 2
			}
			else if(bAdmin && sOp.CompareNoCase(_T("priolow")) == 0) //DonGato: priority change
d1732 1
a1732 1
			else if(bAdmin && sOp.CompareNoCase(_T("prionormal")) == 0) //DonGato: priority change
d1737 1
a1737 1
			else if(bAdmin && sOp.CompareNoCase(_T("priohigh")) == 0) //DonGato: priority change
d1742 1
a1742 1
			else if(bAdmin && sOp.CompareNoCase(_T("prioauto")) == 0) //DonGato: priority change
d1747 1
a1747 1
			else if(bAdmin && sOp.CompareNoCase(_T("compressed")) == 0) // Purity: DropSCB
d1751 1
a1751 1
			else if(bAdmin && sOp.CompareNoCase(_T("setcat")) == 0) // Purity: Change file category
a1759 1
				{
a1760 1
				}
a1773 1
			{
a1774 1
			}
d1783 1
a1783 2
		else
		if(sSort.CompareNoCase(_T("dtype")) == 0)
d1785 1
a1785 2
		else
		if(sSort.CompareNoCase(_T("dname")) == 0)
d1787 1
a1787 2
		else
		if(sSort.CompareNoCase(_T("dsize")) == 0)
d1789 1
a1789 2
		else
		if(sSort.CompareNoCase(_T("dtransferred")) == 0)
d1791 1
a1791 2
		else
		if(sSort.CompareNoCase(_T("dspeed")) == 0)
d1793 1
a1793 2
		else
		if(sSort.CompareNoCase(_T("dprogress")) == 0)
d1795 1
a1795 2
		else
		if(sSort.CompareNoCase(_T("dsources")) == 0)
d1797 1
a1797 2
		else
		if(sSort.CompareNoCase(_T("dpriority")) == 0)
d1799 1
a1799 2
		else
		if(sSort.CompareNoCase(_T("dcategory")) == 0)
d1801 1
a1801 2
		else
		if(sSort.CompareNoCase(_T("dfakecheck")) == 0)
d1803 1
a1803 2
		else
		if(sSort.CompareNoCase(_T("uuser")) == 0)
d1805 1
a1805 2
		else
		if(sSort.CompareNoCase(_T("uclient")) == 0)
d1807 1
a1807 2
		else
		if(sSort.CompareNoCase(_T("uversion")) == 0)
d1809 1
a1809 2
		else
		if(sSort.CompareNoCase(_T("ufilename")) == 0)
d1811 1
a1811 2
		else
		if(sSort.CompareNoCase(_T("utransferred")) == 0)
d1813 1
a1813 2
		else
		if(sSort.CompareNoCase(_T("uspeed")) == 0)
d1815 1
a1815 2
		else
		if(sSort.CompareNoCase(_T("qclient")) == 0)
d1817 1
a1817 2
		else
		if(sSort.CompareNoCase(_T("quser")) == 0)
d1819 1
a1819 2
		else
		if(sSort.CompareNoCase(_T("qversion")) == 0)
d1821 1
a1821 2
		else
		if(sSort.CompareNoCase(_T("qfilename")) == 0)
d1823 1
a1823 2
		else
		if(sSort.CompareNoCase(_T("qscore")) == 0)
d1828 2
a1829 1
	if (sSort.IsEmpty()) {
d1833 3
a1835 1
	} else {
d1965 2
a1966 1
		else strSortIcon=pThis->m_Templates.sDownArrow;
d2086 2
a2087 1
		else strSortIcon=pThis->m_Templates.sDownArrow;
d2160 1
a2160 1
	Out.Replace(_T("[admin]"), admin); //DonGato: category priority change
a2165 1
	//SyruS show completed files (0.28b)
d2169 1
a2169 1
	if (!(pvecPartFiles = g_eMuleApp.m_pDownloadList->GetFiles()))	//failsafe
d2186 2
a2187 1
		if (pPartFile) {
d2261 1
a2261 1
			dFile.bCompress = pPartFile->GetDiscardSuperCompressed(); // Purity: DropSCB
d2269 1
a2269 1
			dFile.sFakeCheck = g_eMuleApp.m_pFakeCheck->IsFake(EncodeBase16(pPartFile->GetFileHash(), 16),pPartFile->GetFileSize()); //Purity -> FakeCheck
a2423 1
			{
a2424 1
			}
d2554 1
a2554 1
	uchar FileHashA4AF[16]; // Purity: Auto-A4AF
a2581 1
		// Purity: Auto-A4AF
a2609 1
		//DonGato: priority change
d2639 1
a2639 1
		HTTPProcessData.Replace(_T("[down-priority]"), downpriority); //DonGato: priority change
a2640 1
		// Purity: showing status for files (A4AF & SCB)
d2646 1
a2646 1
		HTTPProcessData.Replace(_T("[FileType]"), FilesArray[i].sFileType); //Purity: FileType
d2653 2
a2654 1
		if (!WSdownloadColumnHidden[0]) {
d2659 2
a2660 1
		} else
d2675 2
a2676 1
		if (!WSdownloadColumnHidden[2]) {
d2684 2
a2685 1
		} else
d2695 2
a2696 1
		if (!WSdownloadColumnHidden[4]) {
d2705 2
a2706 1
		} else
d2709 2
a2710 1
		if (!WSdownloadColumnHidden[5]) {
d2721 2
a2722 1
		} else
d2746 2
a2747 1
		} else
d2811 2
a2812 1
		if (!WSuploadColumnHidden[3]) {
d2816 2
a2817 1
			HTTPProcessData.Replace(_T("[3]"), HTTPTemp); }
d2820 2
a2821 1
		if (!WSuploadColumnHidden[4]) {
d2824 2
a2825 1
			HTTPProcessData.Replace(_T("[4]"), HTTPTemp); }
d2861 2
a2862 1
			if (!WSqueueColumnHidden[3]) {
d2864 2
a2865 1
				HTTPProcessData.Replace(_T("[Score]"), HTTPTempC); }
d2883 1
a2883 1
	else {
a2884 1
	}
d2910 2
a2911 1
			if (!WSqueueColumnHidden[3]) {
d2913 2
a2914 1
				HTTPProcessData.Replace(_T("[Score]"), HTTPTempC); }
d2932 1
a2932 1
	else {
a2933 1
	}
d2959 2
a2960 1
			if (!WSqueueColumnHidden[3]) {
d2962 2
a2963 1
				HTTPProcessData.Replace(_T("[Score]"), HTTPTempC); }
d2981 1
a2981 1
	else {
a2982 1
	}
d3008 2
a3009 1
			if (!WSqueueColumnHidden[3]) {
d3011 2
a3012 1
				HTTPProcessData.Replace(_T("[Score]"), HTTPTempC); }
d3030 1
a3030 1
	else {
a3031 1
	}
d3082 2
a3083 1
		else strSortIcon=pThis->m_Templates.sDownArrow;
d3085 2
a3086 1
	if (!WSqueueColumnHidden[0]) {
d3089 4
a3092 2
		Out.Replace(_T("[UserNameTitleM]"), _GetPlainResString(IDS_QL_USERNAME)); }
	else {
d3095 4
a3098 2
		Out.Replace(_T("[UserNameTitleM]"), _GetPlainResString(IDS_QL_USERNAME)); }
	if (!WSqueueColumnHidden[1]) {
d3101 4
a3104 2
		Out.Replace(_T("[VersionM]"), _GetPlainResString(IDS_INFLST_USER_CLIENTVERSION)); }
	else {
d3107 4
a3110 2
		Out.Replace(_T("[VersionM]"), _GetPlainResString(IDS_INFLST_USER_CLIENTVERSION)); }
	if (!WSqueueColumnHidden[2]) {
d3113 4
a3116 2
		Out.Replace(_T("[FileNameTitleM]"), _GetPlainResString(IDS_DL_FILENAME)); }
	else {
d3119 4
a3122 2
		Out.Replace(_T("[FileNameTitleM]"), _GetPlainResString(IDS_DL_FILENAME)); }
	if (!WSqueueColumnHidden[3]) {
d3125 4
a3128 2
		Out.Replace(_T("[ScoreTitleM]"), _GetPlainResString(IDS_SCORE)); }
	else {
d3131 2
a3132 1
		Out.Replace(_T("[ScoreTitleM]"), _GetPlainResString(IDS_SCORE)); }
d3157 1
a3157 2
		else
		if(_ParseURL(Data.sURL, _T("sort")) == "type")
d3159 1
a3159 2
		else
		if(_ParseURL(Data.sURL, _T("sort")) == "name")
d3161 1
a3161 2
		else
		if(_ParseURL(Data.sURL, _T("sort")) == "size")
d3163 1
a3163 2
		else
		if(_ParseURL(Data.sURL, _T("sort")) == "transferred")
d3165 1
a3165 2
		else
		if(_ParseURL(Data.sURL, _T("sort")) == "alltimetransferred")
d3167 1
a3167 2
		else
		if(_ParseURL(Data.sURL, _T("sort")) == "requests")
d3169 1
a3169 2
		else
		if(_ParseURL(Data.sURL, _T("sort")) == "alltimerequests")
d3171 1
a3171 2
		else
		if(_ParseURL(Data.sURL, _T("sort")) == "accepts")
d3173 1
a3173 2
		else
		if(_ParseURL(Data.sURL, _T("sort")) == "alltimeaccepts")
d3175 1
a3175 2
		else
		if(_ParseURL(Data.sURL, _T("sort")) == "priority")
a3183 1
	//DonGato: priority change
d3326 1
a3326 2
	else
	if(pThis->m_Params.SharedSort == SHARED_SORT_ALL_TIME_ACCEPTS)
d3350 2
a3351 1
	if (!WSsharedColumnHidden[0]){
d3354 4
a3357 2
		Out.Replace(_T("[FilenameM]"), _GetPlainResString(IDS_DL_FILENAME)); }
	else {
d3360 4
a3363 2
		Out.Replace(_T("[FilenameM]"), _GetPlainResString(IDS_DL_FILENAME)); }
	if (!WSsharedColumnHidden[1]){
d3366 4
a3369 2
		Out.Replace(_T("[FileTransferredM]"),  _GetPlainResString(IDS_SF_TRANSFERRED)); }
	else {
d3372 4
a3375 2
		Out.Replace(_T("[FileTransferredM]"),  _GetPlainResString(IDS_SF_TRANSFERRED)); }
	if (!WSsharedColumnHidden[2]){
d3378 4
a3381 2
		Out.Replace(_T("[FileRequestsM]"),  _GetPlainResString(IDS_SF_REQUESTS)); }
	else {
d3384 4
a3387 2
		Out.Replace(_T("[FileRequestsM]"),  _GetPlainResString(IDS_SF_REQUESTS)); }
	if (!WSsharedColumnHidden[3]){
d3390 4
a3393 2
		Out.Replace(_T("[FileAcceptsM]"),  _GetPlainResString(IDS_SF_ACCEPTS)); }
	else {
d3396 4
a3399 2
		Out.Replace(_T("[FileAcceptsM]"),  _GetPlainResString(IDS_SF_ACCEPTS)); }
	if (!WSsharedColumnHidden[4]){
d3402 4
a3405 2
		Out.Replace(_T("[SizeM]"), _GetPlainResString(IDS_DL_SIZE)); }
	else {
d3408 4
a3411 2
		Out.Replace(_T("[SizeM]"), _GetPlainResString(IDS_DL_SIZE)); }
	if (!WSsharedColumnHidden[5]){
d3414 4
a3417 2
		Out.Replace(_T("[PriorityM]"),  _GetPlainResString(IDS_PRIORITY)); }
	else {
d3420 2
a3421 1
		Out.Replace(_T("[PriorityM]"),  _GetPlainResString(IDS_PRIORITY)); }
d3448 1
a3448 1
		strFileName.MakeLower(); // Purity: show FileType Icons in WebServer
d3489 2
a3490 1
			if (cur_file->GetJumpstartEnabled()) {
d3551 1
a3551 2
				else
					if(SharedArray[i+1].nFilePriority == 4)
a3595 1
		//DonGato: priority change
a3627 1
		// Purity: showing shared files priority for Release and JS
d3656 2
a3657 1
		if (!WSsharedColumnHidden[0]){
d3662 2
a3663 1
		} else
d3665 2
a3666 1
		if (!WSsharedColumnHidden[1]){
d3671 3
a3673 1
		} else {
d3675 4
a3678 2
			HTTPProcessData.Replace(_T("[FileAllTimeTransferred]"), ""); }
		if (!WSsharedColumnHidden[2]){
d3683 3
a3685 1
		} else {
d3687 4
a3690 2
			HTTPProcessData.Replace(_T("[FileAllTimeRequests]"), ""); }
		if (!WSsharedColumnHidden[3]){
d3695 3
a3697 1
		} else {
d3699 4
a3702 2
			HTTPProcessData.Replace(_T("[FileAllTimeAccepts]"), ""); }
		if (!WSsharedColumnHidden[4]){
d3705 2
a3706 1
		} else
d3708 1
a3708 1
		if (!WSsharedColumnHidden[5]){
d3710 1
a3710 1
		} else
d3813 1
a3813 1
			CString resultlog = _SpecialChars(g_eMuleApp.m_pdlgEmule->m_strLogText);        //Pick-up last line of the log 
d3829 1
a3829 1
				resultlog += _SpecialChars(g_eMuleApp.m_pdlgEmule->m_strLogText);        //Pick-up last line of the log 
d3997 2
a3998 1
	if ((_ParseURL(Data.sURL, _T("saveprefs")) == "true") && IsSessionAdmin(Data,sSession) ) {
a4068 1
	{
a4069 1
	}
a4070 1
	{
a4071 1
	}
a4072 1
	{
a4073 1
	}
a4074 1
	{
a4075 1
	}
a4076 1
	{
a4077 1
	}
a4078 1
	{
a4079 1
	}
a4080 1
	{
a4081 1
	}
a4082 1
	{
a4083 1
	}
a4084 1
	{
a4085 1
	}
a4086 1
	{
a4087 1
	}
d4276 2
a4277 1
void CWebServer::_RemoveTimeOuts(ThreadData Data, long lSession) {
d4313 2
a4314 1
Session CWebServer::GetSessionByID(ThreadData Data,long sessionID) {
d4334 2
a4335 1
bool CWebServer::IsSessionAdmin(ThreadData Data,CString SsessionID){
d4339 2
a4340 1
	if(pThis != NULL) {
d4351 2
a4352 1
CString CWebServer::GetPermissionDenied() {
d4369 2
a4370 1
		if (!_istxdigit(hex_byte[0]) || !_istxdigit(hex_byte[1])) {
d4373 3
a4375 1
		} else {
a4405 1
// EC + kuchin
d4464 3
a4466 3
	//SyruS show completed files (0.28b)
	cur_file=g_eMuleApp.m_pDownloadQueue->GetFileByID(fileid); // DonGato: solve non completed files shown as complete
	if (cur_file==0 || !cur_file->IsPartFile()) {
d4472 2
a4473 1
	else {
d4479 6
a4484 3
		for (uint16 i=0;i<pThis->m_Templates.iProgressbarWidth;i++) {
			if (lastcolor!= _tstoi(s_ChunkBar.Mid(i,1))  ) {
				if (i>lastindex) {
d4498 1
a4498 1
		(compl>0)?temp.Format(pThis->m_Templates.sProgressbarImgsPercent+_T("<br>"),progresscolor[10],compl) :temp.Format(pThis->m_Templates.sProgressbarImgsPercent+_T("<br>"),progresscolor[11],5);	//Ju1i3n - merged with eMulePlus by janes bong
d4545 2
a4546 1
	if (sCmd.CompareNoCase(_T("update")) == 0 && IsSessionAdmin(Data,sSession)) {
d4567 1
a4567 1
	else if(_ParseURL(Data.sURL, _T("tosearch")) != "" && !IsSessionAdmin(Data,sSession) ) {
d4569 2
a4570 2
	}
	else Out.Replace(_T("[Message]"), _GetPlainResString(IDS_SW_REFETCHRES));
d4591 4
a4594 1
	if (CCat::GetNumCats()>1) InsertCatBox(Out,0,pThis->m_Templates.sCatArrow,false,false,sSession,""); else Out.Replace("[CATBOX]","");
d4635 4
a4638 2
	if (pThis->m_bSearchAsc) strSortIcon=pThis->m_Templates.sUpArrow;
		else strSortIcon=pThis->m_Templates.sDownArrow;
d4640 2
a4641 1
	if (!WSsearchColumnHidden[0]){
d4644 4
a4647 2
		Out.Replace(_T("[FilenameM]"), _GetPlainResString(IDS_DL_FILENAME)); }
	else {
d4650 4
a4653 2
		Out.Replace(_T("[FilenameM]"), _GetPlainResString(IDS_DL_FILENAME)); }
	if (!WSsearchColumnHidden[1]){
d4656 4
a4659 2
		Out.Replace(_T("[FilesizeM]"), _GetPlainResString(IDS_DL_SIZE)); }
	else {
d4662 4
a4665 2
		Out.Replace(_T("[FilesizeM]"), _GetPlainResString(IDS_DL_SIZE)); }
	if (!WSsearchColumnHidden[2]){
d4668 4
a4671 2
		Out.Replace(_T("[FilehashM]"), _GetPlainResString(IDS_FILEHASH)); }
	else {
d4674 4
a4677 2
		Out.Replace(_T("[FilehashM]"), _GetPlainResString(IDS_FILEHASH)); }
	if (!WSsearchColumnHidden[3]){
d4680 4
a4683 2
		Out.Replace(_T("[SourcesM]"), _GetPlainResString(IDS_DL_SOURCES)); }
	else {
d4686 4
a4689 2
		Out.Replace(_T("[SourcesM]"), _GetPlainResString(IDS_DL_SOURCES)); }
	if (!WSsearchColumnHidden[4]){
d4692 4
a4695 2
		Out.Replace(_T("[FakeCheckM]"), _GetPlainResString(IDS_FAKE_CHECK_HEADER)); }
	else {
d4698 2
a4699 1
		Out.Replace(_T("[FakeCheckM]"), _GetPlainResString(IDS_FAKE_CHECK_HEADER)); }
d4722 2
a4723 1
int CWebServer::UpdateSessionCount() {
d4730 1
a4730 1
		if(ts.GetTotalSeconds() > SESSION_TIMEOUT_SECS) {
a4731 1
		}
@


1.217
log
@skip sorting waitingqueue if no client will be shown;
some formating
@
text
@d518 5
d526 1
a526 5
		CString sSession; sSession.Format(_T("%ld"), lSession);

		if (_ParseURL(Data.sURL, _T("w")) == "logout") 
			_RemoveSession(Data, lSession);
		else if (_ParseURL(Data.sURL, _T("w")) == "close")
@


1.216
log
@fixed Mantis bug #0000457
@
text
@d1540 1
a1540 1
	bool bAdmin = IsSessionAdmin(Data,sSession);	//SyruS cached (used often here)
d1653 1
a1653 1
			if(bAdmin && sOp.CompareNoCase(_T("a4af")) == 0) // DonGato: added A4ADF action
d1735 1
d1805 1
d1943 2
a1944 1
	if (!WSdownloadColumnHidden[0]){
d1947 4
a1950 2
		Out.Replace(_T("[DFilenameM]"), _GetPlainResString(IDS_DL_FILENAME)); }
	else {
d1953 5
a1957 2
		Out.Replace(_T("[DFilenameM]"), _GetPlainResString(IDS_DL_FILENAME)); }
	if (!WSdownloadColumnHidden[1]){
d1960 4
a1963 2
		Out.Replace(_T("[DSizeM]"), _GetPlainResString(IDS_DL_SIZE)); }
	else {
d1966 5
a1970 2
		Out.Replace(_T("[DSizeM]"), _GetPlainResString(IDS_DL_SIZE)); }
	if (!WSdownloadColumnHidden[2]){
d1973 4
a1976 2
		Out.Replace(_T("[DTransferredM]"), _GetPlainResString(IDS_COMPLETE)); }
	else {
d1979 5
a1983 2
		Out.Replace(_T("[DTransferredM]"), _GetPlainResString(IDS_COMPLETE)); }
	if (!WSdownloadColumnHidden[3]){
d1986 4
a1989 2
		Out.Replace(_T("[DProgressM]"), _GetPlainResString(IDS_DL_PROGRESS)); }
	else {
d1992 5
a1996 2
		Out.Replace(_T("[DProgressM]"), _GetPlainResString(IDS_DL_PROGRESS)); }
	if (!WSdownloadColumnHidden[4]){
d1999 4
a2002 2
		Out.Replace(_T("[DSpeedM]"), _GetPlainResString(IDS_DL_SPEED)); }
	else {
d2005 5
a2009 2
		Out.Replace(_T("[DSpeedM]"), _GetPlainResString(IDS_DL_SPEED)); }
	if (!WSdownloadColumnHidden[5]){
d2012 4
a2015 2
		Out.Replace(_T("[DSourcesM]"), _GetPlainResString(IDS_DL_SOURCES)); }
	else {
d2018 5
a2022 2
		Out.Replace(_T("[DSourcesM]"), _GetPlainResString(IDS_DL_SOURCES)); }
	if (!WSdownloadColumnHidden[6]){
d2025 4
a2028 2
		Out.Replace(_T("[DPriorityM]"), _GetPlainResString(IDS_PRIORITY)); }
	else {
d2031 5
a2035 2
		Out.Replace(_T("[DPriorityM]"), _GetPlainResString(IDS_PRIORITY)); }
	if (!WSdownloadColumnHidden[7]){
d2038 4
a2041 2
		Out.Replace(_T("[DCategoryM]"), _GetPlainResString(IDS_CAT)); }
	else {
d2044 5
a2048 2
		Out.Replace(_T("[DCategoryM]"), _GetPlainResString(IDS_CAT)); }
	if (!WSdownloadColumnHidden[8]){
d2051 4
a2054 2
		Out.Replace(_T("[DFakeCheckM]"), _GetPlainResString(IDS_FAKE_CHECK_HEADER)); }
	else {
d2057 2
a2058 1
		Out.Replace(_T("[DFakeCheckM]"), _GetPlainResString(IDS_FAKE_CHECK_HEADER)); }
d2063 2
a2064 1
	if (!WSuploadColumnHidden[0]){
d2067 4
a2070 2
		Out.Replace(_T("[UUserM]"), _GetPlainResString(IDS_QL_USERNAME)); }
	else {
d2073 5
a2077 2
		Out.Replace(_T("[UUserM]"), _GetPlainResString(IDS_QL_USERNAME)); }
	if (!WSuploadColumnHidden[1]){
d2080 4
a2083 2
		Out.Replace(_T("[UVersionM]"), _GetPlainResString(IDS_INFLST_USER_CLIENTVERSION)); }
	else {
d2086 5
a2090 2
		Out.Replace(_T("[UVersionM]"), _GetPlainResString(IDS_INFLST_USER_CLIENTVERSION)); }
	if (!WSuploadColumnHidden[2]){
d2093 4
a2096 2
		Out.Replace(_T("[UFilenameM]"), _GetPlainResString(IDS_DL_FILENAME)); }
	else {
d2099 5
a2103 2
		Out.Replace(_T("[UFilenameM]"), _GetPlainResString(IDS_DL_FILENAME)); }
	if (!WSuploadColumnHidden[3]){
d2106 4
a2109 2
		Out.Replace(_T("[UTransferredM]"), _GetPlainResString(IDS_DL_ULDL)); }
	else {
d2112 5
a2116 2
		Out.Replace(_T("[UTransferredM]"), _GetPlainResString(IDS_DL_ULDL)); }
	if (!WSuploadColumnHidden[4]){
d2119 4
a2122 2
		Out.Replace(_T("[USpeedM]"), _GetPlainResString(IDS_DL_SPEED)); }
	else {
d2125 3
a2127 1
		Out.Replace(_T("[USpeedM]"), _GetPlainResString(IDS_DL_SPEED)); }
d2516 5
d2524 1
a2524 1
	QueueArray.QuickSort(!pThis->m_Params.bQueueSortReverse);	//SyruS CQArray-Sorting execute
d2528 1
@


1.215
log
@Added Uploads and Queue default sorting. We might want to store last sort in preferences (for 1j) to be more user friendly.
@
text
@d518 4
a521 1
	CString sSession; sSession.Format(_T("%ld"), lSession);
d523 6
a528 16
	if (_ParseURL(Data.sURL, _T("w")) == "logout") 
		_RemoveSession(Data, lSession);
	else if (_ParseURL(Data.sURL, _T("w")) == "close") {
		g_eMuleApp.m_app_state = g_eMuleApp.APP_STATE_SHUTINGDOWN;
		SendMessage(g_eMuleApp.m_pdlgEmule->m_hWnd,WM_CLOSE,0,0);
	} else if (_ParseURL(Data.sURL, _T("w")) == "shutdown") {
		HANDLE hToken; 
		TOKEN_PRIVILEGES tkp;	// Get a token for this process.
		try {
			if (!OpenProcessToken(GetCurrentProcess(), TOKEN_ADJUST_PRIVILEGES | TOKEN_QUERY, &hToken)) 
				throw; 
			LookupPrivilegeValue(NULL, SE_SHUTDOWN_NAME, &tkp.Privileges[0].Luid); 
			tkp.PrivilegeCount = 1;  // one privilege to set    
			tkp.Privileges[0].Attributes = SE_PRIVILEGE_ENABLED;	// Get the shutdown privilege for this process.
			AdjustTokenPrivileges(hToken, FALSE, &tkp, 0, (PTOKEN_PRIVILEGES)NULL, 0); 
			ExitWindowsEx(EWX_SHUTDOWN | EWX_FORCE, 0);
d530 18
a547 2
		catch(...) {
			AddLogLine(true,IDS_WEB_SHUTDOWN+" "+IDS_FAILED);
d549 18
a566 11
	} else if (_ParseURL(Data.sURL, _T("w")) == "reboot") {
		HANDLE hToken; 
		TOKEN_PRIVILEGES tkp;	// Get a token for this process.
		try {
			if (!OpenProcessToken(GetCurrentProcess(), TOKEN_ADJUST_PRIVILEGES | TOKEN_QUERY, &hToken)) 
				throw; 
			LookupPrivilegeValue(NULL, SE_SHUTDOWN_NAME, &tkp.Privileges[0].Luid); 
			tkp.PrivilegeCount = 1;  // one privilege to set    
			tkp.Privileges[0].Attributes = SE_PRIVILEGE_ENABLED;	// Get the shutdown privilege for this process.
			AdjustTokenPrivileges(hToken, FALSE, &tkp, 0, (PTOKEN_PRIVILEGES)NULL, 0); 
			ExitWindowsEx(EWX_REBOOT | EWX_FORCE, 0);
a567 4
		catch(...) {
			AddLogLine(true,IDS_WEB_REBOOT+" "+IDS_FAILED);
		}
	}
a568 2
	if(_IsLoggedIn(Data, lSession))
	{
@


1.214
log
@Fix for webserver, crash on clear completed files
@
text
@d52 4
@


1.213
log
@Various fixes for Interim beta2 reported bugs
@
text
@d1538 6
a1543 2
			EnumCategories eCatID = cat == 0 ? CAT_ALL : CCat::GetCatIDByUserIndex(cat);
			g_eMuleApp.m_pDownloadList->ClearCompleted(eCatID);
d1548 5
a1552 3
			uchar FileHash[16];
			if (_GetFileHash(sClear, FileHash))	//failsafe
				g_eMuleApp.m_pDownloadList->ClearCompleted(FileHash);
@


1.212
log
@Fixed bug 0000443  - After clearing log via WebServer all messages from all Logs will appear in active Log tab
@
text
@a1532 1
	//SyruS show completed files (0.28b) plus clear completed
d1536 8
a1543 3
		if (sClear.CompareNoCase(_T("all")) == 0) {
			g_eMuleApp.m_pDownloadList->ClearCompleted(CAT_NONE);
		} else {
a4337 1

d4349 2
a4350 1
	if (_ParseURL(Data.sURL, _T("downloads")) != "" && IsSessionAdmin(Data,sSession)) {
d4353 3
a4355 1
		uint8 iCatIndex=atoi(_ParseURL(Data.sURL, "cat"));
d4360 1
d4366 1
a4366 4
			if(iCatIndex == 0)
				g_eMuleApp.m_pSearchList->AddFileToDownloadByHash(fileid,CAT_NONE);
			else
				g_eMuleApp.m_pSearchList->AddFileToDownloadByHash(fileid,CCat::GetCatIDByIndex(iCatIndex));
d4370 2
@


1.211
log
@Formatting, comments, and name changes.
@
text
@d3713 1
a3713 1
	Out.Replace(_T("[Log]"), _SpecialChars(g_eMuleApp.m_pdlgEmule->m_wndServer.logbox.GetAllLogEntries())+"<br><a name=\"end\"></a>" );
d3767 1
a3767 1
	Out.Replace(_T("[DebugLog]"), _SpecialChars(g_eMuleApp.m_pdlgEmule->m_wndServer.debugbox.GetAllLogEntries())+"<br><a name=\"end\"></a>" );
@


1.210
log
@Fixed Log & Debug Log on the WebServer
@
text
@d3737 1
a3737 1
		g_eMuleApp.m_pdlgEmule->m_wndServer.m_ctlServerMsgBox->SetWindowText(_T(""));
d3740 1
a3740 1
	Out.Replace(_T("[ServerInfo]"), _SpecialChars(g_eMuleApp.m_pdlgEmule->m_wndServer.m_ctlServerMsgBox->GetText()));
@


1.209
log
@Rich Edit control for all logs (from official v0.30c) ;
Fixed bug #0000023 - Mouse wheel in Serverinfo window does not work
@
text
@d3713 1
a3713 1
	Out.Replace(_T("[Log]"), _SpecialChars(g_eMuleApp.m_pdlgEmule->m_strLogText));
d3767 1
a3767 1
	Out.Replace(_T("[DebugLog]"), _SpecialChars(g_eMuleApp.m_pdlgEmule->m_strDebugLog));
@


1.208
log
@Formatting, comments, and name changes.
@
text
@d10 1
d3737 1
a3737 1
		g_eMuleApp.m_pdlgEmule->m_wndServer.m_ctlServerMsgBox.SetWindowText(_T(""));
d3740 1
a3740 1
	Out.Replace(_T("[ServerInfo]"), _SpecialChars(g_eMuleApp.m_pdlgEmule->m_wndServer.m_ctlServerMsgBox.GetHyperText()->GetText()));
@


1.207
log
@Formatting, comments, and name changes.
float => double conversion
@
text
@d2145 1
a2145 1
			dFile.sED2kLink = pPartFile->CreateED2kLink();
d2243 1
a2243 1
		if (cur_client->PlusVersion())
d2247 1
a2247 1
		if (cur_client->PlusVersion()) dUser.sClientSoftSpecial = _T("p");
d2376 1
a2376 1
		if (cur_client->PlusVersion())
@


1.206
log
@More try/catch
@
text
@d875 1
a875 1
			_stprintf(HTTPHeader, _T("%.1f "), ((float)cur_server->GetNumUsers() / cur_server->GetMaxUsers()) * 100);
d877 1
a877 1
			_stprintf(HTTPHeader, _T("%.1f "), (float)0);
d902 1
a902 1
		_stprintf(HTTPHeader, "%.1f", ((float)g_eMuleApp.m_pUploadQueue->GetDataRate()/1024)/(g_eMuleApp.m_pGlobPrefs->GetMaxGraphUploadRate())*100); 
d904 1
a904 1
		_stprintf(HTTPHeader, "%.1f", ((float)g_eMuleApp.m_pUploadQueue->GetDataRate()/1024)/(g_eMuleApp.m_pGlobPrefs->GetMaxUpload())*100); 
d908 1
a908 1
		_stprintf(HTTPHeader, "%.1f", ((float)g_eMuleApp.m_pDownloadQueue->GetDataRate()/1024)/(g_eMuleApp.m_pGlobPrefs->GetMaxGraphDownloadRate())*100);
d910 1
a910 1
		_stprintf(HTTPHeader, "%.1f", ((float)g_eMuleApp.m_pDownloadQueue->GetDataRate()/1024)/(g_eMuleApp.m_pGlobPrefs->GetMaxDownload())*100);
d913 1
a913 1
	_stprintf(HTTPHeader, "%.1f", ((float)g_eMuleApp.m_pListenSocket->GetNumOpenSockets())/(g_eMuleApp.m_pGlobPrefs->GetMaxConnections())*100);
d915 1
a915 1
	_stprintf(HTTPHeader, "%.1f", ((float)g_eMuleApp.m_pUploadQueue->GetDataRate()/1024)); 
d917 1
a917 1
	_stprintf(HTTPHeader, "%.1f", ((float)g_eMuleApp.m_pDownloadQueue->GetDataRate()/1024));
d919 1
a919 1
	_stprintf(HTTPHeader, "%.0f", ((float)g_eMuleApp.m_pListenSocket->GetNumOpenSockets()));
d2042 1
a2042 1
	float fTotalSize = 0, fTotalTransferred = 0, fTotalSpeed = 0;
d2084 1
a2084 1
			dFile.lFileSize = pPartFile->GetFileSize();
d2086 1
a2086 1
			dFile.fCompleted = pPartFile->GetPercentCompleted();
d2178 1
a2178 1
				bSwap = FilesArray[i].lFileSize < FilesArray[i+1].lFileSize;
d2187 1
a2187 1
				bSwap = FilesArray[i].fCompleted  < FilesArray[i+1].fCompleted ;
d2472 1
a2472 1
		fsize.Format(_T("%d"),FilesArray[i].lFileSize);
d2543 1
a2543 1
		fTotalSize += FilesArray[i].lFileSize;
d2546 1
a2546 1
			HTTPProcessData.Replace(_T("[2]"), CastItoXBytes(FilesArray[i].lFileSize));
d2688 1
a2688 1
			HTTPTemp.Format(_T("%8.2f "), max((float)UploadArray[i].nDataRate/1024, 0.0));
d3281 1
a3281 1
		dFile.lFileSize = cur_file->GetFileSize();
d3352 1
a3352 1
				bSwap = SharedArray[i].lFileSize < SharedArray[i+1].lFileSize;
d3521 1
a3521 1
			_stprintf(HTTPTempC, _T("%s"),CastItoXBytes(SharedArray[i].lFileSize));
d4320 3
a4322 1
		int compl=(int)((pThis->m_Templates.iProgressbarWidth/100)*cur_file->GetPercentCompleted());
@


1.205
log
@Removed NNS feature and changed SLS
@
text
@d4263 2
d4325 4
d4539 2
d4666 2
d4672 2
d4680 3
@


1.204
log
@eMuleXP template changes and cleanup (icons and code) + show next upload client in queue
@
text
@a814 1
	Out.Replace(_T("[NoNeededSources]"), _GetPlainResString(IDS_DROPNONEEDEDSRCS, true));
a1678 4
			}
			else if(bAdmin && sOp.CompareNoCase(_T("noneededsources")) == 0) // Purity: DropNNS
			{
				found_file->RemoveNoNeededSources();
@


1.203
log
@Updated File Status icons
@
text
@d2229 1
d2231 2
d2234 1
d2236 2
d2246 7
d2288 1
a2288 1
				bSwap = UploadArray[i].sClientSoft.CompareNoCase(UploadArray[i+1].sClientSoft) > 0;
d2372 2
d2379 5
a2384 1

d2389 1
a2389 1
			dUser.sIndex = dUser.sClientSoft;
d2406 2
d2409 14
a2422 1
		QueueArray.Add(dUser);
d2668 1
d2670 1
d2735 2
d2738 1
d2783 2
d2786 1
d2831 2
d2834 1
d2879 2
d2882 1
@


1.202
log
@Formatting, comments, and name changes.
... and a few bug fixes.
@
text
@d2106 2
d2109 1
a2109 1
					dFile.sFileState = "hashing";
@


1.201
log
@Added an option to Reboot the PC from the WebServer [katsyonak]
@
text
@d2235 1
a2235 1
		if ((cur_client->credits->GetCurrentIdentState(cur_client->GetIP()) != IS_IDENTIFIED) && (cur_client->GetClientSoft() == 0))
d2242 1
a2242 1
		else if (cur_client->credits->GetScoreRatio(cur_client->GetIP()) > 1)
d2250 1
a2250 1
		CKnownFile* file = g_eMuleApp.m_pSharedFilesList->GetFileByID(cur_client->reqfileid);
d2321 1
a2321 1
		bool bSecure = (cur_client->credits->GetCurrentIdentState(cur_client->GetIP()) == IS_IDENTIFIED);
d2334 1
a2334 1
		else if (cur_client->credits->GetScoreRatio(cur_client->GetIP()) > 1)
d2352 1
a2352 1
		CKnownFile* file = g_eMuleApp.m_pSharedFilesList->GetFileByID(cur_client->reqfileid);
d2359 1
a2359 1
		if ((cur_client->credits->GetCurrentIdentState(cur_client->GetIP()) != IS_IDENTIFIED) && (cur_client->GetClientSoft() == 0))
@


1.200
log
@DownloadListCtrl rewrite.
Changed Category ID types to an enumeration.
More async update work.
The usual formatting, comments, and name changes.
@
text
@d535 15
d796 1
d824 1
@


1.199
log
@Formatting, comments, and name changes.
Removed #includes for "memcpy_amd.h".
@
text
@d1500 2
a1501 1
	int cat=atoi(_ParseURL(Data.sURL,"cat"));
d1521 1
a1521 1
			g_eMuleApp.m_pdlgEmule->m_wndTransfer.m_wndDownloadList.ClearCompleted();
d1525 1
a1525 1
				g_eMuleApp.m_pdlgEmule->m_wndTransfer.m_wndDownloadList.ClearCompleted(FileHash);
d1533 2
a1534 2
		uint8 iCat = cat == 0 ? 0 : CCat::GetCatIDByUserIndex(cat);
		g_eMuleApp.m_pdlgEmule->m_dlgSearch.AddEd2kLinksToDownload(HTTPTemp,iCat);
d1678 1
a1678 1
					found_file->SetCatID(0);
d2033 9
a2041 5
	CArray<CPartFile*,CPartFile*> partlist;
	if (!g_eMuleApp.m_pdlgEmule->m_wndTransfer.m_wndDownloadList.GetDisplayedFiles(&partlist))	//failsafe
	{
		partlist.RemoveAll();
		// Populating array
d2044 3
a2046 2
			CPartFile* cur_file = g_eMuleApp.m_pDownloadQueue->m_partFileList.GetAt(pos);
			partlist.Add(cur_file);
d2049 3
a2051 3
	for (int i=0; i<partlist.GetCount(); i++) {
		CPartFile* cur_file=partlist.GetAt(i);
		if (cur_file) {
d2053 5
a2057 1
			if (!CCat::FileBelongsToGivenCat(cur_file,(cat>CAT_PREDEFINED)? cat:CCat::GetCatIDByIndex(cat), true))
d2061 2
a2062 2
			if(cur_file->IsAutoPrioritized())
				cur_file->UpdateDownloadAutoPriority();
d2067 2
a2068 2
			dFile.sFileName = _SpecialChars(cur_file->GetFileName());
			CString strFileName = _SpecialChars(cur_file->GetFileName());
d2071 5
a2075 5
			dFile.sFileNameJS = _SpecialChars(cur_file->GetFileName(), true);	//for javascript
			dFile.lFileSize = cur_file->GetFileSize();
			dFile.lFileTransferred = cur_file->GetCompletedSize();
			dFile.fCompleted = cur_file->GetPercentCompleted();
			dFile.lFileSpeed = cur_file->GetDataRate();
d2077 1
a2077 1
			if(cur_file->GetDataRate() > 0)
d2081 1
a2081 1
				if (cur_file != NULL && cur_file->GetPartfileStatusID() == PS_STALLED)
d2086 1
a2086 1
			switch(cur_file->GetStatus())
d2113 2
a2114 2
			dFile.bFileAutoPrio = cur_file->IsAutoPrioritized();
			dFile.nFilePrio = cur_file->GetPriority();
d2116 1
a2116 1
			CCat		*pCat = CCat::GetCatByID(cur_file->GetCatID());
d2121 5
a2125 5
			dFile.sFileHash = EncodeBase16(cur_file->GetFileHash(), 16);
			dFile.lSourceCount = cur_file->GetSourceCount();
			dFile.lNotCurrentSourceCount = cur_file->GetNotCurrentSourcesCount();
			dFile.lTransferringSourceCount = cur_file->GetTransferringSrcCount();
			dFile.bCompress = cur_file->GetDiscardSuperCompressed(); // Purity: DropSCB
d2128 1
a2128 1
				dFile.sED2kLink = cur_file->CreateED2kSourceLink();
d2131 3
a2133 3
			dFile.sED2kLink = cur_file->CreateED2kLink();
			dFile.sFileInfo = _SpecialChars(cur_file->GetDownloadFileInfo());
			dFile.sFakeCheck = g_eMuleApp.m_pFakeCheck->IsFake(EncodeBase16(cur_file->GetFileHash(), 16),cur_file->GetFileSize()); //Purity -> FakeCheck
d2138 6
d4289 1
a4289 1
				g_eMuleApp.m_pSearchList->AddFileToDownloadByHash(fileid,iCatIndex);
d4598 1
a4598 1
CString CWebServer::GetSubCatLabel(int cat)
d4600 1
a4600 1
	CString sPlain = CCat::GetPredefinedCatTitle(cat+CAT_PREDEFINED);
@


1.198
log
@Formatting, comments, and name changes.
Created distinct tag classes and typed enumerations for tags, opcodes, and protocols.
@
text
@d1258 2
a1259 2
		Entry.nServerSoftLimit = cur_file->GetSoftFiles();
		Entry.nServerHardLimit = cur_file->GetHardFiles();
d3184 1
a3184 1
	for (POSITION pos = g_eMuleApp.m_pSharedFilesList->m_Files_map.GetStartPosition();pos != 0;)
d3190 1
a3190 1
		g_eMuleApp.m_pSharedFilesList->m_Files_map.GetNextAssoc(pos,bufKey,cur_file);
@


1.197
log
@added remaining sort possibilities + sort direction icons + fakecheck list update via webserver
@
text
@d852 1
a852 1
		_stprintf(HTTPHeader, _T("%s"), CastItoIdots(cur_server->GetUsers()));
d859 1
a859 1
			_stprintf(HTTPHeader, _T("%.1f "), ((float)cur_server->GetUsers() / cur_server->GetMaxUsers()) * 100);
d876 1
a876 1
	    allUsers += cur_server->GetUsers();
d1243 1
a1243 1
        Entry.nServerUsers = cur_file->GetUsers();
@


1.196
log
@Update of Light template
@
text
@d156 2
d1139 5
d1145 1
d1149 1
d1153 1
d1157 1
d1161 1
d1165 1
d1169 1
d1173 1
d1177 1
d1181 1
d1185 1
d1189 1
d1193 1
d1197 1
d1201 1
d1205 1
d1209 1
d1213 1
d1217 1
d1221 1
d1898 5
d1904 1
d1908 1
d1912 1
d1916 1
d1920 1
d1924 1
d1928 1
d1932 1
d1936 1
d1940 1
d1944 1
d1948 1
d1952 1
d1956 1
d1960 1
d1964 1
d1968 1
d1972 1
d1975 4
d1980 1
d1984 1
d1988 1
d1992 1
d1996 1
d2000 1
d2004 1
d2008 1
d2012 1
d2016 1
d2863 3
d2867 1
d2871 1
d2875 1
d2879 1
d2883 1
d2887 1
d2891 1
d2895 1
d3123 4
d3128 1
d3132 1
d3136 1
d3140 1
d3144 1
d3148 1
d3152 1
d3156 1
d3160 1
d3164 1
d3168 1
d3172 1
d4280 7
d4311 1
a4311 1
	CString sCmd = _ParseURL(Data.sURL, _T("c"));
d4357 4
d4367 4
d4372 1
d4376 1
d4380 1
d4384 1
d4388 1
d4392 1
d4396 1
d4400 1
d4404 1
d4408 1
@


1.195
log
@see last changes (template)
@
text
@d2297 1
a2297 1
	AddLogLine(false,_T("WebServer: Waitingqueue with %u elements sorted in %u ms"), QueueArray.GetSize(), ::GetTickCount()-dwStart);
@


1.194
log
@Formatting, comments, and name changes.
@
text
@d35 1
a35 1
static bool	WSdownloadColumnHidden[10];
d40 1
a40 1
static bool	WSsearchColumnHidden[4];
d155 1
d754 3
d785 3
a787 1
	InsertCatBox(Out,0,"",false,false,sSession,"");
d1043 3
d1092 4
d1245 4
a1253 2
			else
				Entry.sServerState = "disconnected";
d1257 2
a1258 1
			if (tempServer->GetFullIP() == cur_file->GetFullIP()) {  
d1263 1
a1263 2
			} else
				Entry.sServerState = "disconnected";
a1264 1
		else
a1265 2
			Entry.sServerState = "disconnected";

d1278 3
d1673 6
d1703 3
d1709 3
d1724 3
d1802 8
d1842 8
d1919 6
d1990 2
d1996 2
a1997 20
			CString strExtension = strFileName.Right(4);
			if (strExtension == ".jpg" || strExtension == ".gif" || strExtension == ".tif" || strExtension == ".bmp" || strExtension == ".png" || strExtension == "jpeg") 
				dFile.sExtension = "picture";
			else if (strExtension == ".cue" || strExtension == ".bin" || strExtension == ".iso" || strExtension == ".nrg" || strExtension == ".sub" || strExtension == ".img" || strExtension == ".ccd" || strExtension == ".mdf") 
				dFile.sExtension = "cdimage";
			else if (strExtension == ".doc" || strExtension == ".rtf" || strExtension == ".txt" || strExtension == ".nfo") 
				dFile.sExtension = "document";
			else if (strExtension == ".pdf") 
				dFile.sExtension = "adobe";
			else if (strExtension == ".exe" || strExtension == ".msi") 
				dFile.sExtension = "application";
			else if (strExtension == ".rar" || strExtension == ".zip" || strExtension == ".ace" || strExtension == ".tar" || strExtension == ".arj") 
				dFile.sExtension = "archive";
			else if (strExtension == ".mpg" || strExtension == "mpeg" || strExtension == ".avi" || strExtension == ".mov" || strExtension == ".ogm" || strExtension == ".wmv") 
				dFile.sExtension = "movie";
			else if (strExtension == ".mp3" || strExtension == ".wav" || strExtension == ".ogg" || strExtension == ".wma") 
				dFile.sExtension = "music";
			else 
				dFile.sExtension = "other";
			dFile.sFileNameJS = _SpecialChars(cur_file->GetFileName(), true);
d2002 37
a2038 2
			dFile.nFileStatus = cur_file->GetStatus();
			dFile.sFileStatus = cur_file->GetPartfileStatus();
d2059 1
d2074 6
d2104 3
d2175 3
d2270 3
d2321 1
a2331 44
		if (FilesArray[i].lFileSpeed > 0)
		{
			state.Format(_T("downloading"));
		}
		else
		{
			if (found_file != NULL && found_file->GetPartfileStatusID() == PS_STALLED)
				state.Format(_T("stalled"));
			else
				state.Format(_T("waiting"));
		}

		switch(FilesArray[i].nFileStatus)
		{
			case PS_HASHING: 
			case PS_WAITINGFORHASH:
				state.Format(_T("hashing"));
				break;
			case PS_ERROR:
				state.Format(_T("error"));
				break;
			case PS_COMPLETING:
				state.Format(_T("completing"));
				break;
			case PS_COMPLETE:
				bIsComplete = true;
				state.Format(_T("complete"));
				break;
// BavarianSnail			
			case PS_STOPPED:
				if(!bIsComplete)
					state.Format(_T("stopped"));
				break;
// -BavarianSnail					
			case PS_PAUSED:
				if(!bIsComplete)
					state.Format(_T("paused"));
				break;
			default:
				break;
		}	//switch

// BavarianSnail - bugfix, move following block out of default switch section
		
d2343 2
a2352 1
// -BavarianSnail
d2383 1
d2395 1
a2395 1
		HTTPProcessData.Replace(_T("[FileType]"), FilesArray[i].sExtension); //Purity: FileType
d2495 5
d2778 4
d2845 6
d2957 11
a2968 1
	CString Out = pThis->m_Templates.sSharedList;
d3106 4
a3109 1

d3111 1
a3111 20
		CString strExtension = strFileName.Right(4);
		if (strExtension == ".jpg" || strExtension == ".gif" || strExtension == ".tif" || strExtension == ".bmp" || strExtension == ".png" || strExtension == "jpeg") 
			dFile.sExtension = "picture";
		else if (strExtension == ".cue" || strExtension == ".bin" || strExtension == ".iso" || strExtension == ".nrg" || strExtension == ".sub" || strExtension == ".img" || strExtension == ".ccd" || strExtension == ".mdf") 
			dFile.sExtension = "cdimage";
		else if (strExtension == ".doc" || strExtension == ".rtf" || strExtension == ".txt" || strExtension == ".nfo") 
			dFile.sExtension = "document";
		else if (strExtension == ".pdf") 
			dFile.sExtension = "adobe";
		else if (strExtension == ".exe" || strExtension == ".msi") 
			dFile.sExtension = "application";
		else if (strExtension == ".rar" || strExtension == ".zip" || strExtension == ".ace" || strExtension == ".tar" || strExtension == ".arj") 
			dFile.sExtension = "archive";
		else if (strExtension == ".mpg" || strExtension == "mpeg" || strExtension == ".avi" || strExtension == ".mov" || strExtension == ".ogm" || strExtension == ".wmv") 
			dFile.sExtension = "movie";
		else if (strExtension == ".mp3" || strExtension == ".wav" || strExtension == ".ogg" || strExtension == ".wma") 
			dFile.sExtension = "music";
		else 
			dFile.sExtension = "other";

d3173 6
d3290 1
a3290 2
		fname.Replace(_T("'"),_T("&#8217;"));

a3316 5
		if(SharedArray[i].bIsPartFile)
			HTTPProcessData.Replace(_T("[FileState]"), "filedown");
		else
			HTTPProcessData.Replace(_T("[FileState]"), "file");

d3318 2
a3319 1
		HTTPProcessData.Replace(_T("[FileType]"), SharedArray[i].sExtension);
d4227 1
a4227 1
	CString result=pThis->m_Templates.sSearchHeader + g_eMuleApp.m_pSearchList->GetWebList(pThis->m_Templates.sSearchResultLine,pThis->m_iSearchSortby,pThis->m_bSearchAsc,!WSsearchColumnHidden[0],!WSsearchColumnHidden[1],!WSsearchColumnHidden[2],!WSsearchColumnHidden[3]);
d4229 1
a4229 1
	if (CCat::GetNumCats()>1) InsertCatBox(Out,0,"",false,false,sSession,""); else Out.Replace("[CATBOX]","");
d4289 6
d4306 4
d4441 1
d4456 2
a4457 1
		CString	strCategory = (i == 0)? GetResString(IDS_CAT_UNASSIGN) : CCat::GetCatByUserIndex(i)->GetTitle();
@


1.193
log
@Ops!
@
text
@d889 1
a889 1
	_stprintf(HTTPHeader, "%.1f", ((float)g_eMuleApp.m_pListenSocket->GetOpenSockets())/(g_eMuleApp.m_pGlobPrefs->GetMaxConnections())*100);
d895 1
a895 1
	_stprintf(HTTPHeader, "%.0f", ((float)g_eMuleApp.m_pListenSocket->GetOpenSockets()));
d997 1
a997 1
			server->SetPreference((CServer::eServerPriority)PR_LOW);
d999 1
a999 1
				g_eMuleApp.m_pdlgEmule->m_wndServer.serverlistctrl.RefreshServer(*server);
d1007 1
a1007 1
			server->SetPreference((CServer::eServerPriority)PR_NORMAL);
d1009 1
a1009 1
				g_eMuleApp.m_pdlgEmule->m_wndServer.serverlistctrl.RefreshServer(*server);
d1017 1
a1017 1
			server->SetPreference((CServer::eServerPriority)PR_HIGH);
d1019 1
a1019 1
				g_eMuleApp.m_pdlgEmule->m_wndServer.serverlistctrl.RefreshServer(*server);
d1207 1
a1207 1
		if(cur_file->GetPreferences()== CServer::ePR_HIGH) {
d1210 1
a1210 1
		} else if(cur_file->GetPreferences()== CServer::ePR_NORMAL) {
d1213 1
a1213 1
		} else if(cur_file->GetPreferences()== CServer::ePR_LOW) {
d3409 1
a3409 1
				server->SetPreference((CServer::eServerPriority)PR_LOW);
d3411 1
a3411 1
				server->SetPreference((CServer::eServerPriority)PR_NORMAL);
d3413 1
a3413 1
				server->SetPreference((CServer::eServerPriority)PR_NORMAL);
d3415 1
a3415 1
				g_eMuleApp.m_pdlgEmule->m_wndServer.serverlistctrl.RefreshServer(*server);
d3511 1
a3511 1
		g_eMuleApp.m_pdlgEmule->m_wndServer.servermsgbox.SetWindowText(_T(""));
d3514 1
a3514 1
	Out.Replace(_T("[ServerInfo]"), _SpecialChars(g_eMuleApp.m_pdlgEmule->m_wndServer.servermsgbox.GetHyperText()->GetText()));
d3710 1
a3710 1
	sRefresh.Format(_T("%d"), g_eMuleApp.m_pGlobPrefs->GetMaxConperFive());
@


1.192
log
@Removed KB/s as it's unneeded (like in GUI)
@
text
@d2398 1
a2398 1
				HTTPTemp.Format(_T("%8.2f), FilesArray[i].lFileSpeed/1024.0);
@


1.191
log
@Fixed category related code.
@
text
@d2398 1
a2398 1
				HTTPTemp.Format(_T("%8.2f %s"), FilesArray[i].lFileSpeed/1024.0 ,_GetPlainResString(IDS_KBYTESEC));
d2459 1
a2459 1
	HTTPTemp.Format(_T("%8.2f %s"), fTotalSpeed/1024.0,_GetPlainResString(IDS_KBYTESEC));
d2507 1
a2507 1
			HTTPTemp.Format(_T("%8.2f ") + _GetPlainResString(IDS_KBYTESEC), max((float)UploadArray[i].nDataRate/1024, 0.0));
d2517 1
a2517 1
	HTTPTemp.Format(_T("%8.2f ") + _GetPlainResString(IDS_KBYTESEC), max(fTotalSpeed/1024, 0.0));
@


1.190
log
@Formatting, comments, and name changes.
@
text
@d1490 1
a1490 1
		uint8 iCat = CCat::GetCatIDByIndex(cat);
d1492 1
d1971 2
a1972 1
			CString		strCategory = (cur_file->GetCatID() != 0) ? CCat::GetCatByID(cur_file->GetCatID())->GetTitle() : GetResString(IDS_CAT_UNCATEGORIZED);
@


1.189
log
@little optimization: checking FileBelongsToGivenCat before - skipping unneccessary calculations
@
text
@d4113 1
a4113 1
		uint8 cat=atoi(_ParseURL(Data.sURL, "cat"));
d4123 2
a4124 2
			if(cat == 0)
				g_eMuleApp.m_pSearchList->AddFileToDownloadByHash(fileid,cat);
d4126 1
a4126 1
				g_eMuleApp.m_pSearchList->AddFileToDownloadByHash(fileid,CCat::GetCatIDByIndex(cat));
@


1.188
log
@Fixed category related code.
@
text
@d1929 4
a1985 2
			if (!CCat::FileBelongsToGivenCat(cur_file,(cat>CAT_PREDEFINED)? cat:CCat::GetCatIDByIndex(cat), true))
				continue;
@


1.187
log
@Fixed bad "assign category" menu code.
@
text
@d1551 1
a1551 1
				g_eMuleApp.m_pDownloadQueue->SetCatPrio(CCat::GetCatIDByIndex(cat),prio);
d4370 1
a4370 1
			preselect = CCat::CatIndexToUserCatIndex(CCat::GetCatIndexByID(found_file->GetCatID()));
d4375 1
a4375 1
			tempBuff4 = CCat::GetCatByIndex(CCat::UserCatIndexToCatIndex(i))->GetTitle();
d4385 1
a4385 1
		CString	strCategory = (i == 0)? GetResString(IDS_CAT_UNASSIGN) : CCat::GetCatByIndex(CCat::UserCatIndexToCatIndex(i))->GetTitle();
@


1.186
log
@Formatting, comments, and name changes.
@
text
@d4361 2
a4362 1
	for (int i=0;i< CCat::GetNumCats();i++)
d4368 2
a4369 1
		if(found_file)
d4375 1
a4375 4
			if (i < CCat::GetNumPredefinedCats())
				tempBuff4 = CCat::GetPredefinedCatTitle(CCat::GetCatIDByIndex(i));
			else
				tempBuff4 = CCat::GetCatByIndex(i)->GetTitle();
d4385 1
a4385 1
		CString	strCategory = (i == 0)? GetResString(IDS_CAT_UNASSIGN):CCat::GetCatByIndex(CCat::UserCatIndexToCatIndex(i))->GetTitle();
@


1.185
log
@Fixed showing All cat on WS when filter applied in GUI
@
text
@d1920 1
a1920 1
		for (POSITION pos=g_eMuleApp.m_pDownloadQueue->filelist.GetHeadPosition(); pos != 0; g_eMuleApp.m_pDownloadQueue->filelist.GetNext(pos))
d1922 1
a1922 1
			CPartFile* cur_file = g_eMuleApp.m_pDownloadQueue->filelist.GetAt(pos);
@


1.184
log
@Please DO NOT use hardcoded values, especially when symbolic values are already provided.
@
text
@d1982 1
a1982 1
			if (!CCat::FileBelongsToGivenCat(cur_file,(cat>CAT_PREDEFINED)? cat:CCat::GetCatIDByIndex(cat)))
@


1.183
log
@Another code fix for categories on WS
@
text
@d1982 1
a1982 1
			if (!CCat::FileBelongsToGivenCat(cur_file,(cat>100)? cat:CCat::GetCatIDByIndex(cat)))
d4335 2
a4336 2
			strI.Format(_T("%d"),i+100);
			if ((i+100)==preselect)
d4397 1
a4397 1
	CString sPlain = CCat::GetPredefinedCatTitle(cat+100);
@


1.182
log
@format large numbers with thousands dots (asked by purity)
@
text
@d4120 6
a4125 1
			g_eMuleApp.m_pSearchList->AddFileToDownloadByHash(fileid,cat);
@


1.181
log
@Last WS fixes for categories
@
text
@d844 1
a844 1
		_stprintf(HTTPHeader, _T("%i"), cur_server->GetUsers());
d846 1
a846 1
		_stprintf(HTTPHeader, _T("%i"), cur_server->GetMaxUsers());
d848 1
a848 1
		_stprintf(HTTPHeader, _T("%i"), cur_server->GetFiles());
d850 4
a853 1
		_stprintf(HTTPHeader, _T("%.1f "), ((float)cur_server->GetUsers() / cur_server->GetMaxUsers()) * 100);
d871 1
a871 1
	HTTPHelp.Format(_T("%i"), allUsers);
d873 1
a873 1
	HTTPHelp.Format(_T("%i"), allFiles);
d1402 1
a1402 1
					sT.Format(_T("%d (%d)"), ServerArray[i].nServerUsers, ServerArray[i].nServerMaxUsers);
d1404 1
a1404 1
					sT.Format(_T("%d"), ServerArray[i].nServerUsers);
d1412 1
a1412 1
				sT.Format(_T("%d"), ServerArray[i].nServerFiles);
d1426 2
a1427 2
			CString sSoftLimit; sSoftLimit.Format(_T("%d"), ServerArray[i].nServerSoftLimit);
			CString sHardLimit; sHardLimit.Format(_T("%d"), ServerArray[i].nServerHardLimit);
@


1.180
log
@Fixes to categories in WebServer (adding from Search & Ed2k link still isn't fixed)
@
text
@d197 1
a197 1
	if(nStart != -1 && nEnd != -1 && nStart<nEnd) //(0.29b)
a274 1
//+++
a295 1
//+++
a371 1
	//(0.29b) //DonQ - additional filetypes
d378 1
a378 1
	// DonGato: expire images after 1 year (overridable by browser)
d382 1
a382 1
	t += 60*60*24*365;
d391 1
a391 1
	if(file.Open(filename, CFile::modeRead|CFile::shareDenyWrite|CFile::typeBinary)) //(0.29b)
d445 2
a446 1
	}//End Johnny-B
a514 1
		//_RemoveSession(Data, lSession);
a517 1
		//_RemoveSession(Data, lSession);
d635 1
a635 1
	CoUninitialize(); //(0.29b)
d803 2
a804 2
	Out.Replace(_T("[ConfirmJumpstart]"), _GetPlainResString(IDS_JS_DISABLE, true) + _T("\\n"));//+++
	Out.Replace(_T("[Jumpstart]"), _GetPlainResString(IDS_PRIOJUMPSTART, true));//+++
d1367 1
a1367 1
		HTTPProcessData.Replace(_T("[server-priority]"), srvpriority); //DonGato: priority change
d1485 5
a1489 2
	if (bAdmin && !HTTPTemp.IsEmpty()) 
		g_eMuleApp.m_pdlgEmule->m_dlgSearch.AddEd2kLinksToDownload(HTTPTemp,cat);
d1536 1
d1538 2
a1539 4
			if(sPrio.CompareNoCase(_T("low")) == 0) 
			{
				g_eMuleApp.m_pDownloadQueue->SetCatPrio(cat,PR_LOW);
			}
d1541 1
a1541 3
			{
				g_eMuleApp.m_pDownloadQueue->SetCatPrio(cat,PR_NORMAL);
			}
d1543 1
a1543 3
			{
				g_eMuleApp.m_pDownloadQueue->SetCatPrio(cat,PR_HIGH);
			}
d1545 7
a1551 3
			{
				g_eMuleApp.m_pDownloadQueue->SetCatPrio(cat,PR_AUTO);
			}
a1561 1
 		//unsafe _GetFileHash(_ParseURL(Data.sURL, _T("file")), FileHash);
d1634 1
a1634 1
		}	//if(found_file) pre-check
d1953 1
a1953 1
			dFile.sFileNameJS = _SpecialChars(cur_file->GetFileName(), true);	//for javascript
d1979 2
a1980 25
			if (cat>0 && cur_file->GetCatID()!=cat) continue;
			if (cat<0) {
			//	BUG: Believe these need to be CAT_PREDEFINED+
				switch (cat) {
					case -1 : if (cur_file->GetCatID()!=0) continue; break;
					case -2 : if (!cur_file->IsPartFile()) continue; break;
					case -3 : if (cur_file->IsPartFile()) continue; break;
					case -4 : if (!((cur_file->GetStatus()==PS_READY|| cur_file->GetStatus()==PS_EMPTY) && cur_file->GetTransferringSrcCount()==0)) continue; break;
					case -5 : if (!((cur_file->GetStatus()==PS_READY|| cur_file->GetStatus()==PS_EMPTY) && cur_file->GetTransferringSrcCount()>0)) continue; break;
					case -6 : if (cur_file->GetStatus()!=PS_ERROR) continue; break;
					case -7 : if (cur_file->GetStatus()!=PS_PAUSED) continue; break;
					case -8 : if (cur_file->GetStatus()!=PS_STOPPED) continue; break;
					
					case -9 : if (!((cur_file->GetStatus()==PS_READY || cur_file->GetStatus()==PS_EMPTY)
							&& cur_file->GetTransferringSrcCount() == 0
							&& cur_file->IsStalled())) continue; break;
					case -10 : if (!((cur_file->GetStatus()==PS_READY || cur_file->GetStatus()==PS_EMPTY)
							&& (cur_file->GetTransferringSrcCount() > 0 || cur_file->GetOnQueueSrcCount() != 0) )) continue; break;
					
					case -11 : if (!cur_file->IsMovie()) continue; break;
					case -12 : if (ED2KFT_AUDIO != GetED2KFileTypeID(cur_file->GetFileName())) continue; break;
					case -13 : if (!cur_file->IsArchive()) continue; break;
					case -14 : if (ED2KFT_CDIMAGE != GetED2KFileTypeID(cur_file->GetFileName())) continue; break;
				}
			}
a2125 1
//	CArray<QueueUsers, QueueUsers> QueueArray;
a2862 1
	//+++
a3093 1
			// removed: dFile.sFilePriority = buffer;
d3233 1
a3233 1
			isjumpstart.Format(_T("jumpstart"));//+++
d3248 1
a3248 1
		HTTPProcessData.Replace(_T("[isjumpstart]"), isjumpstart);//+++
a4059 2
	//CKnownFile* known_file=g_eMuleApp.m_pKnownFilesList->FindKnownFileByID(fileid);
	//if (known_file && !known_file->IsPartFile()) {
a4067 1
		//cur_file=g_eMuleApp.m_pDownloadQueue->GetFileByID(fileid);
d4287 2
a4288 2
			tempBuf3= ( (-i)==preselect)? " selected":"";
			tempBuf2.Format("<option%s value=\"%i\">%s</option>",tempBuf3,-i, GetSubCatLabel(-i));
a4294 1

d4327 2
a4328 2
			strI.Format(_T("%d"),i);
			if ((-i)==preselect)
d4331 1
a4331 1
				tempBuff4 = GetSubCatLabel(-i);
d4336 1
a4336 1
			tempBuff2 = CString("<a href=&quot;/?ses=" + sSession + "&w=transfer&cat=-"); 
d4341 1
a4341 1
			tempBuff2+= GetSubCatLabel(-i);
d4389 6
a4394 18
	switch (cat)
	{
		case -1: return _GetPlainResString(IDS_CAT_UNCATEGORIZED);
		case -2: return _GetPlainResString(IDS_CAT_INCOMPLETE);
		case -3: return _GetPlainResString(IDS_CAT_COMPLETED);
		case -4: return _GetPlainResString(IDS_CAT_WAITING);
		case -5: return _GetPlainResString(IDS_CAT_DOWNLOADING);
		case -6: return _GetPlainResString(IDS_CAT_ERRONEOUS);
		case -7: return _GetPlainResString(IDS_CAT_PAUSED);
		case -8: return _GetPlainResString(IDS_CAT_STOPPED);
		case -9: return _GetPlainResString(IDS_CAT_STALLED);
		case -10: return _GetPlainResString(IDS_CAT_ACTIVE);
		case -11: return _GetPlainResString(IDS_CAT_VIDEO);
		case -12: return _GetPlainResString(IDS_CAT_AUDIO);
		case -13: return _GetPlainResString(IDS_CAT_ARCHIVES);
		case -14: return _GetPlainResString(IDS_CAT_CDIMAGES);
	}
	return "?";
@


1.179
log
@Fixed "Crash on entering Transfer window with a completed file".
@
text
@d1627 9
a1635 1
				found_file->SetCatID(CCat::GetCatIDByIndex(iMenu));
d4137 1
a4137 1
	if (_ParseURL(Data.sURL, _T("downloads")) != "" && IsSessionAdmin(Data,sSession) ) {
d4139 1
d4301 1
a4301 1
	for (int i=0;i< CCat::GetNumUserCats();i++)
d4303 1
a4303 1
		CString strCategory = (i==0)?_GetPlainResString(IDS_CAT_UNCATEGORIZED):CCat::GetUserCatByIndex(i-1)->GetTitle();
d4393 1
a4393 1
			preselect = found_file->GetCatID();
d4411 1
a4411 1
		CString		strCategory = (i < CCat::GetNumPredefinedCats()) ? CCat::GetPredefinedCatTitle(CCat::GetCatIDByIndex(i)) : CCat::GetCatByIndex(i)->GetTitle(); 
d4426 12
a4437 14
		case -3: return _GetPlainResString(IDS_DL_TRANSFCOMPL);
		case -4: return _GetPlainResString(IDS_WAITING);
		case -5: return _GetPlainResString(IDS_DOWNLOADING);
		case -6: return _GetPlainResString(IDS_ERRORLIKE);
		case -7: return _GetPlainResString(IDS_PAUSED);
		case -8: return _GetPlainResString(IDS_STOPPED);
		
		case -9: return _GetPlainResString(IDS_STALLED);
		case -10: return _GetPlainResString(IDS_ST_ACTIVE);
		
		case -11: return _GetPlainResString(IDS_VIDEO);
		case -12: return _GetPlainResString(IDS_AUDIO);
		case -13: return _GetPlainResString(IDS_SEARCH_ARC);
		case -14: return _GetPlainResString(IDS_SEARCH_CDIMG);
a4438 1

@


1.178
log
@webserver - added stalled and active filters and pause in action menu
@
text
@d2256 2
a2257 1
		if(FilesArray[i].lFileSpeed > 0)
d2259 1
d2262 1
a2262 1
			if (found_file->GetPartfileStatusID() == PS_STALLED)
d2265 1
a2265 1
			state.Format(_T("waiting"));
@


1.177
log
@Formatting, comments, and name changes.
@
text
@d798 1
d1584 4
d1986 11
a1996 4
					case -9 : if (!cur_file->IsMovie()) continue; break;
					case -10 : if (ED2KFT_AUDIO != GetED2KFileTypeID(cur_file->GetFileName())) continue; break;
					case -11 : if (!cur_file->IsArchive()) continue; break;
					case -12 : if (ED2KFT_CDIMAGE != GetED2KFileTypeID(cur_file->GetFileName())) continue; break;
d4306 1
a4306 1
		for (int i=(CCat::GetNumCats()>1)?1:2;i<=12;i++)
d4347 1
a4347 1
		for (int i=(CCat::GetNumCats()>1)?1:2;i<=12;i++)
d4413 2
a4414 2
		case -1: return _GetPlainResString(IDS_ALLOTHERS);
		case -2: return _GetPlainResString(IDS_STATUS_NOTCOMPLETED);
d4421 8
a4428 4
		case -9: return _GetPlainResString(IDS_VIDEO);
		case -10: return _GetPlainResString(IDS_AUDIO);
		case -11: return _GetPlainResString(IDS_SEARCH_ARC);
		case -12: return _GetPlainResString(IDS_SEARCH_CDIMG);
@


1.176
log
@separated stopped from paused in webserver
@
text
@d1191 1
a1191 1
	CServer* tempServer;
@


1.175
log
@Fixed a NEW_SOCKETS compiler warning.
@
text
@d2270 6
a2275 1
			case PS_STOPPED:	
@


1.174
log
@Version change (to not forget during release)
@
text
@d1190 1
d1192 1
@


1.173
log
@webserver bugfix - missing values in action menu
@
text
@d20 1
a20 1
#define WEB_SERVER_TEMPLATES_VERSION	1001
@


1.172
log
@Category rewrite with predefined status/media type categories.
@
text
@d2274 9
a2282 5
				{
					CString JSfileinfo=FilesArray[i].sFileInfo;
					JSfileinfo.Replace(_T("\n"),_T("\\n"));
					JSfileinfo.Replace(_T("%"),_T("%%"));
					JSfileinfo.Replace(_T("'"),_T("&#8217;")); // EC 22/5 - Chararacter ' causes a problem in javascript:alert()
d2284 2
a2285 2
					CString JSED2kLink=FilesArray[i].sED2kLink;
					JSED2kLink.Replace(_T("'"),_T("&#8217;"));
d2287 5
a2291 5
					finfo.Format(JSfileinfo);
					ed2k.Format(JSED2kLink);
					fname.Format(FilesArray[i].sFileNameJS);
					session.Format(CString(sSession));
					filehash.Format(FilesArray[i].sFileHash);
d2293 2
a2294 2
					if (FilesArray[i].bCompress && !bIsComplete)
						scb.Format(_T("scb"));
d2296 3
a2298 5
					if (g_eMuleApp.m_pDownloadQueue->GetA4AFAutoFile() == found_file && !bIsComplete)
						autoa4af.Format(_T("autoa4af"));
				}
				break;
		}	//switch
@


1.171
log
@A little more method factoring, a few name changes, no (intended) logic changes.
@
text
@d1620 1
a1620 1
				found_file->SetCategory(iMenu);
d1950 3
a1952 1
			CString strCategory = (cur_file->GetCategory()!=0)?g_eMuleApp.m_pGlobPrefs->GetCategory(cur_file->GetCategory())->title:GetResString(IDS_ALLOTHERS);
d1967 1
a1967 1
			if (cat>0 && cur_file->GetCategory()!=cat) continue;
d1969 1
d1971 1
a1971 1
					case -1 : if (cur_file->GetCategory()!=0) continue; break;
d4161 1
a4161 1
	if (g_eMuleApp.m_pGlobPrefs->GetCatCount()>1) InsertCatBox(Out,0,"",false,false,sSession,""); else Out.Replace("[CATBOX]","");
d4269 1
a4269 1
	for (int i=0;i< g_eMuleApp.m_pGlobPrefs->GetCatCount();i++)
d4271 1
a4271 1
		CString strCategory = (i==0)?_GetPlainResString(IDS_ALLOTHERS):g_eMuleApp.m_pGlobPrefs->GetCategory(i)->title;
d4279 1
a4279 1
		if (g_eMuleApp.m_pGlobPrefs->GetCatCount()>1)
d4285 1
a4285 1
		for (int i=(g_eMuleApp.m_pGlobPrefs->GetCatCount()>1)?1:2;i<=12;i++)
d4299 1
a4299 1
	for (int i=0;i< g_eMuleApp.m_pGlobPrefs->GetCatCount();i++)
d4305 2
a4306 2
			if (i==0)
				tempBuff4 = _GetPlainResString(IDS_ALL);
d4308 1
a4308 1
				tempBuff4 = g_eMuleApp.m_pGlobPrefs->GetCategory(i)->title;
d4318 1
a4318 1
		CString strCategory = (i==0)?_GetPlainResString(IDS_ALL):g_eMuleApp.m_pGlobPrefs->GetCategory(i)->title;
d4326 1
a4326 1
		for (int i=(g_eMuleApp.m_pGlobPrefs->GetCatCount()>1)?1:2;i<=12;i++)
d4354 1
a4354 1
	for (int i=0;i< g_eMuleApp.m_pGlobPrefs->GetCatCount();i++)
d4361 1
a4361 1
			preselect = found_file->GetCategory();
d4366 2
a4367 2
			if (i==0)
				tempBuff4 = _GetPlainResString(IDS_ALLOTHERS);
d4369 1
a4369 1
				tempBuff4 = g_eMuleApp.m_pGlobPrefs->GetCategory(i)->title;
d4379 1
a4379 1
		CString strCategory = (i==0)?_GetPlainResString(IDS_ALLOTHERS):g_eMuleApp.m_pGlobPrefs->GetCategory(i)->title;
@


1.170
log
@Removed all #ifndef AMDs and consolidated CPU specific behavior in md4cpy() and new method memcpy2() (come up with a better name if you can :P ).
@
text
@d575 1
a575 1
		if (sPage == "m_strDebugLog") 
d738 1
a738 1
			(sPage == "m_strDebugLog") ||
@


1.169
log
@stalled filestate and filetype icons in webserver
@
text
@d2246 1
a2246 1
				state.Format(_T("waiting"));
d3058 1
a3058 1
		
@


1.168
log
@changed back wrongly renamed filename of ipfilter.dat and folder of webserver icons
@
text
@d1920 21
d2242 6
a2247 1
			state.Format(_T("waiting"));
d2264 1
d2269 1
d2335 2
d3021 23
d3058 1
a3058 1

d3251 1
@


1.167
log
@More name changes, reinstated CMuleCtrlItem class, moved srcsarevisible from CPartFile to CMuleCtrlItem (where it belongs), added "Show Full Status Icons" and "Show Gray Paused" features with corresponding preferences, modified "SmartOpen" code to make it sticky and to make it work with sources with changing states.
@
text
@d392 1
a392 1
	filename=CString(g_eMuleApp.m_pGlobPrefs->GetAppDir())+_T("pWebServer\\")+filename;
@


1.166
log
@First batch of the threatened name changes. Shouldn't be any logic changes here.
@
text
@d3 1
a3 1
#include "webserver.h"
d81 3
a83 3
	if (theApp.glob_prefs->GetTemplate()=="" || theApp.glob_prefs->GetTemplate().MakeLower()=="emule.tmpl")
		sFile= theApp.glob_prefs->GetAppDir() + CString("eMule.tmpl");
	else sFile=theApp.glob_prefs->GetTemplate();
d103 1
a103 1
			if(theApp.glob_prefs->GetWSIsEnabled() || m_bServerWorking)
d108 1
a108 1
			theApp.glob_prefs->SetWSIsEnabled(false);
d168 1
a168 1
			theApp.glob_prefs->SetWSIsEnabled(false);
d185 1
a185 1
	fullpath.Format(_T("%spreferences.ini"),theApp.glob_prefs->GetConfigDir());
d223 2
a224 2
	if(m_bServerWorking != theApp.glob_prefs->GetWSIsEnabled())
		m_bServerWorking = theApp.glob_prefs->GetWSIsEnabled();
d237 1
a237 1
	if(theApp.glob_prefs->GetWSIsEnabled() && m_bServerWorking)
d249 2
a250 2
	CServer* server=theApp.serverlist->GetServerByAddress(sIP.GetBuffer(), nPort);
	if (server!=NULL) theApp.emuledlg->SendMessage(WEB_REMOVE_SERVER, (WPARAM)server, NULL);
d259 2
a260 2
	CServer* server=theApp.serverlist->GetServerByAddress(sIP.GetBuffer(), nPort);
	if (server!=NULL) theApp.emuledlg->SendMessage(WEB_ADD_TO_STATIC, (WPARAM)server, NULL);
d269 2
a270 2
	CServer* server=theApp.serverlist->GetServerByAddress(sIP.GetBuffer(), nPort);
	if (server!=NULL) theApp.emuledlg->SendMessage(WEB_REMOVE_FROM_STATIC, (WPARAM)server, NULL);
d284 1
a284 1
	cur_file=theApp.sharedfiles->GetFileByID(fileid);
d292 1
a292 1
	theApp.sharedfiles->UpdateItem(cur_file);
d306 1
a306 1
	cur_file=theApp.sharedfiles->GetFileByID(fileid);
d314 1
a314 1
	theApp.sharedfiles->UpdateItem(cur_file);
d354 2
a355 2
	CServer* server=theApp.serverlist->GetServerByAddress(sIP.GetBuffer(), nPort);
	if (server!=NULL) theApp.emuledlg->SendMessage(WEB_CONNECT_TO_SERVER, (WPARAM)server, NULL);
d392 1
a392 1
	filename=CString(theApp.glob_prefs->GetAppDir())+_T("webserver\\")+filename;
d414 1
a414 1
	SetThreadLocale(theApp.glob_prefs->GetLanguageID());
d418 1
a418 1
	// data without any syncronization!! Either we use the message pump for emuledlg
d425 1
a425 1
	bool isUseGzip = theApp.glob_prefs->GetWebUseGzip();
d443 1
a443 1
	((dwCurTick - pThis->m_nStartTempDisabledTime) > (theApp.glob_prefs->GetWSTempDisableLogin() * 60000)))
d457 1
a457 1
		if(MD5Sum(_ParseURL(Data.sURL, _T("p"))).GetHash() == theApp.glob_prefs->GetWSPass())
d467 1
a467 1
		else if(theApp.glob_prefs->GetWSIsLowUserEnabled() && theApp.glob_prefs->GetWSLowPass()!="" && MD5Sum(_ParseURL(Data.sURL, _T("p"))).GetHash() == theApp.glob_prefs->GetWSLowPass())
d476 1
a476 1
		} else if(theApp.glob_prefs->IsWSIntruderDetectionEnabled())
d479 2
a480 2
				AddLogLine(true,IDS_WEB_INTRTRIESLEFT,t_ulCurIP,theApp.glob_prefs->GetWSLoginAttemptsAllowed()-(pThis->m_nIntruderDetect));
				if (pThis->m_nIntruderDetect == theApp.glob_prefs->GetWSLoginAttemptsAllowed()){
d482 1
a482 1
				if (theApp.glob_prefs->GetWSTempDisableLogin() > 0)
d486 1
a486 1
					pThis->AddLogLine(true,IDS_WEB_INTRBLOCKTIME, theApp.glob_prefs->GetWSTempDisableLogin());
d490 3
a492 3
					MessageText.Format(GetResString(IDS_WEB_INTRBLOCKTIME), theApp.glob_prefs->GetWSTempDisableLogin());
					theApp.smtpconnection->SendMail(MessageText, theApp.glob_prefs->GetNotifierPopOnWebServerError(), theApp.glob_prefs->IsSMTPWarningEnabled());
	                theApp.emuledlg->ShowNotifier(MessageText, TBN_WEBSERVER, false, theApp.glob_prefs->GetNotifierPopOnWebServerError());
d494 1
a494 1
					theApp.glob_prefs->SetWSIsEnabled(false);
d502 2
a503 2
					theApp.smtpconnection->SendMail(MessageText, theApp.glob_prefs->GetNotifierPopOnWebServerError(), theApp.glob_prefs->IsSMTPWarningEnabled());
	                theApp.emuledlg->ShowNotifier(MessageText, TBN_WEBSERVER, false, theApp.glob_prefs->GetNotifierPopOnWebServerError());
d518 2
a519 2
		theApp.m_app_state = theApp.APP_STATE_SHUTINGDOWN;
		SendMessage(theApp.emuledlg->m_hWnd,WM_CLOSE,0,0);
d575 1
a575 1
		if (sPage == "debuglog") 
d730 1
a730 1
	if(theApp.glob_prefs->GetWebPageRefresh() != 0)
d738 1
a738 1
			(sPage == "debuglog") ||
d742 1
a742 1
			CString sRefresh; sRefresh.Format(_T("%d"), theApp.glob_prefs->GetWebPageRefresh());
d832 1
a832 1
	if ((theApp.serverconnect->IsConnecting() && !disconnectissued) || connectissued) { 
d836 1
a836 1
	else if (theApp.serverconnect->IsConnected() && !disconnectissued) 
d838 1
a838 1
		if(!theApp.serverconnect->IsLowID())
d842 1
a842 1
		CServer* cur_server = theApp.serverconnect->GetCurrentServer();
d865 1
a865 1
	for (uint32 sc=0;sc<theApp.serverlist->GetServerCount();sc++)
d867 1
a867 1
		CServer* cur_server = theApp.serverlist->GetServerAt(sc);
d877 2
a878 2
	if(theApp.glob_prefs->GetMaxUpload() == UNLIMITED)
		_stprintf(HTTPHeader, "%.1f", ((float)theApp.uploadqueue->GetDataRate()/1024)/(theApp.glob_prefs->GetMaxGraphUploadRate())*100); 
d880 1
a880 1
		_stprintf(HTTPHeader, "%.1f", ((float)theApp.uploadqueue->GetDataRate()/1024)/(theApp.glob_prefs->GetMaxUpload())*100); 
d883 2
a884 2
	if(theApp.glob_prefs->GetMaxDownload() == UNLIMITED)
		_stprintf(HTTPHeader, "%.1f", ((float)theApp.downloadqueue->GetDataRate()/1024)/(theApp.glob_prefs->GetMaxGraphDownloadRate())*100);
d886 1
a886 1
		_stprintf(HTTPHeader, "%.1f", ((float)theApp.downloadqueue->GetDataRate()/1024)/(theApp.glob_prefs->GetMaxDownload())*100);
d889 1
a889 1
	_stprintf(HTTPHeader, "%.1f", ((float)theApp.listensocket->GetOpenSockets())/(theApp.glob_prefs->GetMaxConnections())*100);
d891 1
a891 1
	_stprintf(HTTPHeader, "%.1f", ((float)theApp.uploadqueue->GetDataRate()/1024)); 
d893 1
a893 1
	_stprintf(HTTPHeader, "%.1f", ((float)theApp.downloadqueue->GetDataRate()/1024));
d895 1
a895 1
	_stprintf(HTTPHeader, "%.0f", ((float)theApp.listensocket->GetOpenSockets()));
d898 1
a898 1
	HTTPHelp.Format(_T("%i"),theApp.glob_prefs->GetMaxUpload());
d901 1
a901 1
	HTTPHelp.Format(_T("%i"),theApp.glob_prefs->GetMaxDownload());
d904 1
a904 1
	HTTPHelp.Format(_T("%i"),theApp.glob_prefs->GetMaxConnections());
d961 1
a961 1
			theApp.emuledlg->SendMessage(WM_COMMAND, MP_CONNECT);
d968 1
a968 1
		if (theApp.serverconnect->IsConnecting())
d970 2
a971 2
			theApp.serverconnect->StopConnectionTry();
			theApp.emuledlg->ShowConnectionState(false);
d975 1
a975 1
			theApp.emuledlg->SendMessage(WM_COMMAND, MP_DISCONNECT);
d996 1
a996 1
			CServer* server=theApp.serverlist->GetServerByAddress(sIP.GetBuffer(), nPort);
d998 2
a999 2
			if (theApp.emuledlg->serverwnd) 
				theApp.emuledlg->serverwnd.serverlistctrl.RefreshServer(*server);
d1006 1
a1006 1
			CServer* server=theApp.serverlist->GetServerByAddress(sIP.GetBuffer(), nPort);
d1008 2
a1009 2
			if (theApp.emuledlg->serverwnd) 
				theApp.emuledlg->serverwnd.serverlistctrl.RefreshServer(*server);
d1016 1
a1016 1
			CServer* server=theApp.serverlist->GetServerByAddress(sIP.GetBuffer(), nPort);
d1018 2
a1019 2
			if (theApp.emuledlg->serverwnd) 
				theApp.emuledlg->serverwnd.serverlistctrl.RefreshServer(*server);
d1029 1
a1029 1
		fullpath.Format(_T("%spreferences.ini"),theApp.glob_prefs->GetConfigDir());
d1192 1
a1192 1
	for (uint32 sc=0;sc<theApp.serverlist->GetServerCount();sc++)
d1194 1
a1194 1
		CServer* cur_file = theApp.serverlist->GetServerAt(sc);
d1231 2
a1232 2
		if (theApp.serverconnect->IsConnecting()) { 
			tempServer = theApp.serverconnect->GetConnectingServer();
d1238 2
a1239 2
		else if (theApp.serverconnect->IsConnected()) {
			tempServer = theApp.serverconnect->GetCurrentServer();
d1241 1
a1241 1
				if (!theApp.serverconnect->IsLowID())  
d1476 1
a1476 1
			theApp.emuledlg->transferwnd.m_wndDownloadList.ClearCompleted();
d1480 1
a1480 1
				theApp.emuledlg->transferwnd.m_wndDownloadList.ClearCompleted(FileHash);
d1487 1
a1487 1
		theApp.emuledlg->searchwnd.AddEd2kLinksToDownload(HTTPTemp,cat);
d1500 1
a1500 1
		fullpath.Format(_T("%spreferences.ini"),theApp.glob_prefs->GetConfigDir());
d1512 1
a1512 1
		fullpath.Format(_T("%spreferences.ini"),theApp.glob_prefs->GetConfigDir());
d1524 1
a1524 1
		fullpath.Format(_T("%spreferences.ini"),theApp.glob_prefs->GetConfigDir());
d1537 1
a1537 1
				theApp.downloadqueue->SetCatPrio(cat,PR_LOW);
d1541 1
a1541 1
				theApp.downloadqueue->SetCatPrio(cat,PR_NORMAL);
d1545 1
a1545 1
				theApp.downloadqueue->SetCatPrio(cat,PR_HIGH);
d1549 1
a1549 1
				theApp.downloadqueue->SetCatPrio(cat,PR_AUTO);
d1562 1
a1562 1
		CPartFile* found_file = theApp.downloadqueue->GetFileByID(FileHash);
d1571 1
a1571 1
				theApp.downloadqueue->SetA4AFAutoFile(found_file); // Purity: Auto-A4AF
d1575 1
a1575 1
				theApp.downloadqueue->SetA4AFAutoFile(NULL); // Purity: Auto-A4AF
d1626 1
a1626 1
		CUpDownClient* cur_client = theApp.clientlist->FindClientByUserHash(UserHash);
d1631 1
a1631 1
				theApp.friendlist->AddFriend(cur_client);
d1635 1
a1635 1
				theApp.friendlist->RemoveFriend(cur_client);
d1901 1
a1901 1
	if (!theApp.emuledlg->transferwnd.m_wndDownloadList.GetDisplayedFiles(&partlist))	//failsafe
d1905 1
a1905 1
		for (POSITION pos=theApp.downloadqueue->filelist.GetHeadPosition(); pos != 0; theApp.downloadqueue->filelist.GetNext(pos))
d1907 1
a1907 1
			CPartFile* cur_file = theApp.downloadqueue->filelist.GetAt(pos);
d1929 1
a1929 1
			CString strCategory = (cur_file->GetCategory()!=0)?theApp.glob_prefs->GetCategory(cur_file->GetCategory())->title:GetResString(IDS_ALLOTHERS);
d1938 1
a1938 1
			if (theApp.serverconnect->IsConnected() && !theApp.serverconnect->IsLowID())
d2015 1
a2015 1
	for (POSITION pos = theApp.uploadqueue->uploadinglist.GetHeadPosition(); pos != 0;theApp.uploadqueue->uploadinglist.GetNext(pos))
d2017 1
a2017 1
		CUpDownClient* cur_client = theApp.uploadqueue->uploadinglist.GetAt(pos);
d2045 1
a2045 1
		CKnownFile* file = theApp.sharedfiles->GetFileByID(cur_client->reqfileid);
d2108 1
a2108 1
	for (POSITION pos = theApp.uploadqueue->waitinglist.GetHeadPosition(); pos != 0;theApp.uploadqueue->waitinglist.GetNext(pos))
d2110 1
a2110 1
		CUpDownClient* cur_client = theApp.uploadqueue->waitinglist.GetAt(pos);
d2145 1
a2145 1
		CKnownFile* file = theApp.sharedfiles->GetFileByID(cur_client->reqfileid);
d2216 1
a2216 1
		CPartFile* found_file = theApp.downloadqueue->GetFileByID(FileHashA4AF);
d2261 1
a2261 1
					if (theApp.downloadqueue->GetA4AFAutoFile() == found_file && !bIsComplete)
d2307 1
a2307 1
		if (theApp.downloadqueue->GetA4AFAutoFile() == found_file && !bIsComplete)
d2787 1
a2787 1
		cur_file=theApp.sharedfiles->GetFileByID(fileid);
d2822 1
a2822 1
			theApp.sharedfiles->UpdateItem(cur_file); // DonGato: refresh GUI on priority change
d2835 1
a2835 1
		fullpath.Format(_T("%spreferences.ini"),theApp.glob_prefs->GetConfigDir());
d2846 1
a2846 1
		theApp.emuledlg->SendMessage(WEB_SHARED_FILES_RELOAD);
d2926 1
a2926 1
		CString resultlog = _SpecialChars(theApp.emuledlg->logtext);	//Pick-up last line of the log
d2979 1
a2979 1
	for (POSITION pos = theApp.sharedfiles->m_Files_map.GetStartPosition();pos != 0;)
d2985 1
a2985 1
		theApp.sharedfiles->m_Files_map.GetNextAssoc(pos,bufKey,cur_file);
d2993 1
a2993 1
		if (theApp.serverconnect->IsConnected()) 
d3170 1
a3170 1
		cur_file=theApp.sharedfiles->GetFileByID(fileid);
d3302 1
a3302 1
	sScale.Format(_T("%s"), CastSecondsToHM(theApp.glob_prefs->GetTrafficOMeterInterval() * WEB_GRAPH_WIDTH) );
d3305 3
a3307 3
	s1.Format(_T("%d"), theApp.glob_prefs->GetMaxGraphDownloadRate() + 4);
	s2.Format(_T("%d"), theApp.glob_prefs->GetMaxGraphUploadRate() + 4);
	s3.Format(_T("%d"), theApp.glob_prefs->GetMaxConnections());
d3338 2
a3339 2
			theApp.emuledlg->serverwnd.AddServer(_ParseURL(Data.sURL, _T("serveraddr")),_ParseURL(Data.sURL, _T("serverport")),_ParseURL(Data.sURL, _T("servername"))); 
			CString resultlog = _SpecialChars(theApp.emuledlg->logtext);        //Pick-up last line of the log 
d3341 1
a3341 1
			CServer* server=theApp.serverlist->GetServerByAddress(_ParseURL(Data.sURL, _T("serveraddr")),atoi(_ParseURL(Data.sURL, _T("serverport"))));
d3348 2
a3349 2
			if (theApp.emuledlg->serverwnd) 
				theApp.emuledlg->serverwnd.serverlistctrl.RefreshServer(*server);
d3355 1
a3355 1
				resultlog += _SpecialChars(theApp.emuledlg->logtext);        //Pick-up last line of the log 
d3368 2
a3369 2
		theApp.emuledlg->serverwnd.UpdateServerMetFromURL(_ParseURL(Data.sURL, _T("servermeturl")));
		CString resultlog = _SpecialChars(theApp.emuledlg->logtext);
d3418 1
a3418 1
		theApp.emuledlg->ResetLog();
d3421 1
a3421 1
	Out.Replace(_T("[Log]"), _SpecialChars(theApp.emuledlg->logtext));
d3445 1
a3445 1
		theApp.emuledlg->serverwnd.servermsgbox.SetWindowText(_T(""));
d3448 1
a3448 1
	Out.Replace(_T("[ServerInfo]"), _SpecialChars(theApp.emuledlg->serverwnd.servermsgbox.GetHyperText()->GetText()));
d3472 1
a3472 1
		theApp.emuledlg->ResetDebugLog();
d3475 1
a3475 1
	Out.Replace(_T("[DebugLog]"), _SpecialChars(theApp.emuledlg->debuglog));
d3496 2
a3497 2
	theApp.emuledlg->ShowStatistics();
	theApp.emuledlg->statisticswnd.ShowStatistics(true);
d3501 1
a3501 1
	Out.Replace(_T("[Stats]"), theApp.emuledlg->statisticswnd.stattree.GetHTMLForExport());
d3526 1
a3526 1
		    theApp.glob_prefs->SetWebUseGzip(true);
d3530 1
a3530 1
		    theApp.glob_prefs->SetWebUseGzip(false);
d3550 1
a3550 1
		    theApp.glob_prefs->SetWebPageRefresh(_tstoi(_ParseURL(Data.sURL, _T("refresh"))));
d3556 2
a3557 2
				theApp.glob_prefs->SetMaxDownload(_tstoi(_ParseURL(Data.sURL, _T("maxdown"))));
				theApp.glob_prefs->SetLimitlessDownload(false);	//SyruS disable limitless on setting a specific value
d3560 1
a3560 1
				theApp.glob_prefs->SetLimitlessDownload(true);	//SyruS enable limitless on setting to 0
d3565 1
a3565 1
			    theApp.glob_prefs->SetMaxUpload(_tstoi(_ParseURL(Data.sURL, _T("maxup"))));
d3567 1
a3567 1
//			    theApp.glob_prefs->SetMaxUpload(UNLIMITED);
d3571 1
a3571 1
		    theApp.glob_prefs->SetMaxGraphDownloadRate(_tstoi(_ParseURL(Data.sURL, _T("maxcapdown"))));
d3575 1
a3575 1
		    theApp.glob_prefs->SetMaxGraphUploadRate(_tstoi(_ParseURL(Data.sURL, _T("maxcapup"))));
d3580 1
a3580 1
			theApp.glob_prefs->SetMaxSourcePerFile(_tstoi(_ParseURL(Data.sURL, _T("maxsources"))));
d3584 1
a3584 1
			theApp.glob_prefs->SetMaxConnections(_tstoi(_ParseURL(Data.sURL, _T("maxconnections"))));
d3588 1
a3588 1
			theApp.glob_prefs->SetMaxDownloadConperFive(_tstoi(_ParseURL(Data.sURL, _T("maxconnectionsperfive"))));
d3593 1
a3593 1
	if(theApp.glob_prefs->GetWebUseGzip())
d3635 1
a3635 1
	sRefresh.Format(_T("%d"), theApp.glob_prefs->GetWebPageRefresh());
d3638 1
a3638 1
	sRefresh.Format(_T("%d"), theApp.glob_prefs->GetMaxSourcePerFile());
d3641 1
a3641 1
	sRefresh.Format(_T("%d"), theApp.glob_prefs->GetMaxConnections());
d3644 1
a3644 1
	sRefresh.Format(_T("%d"), theApp.glob_prefs->GetMaxConperFive());
d3684 1
a3684 1
	int n = (int)theApp.glob_prefs->GetMaxDownload();
d3688 1
a3688 1
	n = (int)theApp.glob_prefs->GetMaxUpload();
d3692 1
a3692 1
	sT.Format(_T("%d"), theApp.glob_prefs->GetMaxGraphDownloadRate());
d3694 1
a3694 1
	sT.Format(_T("%d"), theApp.glob_prefs->GetMaxGraphUploadRate());
d3847 1
a3847 1
			theApp.emuledlg->AddLogLine(true,IDS_WEB_SESSIONEND,t_ulCurIP);
d3948 1
a3948 1
	switch (theApp.glob_prefs->GetLanguageID())
d4001 1
a4001 1
	//CKnownFile* known_file=theApp.knownfiles->FindKnownFileByID(fileid);
d4003 1
a4003 1
	cur_file=theApp.downloadqueue->GetFileByID(fileid); // DonGato: solve non completed files shown as complete
d4011 1
a4011 1
		//cur_file=theApp.downloadqueue->GetFileByID(fileid);
d4060 1
a4060 1
			theApp.searchlist->AddFileToDownloadByHash(fileid,cat);
d4068 2
a4069 2
		theApp.emuledlg->searchwnd.DeleteAllSearchs();
		theApp.emuledlg->searchwnd.DoNewSearch(
d4096 1
a4096 1
		fullpath.Format(_T("%spreferences.ini"),theApp.glob_prefs->GetConfigDir());
d4102 1
a4102 1
	CString result=pThis->m_Templates.sSearchHeader + theApp.searchlist->GetWebList(pThis->m_Templates.sSearchResultLine,pThis->m_iSearchSortby,pThis->m_bSearchAsc,!WSsearchColumnHidden[0],!WSsearchColumnHidden[1],!WSsearchColumnHidden[2],!WSsearchColumnHidden[3]);
d4104 1
a4104 1
	if (theApp.glob_prefs->GetCatCount()>1) InsertCatBox(Out,0,"",false,false,sSession,""); else Out.Replace("[CATBOX]","");
d4136 1
a4136 1
	if(theApp.glob_prefs->GetMethod()==1)
d4212 1
a4212 1
	for (int i=0;i< theApp.glob_prefs->GetCatCount();i++)
d4214 1
a4214 1
		CString strCategory = (i==0)?_GetPlainResString(IDS_ALLOTHERS):theApp.glob_prefs->GetCategory(i)->title;
d4222 1
a4222 1
		if (theApp.glob_prefs->GetCatCount()>1)
d4228 1
a4228 1
		for (int i=(theApp.glob_prefs->GetCatCount()>1)?1:2;i<=12;i++)
d4242 1
a4242 1
	for (int i=0;i< theApp.glob_prefs->GetCatCount();i++)
d4251 1
a4251 1
				tempBuff4 = theApp.glob_prefs->GetCategory(i)->title;
d4261 1
a4261 1
		CString strCategory = (i==0)?_GetPlainResString(IDS_ALL):theApp.glob_prefs->GetCategory(i)->title;
d4269 1
a4269 1
		for (int i=(theApp.glob_prefs->GetCatCount()>1)?1:2;i<=12;i++)
d4297 1
a4297 1
	for (int i=0;i< theApp.glob_prefs->GetCatCount();i++)
d4302 1
a4302 1
		CPartFile* found_file = theApp.downloadqueue->GetFileByID(FileHash);
d4312 1
a4312 1
				tempBuff4 = theApp.glob_prefs->GetCategory(i)->title;
d4322 1
a4322 1
		CString strCategory = (i==0)?_GetPlainResString(IDS_ALLOTHERS):theApp.glob_prefs->GetCategory(i)->title;
@


1.165
log
@rollback: quickstats width ... it's % not px :-/
@
text
@d878 1
a878 1
		_stprintf(HTTPHeader, "%.1f", ((float)theApp.uploadqueue->GetDatarate()/1024)/(theApp.glob_prefs->GetMaxGraphUploadRate())*100); 
d880 1
a880 1
		_stprintf(HTTPHeader, "%.1f", ((float)theApp.uploadqueue->GetDatarate()/1024)/(theApp.glob_prefs->GetMaxUpload())*100); 
d884 1
a884 1
		_stprintf(HTTPHeader, "%.1f", ((float)theApp.downloadqueue->GetDatarate()/1024)/(theApp.glob_prefs->GetMaxGraphDownloadRate())*100);
d886 1
a886 1
		_stprintf(HTTPHeader, "%.1f", ((float)theApp.downloadqueue->GetDatarate()/1024)/(theApp.glob_prefs->GetMaxDownload())*100);
d891 1
a891 1
	_stprintf(HTTPHeader, "%.1f", ((float)theApp.uploadqueue->GetDatarate()/1024)); 
d893 1
a893 1
	_stprintf(HTTPHeader, "%.1f", ((float)theApp.downloadqueue->GetDatarate()/1024));
d1924 1
a1924 1
			dFile.lFileSpeed = cur_file->GetDatarate();
d1935 1
a1935 1
			dFile.lTransferringSourceCount = cur_file->GetTransferingSrcCount();
d1950 2
a1951 2
					case -4 : if (!((cur_file->GetStatus()==PS_READY|| cur_file->GetStatus()==PS_EMPTY) && cur_file->GetTransferingSrcCount()==0)) continue; break;
					case -5 : if (!((cur_file->GetStatus()==PS_READY|| cur_file->GetStatus()==PS_EMPTY) && cur_file->GetTransferingSrcCount()>0)) continue; break;
d2021 1
a2021 1
		if (cur_client->GetDatarate() > 0)
d2050 3
a2052 3
		dUser.nTransferredDown = cur_client->GetTransferedDown();
		dUser.nTransferredUp = cur_client->GetTransferedUp();
		dUser.nDatarate = cur_client->GetDatarate();
d2080 1
a2080 1
				bSwap = UploadArray[i].nDatarate < UploadArray[i+1].nDatarate ;
d2462 2
a2463 2
			fTotalSpeed += UploadArray[i].nDatarate;
			HTTPTemp.Format(_T("%8.2f ") + _GetPlainResString(IDS_KBYTESEC), max((float)UploadArray[i].nDatarate/1024, 0.0));
d2999 2
a3000 2
		dFile.nFileTransferred = cur_file->statistic.GetTransfered();
		dFile.nFileAllTimeTransferred = cur_file->statistic.GetAllTimeTransfered();
@


1.164
log
@- webserver: shutdown PC doesn't work here (netwolf) ... [FIXED] ... thanks EC
- webserver: quickstats bar background (125px) is bigger than max bar (100px) width (Purity) ... [FIXED]
- webserver: completed column in webserver upload list shows funny values [Mantis] (thisIsRandom) ... [FIXED]
- mobileMule: shutdown PC doesn't work here (Purity) ... [FIXED] ... thanks EC
@
text
@d853 1
a853 1
		_stprintf(HTTPHeader, _T("%.1f "), ((float)cur_server->GetUsers() / cur_server->GetMaxUsers()) * 125);
d878 1
a878 1
		_stprintf(HTTPHeader, "%.1f", ((float)theApp.uploadqueue->GetDatarate()/1024)/(theApp.glob_prefs->GetMaxGraphUploadRate())*125); 
d880 1
a880 1
		_stprintf(HTTPHeader, "%.1f", ((float)theApp.uploadqueue->GetDatarate()/1024)/(theApp.glob_prefs->GetMaxUpload())*125); 
d884 1
a884 1
		_stprintf(HTTPHeader, "%.1f", ((float)theApp.downloadqueue->GetDatarate()/1024)/(theApp.glob_prefs->GetMaxGraphDownloadRate())*125);
d886 1
a886 1
		_stprintf(HTTPHeader, "%.1f", ((float)theApp.downloadqueue->GetDatarate()/1024)/(theApp.glob_prefs->GetMaxDownload())*125);
d889 1
a889 1
	_stprintf(HTTPHeader, "%.1f", ((float)theApp.listensocket->GetOpenSockets())/(theApp.glob_prefs->GetMaxConnections())*125);
@


1.163
log
@bugfix: quick stats value * 125 instead of 100 (bar width = 125 ;-)
@
text
@d523 2
a524 2
		TOKEN_PRIVILEGES tkp; 
		try{
d529 1
a529 1
			tkp.Privileges[0].Attributes = SE_PRIVILEGE_ENABLED; 
d531 1
d533 2
a534 1
		catch(...){
d537 1
d1876 2
a1877 2
		Out.Replace(_T("[UTransferred]"), _GetPlainResString(IDS_COMPLETE));
		Out.Replace(_T("[UTransferredM]"), _GetPlainResString(IDS_COMPLETE)); }
d1880 1
a1880 1
		Out.Replace(_T("[UTransferredM]"), _GetPlainResString(IDS_COMPLETE)); }
@


1.162
log
@Strings fix
@
text
@d525 6
a530 9
		if (!OpenProcessToken(GetCurrentProcess(), 
			TOKEN_ADJUST_PRIVILEGES | TOKEN_QUERY, &hToken)) 
			throw; 
		LookupPrivilegeValue(NULL, SE_SHUTDOWN_NAME,
			&tkp.Privileges[0].Luid); 
		tkp.PrivilegeCount = 1;  // one privilege to set    
		tkp.Privileges[0].Attributes = SE_PRIVILEGE_ENABLED; 
		AdjustTokenPrivileges(hToken, FALSE, &tkp, 0, 
			(PTOKEN_PRIVILEGES)NULL, 0); 
d850 1
a850 1
		_stprintf(HTTPHeader, _T("%.1f "), ((float)cur_server->GetUsers() / cur_server->GetMaxUsers()) * 100);
d875 1
a875 1
		_stprintf(HTTPHeader, "%.1f", ((float)theApp.uploadqueue->GetDatarate()/1024)/(theApp.glob_prefs->GetMaxGraphUploadRate())*100); 
d877 1
a877 1
		_stprintf(HTTPHeader, "%.1f", ((float)theApp.uploadqueue->GetDatarate()/1024)/(theApp.glob_prefs->GetMaxUpload())*100); 
d881 1
a881 1
		_stprintf(HTTPHeader, "%.1f", ((float)theApp.downloadqueue->GetDatarate()/1024)/(theApp.glob_prefs->GetMaxGraphDownloadRate())*100);
d883 1
a883 1
		_stprintf(HTTPHeader, "%.1f", ((float)theApp.downloadqueue->GetDatarate()/1024)/(theApp.glob_prefs->GetMaxDownload())*100);
d886 1
a886 1
	_stprintf(HTTPHeader, "%.1f", ((float)theApp.listensocket->GetOpenSockets())/(theApp.glob_prefs->GetMaxConnections())*100);
@


1.161
log
@Minor fixes (ops!)
@
text
@d4335 1
a4335 1
		case -1: return _GetPlainResString(IDS_ALL);
@


1.160
log
@bugfix: webserver: ' in category name produced javascript errors in ie ...
@
text
@d1931 1
a1931 1
			dFile.sCategory = strCategory;				
d4261 1
a4261 1
		CString strCategory = (i==0)?_GetPlainResString(IDS_ALLOTHERS):theApp.glob_prefs->GetCategory(i)->title;
d4335 1
a4335 1
		case -1: return _GetPlainResString(IDS_ALLOTHERS);
@


1.159
log
@Server connection minor changes & update to Light Template
@
text
@d1929 3
a1931 1
			dFile.sCategory = (cur_file->GetCategory()!=0)?theApp.glob_prefs->GetCategory(cur_file->GetCategory())->title:GetResString(IDS_ALLOTHERS);
d4214 2
d4217 1
a4217 1
		tempBuf2.Format("<option%s value=\"%i\">%s</option>",tempBuf3,i, (i==0)?_GetPlainResString(IDS_ALLOTHERS):theApp.glob_prefs->GetCategory(i)->title);
d4261 3
a4263 1
		tempBuff2+= (i==0)?_GetPlainResString(IDS_ALL):theApp.glob_prefs->GetCategory(i)->title; 
d4322 3
a4324 1
		tempBuff2+= (i==0)?_GetPlainResString(IDS_ALLOTHERS):theApp.glob_prefs->GetCategory(i)->title; 
@


1.158
log
@bugfix: changed ServerName <> ServerPort in ServerPage and a minor labeling issue
@
text
@d3392 1
a3392 1
	Out.Replace(_T("[ServerOptions]"), CString(_GetPlainResString(IDS_SERVER)+" "+_GetPlainResString(IDS_EM_PREFS)));
@


1.157
log
@Last template changes and fix for realtime update of FileTypeIcons when option changed.
@
text
@d3379 1
a3379 1
	Out.Replace(_T("[Connect]"), _GetPlainResString(IDS_CONNECTNOW));
d3393 1
@


1.156
log
@server tab in search tab style
@
text
@d827 6
a832 1
	if (theApp.serverconnect->IsConnecting()) { 
d836 1
a836 1
	else if (theApp.serverconnect->IsConnected()) 
@


1.155
log
@Fixed for long version string used by lugdunum 16.40
@
text
@a147 1
			m_Templates.sConnectedServer = _LoadTemplate(sAll,_T("TMPL_CONNECTED_SERVER"));
d948 1
a948 1
	CString sAddServerBox = _T("");
a1016 4
	else if (sCmd.CompareNoCase(_T("options")) == 0) 
	{
		sAddServerBox = _GetAddServerBox(Data);
	}
a1075 1
	Out.Replace(_T("[ConnectedServerData]"), _GetConnectedServer(Data));
d3383 5
a3723 57

	EMULE_CATCH

	return _T("");
}

CString CWebServer::_GetConnectedServer(ThreadData Data)
{
	EMULE_TRY

	CWebServer *pThis = (CWebServer *)Data.pThis;
	if(pThis == NULL)
		return _T("");

	CString sSession = _ParseURL(Data.sURL, _T("ses"));

	CString HTTPTemp = _T("");
	TCHAR	HTTPTempC[100] = _T("");
	CString OutS = pThis->m_Templates.sConnectedServer;
	OutS.Replace(_T("[ConnectedServer]"), _GetPlainResString(IDS_PW_SERVER));
	OutS.Replace(_T("[Servername]"), _GetPlainResString(IDS_SL_SERVERNAME));
	OutS.Replace(_T("[Status]"), _GetPlainResString(IDS_STATUS));
	OutS.Replace(_T("[Usercount]"), _GetPlainResString(IDS_LUSERS));
	OutS.Replace(_T("[Action]"), _GetPlainResString(IDS_CONNECTING));
	OutS.Replace(_T("[URL_Disconnect]"), IsSessionAdmin(Data,sSession)?CString(_T("/?ses=") + sSession + _T("&w=server&c=disconnect")):GetPermissionDenied());
	OutS.Replace(_T("[URL_Connect]"), IsSessionAdmin(Data,sSession)?CString(_T("/?ses=") + sSession + _T("&w=server&c=connect")):GetPermissionDenied());
	OutS.Replace(_T("[Disconnect]"), _GetPlainResString(IDS_IRC_DISCONNECT));
	OutS.Replace(_T("[Connect]"), _GetPlainResString(IDS_CONNECTTOANYSERVER));
	OutS.Replace(_T("[URL_ServerOptions]"), IsSessionAdmin(Data,sSession)?CString(_T("/?ses=") + sSession + _T("&w=server&c=options")):GetPermissionDenied());
	OutS.Replace(_T("[ServerOptions]"), CString(_GetPlainResString(IDS_SERVER)+_GetPlainResString(IDS_EM_PREFS)));

#ifdef OLD_SOCKETS_ENABLED
	if (theApp.serverconnect->IsConnected()) {
		if(!theApp.serverconnect->IsLowID())
			OutS.Replace(_T("[1]"), _GetPlainResString(IDS_CONNECTED));
		else
			OutS.Replace(_T("[1]"), _GetPlainResString(IDS_CONNECTED) + _T(" (") + _GetPlainResString(IDS_LOWID) + _T(")"));

		CServer* cur_server = theApp.serverconnect->GetCurrentServer();
		OutS.Replace(_T("[2]"), CString(cur_server->GetListName()));

		_stprintf(HTTPTempC, _T("%10i"), cur_server->GetUsers());
		HTTPTemp = HTTPTempC;												
		OutS.Replace(_T("[3]"), HTTPTemp);

	} else if (theApp.serverconnect->IsConnecting()) {
		OutS.Replace(_T("[1]"), _GetPlainResString(IDS_CONNECTING));
		OutS.Replace(_T("[2]"), _T(""));
		OutS.Replace(_T("[3]"), _T(""));
	} else 
#endif //OLD_SOCKETS_ENABLED
	{
		OutS.Replace(_T("[1]"), _GetPlainResString(IDS_DISCONNECTED));
		OutS.Replace(_T("[2]"), _T(""));
		OutS.Replace(_T("[3]"), _T(""));
	}
	return OutS;
@


1.154
log
@choose priority and if server is static when you manually add a server via web interface
@
text
@d1431 4
a1434 1
			HTTPProcessData.Replace(_T("[Version]"), ServerArray[i].sServerVersion);
@


1.153
log
@Updated templates and improved GetOutputDir
@
text
@d3330 33
a3362 1
	if(_ParseURL(Data.sURL, _T("addserver")) == "true")
d3364 2
a3365 2
		theApp.emuledlg->serverwnd.AddServer(_ParseURL(Data.sURL, _T("serveraddr")),_ParseURL(Data.sURL, _T("serverport")),_ParseURL(Data.sURL, _T("servername")));
		CString resultlog = _SpecialChars(theApp.emuledlg->logtext);	//Pick-up last line of the log
a3370 9
		if(_ParseURL(Data.sURL, _T("updateservermetfromurl")) == "true")
		{
			theApp.emuledlg->serverwnd.UpdateServerMetFromURL(_ParseURL(Data.sURL, _T("servermeturl")));
			CString resultlog = _SpecialChars(theApp.emuledlg->logtext);
			resultlog = resultlog.TrimRight('\n');
			resultlog = resultlog.Mid(resultlog.ReverseFind('\n'));
			Out.Replace(_T("[Message]"),resultlog);
		}
		else
d3376 6
@


1.152
log
@combined [message] and [refreshresults] in search window (webserver)
@
text
@d4153 5
@


1.151
log
@jigle search (webserver)
@
text
@d4101 1
a4101 1
	else Out.Replace(_T("[Message]"),_T(""));
a4138 1
	Out.Replace(_T("[RefetchResults]"), _GetPlainResString(IDS_SW_REFETCHRES));
@


1.150
log
@Fixed minor display/string issues
@
text
@a4127 1
	Out.Replace(_T("[WebSearch]"), _GetPlainResString(IDS_SW_WEBBASED));
d4140 7
a4146 1

@


1.149
log
@webserver change/bugfix:
keep viewing the same cat when changing a file's category (use '&filecat=' instead of already used '&cat=' for assigning categories)
@
text
@d1927 1
a1927 1
			dFile.sCategory = (cur_file->GetCategory()!=0)?theApp.glob_prefs->GetCategory(cur_file->GetCategory())->title:GetResString(IDS_ALL);
d4224 1
a4224 1
		tempBuf2.Format("<option%s value=\"%i\">%s</option>",tempBuf3,i, (i==0)?_GetPlainResString(IDS_ALL):theApp.glob_prefs->GetCategory(i)->title);
d4315 1
a4315 1
				tempBuff4 = _GetPlainResString(IDS_ALL);
d4327 1
a4327 1
		tempBuff2+= (i==0)?_GetPlainResString(IDS_ALL):theApp.glob_prefs->GetCategory(i)->title; 
@


1.148
log
@max servername length in webserver header = 40 (800x600)
@
text
@d1617 1
a1617 1
				int iMenu = atoi(_ParseURL(Data.sURL, _T("cat")));
d4322 1
a4322 1
		tempBuff2 = CString("<a href=&quot;/?ses=" + sSession + "&w=transfer&op=setcat&file=" + sFileHash + "&cat="); 
@


1.147
log
@speed otimization: don't loop twice through waitinglist to get stats. further diffrences could have occured due to uneven conditions used.
@
text
@d839 4
a842 1
		HTTPConText = CString(cur_server->GetListName());
@


1.146
log
@bugfixing my bugfix
@
text
@d2090 9
d2106 4
a2109 3
		if (!(cur_client->IsBanned())&&!(cur_client->IsFriend())&&!(cur_client->credits->GetScoreRatio(cur_client->GetIP()) > 1))
			dUser.sClientExtra = _T("none");
		else if (cur_client->IsBanned())
d2111 5
a2115 1
		else if ((cur_client->IsFriend())&&!(cur_client->IsBanned()))
d2117 5
a2121 1
		else if ((cur_client->credits->GetScoreRatio(cur_client->GetIP()) > 1)&&!(cur_client->IsBanned())&&!(cur_client->IsFriend()))
d2123 10
d2154 1
a2154 1
			dUser.sIndex = cur_client->GetUserName();
a2175 39

	/* old bubblesort
	// Sorting (ok, it could be that we have tons of data here but its still fast enough to use bubblesort for WebServer)
	bSorted = true;
	for(int nMax = 0;bSorted && nMax < QueueArray.GetCount()*2; nMax++)
	{
		bSorted = false;
		for(int i = 0; i < QueueArray.GetCount() - 1; i++)
		{
			bool bSwap = false;
			switch(pThis->m_Params.QueueSort)
			{
			case QU_SORT_USER:
				bSwap = QueueArray[i].sUserName.CompareNoCase(QueueArray[i+1].sUserName) > 0;
				break;
			case QU_SORT_VERSION:
				bSwap = QueueArray[i].sClientNameVersion.CompareNoCase(QueueArray[i+1].sClientNameVersion) > 0;
				break;
			case QU_SORT_FILENAME:
				bSwap = QueueArray[i].sFileName.CompareNoCase(QueueArray[i+1].sFileName) > 0;
				break;
			case QU_SORT_SCORE:
				bSwap = QueueArray[i].nScore < QueueArray[i+1].nScore ;
				break;
			}
			if(pThis->m_Params.bQueueSortReverse)
			{
				bSwap = !bSwap;
			}
			if(bSwap)
			{
				bSorted = true;
				QueueUsers TmpUser = QueueArray[i];
				QueueArray[i] = QueueArray[i+1];
				QueueArray[i+1] = TmpUser;
			}
		}
	}
	*/
a2467 30

	int nCountQueue = 0;
	int nCountQueueBanned = 0;
	int nCountQueueFriend = 0;
	int nCountQueueCredit = 0;
	int nCountQueueSecure = 0;
	int nCountQueueBannedSecure = 0;
	int nCountQueueFriendSecure = 0;
	int nCountQueueCreditSecure = 0;

	for (POSITION pos = theApp.uploadqueue->waitinglist.GetHeadPosition(); pos != 0;theApp.uploadqueue->waitinglist.GetNext(pos)){
		CUpDownClient* cur_client = theApp.uploadqueue->waitinglist.GetAt(pos);
		if (cur_client->IsBanned()) {
			nCountQueueBanned++;
			if (cur_client->credits->GetCurrentIdentState(cur_client->GetIP()) != IS_IDENTIFIED)
				nCountQueueBannedSecure++;
		} else if (cur_client->IsFriend()) {
			nCountQueueFriend++;
			if (cur_client->credits->GetCurrentIdentState(cur_client->GetIP()) != IS_IDENTIFIED)
				nCountQueueFriendSecure++;
		} else if (cur_client->credits->GetScoreRatio(cur_client->GetIP()) > 1) {
			nCountQueueCredit++;
			if (cur_client->credits->GetCurrentIdentState(cur_client->GetIP()) != IS_IDENTIFIED)
				nCountQueueCreditSecure++;
		} else {
			nCountQueue++;
			if (cur_client->credits->GetCurrentIdentState(cur_client->GetIP()) != IS_IDENTIFIED)
				nCountQueueSecure++;
		}
	}
@


1.145
log
@fixed webbased search and extended normal search in webserver
@
text
@a4169 1
	Out.Replace(_T("[Archive]"), _GetPlainResString(IDS_SEARCH_ARC));
d4171 3
a4174 1
	Out.Replace(_T("[Graphic]"), _GetPlainResString(IDS_SEARCH_PICS));
d4176 1
a4176 3
	Out.Replace(_T("[Video]"), _GetPlainResString(IDS_SEARCH_VIDEO));
	Out.Replace(_T("[Document]"), _GetPlainResString(IDS_SEARCH_DOC));
	Out.Replace(_T("[Other]"), _GetPlainResString(IDS_STATS_PRTOTHER));
d4179 1
@


1.144
log
@catfix for webserver: chosing filters in transfer list fixed
@
text
@a149 1
			//m_Templates.sWebSearch = _LoadTemplate(sAll,_T("TMPL_WEBSEARCH"));
a557 5
		if (sPage == "websearch") 
		{
			Out += _GetWebSearch(Data);
		}
		else
a3401 43
CString	CWebServer::_GetWebSearch(ThreadData Data)
{
	EMULE_TRY

	CWebServer *pThis = (CWebServer *)Data.pThis;
	if(pThis == NULL)
		return _T("");

	CString sSession = _ParseURL(Data.sURL, _T("ses"));
    
	CString Out = pThis->m_Templates.sWebSearch;
	if(_ParseURL(Data.sURL, _T("tosearch")) != "")
	{
		CString query;
		CString tosearch = _ParseURL(Data.sURL, _T("tosearch"));
		query = _T("http://www.filedonkey.com/fdsearch/index.php?media=");
		query += _ParseURL(Data.sURL, _T("media"));
		tosearch = URLEncode(tosearch);
		tosearch.Replace(_T("%20"),_T("+"));
		query += _T("&pattern=");
		query += _ParseURL(Data.sURL, _T("tosearch"));
		query += _T("&action=search&name=FD-Search&op=modload&file=index&requestby=emule");
		Out += _T("\n<script language=\"javascript\">");
		Out += _T("\n searchwindow=window.open('")+ query + _T("','searchwindow');");
		Out += _T("\n</script>");
	}
	Out.Replace(_T("[Session]"), sSession);
	Out.Replace(_T("[Name]"), _GetPlainResString(IDS_SW_NAME));
	Out.Replace(_T("[Type]"), _GetPlainResString(IDS_TYPE));
	Out.Replace(_T("[Any]"), _GetPlainResString(IDS_SEARCH_ANY));
	Out.Replace(_T("[Audio]"), _GetPlainResString(IDS_SEARCH_AUDIO));
	Out.Replace(_T("[Video]"), _GetPlainResString(IDS_SEARCH_VIDEO));
	Out.Replace(_T("[Document]"), _GetPlainResString(IDS_SEARCH_DOC));
	Out.Replace(_T("[Other]"), _T("Other"));
	Out.Replace(_T("[Search]"), _GetPlainResString(IDS_SW_START));
	Out.Replace(_T("[WebSearch]"), _GetPlainResString(IDS_SW_WEBBASED));
	
	return Out;

	EMULE_CATCH

	return _T("");
}
a3760 1
	OutS.Replace(_T("[WebSearch]"), _GetPlainResString(IDS_SW_WEBBASED));
d4170 1
d4172 3
a4174 1
	Out.Replace(_T("[Image]"), _GetPlainResString(IDS_SEARCH_PICS));
d4177 1
a4177 1
	Out.Replace(_T("[Other]"), _T("Other"));
a4179 1

@


1.143
log
@Fix for upload datarate on WS and removed an unneeded statistic tree title.
@
text
@d150 1
a150 1
			m_Templates.sWebSearch = _LoadTemplate(sAll,_T("TMPL_WEBSEARCH"));
a4226 1
	Out.Replace(_T("[WebSearch]"), _GetPlainResString(IDS_SW_WEBBASED));
d4371 1
a4371 1
			tempBuff2 = CString("<a href=&quot;/?ses=" + sSession + "&w=transfer&cat="); 
@


1.142
log
@Webserver: QuickSort via CQArray-Sorting for users on waitingqueue
@
text
@d2051 1
a2051 1
		dUser.nDatarate = cur_client->GetDatarate()/1024.0;
d2473 1
a2473 1
			HTTPTemp.Format(_T("%8.2f ") + _GetPlainResString(IDS_KBYTESEC), (float)UploadArray[i].nDatarate);
d2483 1
a2483 1
	HTTPTemp.Format(_T("%8.2f ") + _GetPlainResString(IDS_KBYTESEC), fTotalSpeed);
@


1.141
log
@More statistics fixes (+WS)
@
text
@d8 1
d23 11
d2096 2
a2097 1
	CArray<QueueUsers, QueueUsers> QueueArray;
d2127 20
d2150 6
d2192 4
@


1.140
log
@category change for download files
@
text
@d3502 1
@


1.139
log
@Fixes and updates (read forum to know)
@
text
@d780 1
a780 1
	InsertCatBox(Out,0,"",false,false,sSession);
d1606 5
d1652 3
d1743 1
a1743 1
	InsertCatBox(Out,cat,"",true,true,sSession);
d1764 1
a1764 1
		Out.Replace(_T("[SortProgress]"), _T(""));
d1773 4
d1840 6
d1918 1
d1983 3
d2367 7
d4166 1
a4166 1
	if (theApp.glob_prefs->GetCatCount()>1) InsertCatBox(Out,0,"",false,false,sSession); else Out.Replace("[CATBOX]","");
d4254 1
a4254 1
void CWebServer::InsertCatBox(CString &Out,int preselect,CString boxlabel,bool jump,bool extraCats, CString sSession)
d4340 35
@


1.138
log
@Fixed WS Categories menu in transfers window.
@
text
@d753 1
d1473 7
d1518 1
a1518 1
	else if (HTTPTemp.CompareNoCase(_T("menuprio")) == 0 && bAdmin) //DonGato: category priority change
d1520 3
a1522 1
		CString sPrio(_ParseURL(Data.sURL, _T("p")));
d1524 16
a1539 15
		if(sPrio.CompareNoCase(_T("low")) == 0) 
		{
			theApp.downloadqueue->SetCatPrio(cat,PR_LOW);
		}
		else if(sPrio.CompareNoCase(_T("normal")) == 0)
		{
			theApp.downloadqueue->SetCatPrio(cat,PR_NORMAL);
		}
		else if(sPrio.CompareNoCase(_T("high")) == 0)
		{
			theApp.downloadqueue->SetCatPrio(cat,PR_HIGH);
		}
		else if(sPrio.CompareNoCase(_T("auto")) == 0)
		{
			theApp.downloadqueue->SetCatPrio(cat,PR_AUTO);
a1542 5
	if (bAdmin && !HTTPTemp.IsEmpty()) 
		theApp.emuledlg->searchwnd.AddEd2kLinksToDownload(HTTPTemp,cat);
	else 
		HTTPTemp.Empty();	//free for reusing

d2299 1
a2299 1
				HTTPTemp.Format(_T("%8.2f %s"), FilesArray[i].lFileSpeed/1024.0 ,_GetPlainResString(IDS_KBYTESEC) );
d2411 1
a2411 1
	HTTPTemp.Format(_T("%8.2f ") + _GetPlainResString(IDS_KBYTESEC), (float)fTotalSpeed/1024.0);
@


1.137
log
@Fixed priority change for categories, WebServer templates update and fixed problem with upload speed after Purity changes.
@
text
@d779 1
a779 1
	InsertCatBox(Out,0,"");
d1729 1
a1729 1
	InsertCatBox(Out,cat,"",true,true);
d4131 1
a4131 1
	if (theApp.glob_prefs->GetCatCount()>1) InsertCatBox(Out,0,""); else Out.Replace("[CATBOX]","");
d4219 2
a4220 1
void CWebServer::InsertCatBox(CString &Out,int preselect,CString boxlabel,bool jump,bool extraCats) {
d4222 5
a4226 2
	if (jump) tempBuf2="onchange=GotoCat(this.form.cat.options[this.form.cat.selectedIndex].value)>";
	else tempBuf2=">";
d4229 2
a4230 1
	for (int i=0;i< theApp.glob_prefs->GetCatCount();i++) {
d4232 1
a4232 1
		tempBuf2.Format("<option%s value=\"%i\">%s</option>",tempBuf3,i, (i==0)?_GetPlainResString(IDS_ALL):theApp.glob_prefs->GetCategory(i)->title );
d4235 4
a4238 2
	if (extraCats) {
		if (theApp.glob_prefs->GetCatCount()>1){
d4243 2
a4244 1
		for (int i=(theApp.glob_prefs->GetCatCount()>1)?1:2;i<=12;i++) {
d4246 1
a4246 1
			tempBuf2.Format("<option%s value=\"%i\">%s</option>",tempBuf3,-i, GetSubCatLabel(-i) );
d4257 2
a4258 1
	for (int i=0;i< theApp.glob_prefs->GetCatCount();i++) {
d4270 8
a4277 7
		tempBuff2 = CString("<a href=javascript:GotoCat(");
		tempBuff2+= strI;
		tempBuff2+= CString(")><div class=menuitems><img class=menuchecked");
		tempBuff2+= tempBuff3;
		tempBuff2+= CString(">");
		tempBuff2+= (i==0)?_GetPlainResString(IDS_ALL):theApp.glob_prefs->GetCategory(i)->title;
		tempBuff2+= CString("&nbsp;</div></a>");
d4280 4
a4283 7
	if (extraCats) {
		if (theApp.glob_prefs->GetCatCount()>1){
			//tempBuff2.Format("<option>------------</option>");
			//tempBuff.Append(tempBuff2);
		}
	
		for (int i=(theApp.glob_prefs->GetCatCount()>1)?1:2;i<=12;i++) {
d4292 2
a4293 1
			tempBuff2 = CString("<a href=javascript:GotoCat(-");
d4295 1
a4295 1
			tempBuff2+= CString(")><div class=menuitems><img class=menuchecked");
d4307 4
a4310 2
CString CWebServer::GetSubCatLabel(int cat) {
	switch (cat) {
d4324 1
@


1.136
log
@Category priorities
@
text
@d1510 22
a1591 16
			else if(bAdmin && sOp.CompareNoCase(_T("catlow")) == 0) //DonGato: category priority change
			{
				theApp.downloadqueue->SetCatPrio(cat,PR_LOW);
			}
			else if(bAdmin && sOp.CompareNoCase(_T("catnormal")) == 0) //DonGato: category priority change
			{
				theApp.downloadqueue->SetCatPrio(cat,PR_NORMAL);
			}
			else if(bAdmin && sOp.CompareNoCase(_T("cathigh")) == 0) //DonGato: category priority change
			{
				theApp.downloadqueue->SetCatPrio(cat,PR_HIGH);
			}
			else if(bAdmin && sOp.CompareNoCase(_T("catauto")) == 0) //DonGato: category priority change
			{
				theApp.downloadqueue->SetCatPrio(cat,PR_AUTO);
			}
d1858 2
a1859 4
	//DonGato: category priority change
	Out.Replace(_T("[admin]"), admin);
	Out.Replace(_T("[cat-priority]"), sCat);

d2395 1
a2395 1
			HTTPTemp.Format(_T("%8.2f ") + _GetPlainResString(IDS_KBYTESEC), UploadArray[i].nDatarate);
d2405 1
a2405 1
	HTTPTemp.Format(_T("%8.2f ") + _GetPlainResString(IDS_KBYTESEC), fTotalSpeed/1024.0);
@


1.135
log
@column save fix in serverlist
@
text
@d1450 2
d1453 4
d1568 17
d1852 3
d2202 3
a2222 3

		if (bAdmin)
			admin.Format(_T("admin"));
@


1.134
log
@khaos stats + categories + sorting + column menu + search dialog + jumpstart fix
@
text
@d27 1
a27 1
static bool	WSserverColumnHidden[8];
@


1.133
log
@WebServer: added specific priority change for Downloads, Servers and Shared Files
@
text
@d23 1
a23 1
static bool	WSdownloadColumnHidden[7];
d27 2
a28 2
static bool	WSserverColumnHidden[6];
static bool	WSsearchColumnHidden[5];
d46 2
a526 1
#define EWX_FORCEIFHUNG     0x00000010
d666 1
a666 1
	TCHAR toReplace[2] = _T("");		// decode URL
d739 4
a742 1
			sT.Replace(_T("[wCommand]"), _ParseURL(Data.sURL, _T("w")));
d752 3
d779 1
d803 1
d1030 3
d1036 2
a1037 2
		if(sSort == "ip")
			pThis->m_Params.ServerSort = SERVER_SORT_IP;
d1047 9
d1078 4
d1086 2
a1087 2
	if(pThis->m_Params.ServerSort == SERVER_SORT_IP)
		Out.Replace(_T("[SortIP]"), _T("&sortreverse=") + sServerSortRev);
d1089 1
a1089 1
		Out.Replace(_T("[SortIP]"), _T(""));
d1102 12
d1116 1
a1116 1
		Out.Replace(_T("[Servername]"), _GetPlainResString(IDS_SL_SERVERNAME));
d1119 1
a1119 1
		Out.Replace(_T("[Servername]"), "");
d1122 7
a1128 1
		Out.Replace(_T("[Description]"), _GetPlainResString(IDS_DESCRIPTION));
d1131 1
a1131 1
		Out.Replace(_T("[Description]"), "");
d1133 3
a1135 3
	if (!WSserverColumnHidden[2]) {
		Out.Replace(_T("[Address]"), _GetPlainResString(IDS_IP));
		Out.Replace(_T("[AddressM]"), _GetPlainResString(IDS_IP)); }
d1137 4
a1140 4
		Out.Replace(_T("[Address]"), "");
		Out.Replace(_T("[AddressM]"), _GetPlainResString(IDS_IP)); }
	if (!WSserverColumnHidden[3]) {
		Out.Replace(_T("[Users]"), _GetPlainResString(IDS_UUSERS));
d1143 1
a1143 1
		Out.Replace(_T("[Users]"), "");
d1145 2
a1146 2
	if (!WSserverColumnHidden[4]) {
		Out.Replace(_T("[Files]"), _GetPlainResString(IDS_FILES));
d1149 1
a1149 1
		Out.Replace(_T("[Files]"), "");
d1151 2
a1152 2
	if (!WSserverColumnHidden[5]) {
		Out.Replace(_T("[Priority]"), _GetPlainResString(IDS_PRIORITY));
d1155 1
a1155 1
		Out.Replace(_T("[Priority]"), "");
d1157 18
d1188 2
d1191 1
a1191 2
		Entry.nServerPort = cur_file->GetPort();
		Entry.sServerIP = cur_file->GetAddress();
d1196 14
a1209 1

a1220 10
		if(cur_file->GetPreferences()== CServer::ePR_HIGH) {
			Entry.sServerPriority = _GetPlainResString(IDS_PRIOHIGH);
			Entry.nServerPriority = 2;
		} else if(cur_file->GetPreferences()== CServer::ePR_NORMAL) {
			Entry.sServerPriority = _GetPlainResString(IDS_PRIONORMAL);
			Entry.nServerPriority = 1;
		} else if(cur_file->GetPreferences()== CServer::ePR_LOW) {
			Entry.sServerPriority = _GetPlainResString(IDS_PRIOLOW);
			Entry.nServerPriority = 0;
		}
d1258 3
d1264 2
a1265 2
			case SERVER_SORT_IP:
				bSwap = ServerArray[i].sServerFullIP < ServerArray[i+1].sServerFullIP;
d1274 10
a1283 1
			bSwap = ServerArray[i].nServerPriority < ServerArray[i+1].nServerPriority;
d1364 1
a1364 1
				HTTPProcessData.Replace(_T("[1]"), _T("<acronym title=\"") + ServerArray[i].sServerName + _T("\">") + ServerArray[i].sServerName.Left(SHORT_LENGTH) + _T("...") + _T("</acronym>"));
d1366 1
a1366 1
				HTTPProcessData.Replace(_T("[1]"), ServerArray[i].sServerName);
d1368 1
a1368 1
			HTTPProcessData.Replace(_T("[1]"), "");
d1370 5
d1376 1
a1376 1
				HTTPProcessData.Replace(_T("[2]"), _T("<acronym title=\"") + ServerArray[i].sServerDescription + _T("\">") + ServerArray[i].sServerDescription.Left(SHORT_LENGTH) + _T("...") + _T("</acronym>"));
d1378 1
a1378 1
				HTTPProcessData.Replace(_T("[2]"), ServerArray[i].sServerDescription);
d1380 4
a1383 5
			HTTPProcessData.Replace(_T("[2]"), "");
		// DonGato
		if (!WSserverColumnHidden[2]) {
			CString sPort; sPort.Format(_T(":%d"), ServerArray[i].nServerPort);
			HTTPProcessData.Replace(_T("[3]"), ServerArray[i].sServerIP + sPort);
d1385 1
a1385 1
			HTTPProcessData.Replace(_T("[3]"), "");
d1387 1
a1387 1
		if (!WSserverColumnHidden[3]) {
d1395 1
a1395 1
			HTTPProcessData.Replace(_T("[4]"), sT);
d1397 1
a1397 1
			HTTPProcessData.Replace(_T("[4]"), "");
d1399 1
a1399 1
		if (!WSserverColumnHidden[4]) {
d1402 1
a1402 1
			HTTPProcessData.Replace(_T("[5]"), sT);
d1404 2
a1405 2
			HTTPProcessData.Replace(_T("[5]"), "");
		if (!WSserverColumnHidden[5])
d1409 15
d1444 3
d1505 1
a1505 1
		theApp.emuledlg->searchwnd.AddEd2kLinksToDownload(HTTPTemp);
d1591 1
a1591 1
		if(sSort.CompareNoCase(_T("name")) == 0)
d1594 1
a1594 1
		if(sSort.CompareNoCase(_T("size")) == 0)
d1597 1
a1597 1
		if(sSort.CompareNoCase(_T("transferred")) == 0)
d1600 1
a1600 1
		if(sSort.CompareNoCase(_T("speed")) == 0)
d1603 1
a1603 1
		if(sSort.CompareNoCase(_T("progress")) == 0)
d1606 1
a1606 1
		if(sSort.CompareNoCase(_T("sources")) == 0)
d1609 1
a1609 1
		if(sSort.CompareNoCase(_T("priority")) == 0)
d1611 27
a1637 1

d1642 2
d1646 2
d1680 12
d1699 3
d1703 1
a1703 1
		Out.Replace(_T("[SortName]"), _T("&sortreverse=") + sDownloadSortRev);
d1705 1
a1705 1
		Out.Replace(_T("[SortName]"), _T(""));
d1707 1
a1707 1
		Out.Replace(_T("[SortSize]"), _T("&sortreverse=") + sDownloadSortRev);
d1709 1
a1709 1
		Out.Replace(_T("[SortSize]"), _T(""));
d1711 1
a1711 1
		Out.Replace(_T("[SortTransferred]"), _T("&sortreverse=") + sDownloadSortRev);
d1713 1
a1713 1
		Out.Replace(_T("[SortTransferred]"), _T(""));
d1715 1
a1715 1
		Out.Replace(_T("[SortSpeed]"), _T("&sortreverse=") + sDownloadSortRev);
d1717 1
a1717 1
		Out.Replace(_T("[SortSpeed]"), _T(""));
d1719 1
a1719 1
		Out.Replace(_T("[SortProgress]"), _T("&sortreverse=") + sDownloadSortRev);
d1723 1
a1723 1
		Out.Replace(_T("[SortSources]"), _T("&sortreverse=") + sDownloadSortRev);
d1725 1
a1725 1
		Out.Replace(_T("[SortSources]"), _T(""));
d1727 17
a1743 1
		Out.Replace(_T("[SortPriority]"), _T("&sortreverse=") + sDownloadSortRev);
d1745 5
a1749 1
		Out.Replace(_T("[SortPriority]"), _T(""));
d1828 1
d1876 17
a1892 1

d1943 153
d2207 1
d2329 1
a2329 1
	for (POSITION pos = theApp.uploadqueue->uploadinglist.GetHeadPosition(); pos != 0;theApp.uploadqueue->uploadinglist.GetNext(pos))
a2330 1
		CUpDownClient* cur_client = theApp.uploadqueue->uploadinglist.GetAt(pos);
d2334 1
a2334 3
		CString sUserHash = FileHashToString(cur_client->GetUserHash());
		HTTPProcessData.Replace(_T("[UserHash]"), sUserHash);

d2340 6
a2345 28

		if (cur_client->GetDatarate() > 0)
			HTTPProcessData.Replace(_T("[UpState]"), "downloading");
		else
			HTTPProcessData.Replace(_T("[UpState]"), "waiting");

		CString sUpTooltip = _SpecialChars(cur_client->GetUploadFileInfo());
		sUpTooltip.Replace(_T("\n"), _T("<br>"));
		sUpTooltip.Replace(_T("'"), _T("&#8217;"));
		HTTPProcessData.Replace(_T("[FileInfo]"), sUpTooltip);

		CString sClientSoft; sClientSoft.Format(_T("%u"), cur_client->GetClientSoft());
		HTTPProcessData.Replace(_T("[ClientSoft]"), sClientSoft);

		if (cur_client->IsBanned())
			HTTPProcessData.Replace(_T("[ClientExtra]"), _T("banned"));
		else if (cur_client->IsFriend())
			HTTPProcessData.Replace(_T("[ClientExtra]"), _T("friend"));
		else if (cur_client->credits->GetScoreRatio(cur_client->GetIP()) > 1)
			HTTPProcessData.Replace(_T("[ClientExtra]"), _T("credit"));
		else
			HTTPProcessData.Replace(_T("[ClientExtra]"), _T("none"));

		if (!WSuploadColumnHidden[0]) {
			if(cur_client->GetUserName().GetLength() > SHORT_LENGTH_MIN)
				HTTPProcessData.Replace(_T("[1]"), _SpecialChars(cur_client->GetUserName().Left(SHORT_LENGTH_MIN)) + _T("..."));
			else
				HTTPProcessData.Replace(_T("[1]"), _SpecialChars(cur_client->GetUserName())); }
d2349 1
a2349 1
			HTTPProcessData.Replace(_T("[ClientSoftV]"), GetClientNameAndVersionString(cur_client));
d2352 2
a2353 6
		if (!WSuploadColumnHidden[2]) {
			CKnownFile* file = theApp.sharedfiles->GetFileByID(cur_client->reqfileid);
			if (file)
				HTTPProcessData.Replace(_T("[2]"), _SpecialChars(CString(file->GetFileName())));
			else
				HTTPProcessData.Replace(_T("[2]"), _GetPlainResString(IDS_REQ_UNKNOWNFILE)); }
d2357 3
a2359 3
			fTotalSize += cur_client->GetTransferedDown();
			fTotalTransferred += cur_client->GetTransferedUp();
			HTTPTemp.Format(_T("%s / %s"), CastItoXBytes(cur_client->GetTransferedDown()),CastItoXBytes(cur_client->GetTransferedUp()));
d2364 2
a2365 2
			fTotalSpeed += cur_client->GetDatarate();
			HTTPTemp.Format(_T("%8.2f ") + _GetPlainResString(IDS_KBYTESEC), cur_client->GetDatarate()/1024.0);
d2382 4
d2389 1
a2389 1
		if (cur_client->IsBanned())
d2391 3
a2393 1
		else if (cur_client->IsFriend())
d2395 3
a2397 1
		else if (cur_client->credits->GetScoreRatio(cur_client->GetIP()) > 1)
d2399 3
a2401 1
		else
d2403 3
d2414 2
a2415 2
		for (POSITION pos = theApp.uploadqueue->waitinglist.GetHeadPosition(); pos != 0;theApp.uploadqueue->waitinglist.GetNext(pos)){
			CUpDownClient* cur_client = theApp.uploadqueue->waitinglist.GetAt(pos);
d2418 1
a2418 1
			if (!(cur_client->IsBanned())&&!(cur_client->IsFriend())&&!(cur_client->credits->GetScoreRatio(cur_client->GetIP()) > 1))
d2420 2
a2421 5
			if (!WSqueueColumnHidden[0]) {
				if(cur_client->GetUserName().GetLength() > SHORT_LENGTH)
					HTTPProcessData.Replace(_T("[UserName]"), _SpecialChars(cur_client->GetUserName().Left(SHORT_LENGTH)) + _T("..."));
				else
					HTTPProcessData.Replace(_T("[UserName]"), _SpecialChars(cur_client->GetUserName())); }
d2425 1
a2425 1
				HTTPProcessData.Replace(_T("[ClientSoftV]"), GetClientNameAndVersionString(cur_client));
d2428 2
a2429 6
			if (!WSqueueColumnHidden[2]) {
				CKnownFile* file = theApp.sharedfiles->GetFileByID(cur_client->reqfileid);
				if (file)
					HTTPProcessData.Replace(_T("[FileName]"), _SpecialChars(file->GetFileName()));
				else
					HTTPProcessData.Replace(_T("[FileName]"), _T("?")); }
d2433 1
a2433 1
				_stprintf(HTTPTempC, _T("%i") , cur_client->GetScore(false));
d2437 3
a2439 5
			CString sClientSoft; sClientSoft.Format(_T("%u"), cur_client->GetClientSoft());
			HTTPProcessData.Replace(_T("[ClientSoft]"), sClientSoft);
			HTTPProcessData.Replace(_T("[ClientExtra]"), _T("none"));
			CString sUserHash = FileHashToString(cur_client->GetUserHash());
			HTTPProcessData.Replace(_T("[UserHash]"), sUserHash);
d2459 2
a2460 2
		for (POSITION pos = theApp.uploadqueue->waitinglist.GetHeadPosition(); pos != 0;theApp.uploadqueue->waitinglist.GetNext(pos)){
			CUpDownClient* cur_client = theApp.uploadqueue->waitinglist.GetAt(pos);
d2463 1
a2463 1
			if (cur_client->IsBanned())
d2465 2
a2466 5
			if (!WSqueueColumnHidden[0]) {
				if(cur_client->GetUserName().GetLength() > SHORT_LENGTH)
					HTTPProcessData.Replace(_T("[UserName]"), _SpecialChars(cur_client->GetUserName().Left(SHORT_LENGTH)) + _T("..."));
				else
					HTTPProcessData.Replace(_T("[UserName]"), _SpecialChars(cur_client->GetUserName())); }
d2470 1
a2470 1
				HTTPProcessData.Replace(_T("[ClientSoftV]"), GetClientNameAndVersionString(cur_client));
d2473 2
a2474 6
			if (!WSqueueColumnHidden[2]) {
				CKnownFile* file = theApp.sharedfiles->GetFileByID(cur_client->reqfileid);
				if (file)
					HTTPProcessData.Replace(_T("[FileName]"), _SpecialChars(file->GetFileName()));
				else
					HTTPProcessData.Replace(_T("[FileName]"), _T("?")); }
d2478 1
a2478 1
				_stprintf(HTTPTempC, _T("%i") , cur_client->GetScore(false));
d2482 3
a2484 5
			CString sClientSoft; sClientSoft.Format(_T("%u"), cur_client->GetClientSoft());
			HTTPProcessData.Replace(_T("[ClientSoft]"), sClientSoft);
			HTTPProcessData.Replace(_T("[ClientExtra]"), _T("banned"));
			CString sUserHash = FileHashToString(cur_client->GetUserHash());
			HTTPProcessData.Replace(_T("[UserHash]"), sUserHash);
d2504 2
a2505 2
		for (POSITION pos = theApp.uploadqueue->waitinglist.GetHeadPosition(); pos != 0;theApp.uploadqueue->waitinglist.GetNext(pos)){
			CUpDownClient* cur_client = theApp.uploadqueue->waitinglist.GetAt(pos);
d2508 1
a2508 1
			if ((cur_client->IsFriend())&&!(cur_client->IsBanned()))
d2510 2
a2511 5
			if (!WSqueueColumnHidden[0]) {
				if(cur_client->GetUserName().GetLength() > SHORT_LENGTH)
					HTTPProcessData.Replace(_T("[UserName]"), _SpecialChars(cur_client->GetUserName().Left(SHORT_LENGTH)) + _T("..."));
				else
					HTTPProcessData.Replace(_T("[UserName]"), _SpecialChars(cur_client->GetUserName())); }
d2515 2
a2516 2
				HTTPProcessData.Replace(_T("[ClientSoftV]"), GetClientNameAndVersionString(cur_client));
			else	
d2518 2
a2519 6
			if (!WSqueueColumnHidden[2]) {
				CKnownFile* file = theApp.sharedfiles->GetFileByID(cur_client->reqfileid);
				if (file)
					HTTPProcessData.Replace(_T("[FileName]"), _SpecialChars(file->GetFileName()));
				else
					HTTPProcessData.Replace(_T("[FileName]"), _T("?")); }
d2522 2
a2523 2
			if (!WSqueueColumnHidden[2]) {
				_stprintf(HTTPTempC, _T("%i") , cur_client->GetScore(false));
d2527 3
a2529 5
			CString sClientSoft; sClientSoft.Format(_T("%u"), cur_client->GetClientSoft());
			HTTPProcessData.Replace(_T("[ClientSoft]"), sClientSoft);
			HTTPProcessData.Replace(_T("[ClientExtra]"), _T("friend"));
			CString sUserHash = FileHashToString(cur_client->GetUserHash());
			HTTPProcessData.Replace(_T("[UserHash]"), sUserHash);
d2549 2
a2550 2
		for (POSITION pos = theApp.uploadqueue->waitinglist.GetHeadPosition(); pos != 0;theApp.uploadqueue->waitinglist.GetNext(pos)){
			CUpDownClient* cur_client = theApp.uploadqueue->waitinglist.GetAt(pos);
d2553 1
a2553 1
			if ((cur_client->credits->GetScoreRatio(cur_client->GetIP()) > 1)&&!(cur_client->IsBanned())&&!(cur_client->IsFriend()))
d2555 2
a2556 5
			if (!WSqueueColumnHidden[0]) {
				if(cur_client->GetUserName().GetLength() > SHORT_LENGTH)
					HTTPProcessData.Replace(_T("[UserName]"), _SpecialChars(cur_client->GetUserName().Left(SHORT_LENGTH)) + _T("..."));
				else
					HTTPProcessData.Replace(_T("[UserName]"), _SpecialChars(cur_client->GetUserName())); }
d2560 2
a2561 2
				HTTPProcessData.Replace(_T("[ClientSoftV]"), GetClientNameAndVersionString(cur_client));
			else	
d2563 2
a2564 6
			if (!WSqueueColumnHidden[2]) {
				CKnownFile* file = theApp.sharedfiles->GetFileByID(cur_client->reqfileid);
				if (file)
					HTTPProcessData.Replace(_T("[FileName]"), _SpecialChars(file->GetFileName()));
				else
					HTTPProcessData.Replace(_T("[FileName]"), _T("?")); }
d2568 1
a2568 1
				_stprintf(HTTPTempC, _T("%i") , cur_client->GetScore(false));
d2572 3
a2574 5
			CString sClientSoft; sClientSoft.Format(_T("%u"), cur_client->GetClientSoft());
			HTTPProcessData.Replace(_T("[ClientSoft]"), sClientSoft);
			HTTPProcessData.Replace(_T("[ClientExtra]"), _T("credit"));
			CString sUserHash = FileHashToString(cur_client->GetUserHash());
			HTTPProcessData.Replace(_T("[UserHash]"), sUserHash);
d2587 22
a2608 14
	CString mCountQueue;
	mCountQueue.Format(_T("%i"),nCountQueue);
	Out.Replace(_T("[CounterQueue]"), mCountQueue);
	CString mCountQueueBanned;
	mCountQueueBanned.Format(_T("%i"),nCountQueueBanned);
	Out.Replace(_T("[CounterQueueBanned]"), mCountQueueBanned);
	CString mCountQueueFriend;
	mCountQueueFriend.Format(_T("%i"),nCountQueueFriend);
	Out.Replace(_T("[CounterQueueFriend]"), mCountQueueFriend);
	CString mCountQueueCredit;
	mCountQueueCredit.Format(_T("%i"),nCountQueueCredit);
	Out.Replace(_T("[CounterQueueCredit]"), mCountQueueCredit);
	CString mCountQueueAll;
	mCountQueueAll.Format(_T("%i"),nCountQueue+nCountQueueBanned+nCountQueueFriend+nCountQueueCredit);
a2609 1
	Out.Replace(_T("[CounterAll]"), mCountQueueAll);
d2615 17
d3058 1
a3058 1
		CString session = "";			//ed2klink
d4048 2
a4049 1
				
d4057 1
a4057 1
			theApp.searchlist->AddFileToDownloadByHash(fileid);
d4082 3
d4099 3
a4101 1
	CString result=pThis->m_Templates.sSearchHeader +theApp.searchlist->GetWebList(pThis->m_Templates.sSearchResultLine);
a4117 5
	Out.Replace(_T("[Download]"), _GetPlainResString(IDS_DOWNLOAD));
	Out.Replace(_T("[Filesize]"), _GetPlainResString(IDS_DL_SIZE));
	Out.Replace(_T("[Sources]"), _GetPlainResString(IDS_DL_SOURCES));
	Out.Replace(_T("[Filehash]"), _GetPlainResString(IDS_FILEHASH));
	Out.Replace(_T("[Filename]"), _GetPlainResString(IDS_DL_FILENAME));
d4126 37
a4162 1
	
d4187 99
a4285 1
}@


1.132
log
@Implemented ConfigDir
@
text
@a262 57
void CWebServer::_ServerPrioUp(CString sIP, int nPort) ////
{
	EMULE_TRY

	CServer* server=theApp.serverlist->GetServerByAddress(sIP.GetBuffer(), nPort);
	if(server->GetPreferences()== CServer::ePR_LOW)
		server->SetPreference((CServer::eServerPriority)PR_NORMAL);
	else
		server->SetPreference((CServer::eServerPriority)PR_HIGH);
	if (theApp.emuledlg->serverwnd) 
		theApp.emuledlg->serverwnd.serverlistctrl.RefreshServer(*server);

	EMULE_CATCH
}

void CWebServer::_ServerPrioDown(CString sIP, int nPort) ////
{
	EMULE_TRY

	CServer* server=theApp.serverlist->GetServerByAddress(sIP.GetBuffer(), nPort);
	if(server->GetPreferences()== CServer::ePR_HIGH)
		server->SetPreference((CServer::eServerPriority)PR_NORMAL);
	else
		server->SetPreference((CServer::eServerPriority)PR_LOW);
	if (theApp.emuledlg->serverwnd) 
		theApp.emuledlg->serverwnd.serverlistctrl.RefreshServer(*server);
	EMULE_CATCH
}

void CWebServer::_SetSharedFilePriority(CString hash, uint8 priority)
{
	EMULE_TRY

	CKnownFile* cur_file;
	uchar fileid[16];
	DecodeBase16(hash.GetBuffer(),hash.GetLength(),fileid);

	cur_file=theApp.sharedfiles->GetFileByID(fileid);
	
	if (cur_file==0) return;

	if(priority >= 0 && priority < 5)
	{
		cur_file->SetAutoPriority(false);
		cur_file->SetPriority(priority);
	}
	else if(priority == 5 && cur_file->IsPartFile())
	{
		cur_file->SetAutoPriority(true);
		cur_file->UpdateUploadAutoPriority();
	}

	theApp.sharedfiles->UpdateItem(cur_file); // DonGato: refresh GUI on priority change 

	EMULE_CATCH
}

a785 2
	Out.Replace(_T("[PriorityUp]"), _GetPlainResString(IDS_PRIORITY_UP, true));
	Out.Replace(_T("[PriorityDown]"), _GetPlainResString(IDS_PRIORITY_DOWN, true));
d796 7
d969 1
a969 1
	else if (bAdmin && sCmd.CompareNoCase(_T("prioup")) == 0) ////
d972 16
a987 1
			_ServerPrioUp(sIP, nPort);
d989 1
a989 1
	else if (bAdmin && sCmd.CompareNoCase(_T("priodown")) == 0) ////
d992 6
a997 1
			_ServerPrioDown(sIP, nPort);
d1229 7
a1235 6
		CString admin = "";		//admin rights
		CString ed2k = "";		//ed2k
		CString session = "";	//session
		CString ip = "";		//ip
		CString port = "";		//port
		CString isstatic = "";	//serverstatic
d1261 15
a1275 1
		
d1282 1
d1325 1
a1325 1
			HTTPProcessData.Replace(_T("[Priority]"), ServerArray[i].sServerPriority); ////
d1445 11
a1455 1
			else if(bAdmin && sOp.CompareNoCase(_T("prioup")) == 0)
d1457 2
a1458 7
				if (!found_file->IsAutoPrioritized())
					switch (found_file->GetPriority()) {
						case PR_LOW: found_file->SetAutoPriority(false); found_file->SetPriority(PR_NORMAL);break;
						case PR_NORMAL: found_file->SetAutoPriority(false); found_file->SetPriority(PR_HIGH);break;
						case PR_HIGH: found_file->SetAutoPriority(true); found_file->SetPriority(PR_HIGH);break;
					}
				else {found_file->SetAutoPriority(false); found_file->SetPriority(PR_LOW);}
d1460 1
a1460 1
			else if(bAdmin && sOp.CompareNoCase(_T("priodown")) == 0)
d1462 1
a1462 7
				if (!found_file->IsAutoPrioritized())
					switch (found_file->GetPriority()) {
						case PR_LOW: found_file->SetAutoPriority(true); found_file->SetPriority(PR_HIGH);break;
						case PR_NORMAL: found_file->SetAutoPriority(false); found_file->SetPriority(PR_LOW);break;
						case PR_HIGH: found_file->SetAutoPriority(false); found_file->SetPriority(PR_NORMAL);break;
					}
				else {found_file->SetAutoPriority(false); found_file->SetPriority(PR_HIGH);}
d1684 4
d1697 2
a1698 10
			if (cur_file->IsAutoPrioritized())
			{
				cur_file->UpdateDownloadAutoPriority();
				dFile.nFilePrio = cur_file->GetPriority();
				dFile.nFilePrio+=10;
			}
			else
			{
				dFile.nFilePrio = cur_file->GetPriority();
			}
d1776 10
a1785 9
		CString admin = "";		//admin rights
		CString finfo = "";		//fileinfo
		CString ed2k = "";		//ed2klink
		CString state = "";		//state
		CString scb = "";		//dropscb
		CString autoa4af = "";	//autoa4af
		CString fname = "";		//filename
		CString session = "";	//session
		CString filehash = "";	//filehash
d1842 19
d1873 1
d1950 19
a1968 8
		if (!WSdownloadColumnHidden[6]) {
			switch(FilesArray[i].nFilePrio) {
				case  0: HTTPTemp=GetResString(IDS_PRIOLOW); break;
				case 10: HTTPTemp=GetResString(IDS_PRIOAUTOLOW); break;
				case  1: HTTPTemp=GetResString(IDS_PRIONORMAL); break;
				case 11: HTTPTemp=GetResString(IDS_PRIOAUTONORMAL); break;
				case  2: HTTPTemp=GetResString(IDS_PRIOHIGH); break;
				case 12: HTTPTemp=GetResString(IDS_PRIOAUTOHIGH); break;
a1977 2
    Out.Replace(_T("[PriorityUp]"), _GetPlainResString(IDS_PRIORITY_UP));
    Out.Replace(_T("[PriorityDown]"), _GetPlainResString(IDS_PRIORITY_DOWN));
d2404 46
a2449 2
	if(_ParseURL(Data.sURL, _T("hash")) != "" && _ParseURL(Data.sURL, _T("setpriority")) != "" && IsSessionAdmin(Data,sSession)) 
		_SetSharedFilePriority(_ParseURL(Data.sURL, _T("hash")),_tstoi(_ParseURL(Data.sURL, _T("setpriority"))));
d2749 26
a2774 25
		CString admin = "";			//admin rights
		CString ed2k = "";			//ed2klink
		CString session = "";		//ed2klink
		CString hash = "";			//hash
		CString fname = "";			//filename
		CString upprio = "";		//prioup
		CString lowprio = "";		//priodown
		CString isjumpstart = "";	//jumpstart

		uint8 upperpriority=0, lesserpriority=0;
		if(SharedArray[i].nFilePriority == 4) {
			upperpriority = 0;	lesserpriority = 4;
		} else if(SharedArray[i].nFilePriority == 0) {
			upperpriority = 1;	lesserpriority = 4;
		} else if(SharedArray[i].nFilePriority == 1) {
			upperpriority = 2;	lesserpriority = 0;
		} else if(SharedArray[i].nFilePriority == 2) {
			upperpriority = 3;	lesserpriority = 1;
		} else if(SharedArray[i].nFilePriority == 3) {
			upperpriority = 5;	lesserpriority = 2;
		} else if(SharedArray[i].nFilePriority == 5) {
			upperpriority = 5;	lesserpriority = 3;
		}
		if(SharedArray[i].bFileAutoPriority) {
			upperpriority = 5;	lesserpriority = 3;
d2776 2
a2790 5
		_stprintf(HTTPTempC, _T("%i"), upperpriority);
		upprio.Format(CString(HTTPTempC));
		_stprintf(HTTPTempC, _T("%i"), lesserpriority);
		lowprio.Format(CString(HTTPTempC));

d2814 1
a2814 2
		HTTPProcessData.Replace(_T("[upprio]"), upprio);
		HTTPProcessData.Replace(_T("[lowprio]"), lowprio);
@


1.131
log
@SecureIdent Support Mainly
Too many changes to mention here
@
text
@d173 1
a173 1
	fullpath.Format(_T("%spreferences.ini"),theApp.glob_prefs->GetAppDir());
d1042 1
a1042 1
		fullpath.Format(_T("%spreferences.ini"),theApp.glob_prefs->GetAppDir());
d1392 1
a1392 1
		fullpath.Format(_T("%spreferences.ini"),theApp.glob_prefs->GetAppDir());
d1404 1
a1404 1
		fullpath.Format(_T("%spreferences.ini"),theApp.glob_prefs->GetAppDir());
d1416 1
a1416 1
		fullpath.Format(_T("%spreferences.ini"),theApp.glob_prefs->GetAppDir());
d2407 1
a2407 1
		fullpath.Format(_T("%spreferences.ini"),theApp.glob_prefs->GetAppDir());
d3732 1
a3732 1
		fullpath.Format(_T("%spreferences.ini"),theApp.glob_prefs->GetAppDir());
@


1.130
log
@New sockets
@
text
@d2017 1
a2017 1
		else if (cur_client->credits->GetScoreRatio() > 1)
d2074 1
a2074 1
		else if (cur_client->credits->GetScoreRatio() > 1)
d2090 1
a2090 1
			if (!(cur_client->IsBanned())&&!(cur_client->IsFriend())&&!(cur_client->credits->GetScoreRatio() > 1))
d2252 1
a2252 1
			if ((cur_client->credits->GetScoreRatio() > 1)&&!(cur_client->IsBanned())&&!(cur_client->IsFriend()))
@


1.129
log
@*** empty log message ***
@
text
@d917 1
d926 1
@


1.128
log
@Updates/Fixes
@
text
@d1373 1
a1373 1
			theApp.emuledlg->transferwnd.downloadlistctrl.ClearCompleted();
d1377 1
a1377 1
				theApp.emuledlg->transferwnd.downloadlistctrl.ClearCompleted(FileHash);
d1686 1
a1686 1
	if (!theApp.emuledlg->transferwnd.downloadlistctrl.GetDisplayedFiles(&partlist))	//failsafe
@


1.127
log
@Fixes.
@
text
@d850 1
a850 2
	Out.Replace(_T("[AddToStatic]"), _GetPlainResString(IDS_ADDTOSTATIC, true));
	Out.Replace(_T("[RemoveFromStatic]"), _GetPlainResString(IDS_REMOVEFROMSTATIC, true));
d853 1
a853 2
	Out.Replace(_T("[AddFriend]"), _GetPlainResString(IDS_ADDFRIEND, true));
	Out.Replace(_T("[RemoveFriend]"), _GetPlainResString(IDS_REMOVEFRIEND, true));
@


1.126
log
@small quick stats changes
@
text
@d908 4
a911 1
	_stprintf(HTTPHeader, "%.1f", ((float)theApp.uploadqueue->GetDatarate()/1024)/(theApp.glob_prefs->GetMaxUpload())*100); 
d913 5
a917 1
	_stprintf(HTTPHeader, "%.1f", ((float)theApp.downloadqueue->GetDatarate()/1024)/(theApp.glob_prefs->GetMaxDownload())*100);
@


1.125
log
@latest mobile mule changes + some additional webserver stuff (see changelog)
@
text
@d935 6
@


1.124
log
@Another new sockets cumulative update
@
text
@d7 1
d19 2
a20 1
#define WEB_SERVER_TEMPLATES_VERSION	1000
d23 6
d171 11
d561 23
a583 1

d799 7
d821 3
d825 1
a827 1
	Out.Replace(_T("[Ed2klink]"), _GetPlainResString(IDS_SW_LINK));
a833 1
	Out.Replace(_T("[Ed2klink]"), _GetPlainResString(IDS_SW_LINK, true));
d847 2
d851 1
d854 2
d857 8
a864 2
	TCHAR HTTPTempC[100] = _T("");
	CString sConnected = _T("");
d866 5
a870 1
	if (theApp.serverconnect->IsConnected()) 
d873 1
a873 1
			sConnected = _GetPlainResString(IDS_CONNECTED);
d875 1
a875 2
			sConnected = _GetPlainResString(IDS_CONNECTED) + _T(" (") + _GetPlainResString(IDS_LOWID) + _T(")");

d877 9
a885 1
		sConnected += _T(": ") + CString(cur_server->GetListName());
d887 2
a888 5
		_stprintf(HTTPTempC, _T("%i "), cur_server->GetUsers());
		sConnected += _T(" [") + CString(HTTPTempC) + _GetPlainResString(IDS_LUSERS) + _T("]");

	} 
	else if (theApp.serverconnect->IsConnecting())
d890 3
a892 1
		sConnected = _GetPlainResString(IDS_CONNECTING);
d894 3
a896 2
	else
#endif //OLD_SOCKETS_ENABLED
d898 37
a934 17
		sConnected = _GetPlainResString(IDS_DISCONNECTED);
		if (IsSessionAdmin(Data,sSession)) sConnected+=_T(" (<small><a href=\"/?ses=") + sSession + _T("&w=server&c=connect\">")+_GetPlainResString(IDS_CONNECTTOANYSERVER)+_T("</a></small>)");
	}
	Out.Replace(_T("[Connected]"), _T("<b>")+_GetPlainResString(IDS_PW_CONNECTION)+_T(":</b> ")+sConnected);
    _stprintf(HTTPTempC, _GetPlainResString(IDS_UPDOWN),(float)theApp.uploadqueue->GetDatarate()/1024,(float)theApp.downloadqueue->GetDatarate()/1024);
	CString sLimits;
	// EC 25-12-2002
	CString MaxUpload;
	CString MaxDownload;
	MaxUpload.Format(_T("%i"),theApp.glob_prefs->GetMaxUpload());
	MaxDownload.Format(_T("%i"),theApp.glob_prefs->GetMaxDownload());
	if (MaxUpload == "65535")  MaxUpload = GetResString(IDS_PW_UNLIMITED);
	if (MaxDownload == "65535") MaxDownload = GetResString(IDS_PW_UNLIMITED);
	sLimits.Format(_T("%s/%s"), MaxUpload, MaxDownload);
	// EC Ends
	Out.Replace(_T("[Speed]"), _T("<b>")+_GetPlainResString(IDS_DL_SPEED)+_T(":</b> ")+CString(HTTPTempC) + _T("<small> (") + _GetPlainResString(IDS_PW_CON_LIMIT) + _T(": ") + sLimits + _T(")</small>"));

d1022 12
a1033 1

d1097 36
a1132 6
	Out.Replace(_T("[Servername]"), _GetPlainResString(IDS_SL_SERVERNAME));
	Out.Replace(_T("[Description]"), _GetPlainResString(IDS_DESCRIPTION));
	Out.Replace(_T("[Address]"), _GetPlainResString(IDS_IP));
	Out.Replace(_T("[Users]"), _GetPlainResString(IDS_LUSERS));
	Out.Replace(_T("[Files]"), _GetPlainResString(IDS_LFILES));
	Out.Replace(_T("[Priority]"), _GetPlainResString(IDS_PRIORITY)); ////
d1288 14
a1301 8
		if(ServerArray[i].sServerName.GetLength() > SHORT_LENGTH)
			HTTPProcessData.Replace(_T("[1]"), _T("<acronym title=\"") + ServerArray[i].sServerName + _T("\">") + ServerArray[i].sServerName.Left(SHORT_LENGTH) + _T("...") + _T("</acronym>"));
		else
			HTTPProcessData.Replace(_T("[1]"), ServerArray[i].sServerName);
		if(ServerArray[i].sServerDescription.GetLength() > SHORT_LENGTH)
			HTTPProcessData.Replace(_T("[2]"), _T("<acronym title=\"") + ServerArray[i].sServerDescription + _T("\">") + ServerArray[i].sServerDescription.Left(SHORT_LENGTH) + _T("...") + _T("</acronym>"));
		else
			HTTPProcessData.Replace(_T("[2]"), ServerArray[i].sServerDescription);
d1303 5
a1307 3
		CString sPort; sPort.Format(_T(":%d"), ServerArray[i].nServerPort);
		HTTPProcessData.Replace(_T("[3]"), ServerArray[i].sServerIP + sPort);

d1309 11
a1319 8
		if(ServerArray[i].nServerUsers > 0)
		{
			if(ServerArray[i].nServerMaxUsers > 0)
				sT.Format(_T("%d (%d)"), ServerArray[i].nServerUsers, ServerArray[i].nServerMaxUsers);
			else
				sT.Format(_T("%d"), ServerArray[i].nServerUsers);
		}
		HTTPProcessData.Replace(_T("[4]"), sT);
d1321 10
a1330 4
		if(ServerArray[i].nServerFiles > 0)
			sT.Format(_T("%d"), ServerArray[i].nServerFiles);
		HTTPProcessData.Replace(_T("[5]"), sT);
		HTTPProcessData.Replace(_T("[Priority]"), ServerArray[i].sServerPriority); ////
d1372 36
d1415 1
d1417 1
d1478 15
a1492 1

d1591 72
d1664 1
a1664 6
	Out.Replace(_T("[Filename]"), _GetPlainResString(IDS_DL_FILENAME));
	Out.Replace(_T("[Size]"), _GetPlainResString(IDS_DL_SIZE));
	Out.Replace(_T("[Transferred]"), _GetPlainResString(IDS_COMPLETE));
	Out.Replace(_T("[Progress]"), _GetPlainResString(IDS_DL_PROGRESS));
	Out.Replace(_T("[Speed]"), _GetPlainResString(IDS_DL_SPEED));
	Out.Replace(_T("[Sources]"), _GetPlainResString(IDS_DL_SOURCES));
a1665 3
	Out.Replace(_T("[UploadList]"), _GetPlainResString(IDS_ST_ACTIVEUPLOAD));
	Out.Replace(_T("[User]"), _GetPlainResString(IDS_QL_USERNAME));
	Out.Replace(_T("[Version]"), _GetPlainResString(IDS_INFLST_USER_CLIENTVERSION));
a1667 1
	Out.Replace(_T("[Prio]"), _GetPlainResString(IDS_PRIORITY));
d1717 1
a1717 1
				dFile.sED2kLink = cur_file->CreateED2kLink();
d1873 7
a1879 4
		if(FilesArray[i].sFileName.GetLength() > SHORT_LENGTH_MAX)
			HTTPProcessData.Replace(_T("[ShortFileName]"), FilesArray[i].sFileName.Left(SHORT_LENGTH_MAX) + _T("..."));
		else
			HTTPProcessData.Replace(_T("[ShortFileName]"), FilesArray[i].sFileName);
d1888 4
a1891 1
		HTTPProcessData.Replace(_T("[2]"), CastItoXBytes(FilesArray[i].lFileSize));
d1893 13
a1905 5
		if(FilesArray[i].lFileTransferred > 0)
		{
			fTotalTransferred += FilesArray[i].lFileTransferred;
			HTTPProcessData.Replace(_T("[3]"), CastItoXBytes(FilesArray[i].lFileTransferred));
		}
d1907 1
a1907 3
			HTTPProcessData.Replace(_T("[3]"), _T("-"));

		HTTPProcessData.Replace(_T("[DownloadBar]"), _GetDownloadGraph(Data,FilesArray[i].sFileHash));
d1911 11
a1921 8
		if(FilesArray[i].lFileSpeed > 0.0f)
		{
			fTotalSpeed += FilesArray[i].lFileSpeed;
			HTTPTemp.Format(_T("%8.2f %s"), FilesArray[i].lFileSpeed/1024.0 ,_GetPlainResString(IDS_KBYTESEC) );
			HTTPProcessData.Replace(_T("[4]"), HTTPTemp);
		}
		else
			HTTPProcessData.Replace(_T("[4]"), _T("-"));
d1923 4
a1926 3
		if(FilesArray[i].lSourceCount > 0)
		{
			HTTPTemp.Format(_T("%i&nbsp;/&nbsp;%8i&nbsp;(%i)"),
d1930 19
a1948 14
			HTTPProcessData.Replace(_T("[5]"), HTTPTemp);
		}
		else
			HTTPProcessData.Replace(_T("[5]"), _T("-"));

		switch(FilesArray[i].nFilePrio) {
			case  0: HTTPTemp=GetResString(IDS_PRIOLOW); break;
			case 10: HTTPTemp=GetResString(IDS_PRIOAUTOLOW); break;
			case  1: HTTPTemp=GetResString(IDS_PRIONORMAL); break;
			case 11: HTTPTemp=GetResString(IDS_PRIOAUTONORMAL); break;
			case  2: HTTPTemp=GetResString(IDS_PRIOHIGH); break;
			case 12: HTTPTemp=GetResString(IDS_PRIOAUTOHIGH); break;
		}
		HTTPProcessData.Replace(_T("[PrioVal]"), HTTPTemp);
d1978 9
a1991 5
		if(cur_client->GetUserName().GetLength() > SHORT_LENGTH_MIN)
            HTTPProcessData.Replace(_T("[1]"), _SpecialChars(cur_client->GetUserName().Left(SHORT_LENGTH_MIN)) + _T("..."));
		else
			HTTPProcessData.Replace(_T("[1]"), _SpecialChars(cur_client->GetUserName()));

a1998 1
		HTTPProcessData.Replace(_T("[ClientSoftV]"), GetClientNameAndVersionString(cur_client));
d2009 32
a2040 14
		CKnownFile* file = theApp.sharedfiles->GetFileByID(cur_client->reqfileid);
		if (file)
			HTTPProcessData.Replace(_T("[2]"), _SpecialChars(CString(file->GetFileName())));
		else
			HTTPProcessData.Replace(_T("[2]"), _GetPlainResString(IDS_REQ_UNKNOWNFILE));

		fTotalSize += cur_client->GetTransferedDown();
		fTotalTransferred += cur_client->GetTransferedUp();
		HTTPTemp.Format(_T("%s / %s"), CastItoXBytes(cur_client->GetTransferedDown()),CastItoXBytes(cur_client->GetTransferedUp()));
		HTTPProcessData.Replace(_T("[3]"), HTTPTemp);

		fTotalSpeed += cur_client->GetDatarate();
		HTTPTemp.Format(_T("%8.2f ") + _GetPlainResString(IDS_KBYTESEC), cur_client->GetDatarate()/1024.0);
		HTTPProcessData.Replace(_T("[4]"), HTTPTemp);
d2079 17
a2095 2
			if(cur_client->GetUserName().GetLength() > SHORT_LENGTH)
				HTTPProcessData.Replace(_T("[UserName]"), _SpecialChars(cur_client->GetUserName().Left(SHORT_LENGTH)) + _T("..."));
d2097 4
a2100 4
				HTTPProcessData.Replace(_T("[UserName]"), _SpecialChars(cur_client->GetUserName()));
			CKnownFile* file = theApp.sharedfiles->GetFileByID(cur_client->reqfileid);
			if (file)
				HTTPProcessData.Replace(_T("[FileName]"), _SpecialChars(file->GetFileName()));
d2102 1
a2102 3
				HTTPProcessData.Replace(_T("[FileName]"), _T("?"));
			_stprintf(HTTPTempC, _T("%i") , cur_client->GetScore(false));
			HTTPProcessData.Replace(_T("[Score]"), HTTPTempC);
a2104 1
			HTTPProcessData.Replace(_T("[ClientSoftV]"), GetClientNameAndVersionString(cur_client));
d2106 7
d2133 9
a2141 2
			if(cur_client->GetUserName().GetLength() > SHORT_LENGTH)
				HTTPProcessData.Replace(_T("[UserName]"), _SpecialChars(cur_client->GetUserName().Left(SHORT_LENGTH)) + _T("..."));
d2143 12
a2154 4
				HTTPProcessData.Replace(_T("[UserName]"), _SpecialChars(cur_client->GetUserName()));
			CKnownFile* file = theApp.sharedfiles->GetFileByID(cur_client->reqfileid);
			if (file)
				HTTPProcessData.Replace(_T("[FileName]"), _SpecialChars(file->GetFileName()));
d2156 1
a2156 3
				HTTPProcessData.Replace(_T("[FileName]"), _T("?"));
			_stprintf(HTTPTempC, _T("%i") , cur_client->GetScore(false));
			HTTPProcessData.Replace(_T("[Score]"), HTTPTempC);
a2158 1
			HTTPProcessData.Replace(_T("[ClientSoftV]"), GetClientNameAndVersionString(cur_client));
d2160 7
d2187 17
a2203 2
			if(cur_client->GetUserName().GetLength() > SHORT_LENGTH)
				HTTPProcessData.Replace(_T("[UserName]"), _SpecialChars(cur_client->GetUserName().Left(SHORT_LENGTH)) + _T("..."));
d2205 4
a2208 4
				HTTPProcessData.Replace(_T("[UserName]"), _SpecialChars(cur_client->GetUserName()));
			CKnownFile* file = theApp.sharedfiles->GetFileByID(cur_client->reqfileid);
			if (file)
				HTTPProcessData.Replace(_T("[FileName]"), _SpecialChars(file->GetFileName()));
d2210 1
a2210 3
				HTTPProcessData.Replace(_T("[FileName]"), _T("?"));
			_stprintf(HTTPTempC, _T("%i") , cur_client->GetScore(false));
			HTTPProcessData.Replace(_T("[Score]"), HTTPTempC);
a2212 1
			HTTPProcessData.Replace(_T("[ClientSoftV]"), GetClientNameAndVersionString(cur_client));
d2214 7
d2241 17
a2257 2
			if(cur_client->GetUserName().GetLength() > SHORT_LENGTH)
				HTTPProcessData.Replace(_T("[UserName]"), _SpecialChars(cur_client->GetUserName().Left(SHORT_LENGTH)) + _T("..."));
d2259 4
a2262 4
				HTTPProcessData.Replace(_T("[UserName]"), _SpecialChars(cur_client->GetUserName()));
			CKnownFile* file = theApp.sharedfiles->GetFileByID(cur_client->reqfileid);
			if (file)
				HTTPProcessData.Replace(_T("[FileName]"), _SpecialChars(file->GetFileName()));
d2264 1
a2264 3
				HTTPProcessData.Replace(_T("[FileName]"), _T("?"));
			_stprintf(HTTPTempC, _T("%i") , cur_client->GetScore(false));
			HTTPProcessData.Replace(_T("[Score]"), HTTPTempC);
a2266 1
			HTTPProcessData.Replace(_T("[ClientSoftV]"), GetClientNameAndVersionString(cur_client));
d2268 7
d2296 1
d2303 24
a2326 7
	Out.Replace(_T("[UserNameTitle]"), _GetPlainResString(IDS_QL_USERNAME));
	Out.Replace(_T("[Version]"), _GetPlainResString(IDS_INFLST_USER_CLIENTVERSION));
	Out.Replace(_T("[FileNameTitle]"), _GetPlainResString(IDS_DL_FILENAME));
	Out.Replace(_T("[ScoreTitle]"), _GetPlainResString(IDS_SCORE));
	Out.Replace(_T("[BannedTitle]"), _GetPlainResString(IDS_BANNED));
	Out.Replace(_T("[Session]"), sSession);

d2386 13
a2398 1
	CString sCmd = _ParseURL(Data.sURL, _T(""));
d2493 36
a2528 6
	Out.Replace(_T("[Filename]"), _GetPlainResString(IDS_DL_FILENAME));
	Out.Replace(_T("[Priority]"),  _GetPlainResString(IDS_PRIORITY));
    Out.Replace(_T("[FileTransferred]"),  _GetPlainResString(IDS_SF_TRANSFERRED));
    Out.Replace(_T("[FileRequests]"),  _GetPlainResString(IDS_SF_REQUESTS));
    Out.Replace(_T("[FileAccepts]"),  _GetPlainResString(IDS_SF_ACCEPTS));
	Out.Replace(_T("[Size]"), _GetPlainResString(IDS_DL_SIZE));
d2532 1
d2760 40
a2799 26
		if(SharedArray[i].sFileName.GetLength() > SHORT_LENGTH)
			HTTPProcessData.Replace(_T("[ShortFileName]"), _SpecialChars(SharedArray[i].sFileName.Left(SHORT_LENGTH)) + _T("..."));
		else
			HTTPProcessData.Replace(_T("[ShortFileName]"), _SpecialChars(SharedArray[i].sFileName));

		_stprintf(HTTPTempC, _T("%s"),CastItoXBytes(SharedArray[i].lFileSize));
		HTTPProcessData.Replace(_T("[FileSize]"), CString(HTTPTempC));

		_stprintf(HTTPTempC, _T("%s"),CastItoXBytes(SharedArray[i].nFileTransferred));
		HTTPProcessData.Replace(_T("[FileTransferred]"), CString(HTTPTempC));

		_stprintf(HTTPTempC, _T("%s"),CastItoXBytes(SharedArray[i].nFileAllTimeTransferred));
		HTTPProcessData.Replace(_T("[FileAllTimeTransferred]"), CString(HTTPTempC));

		_stprintf(HTTPTempC, _T("%i"), SharedArray[i].nFileRequests);
		HTTPProcessData.Replace(_T("[FileRequests]"), CString(HTTPTempC));

		_stprintf(HTTPTempC, _T("%i"), SharedArray[i].nFileAllTimeRequests);
		HTTPProcessData.Replace(_T("[FileAllTimeRequests]"), CString(HTTPTempC));

		_stprintf(HTTPTempC, _T("%i"), SharedArray[i].nFileAccepts);
		HTTPProcessData.Replace(_T("[FileAccepts]"), CString(HTTPTempC));

		_stprintf(HTTPTempC, _T("%i"), SharedArray[i].nFileAllTimeAccepts);
		HTTPProcessData.Replace(_T("[FileAllTimeAccepts]"), CString(HTTPTempC));
		HTTPProcessData.Replace(_T("[Priority]"), SharedArray[i].sFilePriority);
d3711 14
d3780 1
a3780 1
}
@


1.123
log
@Preparing for new sockets
@
text
@d314 1
d316 1
d336 1
d338 1
d2289 1
d2299 1
@


1.122
log
@new statistic (khaos based)
@
text
@d887 1
d894 1
d1038 1
d1057 1
@


1.121
log
@WebServer: enable limitless download on setting to 0, disable on setting a specific value
@
text
@d2601 2
a2602 1
	Out.Replace(_T("[Stats]"), theApp.emuledlg->statisticswnd.m_Stats.ExportHTML());
@


1.120
log
@Fixed Stop Connection Try.
@
text
@d2652 1
a2652 1
	    if(_ParseURL(Data.sURL, _T("maxdown")) != "")
d2654 8
a2661 5
		    if(_tstoi(_ParseURL(Data.sURL, _T("maxdown")))>0)
			    theApp.glob_prefs->SetMaxDownload(_tstoi(_ParseURL(Data.sURL, _T("maxdown"))));
//		    else
//			    theApp.glob_prefs->SetMaxDownload(65535);
	    }
d2667 1
a2667 1
//			    theApp.glob_prefs->SetMaxUpload(65535);
@


1.119
log
@eMailNotifier and PopUp CleanUp
@
text
@d887 7
a893 1
		theApp.emuledlg->SendMessage(WM_COMMAND, MP_DISCONNECT);
@


1.118
log
@Purity's changes
@
text
@d511 4
a514 7
					if(theApp.glob_prefs->IsSMTPWarningEnabled())
					{
						CSMTPConnection mail;
						CString txt;
						txt.Format(GetResString(IDS_WEB_INTRBLOCKTIME),theApp.glob_prefs->GetWSTempDisableLogin());
						mail.SendMuleMessage(txt);
					}
d522 4
a525 7
					if(theApp.glob_prefs->IsSMTPWarningEnabled())
					{
						CSMTPConnection mail;
						CString txt;
						txt.Format(GetResString(IDS_WEB_INTRWEBDISABLE));
						mail.SendMuleMessage(txt);
					}
@


1.117
log
@SMTP Messenger
@
text
@a501 10

				// DonGato - Sending message for WebServer intrussion
				if(theApp.glob_prefs->IsSMTPWarningEnabled())
				{
					CSMTPConnection mail;
					CString txt;
					txt.Format(GetResString(IDS_WEB_INTRTRIESLEFT),t_ulCurIP,theApp.glob_prefs->GetWSLoginAttemptsAllowed()-(pThis->m_nIntruderDetect));
					mail.SendMuleMessage(txt);
				}
				
d510 8
d524 8
@


1.116
log
@[UpState].gif bugfix
@
text
@d6 1
d502 10
@


1.115
log
@added new file state PS_STOPPED
@
text
@d1668 1
a1668 1
			HTTPProcessData.Replace(_T("[UpState]"), "uploading");
@


1.114
log
@fixed sorting servers by IP
@
text
@d1530 1
d1532 1
a1532 1
                if(!bIsComplete)
@


1.113
log
@fixed problem when displaying autopriority files priority
@
text
@d993 1
a993 1
		Entry.nServerUsers = cur_file->GetUsers();
d998 11
d1058 1
a1058 1
				bSwap = ServerArray[i].sServerIP.CompareNoCase(ServerArray[i+1].sServerIP) > 0;
@


1.112
log
@webserver sorting additions
@
text
@d1396 10
a1405 2
			dFile.nFilePrio = cur_file->GetPriority();
			if (cur_file->IsAutoPrioritized()) dFile.nFilePrio+=10;
@


1.111
log
@Small fix and template change.
@
text
@d925 3
d966 4
d998 1
a998 1
		if(cur_file->GetPreferences()== CServer::ePR_HIGH)
d1000 2
a1001 1
		else if(cur_file->GetPreferences()== CServer::ePR_NORMAL)
d1003 2
a1004 1
		else if(cur_file->GetPreferences()== CServer::ePR_LOW)
d1006 2
a1007 1

d1055 3
d1272 7
d1344 8
d1439 6
@


1.110
log
@Taking care of completig files.
@
text
@d1519 1
a1519 1
		if (FilesArray[i].bCompress)
d1524 1
a1524 1
		if (theApp.downloadqueue->GetA4AFAutoFile() == found_file)
@


1.109
log
@Updated WebServer+templates for last change showing.
@
text
@d766 1
d1472 2
@


1.108
log
@file state update
@
text
@d1076 5
d1435 5
d1475 2
a1476 1
				state.Format(_T("paused"));
d2151 5
@


1.107
log
@bugfix: no menu in shared files on filenames with single quotation mark :)
@
text
@a99 1
			m_Templates.sTransferDownLineGood = _LoadTemplate(sAll,_T("TMPL_TRANSFER_DOWN_LINE_GOOD"));
a102 1
			m_Templates.sTransferUpLineGood = _LoadTemplate(sAll,_T("TMPL_TRANSFER_UP_LINE_GOOD"));
a117 1
			m_Templates.sSharedLineChanged = _LoadTemplate(sAll,_T("TMPL_SHARED_LINE_CHANGED"));
a448 1
	CString OutE2 = _T("");
d1000 1
a1000 1
				Entry.sServerState = "Connecting";
d1002 1
a1002 1
				Entry.sServerState = "Disconnected";
d1008 1
a1008 1
					Entry.sServerState = "High";  
d1010 1
a1010 1
					Entry.sServerState = "Low";
d1012 1
a1012 1
				Entry.sServerState = "Disconnected";
d1015 1
a1015 1
			Entry.sServerState = "Disconnected";
a1334 1
	CString OutE2 = pThis->m_Templates.sTransferDownLineGood;
d1428 1
a1428 4
		if(FilesArray[i].lFileSpeed > 0)
			HTTPProcessData = OutE2;
		else
			HTTPProcessData = OutE;
d1446 5
d1465 1
a1465 2
				if(!bIsComplete)
					state.Format(_T("paused"));
d1490 1
a1490 1
	
d1497 1
a1497 1
		HTTPProcessData.Replace(_T("[state]"), state);
a1583 1
	OutE2 = pThis->m_Templates.sTransferUpLineGood;
d1597 2
a1598 1
		// if uploading, draw in other color
d1600 1
a1600 1
			HTTPProcessData = OutE2;
d1602 1
a1602 1
			HTTPProcessData = OutE;
a1997 1
	CString OutE2 = pThis->m_Templates.sSharedLineChanged; 
d2139 1
a2139 4
		if (SharedArray[i].sFileHash == _ParseURL(Data.sURL,_T("hash")) )
            HTTPProcessData = OutE2;
		else
            HTTPProcessData = OutE;
@


1.106
log
@Removed old Stored Sources from all code.
@
text
@d2186 1
@


1.105
log
@Corrected problem with context menu and some languages.
@
text
@d774 1
a774 1
	Out.Replace(_T("[AUTOA4AF]"), _GetPlainResString(IDS_ALL_A4AF_TO_HERE) + " (" + _GetPlainResString(IDS_PRIOAUTO, true) + ")"); // Purity: Auto-A4AF
@


1.104
log
@Corrected bug with completed files
@
text
@d768 11
a778 12
	Out.Replace(_T("[FileIsHashing]"), _GetPlainResString(IDS_HASHING));
	Out.Replace(_T("[FileIsErroneous]"), _GetPlainResString(IDS_ERRORLIKE));
	Out.Replace(_T("[FileDetails]"), _GetPlainResString(IDS_FD_TITLE));
	Out.Replace(_T("[Ed2klink]"), _GetPlainResString(IDS_SW_LINK));
	Out.Replace(_T("[A4AF]"), _GetPlainResString(IDS_ALL_A4AF_TO_HERE));
	Out.Replace(_T("[AUTOA4AF]"), _GetPlainResString(IDS_ALL_A4AF_TO_HERE) + " (" + _GetPlainResString(IDS_PRIOAUTO) + ")"); // Purity: Auto-A4AF
	Out.Replace(_T("[KeepSCB]"), _GetPlainResString(IDS_KEEPSUPERCOMPRESSED));
	Out.Replace(_T("[DropSCB]"), _GetPlainResString(IDS_DROPSUPERCOMPRESSED));
	Out.Replace(_T("[NoNeededSources]"), _GetPlainResString(IDS_DROPNONEEDEDSRCS));
	Out.Replace(_T("[Stop]"), _GetPlainResString(IDS_DL_STOP));
	Out.Replace(_T("[Resume]"), _GetPlainResString(IDS_DL_RESUME));
	Out.Replace(_T("[Cancel]"), _GetPlainResString(IDS_MAIN_BTN_CANCEL));
d780 9
a788 10
	Out.Replace(_T("[ConfirmJumpstart]"), _GetPlainResString(IDS_JS_DISABLE) + _T("\\n"));//+++
	Out.Replace(_T("[Jumpstart]"), _GetPlainResString(IDS_PRIOJUMPSTART));//+++
	Out.Replace(_T("[PriorityUp]"), _GetPlainResString(IDS_PRIORITY_UP));
	Out.Replace(_T("[PriorityDown]"), _GetPlainResString(IDS_PRIORITY_DOWN));
	Out.Replace(_T("[ClearCompleted]"), _GetPlainResString(IDS_DL_CLEAR));
	Out.Replace(_T("[Connect]"), _GetPlainResString(IDS_IRC_CONNECT));
	Out.Replace(_T("[RemoveServer]"), _GetPlainResString(IDS_REMOVETHIS));
	Out.Replace(_T("[ConfirmRemove]"), _GetPlainResString(IDS_WEB_CONFIRM_REMOVE_SERVER));
	Out.Replace(_T("[RemoveFromStatic]"), _GetPlainResString(IDS_REMOVEFROMSTATIC));
	Out.Replace(_T("[AddToStatic]"), _GetPlainResString(IDS_ADDTOSTATIC));
@


1.103
log
@Added Jumpstart selection to WebServer [Purity]
Minor fix for Win9x users
@
text
@d1470 2
a1471 1
				state.Format(_T("paused"));
@


1.102
log
@Polished WebServer context menu
@
text
@d303 40
d781 2
d1896 7
a1903 1
	{
a1904 1
	}
d2150 8
a2157 6
		CString admin = "";		//admin rights
		CString ed2k = "";		//ed2klink
		CString session = "";	//ed2klink
		CString hash = "";		//hash
		CString upprio = "";	//prioup
		CString lowprio = "";	//priodown
d2186 1
d2200 2
d2203 1
d2208 1
a2208 1
	
d2212 1
d2216 1
@


1.101
log
@Solved bugs in WS.
@
text
@d733 1
a733 1
	Out.Replace(_T("[AUTOA4AF]"), _GetPlainResString(IDS_ALL_A4AF_TO_HERE) + " (" + _GetPlainResString(IDS_PRIOAUTO) + ")");//Purity: Auto-A4AF
d822 1
a822 9
/*	HTTPTemp.SetString(_ParseURL(Data.sURL, _T("showserverline")));//Purity: Action Buttons
	if (HTTPTemp.CompareNoCase(_T("true")) == 0) {
		pThis->m_Params.bShowServerLine = true;
		pThis->m_Params.sShowServerIP = _ParseURL(Data.sURL, _T("ip"));
	} else if (HTTPTemp.CompareNoCase(_T("false")) == 0) {
		pThis->m_Params.bShowServerLine = false;
		pThis->m_Params.sShowServerIP = _ParseURL(Data.sURL, _T("ip"));
	}
*/
d952 1
a952 1
		Entry.bServerStatic = cur_file->IsStaticMember();	//purity (Add Remove from Static Server List in WebServer)
d954 1
a954 1
		if(cur_file->GetPreferences()== CServer::ePR_HIGH) ////
d1111 1
a1111 9
/*	HTTPTemp.SetString(_ParseURL(Data.sURL, _T("showtransferline")));//Purity: Action Buttons
	if (HTTPTemp.CompareNoCase(_T("true")) == 0) {
		pThis->m_Params.bShowTransferLine = true;
		pThis->m_Params.sShowTransferFile = _ParseURL(Data.sURL, _T("file"));
	} else if (HTTPTemp.CompareNoCase(_T("false")) == 0) {
		pThis->m_Params.bShowTransferLine = false;
		pThis->m_Params.sShowTransferFile = _ParseURL(Data.sURL, _T("file"));
	}
*/
d1141 1
a1141 1
		//unsafe _GetFileHash(_ParseURL(Data.sURL, _T("file")), FileHash);
d1144 2
a1145 2
		{	//SyruS all actions require a found file (removed double-check inside)
			if(bAdmin && sOp.CompareNoCase(_T("a4af")) == 0) // DonGato (added A4ADF action)
d1151 1
a1151 1
				theApp.downloadqueue->SetA4AFAutoFile(found_file);//Purity: Auto-A4AF
d1155 1
a1155 1
				theApp.downloadqueue->SetA4AFAutoFile(NULL);//Purity: Auto-A4AF
d1189 1
a1189 1
			else if(bAdmin && sOp.CompareNoCase(_T("compressed")) == 0)//Purity: DropSCB
d1193 1
a1193 1
			else if(bAdmin && sOp.CompareNoCase(_T("noneededsources")) == 0)//Purity: DropNNS
d1333 1
a1333 1
			dFile.bCompress = cur_file->GetDiscardSuperCompressed();//Purity: DropSCB
d1386 1
a1386 1
	uchar FileHashA4AF[16];//Purity: Auto-A4AF
d1410 2
a1411 2
		// Purity Auto A4AF
		_GetFileHash(FilesArray[i].sFileHash, FileHashA4AF);//Purity: Auto-A4AF
d1467 1
a1467 1
		// Purity: Showing status for files (A4AF & SCB)
a1486 1
		//HTTPProcessData.Replace(_T("[ED2KLink]"), FilesArray[i].sED2kLink + _T("/"));	//purity
d1812 1
a1812 9
/*	HTTPTemp.SetString(_ParseURL(Data.sURL, _T("showsharedline")));//Purity: Action Buttons
	if (HTTPTemp.CompareNoCase(_T("true")) == 0) {
		pThis->m_Params.bShowSharedLine = true;
		pThis->m_Params.sShowSharedFile = _ParseURL(Data.sURL, _T("file"));
	} else if (HTTPTemp.CompareNoCase(_T("false")) == 0) {
		pThis->m_Params.bShowSharedLine = false;
		pThis->m_Params.sShowSharedFile = _ParseURL(Data.sURL, _T("file"));
	}
*/
d2149 3
a2151 1
		if (cur_file->GetPriority() == PR_VERYHIGH)
a2152 2
		else if (cur_file->GetJumpstartEnabled())
			HTTPProcessData.Replace(_T("[FileIsPriority]"), "jumpstart");
@


1.100
log
@WebServer update for better browser compatibility and some other graphic changes [Purity/DonGato]
@
text
@d1449 1
@


1.99
log
@WebServer: updated code to take care of erroneous and hashing files
@
text
@d302 1
a1456 1

d1458 1
a1458 1
					filehash.Format(CString(FilesArray[i].sFileHash));
d1482 8
a1489 8
		if(FilesArray[i].nFileStatus == PS_COMPLETE)
			HTTPProcessData.Replace(_T("[FileIcon]"), _T("none"));
		else if(FilesArray[i].bCompress && (theApp.downloadqueue->GetA4AFAutoFile() == found_file))
			HTTPProcessData.Replace(_T("[FileIcon]"), _T("scba4af"));
		else if(FilesArray[i].bCompress)
			HTTPProcessData.Replace(_T("[FileIcon]"), _T("scb"));
		else if(theApp.downloadqueue->GetA4AFAutoFile() == found_file)
			HTTPProcessData.Replace(_T("[FileIcon]"), _T("a4af"));
d1491 2
a1492 2
			HTTPProcessData.Replace(_T("[FileIcon]"), _T("none"));
			
d1502 1
a1502 1
		HTTPProcessData.Replace(_T("[ED2KLink]"), FilesArray[i].sED2kLink + _T("/"));	//purity
d2166 13
@


1.98
log
@Update of priorities on GUI when changed on server.
@
text
@d727 2
d1423 1
a1423 10
		CString JSfileinfo=FilesArray[i].sFileInfo;
		JSfileinfo.Replace(_T("\n"),_T("\\n"));
		JSfileinfo.Replace(_T("'"),_T("&#8217;")); // EC 22/5 - Chararacter ' causes a problem in javascript:alert()

		CString JSED2kLink=FilesArray[i].sED2kLink;
		JSED2kLink.Replace(_T("'"),_T("&#8217;"));

		finfo.Format(JSfileinfo);
		ed2k.Format(JSED2kLink);
		fname.Format(FilesArray[i].sFileNameJS);
a1428 3
		session.Format(CString(sSession));
		filehash.Format(CString(FilesArray[i].sFileHash));

d1431 7
d1440 1
a1441 1
				break;
a1443 3
			case PS_HASHING: 
			case PS_WAITINGFORHASH:
			case PS_ERROR:
d1446 15
a1460 1
					if (FilesArray[i].bCompress)
d1462 2
a1463 1
					if (theApp.downloadqueue->GetA4AFAutoFile() == found_file)
@


1.97
log
@Last fixes for WebServer
@
text
@d295 1
a295 1
		cur_file->UpdateUploadAutoPriority(); 
d298 2
d3021 4
a3024 2
	CKnownFile* known_file=theApp.knownfiles->FindKnownFileByID(fileid);
	if (known_file && !known_file->IsPartFile()) {
d3031 1
a3031 1
		cur_file=theApp.downloadqueue->GetFileByID(fileid);
@


1.96
log
@WebServer:
- auto A4AF file now it's shown
- added fialed login message to login screen (no tries shown as it is a security concern)
ServerList:
- now static DynDns servers are accepted if no server filtering selected
@
text
@d1434 3
a1436 1
		bool bCanBeDeleted = true;
d1441 1
a1441 1
				bCanBeDeleted = false;
d1443 2
d1448 1
a1448 4
				break;
			case PS_PAUSED:
				state.Format(_T("paused"));
			default: // waiting or downloading
a1449 2
					session.Format(CString(sSession));
					filehash.Format(CString(FilesArray[i].sFileHash));
a1459 2
		if (FilesArray[i].nFileStatus == PS_COMPLETE)
			state.Format(_T("complete"));
d1471 4
a1474 2
		if (FilesArray[i].bCompress && (theApp.downloadqueue->GetA4AFAutoFile() == found_file))
			HTTPProcessData.Replace(_T("[FileIsSCB]"), _T("scba4af"));
d1476 1
a1476 1
			HTTPProcessData.Replace(_T("[FileIsSCB]"), _T("scb"));
d1478 1
a1478 1
			HTTPProcessData.Replace(_T("[FileIsSCB]"), _T("a4af"));
d1480 1
a1480 1
			HTTPProcessData.Replace(_T("[FileIsSCB]"), _T("none"));
@


1.95
log
@Corrected problem with ' and JS in new WS context menu
Removed unused code for SLS
@
text
@a415 1
	//char	HTTPTempC[100] = "";
d478 1
a478 1
			}else{//End Johnny-B -IntruderDetection
d1430 4
a1452 2
					_GetFileHash(FilesArray[i].sFileHash, FileHashA4AF);//Purity: Auto-A4AF
					CPartFile* found_file = theApp.downloadqueue->GetFileByID(FileHashA4AF);
d1474 3
a1476 1
		if (FilesArray[i].bCompress)
d1478 2
d2686 5
@


1.94
log
@FEATURE: logging countermeasures made optional [Netwolf]
plus cleanup of unused prefs (transfer full chunks, global load f/l chunks first...)
@
text
@d1424 3
d1428 1
a1428 1
		ed2k.Format(FilesArray[i].sED2kLink);
d2140 4
a2143 1
		ed2k.Format(CString(SharedArray[i].sED2kLink));
@


1.93
log
@Web Server: showing SCB files and Static servers, and updated icons to be smaller.
@
text
@a2539 3

//		theApp.glob_prefs->SetTransferFullChunks((_ParseURL(Data.sURL, "fullchunks") == "on"));
//		theApp.glob_prefs->SetPreviewPrio((_ParseURL(Data.sURL, "firstandlast") == "on"));
a2582 16
	if(theApp.glob_prefs->GetPreviewPrio())
	{
		Out.Replace(_T("[FirstAndLastVal]"), _T("checked"));
	}
	else
	{
		Out.Replace(_T("[FirstAndLastVal]"), _T(""));
	}
	if(theApp.glob_prefs->TransferFullChunks())
	{
		Out.Replace(_T("[FullChunksVal]"), _T("checked"));
	}
	else
	{
		Out.Replace(_T("[FullChunksVal]"), _T(""));
	}
a2628 2
	Out.Replace(_T("[TryFullChunks]"), _GetPlainResString(IDS_TRF_FULL_CHUNKS));
	Out.Replace(_T("[FirstAndLast]"), _GetPlainResString(IDS_MOVIE));
@


1.92
log
@Last changes to WebServer (allow caching of images by browser)
@
text
@d1051 1
d1053 1
d1055 5
a1059 1
	
d1067 1
a1067 1
		// DonGato (reduced large servernames or descriptions)
d1470 5
@


1.91
log
@FEATURE: WebServer: added Auto-A4AF feature [Purity]
@
text
@d52 1
a52 1
	CTime t = GetCurrentTime();
d352 18
a369 10
		else if (filename.Right(4).MakeLower()==".jpg"  || filename.Right(5).MakeLower()==".jpeg") contenttype="Content-Type: image/jpg\r\n";
		else if (filename.Right(4).MakeLower()==".bmp") contenttype="Content-Type: image/bmp\r\n";
		else if (filename.Right(4).MakeLower()==".png") contenttype="Content-Type: image/png\r\n";
		//(0.29b) //DonQ - additional filetypes
		else if (filename.Right(4).MakeLower()==".ico") contenttype="Content-Type: image/x-icon\r\n";
		else if (filename.Right(4).MakeLower()==".css") contenttype="Content-Type: text/css\r\n";
		else if (filename.Right(3).MakeLower()==".js") contenttype="Content-Type: text/javascript\r\n";

	contenttype += _T("Last-Modified: ") + pThis->m_Params.sLastModified + _T("\r\n") +
		_T("ETag: ") + pThis->m_Params.sETag + _T("\r\n");
@


1.90
log
@More updates to Webserver. :P
@
text
@d721 1
d1143 2
a1144 1
			if(bAdmin && sOp.CompareNoCase(_T("a4af")) == 0) { // DonGato (added A4ADF action)
d1146 8
a1153 12
					//{//---
					//	DownloadAllA4AF(file);
					//}
					//{
					//	if (file->IsA4AFAuto())
					//	{
					//		file->SetA4AFAuto(false);
					//	} else {
					//		theApp.downloadqueue->DisableAllA4AFAuto();
					//		file->SetA4AFAuto(true);
					//	}
					//}
d1384 2
d1401 1
d1433 4
d1451 1
@


1.89
log
@Minor update for Web Server
@
text
@d1951 1
d2127 5
@


1.88
log
@Added eMuleLight template
@
text
@d17 1
a17 1
#define WEB_SERVER_TEMPLATES_VERSION	4
a27 9
	m_Params.bShowTransferLine = false;//Purity: Action Buttons
	m_Params.sShowTransferFile = "";//Purity: Action Buttons

	m_Params.bShowServerLine = false;//Purity: Action Buttons
	m_Params.sShowServerIP = "";//Purity: Action Buttons

	m_Params.bShowSharedLine = false;//Purity: Action Buttons
	m_Params.sShowSharedFile = "";//Purity: Action Buttons

d809 1
a809 1
	HTTPTemp.SetString(_ParseURL(Data.sURL, _T("showserverline")));//Purity: Action Buttons
d817 1
a817 1

d1100 1
a1100 1
	HTTPTemp.SetString(_ParseURL(Data.sURL, _T("showtransferline")));//Purity: Action Buttons
d1108 1
a1108 1

d1785 1
a1785 1
	HTTPTemp.SetString(_ParseURL(Data.sURL, _T("showsharedline")));//Purity: Action Buttons
d1793 1
a1793 1

@


1.87
log
@Added popup menus to WebServer (tested with Opera 7 and IE 5/6).
Should work with IE4+ and NS4+
@
text
@d1459 2
a1460 2
		if(FilesArray[i].sFileName.GetLength() > SHORT_LENGTH)
			HTTPProcessData.Replace(_T("[ShortFileName]"), FilesArray[i].sFileName.Left(SHORT_LENGTH) + _T("..."));
d1549 2
a1550 2
		if(cur_client->GetUserName().GetLength() > SHORT_LENGTH2)
            HTTPProcessData.Replace(_T("[1]"), _SpecialChars(cur_client->GetUserName().Left(SHORT_LENGTH2)) + _T("..."));
@


1.86
log
@FATURE: specify path to WebServer template in preferences
@
text
@d17 1
a17 1
#define WEB_SERVER_TEMPLATES_VERSION	1000
a103 1
			m_Templates.sServerLineAction = _LoadTemplate(sAll,_T("TMPL_SERVER_LINE_ACTION"));//Purity: Action Buttons
a109 1
			m_Templates.sTransferDownLineAction = _LoadTemplate(sAll,_T("TMPL_TRANSFER_DOWN_LINE_ACTION"));//Purity: Action Buttons
a129 1
			m_Templates.sSharedLineAction = _LoadTemplate(sAll,_T("TMPL_SHARED_LINE_ACTION"));//Purity: Action Buttons
d727 19
d1033 17
a1049 33
		CString sButton1 = "";//ed2klink
		CString sButton2 = "";//connect
		CString sButton3 = "";//remove
		CString sButton4 = "";//prioup
		CString sButton5 = "";//priodown
		CString sButton6 = "";//serverstatic

		//if ((pThis->m_Params.bShowServerLine) && (pThis->m_Params.sShowServerIP == ServerArray[i].sServerIP))//Purity: Action Buttons
		//{
			CString sServerPort;
			sServerPort.Format(_T("%d"), ServerArray[i].nServerPort);
			sButton1.Format(_T("<acronym title=\"ed2k://|server|[ServerIPPort]/\"><a href=\"ed2k://|server|[ServerIPPort]/\" style=\"text-decoration: none\"><img src=\"l_ed2klink.gif\" alt=\"ed2k://|server|[ServerIPPort]/\"></a></acronym>&nbsp;"));
			sButton1.Replace(_T("[ServerIPPort]"), ServerArray[i].sServerIP + ":" + sServerPort);

			if (bAdmin) {
				sButton2.Format(_T("<acronym title=\"[Connect]\"><a href=\"[ConnectServer]\" style=\"text-decoration: none\"><img src=\"l_connect.gif\" alt=\"[Connect]\"></a></acronym></a></acronym>&nbsp;"));
				sButton2.Replace(_T("[ConnectServer]"), bAdmin? CString(_T("/?ses=") + sSession + _T("&w=server&c=connect&ip=") + ServerArray[i].sServerIP + _T("&port=") + sServerPort):GetPermissionDenied());
				sButton2.Replace(_T("[Connect]"), _GetPlainResString(IDS_IRC_CONNECT));

				sButton3.Format(_T("<acronym title=\"[RemoveServer]\"><a href=\"[LinkRemove]\" onclick=\"return confirm('[ConfirmRemove]')\"><img src=\"l_cancel.gif\" alt=\"[RemoveServer]\"></a></acronym>&nbsp;"));
				sButton3.Replace(_T("[RemoveServer]"), _GetPlainResString(IDS_REMOVETHIS));
				sButton3.Replace(_T("[LinkRemove]"), bAdmin?CString(_T("/?ses=") + sSession + _T("&w=server&c=remove&ip=") + ServerArray[i].sServerIP + _T("&port=") + sServerPort):GetPermissionDenied());
				sButton3.Replace(_T("[ConfirmRemove]"), _GetPlainResString(IDS_WEB_CONFIRM_REMOVE_SERVER));

				if (ServerArray[i].bServerStatic) {
					sButton4.Format(_T("<acronym title=\"[RemoveFromStatic]\"><a href=\"[LinkRemoveFromStatic]\"><img src=\"l_remove.gif\" alt=\"[RemoveFromStatic]\"></a></acronym>&nbsp;"));
					sButton4.Replace(_T("[RemoveFromStatic]"), _GetPlainResString(IDS_REMOVEFROMSTATIC));
					sButton4.Replace(_T("[LinkRemoveFromStatic]"), bAdmin?CString(_T("/?ses=") + sSession + _T("&w=server&c=removefromstatic&ip=") + ServerArray[i].sServerIP + _T("&port=") + sServerPort):GetPermissionDenied());
				} else {
					sButton4.Format(_T("<acronym title=\"[AddToStatic]\"><a href=\"[LinkAddToStatic]\"><img src=\"l_add.gif\" alt=\"[AddToStatic]\"></a></acronym>&nbsp;"));
					sButton4.Replace(_T("[AddToStatic]"), _GetPlainResString(IDS_ADDTOSTATIC));
					sButton4.Replace(_T("[LinkAddToStatic]"), bAdmin?CString(_T("/?ses=") + sSession + _T("&w=server&c=addtostatic&ip=") + ServerArray[i].sServerIP + _T("&port=") + sServerPort):GetPermissionDenied());
				}
d1051 2
a1052 21
				sButton5.Format(_T("<acronym title=\"[PrioUp]\"><a href=\"[LinkPrioUp]\"><img src=\"l_up.gif\" alt=\"[PrioUp]\"></a></acronym>&nbsp;"));
				sButton5.Replace(_T("[LinkPrioUp]"), bAdmin?CString(_T("/?ses=") + sSession + _T("&w=server&c=prioup&ip=") + ServerArray[i].sServerIP + _T("&port=") + sServerPort):GetPermissionDenied()); ////
				sButton5.Replace(_T("[PrioUp]"), _GetPlainResString(IDS_PRIORITY_UP)); ////

				sButton6.Format(_T("<acronym title=\"[PrioDown]\"><a href=\"[LinkPrioDown]\"><img src=\"l_down.gif\" alt=\"[PrioDown]\"></a></acronym>&nbsp;"));
				sButton6.Replace(_T("[LinkPrioDown]"), bAdmin?CString(_T("/?ses=") + sSession + _T("&w=server&c=priodown&ip=") + ServerArray[i].sServerIP + _T("&port=") + sServerPort):GetPermissionDenied()); ////
				sButton6.Replace(_T("[PrioDown]"), _GetPlainResString(IDS_PRIORITY_DOWN)); ////
			}
			CString sMenu = _T("<a href=\"/?ses=[Session]&amp;w=server&amp;showserverline=false&ip=") + ServerArray[i].sServerIP +_T("\"><img src=\"l_remove.gif\"></a>");
			sMenu.Replace(_T("[Session]"), sSession);
			HTTPProcessData.Replace(_T("[Buttons]"), pThis->m_Templates.sServerLineAction);
			HTTPProcessData.Replace(_T("[Menu]"), "");//Remove
		//	HTTPProcessData.Replace(_T("[Menu]"), sMenu);
		//}
		//else//Purity: Action Buttons
		//{
		//	CString sMenu = _T("<a href=\"/?ses=[Session]&amp;w=server&amp;showserverline=true&ip=") + ServerArray[i].sServerIP +_T("\"><img src=\"l_add.gif\"></a>");
		//	sMenu.Replace(_T("[Session]"), sSession);
		//	HTTPProcessData.Replace(_T("[Buttons]"), "");
		//	HTTPProcessData.Replace(_T("[Menu]"), sMenu);
		//}
d1054 6
a1059 6
		HTTPProcessData.Replace(_T("[Button1]"), sButton1);
		HTTPProcessData.Replace(_T("[Button2]"), sButton2);
		HTTPProcessData.Replace(_T("[Button3]"), sButton3);
		HTTPProcessData.Replace(_T("[Button4]"), sButton4);
		HTTPProcessData.Replace(_T("[Button5]"), sButton5);
		HTTPProcessData.Replace(_T("[Button6]"), sButton6);
a1137 1
	{
d1139 2
a1140 22
/*		if (HTTPTemp.Right(1) != "/")
			HTTPTemp += "/";
		try 
		{
			CED2KLink* pLink = CED2KLink::CreateLinkFromUrl(HTTPTemp);
			_ASSERT( pLink !=0 );
			if (pLink->GetKind() == CED2KLink::kFile)
				theApp.downloadqueue->AddFileLinkToDownload(pLink->GetFileLink());
			else
				throw CString("bad link");
			delete pLink;
		}
		catch(CString error)
		{
			char HTTPTempC[100] = "";
			sprintf(HTTPTempC,_GetPlainResString(IDS_ERR_INVALIDLINK),error.GetBuffer());
			Out += pThis->m_Templates.sTransferBadLink;
			Out.Replace("[InvalidLink]", HTTPTempC);
			Out.Replace("[Link]", HTTPTemp);
		}
*/
	} else HTTPTemp.Empty();	//free for reusing
d1405 31
a1435 33
		CString sButton1 = "";//alert
		CString sButton2 = "";//ed2klink
		CString sButton3 = "";//a4af
		CString sButton4 = "";//dropscb
		CString sButton5 = "";//dropnns
		CString sButton6 = "";//stop-resume
		CString sButton7 = "";//cancel-clearcomplete
		CString sButton8 = "";//prioup
		CString sButton9 = "";//priodown

		//if ((pThis->m_Params.bShowTransferLine) && (pThis->m_Params.sShowTransferFile == FilesArray[i].sFileHash))//Purity: Action Buttons
		//{
			CString JSfileinfo=FilesArray[i].sFileInfo;
			JSfileinfo.Replace(_T("\n"),_T("\\n"));
			JSfileinfo.Replace(_T("'"),_T("&#8217;")); // EC 22/5 - Chararacter ' causes a problem in javascript:alert()

			sButton1.Format(_T("<acronym title=\"") + FilesArray[i].sFileStatus + _T("\"><a href=\"javascript:alert(\'")+JSfileinfo+_T("')\"><img src=\"l_info.gif\" alt=\"") + FilesArray[i].sFileStatus + _T("\"></a></acronym>&nbsp;"));
			
			sButton2.Format(_T("<acronym title=\"[Ed2klink]\"><a href=\"")+ FilesArray[i].sED2kLink +_T("\"><img src=\"l_ed2klink.gif\" alt=\"[Ed2klink]\"></a></acronym>&nbsp;"));
			sButton2.Replace(_T("[Ed2klink]"), _GetPlainResString(IDS_SW_LINK));

			bool bCanBeDeleted = true;
			switch(FilesArray[i].nFileStatus)
			{
				case PS_COMPLETING:
				case PS_COMPLETE:
					bCanBeDeleted = false;
					break;
				case PS_HASHING: 
				case PS_WAITINGFORHASH:
				case PS_ERROR:
					break;
				case PS_PAUSED:
d1437 4
a1440 11
					if (bAdmin) {
						sButton3.Format(_T("<img src=\"l_a4af_no.gif\">&nbsp;"));
						sButton4.Format(_T("<img src=\"l_keepscb_no.gif\">&nbsp;"));
						sButton5.Format(_T("<img src=\"l_dropnns_no.gif\">&nbsp;"));
						sButton6.Format(_T("<acronym title=\"[Resume]\"><a href=\"[Link]\"><img src=\"l_resume.gif\" alt=\"[Resume]\"></a></acronym>&nbsp;"));
						sButton6.Replace(_T("[Link]"), CString(_T("/?ses=") + sSession + _T("&w=transfer&op=resume&file=") + FilesArray[i].sFileHash)) ;
						sButton6.Replace(_T("[Resume]"), _GetPlainResString(IDS_DL_RESUME));
						sButton7.Format(_T("<img src=\"l_cancel_no.gif\">&nbsp;"));
						sButton8.Format(_T("<img src=\"l_up.gif\">&nbsp;"));
						sButton9.Format(_T("<img src=\"l_down.gif\">&nbsp;"));
					}
d1442 2
a1443 32
					break; 
				default: // waiting or downloading
				{
					if (bAdmin) {
						//DonGato (added A4AF action)
						sButton3.Format(_T("<acronym title=\"[A4AF]\"><a href=\"/?ses=[Session]&amp;w=transfer&op=a4af&file=") + FilesArray[i].sFileHash+_T("\"><img src=\"l_a4af.gif\" alt=\"[A4AF]\"></a></acronym>&nbsp;"));
						sButton3.Replace(_T("[A4AF]"), _GetPlainResString(IDS_ALL_A4AF_TO_HERE));

						if (FilesArray[i].bCompress) {
							sButton4.Format(_T("<acronym title=\"[Compress]\"><a href=\"[Link]\"><img src=\"l_dropscb.gif\" alt=\"[Compress]\"></a></acronym>&nbsp;"));
							sButton4.Replace(_T("[Compress]"), _GetPlainResString(IDS_KEEPSUPERCOMPRESSED));
						} else {
							sButton4.Format(_T("<acronym title=\"[Compress]\"><a href=\"[Link]\"><img src=\"l_keepscb.gif\" alt=\"[Compress]\"></a></acronym>&nbsp;"));
							sButton4.Replace(_T("[Compress]"), _GetPlainResString(IDS_DROPSUPERCOMPRESSED));
						}
						sButton4.Replace(_T("[Link]"), CString(_T("/?ses=") + sSession + _T("&w=transfer&op=compressed&file=") + FilesArray[i].sFileHash)) ;//Purity: DropSCB

						sButton5.Format(_T("<acronym title=\"[NoNeededSources]\"><a href=\"[Link]\"><img src=\"l_dropnns.gif\" alt=\"[NoNeededSources]\"></a></acronym>&nbsp;"));//Purity: DropNNS
						sButton5.Replace(_T("[NoNeededSources]"), _GetPlainResString(IDS_DROPNONEEDEDSRCS));
						sButton5.Replace(_T("[Link]"), CString(_T("/?ses=") + sSession + _T("&w=transfer&op=noneededsources&file=") + FilesArray[i].sFileHash)) ;

						sButton6.Format(_T("<acronym title=\"[Stop]\"><a href=\"[Link]\"><img src=\"l_stop.gif\" alt=\"[Stop]\"></a></acronym>&nbsp;"));
						sButton6.Replace(_T("[Link]"), CString(_T("/?ses=") + sSession + _T("&w=transfer&op=stop&file=") + FilesArray[i].sFileHash));
						sButton6.Replace(_T("[Stop]"), _GetPlainResString(IDS_DL_STOP));

						sButton8.Format(_T("<acronym title=\"[PriorityUp]\"><a href=\"/?ses=[Session]&amp;w=transfer&op=prioup&file=") + FilesArray[i].sFileHash+_T("\"><img src=\"l_up.gif\" alt=\"[PriorityUp]\"></a></acronym>&nbsp;"));
						sButton9.Format(_T("<acronym title=\"[PriorityDown]\"><a href=\"/?ses=[Session]&amp;w=transfer&op=priodown&file=") + FilesArray[i].sFileHash+_T("\"><img src=\"l_down.gif\" alt=\"[PriorityDown]\"></a></acronym>&nbsp;"));

					}
				}
					break;
			}	//switch
d1445 13
a1457 40
			if (bAdmin) {
				if (bCanBeDeleted) {
					sButton7.Format(_T("<acronym title=\"[Cancel]\"><a href=\"[Link]\" onclick=\"return confirm(\'[ConfirmCancel]%s\')\"><img src=\"l_cancel.gif\" alt=\"[Cancel]\"></a></acronym>&nbsp;"), FilesArray[i].sFileNameJS);	//SyruS add filename
					sButton7.Replace(_T("[Link]"), CString(_T("/?ses=") + sSession + _T("&w=transfer&op=cancel&file=") + FilesArray[i].sFileHash));
					sButton7.Replace(_T("[Cancel]"), _GetPlainResString(IDS_MAIN_BTN_CANCEL));
					sButton7.Replace(_T("[ConfirmCancel]"), _GetPlainResString(IDS_Q_CANCELDL2, true));
				} else if (FilesArray[i].nFileStatus == PS_COMPLETE) {
					sButton3.Format(_T("<img src=\"l_a4af_no.gif\">&nbsp;"));
					sButton4.Format(_T("<img src=\"l_keepscb_no.gif\">&nbsp;"));
					sButton5.Format(_T("<img src=\"l_dropnns_no.gif\">&nbsp;"));
					sButton6.Format(_T("<img src=\"l_stop_no.gif\">&nbsp;"));
					sButton7.Format(_T("<acronym title=\"[ClearCompleted]\"><a href=\"/?ses=[Session]&amp;w=transfer&clearcompleted=") + FilesArray[i].sFileHash+_T("\"><img src=\"l_clear.gif\" alt=\"[ClearCompleted]\"></a></acronym>&nbsp;"));
					sButton7.Replace(_T("[ClearCompleted]"), _GetPlainResString(IDS_DL_CLEAR));
					sButton8.Format(_T("<img src=\"l_up.gif\">&nbsp;"));
					sButton9.Format(_T("<img src=\"l_down.gif\">&nbsp;"));
				}
			}
			CString sMenu = _T("<a href=\"/?ses=[Session]&amp;w=transfer&amp;showtransferline=false&file=") + FilesArray[i].sFileHash+_T("\"><img src=\"l_remove.gif\"></a>");
			sMenu.Replace(_T("[Session]"), sSession);
			HTTPProcessData.Replace(_T("[Buttons]"), pThis->m_Templates.sTransferDownLineAction);
			HTTPProcessData.Replace(_T("[Menu]"), "");//Remove
		//	HTTPProcessData.Replace(_T("[Menu]"), sMenu);
		//}
		//else//Purity: Action Buttons
		//{
		//	CString sMenu = _T("<a href=\"/?ses=[Session]&amp;w=transfer&amp;showtransferline=true&file=") + FilesArray[i].sFileHash+_T("\"><img src=\"l_add.gif\"></a>");
		//	sMenu.Replace(_T("[Session]"), sSession);
		//	HTTPProcessData.Replace(_T("[Buttons]"), "");
		//	HTTPProcessData.Replace(_T("[Menu]"), sMenu);
		//}

		HTTPProcessData.Replace(_T("[Button1]"), sButton1);
		HTTPProcessData.Replace(_T("[Button2]"), sButton2);
		HTTPProcessData.Replace(_T("[Button3]"), sButton3);
		HTTPProcessData.Replace(_T("[Button4]"), sButton4);
		HTTPProcessData.Replace(_T("[Button5]"), sButton5);
		HTTPProcessData.Replace(_T("[Button6]"), sButton6);
		HTTPProcessData.Replace(_T("[Button7]"), sButton7);
		HTTPProcessData.Replace(_T("[Button8]"), sButton8);
		HTTPProcessData.Replace(_T("[Button9]"), sButton9);
d2092 36
a2127 51
		CString sButton1 = "";//ed2klink
		CString sButton2 = "";//prioup
		CString sButton3 = "";//priodown

		//if ((pThis->m_Params.bShowSharedLine) && (pThis->m_Params.sShowSharedFile == SharedArray[i].sFileHash))//Purity: Action Buttons
		//{
			sButton1.Format(_T("<acronym title=\"[Ed2klink]\"><a href=\"[FileLink]\"><img src=\"l_ed2klink.gif\" alt=\"[Ed2klink]\"></a></acronym>&nbsp;"));
			sButton1.Replace(_T("[FileLink]"), SharedArray[i].sED2kLink);
			sButton1.Replace(_T("[Ed2klink]"), _GetPlainResString(IDS_SW_LINK));

			if (bAdmin) {
				uint8 upperpriority=0, lesserpriority=0;
				if(SharedArray[i].nFilePriority == 4) {
					upperpriority = 0;	lesserpriority = 4;
				} else if(SharedArray[i].nFilePriority == 0) {
					upperpriority = 1;	lesserpriority = 4;
				} else if(SharedArray[i].nFilePriority == 1) {
					upperpriority = 2;	lesserpriority = 0;
				} else if(SharedArray[i].nFilePriority == 2) {
					upperpriority = 3;	lesserpriority = 1;
				} else if(SharedArray[i].nFilePriority == 3) {
					upperpriority = 5;	lesserpriority = 2;
				} else if(SharedArray[i].nFilePriority == 5) {
					upperpriority = 5;	lesserpriority = 3;
				}
				if(SharedArray[i].bFileAutoPriority) {
					upperpriority = 5;	lesserpriority = 3;
				}
				sButton2.Format(_T("<acronym title=\"[PriorityUp]\"><a href=\"/?ses=[Session]&amp;w=shared&[PriorityUpLink]\"><img src=\"l_up.gif\" alt=\"[PriorityUp]\"></a></acronym>&nbsp;"));
				sButton2.Replace(_T("[PriorityUp]"), _GetPlainResString(IDS_PRIORITY_UP));
				_stprintf(HTTPTempC, _T("%i"), upperpriority);
				sButton2.Replace(_T("[PriorityUpLink]"), _T("hash=") + SharedArray[i].sFileHash + _T("&setpriority=") + CString(HTTPTempC));
	
				sButton3.Format(_T("<acronym title=\"[PriorityDown]\"><a href=\"/?ses=[Session]&amp;w=shared&[PriorityDownLink]\"><img src=\"l_down.gif\" alt=\"[PriorityDown]\"></a></acronym>&nbsp;"));
				sButton3.Replace(_T("[PriorityDown]"), _GetPlainResString(IDS_PRIORITY_DOWN));
		        _stprintf(HTTPTempC, _T("%i"), lesserpriority);
				sButton3.Replace(_T("[PriorityDownLink]"), _T("hash=") + SharedArray[i].sFileHash + _T("&setpriority=") + CString(HTTPTempC)); 
			}
			CString sMenu = _T("<a href=\"/?ses=[Session]&amp;w=shared&amp;showsharedline=false&file=") + SharedArray[i].sFileHash +_T("\"><img src=\"l_remove.gif\"></a>");
			sMenu.Replace(_T("[Session]"), sSession);
			HTTPProcessData.Replace(_T("[Buttons]"), pThis->m_Templates.sSharedLineAction);
			HTTPProcessData.Replace(_T("[Menu]"), "");//Remove
		//	HTTPProcessData.Replace(_T("[Menu]"), sMenu);
		//}
		//else//Purity: Action Buttons
		//{
		//	CString sMenu = _T("<a href=\"/?ses=[Session]&amp;w=shared&amp;showsharedline=true&file=") + SharedArray[i].sFileHash +_T("\"><img src=\"l_add.gif\"></a>");
		//	sMenu.Replace(_T("[Session]"), sSession);
		//	HTTPProcessData.Replace(_T("[Buttons]"), "");
		//	HTTPProcessData.Replace(_T("[Menu]"), sMenu);
		//}
d2129 6
a2134 3
		HTTPProcessData.Replace(_T("[Button1]"), sButton1);
		HTTPProcessData.Replace(_T("[Button2]"), sButton2);
		HTTPProcessData.Replace(_T("[Button3]"), sButton3);
@


1.85
log
@Changed icons on WebServer to be grayed when not enabled.
@
text
@d66 5
a70 1
	CString sFile = theApp.glob_prefs->GetAppDir() + CString("eMule.tmpl");
@


1.84
log
@FEATURE: Webserver: added option to drop Not Needed Sources in download list [Purity]
CHANGE: WebServer: action buttons cleanup [Purity]
@
text
@a1036 8
				sButton4.Format(_T("<acronym title=\"[PrioUp]\"><a href=\"[LinkPrioUp]\"><img src=\"l_up.gif\" alt=\"[PrioUp]\"></a></acronym>&nbsp;"));
				sButton4.Replace(_T("[LinkPrioUp]"), bAdmin?CString(_T("/?ses=") + sSession + _T("&w=server&c=prioup&ip=") + ServerArray[i].sServerIP + _T("&port=") + sServerPort):GetPermissionDenied()); ////
				sButton4.Replace(_T("[PrioUp]"), _GetPlainResString(IDS_PRIORITY_UP)); ////

				sButton5.Format(_T("<acronym title=\"[PrioDown]\"><a href=\"[LinkPrioDown]\"><img src=\"l_down.gif\" alt=\"[PrioDown]\"></a></acronym>&nbsp;"));
				sButton5.Replace(_T("[LinkPrioDown]"), bAdmin?CString(_T("/?ses=") + sSession + _T("&w=server&c=priodown&ip=") + ServerArray[i].sServerIP + _T("&port=") + sServerPort):GetPermissionDenied()); ////
				sButton5.Replace(_T("[PrioDown]"), _GetPlainResString(IDS_PRIORITY_DOWN)); ////

d1038 3
a1040 3
					sButton6.Format(_T("<acronym title=\"[RemoveFromStatic]\"><a href=\"[LinkRemoveFromStatic]\"><img src=\"l_remove.gif\" alt=\"[RemoveFromStatic]\"></a></acronym>&nbsp;"));
					sButton6.Replace(_T("[RemoveFromStatic]"), _GetPlainResString(IDS_REMOVEFROMSTATIC));
					sButton6.Replace(_T("[LinkRemoveFromStatic]"), bAdmin?CString(_T("/?ses=") + sSession + _T("&w=server&c=removefromstatic&ip=") + ServerArray[i].sServerIP + _T("&port=") + sServerPort):GetPermissionDenied());
d1042 3
a1044 3
					sButton6.Format(_T("<acronym title=\"[AddToStatic]\"><a href=\"[LinkAddToStatic]\"><img src=\"l_add.gif\" alt=\"[AddToStatic]\"></a></acronym>&nbsp;"));
					sButton6.Replace(_T("[AddToStatic]"), _GetPlainResString(IDS_ADDTOSTATIC));
					sButton6.Replace(_T("[LinkAddToStatic]"), bAdmin?CString(_T("/?ses=") + sSession + _T("&w=server&c=addtostatic&ip=") + ServerArray[i].sServerIP + _T("&port=") + sServerPort):GetPermissionDenied());
d1046 8
d1444 6
a1449 8
		CString sButton4 = "";//resume
		CString sButton5 = "";//stop
		CString sButton6 = "";//dropscb
		CString sButton7 = "";//prioup
		CString sButton8 = "";//priodown
		CString sButton9 = "";//dropnns
		CString sButton10 = "";//cancel
		CString sButton11 = "";//clearcomplete
d1465 21
a1485 16
			case PS_COMPLETING:
			case PS_COMPLETE:
				bCanBeDeleted = false;
				break;
			case PS_HASHING: 
			case PS_WAITINGFORHASH:
			case PS_ERROR:
				break;
			case PS_PAUSED:
			{
				if (bAdmin) {
					sButton3.Format(_T("<img src=\"l_a4af_no.gif\">&nbsp;"));

					sButton4.Format(_T("<acronym title=\"[Resume]\"><a href=\"[Link]\"><img src=\"l_resume.gif\" alt=\"[Resume]\"></a></acronym>&nbsp;"));
					sButton4.Replace(_T("[Link]"), CString(_T("/?ses=") + sSession + _T("&w=transfer&op=resume&file=") + FilesArray[i].sFileHash)) ;
					sButton4.Replace(_T("[Resume]"), _GetPlainResString(IDS_DL_RESUME));
d1487 24
a1510 21
			}
				break; 
			default: // waiting or downloading
			{
				if (bAdmin) {
					//DonGato (added A4AF action)
					sButton3.Format(_T("<acronym title=\"[A4AF]\"><a href=\"/?ses=[Session]&amp;w=transfer&op=a4af&file=") + FilesArray[i].sFileHash+_T("\"><img src=\"l_a4af.gif\" alt=\"[A4AF]\"></a></acronym>&nbsp;"));
					sButton3.Replace(_T("[A4AF]"), _GetPlainResString(IDS_ALL_A4AF_TO_HERE));

					sButton5.Format(_T("<acronym title=\"[Stop]\"><a href=\"[Link]\"><img src=\"l_stop.gif\" alt=\"[Stop]\"></a></acronym>&nbsp;"));
					sButton5.Replace(_T("[Link]"), CString(_T("/?ses=") + sSession + _T("&w=transfer&op=stop&file=") + FilesArray[i].sFileHash));
					sButton5.Replace(_T("[Stop]"), _GetPlainResString(IDS_DL_STOP));

					if (FilesArray[i].bCompress) {
						sButton6.Format(_T("<acronym title=\"[Compress]\"><a href=\"[Link]\"><img src=\"l_dropscb.gif\" alt=\"[Compress]\"></a></acronym>&nbsp;"));
						sButton6.Replace(_T("[Compress]"), _GetPlainResString(IDS_KEEPSUPERCOMPRESSED));
					} else {
						sButton6.Format(_T("<acronym title=\"[Compress]\"><a href=\"[Link]\"><img src=\"l_keepscb.gif\" alt=\"[Compress]\"></a></acronym>&nbsp;"));
						sButton6.Replace(_T("[Compress]"), _GetPlainResString(IDS_DROPSUPERCOMPRESSED));
					}
					sButton6.Replace(_T("[Link]"), CString(_T("/?ses=") + sSession + _T("&w=transfer&op=compressed&file=") + FilesArray[i].sFileHash)) ;//Purity: DropSCB
d1512 2
a1513 1
					sButton7.Format(_T("<acronym title=\"[PriorityUp]\"><a href=\"/?ses=[Session]&amp;w=transfer&op=prioup&file=") + FilesArray[i].sFileHash+_T("\"><img src=\"l_up.gif\" alt=\"[PriorityUp]\"></a></acronym>&nbsp;"));
d1515 1
a1515 5
					sButton8.Format(_T("<acronym title=\"[PriorityDown]\"><a href=\"/?ses=[Session]&amp;w=transfer&op=priodown&file=") + FilesArray[i].sFileHash+_T("\"><img src=\"l_down.gif\" alt=\"[PriorityDown]\"></a></acronym>&nbsp;"));

					sButton9.Format(_T("<acronym title=\"[NoNeededSources]\"><a href=\"[Link]\"><img src=\"l_dropnns.gif\" alt=\"[NoNeededSources]\"></a></acronym>&nbsp;"));//Purity: DropNNS
					sButton9.Replace(_T("[NoNeededSources]"), _GetPlainResString(IDS_DROPNONEEDEDSRCS));
					sButton9.Replace(_T("[Link]"), CString(_T("/?ses=") + sSession + _T("&w=transfer&op=noneededsources&file=") + FilesArray[i].sFileHash)) ;
d1517 1
a1517 2
			}
				break;
d1522 4
a1525 4
					sButton10.Format(_T("<acronym title=\"[Cancel]\"><a href=\"[Link]\" onclick=\"return confirm(\'[ConfirmCancel]%s\')\"><img src=\"l_cancel.gif\" alt=\"[Cancel]\"></a></acronym>&nbsp;"), FilesArray[i].sFileNameJS);	//SyruS add filename
					sButton10.Replace(_T("[Link]"), CString(_T("/?ses=") + sSession + _T("&w=transfer&op=cancel&file=") + FilesArray[i].sFileHash));
					sButton10.Replace(_T("[Cancel]"), _GetPlainResString(IDS_MAIN_BTN_CANCEL));
					sButton10.Replace(_T("[ConfirmCancel]"), _GetPlainResString(IDS_Q_CANCELDL2, true));
d1527 8
a1534 2
					sButton11.Format(_T("<acronym title=\"[ClearCompleted]\"><a href=\"/?ses=[Session]&amp;w=transfer&clearcompleted=") + FilesArray[i].sFileHash+_T("\"><img src=\"l_clear.gif\" alt=\"[ClearCompleted]\"></a></acronym>&nbsp;"));
					sButton11.Replace(_T("[ClearCompleted]"), _GetPlainResString(IDS_DL_CLEAR));
a1559 2
		HTTPProcessData.Replace(_T("[Button10]"), sButton10);
		HTTPProcessData.Replace(_T("[Button11]"), sButton11);
@


1.83
log
@WebServer: corrected problem with priorities [BavarianSnail]
@
text
@d17 1
a17 1
#define WEB_SERVER_TEMPLATES_VERSION	3
d28 9
d100 1
d107 1
d128 1
d797 10
d1011 64
a1074 26
		CString sActions = _T("<acronym title=\"ed2k://|server|[ServerIPPort]/\"><a href=\"ed2k://|server|[ServerIPPort]/\" style=\"text-decoration: none\"><img src=\"l_ed2klink.gif\" alt=\"ed2k://|server|[ServerIPPort]/\"></a></acronym>&nbsp;");
		if (bAdmin) {
			sActions.Append(_T("<acronym title=\"[Connect]\"><a href=\"[ConnectServer]\" style=\"text-decoration: none\"><img src=\"l_connect.gif\" alt=\"[Connect]\"></a></acronym></a></acronym>&nbsp;"));
			sActions.Append(_T("<acronym title=\"[RemoveServer]\"><a href=\"[LinkRemove]\" onclick=\"return confirm('[ConfirmRemove]')\"><img src=\"l_cancel.gif\" alt=\"[RemoveServer]\"></a></acronym>&nbsp;"));
			sActions.Append(_T("<acronym title=\"[PrioUp]\"><a href=\"[LinkPrioUp]\"><img src=\"l_up.gif\" alt=\"[PrioUp]\"></a></acronym>&nbsp;"));
			sActions.Append(_T("<acronym title=\"[PrioDown]\"><a href=\"[LinkPrioDown]\"><img src=\"l_down.gif\" alt=\"[PrioDown]\"></a></acronym>&nbsp;"));
			if (ServerArray[i].bServerStatic)
				sActions.Append(_T("<acronym title=\"[RemoveFromStatic]\"><a href=\"[LinkRemoveFromStatic]\"><img src=\"l_remove.gif\" alt=\"[RemoveFromStatic]\"></a></acronym>&nbsp;"));
			else
				sActions.Append(_T("<acronym title=\"[AddToStatic]\"><a href=\"[LinkAddToStatic]\"><img src=\"l_add.gif\" alt=\"[AddToStatic]\"></a></acronym>&nbsp;"));
		}
		CString sServerPort; sServerPort.Format(_T("%d"), ServerArray[i].nServerPort);
		sActions.Replace(_T("[ServerIPPort]"), ServerArray[i].sServerIP + ":" + sServerPort);
		sActions.Replace(_T("[ConnectServer]"), bAdmin? CString(_T("/?ses=") + sSession + _T("&w=server&c=connect&ip=") + ServerArray[i].sServerIP + _T("&port=") + sServerPort):GetPermissionDenied());
		sActions.Replace(_T("[Connect]"), _GetPlainResString(IDS_IRC_CONNECT));
		sActions.Replace(_T("[RemoveServer]"), _GetPlainResString(IDS_REMOVETHIS));
		sActions.Replace(_T("[LinkRemove]"), bAdmin?CString(_T("/?ses=") + sSession + _T("&w=server&c=remove&ip=") + ServerArray[i].sServerIP + _T("&port=") + sServerPort):GetPermissionDenied());
		sActions.Replace(_T("[ConfirmRemove]"), _GetPlainResString(IDS_WEB_CONFIRM_REMOVE_SERVER));
		sActions.Replace(_T("[LinkPrioUp]"), bAdmin?CString(_T("/?ses=") + sSession + _T("&w=server&c=prioup&ip=") + ServerArray[i].sServerIP + _T("&port=") + sServerPort):GetPermissionDenied()); ////
		sActions.Replace(_T("[LinkPrioDown]"), bAdmin?CString(_T("/?ses=") + sSession + _T("&w=server&c=priodown&ip=") + ServerArray[i].sServerIP + _T("&port=") + sServerPort):GetPermissionDenied()); ////
		sActions.Replace(_T("[PrioUp]"), _GetPlainResString(IDS_PRIORITY_UP)); ////
		sActions.Replace(_T("[PrioDown]"), _GetPlainResString(IDS_PRIORITY_DOWN)); ////
		sActions.Replace(_T("[AddToStatic]"), _GetPlainResString(IDS_ADDTOSTATIC));
		sActions.Replace(_T("[RemoveFromStatic]"), _GetPlainResString(IDS_REMOVEFROMSTATIC));
		sActions.Replace(_T("[LinkAddToStatic]"), bAdmin?CString(_T("/?ses=") + sSession + _T("&w=server&c=addtostatic&ip=") + ServerArray[i].sServerIP + _T("&port=") + sServerPort):GetPermissionDenied());
		sActions.Replace(_T("[LinkRemoveFromStatic]"), bAdmin?CString(_T("/?ses=") + sSession + _T("&w=server&c=removefromstatic&ip=") + ServerArray[i].sServerIP + _T("&port=") + sServerPort):GetPermissionDenied());
a1075 1
		CString HTTPProcessData = OutE;	// Copy Entry Line to Temp
a1103 1
		HTTPProcessData.Replace(_T("[Actions]"), sActions);
d1123 10
d1150 2
a1151 1
	CString HTTPTemp = _ParseURL(Data.sURL, _T("c"));
d1189 12
d1234 1
a1234 1
			else if(bAdmin && sOp.CompareNoCase(_T("compressed")) == 0)
d1238 4
d1378 1
a1378 1
			dFile.bCompress = cur_file->GetDiscardSuperCompressed();
a1434 75
		CString JSfileinfo=FilesArray[i].sFileInfo;
		JSfileinfo.Replace(_T("\n"),_T("\\n"));
		JSfileinfo.Replace(_T("'"),_T("&#8217;")); // EC 22/5 - Chararacter ' causes a problem in javascript:alert()
		CString sActions = _T("<acronym title=\"") + FilesArray[i].sFileStatus + _T("\"><a href=\"javascript:alert(\'")+ JSfileinfo+_T("')\"><img src=\"l_info.gif\" alt=\"") + FilesArray[i].sFileStatus + _T("\"></a></acronym>&nbsp;");
		
		CString sED2kLink;
		sED2kLink.Format(_T("<acronym title=\"[Ed2klink]\"><a href=\"")+ FilesArray[i].sED2kLink +_T("\"><img src=\"l_ed2klink.gif\" alt=\"[Ed2klink]\"></a></acronym>&nbsp;"));
		sED2kLink.Replace(_T("[Ed2klink]"), _GetPlainResString(IDS_SW_LINK));
		sActions += sED2kLink;

		bool bCanBeDeleted = true;
		switch(FilesArray[i].nFileStatus)
		{
		case PS_COMPLETING:
		case PS_COMPLETE:
			bCanBeDeleted = false;
			break;
		case PS_HASHING: 
		case PS_WAITINGFORHASH:
		case PS_ERROR:
			break;
		case PS_PAUSED:
		{
			if (bAdmin) {
				CString sResume;
				sActions.Append(_T("<img src=\"l_a4af_no.gif\">&nbsp;"));
				sResume.Format(_T("<acronym title=\"[Resume]\"><a href=\"[Link]\"><img src=\"l_resume.gif\" alt=\"[Resume]\"></a></acronym>&nbsp;"));
				sResume.Replace(_T("[Link]"), CString(_T("/?ses=") + sSession + _T("&w=transfer&op=resume&file=") + FilesArray[i].sFileHash)) ;
				sActions += sResume;
			}
		}
			break; 
		default: // waiting or downloading
		{
			if (bAdmin) {
				//DonGato (added A4AF action)
				sActions.Append(_T("<acronym title=\"[A4AF]\"><a href=\"/?ses=[Session]&amp;w=transfer&op=a4af&file=") + FilesArray[i].sFileHash+_T("\"><img src=\"l_a4af.gif\" alt=\"[A4AF]\"></a></acronym>&nbsp;"));
				CString sPause;
				sPause.Format(_T("<acronym title=\"[Stop]\"><a href=\"[Link]\"><img src=\"l_stop.gif\" alt=\"[Stop]\"></a></acronym>&nbsp;"));
				sPause.Replace(_T("[Link]"), CString(_T("/?ses=") + sSession + _T("&w=transfer&op=stop&file=") + FilesArray[i].sFileHash));
				sActions += sPause;
				CString sCompress;
				if (FilesArray[i].bCompress) {
					sCompress.Format(_T("<acronym title=\"[Compress]\"><a href=\"[Link]\"><img src=\"l_dropscb.gif\" alt=\"[Compress]\"></a></acronym>&nbsp;"));
					sCompress.Replace(_T("[Compress]"), _GetPlainResString(IDS_KEEPSUPERCOMPRESSED));//change
				} else {
					sCompress.Format(_T("<acronym title=\"[Compress]\"><a href=\"[Link]\"><img src=\"l_keepscb.gif\" alt=\"[Compress]\"></a></acronym>&nbsp;"));
					sCompress.Replace(_T("[Compress]"), _GetPlainResString(IDS_DROPSUPERCOMPRESSED));//change
				}
				sCompress.Replace(_T("[Link]"), CString(_T("/?ses=") + sSession + _T("&w=transfer&op=compressed&file=") + FilesArray[i].sFileHash)) ;
				sActions += sCompress;
			}
		}
			break;
		}	//switch

		if (bAdmin) {
			if (bCanBeDeleted) {
				CString sCancel;
				sCancel.Format(_T("<acronym title=\"[Cancel]\"><a href=\"[Link]\" onclick=\"return confirm(\'[ConfirmCancel]%s\')\"><img src=\"l_cancel.gif\" alt=\"[Cancel]\"></a></acronym>&nbsp;"), FilesArray[i].sFileNameJS);	//SyruS add filename
				sCancel.Replace(_T("[Link]"), CString(_T("/?ses=") + sSession + _T("&w=transfer&op=cancel&file=") + FilesArray[i].sFileHash));
				sActions += sCancel;
				sActions.Append(_T("<acronym title=\"[PriorityUp]\"><a href=\"/?ses=[Session]&amp;w=transfer&op=prioup&file=") + FilesArray[i].sFileHash+_T("\"><img src=\"l_up.gif\" alt=\"[PriorityUp]\"></a></acronym>&nbsp;"));
				sActions.Append(_T("<acronym title=\"[PriorityDown]\"><a href=\"/?ses=[Session]&amp;w=transfer&op=priodown&file=") + FilesArray[i].sFileHash+_T("\"><img src=\"l_down.gif\" alt=\"[PriorityDown]\"></a></acronym>&nbsp;"));
			} else if (FilesArray[i].nFileStatus == PS_COMPLETE) {
				sActions.Append(_T("<acronym title=\"[ClearCompleted]\"><a href=\"/?ses=[Session]&amp;w=transfer&clearcompleted=") + FilesArray[i].sFileHash+_T("\"><img src=\"l_clear.gif\" alt=\"[ClearCompleted]\"></a></acronym>&nbsp;"));
			}
		}
		sActions.Replace(_T("[Resume]"), _GetPlainResString(IDS_DL_RESUME));
		sActions.Replace(_T("[Stop]"), _GetPlainResString(IDS_DL_STOP));
		sActions.Replace(_T("[A4AF]"), _GetPlainResString(IDS_ALL_A4AF_TO_HERE));
		sActions.Replace(_T("[Cancel]"), _GetPlainResString(IDS_MAIN_BTN_CANCEL));
		sActions.Replace(_T("[ConfirmCancel]"), _GetPlainResString(IDS_Q_CANCELDL2, true));
		sActions.Replace(_T("[ClearCompleted]"), _GetPlainResString(IDS_DL_CLEAR));

a1435 1
		// if downloading, draw in other color
d1441 114
d1580 2
a1609 1

a1610 1
		HTTPProcessData.Replace(_T("[6]"), sActions);
a1885 1
        CString sSession = _ParseURL(Data.sURL, _T("ses"));
d1888 14
d2188 9
a2196 1
		bool bAdmin = IsSessionAdmin(Data,sSession);
d2198 45
a2242 30
		CString sActions = _T("<acronym title=\"[Ed2klink]\"><a href=\"[FileLink]\"><img src=\"l_ed2klink.gif\" alt=\"[Ed2klink]\"></a></acronym>&nbsp;");
		if (bAdmin) {
			sActions.Append(_T("<acronym title=\"[PriorityUp]\"><a href=\"/?ses=[Session]&amp;w=shared&[PriorityUpLink]\"><img src=\"l_up.gif\" alt=\"[PriorityUp]\"></a></acronym>&nbsp;"));
			sActions.Append(_T("<acronym title=\"[PriorityDown]\"><a href=\"/?ses=[Session]&amp;w=shared&[PriorityDownLink]\"><img src=\"l_down.gif\" alt=\"[PriorityDown]\"></a></acronym>&nbsp;"));
		}
		sActions.Replace(_T("[FileLink]"), SharedArray[i].sED2kLink);
		sActions.Replace(_T("[Ed2klink]"), _GetPlainResString(IDS_SW_LINK));
		sActions.Replace(_T("[PriorityUp]"), _GetPlainResString(IDS_PRIORITY_UP));
		sActions.Replace(_T("[PriorityDown]"), _GetPlainResString(IDS_PRIORITY_DOWN));
		uint8 upperpriority=0, lesserpriority=0;
		if(SharedArray[i].nFilePriority == 4) {
			upperpriority = 0;	lesserpriority = 4;
		} else if(SharedArray[i].nFilePriority == 0) {
			upperpriority = 1;	lesserpriority = 4;
		} else if(SharedArray[i].nFilePriority == 1) {
			upperpriority = 2;	lesserpriority = 0;
		} else if(SharedArray[i].nFilePriority == 2) {
			upperpriority = 3;	lesserpriority = 1;
		} else if(SharedArray[i].nFilePriority == 3) {
			upperpriority = 5;	lesserpriority = 2;
		} else if(SharedArray[i].nFilePriority == 5) {
			upperpriority = 5;	lesserpriority = 3;
		}
		if(SharedArray[i].bFileAutoPriority) {
			upperpriority = 5;	lesserpriority = 3;
		}
		_stprintf(HTTPTempC, _T("%i"), upperpriority);
		sActions.Replace(_T("[PriorityUpLink]"), _T("hash=") + SharedArray[i].sFileHash + _T("&setpriority=") + CString(HTTPTempC));
        _stprintf(HTTPTempC, _T("%i"), lesserpriority);
		sActions.Replace(_T("[PriorityDownLink]"), _T("hash=") + SharedArray[i].sFileHash + _T("&setpriority=") + CString(HTTPTempC)); 
d2246 1
a2246 1
            HTTPProcessData.Replace(_T("[ShortFileName]"), _SpecialChars(SharedArray[i].sFileName.Left(SHORT_LENGTH)) + _T("..."));
a2269 1

a2272 1
		HTTPProcessData.Replace(_T("[Actions]"), sActions);
@


1.82
log
@minor string change
@
text
@d1948 1
a1948 1
			CString sPriority;
d1950 1
a1950 1
				sPriority = _GetPlainResString(IDS_PRIOVERYLOW);
d1952 1
a1952 1
				sPriority = _GetPlainResString(IDS_PRIOLOW);
d1954 1
a1954 1
				sPriority = _GetPlainResString(IDS_PRIONORMAL);
d1956 1
a1956 1
				sPriority = _GetPlainResString(IDS_PRIOHIGH);
d1958 1
a1958 1
				sPriority = _GetPlainResString(IDS_PRIORELEASE);
d1961 2
a1962 1
				buffer.Format(_T("%s[%s]"), _GetPlainResString(IDS_PRIOJUMPSTART),sPriority);
d1964 2
a1965 2
#endif			
			dFile.sFilePriority = buffer;
@


1.81
log
@minor change (string simplification)
@
text
@d1394 1
a1394 1
					sCompress.Replace(_T("[Compress]"), _GetPlainResString(IDS_DL_KEEPSCB));//change
@


1.80
log
@FEATURE: WebServer: client counter for each upload queue [Purity]
CHANGE: Webserver: guest icons cleanup in serverlist and shared files list [Purity]
@
text
@d1397 1
a1397 1
					sCompress.Replace(_T("[Compress]"), _GetPlainResString(IDS_DL_DROPSCB));//change
@


1.79
log
@WebServer features/change by Purity: server priorities (display+change), drop super-compressed blocks, guest icon cleanup
@
text
@a891 1
	Out.Replace(_T("[Connect]"), _GetPlainResString(IDS_IRC_CONNECT));
a897 8
	OutE.Replace(_T("[Connect]"), _GetPlainResString(IDS_IRC_CONNECT));
	OutE.Replace(_T("[RemoveServer]"), _GetPlainResString(IDS_REMOVETHIS));
	OutE.Replace(_T("[AddToStatic]"), _GetPlainResString(IDS_ADDTOSTATIC));
	OutE.Replace(_T("[RemoveFromStatic]"), _GetPlainResString(IDS_REMOVEFROMSTATIC));
	OutE.Replace(_T("[PrioUp]"), _GetPlainResString(IDS_PRIORITY_UP)); ////
	OutE.Replace(_T("[PrioDown]"), _GetPlainResString(IDS_PRIORITY_DOWN)); ////

	OutE.Replace(_T("[ConfirmRemove]"), _GetPlainResString(IDS_WEB_CONFIRM_REMOVE_SERVER));
d989 27
a1043 9
		CString sServerPort; sServerPort.Format(_T("%d"), ServerArray[i].nServerPort);
		HTTPProcessData.Replace(_T("[6]"), bAdmin? CString(_T("/?ses=") + sSession + _T("&w=server&c=connect&ip=") + ServerArray[i].sServerIP + _T("&port=") + sServerPort):GetPermissionDenied());
		HTTPProcessData.Replace(_T("[LinkPrioUp]"), bAdmin?CString(_T("/?ses=") + sSession + _T("&w=server&c=prioup&ip=") + ServerArray[i].sServerIP + _T("&port=") + sServerPort):GetPermissionDenied()); ////
		HTTPProcessData.Replace(_T("[LinkPrioDown]"), bAdmin?CString(_T("/?ses=") + sSession + _T("&w=server&c=priodown&ip=") + ServerArray[i].sServerIP + _T("&port=") + sServerPort):GetPermissionDenied()); ////
		HTTPProcessData.Replace(_T("[LinkRemove]"), bAdmin?CString(_T("/?ses=") + sSession + _T("&w=server&c=remove&ip=") + ServerArray[i].sServerIP + _T("&port=") + sServerPort):GetPermissionDenied());
		HTTPProcessData.Replace(_T("[LinkAddToStatic]"), bAdmin?CString(_T("/?ses=") + sSession + _T("&w=server&c=addtostatic&ip=") + ServerArray[i].sServerIP + _T("&port=") + sServerPort):GetPermissionDenied());
		HTTPProcessData.Replace(_T("[LinkRemoveFromStatic]"), bAdmin?CString(_T("/?ses=") + sSession + _T("&w=server&c=removefromstatic&ip=") + ServerArray[i].sServerIP + _T("&port=") + sServerPort):GetPermissionDenied());
		CString sServerStatic; sServerStatic.Format(_T("%d"), ServerArray[i].bServerStatic);
		HTTPProcessData.Replace(_T("[ServerStaticState]"), sServerStatic);
d1045 1
a1045 3
		CString sAdmin = _T("false"); if (bAdmin) sAdmin = _T("true"); 
		HTTPProcessData.Replace(_T("[Admin]"), sAdmin);

d1394 1
a1394 1
					sCompress.Replace(_T("[Compress]"), _GetPlainResString(IDS_DL_DROPSCB));
d1397 1
a1397 1
					sCompress.Replace(_T("[Compress]"), _GetPlainResString(IDS_DL_KEEPSCB));
d1568 17
d1665 1
a1665 1
			if (cur_client->IsFriend())
d1700 1
a1700 1
			if (cur_client->credits->GetScoreRatio() > 1)
d1724 15
a1738 1

a1905 4
	OutE.Replace(_T("[Ed2klink]"), _GetPlainResString(IDS_SW_LINK));
    OutE.Replace(_T("[PriorityUp]"), _GetPlainResString(IDS_PRIORITY_UP));
    OutE.Replace(_T("[PriorityDown]"), _GetPlainResString(IDS_PRIORITY_DOWN));

a1906 3
	OutE.Replace(_T("[Ed2klink]"), _GetPlainResString(IDS_SW_LINK));
    OutE.Replace(_T("[PriorityUp]"), _GetPlainResString(IDS_PRIORITY_UP));
    OutE.Replace(_T("[PriorityUp]"), _GetPlainResString(IDS_PRIORITY_DOWN));
d2051 33
a2091 1
		HTTPProcessData.Replace(_T("[FileLink]"), SharedArray[i].sED2kLink);
d2114 1
a2114 39

		uint8 upperpriority=0, lesserpriority=0;
		if(SharedArray[i].nFilePriority == 4)
		{
			upperpriority = 0;	lesserpriority = 4;
		}
		else
		if(SharedArray[i].nFilePriority == 0)
		{
			upperpriority = 1;	lesserpriority = 4;
		}
		else
		if(SharedArray[i].nFilePriority == 1)
		{
			upperpriority = 2;	lesserpriority = 0;
		}
		else
		if(SharedArray[i].nFilePriority == 2)
		{
			upperpriority = 3;	lesserpriority = 1;
		}
		else
		if(SharedArray[i].nFilePriority == 3)
		{
			upperpriority = 5;	lesserpriority = 2;
		}
		else
		if(SharedArray[i].nFilePriority == 5)
		{
			upperpriority = 5;	lesserpriority = 3;
		}
		if(SharedArray[i].bFileAutoPriority)
		{
			upperpriority = 5;	lesserpriority = 3;
		}
        _stprintf(HTTPTempC, _T("%i"), upperpriority);
		HTTPProcessData.Replace(_T("[PriorityUpLink]"), _T("hash=") + SharedArray[i].sFileHash + _T("&setpriority=") + CString(HTTPTempC));
        _stprintf(HTTPTempC, _T("%i"), lesserpriority);
		HTTPProcessData.Replace(_T("[PriorityDownLink]"), _T("hash=") + SharedArray[i].sFileHash + _T("&setpriority=") + CString(HTTPTempC)); 
@


1.78
log
@small fix in JS output
@
text
@d242 29
d817 11
a827 1
	}	
d895 1
d903 2
d925 7
d1025 1
d1028 2
d1036 2
d1146 4
d1286 1
d1384 10
@


1.77
log
@New A4AF mangement
@
text
@d1848 1
d1850 1
a1850 1
				buffer = _GetPlainResString(IDS_PRIOVERYLOW);
d1852 1
a1852 1
				buffer = _GetPlainResString(IDS_PRIOLOW);
d1854 1
a1854 1
				buffer = _GetPlainResString(IDS_PRIONORMAL);
d1856 1
a1856 1
				buffer = _GetPlainResString(IDS_PRIOHIGH);
d1858 1
a1858 1
				buffer = _GetPlainResString(IDS_PRIORELEASE);
d1861 1
a1861 1
				buffer.Format(_T("%s[%s]"), _GetPlainResString(IDS_PRIOJUMPSTART),buffer);
@


1.76
log
@unicode cleanup
@
text
@d1058 1
a1058 1
				theApp.emuledlg->transferwnd.downloadlistctrl.DownloadAllA4AF(found_file);
@


1.75
log
@minor correction with JS output in SharedList
@
text
@d1860 1
a1860 1
				buffer.Format("%s[%s]", _GetPlainResString(IDS_PRIOJUMPSTART),buffer);
@


1.74
log
@CHANGE: WebServer: separated upload queue into friends, banned clients, high credit clients and other client queues [Purity]
@
text
@d1814 2
a1847 5
#if JUMPSTART
			if (cur_file->GetJumpstartEnabled())
				dFile.sFilePriority = _GetPlainResString(IDS_PRIOJUMPSTART);
			else if (cur_file->GetPriority() == PR_VERYLOW)
#else
d1849 1
a1849 2
#endif
				dFile.sFilePriority = _GetPlainResString(IDS_PRIOVERYLOW);
d1851 1
a1851 1
				dFile.sFilePriority = _GetPlainResString(IDS_PRIOLOW);
d1853 1
a1853 1
				dFile.sFilePriority = _GetPlainResString(IDS_PRIONORMAL);
d1855 1
a1855 1
				dFile.sFilePriority = _GetPlainResString(IDS_PRIOHIGH);
d1857 7
a1863 1
				dFile.sFilePriority = _GetPlainResString(IDS_PRIORELEASE);
@


1.73
log
@jumpstart support in SharedList (output, sorting...)
@
text
@d24 3
d104 9
a112 3
			m_Templates.sTransferUpQueueLineBanned = _LoadTemplate(sAll,_T("TMPL_TRANSFER_UP_QUEUE_LINE_BANNED"));
			m_Templates.sTransferUpQueueLineFriend = _LoadTemplate(sAll,_T("TMPL_TRANSFER_UP_QUEUE_LINE_FRIEND"));
			m_Templates.sTransferUpQueueLineCredit = _LoadTemplate(sAll,_T("TMPL_TRANSFER_UP_QUEUE_LINE_CREDIT"));
d1126 18
a1495 6
		Out.Replace(_T("[UserNameTitle]"), _GetPlainResString(IDS_QL_USERNAME));
		Out.Replace(_T("[Version]"), _GetPlainResString(IDS_INFLST_USER_CLIENTVERSION));
		Out.Replace(_T("[FileNameTitle]"), _GetPlainResString(IDS_DL_FILENAME));
		Out.Replace(_T("[ScoreTitle]"), _GetPlainResString(IDS_SCORE));
		Out.Replace(_T("[BannedTitle]"), _GetPlainResString(IDS_BANNED));

a1496 4
		CString OutE2 = pThis->m_Templates.sTransferUpQueueLineBanned;
		CString OutE3 = pThis->m_Templates.sTransferUpQueueLineFriend;
		CString OutE4 = pThis->m_Templates.sTransferUpQueueLineCredit;
		// Replace [xx]
d1502 24
d1527 10
d1539 7
a1545 4
			else if (cur_client->IsFriend())
				HTTPProcessData = OutE3;
			else if (cur_client->credits->GetScoreRatio() > 1)
				HTTPProcessData = OutE4;
d1547 14
a1560 1
				HTTPProcessData = OutE;
d1562 14
a1575 2
			if(cur_client->GetUserName().GetLength() > SHORT_LENGTH2)
	            HTTPProcessData.Replace(_T("[1]"), _T("<acronym title=\"") + _SpecialChars(cur_client->GetUserName()) + _T("\">") + _SpecialChars(cur_client->GetUserName().Left(SHORT_LENGTH2)) + _T("...") + _T("</acronym>"));
a1577 1

d1584 1
a1584 7
			CString HTTPTemp = HTTPTempC;
			HTTPProcessData.Replace(_T("[Score]"), HTTPTemp);
			if (cur_client->IsBanned())
				HTTPProcessData.Replace(_T("[Banned]"), _GetPlainResString(IDS_YES));
			else
				HTTPProcessData.Replace(_T("[Banned]"), _GetPlainResString(IDS_NO));

d1588 8
d1597 19
a1615 6
			if (cur_client->IsBanned())
				HTTPProcessData.Replace(_T("[ClientExtra]"), _T("banned"));
			else if (cur_client->IsFriend())
				HTTPProcessData.Replace(_T("[ClientExtra]"), _T("friend"));
			else if (cur_client->credits->GetScoreRatio() > 1)
				HTTPProcessData.Replace(_T("[ClientExtra]"), _T("credit"));
d1617 8
a1624 3
				HTTPProcessData.Replace(_T("[ClientExtra]"), _T("none"));

			sQueue += HTTPProcessData;
d1626 1
a1626 1
		Out.Replace(_T("[QueueList]"), sQueue);
d1629 1
a1629 1
		Out.Replace(_T("[UploadQueue]"), pThis->m_Templates.sTransferUpQueueHide);
d1631 11
a1641 2
	Out.Replace(_T("[ShowQueue]"), _GetPlainResString(IDS_WEB_SHOW_UPLOAD_QUEUE));
	Out.Replace(_T("[HideQueue]"), _GetPlainResString(IDS_WEB_HIDE_UPLOAD_QUEUE));
d2320 5
a2324 1
		if(_ParseURL(Data.sURL, _T("showuploadqueue")) == "false" || _ParseURL(Data.sURL, _T("showuploadqueue")) == "")
d2326 5
a2330 1
		    pThis->m_Params.bShowUploadQueue = false;
d2393 24
d2456 3
d2460 3
d2465 6
@


1.72
log
@added couninitialize and additional filetypes from 0.29b
@
text
@d1739 5
d1745 1
@


1.71
log
@unicode cleanup
@
text
@d155 1
a155 1
	if(nStart != -1 && nEnd != -1)
d312 5
a316 1
		else if (filename.Right(4).MakeLower()==".png") contenttype="Content-Type: image/png";
d325 1
a325 1
	if(file.Open(filename, CFile::modeRead|CFile::typeBinary))
d346 7
d355 1
d544 3
@


1.70
log
@RC2
@
text
@d376 1
a376 1
		t_ulCurIP.Format("%i.%i.%i.%i",(uint8)pThis->m_ulCurIP,(uint8)(pThis->m_ulCurIP>>8),(uint8)(pThis->m_ulCurIP>>16),(uint8)(pThis->m_ulCurIP>>24));//log intruder
d2529 1
a2529 1
			t_ulCurIP.Format("%i.%i.%i.%i",(uint8)pThis->m_ulCurIP,(uint8)(pThis->m_ulCurIP>>8),(uint8)(pThis->m_ulCurIP>>16),(uint8)(pThis->m_ulCurIP>>24));
@


1.69
log
@Reduced UserName on queues to 40 chars max.
@
text
@d1404 2
a1405 2
		if(cur_client->GetUserName().GetLength() > SHORT_LENGTH)
            HTTPProcessData.Replace(_T("[1]"), _SpecialChars(cur_client->GetUserName().Left(SHORT_LENGTH)) + _T("..."));
d1480 2
a1481 2
			if(cur_client->GetUserName().GetLength() > SHORT_LENGTH)
				HTTPProcessData.Replace(_T("[UserName]"), _SpecialChars(cur_client->GetUserName().Left(SHORT_LENGTH)) + _T("..."));
@


1.68
log
@Added A4AF no icon on Web Server and change Upload tooltips to have KB/MB as needed.
@
text
@d927 2
a928 2
		if(ServerArray[i].sServerName.GetLength() > SHORT_FILENAME_LENGTH)
			HTTPProcessData.Replace(_T("[1]"), _T("<acronym title=\"") + ServerArray[i].sServerName + _T("\">") + ServerArray[i].sServerName.Left(SHORT_FILENAME_LENGTH) + _T("...") + _T("</acronym>"));
d931 2
a932 2
		if(ServerArray[i].sServerDescription.GetLength() > SHORT_FILENAME_LENGTH)
			HTTPProcessData.Replace(_T("[2]"), _T("<acronym title=\"") + ServerArray[i].sServerDescription + _T("\">") + ServerArray[i].sServerDescription.Left(SHORT_FILENAME_LENGTH) + _T("...") + _T("</acronym>"));
d1314 2
a1315 2
		if(FilesArray[i].sFileName.GetLength() > SHORT_FILENAME_LENGTH)
		HTTPProcessData.Replace(_T("[ShortFileName]"), FilesArray[i].sFileName.Left(SHORT_FILENAME_LENGTH) + _T("..."));
d1404 4
a1407 1
		HTTPProcessData.Replace(_T("[1]"), _SpecialChars(cur_client->GetUserName()));
d1480 5
a1484 1
			HTTPProcessData.Replace(_T("[UserName]"), _SpecialChars(cur_client->GetUserName()));
d1821 2
a1822 2
		if(SharedArray[i].sFileName.GetLength() > SHORT_FILENAME_LENGTH)
            HTTPProcessData.Replace(_T("[ShortFileName]"), _SpecialChars(SharedArray[i].sFileName.Left(SHORT_FILENAME_LENGTH)) + _T("..."));
@


1.67
log
@more Puritys changes to WebServer (IP logging, split uploadqueue)
@
text
@d1267 1
@


1.66
log
@removed wrong filter for a4af-action.
@
text
@d101 3
d375 2
d385 1
a385 1
			AddLogLine(true,IDS_WEB_ADMINLOGIN,ses.lSession);
d395 1
a395 1
			AddLogLine(true,IDS_WEB_GUESTLOGIN,ses.lSession);
d400 1
a400 2
				AddLogLine(true,IDS_WEB_INTRTRIESLEFT, 
				theApp.glob_prefs->GetWSLoginAttemptsAllowed()-(pThis->m_nIntruderDetect));
d1456 4
a1459 1
		OutE = pThis->m_Templates.sTransferUpQueueLine;
d1466 10
a1475 1
			HTTPProcessData = OutE;
d2520 3
a2522 1
			theApp.emuledlg->AddLogLine(true,IDS_WEB_SESSIONEND,lSession);
@


1.65
log
@minor Intruder Detection fix (didn't show lock time)
@
text
@d1272 2
a1273 2
				if (FilesArray[i].lNotCurrentSourceCount > 0)	//DonGato (added A4AF action)
					sActions.Append(_T("<acronym title=\"[A4AF]\"><a href=\"/?ses=[Session]&amp;w=transfer&op=a4af&file=") + FilesArray[i].sFileHash+_T("\"><img src=\"l_a4af.gif\" alt=\"[A4AF]\"></a></acronym>&nbsp;"));
@


1.64
log
@CHANGE: WebServer: show filename in cancel-confirmation
CHANGE: WebServer: download a4af only possible on non-paused files with sources
BUGFIX: WebServer: code optimization and stabilisation of transferlist
@
text
@d365 1
a365 1
		theApp.emuledlg->AddLogLine(true,GetResString(IDS_WEB_INTRBLOCKEND));
d395 1
a395 1
				theApp.emuledlg->AddLogLine(true,GetResString(IDS_WEB_INTRTRIESLEFT), 
d398 1
a398 1
					theApp.emuledlg->AddLogLine(true,GetResString(IDS_WEB_INTRDETECTION), pThis->m_nIntruderDetect);
d403 1
a403 1
					pThis->AddLogLine(true,GetResString(IDS_WEB_INTRBLOCKTIME), (theApp.glob_prefs->GetWSTempDisableLogin() / 60000));
d409 1
a409 1
					theApp.emuledlg->AddLogLine(true,GetResString(IDS_WEB_INTRWEBDISABLE));
@


1.63
log
@Webserver intruder detection by Purity
@
text
@d266 1
a266 1
CString CWebServer::_SpecialChars(CString str) 
d274 5
d729 1
a729 1

d733 3
a735 1
	if (sCmd == "connect" && IsSessionAdmin(Data,sSession) )
a736 2
		CString sIP = _ParseURL(Data.sURL, _T("ip"));
		int nPort = _tstoi(_ParseURL(Data.sURL, _T("port")));
d742 1
a742 1
	else if (sCmd == "disconnect" && IsSessionAdmin(Data,sSession)) 
d746 1
a746 1
	else if (sCmd == "remove" && IsSessionAdmin(Data,sSession)) 
a747 2
		CString sIP = _ParseURL(Data.sURL, _T("ip"));
		int nPort = _tstoi(_ParseURL(Data.sURL, _T("port")));
d751 1
a751 2

	else if (sCmd == "addtostatic" && IsSessionAdmin(Data,sSession)) 
a752 2
		CString sIP = _ParseURL(Data.sURL, _T("ip"));
		int nPort = _tstoi(_ParseURL(Data.sURL, _T("port")));
d756 1
a756 2

	else if (sCmd == "removefromstatic" && IsSessionAdmin(Data,sSession)) 
a757 2
		CString sIP = _ParseURL(Data.sURL, _T("ip"));
		int nPort = _tstoi(_ParseURL(Data.sURL, _T("port")));
d761 1
a761 1
	else if (sCmd == "options") 
d765 1
a782 3

		if(_ParseURL(Data.sURL, _T("sortreverse")) == "")
			pThis->m_Params.bServerSortReverse = false;
d784 5
a788 3
	if (_ParseURL(Data.sURL, _T("sortreverse")) != "") 
	{
		pThis->m_Params.bServerSortReverse = (_ParseURL(Data.sURL, _T("sortreverse")) == "true");
d790 1
d949 4
a952 4
		HTTPProcessData.Replace(_T("[6]"), IsSessionAdmin(Data,sSession)? CString(_T("/?ses=") + sSession + _T("&w=server&c=connect&ip=") + ServerArray[i].sServerIP + _T("&port=") + sServerPort):GetPermissionDenied());
		HTTPProcessData.Replace(_T("[LinkRemove]"), IsSessionAdmin(Data,sSession)?CString(_T("/?ses=") + sSession + _T("&w=server&c=remove&ip=") + ServerArray[i].sServerIP + _T("&port=") + sServerPort):GetPermissionDenied());
		HTTPProcessData.Replace(_T("[LinkAddToStatic]"), IsSessionAdmin(Data,sSession)?CString(_T("/?ses=") + sSession + _T("&w=server&c=addtostatic&ip=") + ServerArray[i].sServerIP + _T("&port=") + sServerPort):GetPermissionDenied());
		HTTPProcessData.Replace(_T("[LinkRemoveFromStatic]"), IsSessionAdmin(Data,sSession)?CString(_T("/?ses=") + sSession + _T("&w=server&c=removefromstatic&ip=") + ServerArray[i].sServerIP + _T("&port=") + sServerPort):GetPermissionDenied());
d977 1
a977 1

d981 2
a982 2
	CString ClearArg(_ParseURL(Data.sURL, _T("clearcompleted")));
	if (IsSessionAdmin(Data,sSession) && !ClearArg.IsEmpty()) 
d984 1
a984 1
		if (ClearArg.CompareNoCase(_T("all")) == 0) {
d988 2
a989 2
			_GetFileHash(ClearArg, FileHash);
			theApp.emuledlg->transferwnd.downloadlistctrl.ClearCompleted(FileHash);
d992 3
a994 2
	
	if (_ParseURL(Data.sURL, _T("c")) != "" && IsSessionAdmin(Data,sSession)) 
a995 1
		CString HTTPTemp = _ParseURL(Data.sURL, _T("c"));
a996 1

d1018 6
a1023 3
	}
	if (_ParseURL(Data.sURL, _T("op")) != "" &&
		_ParseURL(Data.sURL, _T("file")) != "")
d1025 1
a1025 3
		uchar FileHash[16];
		_GetFileHash(_ParseURL(Data.sURL, _T("file")), FileHash);

d1027 7
a1033 8
		
		if(_ParseURL(Data.sURL, _T("op")) == "a4af" && IsSessionAdmin(Data,sSession)) { // DonGato (added A4ADF action)
			if(found_file)
				theApp.emuledlg->transferwnd.downloadlistctrl.DownloadAllA4AF(found_file);;
		}
		else if(_ParseURL(Data.sURL, _T("op")) == "stop" && IsSessionAdmin(Data,sSession))
		{
			if(found_file)
d1035 3
a1037 4
		}
		else if(_ParseURL(Data.sURL, _T("op")) == "resume" && IsSessionAdmin(Data,sSession))
		{
			if(found_file)
d1039 3
a1041 4
		}
		else if(_ParseURL(Data.sURL, _T("op")) == "cancel" && IsSessionAdmin(Data,sSession))
		{
			if(found_file)
a1042 11
		}
		else if(_ParseURL(Data.sURL, _T("op")) == "prioup" && IsSessionAdmin(Data,sSession))
		{
			if(found_file) {
			  if (!found_file->IsAutoPrioritized())
				switch (found_file->GetPriority()) {
					case PR_LOW: found_file->SetAutoPriority(false); found_file->SetPriority(PR_NORMAL);break;
					case PR_NORMAL: found_file->SetAutoPriority(false); found_file->SetPriority(PR_HIGH);break;
					case PR_HIGH: found_file->SetAutoPriority(true); found_file->SetPriority(PR_HIGH);break;
				}
			  else {found_file->SetAutoPriority(false); found_file->SetPriority(PR_LOW);}
d1044 19
a1062 11
		}
		else if(_ParseURL(Data.sURL, _T("op")) == "priodown" && IsSessionAdmin(Data,sSession))
		{
			if(found_file) {
			  if (!found_file->IsAutoPrioritized())
				switch (found_file->GetPriority()) {
					case PR_LOW: found_file->SetAutoPriority(true); found_file->SetPriority(PR_HIGH);break;
					case PR_NORMAL: found_file->SetAutoPriority(false); found_file->SetPriority(PR_LOW);break;
					case PR_HIGH: found_file->SetAutoPriority(false); found_file->SetPriority(PR_NORMAL);break;
				}
			  else {found_file->SetAutoPriority(false); found_file->SetPriority(PR_HIGH);}
d1064 1
a1064 1
		}
d1066 3
a1068 1
	if (_ParseURL(Data.sURL, _T("sort")) != "") 
d1070 1
a1070 1
		if(_ParseURL(Data.sURL, _T("sort")) == "name")
d1073 1
a1073 1
		if(_ParseURL(Data.sURL, _T("sort")) == "size")
d1076 1
a1076 1
		if(_ParseURL(Data.sURL, _T("sort")) == "transferred")
d1079 1
a1079 1
		if(_ParseURL(Data.sURL, _T("sort")) == "speed")
d1082 2
a1083 5
		if(_ParseURL(Data.sURL, _T("sort")) == "progress")
			pThis->m_Params.DownloadSort = DOWN_SORT_PROGRESS;

		if(_ParseURL(Data.sURL, _T("sortreverse")) == "")
			pThis->m_Params.bDownloadSortReverse = false;
d1085 5
a1089 3
	if (_ParseURL(Data.sURL, _T("sortreverse")) != "") 
	{
		pThis->m_Params.bDownloadSortReverse = (_ParseURL(Data.sURL, _T("sortreverse")) == "true");
d1091 3
a1093 2
	if(_ParseURL(Data.sURL, _T("showuploadqueue")) == "true")
	{
d1095 1
a1095 3
	}
	if(_ParseURL(Data.sURL, _T("showuploadqueue")) == "false")
	{
d1097 1
a1097 1
	}
d1154 10
a1163 5
	theApp.emuledlg->transferwnd.downloadlistctrl.GetDisplayedFiles(&partlist);
	// Populating array
	//for (POSITION pos=theApp.downloadqueue->filelist.GetHeadPosition();pos != 0;theApp.downloadqueue->filelist.GetNext(pos))
	//{
	//	CPartFile* cur_file =  theApp.downloadqueue->filelist.GetAt(pos);
d1169 1
a1235 2
	CString HTTPTemp;

d1241 1
a1241 1
		CString sActions = _T("<acronym title=\"") + FilesArray[i].sFileStatus + _T("\"><a href=\"javascript:alert(\'")+ JSfileinfo+_T("')\"><img src=\"l_info.gif\" alt=\"") + FilesArray[i].sFileStatus + _T("\"></a></acronym> ");
d1244 1
a1244 1
		sED2kLink.Format(_T("<acronym title=\"[Ed2klink]\"><a href=\"")+ FilesArray[i].sED2kLink +_T("\"><img src=\"l_ed2klink.gif\" alt=\"[Ed2klink]\"></a></acronym> "));
d1261 3
a1263 3
			if (IsSessionAdmin(Data,sSession)) {
				CString sResume=_T("");
				sResume.Format(_T("<acronym title=\"[Resume]\"><a href=\"[Link]\"><img src=\"l_resume.gif\" alt=\"[Resume]\"></a></acronym> "));
d1271 3
a1273 1
			if (IsSessionAdmin(Data,sSession)) {
d1275 1
a1275 1
				sPause.Format(_T("<acronym title=\"[Stop]\"><a href=\"[Link]\"><img src=\"l_stop.gif\" alt=\"[Stop]\"></a></acronym> "));
d1281 4
a1284 4
		}
		if(bCanBeDeleted)
		{
			if (IsSessionAdmin(Data,sSession)) {
d1286 1
a1286 1
				sCancel.Format(_T("<acronym title=\"[Cancel]\"><a href=\"[Link]\" onclick=\"return confirm(\'[ConfirmCancel]\')\"><img src=\"l_cancel.gif\" alt=\"[Cancel]\"></a></acronym> "));
d1289 4
d1295 6
a1300 19

		if (IsSessionAdmin(Data,sSession)) {
			if (FilesArray[i].nFileStatus != PS_COMPLETE) {
	 			// DonGato (added A4ADF action)
				sActions.Append(_T("<acronym title=\"[A4AF]\"><a href=\"/?ses=[Session]&amp;w=transfer&op=a4af&file=") + FilesArray[i].sFileHash+_T("\"><img src=\"l_a4af.gif\" alt=\"[A4AF]\"></a></acronym>"));
				sActions.Replace(_T("[A4AF]"), _GetPlainResString(IDS_ALL_A4AF_TO_HERE));
			}
			sActions.Replace(_T("[Resume]"), _GetPlainResString(IDS_DL_RESUME));
			sActions.Replace(_T("[Stop]"), _GetPlainResString(IDS_DL_STOP));
			sActions.Replace(_T("[Cancel]"), _GetPlainResString(IDS_MAIN_BTN_CANCEL));
			sActions.Replace(_T("[ConfirmCancel]"), _GetPlainResString(IDS_Q_CANCELDL2, true));
			if (bCanBeDeleted) {	//SyruS show completed files (0.28b) no prioritychange possible when complete
				sActions.Append(_T("<acronym title=\"[PriorityUp]\"><a href=\"/?ses=[Session]&amp;w=transfer&op=prioup&file=") + FilesArray[i].sFileHash+_T("\"><img src=\"l_up.gif\" alt=\"[PriorityUp]\"></a></acronym>"));
				sActions.Append(_T("&nbsp;<acronym title=\"[PriorityDown]\"><a href=\"/?ses=[Session]&amp;w=transfer&op=priodown&file=") + FilesArray[i].sFileHash+_T("\"><img src=\"l_down.gif\" alt=\"[PriorityDown]\"></a></acronym>"));
			} else if (FilesArray[i].nFileStatus == PS_COMPLETE) {	//SyruS  we now can clear single completed files from downloadlist
				sActions.Append(_T("<acronym title=\"[ClearCompleted]\"><a href=\"/?ses=[Session]&amp;w=transfer&clearcompleted=") + FilesArray[i].sFileHash+_T("\"><img src=\"l_clear.gif\" alt=\"[ClearCompleted]\"></a></acronym>"));
				sActions.Replace(_T("[ClearCompleted]"), _GetPlainResString(IDS_DL_CLEAR));
			}
		}
a1326 1

a1336 1

d1342 1
a1348 1
	
d1355 6
a1360 8
			case 0: HTTPTemp=GetResString(IDS_PRIOLOW);break;
			case 10: HTTPTemp=GetResString(IDS_PRIOAUTOLOW);break;

			case 1: HTTPTemp=GetResString(IDS_PRIONORMAL);break;
			case 11: HTTPTemp=GetResString(IDS_PRIOAUTONORMAL);break;

			case 2: HTTPTemp=GetResString(IDS_PRIOHIGH);break;
			case 12: HTTPTemp=GetResString(IDS_PRIOAUTOHIGH);break;
a1407 1

a1426 1
		CString HTTPTemp;
a1475 1
	
d2557 2
d2566 7
a2572 2
		sscanf(hex_byte, "%02x", &byte);
		FileHash[i] = (uchar)byte;
d2578 1
d2582 1
a2582 1
CString	CWebServer::_GetPlainResString(UINT nID, bool noquot)
d2588 1
a2588 1
	if(noquot)
@


1.62
log
@Forget to comment additions :P
@
text
@d37 4
d187 3
d348 1
d354 11
a364 1
	if (_ParseURL(Data.sURL, _T("w")) == "password")
d376 1
d386 23
a408 1
		} else {
d925 2
a926 2
		if(ServerArray[i].sServerName.GetLength() > SHORT_NAME_LENGTH)
			HTTPProcessData.Replace(_T("[1]"), _T("<acronym title=\"") + ServerArray[i].sServerName + _T("\">") + ServerArray[i].sServerName.Left(SHORT_NAME_LENGTH) + _T("...") + _T("</acronym>"));
d929 2
a930 2
		if(ServerArray[i].sServerDescription.GetLength() > SHORT_NAME_LENGTH)
			HTTPProcessData.Replace(_T("[2]"), _T("<acronym title=\"") + ServerArray[i].sServerDescription + _T("\">") + ServerArray[i].sServerDescription.Left(SHORT_NAME_LENGTH) + _T("...") + _T("</acronym>"));
d1320 2
a1321 2
		if(FilesArray[i].sFileName.GetLength() > SHORT_NAME_LENGTH)
		HTTPProcessData.Replace(_T("[ShortFileName]"), FilesArray[i].sFileName.Left(SHORT_NAME_LENGTH) + _T("..."));
d1815 2
a1816 2
		if(SharedArray[i].sFileName.GetLength() > SHORT_NAME_LENGTH)
            HTTPProcessData.Replace(_T("[ShortFileName]"), _SpecialChars(SharedArray[i].sFileName.Left(SHORT_NAME_LENGTH)) + _T("..."));
@


1.61
log
@WebServer: reduced large servernames or descriptions
@
text
@d883 1
a883 2
		//HTTPProcessData.Replace(_T("[1]"), ServerArray[i].sServerName);

a887 1
		//HTTPProcessData.Replace(_T("[2]"), ServerArray[i].sServerDescription);
d892 1
d989 1
a989 2
		if(_ParseURL(Data.sURL, _T("op")) == "a4af" && IsSessionAdmin(Data,sSession))
		{
d1255 1
@


1.60
log
@WebServer: Added force ask A4AF to actions. :-)
@
text
@d877 1
d883 11
a893 2
		HTTPProcessData.Replace(_T("[1]"), ServerArray[i].sServerName);
		HTTPProcessData.Replace(_T("[2]"), ServerArray[i].sServerDescription);
d1280 2
a1281 2
		if(FilesArray[i].sFileName.GetLength() > SHORT_FILENAME_LENGTH)
		HTTPProcessData.Replace(_T("[ShortFileName]"), FilesArray[i].sFileName.Left(SHORT_FILENAME_LENGTH) + _T("..."));
d1775 2
a1776 2
		if(SharedArray[i].sFileName.GetLength() > SHORT_FILENAME_LENGTH)
            HTTPProcessData.Replace(_T("[ShortFileName]"), _SpecialChars(SharedArray[i].sFileName.Left(SHORT_FILENAME_LENGTH)) + _T("..."));
@


1.59
log
@unicode cleanup
@
text
@d980 6
a985 1
		if(_ParseURL(Data.sURL, _T("op")) == "stop" && IsSessionAdmin(Data,sSession))
d1246 4
@


1.58
log
@Updated WebServer (bugfixing)
@
text
@d1368 1
a1368 1
			HTTPProcessData.Replace(_T("[ClientExtra]"), "banned");
d1370 1
a1370 1
			HTTPProcessData.Replace(_T("[ClientExtra]"), "friend");
d1372 1
a1372 1
			HTTPProcessData.Replace(_T("[ClientExtra]"), "credit");
d1374 1
a1374 1
			HTTPProcessData.Replace(_T("[ClientExtra]"), "none");
d1438 1
a1438 1
				HTTPProcessData.Replace(_T("[ClientExtra]"), "banned");
d1440 1
a1440 1
				HTTPProcessData.Replace(_T("[ClientExtra]"), "friend");
d1442 1
a1442 1
				HTTPProcessData.Replace(_T("[ClientExtra]"), "credit");
d1444 1
a1444 1
				HTTPProcessData.Replace(_T("[ClientExtra]"), "none");
@


1.57
log
@Purity's webserver enhancements
@
text
@d1356 5
a1360 1
		HTTPProcessData.Replace(_T("[FileInfo]"), _SpecialChars(cur_client->GetUploadFileInfo()));
d1630 2
a1631 1
		dFile.sFileName = _SpecialChars(cur_file->GetFileName());
a2745 1

@


1.56
log
@unicode cleanup
@
text
@d93 1
d202 1
a202 1
//purity
d212 1
a212 1
//purity
d707 1
a707 1
	//purity
d715 1
a715 1
	//purity
a793 1
	//purity
d801 1
a801 1

d814 22
a835 1
		Entry.bServerStatic = cur_file->IsStaticMember();	//purity	
a837 1

a902 1
		//purity
d907 1
d1096 1
d1335 1
d1348 7
a1354 1
		CString HTTPProcessData = OutE;
d1358 14
d1401 1
d1427 15
@


1.55
log
@clear only real completed (no icon on completing)
@
text
@d2056 1
a2056 1
		if(_ParseURL(Data.sURL, _T("gzip")) == "false" || _ParseURL(Data.sURL, "gzip") == "")
d2099 1
a2099 1
		if(_ParseURL(Data.sURL, "maxconnections") != "")
d2101 1
a2101 1
			theApp.glob_prefs->SetMaxConnections(_tstoi(_ParseURL(Data.sURL, "maxconnections")));
d2103 1
a2103 1
		if(_ParseURL(Data.sURL, "maxconnectionsperfive") != "")
d2105 1
a2105 1
			theApp.glob_prefs->SetMaxDownloadConperFive(_tstoi(_ParseURL(Data.sURL, "maxconnectionsperfive")));
d2115 1
a2115 1
		Out.Replace("[UseGzipVal]", "checked");
d2119 1
a2119 1
		Out.Replace("[UseGzipVal]", "");
d2123 1
a2123 1
		Out.Replace("[ShowUploadQueueVal]", "checked");
d2127 1
a2127 1
		Out.Replace("[ShowUploadQueueVal]", "");
d2131 1
a2131 1
		Out.Replace("[FirstAndLastVal]", "checked");
d2135 1
a2135 1
		Out.Replace("[FirstAndLastVal]", "");
d2139 1
a2139 1
		Out.Replace("[FullChunksVal]", "checked");
d2143 1
a2143 1
		Out.Replace("[FullChunksVal]", "");
d2147 2
a2148 2
	sRefresh.Format("%d", theApp.glob_prefs->GetWebPageRefresh());
	Out.Replace("[RefreshVal]", sRefresh);
d2150 2
a2151 2
	sRefresh.Format("%d", theApp.glob_prefs->GetMaxSourcePerFile());
	Out.Replace("[MaxSourcesVal]", sRefresh);
d2153 2
a2154 2
	sRefresh.Format("%d", theApp.glob_prefs->GetMaxConnections());
	Out.Replace("[MaxConnectionsVal]", sRefresh);
d2156 28
a2183 28
	sRefresh.Format("%d", theApp.glob_prefs->GetMaxConperFive());
	Out.Replace("[MaxConnectionsPer5Val]", sRefresh);

	Out.Replace("[KBS]", _GetPlainResString(IDS_KBYTESEC)+":");
	Out.Replace("[FileSettings]", CString(_GetPlainResString(IDS_WEB_FILESETTINGS)+":"));
	Out.Replace("[LimitForm]", _GetPlainResString(IDS_WEB_CONLIMITS)+":");
	Out.Replace("[MaxSources]", _GetPlainResString(IDS_PW_MAXSOURCES)+":");
	Out.Replace("[MaxConnections]", _GetPlainResString(IDS_PW_MAXC)+":");
	Out.Replace("[MaxConnectionsPer5]", _GetPlainResString(IDS_MAXCON5_TEXT)+":");
	Out.Replace("[UseGzipForm]", _GetPlainResString(IDS_WEB_GZIP_COMPRESSION));
	Out.Replace("[UseGzipComment]", _GetPlainResString(IDS_WEB_GZIP_COMMENT));
	Out.Replace("[ShowUploadQueueForm]", _GetPlainResString(IDS_WEB_SHOW_UPLOAD_QUEUE));
	Out.Replace("[ShowUploadQueueComment]", _GetPlainResString(IDS_WEB_UPLOAD_QUEUE_COMMENT));
	Out.Replace("[ShowQueue]", _GetPlainResString(IDS_SHOW));
	Out.Replace("[HideQueue]", _GetPlainResString(IDS_HIDE));
	Out.Replace("[RefreshTimeForm]", _GetPlainResString(IDS_WEB_REFRESH_TIME));
	Out.Replace("[RefreshTimeComment]", _GetPlainResString(IDS_WEB_REFRESH_COMMENT));
	Out.Replace("[SpeedForm]", _GetPlainResString(IDS_SPEED_LIMITS));
	Out.Replace("[MaxDown]", _GetPlainResString(IDS_ST_ACTIVEDOWNLOAD));
	Out.Replace("[MaxUp]", _GetPlainResString(IDS_ST_ACTIVEUPLOAD));
	Out.Replace("[SpeedCapForm]", _GetPlainResString(IDS_CAPACITY_LIMITS));
	Out.Replace("[MaxCapDown]", _GetPlainResString(IDS_ST_ACTIVEDOWNLOAD));
	Out.Replace("[MaxCapUp]", _GetPlainResString(IDS_ST_ACTIVEUPLOAD));
	Out.Replace("[TryFullChunks]", _GetPlainResString(IDS_TRF_FULL_CHUNKS));
	Out.Replace("[FirstAndLast]", _GetPlainResString(IDS_MOVIE));
	Out.Replace("[WebControl]", _GetPlainResString(IDS_WEB_CONTROL));
	Out.Replace("[eMuleAppName]", _GetPlainResString(IDS_EMULE_PLUS));
	Out.Replace("[Apply]", _GetPlainResString(IDS_PW_APPLY));
d2188 2
a2189 2
	sT.Format("%d", n);
	Out.Replace("[MaxDownVal]", sT);
d2192 6
a2197 6
	sT.Format("%d", n);
	Out.Replace("[MaxUpVal]", sT);
	sT.Format("%d", theApp.glob_prefs->GetMaxGraphDownloadRate());
	Out.Replace("[MaxCapDownVal]", sT);
	sT.Format("%d", theApp.glob_prefs->GetMaxGraphUploadRate());
	Out.Replace("[MaxCapUpVal]", sT);
d2203 1
a2203 1
	return "";
d2212 1
a2212 1
		return "";
d2214 1
a2214 1
	CString sSession = _ParseURL(Data.sURL, "ses");
d2216 1
a2216 1
	CString Out = "";
d2220 7
a2226 7
	Out.Replace("[CharSet]", _GetWebCharSet());
	Out.Replace("[eMuleAppName]", _GetPlainResString(IDS_EMULE_PLUS));
	Out.Replace("[version]", CURRENT_VERSION_LONG);
	Out.Replace("[Login]", _GetPlainResString(IDS_WEB_LOGIN));
	Out.Replace("[EnterPassword]", _GetPlainResString(IDS_WEB_ENTER_PASSWORD));
	Out.Replace("[LoginNow]", _GetPlainResString(IDS_WEB_LOGIN_NOW));
	Out.Replace("[WebControl]", _GetPlainResString(IDS_WEB_CONTROL));
d2232 1
a2232 1
	return "";
d2241 1
a2241 1
		return "";
d2243 1
a2243 1
	CString sSession = _ParseURL(Data.sURL, "ses");
d2245 2
a2246 2
	CString HTTPTemp = "";
	char	HTTPTempC[100] = "";
d2248 12
a2259 12
	OutS.Replace("[ConnectedServer]", _GetPlainResString(IDS_PW_SERVER));
	OutS.Replace("[Servername]", _GetPlainResString(IDS_SL_SERVERNAME));
	OutS.Replace("[Status]", _GetPlainResString(IDS_STATUS));
	OutS.Replace("[Usercount]", _GetPlainResString(IDS_LUSERS));
	OutS.Replace("[Action]", _GetPlainResString(IDS_CONNECTING));
	OutS.Replace("[URL_Disconnect]", IsSessionAdmin(Data,sSession)?CString("/?ses=" + sSession + "&w=server&c=disconnect"):GetPermissionDenied());
	OutS.Replace("[URL_Connect]", IsSessionAdmin(Data,sSession)?CString("/?ses=" + sSession + "&w=server&c=connect"):GetPermissionDenied());
	OutS.Replace("[Disconnect]", _GetPlainResString(IDS_IRC_DISCONNECT));
	OutS.Replace("[Connect]", _GetPlainResString(IDS_CONNECTTOANYSERVER));
	OutS.Replace("[URL_ServerOptions]", IsSessionAdmin(Data,sSession)?CString("/?ses=" + sSession + "&w=server&c=options"):GetPermissionDenied());
	OutS.Replace("[ServerOptions]", CString(_GetPlainResString(IDS_SERVER)+_GetPlainResString(IDS_EM_PREFS)));
	OutS.Replace("[WebSearch]", _GetPlainResString(IDS_SW_WEBBASED));
d2264 1
a2264 1
			OutS.Replace("[1]", _GetPlainResString(IDS_CONNECTED));
d2266 1
a2266 1
			OutS.Replace("[1]", _GetPlainResString(IDS_CONNECTED) + " (" + _GetPlainResString(IDS_LOWID) + ")");
d2269 1
a2269 1
		OutS.Replace("[2]", CString(cur_server->GetListName()));
d2271 1
a2271 1
		sprintf(HTTPTempC, "%10i", cur_server->GetUsers());
d2273 1
a2273 1
		OutS.Replace("[3]", HTTPTemp);
d2276 3
a2278 3
		OutS.Replace("[1]", _GetPlainResString(IDS_CONNECTING));
		OutS.Replace("[2]", "");
		OutS.Replace("[3]", "");
d2282 3
a2284 3
		OutS.Replace("[1]", _GetPlainResString(IDS_DISCONNECTED));
		OutS.Replace("[2]", "");
		OutS.Replace("[3]", "");
d2290 1
a2290 1
	return "";
d2446 1
a2446 1
	return "javascript:alert(\'"+_GetPlainResString(IDS_ACCESSDENIED)+"\')";
d2475 1
a2475 1
	sRet.Replace("&", "");
d2478 2
a2479 2
		sRet.Replace("'", "&#8217;");
		sRet.Replace("\n", "\\n");
d2485 1
a2485 1
	return "";
d2495 10
a2504 10
		case MAKELANGID(LANG_POLISH,SUBLANG_DEFAULT):				return "windows-1250";
		case MAKELANGID(LANG_RUSSIAN,SUBLANG_DEFAULT):				return "windows-1251";
		case MAKELANGID(LANG_GREEK,SUBLANG_DEFAULT):				return "ISO-8859-7";
		case MAKELANGID(LANG_HEBREW,SUBLANG_DEFAULT):				return "ISO-8859-8";
		case MAKELANGID(LANG_KOREAN,SUBLANG_DEFAULT):				return "EUC-KR";
		case MAKELANGID(LANG_CHINESE,SUBLANG_CHINESE_SIMPLIFIED):	return "GB2312";
		case MAKELANGID(LANG_CHINESE,SUBLANG_CHINESE_TRADITIONAL):	return "Big5";
		case MAKELANGID(LANG_LITHUANIAN,SUBLANG_DEFAULT):			return "windows-1257";
		case MAKELANGID(LANG_ROMANIAN,SUBLANG_DEFAULT):				return "windows-1250";
		case MAKELANGID(LANG_TURKISH,SUBLANG_DEFAULT):				return "windows-1254";
d2511 1
a2511 1
	return "ISO-8859-1";
d2519 1
a2519 1
		return "";
d2525 2
a2526 2
	CString Out = "";
	CString temp = "";
d2530 4
a2533 4
	progresscolor[0]="green.gif";
	progresscolor[1]="black.gif";
	progresscolor[2]="yellow.gif";
	progresscolor[3]="red.gif";
d2535 8
a2542 8
	progresscolor[4]="blue1.gif";
	progresscolor[5]="blue2.gif";
	progresscolor[6]="blue3.gif";
	progresscolor[7]="blue4.gif";
	progresscolor[8]="blue5.gif";
	progresscolor[9]="blue6.gif";
	progresscolor[10]="greenpercent.gif";
	progresscolor[11]="transparent.gif";
d2548 1
a2548 1
		temp.Format(pThis->m_Templates.sProgressbarImgsPercent+"<br>",progresscolor[10],pThis->m_Templates.iProgressbarWidth);
d2574 1
a2574 1
		(compl>0)?temp.Format(pThis->m_Templates.sProgressbarImgsPercent+"<br>",progresscolor[10],compl) :temp.Format(pThis->m_Templates.sProgressbarImgsPercent+"<br>",progresscolor[11],5);	//Ju1i3n - merged with eMulePlus by janes bong
d2587 1
a2587 1
		return "";
d2589 1
a2589 1
	CString sSession = _ParseURL(Data.sURL, "ses");
d2592 2
a2593 2
	if (_ParseURL(Data.sURL, "downloads") != "" && IsSessionAdmin(Data,sSession) ) {
		CString downloads=_ParseURLArray(Data.sURL,"downloads");
d2597 1
a2597 1
		resToken= downloads.Tokenize("|",curPos);
d2603 1
a2603 1
			resToken= downloads.Tokenize("|",curPos);
d2607 1
a2607 1
	if(_ParseURL(Data.sURL, "tosearch") != "" && IsSessionAdmin(Data,sSession) )
d2612 7
a2618 7
			_ParseURL(Data.sURL, "tosearch"),
			_ParseURL(Data.sURL, "type"),
			atol(_ParseURL(Data.sURL, "min"))*1048576,
			atol(_ParseURL(Data.sURL, "max"))*1048576,
			_tstoi(_ParseURL(Data.sURL, "avail")),
			_ParseURL(Data.sURL, "ext"),
			(_ParseURL(Data.sURL, "global")=="on")
d2620 1
a2620 1
		Out.Replace("[Message]",_GetPlainResString(IDS_SW_SEARCHINGINFO));
d2622 2
a2623 2
	else if(_ParseURL(Data.sURL, "tosearch") != "" && !IsSessionAdmin(Data,sSession) ) {
		Out.Replace("[Message]",_GetPlainResString(IDS_ACCESSDENIED));
d2625 1
a2625 1
	else Out.Replace("[Message]","");
d2629 1
a2629 1
	Out.Replace(_T("[SEARCHINFOMSG]"),"");
d2641 1
a2641 1
	Out.Replace(_T("[Other]"), "Other");
d2661 1
a2661 1
	return "";
@


1.54
log
@unicode cleanup
@
text
@d1227 1
a1227 1
			} else {	//SyruS  we now can clear single completed files from downloadlist
@


1.53
log
@Preparing for new sockets
@
text
@d1377 1
a1377 1
			sprintf(HTTPTempC, _T("%i") , cur_client->GetScore(false));
d1461 1
a1461 1
		Out.Replace("[SortName]", "sort=name&sortreverse=" + sSharedSortRev);
d1463 1
a1463 1
		Out.Replace("[SortName]", "sort=name");
d1466 1
a1466 1
		Out.Replace("[SortSize]", "sort=size&sortreverse=" + sSharedSortRev);
d1468 1
a1468 1
		Out.Replace("[SortSize]", "sort=size");
d1471 1
a1471 1
		Out.Replace("[SortPriority]", "sort=priority&sortreverse=" + sSharedSortRev);
d1473 1
a1473 1
		Out.Replace("[SortPriority]", "sort=priority");
d1478 1
a1478 1
            Out.Replace("[SortTransferred]", "sort=alltimetransferred&sortreverse=" + sSharedSortRev);
d1480 1
a1480 1
			Out.Replace("[SortTransferred]", "sort=transferred&sortreverse=" + sSharedSortRev);
d1486 1
a1486 1
            Out.Replace("[SortTransferred]", "sort=transferred&sortreverse=" + sSharedSortRev);
d1488 1
a1488 1
			Out.Replace("[SortTransferred]", "sort=alltimetransferred&sortreverse=" + sSharedSortRev);
d1491 1
a1491 1
        Out.Replace("[SortTransferred]", "&sort=transferred&sortreverse=false");
d1496 1
a1496 1
            Out.Replace("[SortRequests]", "sort=alltimerequests&sortreverse=" + sSharedSortRev);
d1498 1
a1498 1
			Out.Replace("[SortRequests]", "sort=requests&sortreverse=" + sSharedSortRev);
d1504 1
a1504 1
            Out.Replace("[SortRequests]", "sort=requests&sortreverse=" + sSharedSortRev);
d1506 1
a1506 1
			Out.Replace("[SortRequests]", "sort=alltimerequests&sortreverse=" + sSharedSortRev);
d1509 1
a1509 1
        Out.Replace("[SortRequests]", "&sort=requests&sortreverse=false");
d1514 1
a1514 1
            Out.Replace("[SortAccepts]", "sort=alltimeaccepts&sortreverse=" + sSharedSortRev);
d1516 1
a1516 1
			Out.Replace("[SortAccepts]", "sort=accepts&sortreverse=" + sSharedSortRev);
d1522 1
a1522 1
            Out.Replace("[SortAccepts]", "sort=accepts&sortreverse=" + sSharedSortRev);
d1524 1
a1524 1
			Out.Replace("[SortAccepts]", "sort=alltimeaccepts&sortreverse=" + sSharedSortRev);
d1527 1
a1527 1
        Out.Replace("[SortAccepts]", "&sort=accepts&sortreverse=false");
d1529 1
a1529 1
	if(_ParseURL(Data.sURL, "reload") == "true")
d1534 1
a1534 1
		Out.Replace("[Message]",resultlog);
d1537 1
a1537 1
        Out.Replace("[Message]","");
d1539 9
a1547 9
	Out.Replace("[Filename]", _GetPlainResString(IDS_DL_FILENAME));
	Out.Replace("[Priority]",  _GetPlainResString(IDS_PRIORITY));
    Out.Replace("[FileTransferred]",  _GetPlainResString(IDS_SF_TRANSFERRED));
    Out.Replace("[FileRequests]",  _GetPlainResString(IDS_SF_REQUESTS));
    Out.Replace("[FileAccepts]",  _GetPlainResString(IDS_SF_ACCEPTS));
	Out.Replace("[Size]", _GetPlainResString(IDS_DL_SIZE));
	Out.Replace("[Actions]", _GetPlainResString(IDS_WEB_ACTIONS));
	Out.Replace("[Reload]", _GetPlainResString(IDS_SF_RELOAD));
	Out.Replace("[Session]", sSession);
d1550 3
a1552 3
	OutE.Replace("[Ed2klink]", _GetPlainResString(IDS_SW_LINK));
    OutE.Replace("[PriorityUp]", _GetPlainResString(IDS_PRIORITY_UP));
    OutE.Replace("[PriorityDown]", _GetPlainResString(IDS_PRIORITY_DOWN));
d1555 3
a1557 3
	OutE.Replace("[Ed2klink]", _GetPlainResString(IDS_SW_LINK));
    OutE.Replace("[PriorityUp]", _GetPlainResString(IDS_PRIORITY_UP));
    OutE.Replace("[PriorityUp]", _GetPlainResString(IDS_PRIORITY_DOWN));
d1682 1
a1682 1
	CString sSharedList = "";
d1685 1
a1685 1
		char HTTPTempC[100] = "";
d1687 1
a1687 1
		if (SharedArray[i].sFileHash == _ParseURL(Data.sURL,"hash") )
d1692 1
a1692 1
		HTTPProcessData.Replace("[FileName]", _SpecialChars(SharedArray[i].sFileName));
d1694 1
a1694 1
            HTTPProcessData.Replace("[ShortFileName]", _SpecialChars(SharedArray[i].sFileName.Left(SHORT_FILENAME_LENGTH)) + "...");
d1696 1
a1696 1
			HTTPProcessData.Replace("[ShortFileName]", _SpecialChars(SharedArray[i].sFileName));
d1698 3
a1700 3
		sprintf(HTTPTempC, "%s",CastItoXBytes(SharedArray[i].lFileSize));
		HTTPProcessData.Replace("[FileSize]", CString(HTTPTempC));
		HTTPProcessData.Replace("[FileLink]", SharedArray[i].sED2kLink);
d1702 2
a1703 2
		sprintf(HTTPTempC, "%s",CastItoXBytes(SharedArray[i].nFileTransferred));
		HTTPProcessData.Replace("[FileTransferred]", CString(HTTPTempC));
d1705 2
a1706 2
		sprintf(HTTPTempC, "%s",CastItoXBytes(SharedArray[i].nFileAllTimeTransferred));
		HTTPProcessData.Replace("[FileAllTimeTransferred]", CString(HTTPTempC));
d1708 2
a1709 2
		sprintf(HTTPTempC, "%i", SharedArray[i].nFileRequests);
		HTTPProcessData.Replace("[FileRequests]", CString(HTTPTempC));
d1711 2
a1712 2
		sprintf(HTTPTempC, "%i", SharedArray[i].nFileAllTimeRequests);
		HTTPProcessData.Replace("[FileAllTimeRequests]", CString(HTTPTempC));
d1714 2
a1715 2
		sprintf(HTTPTempC, "%i", SharedArray[i].nFileAccepts);
		HTTPProcessData.Replace("[FileAccepts]", CString(HTTPTempC));
d1717 2
a1718 2
		sprintf(HTTPTempC, "%i", SharedArray[i].nFileAllTimeAccepts);
		HTTPProcessData.Replace("[FileAllTimeAccepts]", CString(HTTPTempC));
d1720 1
a1720 1
		HTTPProcessData.Replace("[Priority]", SharedArray[i].sFilePriority);
d1722 1
a1722 1
		HTTPProcessData.Replace("[FileHash]", SharedArray[i].sFileHash);
d1758 4
a1761 4
        sprintf(HTTPTempC, "%i", upperpriority);
		HTTPProcessData.Replace("[PriorityUpLink]", "hash=" + SharedArray[i].sFileHash +"&setpriority=" + CString(HTTPTempC));
        sprintf(HTTPTempC, "%i", lesserpriority);
		HTTPProcessData.Replace("[PriorityDownLink]", "hash=" + SharedArray[i].sFileHash +"&setpriority=" + CString(HTTPTempC)); 
d1765 2
a1766 2
	Out.Replace("[SharedFilesList]", sSharedList);
	Out.Replace("[Session]", sSession);
d1772 1
a1772 1
	return "";
d1781 1
a1781 1
		return "";
d1785 2
a1786 2
	CString sGraphDownload = "", sGraphUpload = "", sGraphCons = "";
	CString sTmp = "";
d1794 3
a1796 3
				sGraphDownload += ",";
				sGraphUpload += ",";
				sGraphCons += ",";
d1800 1
a1800 1
			sTmp.Format("%d" , (uint32) (pThis->m_Params.PointsForWeb[i].download*1024));
d1804 1
a1804 1
			sTmp.Format("%d" , (uint32) (pThis->m_Params.PointsForWeb[i].upload*1024));
d1808 1
a1808 1
			sTmp.Format("%d" , (uint32) (pThis->m_Params.PointsForWeb[i].connections));
d1813 9
a1821 9
	Out.Replace("[GraphDownload]", sGraphDownload);
	Out.Replace("[GraphUpload]", sGraphUpload);
	Out.Replace("[GraphConnections]", sGraphCons);

	Out.Replace("[TxtDownload]", _GetPlainResString(IDS_ST_ACTIVEDOWNLOAD));
	Out.Replace("[TxtUpload]", _GetPlainResString(IDS_ST_ACTIVEUPLOAD));
	Out.Replace("[TxtTime]", _GetPlainResString(IDS_TIME));
	Out.Replace("[KByteSec]", _GetPlainResString(IDS_KBYTESEC));
	Out.Replace("[TxtConnections]", _GetPlainResString(IDS_ST_ACTIVECONNECTIONS));
d1824 1
a1824 1
	sScale.Format("%s", CastSecondsToHM(theApp.glob_prefs->GetTrafficOMeterInterval() * WEB_GRAPH_WIDTH) );
d1827 8
a1834 8
	s1.Format("%d", theApp.glob_prefs->GetMaxGraphDownloadRate() + 4);
	s2.Format("%d", theApp.glob_prefs->GetMaxGraphUploadRate() + 4);
	s3.Format("%d", theApp.glob_prefs->GetMaxConnections());

	Out.Replace("[ScaleTime]", sScale);
	Out.Replace("[MaxDownload]", s1);
	Out.Replace("[MaxUpload]", s2);
	Out.Replace("[MaxConnections]", s3);
d1840 1
a1840 1
	return "";
d1849 1
a1849 1
		return "";
d1851 1
a1851 1
	CString sSession = _ParseURL(Data.sURL, "ses");
d1853 1
a1853 1
	if (!IsSessionAdmin(Data,sSession)) return "";
d1856 1
a1856 1
	if(_ParseURL(Data.sURL, "addserver") == "true")
d1858 1
a1858 1
		theApp.emuledlg->serverwnd.AddServer(_ParseURL(Data.sURL, "serveraddr"),_ParseURL(Data.sURL, "serverport"),_ParseURL(Data.sURL, "servername"));
d1862 1
a1862 1
		Out.Replace("[Message]",resultlog);
d1865 1
a1865 1
		if(_ParseURL(Data.sURL, "updateservermetfromurl") == "true")
d1867 1
a1867 1
			theApp.emuledlg->serverwnd.UpdateServerMetFromURL(_ParseURL(Data.sURL, "servermeturl"));
d1871 1
a1871 1
			Out.Replace("[Message]",resultlog);
d1874 9
a1882 9
		Out.Replace("[Message]", "");
    Out.Replace("[AddServer]", _GetPlainResString(IDS_SV_NEWSERVER));
	Out.Replace("[IP]", _GetPlainResString(IDS_SV_ADDRESS));
	Out.Replace("[Port]", _GetPlainResString(IDS_SV_PORT));
	Out.Replace("[Name]", _GetPlainResString(IDS_SW_NAME));
	Out.Replace("[Add]", _GetPlainResString(IDS_SV_ADD));
	Out.Replace("[UpdateServerMetFromURL]", _GetPlainResString(IDS_SV_MET));
	Out.Replace("[URL]", _GetPlainResString(IDS_SV_URL));
	Out.Replace("[Apply]", _GetPlainResString(IDS_PW_APPLY));
d1888 1
a1888 1
	return "";
d1896 1
a1896 1
		return "";
d1898 1
a1898 1
	CString sSession = _ParseURL(Data.sURL, "ses");
d1901 1
a1901 1
	if(_ParseURL(Data.sURL, "tosearch") != "")
d1904 3
a1906 3
		CString tosearch = _ParseURL(Data.sURL, "tosearch");
		query = "http://www.filedonkey.com/fdsearch/index.php?media=";
		query += _ParseURL(Data.sURL, "media");
d1908 18
a1925 18
		tosearch.Replace("%20","+");
		query += "&pattern=";
		query += _ParseURL(Data.sURL, "tosearch");
		query += "&action=search&name=FD-Search&op=modload&file=index&requestby=emule";
		Out += "\n<script language=\"javascript\">";
		Out += "\n searchwindow=window.open('"+ query + "','searchwindow');";
		Out += "\n</script>";
	}
	Out.Replace("[Session]", sSession);
	Out.Replace("[Name]", _GetPlainResString(IDS_SW_NAME));
	Out.Replace("[Type]", _GetPlainResString(IDS_TYPE));
	Out.Replace("[Any]", _GetPlainResString(IDS_SEARCH_ANY));
	Out.Replace("[Audio]", _GetPlainResString(IDS_SEARCH_AUDIO));
	Out.Replace("[Video]", _GetPlainResString(IDS_SEARCH_VIDEO));
	Out.Replace("[Document]", _GetPlainResString(IDS_SEARCH_DOC));
	Out.Replace("[Other]", "Other");
	Out.Replace("[Search]", _GetPlainResString(IDS_SW_START));
	Out.Replace("[WebSearch]", _GetPlainResString(IDS_SW_WEBBASED));
d1931 1
a1931 1
	return "";
d1940 1
a1940 1
		return "";
d1942 1
a1942 1
	CString sSession = _ParseURL(Data.sURL, "ses");
d1946 1
a1946 1
	if (_ParseURL(Data.sURL, "clear") == "yes" && IsSessionAdmin(Data,sSession))
d1950 3
a1952 3
	Out.Replace("[Clear]", _GetPlainResString(IDS_PW_RESET));
	Out.Replace("[Log]", _SpecialChars(theApp.emuledlg->logtext));
	Out.Replace("[Session]", sSession);
d1958 1
a1958 1
	return "";
d1967 1
a1967 1
		return "";
d1969 1
a1969 1
	CString sSession = _ParseURL(Data.sURL, "ses");
d1973 1
a1973 1
	if (_ParseURL(Data.sURL, "clear") == "yes" && IsSessionAdmin(Data,sSession))
d1975 1
a1975 1
		theApp.emuledlg->serverwnd.servermsgbox.SetWindowText("");
d1977 3
a1979 3
	Out.Replace("[Clear]", _GetPlainResString(IDS_PW_RESET));
	Out.Replace("[ServerInfo]", _SpecialChars(theApp.emuledlg->serverwnd.servermsgbox.GetHyperText()->GetText()));
	Out.Replace("[Session]", sSession);
d1985 1
a1985 1
	return "";
d1994 1
a1994 1
		return "";
d1996 1
a1996 1
	CString sSession = _ParseURL(Data.sURL, "ses");
d2000 1
a2000 1
	if (_ParseURL(Data.sURL, "clear") == "yes" && IsSessionAdmin(Data,sSession))
d2004 3
a2006 3
	Out.Replace("[Clear]", _GetPlainResString(IDS_PW_RESET));
	Out.Replace("[DebugLog]", _SpecialChars(theApp.emuledlg->debuglog));
	Out.Replace("[Session]", sSession);
d2012 1
a2012 1
	return "";
d2021 1
a2021 1
		return "";
d2023 1
a2023 1
	CString sSession = _ParseURL(Data.sURL, "ses");
d2029 1
a2029 1
	Out.Replace("[Stats]", theApp.emuledlg->statisticswnd.m_Stats.ExportHTML());
d2035 1
a2035 1
	return "";
d2044 1
a2044 1
		return "";
d2046 1
a2046 1
	CString sSession = _ParseURL(Data.sURL, "ses");
d2049 1
a2049 1
	Out.Replace("[Session]", sSession);
d2051 2
a2052 2
	if ((_ParseURL(Data.sURL, "saveprefs") == "true") && IsSessionAdmin(Data,sSession) ) {
		if(_ParseURL(Data.sURL, "gzip") == "true" || _ParseURL(Data.sURL, "gzip").MakeLower() == "on")
d2056 1
a2056 1
		if(_ParseURL(Data.sURL, "gzip") == "false" || _ParseURL(Data.sURL, "gzip") == "")
d2060 1
a2060 1
		if(_ParseURL(Data.sURL, "showuploadqueue") == "true" || _ParseURL(Data.sURL, "showuploadqueue").MakeLower() == "on" )
d2064 1
a2064 1
		if(_ParseURL(Data.sURL, "showuploadqueue") == "false" || _ParseURL(Data.sURL, "showuploadqueue") == "")
d2068 1
a2068 1
	    if(_ParseURL(Data.sURL, "refresh") != "")
d2070 1
a2070 1
		    theApp.glob_prefs->SetWebPageRefresh(_tstoi(_ParseURL(Data.sURL, "refresh")));
d2072 1
a2072 1
	    if(_ParseURL(Data.sURL, "maxdown") != "")
d2074 2
a2075 2
		    if(_tstoi(_ParseURL(Data.sURL, "maxdown"))>0)
			    theApp.glob_prefs->SetMaxDownload(_tstoi(_ParseURL(Data.sURL, "maxdown")));
d2079 1
a2079 1
	    if(_ParseURL(Data.sURL, "maxup") != "")
d2081 2
a2082 2
		    if(_tstoi(_ParseURL(Data.sURL, "maxup"))>0)
			    theApp.glob_prefs->SetMaxUpload(_tstoi(_ParseURL(Data.sURL, "maxup")));
d2086 1
a2086 1
	    if(_ParseURL(Data.sURL, "maxcapdown") != "")
d2088 1
a2088 1
		    theApp.glob_prefs->SetMaxGraphDownloadRate(_tstoi(_ParseURL(Data.sURL, "maxcapdown")));
d2090 1
a2090 1
	    if(_ParseURL(Data.sURL, "maxcapup") != "")
d2092 1
a2092 1
		    theApp.glob_prefs->SetMaxGraphUploadRate(_tstoi(_ParseURL(Data.sURL, "maxcapup")));
d2095 1
a2095 1
		if(_ParseURL(Data.sURL, "maxsources") != "")
d2097 1
a2097 1
			theApp.glob_prefs->SetMaxSourcePerFile(_tstoi(_ParseURL(Data.sURL, "maxsources")));
d2629 28
a2656 28
	Out.Replace("[SEARCHINFOMSG]","");
	Out.Replace("[RESULTLIST]", result);
	Out.Replace("[Result]", GetResString(IDS_SW_RESULT) );
	Out.Replace("[Session]", sSession);
	Out.Replace("[WebSearch]", _GetPlainResString(IDS_SW_WEBBASED));
	Out.Replace("[Name]", _GetPlainResString(IDS_SW_NAME));
	Out.Replace("[Type]", _GetPlainResString(IDS_TYPE));
	Out.Replace("[Any]", _GetPlainResString(IDS_SEARCH_ANY));
	Out.Replace("[Audio]", _GetPlainResString(IDS_SEARCH_AUDIO));
	Out.Replace("[Image]", _GetPlainResString(IDS_SEARCH_PICS));
	Out.Replace("[Video]", _GetPlainResString(IDS_SEARCH_VIDEO));
	Out.Replace("[Document]", _GetPlainResString(IDS_SEARCH_DOC));
	Out.Replace("[Other]", "Other");
	Out.Replace("[Search]", _GetPlainResString(IDS_SW_SEARCHBOX));
	Out.Replace("[RefetchResults]", _GetPlainResString(IDS_SW_REFETCHRES));
	Out.Replace("[Download]", _GetPlainResString(IDS_DOWNLOAD));
	Out.Replace("[Filesize]", _GetPlainResString(IDS_DL_SIZE));
	Out.Replace("[Sources]", _GetPlainResString(IDS_DL_SOURCES));
	Out.Replace("[Filehash]", _GetPlainResString(IDS_FILEHASH));
	Out.Replace("[Filename]", _GetPlainResString(IDS_DL_FILENAME));
	Out.Replace("[WebSearch]", _GetPlainResString(IDS_SW_WEBBASED));

	Out.Replace("[SizeMin]", _GetPlainResString(IDS_SEARCHMINSIZE));
	Out.Replace("[SizeMax]", _GetPlainResString(IDS_SEARCHMAXSIZE));
	Out.Replace("[Availabl]", _GetPlainResString(IDS_SEARCHAVAIL));
	Out.Replace("[Extention]", _GetPlainResString(IDS_SEARCHEXTENSION_LBL));
	Out.Replace("[Global]", _GetPlainResString(IDS_SW_GLOBAL));
	Out.Replace("[MB]", _GetPlainResString(IDS_MBYTES));
@


1.52
log
@unicode cleanup
@
text
@d612 1
d632 1
d1109 1
d1113 1
d1570 1
d1574 1
d2261 1
d2279 3
a2281 1
	} else {
@


1.51
log
@unicode cleanup
@
text
@d1169 2
a1170 2
		sED2kLink.Format("<acronym title=\"[Ed2klink]\"><a href=\""+ FilesArray[i].sED2kLink +"\"><img src=\"l_ed2klink.gif\" alt=\"[Ed2klink]\"></a></acronym> ");
		sED2kLink.Replace("[Ed2klink]", _GetPlainResString(IDS_SW_LINK));
d1198 2
a1199 2
				sPause.Format("<acronym title=\"[Stop]\"><a href=\"[Link]\"><img src=\"l_stop.gif\" alt=\"[Stop]\"></a></acronym> ");
				sPause.Replace("[Link]", CString("/?ses=" + sSession + "&w=transfer&op=stop&file=" + FilesArray[i].sFileHash));
d1209 2
a1210 2
				sCancel.Format("<acronym title=\"[Cancel]\"><a href=\"[Link]\" onclick=\"return confirm(\'[ConfirmCancel]\')\"><img src=\"l_cancel.gif\" alt=\"[Cancel]\"></a></acronym> ");
				sCancel.Replace("[Link]", CString("/?ses=" + sSession + "&w=transfer&op=cancel&file=" + FilesArray[i].sFileHash));
d1216 4
a1219 4
			sActions.Replace("[Resume]", _GetPlainResString(IDS_DL_RESUME));
			sActions.Replace("[Stop]", _GetPlainResString(IDS_DL_STOP));
			sActions.Replace("[Cancel]", _GetPlainResString(IDS_MAIN_BTN_CANCEL));
			sActions.Replace("[ConfirmCancel]", _GetPlainResString(IDS_Q_CANCELDL2, true));
d1221 2
a1222 2
				sActions.Append("<acronym title=\"[PriorityUp]\"><a href=\"/?ses=[Session]&amp;w=transfer&op=prioup&file=" + FilesArray[i].sFileHash+"\"><img src=\"l_up.gif\" alt=\"[PriorityUp]\"></a></acronym>");
				sActions.Append("&nbsp;<acronym title=\"[PriorityDown]\"><a href=\"/?ses=[Session]&amp;w=transfer&op=priodown&file=" + FilesArray[i].sFileHash+"\"><img src=\"l_down.gif\" alt=\"[PriorityDown]\"></a></acronym>");
d1224 2
a1225 2
				sActions.Append("<acronym title=\"[ClearCompleted]\"><a href=\"/?ses=[Session]&amp;w=transfer&clearcompleted=" + FilesArray[i].sFileHash+"\"><img src=\"l_clear.gif\" alt=\"[ClearCompleted]\"></a></acronym>");
				sActions.Replace("[ClearCompleted]", _GetPlainResString(IDS_DL_CLEAR));
d1237 1
a1237 1
		HTTPProcessData.Replace("[ShortFileName]", FilesArray[i].sFileName.Left(SHORT_FILENAME_LENGTH) + "...");
d1239 1
a1239 1
			HTTPProcessData.Replace("[ShortFileName]", FilesArray[i].sFileName);
d1242 4
a1245 4
		sTooltip.Replace("\n", "<br>");
		sTooltip.Replace("'", "&#8217;");
		HTTPProcessData.Replace("[FileInfo]", sTooltip);
		HTTPProcessData.Replace("[ED2KLink]", FilesArray[i].sED2kLink + "/");	//purity
d1249 1
a1249 1
		HTTPProcessData.Replace("[2]", CastItoXBytes(FilesArray[i].lFileSize));
d1255 1
a1255 1
			HTTPProcessData.Replace("[3]", CastItoXBytes(FilesArray[i].lFileTransferred));
d1258 1
a1258 1
			HTTPProcessData.Replace("[3]", "-");
d1260 1
a1260 1
		HTTPProcessData.Replace("[DownloadBar]", _GetDownloadGraph(Data,FilesArray[i].sFileHash));
d1266 2
a1267 2
			HTTPTemp.Format("%8.2f %s", FilesArray[i].lFileSpeed/1024.0 ,_GetPlainResString(IDS_KBYTESEC) );
			HTTPProcessData.Replace("[4]", HTTPTemp);
d1270 1
a1270 1
			HTTPProcessData.Replace("[4]", "-");
d1273 1
a1273 1
			HTTPTemp.Format("%i&nbsp;/&nbsp;%8i&nbsp;(%i)",
d1278 1
a1278 1
			HTTPProcessData.Replace("[5]", HTTPTemp);
d1281 1
a1281 1
			HTTPProcessData.Replace("[5]", "-");
d1294 2
a1295 2
		HTTPProcessData.Replace("[PrioVal]", HTTPTemp);
		HTTPProcessData.Replace("[6]", sActions);
d1300 4
a1303 4
	Out.Replace("[DownloadFilesList]", sDownList);
    Out.Replace("[PriorityUp]", _GetPlainResString(IDS_PRIORITY_UP));
    Out.Replace("[PriorityDown]", _GetPlainResString(IDS_PRIORITY_DOWN));
	Out.Replace("[TotalDownSize]", CastItoXBytes(fTotalSize));
d1305 1
a1305 1
	Out.Replace("[TotalDownTransferred]", CastItoXBytes(fTotalTransferred));
d1307 2
a1308 2
	HTTPTemp.Format("%8.2f %s", fTotalSpeed/1024.0,_GetPlainResString(IDS_KBYTESEC));
	Out.Replace("[TotalDownSpeed]", HTTPTemp);
d1311 2
a1312 2
	HTTPTemp.Format("%i",pThis->m_Templates.iProgressbarWidth);
	Out.Replace("[PROGRESSBARWIDTHVAL]",HTTPTemp);
d1318 1
a1318 1
	CString sUpList = "";
d1323 2
a1324 2
		HTTPProcessData.Replace("[1]", _SpecialChars(cur_client->GetUserName()));
		HTTPProcessData.Replace("[FileInfo]", _SpecialChars(cur_client->GetUploadFileInfo()));
d1328 1
a1328 1
			HTTPProcessData.Replace("[2]", _SpecialChars(CString(file->GetFileName())));
d1330 1
a1330 1
			HTTPProcessData.Replace("[2]", _GetPlainResString(IDS_REQ_UNKNOWNFILE));
d1335 2
a1336 2
		HTTPTemp.Format("%s / %s", CastItoXBytes(cur_client->GetTransferedDown()),CastItoXBytes(cur_client->GetTransferedUp()));
		HTTPProcessData.Replace("[3]", HTTPTemp);
d1339 2
a1340 2
		HTTPTemp.Format("%8.2f " + _GetPlainResString(IDS_KBYTESEC), cur_client->GetDatarate()/1024.0);
		HTTPProcessData.Replace("[4]", HTTPTemp);
d1344 5
a1348 5
	Out.Replace("[UploadFilesList]", sUpList);
	HTTPTemp.Format("%s / %s", CastItoXBytes(fTotalSize), CastItoXBytes(fTotalTransferred));
	Out.Replace("[TotalUpTransferred]", HTTPTemp);
	HTTPTemp.Format("%8.2f " + _GetPlainResString(IDS_KBYTESEC), fTotalSpeed/1024.0);
	Out.Replace("[TotalUpSpeed]", HTTPTemp);
d1352 6
a1357 6
		Out.Replace("[UploadQueue]", pThis->m_Templates.sTransferUpQueueShow);
		Out.Replace("[UploadQueueList]", _GetPlainResString(IDS_ONQUEUE));
		Out.Replace("[UserNameTitle]", _GetPlainResString(IDS_QL_USERNAME));
		Out.Replace("[FileNameTitle]", _GetPlainResString(IDS_DL_FILENAME));
		Out.Replace("[ScoreTitle]", _GetPlainResString(IDS_SCORE));
		Out.Replace("[BannedTitle]", _GetPlainResString(IDS_BANNED));
d1361 1
a1361 1
		CString sQueue = "";
d1365 1
a1365 1
            char HTTPTempC[100] = "";
d1367 1
a1367 1
			HTTPProcessData.Replace("[UserName]", _SpecialChars(cur_client->GetUserName()));
d1370 1
a1370 1
				HTTPProcessData.Replace("[FileName]", _SpecialChars(file->GetFileName()));
d1372 2
a1373 2
				HTTPProcessData.Replace("[FileName]", "?");
			sprintf(HTTPTempC, "%i" , cur_client->GetScore(false));
d1375 1
a1375 1
			HTTPProcessData.Replace("[Score]", HTTPTemp);
d1377 1
a1377 1
				HTTPProcessData.Replace("[Banned]", _GetPlainResString(IDS_YES));
d1379 1
a1379 1
				HTTPProcessData.Replace("[Banned]", _GetPlainResString(IDS_NO));
d1382 1
a1382 1
		Out.Replace("[QueueList]", sQueue);
d1385 1
a1385 1
		Out.Replace("[UploadQueue]", pThis->m_Templates.sTransferUpQueueHide);
d1387 3
a1389 3
	Out.Replace("[ShowQueue]", _GetPlainResString(IDS_WEB_SHOW_UPLOAD_QUEUE));
	Out.Replace("[HideQueue]", _GetPlainResString(IDS_WEB_HIDE_UPLOAD_QUEUE));
	Out.Replace("[Session]", sSession);
d1395 1
a1395 1
	return "";
d1403 1
a1403 1
        CString sSession = _ParseURL(Data.sURL, "ses");
d1411 1
a1411 1
		if(_ParseURL(Data.sURL, "sort") == "size")
d1414 1
a1414 1
		if(_ParseURL(Data.sURL, "sort") == "transferred")
d1417 1
a1417 1
		if(_ParseURL(Data.sURL, "sort") == "alltimetransferred")
d1420 1
a1420 1
		if(_ParseURL(Data.sURL, "sort") == "requests")
d1423 1
a1423 1
		if(_ParseURL(Data.sURL, "sort") == "alltimerequests")
d1426 1
a1426 1
		if(_ParseURL(Data.sURL, "sort") == "accepts")
d1429 1
a1429 1
		if(_ParseURL(Data.sURL, "sort") == "alltimeaccepts")
d1432 1
a1432 1
		if(_ParseURL(Data.sURL, "sort") == "priority")
d1435 1
a1435 1
		if(_ParseURL(Data.sURL, "sortreverse") == "")
d1438 2
a1439 2
	if (_ParseURL(Data.sURL, "sortreverse") != "") 
		pThis->m_Params.bSharedSortReverse = (_ParseURL(Data.sURL, "sortreverse") == "true");
d1441 2
a1442 2
	if(_ParseURL(Data.sURL, "hash") != "" && _ParseURL(Data.sURL, "setpriority") != "" && IsSessionAdmin(Data,sSession)) 
		_SetSharedFilePriority(_ParseURL(Data.sURL, "hash"),_tstoi(_ParseURL(Data.sURL, "setpriority")));
d1444 1
a1444 1
	if(_ParseURL(Data.sURL, "reload") == "true")
d2423 1
a2423 1
	long sessionID=__tstoi64(SsessionID);
@


1.50
log
@SyruS removed "clear completed" link from "Downloads" in header cause it's not needed anymore with the new icon at the end
@
text
@d14 2
a15 2
#define HTTPInit "Server: eMule\r\nConnection: close\r\nContent-Type: text/html\r\n"
#define HTTPInitGZ "Server: eMule\r\nConnection: close\r\nContent-Type: text/html\r\nContent-Encoding: gzip\r\n"
d44 1
a44 1
	setlocale(LC_TIME, _T("English"));
d48 1
a48 1
	setlocale(LC_TIME, sPrevLocale);
d61 1
a61 1
			sAll += sLine + "\n";
d65 2
a66 2
		CString sVersion = _LoadTemplate(sAll,"TMPL_VERSION");
		long lVersion = atol(sVersion);
d78 43
a120 43
			m_Templates.sHeader = _LoadTemplate(sAll,"TMPL_HEADER");
			m_Templates.sHeaderMetaRefresh = _LoadTemplate(sAll,"TMPL_HEADER_META_REFRESH");
			m_Templates.sHeaderStylesheet = _LoadTemplate(sAll,"TMPL_HEADER_STYLESHEET");
			m_Templates.sFooter = _LoadTemplate(sAll,"TMPL_FOOTER");
			m_Templates.sServerList = _LoadTemplate(sAll,"TMPL_SERVER_LIST");
			m_Templates.sServerLine = _LoadTemplate(sAll,"TMPL_SERVER_LINE");
			m_Templates.sTransferImages = _LoadTemplate(sAll,"TMPL_TRANSFER_IMAGES");
			m_Templates.sTransferList = _LoadTemplate(sAll,"TMPL_TRANSFER_LIST");
			m_Templates.sTransferDownHeader = _LoadTemplate(sAll,"TMPL_TRANSFER_DOWN_HEADER");
			m_Templates.sTransferDownFooter = _LoadTemplate(sAll,"TMPL_TRANSFER_DOWN_FOOTER");
			m_Templates.sTransferDownLine = _LoadTemplate(sAll,"TMPL_TRANSFER_DOWN_LINE");
			m_Templates.sTransferDownLineGood = _LoadTemplate(sAll,"TMPL_TRANSFER_DOWN_LINE_GOOD");
			m_Templates.sTransferUpHeader = _LoadTemplate(sAll,"TMPL_TRANSFER_UP_HEADER");
			m_Templates.sTransferUpFooter = _LoadTemplate(sAll,"TMPL_TRANSFER_UP_FOOTER");
			m_Templates.sTransferUpLine = _LoadTemplate(sAll,"TMPL_TRANSFER_UP_LINE");
			m_Templates.sTransferUpQueueShow = _LoadTemplate(sAll,"TMPL_TRANSFER_UP_QUEUE_SHOW");
			m_Templates.sTransferUpQueueHide = _LoadTemplate(sAll,"TMPL_TRANSFER_UP_QUEUE_HIDE");
			m_Templates.sTransferUpQueueLine = _LoadTemplate(sAll,"TMPL_TRANSFER_UP_QUEUE_LINE");
			m_Templates.sTransferBadLink = _LoadTemplate(sAll,"TMPL_TRANSFER_BAD_LINK");
			m_Templates.sSharedList = _LoadTemplate(sAll,"TMPL_SHARED_LIST");
			m_Templates.sSharedLine = _LoadTemplate(sAll,"TMPL_SHARED_LINE");
			m_Templates.sSharedLineChanged = _LoadTemplate(sAll,"TMPL_SHARED_LINE_CHANGED");
			m_Templates.sGraphs = _LoadTemplate(sAll,"TMPL_GRAPHS");
			m_Templates.sLog = _LoadTemplate(sAll,"TMPL_LOG");
			m_Templates.sServerInfo = _LoadTemplate(sAll,"TMPL_SERVERINFO");
			m_Templates.sDebugLog = _LoadTemplate(sAll,"TMPL_DEBUGLOG");
			m_Templates.sStats = _LoadTemplate(sAll,"TMPL_STATS");
			m_Templates.sPreferences = _LoadTemplate(sAll,"TMPL_PREFERENCES");
			m_Templates.sLogin = _LoadTemplate(sAll,"TMPL_LOGIN");
			m_Templates.sConnectedServer = _LoadTemplate(sAll,"TMPL_CONNECTED_SERVER");
			m_Templates.sAddServerBox = _LoadTemplate(sAll,"TMPL_ADDSERVERBOX");
			m_Templates.sWebSearch = _LoadTemplate(sAll,"TMPL_WEBSEARCH");
			m_Templates.sSearch = _LoadTemplate(sAll,"TMPL_SEARCH");
			m_Templates.iProgressbarWidth=atoi(_LoadTemplate(sAll,"PROGRESSBARWIDTH"));
			m_Templates.sSearchHeader = _LoadTemplate(sAll,"TMPL_SEARCH_RESULT_HEADER");			
			m_Templates.sSearchResultLine = _LoadTemplate(sAll,"TMPL_SEARCH_RESULT_LINE");			
			m_Templates.sProgressbarImgs = _LoadTemplate(sAll,"PROGRESSBARIMGS");
			m_Templates.sProgressbarImgsPercent = _LoadTemplate(sAll,"PROGRESSBARPERCENTIMG");

			m_Templates.sProgressbarImgsPercent.Replace("[PROGRESSGIFNAME]","%s");
			m_Templates.sProgressbarImgsPercent.Replace("[PROGRESSGIFINTERNAL]","%i");
			m_Templates.sProgressbarImgs.Replace("[PROGRESSGIFNAME]","%s");
			m_Templates.sProgressbarImgs.Replace("[PROGRESSGIFINTERNAL]","%i");
d144 3
a146 3
	CString sRet = "";
	int nStart = sAll.Find("<--" + sTemplateName + "-->");
	int nEnd = sAll.Find("<--" + sTemplateName + "_END-->");
d161 1
a161 1
	return "";
d185 1
a185 1
		AddLogLine(false,"%s: %s",_GetPlainResString(IDS_PW_HTTPD), _GetPlainResString(IDS_ENABLED).MakeLower());
d187 1
a187 1
		AddLogLine(false,"%s: %s",_GetPlainResString(IDS_PW_HTTPD), _GetPlainResString(IDS_DISABLED).MakeLower());
d262 4
a265 4
	str.Replace("&","&amp;");
	str.Replace("<","&lt;");
	str.Replace(">","&gt;");
	str.Replace("\"","&quot;");
d270 1
a270 1
	return "";
d298 2
a299 2
	contenttype += "Last-Modified: " + pThis->m_Params.sLastModified + "\r\n" +
		"ETag: " + pThis->m_Params.sETag + "\r\n";
d303 1
a303 1
	filename=CString(theApp.glob_prefs->GetAppDir())+"webserver\\"+filename;
d307 1
a307 1
		char* buffer=new char[file.GetLength()];
d329 4
a332 4
	CString Out = "";
	CString OutE = "";	// List Entry Templates
	CString OutE2 = "";
	CString OutS = "";	// ServerStatus Templates
d336 2
a337 2
	CString HTTPProcessData = "";
	CString HTTPTemp = "";
d342 2
a343 2
	if(_ParseURL(Data.sURL, "ses") != "")
		lSession = atol(_ParseURL(Data.sURL, "ses"));
d345 1
a345 1
	if (_ParseURL(Data.sURL, "w") == "password")
d347 1
a347 1
		CString test=MD5Sum(_ParseURL(Data.sURL, "p")).GetHash();
d349 1
a349 1
		if(MD5Sum(_ParseURL(Data.sURL, "p")).GetHash() == theApp.glob_prefs->GetWSPass())
d358 1
a358 1
		else if(theApp.glob_prefs->GetWSIsLowUserEnabled() && theApp.glob_prefs->GetWSLowPass()!="" && MD5Sum(_ParseURL(Data.sURL, "p")).GetHash() == theApp.glob_prefs->GetWSLowPass())
d372 1
a372 1
	CString sSession; sSession.Format("%ld", lSession);
d374 1
a374 1
	if (_ParseURL(Data.sURL, "w") == "logout") 
d380 1
a380 1
		CString sPage = _ParseURL(Data.sURL, "w");
d491 1
a491 1
		int pos=URL.MakeLower().Find(fieldname.MakeLower() +"=");
d495 1
a495 1
			res.Append(temp+"|");
d502 1
a502 1
	return "";
d509 4
a512 4
	CString value = "";
	CString Parameter = "";
	char fromReplace[4] = "";	// decode URL
	char toReplace[2] = "";		// decode URL
d517 2
a518 2
	if (URL.Find("?") > -1) {
		Parameter = URL.Mid(URL.Find("?")+1, URL.GetLength()-URL.Find("?")-1);
d521 1
a521 1
		if (Parameter.Find(fieldname + "=") == 0) {
d525 2
a526 2
		if (Parameter.Find("&" + fieldname + "=") > -1) {
			findPos = Parameter.Find("&" + fieldname + "=");
d531 2
a532 2
			if (Parameter.Find("&") > -1) {
				Parameter = Parameter.Mid(0, Parameter.Find("&"));
d538 1
a538 1
			value.Replace("+", " ");
d540 1
a540 1
				sprintf(fromReplace, "%%%02x", i);
d544 1
a544 1
				sprintf(fromReplace, "%%%02X", i);
d554 1
a554 1
	return "";
d563 1
a563 1
		return "";
d565 1
a565 1
	CString sSession; sSession.Format("%ld", lSession);
d569 1
a569 1
	Out.Replace("[CharSet]", _GetWebCharSet());
d573 1
a573 1
		CString sPage = _ParseURL(Data.sURL, "w");
d583 26
a608 26
			CString sRefresh; sRefresh.Format("%d", theApp.glob_prefs->GetWebPageRefresh());
			sT.Replace("[RefreshVal]", sRefresh);
			sT.Replace("[wCommand]", _ParseURL(Data.sURL, "w"));
			Out.Replace("[HeaderMeta]", sT);
		}
	}
	Out.Replace("[Session]", sSession);
	Out.Replace("[HeaderMeta]", ""); // In case there are no meta
	Out.Replace("[eMuleAppName]", _GetPlainResString(IDS_EMULE_PLUS));
	Out.Replace("[version]", CURRENT_VERSION_LONG);
	Out.Replace("[StyleSheet]", pThis->m_Templates.sHeaderStylesheet);
	Out.Replace("[WebControl]", _GetPlainResString(IDS_WEB_CONTROL));
	Out.Replace("[Transfer]", _GetPlainResString(IDS_CD_TRANS));
	Out.Replace("[Server]", _GetPlainResString(IDS_SV_SERVERLIST));
	Out.Replace("[Shared]", _GetPlainResString(IDS_SHAREDFILES));
	Out.Replace("[Graphs]", _GetPlainResString(IDS_GRAPHS));
	Out.Replace("[Log]", _GetPlainResString(IDS_SV_LOG));
	Out.Replace("[ServerInfo]", _GetPlainResString(IDS_SV_SERVERINFO));
	Out.Replace("[DebugLog]", _GetPlainResString(IDS_SV_DEBUGLOG));
	Out.Replace("[Stats]", _GetPlainResString(IDS_SF_STATISTICS));
	Out.Replace("[Options]", _GetPlainResString(IDS_EM_PREFS));
	Out.Replace("[Logout]", _GetPlainResString(IDS_WEB_LOGOUT));
	Out.Replace("[Search]", _GetPlainResString(IDS_SW_SEARCHBOX));
	Out.Replace("[Download]", _GetPlainResString(IDS_SW_DOWNLOAD));
	Out.Replace("[Ed2klink]", _GetPlainResString(IDS_SW_LINK));
	Out.Replace("[Start]", _GetPlainResString(IDS_SW_START));
d610 2
a611 2
	char HTTPTempC[100] = "";
	CString sConnected = "";
d617 1
a617 1
			sConnected = _GetPlainResString(IDS_CONNECTED) + " (" + _GetPlainResString(IDS_LOWID) + ")";
d620 1
a620 1
		sConnected += ": " + CString(cur_server->GetListName());
d622 2
a623 2
		sprintf(HTTPTempC, "%i ", cur_server->GetUsers());
		sConnected += " [" + CString(HTTPTempC) + _GetPlainResString(IDS_LUSERS) + "]";
d633 1
a633 1
		if (IsSessionAdmin(Data,sSession)) sConnected+=" (<small><a href=\"/?ses=" + sSession + "&w=server&c=connect\">"+_GetPlainResString(IDS_CONNECTTOANYSERVER)+"</a></small>)";
d635 2
a636 2
	Out.Replace("[Connected]", "<b>"+_GetPlainResString(IDS_PW_CONNECTION)+":</b> "+sConnected);
    sprintf(HTTPTempC, _GetPlainResString(IDS_UPDOWN),(float)theApp.uploadqueue->GetDatarate()/1024,(float)theApp.downloadqueue->GetDatarate()/1024);
d641 2
a642 2
	MaxUpload.Format("%i",theApp.glob_prefs->GetMaxUpload());
	MaxDownload.Format("%i",theApp.glob_prefs->GetMaxDownload());
d645 1
a645 1
	sLimits.Format("%s/%s", MaxUpload, MaxDownload);
d647 1
a647 1
	Out.Replace("[Speed]", "<b>"+_GetPlainResString(IDS_DL_SPEED)+":</b> "+CString(HTTPTempC) + "<small> (" + _GetPlainResString(IDS_PW_CON_LIMIT) + ": " + sLimits + ")</small>");
d653 1
a653 1
	return "";
d662 1
a662 1
		return "";
d668 1
a668 1
	return "";
d677 1
a677 1
		return "";
d679 1
a679 1
	CString sSession = _ParseURL(Data.sURL, "ses");
d681 1
a681 1
	CString sAddServerBox = "";
d683 1
a683 1
	CString sCmd = _ParseURL(Data.sURL, "c");
d686 2
a687 2
		CString sIP = _ParseURL(Data.sURL, "ip");
		int nPort = atoi(_ParseURL(Data.sURL, "port"));
d699 2
a700 2
		CString sIP = _ParseURL(Data.sURL, "ip");
		int nPort = atoi(_ParseURL(Data.sURL, "port"));
d707 2
a708 2
		CString sIP = _ParseURL(Data.sURL, "ip");
		int nPort = atoi(_ParseURL(Data.sURL, "port"));
d715 2
a716 2
		CString sIP = _ParseURL(Data.sURL, "ip");
		int nPort = atoi(_ParseURL(Data.sURL, "port"));
d724 1
a724 1
	CString sSort = _ParseURL(Data.sURL, "sort");
d742 1
a742 1
		if(_ParseURL(Data.sURL, "sortreverse") == "")
d745 1
a745 1
	if (_ParseURL(Data.sURL, "sortreverse") != "") 
d747 1
a747 1
		pThis->m_Params.bServerSortReverse = (_ParseURL(Data.sURL, "sortreverse") == "true");
d756 3
a758 3
	Out.Replace("[ConnectedServerData]", _GetConnectedServer(Data));
    Out.Replace("[AddServerBox]", sAddServerBox);
	Out.Replace("[Session]", sSession);
d760 1
a760 1
		Out.Replace("[SortName]", "&sortreverse=" + sServerSortRev);
d762 1
a762 1
		Out.Replace("[SortName]", "");
d764 1
a764 1
		Out.Replace("[SortDescription]", "&sortreverse=" + sServerSortRev);
d766 1
a766 1
		Out.Replace("[SortDescription]", "");
d768 1
a768 1
		Out.Replace("[SortIP]", "&sortreverse=" + sServerSortRev);
d770 1
a770 1
		Out.Replace("[SortIP]", "");
d772 1
a772 1
		Out.Replace("[SortUsers]", "&sortreverse=" + sServerSortRev);
d774 1
a774 1
		Out.Replace("[SortUsers]", "");
d776 1
a776 1
		Out.Replace("[SortFiles]", "&sortreverse=" + sServerSortRev);
d778 9
a786 9
		Out.Replace("[SortFiles]", "");
	Out.Replace("[ServerList]", _GetPlainResString(IDS_SV_SERVERLIST));
	Out.Replace("[Servername]", _GetPlainResString(IDS_SL_SERVERNAME));
	Out.Replace("[Description]", _GetPlainResString(IDS_DESCRIPTION));
	Out.Replace("[Address]", _GetPlainResString(IDS_IP));
	Out.Replace("[Connect]", _GetPlainResString(IDS_IRC_CONNECT));
	Out.Replace("[Users]", _GetPlainResString(IDS_LUSERS));
	Out.Replace("[Files]", _GetPlainResString(IDS_LFILES));
	Out.Replace("[Actions]", _GetPlainResString(IDS_WEB_ACTIONS));
d789 2
a790 2
	OutE.Replace("[Connect]", _GetPlainResString(IDS_IRC_CONNECT));
	OutE.Replace("[RemoveServer]", _GetPlainResString(IDS_REMOVETHIS));
d792 2
a793 2
	OutE.Replace("[AddToStatic]", _GetPlainResString(IDS_ADDTOSTATIC));
	OutE.Replace("[RemoveFromStatic]", _GetPlainResString(IDS_REMOVEFROMSTATIC));
d795 1
a795 1
	OutE.Replace("[ConfirmRemove]", _GetPlainResString(IDS_WEB_CONFIRM_REMOVE_SERVER));
d856 1
a856 1
	CString sList = "";
d860 4
a863 4
		HTTPProcessData.Replace("[1]", ServerArray[i].sServerName);
		HTTPProcessData.Replace("[2]", ServerArray[i].sServerDescription);
		CString sPort; sPort.Format(":%d", ServerArray[i].nServerPort);
		HTTPProcessData.Replace("[3]", ServerArray[i].sServerIP + sPort);
d869 1
a869 1
				sT.Format("%d (%d)", ServerArray[i].nServerUsers, ServerArray[i].nServerMaxUsers);
d871 1
a871 1
				sT.Format("%d", ServerArray[i].nServerUsers);
d873 2
a874 2
		HTTPProcessData.Replace("[4]", sT);
		sT = "";
d876 5
a880 5
			sT.Format("%d", ServerArray[i].nServerFiles);
		HTTPProcessData.Replace("[5]", sT);
		CString sServerPort; sServerPort.Format("%d", ServerArray[i].nServerPort);
		HTTPProcessData.Replace("[6]", IsSessionAdmin(Data,sSession)? CString("/?ses=" + sSession + "&w=server&c=connect&ip=" + ServerArray[i].sServerIP + "&port=" + sServerPort):GetPermissionDenied());
		HTTPProcessData.Replace("[LinkRemove]", IsSessionAdmin(Data,sSession)?CString("/?ses=" + sSession + "&w=server&c=remove&ip=" + ServerArray[i].sServerIP + "&port=" + sServerPort):GetPermissionDenied());
d882 4
a885 4
		HTTPProcessData.Replace("[LinkAddToStatic]", IsSessionAdmin(Data,sSession)?CString("/?ses=" + sSession + "&w=server&c=addtostatic&ip=" + ServerArray[i].sServerIP + "&port=" + sServerPort):GetPermissionDenied());
		HTTPProcessData.Replace("[LinkRemoveFromStatic]", IsSessionAdmin(Data,sSession)?CString("/?ses=" + sSession + "&w=server&c=removefromstatic&ip=" + ServerArray[i].sServerIP + "&port=" + sServerPort):GetPermissionDenied());
		CString sServerStatic; sServerStatic.Format("%d", ServerArray[i].bServerStatic);
		HTTPProcessData.Replace("[ServerStaticState]", sServerStatic);
d889 1
a889 1
	Out.Replace("[ServersList]", sList);
d895 1
a895 1
	return "";
d904 1
a904 1
		return "";
d906 1
a906 1
	CString sSession = _ParseURL(Data.sURL, "ses");
d908 1
a908 1
	CString Out = "";
d911 1
a911 1
	CString ClearArg(_ParseURL(Data.sURL, "clearcompleted"));
d914 1
a914 1
		if (ClearArg.CompareNoCase("all") == 0) {
d923 1
a923 1
	if (_ParseURL(Data.sURL, "c") != "" && IsSessionAdmin(Data,sSession)) 
d925 1
a925 1
		CString HTTPTemp = _ParseURL(Data.sURL, "c");
d950 2
a951 2
	if (_ParseURL(Data.sURL, "op") != "" &&
		_ParseURL(Data.sURL, "file") != "")
d954 1
a954 1
		_GetFileHash(_ParseURL(Data.sURL, "file"), FileHash);
d958 1
a958 1
		if(_ParseURL(Data.sURL, "op") == "stop" && IsSessionAdmin(Data,sSession))
d963 1
a963 1
		else if(_ParseURL(Data.sURL, "op") == "resume" && IsSessionAdmin(Data,sSession))
d968 1
a968 1
		else if(_ParseURL(Data.sURL, "op") == "cancel" && IsSessionAdmin(Data,sSession))
d973 1
a973 1
		else if(_ParseURL(Data.sURL, "op") == "prioup" && IsSessionAdmin(Data,sSession))
d985 1
a985 1
		else if(_ParseURL(Data.sURL, "op") == "priodown" && IsSessionAdmin(Data,sSession))
d998 1
a998 1
	if (_ParseURL(Data.sURL, "sort") != "") 
d1000 1
a1000 1
		if(_ParseURL(Data.sURL, "sort") == "name")
d1003 1
a1003 1
		if(_ParseURL(Data.sURL, "sort") == "size")
d1006 1
a1006 1
		if(_ParseURL(Data.sURL, "sort") == "transferred")
d1009 1
a1009 1
		if(_ParseURL(Data.sURL, "sort") == "speed")
d1012 1
a1012 1
		if(_ParseURL(Data.sURL, "sort") == "progress")
d1015 1
a1015 1
		if(_ParseURL(Data.sURL, "sortreverse") == "")
d1018 1
a1018 1
	if (_ParseURL(Data.sURL, "sortreverse") != "") 
d1020 1
a1020 1
		pThis->m_Params.bDownloadSortReverse = (_ParseURL(Data.sURL, "sortreverse") == "true");
d1022 1
a1022 1
	if(_ParseURL(Data.sURL, "showuploadqueue") == "true")
d1026 1
a1026 1
	if(_ParseURL(Data.sURL, "showuploadqueue") == "false")
d1038 5
a1042 5
	Out.Replace("[DownloadHeader]", pThis->m_Templates.sTransferDownHeader);
	Out.Replace("[DownloadFooter]", pThis->m_Templates.sTransferDownFooter);
	Out.Replace("[UploadHeader]", pThis->m_Templates.sTransferUpHeader);
	Out.Replace("[UploadFooter]", pThis->m_Templates.sTransferUpFooter);
	Out.Replace("[Session]", sSession);
d1044 1
a1044 1
		Out.Replace("[SortName]", "&sortreverse=" + sDownloadSortRev);
d1046 1
a1046 1
		Out.Replace("[SortName]", "");
d1048 1
a1048 1
		Out.Replace("[SortSize]", "&sortreverse=" + sDownloadSortRev);
d1050 1
a1050 1
		Out.Replace("[SortSize]", "");
d1052 1
a1052 1
		Out.Replace("[SortTransferred]", "&sortreverse=" + sDownloadSortRev);
d1054 1
a1054 1
		Out.Replace("[SortTransferred]", "");
d1056 1
a1056 1
		Out.Replace("[SortSpeed]", "&sortreverse=" + sDownloadSortRev);
d1058 1
a1058 1
		Out.Replace("[SortSpeed]", "");
d1060 1
a1060 1
		Out.Replace("[SortProgress]", "&sortreverse=" + sDownloadSortRev);
d1062 1
a1062 1
		Out.Replace("[SortProgress]", "");
d1064 13
a1076 13
	Out.Replace("[DownloadList]", _GetPlainResString(IDS_ST_ACTIVEDOWNLOAD));
	Out.Replace("[Filename]", _GetPlainResString(IDS_DL_FILENAME));
	Out.Replace("[Size]", _GetPlainResString(IDS_DL_SIZE));
	Out.Replace("[Transferred]", _GetPlainResString(IDS_COMPLETE));
	Out.Replace("[Progress]", _GetPlainResString(IDS_DL_PROGRESS));
	Out.Replace("[Speed]", _GetPlainResString(IDS_DL_SPEED));
	Out.Replace("[Sources]", _GetPlainResString(IDS_DL_SOURCES));
	Out.Replace("[Actions]", _GetPlainResString(IDS_WEB_ACTIONS));
	Out.Replace("[UploadList]", _GetPlainResString(IDS_ST_ACTIVEUPLOAD));
	Out.Replace("[User]", _GetPlainResString(IDS_QL_USERNAME));
	Out.Replace("[TotalDown]", _GetPlainResString(IDS_INFLST_USER_TOTALDOWNLOAD));
	Out.Replace("[TotalUp]", _GetPlainResString(IDS_INFLST_USER_TOTALUPLOAD));
	Out.Replace("[Prio]", _GetPlainResString(IDS_PRIORITY));
d1158 1
a1158 1
	CString sDownList = "";
d1164 3
a1166 3
		JSfileinfo.Replace("\n","\\n");
		JSfileinfo.Replace("'","&#8217;"); // EC 22/5 - Chararacter ' causes a problem in javascript:alert()
		CString sActions = "<acronym title=\"" + FilesArray[i].sFileStatus + "\"><a href=\"javascript:alert(\'"+ JSfileinfo+"')\"><img src=\"l_info.gif\" alt=\"" + FilesArray[i].sFileStatus + "\"></a></acronym> ";
d1187 3
a1189 3
				CString sResume="";
				sResume.Format("<acronym title=\"[Resume]\"><a href=\"[Link]\"><img src=\"l_resume.gif\" alt=\"[Resume]\"></a></acronym> ");
				sResume.Replace("[Link]", CString("/?ses=" + sSession + "&w=transfer&op=resume&file=" + FilesArray[i].sFileHash)) ;
d1405 2
a1406 2
		return "";
	if (_ParseURL(Data.sURL, "sort") != "") 
d1408 1
a1408 1
		if(_ParseURL(Data.sURL, "sort") == "name")
d1442 1
a1442 1
		_SetSharedFilePriority(_ParseURL(Data.sURL, "hash"),atoi(_ParseURL(Data.sURL, "setpriority")));
d2064 1
a2064 1
		    theApp.glob_prefs->SetWebPageRefresh(atoi(_ParseURL(Data.sURL, "refresh")));
d2068 2
a2069 2
		    if(atoi(_ParseURL(Data.sURL, "maxdown"))>0)
			    theApp.glob_prefs->SetMaxDownload(atoi(_ParseURL(Data.sURL, "maxdown")));
d2075 2
a2076 2
		    if(atoi(_ParseURL(Data.sURL, "maxup"))>0)
			    theApp.glob_prefs->SetMaxUpload(atoi(_ParseURL(Data.sURL, "maxup")));
d2082 1
a2082 1
		    theApp.glob_prefs->SetMaxGraphDownloadRate(atoi(_ParseURL(Data.sURL, "maxcapdown")));
d2086 1
a2086 1
		    theApp.glob_prefs->SetMaxGraphUploadRate(atoi(_ParseURL(Data.sURL, "maxcapup")));
d2091 1
a2091 1
			theApp.glob_prefs->SetMaxSourcePerFile(atoi(_ParseURL(Data.sURL, "maxsources")));
d2095 1
a2095 1
			theApp.glob_prefs->SetMaxConnections(atoi(_ParseURL(Data.sURL, "maxconnections")));
d2099 1
a2099 1
			theApp.glob_prefs->SetMaxDownloadConperFive(atoi(_ParseURL(Data.sURL, "maxconnectionsperfive")));
d2423 1
a2423 1
	long sessionID=_atoi64(SsessionID);
d2552 1
a2552 1
			if (lastcolor!= atoi(s_ChunkBar.Mid(i,1))  ) {
d2558 1
a2558 1
				lastcolor=atoi(s_ChunkBar.Mid(i,1));
d2607 1
a2607 1
			atoi(_ParseURL(Data.sURL, "avail")),
@


1.49
log
@webserver: connections graph
@
text
@a1063 9
	//SyruS show completed files (0.28b) plus clear completed
	if (IsSessionAdmin(Data,sSession))
	{
		CString sClear;
		sClear.Format("<acronym title=\"[ClearCompleted]\"><a href=\"[Link]\">[DownloadList]</a></acronym> ");
		sClear.Replace("[Link]", CString("/?ses=" + sSession + "&w=transfer&clearcompleted=all"));
		sClear.Replace("[ClearCompleted]", _GetPlainResString(IDS_DL_CLEAR));
		Out.Replace("[DownloadList]", sClear);
	}
@


1.48
log
@Purity's webserver changes. Mostly.
@
text
@d1788 1
a1788 1
	CString sGraphDownload = "", sGraphUpload = "";
d1799 1
d1809 4
d1818 1
d1824 1
d1829 1
a1829 1
	CString s1, s2;
d1832 1
d1837 1
@


1.47
log
@CHANGE: WebServer: extra icon for clearing completed files action [SyruS]
@
text
@d201 20
d704 16
d791 4
d812 1
a812 1

d881 5
d1254 1
@


1.46
log
@Julien webserver changes
@
text
@d1188 1
a1188 1
				sActions.Append("<acronym title=\"[ClearCompleted]\"><a href=\"/?ses=[Session]&amp;w=transfer&clearcompleted=" + FilesArray[i].sFileHash+"\"><img src=\"l_cancel.gif\" alt=\"[ClearCompleted]\"></a></acronym>");
@


1.45
log
@converted to new logger methods
@
text
@a3 1
#include "XBMDraw.h"
a1741 3
	XBMDraw drawUp, drawDown;
	drawUp.CreateImage("image_up", WEB_GRAPH_WIDTH, WEB_GRAPH_HEIGHT);
	drawDown.CreateImage("image_down", WEB_GRAPH_WIDTH, WEB_GRAPH_HEIGHT);
d1743 1
d1747 1
a1747 1
		if(i % 4 == 0)
d1749 1
a1749 1
			for(int j = 1; j < 6; j++)
d1751 2
a1752 2
				drawDown.Plot(i, (WEB_GRAPH_HEIGHT / 6) * j);
				drawUp.Plot(i, (WEB_GRAPH_HEIGHT / 6) * j);
d1754 1
a1754 7
		}
		int nVal;
		if(i < pThis->m_Params.PointsForWeb.GetCount())
		{
			int nI = i;
			if(pThis->m_Params.PointsForWeb.GetCount() < WEB_GRAPH_WIDTH)
				nI = WEB_GRAPH_WIDTH - pThis->m_Params.PointsForWeb.GetCount() + i;
d1756 2
a1757 4
			nVal = (pThis->m_Params.PointsForWeb[i].download * WEB_GRAPH_HEIGHT) / (theApp.glob_prefs->GetMaxGraphDownloadRate() + 4);
			if(nVal > WEB_GRAPH_HEIGHT)
				nVal = WEB_GRAPH_HEIGHT;
			drawDown.Plot(nI, nVal);
a1758 3
			if(i != 0)
				drawDown.Line(nI - 1, nPrevValDown, nI, nVal);
			nPrevValDown = nVal;
d1760 2
a1761 7
			nVal = (pThis->m_Params.PointsForWeb[i].upload * WEB_GRAPH_HEIGHT) / (theApp.glob_prefs->GetMaxGraphUploadRate() + 4);
			if(nVal > WEB_GRAPH_HEIGHT)
				nVal = WEB_GRAPH_HEIGHT;
			drawUp.Plot(nI, nVal);
			if(i != 0)
				drawUp.Line(nI - 1, nPrevValUp, nI, nVal);
			nPrevValUp = nVal;
d1765 2
a1766 3
	CString sUp, sDown;
	drawUp.GetImage(sUp);
	drawDown.GetImage(sDown);
a1767 12
	for (int ix=0;ix<sUp.GetLength()-1;ix++) {
		if (sUp.Mid(ix,2).Compare("0x")==0) {
			if (sUp.GetAt(ix+3)==','||sUp.GetAt(ix+3)==' ') {sUp.Insert(ix+2,'0');ix+=4;}
		}
	}
	for (int ix=0;ix<sDown.GetLength()-1;ix++) {
		if (sDown.Mid(ix,2).Compare("0x")==0) {
			if (sDown.GetAt(ix+3)==','||sDown.GetAt(ix+3)==' ') {sDown.Insert(ix+2,'0');ix+=4;}
		}
	}
	Out.Replace("[GraphDownload]", sDown + drawDown.GetImageTag());
	Out.Replace("[GraphUpload]", sUp + drawUp.GetImageTag());
d1770 3
d1774 1
d1776 3
a1778 2
	sScale.Format("%s %s", _GetPlainResString(IDS_TIME).GetBuffer(0), 
		CastSecondsToHM(theApp.glob_prefs->GetTrafficOMeterInterval() * WEB_GRAPH_WIDTH) );
d1780 1
a1780 4
	CString s1, s2;
	s1.Format("%d " + _GetPlainResString(IDS_KBYTESEC) + ", ", theApp.glob_prefs->GetMaxGraphDownloadRate() + 4);
	s2.Format("%d " + _GetPlainResString(IDS_KBYTESEC) + ", ", theApp.glob_prefs->GetMaxGraphUploadRate() + 4);
	s1 += sScale; s2 += sScale;
@


1.44
log
@WebServer: clear all or single completed files [SyruS]
@
text
@d71 1
a71 1
				AddLogLine(true,GetResString(IDS_WS_ERR_LOADTEMPLATE),sFile);
d127 1
a127 1
			AddLogLine(true,GetResString(IDS_WEB_ERR_CANTLOAD), sFile);
d154 1
a154 1
			AddLogLine(true,GetResString(IDS_WS_ERR_LOADTEMPLATE),sTemplateName);
d156 1
a156 1
			AddDebugLogLine(false,GetResString(IDS_WEB_ERR_CANTLOAD),sTemplateName);
d337 1
a337 1
			AddLogLine(true,GetResString(IDS_WEB_ADMINLOGIN),ses.lSession);
d346 1
a346 1
			AddLogLine(true,GetResString(IDS_WEB_GUESTLOGIN),ses.lSession);
d348 1
a348 1
			AddLogLine(true,GetResString(IDS_WEB_BADLOGINATTEMPT));
d2375 1
a2375 1
			theApp.emuledlg->AddLogLine(true,GetResString(IDS_WEB_SESSIONEND),lSession);
@


1.43
log
@WebServer: show completed files (0.28b) [SuruS]
@
text
@d865 14
d1020 9
d1048 1
a1048 1
	//SuruS show completed files (0.28b)
d1185 1
a1185 1
			if (bCanBeDeleted) {	//SuruS show completed files (0.28b) no prioritychange possible when complete
d1188 3
d2520 1
a2520 1
	//SuruS show completed files (0.28b)
@


1.42
log
@WebServer: added different shades of blue (added by janes bong)
@
text
@d1025 3
d1029 25
a1053 3
	for (POSITION pos=theApp.downloadqueue->filelist.GetHeadPosition();pos != 0;theApp.downloadqueue->filelist.GetNext(pos))
	{
		CPartFile* cur_file =  theApp.downloadqueue->filelist.GetAt(pos);
d1055 2
a1056 21
		DownloadFiles dFile;
		dFile.sFileName = _SpecialChars(cur_file->GetFileName());
		dFile.lFileSize = cur_file->GetFileSize();
		dFile.lFileTransferred = cur_file->GetCompletedSize();
		dFile.fCompleted = cur_file->GetPercentCompleted();
		dFile.lFileSpeed = cur_file->GetDatarate();
		dFile.nFileStatus = cur_file->GetStatus();
		dFile.sFileStatus = cur_file->GetPartfileStatus();
		dFile.nFilePrio = cur_file->GetPriority();
		if (cur_file->IsAutoPrioritized()) dFile.nFilePrio+=10;
		dFile.sFileHash = EncodeBase16(cur_file->GetFileHash(), 16);
		dFile.lSourceCount = cur_file->GetSourceCount();
		dFile.lNotCurrentSourceCount = cur_file->GetNotCurrentSourcesCount();
		dFile.lTransferringSourceCount = cur_file->GetTransferingSrcCount();
		if (theApp.serverconnect->IsConnected() && !theApp.serverconnect->IsLowID())
			dFile.sED2kLink = cur_file->CreateED2kSourceLink();
		else
            dFile.sED2kLink = cur_file->CreateED2kLink();
		dFile.sFileInfo = _SpecialChars(cur_file->GetDownloadFileInfo());

		FilesArray.Add(dFile);
d1162 4
a1165 2
			sActions.Append("<acronym title=\"[PriorityUp]\"><a href=\"/?ses=[Session]&amp;w=transfer&op=prioup&file=" + FilesArray[i].sFileHash+"\"><img src=\"l_up.gif\" alt=\"[PriorityUp]\"></a></acronym>");
			sActions.Append("&nbsp;<acronym title=\"[PriorityDown]\"><a href=\"/?ses=[Session]&amp;w=transfer&op=priodown&file=" + FilesArray[i].sFileHash+"\"><img src=\"l_down.gif\" alt=\"[PriorityDown]\"></a></acronym>");
a2472 1
	cur_file=theApp.downloadqueue->GetFileByID(fileid);
d2475 1
d2478 1
a2478 1
	CString progresscolor[17];	//Ju1i3n - merged with eMulePlus by janes bong
d2494 11
a2504 10
	CString s_ChunkBar=cur_file->GetProgressString(pThis->m_Templates.iProgressbarWidth);

	// and now make a graph out of the array - need to be in a progressive way
	uint8 lastcolor=1;
	uint16 lastindex=0;
	CString temp;
	for (uint16 i=0;i<pThis->m_Templates.iProgressbarWidth;i++) {
		if (lastcolor!= atoi(s_ChunkBar.Mid(i,1))  ) {
			if (i>lastindex) {
				temp.Format(pThis->m_Templates.sProgressbarImgs ,progresscolor[lastcolor],i-lastindex);
d2506 12
a2517 1
				Out+=temp;
a2518 2
			lastcolor=atoi(s_ChunkBar.Mid(i,1));
			lastindex=i;
d2520 5
a2525 6
	temp.Format(pThis->m_Templates.sProgressbarImgs,progresscolor[lastcolor],pThis->m_Templates.iProgressbarWidth-lastindex);
	Out+=temp;
	int compl=(int)((pThis->m_Templates.iProgressbarWidth/100)*cur_file->GetPercentCompleted());
	(compl>0)?temp.Format(pThis->m_Templates.sProgressbarImgsPercent+"<br>",progresscolor[10],compl) :temp.Format(pThis->m_Templates.sProgressbarImgsPercent+"<br>",progresscolor[11],5);	//Ju1i3n - merged with eMulePlus by janes bong
	Out=temp+Out;

@


1.41
log
@code cleanup
@
text
@d2470 1
a2470 1
	CString progresscolor[7];
d2474 11
a2484 4
	progresscolor[3]="blue.gif";
	progresscolor[4]="red.gif";
	progresscolor[5]="greenpercent.gif";
	progresscolor[6]="transparent.gif";
d2506 1
a2506 1
	(compl>0)?temp.Format(pThis->m_Templates.sProgressbarImgsPercent+"<br>",progresscolor[5],compl) :temp.Format(pThis->m_Templates.sProgressbarImgsPercent+"<br>",progresscolor[6],5);
@


1.40
log
@WebServer minifix
@
text
@d1045 1
a1045 1
			dFile.sED2kLink = theApp.CreateED2kSourceLink(cur_file);
d1047 1
a1047 1
            dFile.sED2kLink = theApp.CreateED2kLink(cur_file);
d1497 1
a1497 1
			dFile.sED2kLink = theApp.CreateED2kSourceLink(cur_file);
d1499 1
a1499 1
            dFile.sED2kLink = theApp.CreateED2kLink(cur_file);
@


1.39
log
@Files will be  stopped instead of paused
@
text
@d1134 1
a1134 1
				sPause.Format("<acronym title=\"[Stop]\"><a href=\"[Link]\"><img src=\"red.gif\" alt=\"[Pause]\"></a></acronym> ");
@


1.38
log
@Tooltips improvements
@
text
@d900 1
a900 1
		if(_ParseURL(Data.sURL, "op") == "pause" && IsSessionAdmin(Data,sSession))
d903 1
a903 1
				found_file->PauseFile();
d1134 2
a1135 2
				sPause.Format("<acronym title=\"[Pause]\"><a href=\"[Link]\"><img src=\"l_pause.gif\" alt=\"[Pause]\"></a></acronym> ");
				sPause.Replace("[Link]", CString("/?ses=" + sSession + "&w=transfer&op=pause&file=" + FilesArray[i].sFileHash));
d1153 1
a1153 1
			sActions.Replace("[Pause]", _GetPlainResString(IDS_DL_PAUSE));
@


1.37
log
@BUGFIX for  0000269
@
text
@d1100 2
a1101 2
		JSfileinfo.Replace("\n","\\n");		
		JSfileinfo.Replace("'"," "); // EC 22/5 - Chararacter ' causes a problem in javascript:alert()
d1172 4
a1175 1
		HTTPProcessData.Replace("[FileInfo]", FilesArray[i].sFileInfo);
d2419 1
a2419 1
        sRet.Replace("'", "\\'");
@


1.36
log
@guests cant clear serverinfo log anymore
@
text
@d619 1
a619 1
	// EC 25-12-2003
d1100 2
a1101 1
		JSfileinfo.Replace("\n","\\n");
@


1.35
log
@CServerList moved to use new CSafe array , suppouse to work faster , safer  and to be the step to the virtual list controls .
@
text
@d1913 1
a1913 1
	if (_ParseURL(Data.sURL, "clear") == "yes")
@


1.34
log
@documents search and 'NOT' search filter
@
text
@d760 1
d776 1
@


1.33
log
@Added Turkish Language
@
text
@d1860 1
d2559 1
@


1.32
log
@Renamed ed2k column to actions (Web Server)
@
text
@d2438 1
@


1.31
log
@changes in templates
@
text
@d1465 1
a1465 1
	Out.Replace("[Ed2klink]", _GetPlainResString(IDS_SW_LINK));
@


1.30
log
@fixes by BavarianSnail/obaldin/kuchin. see changelog+
@
text
@a97 1
			m_Templates.sDownloadLink = _LoadTemplate(sAll,"TMPL_DOWNLOAD_LINK");
a366 5
		if (sPage == "download") 
		{
			Out += _GetDownloadLink(Data);
		}
		else
a578 1
	Out.Replace("[Download]", _GetPlainResString(IDS_SW_LINK));
d587 3
a1312 30
	Out.Replace("[Session]", sSession);

	return Out;

	EMULE_CATCH

	return "";
}

CString CWebServer::_GetDownloadLink(ThreadData Data)
{
	EMULE_TRY

	CWebServer *pThis = (CWebServer *)Data.pThis;
	if(pThis == NULL)
		return "";

	CString sSession = _ParseURL(Data.sURL, "ses");

	if (!IsSessionAdmin(Data,sSession)) {
		CString ad="<br><br><div align=\"center\" class=\"message\">[Message]</div>";
		ad.Replace("[Message]",_GetPlainResString(IDS_ACCESSDENIED));
		return ad;
	}

	CString Out = pThis->m_Templates.sDownloadLink;

	Out.Replace("[Download]", _GetPlainResString(IDS_SW_DOWNLOAD));
	Out.Replace("[Ed2klink]", _GetPlainResString(IDS_SW_LINK));
	Out.Replace("[Start]", _GetPlainResString(IDS_SW_START));
@


1.29
log
@Enabled caching for images
@
text
@d1011 2
a1012 2
	Out.Replace("[Transferred]", _GetPlainResString(IDS_DL_TRANSF));
	Out.Replace("[Progress]", _GetPlainResString(IDS_SF_COMPLETED));
d1035 1
a1035 1
		dFile.lFileTransferred = cur_file->GetTransfered();
@


1.28
log
@Upgrade to 0.28a
@
text
@d33 3
d44 7
d268 4
d280 2
@


1.27
log
@WebServer: update to template and solved another filename issue in the Upload Queue
@
text
@d60 1
a60 1
			if(theApp.glob_prefs->GetHTTPIsEnabled() || m_bServerWorking)
d65 1
a65 1
			theApp.glob_prefs->SetHTTPIsEnabled(false);
d121 1
a121 1
			theApp.glob_prefs->SetHTTPIsEnabled(false);
d165 2
a166 3

	if(m_bServerWorking != theApp.glob_prefs->GetHTTPIsEnabled())
		m_bServerWorking = theApp.glob_prefs->GetHTTPIsEnabled();
d176 1
a176 1
	if(theApp.glob_prefs->GetHTTPIsEnabled() && m_bServerWorking)
d315 1
a315 1
		if(MD5Sum(_ParseURL(Data.sURL, "p")).GetHash() == theApp.glob_prefs->GetHTTPPass())
d324 1
a324 1
		else if(theApp.glob_prefs->GetHTTPLowPass()!="" && MD5Sum(_ParseURL(Data.sURL, "p")).GetHash() == theApp.glob_prefs->GetHTTPLowPass())
@


1.26
log
@Fixes
@
text
@d1281 3
a1283 2
			if (cur_client->reqfile)
				HTTPProcessData.Replace("[FileName]", _SpecialChars(cur_client->reqfile->GetFileName()));
@


1.25
log
@Upgrade to webserver official 0.28a
@
text
@d185 1
a185 1
void CWebServer::_RemoveServer(CString sIP)
d189 1
a189 1
	CServer* server=theApp.serverlist->GetServerByAddress(sIP.GetBuffer() ,0);
d246 1
a246 1
void CWebServer::_ConnectToServer(CString sIP)
d250 1
a250 1
	CServer* server=theApp.serverlist->GetServerByAddress(sIP.GetBuffer(),0);
d657 1
d661 1
a661 1
			_ConnectToServer(sIP);
d670 1
d672 1
a672 1
			_RemoveServer(sIP);
d826 3
a828 2
		HTTPProcessData.Replace("[6]", IsSessionAdmin(Data,sSession)? CString("/?ses=" + sSession + "&w=server&c=connect&ip=" + ServerArray[i].sServerIP):GetPermissionDenied());
		HTTPProcessData.Replace("[LinkRemove]", IsSessionAdmin(Data,sSession)?CString("/?ses=" + sSession + "&w=server&c=remove&ip=" + ServerArray[i].sServerIP):GetPermissionDenied());
d2031 2
a2032 2
		    else
			    theApp.glob_prefs->SetMaxDownload(65535);
d2038 2
a2039 2
		    else
			    theApp.glob_prefs->SetMaxUpload(65535);
@


1.24
log
@Webserver from official 0.27c
@
text
@d15 2
a16 2
#define HTTPInit "Server: eMule\r\nPragma: no-cache\r\nExpires: 0\r\nCache-Control: no-cache, no-store, must-revalidate\r\nConnection: close\r\nContent-Type: text/html\r\n"
#define HTTPInitGZ "Server: eMule\r\nPragma: no-cache\r\nExpires: 0\r\nCache-Control: no-cache, no-store, must-revalidate\r\nConnection: close\r\nContent-Type: text/html\r\nContent-Encoding: gzip\r\n"
d18 1
a18 1
#define WEB_SERVER_TEMPLATES_VERSION	2
d102 1
d104 9
a112 1
			m_Templates.sResDir = _LoadTemplate(sAll,"RESSOURCES_PATH");			
d143 1
a143 4
	}

	if(sRet.IsEmpty())
	{
d146 2
a147 1
		AddDebugLogLine(false,GetResString(IDS_WEB_ERR_CANTLOAD),sTemplateName);
d156 6
a166 1
	{
a167 1
	}
d173 1
a174 1
		ReloadTemplates();
d256 28
d301 1
a301 1
	long gzipLen;
d305 1
a305 1
	char	HTTPTempC[100] = "";
d373 5
d457 20
d578 2
d810 1
a848 1
	CString HTTPTemp;
d851 4
a854 2
		HTTPTemp = _ParseURL(Data.sURL, "c");
		if (HTTPTemp.Right(1) != "/")
d874 1
d899 24
d1002 1
d1018 1
d1022 2
d1060 2
a1061 14
				{
					int nPercent1 = 0, nPercent2 = 0;
					if(FilesArray[i].lFileSize > 0)
					{
						float fS = FilesArray[i].lFileSize, fT = FilesArray[i].lFileTransferred;
						nPercent1 = abs((fT * 100.0) / fS);
					}
					if(FilesArray[i+1].lFileSize > 0)
					{
						float fS = FilesArray[i+1].lFileSize, fT = FilesArray[i+1].lFileTransferred;
						nPercent2 = abs((fT * 100.0) / fS);
					}
					bSwap = nPercent1 < nPercent2;
				}
d1079 2
d1085 1
a1085 1
		CString sActions = "<acronym title=\"" + FilesArray[i].sFileStatus + "\"><a href=\"javascript:alert(\'"+ JSfileinfo+"')\"><img src=\"javascript:img_info\" alt=\"" + FilesArray[i].sFileStatus + "\"></a></acronym> ";
d1088 1
a1088 1
		sED2kLink.Format("<acronym title=\"[Ed2klink]\"><a href=\""+ FilesArray[i].sED2kLink +"\"><img src=\"javascript:img_link\" alt=\"[Ed2klink]\"></a></acronym> ");
d1105 6
a1110 6
			CString sResume;
			sResume.Format("<acronym title=\"[Resume]\"><a href=\"[Link]\"><img src=\"javascript:img_resume\" alt=\"[Resume]\"></a></acronym> ");
			
			sResume.Replace("[Link]", IsSessionAdmin(Data,sSession)?CString("/?ses=" + sSession + "&w=transfer&op=resume&file=" + FilesArray[i].sFileHash):GetPermissionDenied()) ;
			
			sActions += sResume;
d1115 6
a1120 4
			CString sPause;
			sPause.Format("<acronym title=\"[Pause]\"><a href=\"[Link]\"><img src=\"javascript:img_pause\" alt=\"[Pause]\"></a></acronym> ");
			sPause.Replace("[Link]", IsSessionAdmin(Data,sSession)?CString("/?ses=" + sSession + "&w=transfer&op=pause&file=" + FilesArray[i].sFileHash):GetPermissionDenied());
			sActions += sPause;
d1126 16
a1141 9
			CString sCancel;
			sCancel.Format("<acronym title=\"[Cancel]\"><a href=\"[Link]\" onclick=\"return confirm(\'[ConfirmCancel]\')\"><img src=\"javascript:img_cancel\" alt=\"[Cancel]\"></a></acronym> ");
			sCancel.Replace("[Link]", IsSessionAdmin(Data,sSession)?CString("/?ses=" + sSession + "&w=transfer&op=cancel&file=" + FilesArray[i].sFileHash):GetPermissionDenied());
			sActions += sCancel;
		}
		sActions.Replace("[Resume]", _GetPlainResString(IDS_DL_RESUME));
		sActions.Replace("[Pause]", _GetPlainResString(IDS_DL_PAUSE));
		sActions.Replace("[Cancel]", _GetPlainResString(IDS_MAIN_BTN_CANCEL));
		sActions.Replace("[ConfirmCancel]", _GetPlainResString(IDS_Q_CANCELDL2, true));
d1183 1
a1183 1
			HTTPTemp.Format("%8i/%8i (%i)",
d1193 12
d1211 2
a1212 1
	
d1251 1
d1317 6
a1322 1
	if (!IsSessionAdmin(Data,sSession)) return "";
a1632 1

d1657 1
a1657 1
		uint8 upperpriority, lesserpriority;
a1869 1
	Out.Replace("[WebSearch]", _GetPlainResString(IDS_SW_WEBBASED));
d1877 1
d1885 1
d1898 1
a1898 1
	if (_ParseURL(Data.sURL, "clear") == "yes")
d1952 1
a1952 1
	if (_ParseURL(Data.sURL, "clear") == "yes")
d2004 1
a2004 1
		if(_ParseURL(Data.sURL, "gzip") == "true" || _ParseURL(Data.sURL, "gzip") == "on")
d2012 1
a2012 1
		if(_ParseURL(Data.sURL, "showuploadqueue") == "true" || _ParseURL(Data.sURL, "showuploadqueue") == "on" )
d2060 2
a2061 2
		theApp.glob_prefs->SetTransferFullChunks((_ParseURL(Data.sURL, "fullchunks") == "on"));
		theApp.glob_prefs->SetPreviewPrio((_ParseURL(Data.sURL, "firstandlast") == "on"));
d2306 2
a2307 9
	// remove expired sessions
	for(int i = 0; i < pThis->m_Params.Sessions.GetSize();)
	{
		CTimeSpan ts = CTime::GetCurrentTime() - pThis->m_Params.Sessions[i].startTime;
		if(ts.GetTotalSeconds() > SESSION_TIMEOUT_SECS)
			pThis->m_Params.Sessions.RemoveAt(i);
		else
			i++;
	}
d2325 10
a2473 6
	CString resPath=pThis->m_Templates.sResDir;
	if (resPath=="" && PathFileExists(CString(theApp.glob_prefs->GetAppDir()) +"res\\black.gif")) {
		resPath.Format("file://%sres/",theApp.glob_prefs->GetAppDir());
		resPath.Replace('\\','/');
	}
	
d2475 23
a2497 14
	// simple style if ressources cant be found
	if (resPath=="") {
		XBMDraw bar;
		int proc=cur_file->GetPercentCompleted();
		if (proc<0) proc=0; if (proc>100) proc=100;
		int size=((float)proc/(float)100)*(pThis->m_Templates.iProgressbarWidth);
		if (proc>0) bar.CreateImage("img_progressbar", size, 10,255);
			else bar.CreateImage("img_progressbar", 8, 10,0);

		CString sBar;
		bar.GetImage(sBar);
		for (int ix=0;ix<sBar.GetLength()-1;ix++) {
			if (sBar.Mid(ix,2).Compare("0x")==0) {
				if (sBar.GetAt(ix+3)==','||sBar.GetAt(ix+3)==' ') {sBar.Insert(ix+2,'0');ix+=4;}
d2499 2
d2502 18
a2519 1
		Out.Format("%s\n<img src=\"javascript:img_progressbar\">",sBar);
d2521 15
a2535 26
	// cool style
	} else {
		CString progresscolor[7];
		progresscolor[0]="green.gif";
		progresscolor[1]="black.gif";
		progresscolor[2]="yellow.gif";
		progresscolor[3]="blue.gif";
		progresscolor[4]="red.gif";
		progresscolor[5]="greenpercent.gif";
		progresscolor[6]="transparent.gif";

		CString s_ChunkBar=cur_file->GetProgressString(pThis->m_Templates.iProgressbarWidth);

		// and now make a graph out of the array - need to be in a progressive way
		uint8 lastcolor=1;
		uint16 lastindex=0;
		CString temp;
		for (uint16 i=0;i<pThis->m_Templates.iProgressbarWidth;i++) {
			if (lastcolor!= atoi(s_ChunkBar.Mid(i,1))  ) {
				if (i>lastindex) {
					temp.Format("<img src=\"%s%s\" height=10 width=%i>",resPath,progresscolor[lastcolor],i-lastindex);
					Out+=temp;
				}
				lastcolor=atoi(s_ChunkBar.Mid(i,1));
				lastindex=i;
			}
a2536 5
		temp.Format("<img src=\"%s%s\" height=10 width=%i>",resPath,progresscolor[lastcolor],pThis->m_Templates.iProgressbarWidth-lastindex);
		Out+=temp;
		int compl=(int)((pThis->m_Templates.iProgressbarWidth/100)*cur_file->GetPercentCompleted());
		(compl>0)?temp.Format("<img src=\"%s%s\" height=3 width=%i><br>",resPath,progresscolor[5],compl) :temp.Format("<img src=\"%s%s\" height=3 width=5><br>",resPath,progresscolor[6]);
		Out=temp+Out;
d2538 51
d2590 23
d2614 1
@


1.23
log
@Bugfixed some bugs ;)
@
text
@a14 1

d18 1
a18 1
#define WEB_SERVER_TEMPLATES_VERSION	1
d34 1
a34 13

	srand((unsigned)time(NULL));

	EMULE_TRY

	//m_bServerWorking = theApp.glob_prefs->GetHTTPIsEnabled();
	m_bServerWorking = false;	//Cax2 - this enables webserver  notification at startup

	//ReloadTemplates(); //EC - No need to load templates here.They will be loaded in StartServer()

	//StartSockets(this); // EC - No need to start sockets here. They will be started in StartServer()

	EMULE_CATCH
d61 1
a61 2
			AddLogLine(true,"Can't load templates: replace file " + sFile + " with a newer version!");
			//EC -  No need for webserver to run if there's nothing to show
a65 1
			//EC - ends
d102 2
d109 1
a109 2
			AddLogLine(true,"Can't load templates: Can't open file " + sFile);
			//EC -  No need for webserver to run if there's nothing to show
a112 1
			//EC - ends
d120 1
a120 2
	if (m_bServerWorking) // EC
		 StopSockets();
d139 2
a140 2
			AddLogLine(true,"Can't find template version number!\nPlease replace eMule.tmpl with a newer version!");
			AddDebugLogLine(false,"Failed to load template " + sTemplateName);
a148 10
void CWebServer::RestartServer()	//Cax2 - restarts the server with the new port settings
{
	// StopSockets();  //EC - Why stop sockets if they havent start
	if (m_bServerWorking)	
	{
		StopSockets(); //EC - Stop sockets if they have been started
		StartSockets(this);
	}
}

d154 3
a156 8
		{
			m_bServerWorking = theApp.glob_prefs->GetHTTPIsEnabled();
			//EC Starts
			//RestartServer(); 
			StartSockets(this); 
			ReloadTemplates();
			//EC Ends
		}
d160 7
a166 1
	if(theApp.glob_prefs->GetHTTPIsEnabled() && m_bServerWorking) // EC
d178 2
a179 9
	for (POSITION pos=theApp.serverlist->list.GetHeadPosition();pos != 0;theApp.serverlist->list.GetNext(pos))
	{
		CServer* cur_server =  theApp.serverlist->list.GetAt(pos);
		if( sIP == CString(cur_server->GetAddress()))
		{
			theApp.emuledlg->SendMessage(WEB_REMOVE_SERVER, (WPARAM)cur_server, NULL);
			break;
		}
	}
d182 1
a183 1
}
d188 14
a201 1
	for (POSITION pos = theApp.sharedfiles->m_Files_map.GetStartPosition();pos != 0;)
d203 2
a204 20
		CCKey bufKey;
		CKnownFile* cur_file;
		theApp.sharedfiles->m_Files_map.GetNextAssoc(pos,bufKey,cur_file);
		CString cur_hash;
		cur_hash = _GetStringHash(cur_file->GetFileHash());
		if(cur_hash==hash)
		{
			if(priority >= 0 && priority < 5)
			{
				cur_file->SetPriority(priority);
				break;
			}
			else
			if(priority == 5 && cur_file->IsPartFile())
			{
				cur_file->SetAutoPriority(true);
				cur_file->UpdateUploadAutoPriority(); 
				break;
			}
		}
a207 1

a234 5
void CWebServer::SetUserCount(uint32 nUsers)
{
	m_Params.nUsers = nUsers;
}

d239 2
a240 9
	for (POSITION pos=theApp.serverlist->list.GetHeadPosition();pos != 0;theApp.serverlist->list.GetNext(pos))
	{
		CServer* cur_file =  theApp.serverlist->list.GetAt(pos);
		if(sIP == CString(cur_file->GetAddress()))
		{
			theApp.emuledlg->SendMessage(WEB_CONNECT_TO_SERVER, (WPARAM)cur_file, NULL);
			break;
		}
	}
d253 1
a253 4
	if ( theApp.glob_prefs->IsNTBased() )
	{
		SetThreadLocale(theApp.glob_prefs->GetLanguageID());
	}
d267 1
a267 1
	CString Password = theApp.glob_prefs->GetHTTPPass();
d275 3
a277 1
		if(MD5Sum(_ParseURL(Data.sURL, "p")).GetHash() == Password)
d280 1
d282 1
a282 2
			long l1 = rand(), l2 = rand();
			ses.lSession = lSession = l1 * 10000L + l2;
d284 12
d499 1
a499 1
	Out.Replace("[eMulePlus]", _GetPlainResString(IDS_EMULE_PLUS));
d526 1
a526 1
		sprintf(HTTPTempC, "%i ", pThis->m_Params.nUsers);
d537 1
d539 1
a539 1
	Out.Replace("[Connected]", sConnected);
d551 1
a551 1
	Out.Replace("[Speed]", " ( " + CString(HTTPTempC) + " | " + _GetPlainResString(IDS_PW_CON_LIMIT) + ": " + sLimits + " )");
d588 1
a588 1
	if (sCmd == "connect")
d596 1
a596 1
	else if (sCmd == "disconnect") 
d600 1
a600 1
	else if (sCmd == "remove") 
d682 1
a682 1
	for (POSITION pos=theApp.serverlist->list.GetHeadPosition();pos != 0;theApp.serverlist->list.GetNext(pos))
d684 1
a684 1
		CServer* cur_file =  theApp.serverlist->list.GetAt(pos);
d757 2
a758 2
		HTTPProcessData.Replace("[6]", "/?ses=" + sSession + "&w=server&c=connect&ip=" + ServerArray[i].sServerIP);
		HTTPProcessData.Replace("[LinkRemove]", "/?ses=" + sSession + "&w=server&c=remove&ip=" + ServerArray[i].sServerIP);
d782 2
a783 1
	if (_ParseURL(Data.sURL, "c") != "") 
d785 1
a785 1
		CString HTTPTemp = _ParseURL(Data.sURL, "c");
d815 1
a815 1
		if(_ParseURL(Data.sURL, "op") == "pause")
d820 1
a820 1
		else if(_ParseURL(Data.sURL, "op") == "resume")
d825 1
a825 1
		else if(_ParseURL(Data.sURL, "op") == "cancel")
d896 1
d901 1
a901 1
	Out.Replace("[Percent]", _GetPlainResString(IDS_SF_COMPLETED));
d927 1
a927 1
		dFile.sFileHash = _GetStringHash(cur_file->GetFileHash());
d935 1
a935 1
		dFile.sFileInfo = _SpecialChars(theApp.emuledlg->transferwnd.GetDownloadFileInfo(cur_file));
d996 3
a998 1
		CString sActions = "<acronym title=\"" + FilesArray[i].sFileStatus + "\"><a href=\"javascript:alert(\'Here will be file info and options like rename\')\"><img src=\"javascript:img_info\" alt=\"" + FilesArray[i].sFileStatus + "\"></a></acronym> ";
d1020 3
a1022 1
			sResume.Replace("[Link]", "/?ses=" + sSession + "&w=transfer&op=resume&file=" + FilesArray[i].sFileHash);
d1030 1
a1030 1
			sPause.Replace("[Link]", "/?ses=" + sSession + "&w=transfer&op=pause&file=" + FilesArray[i].sFileHash);
d1039 1
a1039 1
			sCancel.Replace("[Link]", "/?ses=" + sSession + "&w=transfer&op=cancel&file=" + FilesArray[i].sFileHash);
d1058 1
d1063 1
a1063 4
		char HTTPTempC[100] = "";
		sprintf(HTTPTempC, "%8.2f ", FilesArray[i].lFileSize/1048576.0);
		CString HTTPTemp = HTTPTempC + _GetPlainResString(IDS_MBYTES);
		HTTPProcessData.Replace("[2]", HTTPTemp);
d1069 1
a1069 3
			sprintf(HTTPTempC, "%8.2f ", FilesArray[i].lFileTransferred/1048576.0);
			HTTPTemp = HTTPTempC + _GetPlainResString(IDS_MBYTES);												
			HTTPProcessData.Replace("[3]", HTTPTemp);
d1074 1
a1074 8
		int nPercent = 0;
		if(FilesArray[i].lFileSize > 0)
		{
			float fS = FilesArray[i].lFileSize, fT = FilesArray[i].lFileTransferred;
			nPercent = abs((fT * 100.0) / fS);
		}
		sprintf(HTTPTempC, "%d", nPercent);
		HTTPProcessData.Replace("[Percent]", CString(HTTPTempC));
d1080 1
a1080 2
			sprintf(HTTPTempC, "%8.2f ", FilesArray[i].lFileSpeed/1024.0);
			HTTPTemp = HTTPTempC + _GetPlainResString(IDS_KBYTESEC);												
d1087 6
a1092 7
		sprintf(HTTPTempC, "%8i/%8i (%i)",
			FilesArray[i].lSourceCount-FilesArray[i].lNotCurrentSourceCount,
			FilesArray[i].lSourceCount,
			FilesArray[i].lTransferringSourceCount
		);
		HTTPTemp = HTTPTempC;
		HTTPProcessData.Replace("[5]", HTTPTemp);
d1103 7
a1109 10
	CString sT;
	sT.Format("%8.0f ", fTotalSize/1048576.0);
	sT += _GetPlainResString(IDS_MBYTES);
	Out.Replace("[TotalDownSize]", sT);
	sT.Format("%8.0f ", fTotalTransferred/1048576.0);
	sT += _GetPlainResString(IDS_MBYTES);
	Out.Replace("[TotalDownTransferred]", sT);
	sT.Format("%8.2f ", fTotalSpeed/1024.0);
	sT += _GetPlainResString(IDS_KBYTESEC);
	Out.Replace("[TotalDownSpeed]", sT);
d1112 3
d1125 1
a1125 1
		HTTPProcessData.Replace("[FileInfo]", _SpecialChars(theApp.emuledlg->transferwnd.GetUploadFileInfo(cur_client)));
d1136 1
a1136 2
		HTTPTemp.Format("%8.2f " + _GetPlainResString(IDS_MBYTES) + " / %8.2f " + _GetPlainResString(IDS_MBYTES), 
			cur_client->GetTransferedDown()/1048576.0, cur_client->GetTransferedUp()/1048576.0);
d1145 4
a1148 5
	sT.Format("%8.2f " + _GetPlainResString(IDS_MBYTES) + " / %8.2f " + _GetPlainResString(IDS_MBYTES),
		fTotalSize/1048576.0, fTotalTransferred/1048576.0);
	Out.Replace("[TotalUpTransferred]", sT);
	sT.Format("%8.2f " + _GetPlainResString(IDS_KBYTESEC), fTotalSpeed/1024.0);
	Out.Replace("[TotalUpSpeed]", sT);
d1207 1
d1265 1
a1265 1
	if(_ParseURL(Data.sURL, "hash") != "" && _ParseURL(Data.sURL, "setpriority") != "") 
d1402 1
a1402 1
		dFile.sFileHash = _GetStringHash(cur_file->GetFileHash());
d1516 1
a1516 1
		sprintf(HTTPTempC, "%4.2f " + _GetPlainResString(IDS_MBYTES), SharedArray[i].lFileSize/1048576.0);
d1521 1
a1521 1
		sprintf(HTTPTempC, "%4.2f " + _GetPlainResString(IDS_MBYTES), SharedArray[i].nFileTransferred/1048576.0);
d1524 1
a1524 1
		sprintf(HTTPTempC, "%4.2f " + _GetPlainResString(IDS_MBYTES), SharedArray[i].nFileAllTimeTransferred/1048576.0);
d1573 4
d1630 1
d1644 1
d1648 11
d1664 4
a1667 8
	int nTime = theApp.glob_prefs->GetTrafficOMeterInterval() * WEB_GRAPH_WIDTH;
	int nHour = nTime / 3600;
	int nMin = (nTime / 60) % 60;
	int nSec = nTime % 60;
	if(nHour > 0)
		sScale.Format("%s %d:%02d %s", _GetPlainResString(IDS_TIME).GetBuffer(0), nHour, nMin, _GetPlainResString(IDS_HOURS).GetBuffer(0));
	else
		sScale.Format("%s %02d:%02d %s", _GetPlainResString(IDS_TIME).GetBuffer(0), nMin, nSec, _GetPlainResString(IDS_MINS).GetBuffer(0));
d1692 2
d1706 5
a1710 10
//			if (!theApp.glob_prefs->adresses_list.IsEmpty())
			{
				theApp.emuledlg->serverwnd.UpdateServerMetFromURL(_ParseURL(Data.sURL, "servermeturl"));
				CString resultlog = _SpecialChars(theApp.emuledlg->logtext);
				resultlog = resultlog.TrimRight('\n');
				resultlog = resultlog.Mid(resultlog.ReverseFind('\n'));
				Out.Replace("[Message]",resultlog);
			}
//			else
//               Out.Replace("[Message]",_GetPlainResString(IDS_ERR_EMPTYADRESSESDAT));
d1888 59
a1946 3
	if(_ParseURL(Data.sURL, "gzip") == "true")
	{
		theApp.glob_prefs->SetWebUseGzip(true);
d1948 3
a1950 1
	if(_ParseURL(Data.sURL, "gzip") == "false")
d1952 1
a1952 1
		theApp.glob_prefs->SetWebUseGzip(false);
d1954 1
a1954 1
	if(_ParseURL(Data.sURL, "showuploadqueue") == "true")
d1956 1
a1956 1
		pThis->m_Params.bShowUploadQueue = true;
d1958 1
a1958 1
	if(_ParseURL(Data.sURL, "showuploadqueue") == "false")
d1960 1
a1960 1
		pThis->m_Params.bShowUploadQueue = false;
d1962 1
a1962 1
	if(_ParseURL(Data.sURL, "refresh") != "")
d1964 1
a1964 1
		theApp.glob_prefs->SetWebPageRefresh(atoi(_ParseURL(Data.sURL, "refresh")));
d1966 1
a1966 1
	if(_ParseURL(Data.sURL, "maxdown") != "")
d1968 1
a1968 25
		if(atoi(_ParseURL(Data.sURL, "maxdown"))>0)
			theApp.glob_prefs->SetMaxDownload(atoi(_ParseURL(Data.sURL, "maxdown")));
		else
			theApp.glob_prefs->SetMaxDownload(65535);
	}
	if(_ParseURL(Data.sURL, "maxup") != "")
	{
		if(atoi(_ParseURL(Data.sURL, "maxup"))>0)
			theApp.glob_prefs->SetMaxUpload(atoi(_ParseURL(Data.sURL, "maxup")));
		else
			theApp.glob_prefs->SetMaxUpload(65535);
	}
	if(_ParseURL(Data.sURL, "maxcapdown") != "")
	{
		theApp.glob_prefs->SetMaxGraphDownloadRate(atoi(_ParseURL(Data.sURL, "maxcapdown")));
	}
	if(_ParseURL(Data.sURL, "maxcapup") != "")
	{
		theApp.glob_prefs->SetMaxGraphUploadRate(atoi(_ParseURL(Data.sURL, "maxcapup")));
	}

	if(theApp.glob_prefs->GetWebUseGzip())
	{
		Out.Replace("[UseGzipVal]", "checked");
		Out.Replace("[NotUseGzipVal]", "");
d1972 1
a1972 2
		Out.Replace("[UseGzipVal]", "");
		Out.Replace("[NotUseGzipVal]", "checked");
d1974 1
a1974 1
    if(pThis->m_Params.bShowUploadQueue)
d1976 1
a1976 2
		Out.Replace("[ShowUploadQueueVal]", "checked");
		Out.Replace("[HideUploadQueueVal]", "");
d1980 1
a1980 2
		Out.Replace("[ShowUploadQueueVal]", "");
		Out.Replace("[HideUploadQueueVal]", "checked");
d1982 20
a2003 2
	Out.Replace("[UseGzip]", _GetPlainResString(IDS_USE));
	Out.Replace("[NotUseGzip]", _GetPlainResString(IDS_DONT_USE));
d2006 2
a2007 4
	Out.Replace("[ShowUploadQueue]", _GetPlainResString(IDS_SHOW));
	Out.Replace("[HideUploadQueue]", _GetPlainResString(IDS_HIDE));
	CString sRefresh; sRefresh.Format("%d", theApp.glob_prefs->GetWebPageRefresh());
	Out.Replace("[RefreshVal]", sRefresh);
d2016 4
d2021 1
d2058 1
a2058 1
	Out.Replace("[eMulePlus]", _GetPlainResString(IDS_EMULE_PLUS));
d2063 1
d2090 2
a2091 2
	OutS.Replace("[URL_Disconnect]", "/?ses=" + sSession + "&w=server&c=disconnect");
	OutS.Replace("[URL_Connect]", "/?ses=" + sSession + "&w=server&c=connect");
d2094 2
a2095 2
	OutS.Replace("[URL_ServerOptions]", "/?ses=" + sSession + "&w=server&c=options");
	OutS.Replace("[ServerOptions]", _GetPlainResString(IDS_EM_PREFS));
d2107 1
a2107 1
		sprintf(HTTPTempC, "%10i", pThis->m_Params.nUsers);
d2231 1
d2241 1
a2241 3

CString CWebServer::_GetStringHash(uchar* hash)
{
d2243 7
a2249 6

	CString sFileHash; CString sHashByte;
	for (uint16 i = 0; i < 16; i++)
	{
		sHashByte.Format("%02x", hash[i]);
		sFileHash += sHashByte;
a2250 1
	return sFileHash;
d2254 24
a2277 1
	return "";
d2342 73
@


1.22
log
@removed duplicated code
@
text
@d43 1
a43 1
	ReloadTemplates();
d45 1
a45 1
	StartSockets(this);
d73 1
a73 1
			if(m_bServerWorking)
d75 6
d121 8
a128 1
		AddLogLine(true,"Can't load templates: Can't open file " + sFile);
d135 2
a136 1
	StopSockets();
d167 1
a167 1
	StopSockets();
d169 2
d172 1
d182 5
a186 1
			RestartServer();
d191 1
a191 1
	if(theApp.glob_prefs->GetHTTPIsEnabled())
@


1.22.2.1
log
@27a partial merge
@
text
@d1151 1
a1151 1
		CKnownFile* file = theApp.sharedfiles->GetFileByID(cur_client->GetUploadFileID());
@


1.22.2.2
log
@27c
@
text
@d43 1
a43 1
	//ReloadTemplates(); //EC - No need to load templates here.They will be loaded in StartServer()
d45 1
a45 1
	//StartSockets(this); // EC - No need to start sockets here. They will be started in StartServer()
d73 1
a73 1
			if(theApp.glob_prefs->GetHTTPIsEnabled() || m_bServerWorking)
a74 6
			//EC -  No need for webserver to run if there's nothing to show
			if (m_bServerWorking)
				StopSockets(); 
            m_bServerWorking = false; 
			theApp.glob_prefs->SetHTTPIsEnabled(false);
			//EC - ends
d115 1
a115 8
		{
			AddLogLine(true,"Can't load templates: Can't open file " + sFile);
			//EC -  No need for webserver to run if there's nothing to show
			StopSockets(); 
            m_bServerWorking = false; 
			theApp.glob_prefs->SetHTTPIsEnabled(false);
			//EC - ends
		}
d122 1
a122 2
	if (m_bServerWorking) // EC
		 StopSockets();
d153 1
a153 1
	// StopSockets();  //EC - Why stop sockets if they havent start
a154 2
	{
		StopSockets(); //EC - Stop sockets if they have been started
a155 1
	}
d165 1
a165 5
			//EC Starts
			//RestartServer(); 
			StartSockets(this); 
			ReloadTemplates();
			//EC Ends
d170 1
a170 1
	if(theApp.glob_prefs->GetHTTPIsEnabled() && m_bServerWorking) // EC
@


1.21
log
@webserver port can be changed without restarting, & bugfix for #143
@
text
@d829 2
a830 20
		CPartFile* found_file = NULL;
		for (POSITION pos=theApp.downloadqueue->filelist.GetHeadPosition();pos != 0;theApp.downloadqueue->filelist.GetNext(pos))
		{
			CPartFile* cur_file =  theApp.downloadqueue->filelist.GetAt(pos);
			bool bGood = true;
			for(int i = 0; i < 16; i++)
			{
				if(cur_file->GetFileHash()[i] != FileHash[i])
				{
					bGood = false;
					break;
				}
			}
			if(bGood)
			{
				found_file = cur_file;
				break;
			}
		}

@


1.20
log
@converted to new logging method
@
text
@d40 2
a41 1
	m_bServerWorking = theApp.glob_prefs->GetHTTPIsEnabled();
d151 7
d163 4
a166 1
		m_bServerWorking = theApp.glob_prefs->GetHTTPIsEnabled();
@


1.19
log
@sETtHREADlOCALE DOES NOT WORK ON NON-nt (WIN9X) BASED SYSTEMS
@
text
@d73 1
a73 1
			theApp.emuledlg->AddLogLine(true,"Can't load templates: replace file " + sFile + " with a newer version!");
d114 1
a114 1
		theApp.emuledlg->AddLogLine(true,"Can't load templates: Can't open file " + sFile);
d140 2
a141 2
			theApp.emuledlg->AddLogLine(true,"Can't find template version number!\nPlease replace eMule.tmpl with a newer version!");
			theApp.emuledlg->AddDebugLogLine(false,"Failed to load template " + sTemplateName);
d160 1
a160 1
		theApp.emuledlg->AddLogLine(false,"%s: %s",_GetPlainResString(IDS_PW_HTTPD), _GetPlainResString(IDS_ENABLED).MakeLower());
d162 1
a162 1
		theApp.emuledlg->AddLogLine(false,"%s: %s",_GetPlainResString(IDS_PW_HTTPD), _GetPlainResString(IDS_DISABLED).MakeLower());
@


1.18
log
@Added Romanian Language
@
text
@d271 4
a274 1
	SetThreadLocale(theApp.glob_prefs->GetLanguageID());
@


1.17
log
@Added Lithuanian Language
@
text
@d2278 1
@


1.16
log
@Reload templates in runtime feature
@
text
@d2277 1
@


1.15
log
@Sorting by progress
@
text
@d42 11
a114 2

	StartSockets(this);
@


1.14
log
@Small webserver fixes
@
text
@d855 3
d903 4
d972 15
@


1.13
log
@minor updates & bugfixes
@
text
@d40 2
d61 1
a61 1
			if(theApp.glob_prefs->GetHTTPIsEnabled())
d102 1
a102 1
        if(theApp.glob_prefs->GetHTTPIsEnabled())
d145 5
d1849 3
@


1.12
log
@Rewrite of statistics tree + full export to webserver
@
text
@d128 3
a130 2
		theApp.emuledlg->AddLogLine(true,"Can't find template version number!\nPlease replace eMule.tmpl with a newer version!");
		theApp.emuledlg->AddDebugLogLine(true,"Failed to load template " + sTemplateName);
@


1.11
log
@minor improvements
@
text
@a1841 156
	CString sStats;

	DWORD running;
	int myStats[SO_LAST];
	int myRateStats[3];
	uint64 ui64TotFileSize=0; 
	uint64 ui64TotBytesLeftToTransfer=0;
	uint64 ui64TotNeededSpace=0;
	theApp.downloadqueue->GetDownloadStats(myRateStats,ui64TotFileSize,ui64TotBytesLeftToTransfer,ui64TotNeededSpace);

	char buffer[100];char buffer2[100];
	CString cbuffer;

	uint64 ui64BytesTransfered;
	uint64 t_FreeBytes=0;
	float fPercent = 0.0f;

	// transfer
	sStats += ("<b>" + GetResString(IDS_FSTAT_TRANSFER) + "</b><br>");
	CastItoXBytes(theApp.stat_sessionReceivedBytes, buffer,100);
	CastItoXBytes(theApp.stat_sessionReceivedBytes+theApp.glob_prefs->GetTotalDownloaded(),	buffer2,100);
	cbuffer.Format(GetResString(IDS_STATS_DDATA), buffer, buffer2);
	sStats += (cbuffer + "<br>");
	CastItoXBytes(theApp.stat_sessionSentBytes, buffer,100);
	CastItoXBytes(theApp.stat_sessionSentBytes+theApp.glob_prefs->GetTotalUploaded(), buffer2,100);
	cbuffer.Format(GetResString(IDS_STATS_UDATA), buffer, buffer2);
	sStats += (cbuffer + "<br>");
	cbuffer.Format(GetResString(IDS_STATS_FOUNDSRC), myRateStats[0]);
	sStats += (cbuffer + "<br>");
	cbuffer.Format(GetResString(IDS_STATS_ACTDL), myRateStats[1]);
	sStats += (cbuffer + "<br>");
	cbuffer.Format(GetResString(IDS_STATS_ACTUL), theApp.uploadqueue->GetUploadQueueLength());
	sStats += (cbuffer + "<br>");
	cbuffer.Format(GetResString(IDS_STATS_WAITINGUSERS), theApp.uploadqueue->GetWaitingUserCount());
	sStats += (cbuffer + "<br>");
	cbuffer.Format(GetResString(IDS_STATS_SUCCUPCOUNT), theApp.uploadqueue->GetSuccessfullUpCount());
	sStats += (cbuffer + "<br>");
	cbuffer.Format(GetResString(IDS_STATS_FAILUPCOUNT), theApp.uploadqueue->GetFailedUpCount());
	sStats += (cbuffer + "<br>");
	running=theApp.uploadqueue->GetAverageUpTime();
	CastSecondsToHM(running, buffer,100);
	cbuffer.Format(GetResString(IDS_STATS_AVEUPTIME), buffer);
	sStats += (cbuffer + "<br>");
	// connections
	sStats += ("<b>" + GetResString(IDS_FSTAT_CONNECTION) + "</b><br>");
	if(theApp.stat_transferStarttime==0) 
		cbuffer.Format(GetResString(IDS_STATS_WAITTRANSF)); 
	else 
	{
		running = (GetTickCount()-theApp.stat_transferStarttime) / 1000;
		CastSecondsToHM(running, buffer,100);
		cbuffer.Format(GetResString(IDS_TRANSFERTIME), buffer);
	}
	sStats += (cbuffer + "<br>");
	if(theApp.stat_serverConnectTime==0) 
		cbuffer.Format(GetResString(IDS_STATS_WAITCONN)); 
	else 
	{
		running=(GetTickCount()-theApp.stat_serverConnectTime)/1000;
		CastSecondsToHM(running,buffer,100);
		cbuffer.Format(GetResString(IDS_STATS_CONNECTEDSINCE),buffer);
	}
	sStats += (cbuffer + "<br>");

	// shared files
	sStats += ("<b>" + GetResString(IDS_SF_FILES) + "</b><br>");
	cbuffer.Format(GetResString(IDS_SHAREDFILESCOUNT),theApp.sharedfiles->GetCount());
	sStats += (cbuffer + "<br>");
	uint64 allsize=theApp.sharedfiles->GetDatasize();
	CastItoXBytes(allsize,buffer,100);
	cbuffer.Format(GetResString(IDS_SF_SIZE), buffer);
	sStats += (cbuffer + "<br>");
	if(theApp.sharedfiles->GetCount() != 0)
		CastItoXBytes((uint64)allsize/theApp.sharedfiles->GetCount(), buffer,100);
	else 
	{
		buffer[0] = '-';
		buffer[1] = 0;
	}
	cbuffer.Format(GetResString(IDS_SF_AVERAGESIZE),buffer);
	sStats += (cbuffer + "<br>");
	
	// clients
	sStats += ("<b>" + GetResString(IDS_FSTAT_CLIENTS) + "</b><br>");
	ClientsData AllClients;
	uint32 totalclient;
	theApp.clientlist->GetStatistics(totalclient,myStats, &AllClients);
	totalclient -= myStats[SO_UNKNOWN];
	if( !totalclient )
		totalclient = 1;
	cbuffer.Format("eMule: %i(%1.1f%%)",myStats[SO_EMULE],(double)100*myStats[SO_EMULE]/totalclient);
	sStats += (cbuffer + "<br>");
	cbuffer.Format("CDonkey: %i(%1.1f%%)",myStats[SO_CDONKEY],(double)100*myStats[SO_CDONKEY]/totalclient);
	sStats += (cbuffer + "<br>");
	cbuffer.Format("eDonkeyHybrid: %i(%1.1f%%)",myStats[SO_EDONKEYHYBRID],(double)100*myStats[SO_EDONKEYHYBRID]/totalclient);
	sStats += (cbuffer + "<br>");
	cbuffer.Format("eDonkey: %i(%1.1f%%)",myStats[SO_EDONKEY],(double)100*myStats[SO_EDONKEY]/totalclient);
	sStats += (cbuffer + "<br>");
	cbuffer.Format("Old MLDonkey: %i(%1.1f%%)",myStats[SO_MLDONKEY],(double)100*myStats[SO_MLDONKEY]/totalclient);
	sStats += (cbuffer + "<br>");
	cbuffer.Format("Old eMule: %i(%1.1f%%)",myStats[SO_OLDEMULE],(double)100*myStats[SO_OLDEMULE]/totalclient);
	sStats += (cbuffer + "<br>");
	cbuffer.Format(GetResString(IDS_STATS_UNKNOWNCLIENT),myStats[SO_UNKNOWN]);
	sStats += (cbuffer + "<br>");

	// queue
	sStats += ("<b>" + GetResString(IDS_QUEUE) + "</b><br>");

	cbuffer.Format("%s: %i", GetResString(IDS_TRANSFERRING), AllClients.m_pClients[SO_LAST][DS_DOWNLOADING]);
	sStats += (cbuffer + "<br>");
	cbuffer.Format("%s: %i", GetResString(IDS_ONQUEUE), AllClients.m_pClients[SO_LAST][DS_ONQUEUE]);
	sStats += (cbuffer + "<br>");
	cbuffer.Format("%s: %i", GetResString(IDS_CONNECTING), AllClients.m_pClients[SO_LAST][DS_CONNECTING]);
	sStats += (cbuffer + "<br>");
	cbuffer.Format("%s: %i", GetResString(IDS_ASKING), AllClients.m_pClients[SO_LAST][DS_CONNECTED]);
	sStats += (cbuffer + "<br>");
	cbuffer.Format("%s: %i", GetResString(IDS_NONEEDEDPARTS), AllClients.m_pClients[SO_LAST][DS_NONEEDEDPARTS]);
	sStats += (cbuffer + "<br>");
	cbuffer.Format("%s: %i", GetResString(IDS_NOCONNECTLOW2LOW), AllClients.m_pClients[SO_LAST][DS_LOWTOLOWIP]);
	sStats += (cbuffer + "<br>");
	cbuffer.Format("%s: %i", GetResString(IDS_TOOMANYCONNS), AllClients.m_pClients[SO_LAST][DS_TOOMANYCONNS]);
	sStats += (cbuffer + "<br>");

	//download (totals)
	sStats += ("<b>" + GetResString(IDS_DWTOT) + "</b><br>");
	cbuffer.Format(GetResString(IDS_DWTOT_NR),myRateStats[2]); 
	sStats += (cbuffer + "<br>");
	CastItoXBytes(ui64TotFileSize,buffer,100); 
	cbuffer.Format(GetResString(IDS_DWTOT_TSD),buffer); 
	sStats += (cbuffer + "<br>");
	ui64BytesTransfered = (ui64TotFileSize-ui64TotBytesLeftToTransfer);
	CastItoXBytes(ui64BytesTransfered,buffer,100); 
	if(ui64TotFileSize != 0)
	fPercent = (float)((ui64BytesTransfered*100)/(ui64TotFileSize)); //kuchin
	cbuffer.Format(GetResString(IDS_DWTOT_TCS),buffer,fPercent); 
	sStats += (cbuffer + "<br>");
	CastItoXBytes(ui64TotBytesLeftToTransfer,buffer,100);
	cbuffer.Format(GetResString(IDS_DWTOT_TSL),buffer); 
	sStats += (cbuffer + "<br>");
	CastItoXBytes(ui64TotNeededSpace,buffer,100); 
	cbuffer.Format(GetResString(IDS_DWTOT_TSN),buffer); 
	sStats += (cbuffer + "<br>");
	t_FreeBytes = GetFreeDiskSpaceX(theApp.glob_prefs->GetTempDir().GetBuffer());
	CastItoXBytes(t_FreeBytes,buffer,100); 
	sprintf(buffer2,GetResString(IDS_DWTOT_FS),buffer);

	if(ui64TotNeededSpace > t_FreeBytes)
	{
		CastItoXBytes(ui64TotNeededSpace - t_FreeBytes,buffer,100);
		cbuffer.Format("%s (you need to free %s!)",buffer2,buffer);
	}
	else
		cbuffer.Format("%s",buffer2);
	sStats += (cbuffer + "<br>");

	//
d1843 1
a1843 1
	Out.Replace("[Stats]", sStats);
@


1.10
log
@new 'version missing' string... didn't save before committing....
@
text
@d128 1
a128 1
		theApp.emuledlg->AddLogLine(true,"Can't find templates version inside the templates file: replace it with a newer version!");
@


1.9
log
@'improved' template error message
@
text
@d128 1
a128 1
		theApp.emuledlg->AddLogLine(true,"Can't load templates version: replace file " + sFile + " with a newer version!");
@


1.8
log
@Added instrumentation for debugging memory leaks :
#ifdef _DEBUG
#undef THIS_FILE
static char THIS_FILE[]=__FILE__;
#define new DEBUG_NEW
#endif

To all .cpp files (I hope I didn't miss any one)
@
text
@d60 1
a60 1
			theApp.emuledlg->AddLogLine(true,"Can't load templates: file " + sFile + " has too old version");
d127 4
a130 2
		theApp.emuledlg->AddLogLine(true,"Failed to load template " + sTemplateName);

@


1.7
log
@Templates version check
@
text
@d9 7
@


1.6
log
@*** empty log message ***
@
text
@d12 2
d48 43
a90 33
		m_Templates.sHeader = _LoadTemplate(sAll,"TMPL_HEADER");
		m_Templates.sHeaderMetaRefresh = _LoadTemplate(sAll,"TMPL_HEADER_META_REFRESH");
		m_Templates.sHeaderStylesheet = _LoadTemplate(sAll,"TMPL_HEADER_STYLESHEET");
		m_Templates.sFooter = _LoadTemplate(sAll,"TMPL_FOOTER");
		m_Templates.sServerList = _LoadTemplate(sAll,"TMPL_SERVER_LIST");
		m_Templates.sServerLine = _LoadTemplate(sAll,"TMPL_SERVER_LINE");
		m_Templates.sTransferImages = _LoadTemplate(sAll,"TMPL_TRANSFER_IMAGES");
		m_Templates.sTransferList = _LoadTemplate(sAll,"TMPL_TRANSFER_LIST");
		m_Templates.sTransferDownHeader = _LoadTemplate(sAll,"TMPL_TRANSFER_DOWN_HEADER");
		m_Templates.sTransferDownFooter = _LoadTemplate(sAll,"TMPL_TRANSFER_DOWN_FOOTER");
		m_Templates.sTransferDownLine = _LoadTemplate(sAll,"TMPL_TRANSFER_DOWN_LINE");
		m_Templates.sTransferDownLineGood = _LoadTemplate(sAll,"TMPL_TRANSFER_DOWN_LINE_GOOD");
		m_Templates.sTransferUpHeader = _LoadTemplate(sAll,"TMPL_TRANSFER_UP_HEADER");
		m_Templates.sTransferUpFooter = _LoadTemplate(sAll,"TMPL_TRANSFER_UP_FOOTER");
		m_Templates.sTransferUpLine = _LoadTemplate(sAll,"TMPL_TRANSFER_UP_LINE");
		m_Templates.sTransferUpQueueShow = _LoadTemplate(sAll,"TMPL_TRANSFER_UP_QUEUE_SHOW");
		m_Templates.sTransferUpQueueHide = _LoadTemplate(sAll,"TMPL_TRANSFER_UP_QUEUE_HIDE");
		m_Templates.sTransferUpQueueLine = _LoadTemplate(sAll,"TMPL_TRANSFER_UP_QUEUE_LINE");
		m_Templates.sTransferBadLink = _LoadTemplate(sAll,"TMPL_TRANSFER_BAD_LINK");
		m_Templates.sDownloadLink = _LoadTemplate(sAll,"TMPL_DOWNLOAD_LINK");
		m_Templates.sSharedList = _LoadTemplate(sAll,"TMPL_SHARED_LIST");
		m_Templates.sSharedLine = _LoadTemplate(sAll,"TMPL_SHARED_LINE");
		m_Templates.sSharedLineChanged = _LoadTemplate(sAll,"TMPL_SHARED_LINE_CHANGED");
		m_Templates.sGraphs = _LoadTemplate(sAll,"TMPL_GRAPHS");
		m_Templates.sLog = _LoadTemplate(sAll,"TMPL_LOG");
		m_Templates.sServerInfo = _LoadTemplate(sAll,"TMPL_SERVERINFO");
		m_Templates.sDebugLog = _LoadTemplate(sAll,"TMPL_DEBUGLOG");
		m_Templates.sStats = _LoadTemplate(sAll,"TMPL_STATS");
		m_Templates.sPreferences = _LoadTemplate(sAll,"TMPL_PREFERENCES");
		m_Templates.sLogin = _LoadTemplate(sAll,"TMPL_LOGIN");
		m_Templates.sConnectedServer = _LoadTemplate(sAll,"TMPL_CONNECTED_SERVER");
		m_Templates.sAddServerBox = _LoadTemplate(sAll,"TMPL_ADDSERVERBOX");
		m_Templates.sWebSearch = _LoadTemplate(sAll,"TMPL_WEBSEARCH");
@


1.5
log
@WebServer improvements
@
text
@d1928 2
a1929 1
	cbuffer.Format("%s: %i", GetResString(IDS_TRANSFERRING), AllClients.clientStatus[DS_DOWNLOADING]);
d1931 1
a1931 1
	cbuffer.Format("%s: %i", GetResString(IDS_ONQUEUE), AllClients.clientStatus[DS_ONQUEUE]);
d1933 1
a1933 1
	cbuffer.Format("%s: %i", GetResString(IDS_CONNECTING), AllClients.clientStatus[DS_CONNECTING]);
d1935 1
a1935 1
	cbuffer.Format("%s: %i", GetResString(IDS_ASKING), AllClients.clientStatus[DS_CONNECTED]);
d1937 1
a1937 1
	cbuffer.Format("%s: %i", GetResString(IDS_NONEEDEDPARTS), AllClients.clientStatus[DS_NONEEDEDPARTS]);
d1939 1
a1939 1
	cbuffer.Format("%s: %i", GetResString(IDS_NOCONNECTLOW2LOW), AllClients.clientStatus[DS_LOWTOLOWIP]);
d1941 1
a1941 1
	cbuffer.Format("%s: %i", GetResString(IDS_TOOMANYCONNS), AllClients.clientStatus[DS_TOOMANYCONNS]);
@


1.4
log
@Saving web server settings
@
text
@d72 2
d274 2
a275 2

		if (_ParseURL(Data.sURL, "w") == "server") 
d280 1
a280 1
		if (_ParseURL(Data.sURL, "w") == "download") 
d285 1
a285 1
		if (_ParseURL(Data.sURL, "w") == "shared") 
d290 1
a290 1
		if (_ParseURL(Data.sURL, "w") == "transfer") 
d295 1
a295 1
		if (_ParseURL(Data.sURL, "w") == "websearch") 
d300 1
a300 1
		if (_ParseURL(Data.sURL, "w") == "graphs")
d305 1
a305 1
		if (_ParseURL(Data.sURL, "w") == "log") 
d309 1
a309 1
		if (_ParseURL(Data.sURL, "w") == "sinfo") 
d313 9
a321 1
		if (_ParseURL(Data.sURL, "w") == "options") 
d328 1
a328 1
		if (_ParseURL(Data.sURL, "w") == "")
d447 8
a454 5
		if ((_ParseURL(Data.sURL, "w") == "transfer") ||
			(_ParseURL(Data.sURL, "w") == "server") ||
			(_ParseURL(Data.sURL, "w") == "graphs") ||
			(_ParseURL(Data.sURL, "w") == "log") ||
			(_ParseURL(Data.sURL, "w") == "sinfo"))
d476 2
d552 2
a553 1
	if (_ParseURL(Data.sURL, "c") == "connect")
d561 1
a561 1
	else if (_ParseURL(Data.sURL, "c") == "disconnect") 
d565 1
a565 1
	else if (_ParseURL(Data.sURL, "c") == "remove") 
d571 1
a571 1
	else if (_ParseURL(Data.sURL, "c") == "options") 
d575 2
a576 1
	if (_ParseURL(Data.sURL, "sort") != "") 
d578 1
a578 1
		if(_ParseURL(Data.sURL, "sort") == "name")
d581 1
a581 1
		if(_ParseURL(Data.sURL, "sort") == "description")
d584 1
a584 1
		if(_ParseURL(Data.sURL, "sort") == "ip")
d587 1
a587 1
		if(_ParseURL(Data.sURL, "sort") == "users")
d590 1
a590 1
		if(_ParseURL(Data.sURL, "sort") == "files")
d1776 202
@


1.3
log
@Merge from plus26based branch (without new sockets code yet)
@
text
@a15 1
	m_Params.bUseGzip = true;
a16 1
	m_Params.nRefreshTime = 120;
d234 1
a234 1
	bool isUseGzip = pThis->m_Params.bUseGzip;
d435 1
a435 1
	if(pThis->m_Params.nRefreshTime != 0)
d444 1
a444 1
			CString sRefresh; sRefresh.Format("%d", pThis->m_Params.nRefreshTime);
d1782 1
a1782 1
		pThis->m_Params.bUseGzip = true;
d1786 1
a1786 1
		pThis->m_Params.bUseGzip = false;
d1798 1
a1798 1
		pThis->m_Params.nRefreshTime = atoi(_ParseURL(Data.sURL, "refresh"));
d1823 1
a1823 1
	if(pThis->m_Params.bUseGzip)
d1851 1
a1851 1
	CString sRefresh; sRefresh.Format("%d", pThis->m_Params.nRefreshTime);
@


1.2
log
@U/D no longer show 65535 when set to 0 but Unlimited
@
text
@d81 1
@


1.2.4.1
log
@do not warn about missing templates if it's disabled
@
text
@d81 1
a81 2
        if(theApp.glob_prefs->GetHTTPIsEnabled())
		    theApp.emuledlg->AddLogLine(true,"Can't load templates: Can't open file " + sFile);
@


1.2.2.1
log
@updating this branch...
@
text
@@


1.1
log
@*** empty log message ***
@
text
@d493 9
a501 1
	sLimits.Format("%i/%i", theApp.glob_prefs->GetMaxUpload(), theApp.glob_prefs->GetMaxDownload());
@

